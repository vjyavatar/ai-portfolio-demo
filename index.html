<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Analytics 4 — Replace G-WW55EQ7ZB8 with your Measurement ID -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WW55EQ7ZB8"></script>
<script>
window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-WW55EQ7ZB8');
</script>

<!-- Google AdSense — Replace ca-pub-2084524493538975 with your publisher ID after approval -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2084524493538975" crossorigin="anonymous"></script>
<title>Celesys AI — Free Real-Time Stock Analysis in 60 Seconds | AI Stock Research</title>
<meta name="description" content="Celesys AI delivers free, institutional-grade stock analysis in 60 seconds. Get real-time valuation metrics, intrinsic value (Graham Number, DCF), 20-factor buy/sell verdicts, quarterly earnings trends, management tone analysis, and curated small-cap picks for US (NYSE, NASDAQ) and Indian (NSE, BSE) markets.">
<meta name="keywords" content="stock analysis, AI stock research, free stock analysis, real-time stock data, stock valuation, intrinsic value calculator, Graham Number, DCF model, entry exit strategy, stop loss calculator, PE ratio checker, PB ratio, stock risk assessment, small cap stocks, micro cap multibagger, Indian stocks NSE BSE, US stocks NYSE NASDAQ, investment research, stock screener, AI investment tool, portfolio analysis, stock recommendation, market intelligence, Nifty 50 analysis, Bank Nifty options, option chain analysis, management tone analysis, earnings analysis QoQ YoY, celesys, celesys ai">
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<meta name="author" content="Celesys AI">
<meta name="application-name" content="Celesys AI">
<meta name="rating" content="general">
<meta name="category" content="Finance, Stock Analysis, Investment Research">
<meta name="topic" content="AI-powered stock analysis platform for retail investors">
<meta name="google-site-verification" content="googleb6e1e80f88761fcc">
<meta name="google-adsense-account" content="ca-pub-2084524493538975">
<link rel="canonical" href="https://celesys.ai">

<!-- Open Graph / Social Sharing -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://celesys.ai">
<meta property="og:title" content="Celesys AI — Free AI Stock Analysis in 60 Seconds">
<meta property="og:description" content="Get professional-grade stock analysis in 60 seconds. Real-time data, AI valuation, exact buy/sell prices, risk scoring, and hidden small-cap picks. Completely free.">
<meta property="og:site_name" content="Celesys AI">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://celesys.ai/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Celesys AI — Free AI Stock Analysis in 60 Seconds">
<meta name="twitter:description" content="Stop guessing. Get AI-powered stock analysis with real-time data, exact entry/exit prices, and risk scoring — free, in 60 seconds.">
<meta name="twitter:image" content="https://celesys.ai/og-image.png">
<meta name="twitter:site" content="@celesysai">

<!-- Additional SEO -->
<meta name="theme-color" content="#f8f9fa">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Celesys AI">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">

<!-- Preconnect for performance (helps Core Web Vitals / SEO ranking) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- JSON-LD Structured Data (rich results in Google) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Celesys AI",
  "alternateName": ["Celesys AI Stock Analyzer", "Celesys Stock Research Platform"],
  "url": "https://celesys.ai",
  "description": "Celesys AI is a free, AI-powered stock analysis platform that delivers institutional-grade research reports in 60 seconds. It provides real-time valuation metrics, intrinsic value calculations (Graham Number, DCF), buy/sell price targets, 20-factor risk scoring, quarterly earnings analysis with QoQ/YoY trends, management tone assessment, and curated small-cap stock picks for US (NYSE, NASDAQ) and Indian (NSE, BSE) markets.",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "Web",
  "browserRequirements": "Requires JavaScript. Works on all modern browsers.",
  "softwareVersion": "2.0",
  "datePublished": "2025-01-01",
  "dateModified": "2026-02-19",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "description": "5 free deep-dive stock analysis reports per hour. No signup, no credit card required.",
    "availability": "https://schema.org/InStock"
  },
  "featureList": [
    "Real-time stock price data from Yahoo Finance and Google Finance",
    "AI-powered buy/sell price targets with entry and exit levels",
    "20-factor deterministic stock verdict engine (P/E, profitability, financial health, 52-week position, P/B, dividend, beta, operating efficiency)",
    "Intrinsic value calculations: Graham Number, DCF growth model, Peter Lynch fair value, earnings yield vs bond comparison",
    "Quarterly earnings analysis with QoQ and YoY growth trends",
    "Management tone and CEO/CFO confidence assessment",
    "Hidden small-cap and micro-cap stock recommendations",
    "NSE option chain analysis with PCR, max pain, and OI walls",
    "Smart Trades: daily AI-generated index and stock trade ideas",
    "Curated stock picks: large-cap, mid-cap, small-cap, niche moat, micro-cap multibaggers, best performing indices",
    "Financial health radar: profit margin, ROE, current ratio, operating margin, dividend yield",
    "Risk profile scoring: volatility, debt, liquidity, valuation, sector risk",
    "Valuation metrics charting: P/E, P/B, dividend yield with interactive tooltips",
    "6-month historical price trend with real monthly close data",
    "Margin vs industry comparison benchmarking",
    "US stocks (NYSE, NASDAQ) and Indian stocks (NSE, BSE) coverage",
    "Global market indices ticker: S&P 500, NASDAQ, Dow Jones, Nifty 50, Sensex, FTSE 100, DAX, Nikkei 225"
  ],
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "ratingCount": "1250",
    "bestRating": "5",
    "worstRating": "1"
  },
  "screenshot": "https://celesys.ai/og-image.png",
  "creator": {
    "@type": "Organization",
    "name": "Celesys AI",
    "url": "https://celesys.ai",
    "email": "contact@celesys.ai",
    "foundingDate": "2025",
    "description": "Celesys AI builds free, AI-powered financial research tools that democratize access to institutional-grade stock analysis for retail investors worldwide."
  },
  "audience": {
    "@type": "Audience",
    "audienceType": "Retail investors, stock traders, financial analysts, portfolio managers"
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is Celesys AI and how does it work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI is a free AI-powered stock analysis platform. Enter any US or Indian stock ticker and receive a comprehensive research report in 60 seconds — including real-time valuation metrics, intrinsic value estimates using Graham Number and DCF models, buy/sell price targets, 20-factor risk scoring, quarterly earnings trends, management tone analysis, and curated small-cap recommendations. No signup required."
      }
    },
    {
      "@type": "Question",
      "name": "Is Celesys AI free to use?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, Celesys AI is completely free. You get 5 deep-dive stock analysis reports per email per hour with no credit card, no subscription, and no hidden fees. The platform is funded as an educational research tool to democratize access to institutional-quality financial analysis."
      }
    },
    {
      "@type": "Question",
      "name": "Which stock markets and tickers does Celesys AI support?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI supports 100+ pre-loaded US stocks from NYSE and NASDAQ (like AAPL, TSLA, NVDA, GOOGL, META) and Indian NSE/BSE stocks (like RELIANCE.NS, TCS.NS, HDFCBANK.NS, INFY.NS). You can also enter any valid Yahoo Finance ticker symbol for global market coverage including European, Asian, and emerging market equities."
      }
    },
    {
      "@type": "Question",
      "name": "How does the 20-factor stock verdict engine work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The Celesys AI verdict engine scores stocks across 20 quantitative factors: P/E valuation, forward P/E discount, profitability (margins and ROE), financial health (debt-to-equity, current and quick ratio), cash vs debt position, 52-week price position, price-to-book value, dividend yield and sustainability, beta/volatility risk, operating efficiency, earnings velocity (EPS + revenue CAGR), relative valuation vs sector P/E, technical momentum (SMA 20/50/200 crossovers), PEG ratio, cash flow quality (FCF margin), EV/EBITDA enterprise valuation, gross margin power, EBITDA margin quality, short interest signal, and multi-factor quality combos. The combined score produces a deterministic verdict — Strong Buy, Buy, Accumulate, Hold, Sell, or Strong Sell — that remains consistent regardless of daily price noise."
      }
    },
    {
      "@type": "Question",
      "name": "How does Celesys AI calculate intrinsic value?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI computes intrinsic value using four established models: the Graham Number (square root of 22.5 × EPS × book value per share), the Benjamin Graham DCF growth formula (EPS × (8.5 + 2g)), the Peter Lynch fair value (EPS × growth rate for PEG ratio of 1), and earnings yield comparison versus 10-year treasury bond rates. These help investors assess whether a stock is trading above or below its fundamental worth."
      }
    },
    {
      "@type": "Question",
      "name": "What is the management tone analysis in Celesys AI?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The management tone analysis uses real earnings data, analyst ratings, insider trading activity, institutional ownership patterns, and forward guidance to assess whether a company's leadership is bullish, cautious, or defensive. It helps investors read between the lines of earnings calls and corporate communications to gauge management confidence and credibility."
      }
    },
    {
      "@type": "Question",
      "name": "What are Smart Trades and curated stock picks?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Smart Trades provides daily AI-generated trade ideas for Nifty 50, Bank Nifty, Sensex, and high-momentum stocks using a 10-factor scoring engine with live NSE option chain data. Curated Stock Picks lists the top 5 undervalued companies across six categories: large-cap, mid-cap, small-cap, niche/deep moat companies, micro-cap multibagger candidates, and best-performing stock market indices — for both India and USA markets."
      }
    },
    {
      "@type": "Question",
      "name": "Is Celesys AI a replacement for a financial advisor?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "No. Celesys AI is an educational research tool, not a licensed financial advisor. All analysis, buy/sell targets, risk scores, and recommendations are AI-generated for educational purposes only. Always consult a certified financial advisor before making investment decisions. Market data may be delayed or incomplete — cross-check with your broker."
      }
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://celesys.ai"},
    {"@type": "ListItem", "position": 2, "name": "About", "item": "https://celesys.ai/about"},
    {"@type": "ListItem", "position": 3, "name": "FAQ", "item": "https://celesys.ai/faq"},
    {"@type": "ListItem", "position": 4, "name": "Privacy Policy", "item": "https://celesys.ai/privacy"},
    {"@type": "ListItem", "position": 5, "name": "Terms of Service", "item": "https://celesys.ai/terms"},
    {"@type": "ListItem", "position": 6, "name": "Disclaimer", "item": "https://celesys.ai/disclaimer"}
  ]
}
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Sora:wght@600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#ffffff;--bg2:#f8f9fa;--bg3:#f0f1f2;--surface:#ffffff;--glass:rgba(255,255,255,0.97);--border:#e0e0e0;--border2:#c8c8c8;--blue:#0087d2;--blue2:#006bb3;--cyan:#0087d2;--teal:#0087d2;--green:#0eb24e;--green2:#0a9940;--amber:#fcb711;--red:#cd004b;--purple:#6561ac;--text:#171717;--text2:#424242;--text3:#6b6b6b;--mono:'IBM Plex Mono',monospace}
[data-theme="dark"]{--bg:#0d1b2a;--bg2:#152238;--bg3:#1b2d45;--surface:#152238;--glass:rgba(13,27,42,0.97);--border:rgba(255,255,255,.1);--border2:rgba(255,255,255,.18);--blue:#4dabf7;--blue2:#74c0fc;--cyan:#4dabf7;--teal:#4dabf7;--green:#51cf66;--green2:#40c057;--amber:#ffd43b;--red:#ff6b6b;--purple:#b197fc;--text:#e9ecef;--text2:#adb5bd;--text3:#868e96}
[data-theme="dark"] body{background:#0d1b2a;color:#e9ecef}
[data-theme="dark"] nav{background:#002244 !important;border-bottom:none !important}
[data-theme="dark"] .hero{background:#0d1b2a !important}
[data-theme="dark"] .tab-bar{background:#152238 !important;border-bottom-color:rgba(255,255,255,.1) !important}
[data-theme="dark"] .tab-btn{color:#adb5bd !important;background:transparent !important}
[data-theme="dark"] .tab-btn:hover:not(.active){background:rgba(255,255,255,.05) !important}
[data-theme="dark"] .tab-btn.active{color:#4dabf7 !important;border-bottom-color:#4dabf7 !important;background:rgba(77,171,247,.08) !important}
[data-theme="dark"] input,[data-theme="dark"] select{background:#0d1b2a !important;color:#e9ecef !important;border-color:rgba(255,255,255,.12) !important}
[data-theme="dark"] .sc{background:#152238 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .sh{background:transparent !important}
[data-theme="dark"] .mcard{background:#152238 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .ccard{background:#152238 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .icard{background:#152238 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .feat-card{background:#152238 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] table th{color:#adb5bd !important}
[data-theme="dark"] table td{color:#e9ecef !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .ic{background:rgba(21,34,56,.6) !important}
[data-theme="dark"] .qpick{background:#1b2d45 !important;border-color:rgba(255,255,255,.1) !important;color:#adb5bd !important}
[data-theme="dark"] .hb{background:#1b2d45 !important;border-color:rgba(255,255,255,.1) !important;color:#adb5bd !important}
[data-theme="dark"] .pfcard{background:#152238 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .ac{background:#152238 !important;border-color:rgba(255,255,255,.1) !important}
[data-theme="dark"] .aci:hover{background:rgba(77,171,247,.1) !important}
[data-theme="dark"] .ipt{background:#0d1b2a !important;border-color:rgba(255,255,255,.12) !important;color:#e9ecef !important}
[data-theme="dark"] .sticky-tagline{background:rgba(13,27,42,.98) !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .rphero{background:#1b2d45 !important;border-color:rgba(255,255,255,.08) !important}
[data-theme="dark"] .gridbg{background:#0d1b2a !important}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:clip;padding-bottom:90px}

/* Grid background */
.gridbg{position:fixed;inset:0;z-index:0;pointer-events:none;background:#ffffff;background-image:none}
.gridbg::after{content:'';position:absolute;inset:0;background:none}

/* NAV */
nav{position:sticky;top:30px;z-index:99;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);background:#003366;border-bottom:none;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;box-shadow:0 2px 6px rgba(0,51,102,.3)}
.nbrand{display:flex;align-items:center;gap:11px}
.nlogo{width:34px;height:34px;border-radius:6px;background:#ffffff;display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:#0087d2;box-shadow:none}
.nname{font-family:'Sora',sans-serif;font-size:15px;font-weight:700;letter-spacing:.3px;color:#ffffff}.nname span{color:rgba(255,255,255,.8)}.ntag{font-size:9px;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:1.2px;font-weight:600;margin-top:-2px;display:block}
.ncenter{display:flex;gap:6px;align-items:center}
.npill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:500;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:rgba(255,255,255,.9)}
.npill .v{color:#ffffff;font-family:var(--mono);font-weight:600}
.nright{display:flex;align-items:center;gap:6px}
.nlive{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:600;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#ffffff}
.ldot{width:6px;height:6px;border-radius:50%;background:#ffffff;box-shadow:0 0 6px rgba(255,255,255,.8);animation:pdot 2s infinite}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* HERO */
.hero{position:relative;z-index:1;padding:28px 28px 16px;text-align:center;background:#ffffff}
.sticky-tagline{position:fixed;top:86px;left:0;width:100%;z-index:98;text-align:center;padding:6px 0;background:rgba(255,255,255,.98);border-bottom:1px solid #e0e0e0;transform:translateY(-100%);opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.sticky-tagline.vis{transform:translateY(0);opacity:1;pointer-events:auto}
.sticky-tagline span{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#0087d2;letter-spacing:.3px}
.hero-eye{display:inline-flex;align-items:center;gap:6px;background:rgba(0,135,210,0.06);border:1px solid rgba(0,135,210,0.15);padding:7px 18px;border-radius:100px;font-size:12px;font-weight:600;color:#0087d2;margin-bottom:24px;letter-spacing:.3px}
.hero h1{font-family:'Sora',sans-serif;font-size:clamp(28px,4.5vw,48px);font-weight:800;line-height:1.15;margin-bottom:10px;color:#171717}
.hero-sub{font-size:15px;color:var(--text2);max-width:560px;margin:0 auto 16px;line-height:1.7}
.qpick{padding:4px 10px;border-radius:4px;border:1px solid #dcdcdc;background:#ffffff;color:#4a4a4a;font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;white-space:nowrap}
.qpick:hover{background:#0087d2;color:#fff;border-color:#0087d2}
.feat-card{background:#ffffff;border:1px solid #dcdcdc;border-radius:6px;padding:12px;text-align:center;transition:all .2s}
.feat-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.06);border-color:#0087d2}
@media(max-width:600px){.feat-card{padding:8px}.hero .icard{padding:14px}.hero-sub{font-size:13px}}
.hbadges{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.hb{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:4px;font-size:11px;font-weight:600;letter-spacing:.2px;border:1px solid #dcdcdc;background:#ffffff;color:#4a4a4a}

/* INPUT */
.isection{position:relative;z-index:1;max-width:720px;margin:0 auto;padding:0 20px 24px}
.icard{background:#ffffff;border:1px solid #dcdcdc;border-radius:8px;padding:28px;box-shadow:0 1px 4px rgba(0,0,0,.04);position:relative;overflow:hidden}
.icard::before{content:'';position:absolute;top:-1px;left:50%;transform:translateX(-50%);width:100px;height:3px;background:#0087d2;border-radius:2px}
.ilabel{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px}
.irow{display:grid;grid-template-columns:1fr 1fr 110px;gap:10px}
.iwrap{position:relative}
.ipt{width:100%;padding:12px 14px;background:#ffffff;border:1.5px solid #dcdcdc;border-radius:6px;font-size:14px;color:var(--text);font-family:'DM Sans',sans-serif;transition:all .3s;outline:none}
.ipt::placeholder{color:#999}.ipt:focus{border-color:#0087d2;box-shadow:0 0 0 3px rgba(0,135,210,.1)}
.ac{position:absolute;top:100%;left:0;right:0;background:#ffffff;border:1.5px solid #dcdcdc;border-top:none;border-radius:0 0 6px 6px;max-height:280px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.1)}
.ac.show{display:block}
.aci{padding:10px 14px;cursor:pointer;border-bottom:1px solid #eaeaea;transition:all .2s;display:flex;align-items:center;gap:8px}
.aci:hover{background:rgba(0,135,210,.04);padding-left:18px}
.act{font-family:var(--mono);font-weight:600;color:#0087d2;font-size:13px;min-width:75px}.acn{color:#4a4a4a;font-size:12px}
.btn{width:100%;padding:12px;border:none;border-radius:6px;font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .3s;background:#0087d2;color:#fff;letter-spacing:.2px}
.btn:hover:not(:disabled){background:#006bb3;box-shadow:0 4px 12px rgba(0,135,210,.3)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.ld{background:var(--bg3);color:var(--blue);border:1.5px solid var(--border2)}
.hlp{margin-top:14px;font-size:11px;color:var(--text3);line-height:1.7}.hlp a{color:var(--blue);text-decoration:none}.hlp strong{color:var(--text2)}

/* STATUS */
.sbar{margin-top:14px;padding:12px 16px;border-radius:10px;display:none;font-size:13px;font-weight:500;border:1px solid;align-items:center;gap:8px}
.sbar.show{display:flex;animation:sld .3s ease}.sbar.info{background:rgba(59,130,246,.06);border-color:rgba(0,120,212,.25);color:var(--blue)}
.sbar.success{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.2);color:var(--green)}.sbar.error{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.2);color:var(--red)}
@keyframes sld{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

/* LOADING */
.lsteps{margin-top:14px;display:none}.lsteps.show{display:block}
.ls{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:12px;color:var(--text3);opacity:0;transform:translateX(-8px);transition:all .4s}
.ls.on{opacity:1;transform:translateX(0);color:var(--blue)}.ls.ok{opacity:1;transform:translateX(0);color:var(--green)}
.lsi{width:22px;height:22px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;font-family:var(--mono);transition:all .3s}
.ls.on .lsi{border-color:var(--blue);color:var(--blue);animation:pdot 1.5s infinite}.ls.ok .lsi{border-color:var(--green);background:var(--green);color:var(--bg)}

/* RATE LIMIT */
.rlbox{margin-top:14px;display:none;padding:20px;border-radius:12px;text-align:center;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.2)}
.rlbox .rlcd{font-family:var(--mono);font-size:38px;font-weight:700;color:var(--amber);margin:8px 0;letter-spacing:3px}
.rlbox .rlmsg{font-size:12px;color:var(--text3)}
.rlbox .rlbar{width:100%;height:3px;background:rgba(245,158,11,.1);border-radius:2px;margin-top:12px;overflow:hidden}
.rlbox .rlbf{height:100%;background:linear-gradient(90deg,var(--amber),var(--green));border-radius:2px;transition:width 1s linear}

/* REPORT */
.rpt{position:relative;max-width:1080px;margin:0 auto;padding:0 20px 64px;display:none}
.rpt.show{display:block;animation:fu .6s ease}
@keyframes fu{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

.rphero{text-align:center;margin-bottom:12px;padding:20px 24px;border-radius:6px;border:1px solid #e0e0e0;background:#f8f9fa;position:relative;overflow:hidden}
.rphero::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:#0087d2}
@keyframes spin{to{transform:rotate(360deg)}}
.rphero>*{position:relative;z-index:1}
.rptk{display:inline-block;font-family:var(--mono);font-size:13px;font-weight:600;color:#0087d2;background:rgba(0,135,210,.06);padding:5px 16px;border-radius:4px;border:1px solid rgba(0,135,210,.15);margin-bottom:12px;letter-spacing:.8px}
.rpco{font-family:'Sora',sans-serif;font-size:clamp(20px,3vw,28px);font-weight:800;margin-bottom:4px}
.rplv{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--green);font-weight:500}

/* METRICS */
.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
.mcard{background:#ffffff;border:1px solid #dcdcdc;border-radius:6px;padding:14px 12px;text-align:center;box-shadow:none;transition:all .2s;position:relative;overflow:hidden}
.mcard:hover{border-color:#0087d2;box-shadow:0 2px 8px rgba(0,135,210,.08)}
.mcard::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:#0087d2;opacity:0;transition:opacity .3s}.mcard:hover::after{opacity:1}
.ml{font-size:9px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:600;margin-bottom:4px}
.mv{font-family:var(--mono);font-size:20px;font-weight:700;color:var(--text);margin-bottom:2px}
.ms{font-size:12px;font-weight:600}.ms.up{color:var(--green)}.ms.dn{color:var(--red)}.ms.nu{color:var(--text3)}

/* CHARTS */
.cgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:24px}
.cgrid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-bottom:24px}
.ccard{background:#ffffff;border:1px solid #dcdcdc;border-radius:6px;padding:20px;box-shadow:none}
.cct{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:14px;display:flex;align-items:center;gap:6px}
.cc{height:180px}
.cc2{height:200px}

/* STICKY INPUT */
.isection{position:relative;z-index:1}

/* SECTIONS - Always open, no accordion */
.sc{background:#ffffff;border:1px solid #dcdcdc;border-radius:4px;padding:0;margin-bottom:10px;box-shadow:none;overflow:visible;scroll-margin-top:140px}
.sc:hover{border-color:#0087d2}
.sh{display:flex;align-items:center;gap:8px;padding:12px 18px 0}
.si{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.st{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;letter-spacing:-.2px;flex:1;scroll-margin-top:150px}
.sbody{padding:12px 18px 16px;overflow:visible}
.tab-bar{display:flex;gap:0;margin-bottom:0;background:#ffffff;border:none;border-bottom:2px solid #dcdcdc;border-radius:0;padding:0 8px;position:sticky;top:86px;z-index:97;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;box-shadow:none}
.tab-bar::-webkit-scrollbar{display:none}
.tab-bar.attention{animation:tabPulse 2s ease 3;border-color:rgba(59,130,246,.5);box-shadow:0 0 20px rgba(59,130,246,.15)}
@keyframes tabPulse{0%,100%{border-color:rgba(0,120,212,.25);box-shadow:0 0 10px rgba(59,130,246,.05)}50%{border-color:rgba(59,130,246,.6);box-shadow:0 0 25px rgba(0,120,212,.25)}}
.tab-scroll-area{overflow-y:visible;border:none;border-radius:0;padding:18px 0;background:transparent;scrollbar-width:thin;scrollbar-color:rgba(0,47,108,.15) transparent}
.tab-scroll-area::-webkit-scrollbar{width:6px}.tab-scroll-area::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px}.tab-scroll-area::-webkit-scrollbar-track{background:transparent}
.tab-btn{flex:none;padding:12px 16px;border:none;border-radius:0;cursor:pointer;font-family:'Sora',sans-serif;font-size:11px;font-weight:600;transition:all .2s;background:transparent;color:#747474;letter-spacing:.2px;display:flex;align-items:center;justify-content:center;gap:5px;border-bottom:3px solid transparent;white-space:nowrap;position:relative}
.tab-btn .tab-icon{font-size:14px;display:inline-flex;width:22px;height:22px;align-items:center;justify-content:center;border-radius:4px;transition:all .2s;background:transparent}
/* All inactive tabs look the same - clean CNBC style */
.tab-btn[data-color="green"],.tab-btn[data-color="navy"],.tab-btn[data-color="purple"],.tab-btn[data-color="cyan"],.tab-btn[data-color="amber"],.tab-btn[data-color="teal"],.tab-btn[data-color="emerald"],.tab-btn[data-color="gold"],.tab-btn[data-color="blue"],.tab-btn[data-color="red"]{color:#747474;background:transparent}
.tab-btn[data-color="green"] .tab-icon,.tab-btn[data-color="navy"] .tab-icon,.tab-btn[data-color="purple"] .tab-icon,.tab-btn[data-color="cyan"] .tab-icon,.tab-btn[data-color="amber"] .tab-icon,.tab-btn[data-color="teal"] .tab-icon,.tab-btn[data-color="emerald"] .tab-icon,.tab-btn[data-color="gold"] .tab-icon,.tab-btn[data-color="blue"] .tab-icon,.tab-btn[data-color="red"] .tab-icon{background:transparent}
.tab-btn:hover:not(.active){color:#0087d2;background:rgba(0,135,210,.03)}
.tab-btn.active{font-weight:800;color:#0087d2;border-bottom:3px solid #0087d2;box-shadow:none;transform:none;background:transparent}
/* All active states - uniform CNBC blue underline */
.tab-btn[data-color="green"].active,.tab-btn[data-color="navy"].active,.tab-btn[data-color="purple"].active,.tab-btn[data-color="cyan"].active,.tab-btn[data-color="amber"].active,.tab-btn[data-color="teal"].active,.tab-btn[data-color="emerald"].active,.tab-btn[data-color="gold"].active,.tab-btn[data-color="blue"].active,.tab-btn[data-color="red"].active{color:#0087d2;border-bottom-color:#0087d2;background:rgba(0,135,210,.03)}
.tab-btn[data-color="green"].active .tab-icon,.tab-btn[data-color="navy"].active .tab-icon,.tab-btn[data-color="purple"].active .tab-icon,.tab-btn[data-color="cyan"].active .tab-icon,.tab-btn[data-color="amber"].active .tab-icon,.tab-btn[data-color="teal"].active .tab-icon,.tab-btn[data-color="emerald"].active .tab-icon,.tab-btn[data-color="gold"].active .tab-icon,.tab-btn[data-color="blue"].active .tab-icon,.tab-btn[data-color="red"].active .tab-icon{background:rgba(0,135,210,.1);color:#0087d2}
.tab-btn::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:#ffffff;color:var(--text2);font-size:11px;font-weight:400;padding:8px 14px;border-radius:8px;border:1px solid #e5e7eb;white-space:nowrap;max-width:280px;white-space:normal;text-align:center;line-height:1.5;opacity:0;pointer-events:none;transition:opacity .2s;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,.1)}
.tab-btn:hover::after{opacity:1}
.sc[data-tab]{display:none}
.go-deeper-btn{display:block;width:100%;margin:18px 0;padding:16px;border:2px dashed rgba(139,92,246,.4);border-radius:12px;background:rgba(139,92,246,.06);color:var(--purple);font-family:'Sora',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .3s;text-align:center}
.go-deeper-btn:hover{background:rgba(139,92,246,.12);border-color:var(--purple);transform:translateY(-1px)}

/* Verdict */
.vpill{display:inline-flex;padding:8px 24px;border-radius:100px;font-family:'Sora',sans-serif;font-size:15px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;animation:vg 2s ease-in-out infinite alternate}
.vpill.buy{background:rgba(16,185,129,.12);color:var(--green);border:2px solid var(--green)}
.vpill.hold{background:rgba(245,158,11,.12);color:var(--amber);border:2px solid var(--amber)}
.vpill.sell{background:rgba(239,68,68,.12);color:var(--red);border:2px solid var(--red)}
@keyframes vg{0%{box-shadow:0 0 16px rgba(59,130,246,.05)}100%{box-shadow:0 0 32px rgba(59,130,246,.12)}}

/* Tables */
.dt{width:100%;border-collapse:collapse}
.dt th{padding:12px 14px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:600;border-bottom:1px solid #e5e7eb;background:#f8f9fa}
.dt td{padding:12px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;color:var(--text2);transition:background .2s}
.dt tr:hover td{background:#f8f9fa}.dt tr:last-child td{border-bottom:none}

/* Decision list */
.dl{list-style:none;padding:0}.dl li{padding:12px 0 12px 32px;position:relative;font-size:13px;color:var(--text2);line-height:1.7;border-bottom:1px solid var(--border)}
.dl li:last-child{border-bottom:none}.dl li::before{content:'';position:absolute;left:0;top:16px;width:18px;height:18px;border-radius:50%;background:rgba(0,120,212,.12);border:1.5px solid var(--blue)}
.dl li strong{color:var(--text)}

/* Price tags */
.ptag{display:inline-block;padding:5px 12px;border-radius:6px;font-family:var(--mono);font-size:13px;font-weight:600}
.ptag.buy{background:rgba(16,185,129,.08);color:var(--green);border:1px solid rgba(16,185,129,.2)}
.ptag.cur{background:rgba(0,120,212,.08);color:var(--blue);border:1px solid rgba(0,120,212,.25)}
.ptag.pro{background:rgba(245,158,11,.08);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.ptag.stp{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2)}

/* Signals */
.sig{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:5px;font-size:11px;font-weight:700}
.sig.g{background:rgba(16,185,129,.1);color:var(--green)}.sig.c{background:rgba(245,158,11,.1);color:var(--amber)}
.sig.r{background:rgba(239,68,68,.1);color:var(--red)}.sig.n{background:rgba(148,163,184,.08);color:var(--text3)}

/* Info cards */
.ic{padding:18px;border-radius:10px;margin-bottom:12px;border-left:3px solid}
.ic h5{font-size:14px;font-weight:700;margin-bottom:6px}.ic p{font-size:13px;line-height:1.8;color:var(--text2)}
.ic.bl{background:rgba(59,130,246,.03);border-color:var(--blue)}.ic.bl h5{color:var(--blue)}
.ic.am{background:rgba(245,158,11,.03);border-color:var(--amber)}.ic.am h5{color:var(--amber)}
.ic.gr{background:rgba(16,185,129,.03);border-color:var(--green)}.ic.gr h5{color:var(--green)}
.ic.rd{background:rgba(239,68,68,.03);border-color:var(--red)}.ic.rd h5{color:var(--red)}
.ic.pu{background:rgba(139,92,246,.03);border-color:var(--purple)}.ic.pu h5{color:var(--purple)}

.aix{display:inline-flex;align-items:center;gap:5px;cursor:pointer;color:var(--blue);font-size:12px;font-weight:600;padding:6px 0;transition:color .2s}.aix:hover{color:var(--blue2)}
.ait{line-height:1.9;color:var(--text2);font-size:13px;white-space:pre-wrap}
.ait::-webkit-scrollbar{width:5px}.ait::-webkit-scrollbar-track{background:var(--bg);border-radius:3px}.ait::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px}.ait::-webkit-scrollbar-thumb:hover{background:rgba(59,130,246,.4)}

/* 52-week position bar */
.w52bar{position:relative;height:6px;background:#e5e7eb;border-radius:3px;margin:8px 0 4px;overflow:visible}
.w52fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--red),var(--amber),var(--green))}
.w52dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:var(--blue);border:2px solid #fff;box-shadow:0 0 8px rgba(59,130,246,.4);z-index:2}
.w52labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--text3)}
.dec-input{background:#ffffff;border:1px solid #d1d5db;border-radius:8px;padding:8px 12px;color:var(--text);font-family:var(--mono);font-size:14px;font-weight:700;width:130px;text-align:right;outline:none;transition:border .2s}
.dec-input:focus{border-color:var(--blue)}
.dec-badge{display:inline-flex;align-items:center;gap:4px;padding:6px 14px;border-radius:8px;font-family:'Sora',sans-serif;font-size:13px;font-weight:800;letter-spacing:.5px}
.dec-meter{height:6px;border-radius:3px;background:#e5e7eb;overflow:hidden;margin:4px 0}
.dec-meter-fill{height:100%;border-radius:3px;transition:width .8s ease}

/* Score bar */
.scorebar{height:6px;background:rgba(148,163,184,.1);border-radius:3px;overflow:hidden;margin:6px 0}
.scorefill{height:100%;border-radius:3px;transition:width .8s ease}

/* Footer */
footer{position:relative;z-index:1;margin-top:32px;background:#003366;border-top:none}
.ftop{max-width:1080px;margin:0 auto;padding:48px 28px 32px;display:grid;grid-template-columns:1.4fr 1fr 1fr;gap:40px}
.ftop h5{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:#fff;margin-bottom:14px}
.ftop p{font-size:12px;color:var(--text3);line-height:1.8;margin-bottom:8px}
.fbrand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.fblogo{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,#ffffff,#e0e7f0);display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:#0087d2}
.fbname{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:#fff}.fbname span{color:var(--blue)}
.ffeature{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text3);padding:5px 0}
.ffeature::before{content:'\2713';color:var(--green);font-weight:700;font-size:10px}
.fdisc{max-width:1080px;margin:0 auto;padding:0 28px 32px}
.fdbox{padding:24px;border-radius:12px;background:rgba(239,68,68,.05);border:1.5px solid rgba(239,68,68,.2);position:relative;overflow:hidden}
.fdbox::before{content:'\26A0';position:absolute;top:12px;right:16px;font-size:44px;opacity:.06}
.fdbox h4{color:var(--red);font-size:13px;font-weight:800;margin-bottom:12px;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:6px}
.fdbox p{color:var(--text2);font-size:12px;line-height:1.8;margin-bottom:8px;padding-left:14px;border-left:2px solid rgba(239,68,68,.15)}
.fdbox p strong{color:var(--red);font-weight:700}
.fdbox p:last-child{margin-bottom:0}
.fbot{max-width:1080px;margin:0 auto;padding:24px 28px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.fcopy{font-size:11px;color:var(--text3)}.fcopy strong{color:var(--text2)}
.flinks{display:flex;gap:16px}.flinks a{font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s}.flinks a:hover{color:var(--blue)}

@media(max-width:768px){.irow{grid-template-columns:1fr}.mgrid{grid-template-columns:1fr 1fr}.cgrid,.cgrid2{grid-template-columns:1fr}.hero{padding:20px 16px 12px}.hero h1{font-size:26px}.ncenter,.nright{display:none}.sc{padding:0}.ftop{grid-template-columns:1fr;gap:24px}.fbot{flex-direction:column;text-align:center}.tab-btn{font-size:10px;padding:8px 10px;gap:3px}.tab-btn .tab-icon{width:18px;height:18px;font-size:11px;border-radius:3px}.tab-bar{position:sticky;top:60px;padding:0 4px}.sub-nav{top:105px}.tab-scroll-area{padding:10px}.fab{bottom:96px;right:16px;padding:8px 16px;font-size:12px}.edu-bar{padding:10px 12px}.edu-bar .edu-lines{gap:3px 12px}.edu-bar .edu-line{font-size:9px}.feat-card{padding:8px}.icard{padding:16px;border-radius:12px}#convGrid{grid-template-columns:1fr !important}}
@media(max-width:480px){.mgrid{grid-template-columns:1fr}.hbadges{flex-direction:column;align-items:center}}

/* FLOATING FEEDBACK PANEL */
.fab{position:fixed;bottom:100px;right:24px;z-index:200;display:flex;align-items:center;gap:6px;padding:10px 20px;border-radius:100px;font-size:13px;font-weight:700;color:#fff;background:linear-gradient(135deg,#0087d2,#6561ac);cursor:pointer;box-shadow:0 4px 16px rgba(0,135,210,.25);transition:all .3s;border:none;font-family:'DM Sans',sans-serif;letter-spacing:.2px;animation:fabBounce 3s ease-in-out infinite}
.edu-bar{position:fixed;bottom:0;left:0;width:100%;z-index:199;padding:14px 24px;background:rgba(255,255,255,0.98);border-top:1px solid rgba(208,2,27,.15);backdrop-filter:blur(12px)}
.edu-bar .edu-title{font-family:'Sora',sans-serif;font-size:12px;font-weight:800;color:var(--red);letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.edu-bar .edu-lines{display:flex;flex-wrap:wrap;gap:4px 20px}
.edu-bar .edu-line{font-size:10px;color:var(--text3);line-height:1.5;padding-left:10px;border-left:2px solid rgba(239,68,68,.3)}
.edu-bar .edu-line strong{color:var(--red);font-weight:700;font-size:10px;letter-spacing:.3px}
.fab:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 8px 30px rgba(59,130,246,.4);animation:none}
.fab .pulse{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pdot 2s infinite}
@keyframes fabBounce{0%,100%{transform:translateY(0);box-shadow:0 4px 20px rgba(59,130,246,.3)}25%{transform:translateY(-8px);box-shadow:0 12px 30px rgba(139,92,246,.4)}50%{transform:translateY(0);box-shadow:0 4px 20px rgba(59,130,246,.3)}75%{transform:translateY(-4px);box-shadow:0 8px 25px rgba(139,92,246,.35)}}
@keyframes notifPop{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}

/* Slide panel */
.fpanel{position:fixed;top:0;right:-480px;width:460px;max-width:92vw;height:100vh;z-index:300;background:#f0f2f5;border-left:1px solid var(--border2);overflow-y:auto;transition:right .4s cubic-bezier(.16,1,.3,1);box-shadow:-8px 0 40px rgba(0,0,0,.5)}
.fpanel.open{right:0}
.fpanel::-webkit-scrollbar{width:5px}.fpanel::-webkit-scrollbar-thumb{background:rgba(0,120,212,.25);border-radius:3px}
.fphdr{position:sticky;top:0;z-index:1;padding:20px 24px;background:rgba(255,255,255,.98);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.fphdr h3{font-family:'Sora',sans-serif;font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--amber),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.fpclose{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.fpclose:hover{background:rgba(239,68,68,.1);color:var(--red);border-color:rgba(239,68,68,.2)}
.fpbody{padding:20px 24px 32px}
.fpbody .sub{font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:24px}

/* Feature cards (panel version) */
.pfcard{background:#ffffff;border:1px solid #dcdcdc;border-radius:4px;padding:16px;margin-bottom:10px;transition:all .2s}
.pfcard:hover{border-color:#0087d2}
.pfcard .pfrow{display:flex;align-items:flex-start;gap:12px}
.pfcard .pficon{font-size:24px;flex-shrink:0;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(59,130,246,.05)}
.pfcard .pfinfo{flex:1;min-width:0}
.pfcard .pfname{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;display:flex;align-items:center;gap:6px}
.pfcard .pfdesc{font-size:11px;color:var(--text3);line-height:1.6}
.pfcard .ftag{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;padding:2px 7px;border-radius:100px}
.ftag.hot{background:rgba(205,0,75,.06);color:#cd004b;border:1px solid rgba(205,0,75,.15)}
.ftag.new{background:rgba(0,135,210,.06);color:#0087d2;border:1px solid rgba(0,135,210,.15)}
.ftag.pro{background:rgba(101,97,172,.06);color:#6561ac;border:1px solid rgba(101,97,172,.15)}
.ftag.live{background:rgba(14,178,78,.08);color:#0eb24e;border:1px solid rgba(14,178,78,.2);animation:pulse 2s infinite}

/* Vote buttons */
.pvbtns{display:flex;gap:6px;margin-top:10px}
.pvbtn{display:flex;align-items:center;gap:4px;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text3);font-family:'DM Sans',sans-serif}
.pvbtn:hover{transform:scale(1.05)}
.pvbtn.up:hover,.pvbtn.up.voted{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3);color:var(--green)}
.pvbtn.dn:hover,.pvbtn.dn.voted{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:var(--red)}
.pvbtn .cnt{font-family:var(--mono);font-size:10px}
.pvbar{margin-top:6px;height:3px;border-radius:2px;background:rgba(148,163,184,.08);overflow:hidden}
.pvbar .vfill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--blue));transition:width .5s ease}

/* Vote chart in panel */
.vgp{margin-top:20px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px}
.vgp h4{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;text-align:center}
.vgp .vsub{font-size:10px;color:var(--text3);text-align:center;margin-bottom:12px}
.vgp .cc{height:200px}

.sendbox{text-align:center;margin-top:16px}
.sendbtn{display:inline-flex;align-items:center;gap:6px;padding:9px 20px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid rgba(59,130,246,.3);background:rgba(59,130,246,.06);color:var(--blue);transition:all .3s;font-family:'DM Sans',sans-serif;width:100%}
.sendbtn:hover{background:rgba(59,130,246,.12)}

/* Backdrop */
.fpbk{position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .3s}
.fpbk.open{opacity:1;pointer-events:auto}

@media(max-width:768px){.fab{bottom:96px;right:16px;padding:8px 16px;font-size:12px}}

/* Allow users to copy prices, data, and analysis text */
.hbadges,.tab-bar,.fab,.nav,.sh{-webkit-user-select:none;-moz-user-select:none;user-select:none}

/* Back to top button */
.btt{position:fixed;bottom:100px;left:24px;z-index:200;padding:8px 16px;border-radius:100px;font-size:12px;font-weight:700;color:var(--text3);background:var(--surface);border:1px solid var(--border);cursor:pointer;opacity:0;transform:translateY(20px);transition:all .3s;font-family:'DM Sans',sans-serif}
.btt.show{opacity:1;transform:translateY(0)}
.btt:hover{color:var(--blue);border-color:var(--blue);background:rgba(59,130,246,.06)}

/* Scroll down hint between charts and tabs */
.sub-nav{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;padding:10px 14px;position:sticky;top:140px;z-index:96;background:rgba(255,255,255,.97);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,47,108,.08);margin-left:-18px;margin-right:-18px}
.sub-nav a{font-size:11px;font-weight:700;padding:6px 14px;border-radius:100px;text-decoration:none;transition:all .25s;cursor:pointer;white-space:nowrap;letter-spacing:.2px}
/* Summary sub-tab colors */
.sub-nav[data-tab="quick"] a:nth-child(1){color:#14a23a;background:rgba(20,162,58,.08);border:1.5px solid rgba(20,162,58,.2)}
.sub-nav[data-tab="quick"] a:nth-child(2){color:#2563eb;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.2)}
.sub-nav[data-tab="quick"] a:nth-child(3){color:#7c3aed;background:rgba(124,58,237,.08);border:1.5px solid rgba(124,58,237,.2)}
.sub-nav[data-tab="quick"] a:nth-child(4){color:#0891b2;background:rgba(8,145,178,.08);border:1.5px solid rgba(8,145,178,.2)}
.sub-nav[data-tab="quick"] a:nth-child(5){color:#dc2626;background:rgba(220,38,38,.08);border:1.5px solid rgba(220,38,38,.2)}
.sub-nav[data-tab="quick"] a:nth-child(6){color:#0d9488;background:rgba(13,148,136,.08);border:1.5px solid rgba(13,148,136,.2)}
.sub-nav[data-tab="quick"] a:nth-child(7){color:#d97706;background:rgba(217,119,6,.08);border:1.5px solid rgba(217,119,6,.2)}
/* Deep Dive sub-tab colors */
.sub-nav[data-tab="deep"] a:nth-child(1){color:#1a5fb4;background:rgba(26,95,180,.08);border:1.5px solid rgba(26,95,180,.2)}
.sub-nav[data-tab="deep"] a:nth-child(2){color:#7c3aed;background:rgba(124,58,237,.08);border:1.5px solid rgba(124,58,237,.2)}
/* Earnings sub-tab colors */
.sub-nav[data-tab="mgmt"] a:nth-child(1){color:#14a23a;background:rgba(20,162,58,.08);border:1.5px solid rgba(20,162,58,.2)}
.sub-nav[data-tab="mgmt"] a:nth-child(2){color:#7c3aed;background:rgba(124,58,237,.08);border:1.5px solid rgba(124,58,237,.2)}
.sub-nav[data-tab="mgmt"] a:nth-child(3){color:#2563eb;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.2)}
/* Picks sub-tab colors */
.sub-nav[data-tab="picks"] a:nth-child(1){color:#0d9488;background:rgba(13,148,136,.08);border:1.5px solid rgba(13,148,136,.2)}
.sub-nav[data-tab="picks"] a:nth-child(2){color:#d97706;background:rgba(217,119,6,.08);border:1.5px solid rgba(217,119,6,.2)}
.sub-nav[data-tab="picks"] a:nth-child(3){color:#2563eb;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.2)}
/* Hover — intensify */
.sub-nav a:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.1);filter:brightness(1.05)}
.sub-nav[data-tab]{display:none}
@keyframes scrollBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
@keyframes eventSlide{from{opacity:0;transform:translateY(-20px);max-height:0}to{opacity:1;transform:translateY(0);max-height:300px}}
@keyframes eventGlow{0%,100%{box-shadow:0 0 15px rgba(245,158,11,.15),inset 0 0 15px rgba(245,158,11,.03)}50%{box-shadow:0 0 30px rgba(245,158,11,.25),inset 0 0 20px rgba(245,158,11,.05)}}
@keyframes eventGlowHigh{0%,100%{box-shadow:0 0 15px rgba(239,68,68,.2),inset 0 0 15px rgba(239,68,68,.03)}50%{box-shadow:0 0 35px rgba(239,68,68,.35),inset 0 0 20px rgba(239,68,68,.06)}}
@keyframes borderShimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.global-ticker{width:100%;overflow:hidden;background:#003366;border-bottom:none;padding:8px 0;position:fixed;top:0;left:0;z-index:100}
.global-ticker .ticker-track{display:flex;gap:0;animation:tickerScroll 40s linear infinite;width:max-content}
.global-ticker .ticker-track:hover{animation-play-state:paused}
.global-ticker .ti{display:flex;align-items:center;gap:6px;font-size:12px;white-space:nowrap;padding:0 16px;border-right:1px solid rgba(255,255,255,.12)}
.global-ticker .ti .tn{color:rgba(255,255,255,.65);font-weight:700;font-size:11px;letter-spacing:.3px}
.global-ticker .ti .tp{font-family:var(--mono);font-weight:800;font-size:13px;color:#ffffff}
.global-ticker .ti .tc{font-size:11px;font-weight:700}
.global-ticker .tc.up{color:#4ade80}.global-ticker .tc.dn{color:#ff6b6b}.global-ticker .tc.fl{color:rgba(255,255,255,.5)}
.cinf{margin-top:8px;padding:8px 10px;border-radius:6px;border:1px solid;font-size:11px;color:var(--text2);line-height:1.6}
.cinf:empty{display:none}
.ptab{font-size:10px;padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;font-weight:600;transition:all .2s;font-family:'DM Sans',sans-serif}
.ptab.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.ptab:hover:not(.active){background:rgba(0,120,212,.12);border-color:var(--blue)}
.pick-tbl{width:100%;border-collapse:collapse;font-size:11px}
.pick-tbl th{text-align:left;padding:6px 8px;font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.5px;border-bottom:1px solid var(--border);text-transform:uppercase}
.pick-tbl td{padding:6px 8px;border-bottom:1px solid rgba(0,47,108,.03);color:var(--text2);vertical-align:top}
.pick-tbl tr:hover td{background:rgba(59,130,246,.03)}
.pick-tbl .cname{font-weight:700;color:var(--text);font-size:12px}
.pick-tbl .csub{font-size:9px;color:var(--text3)}
.pick-tbl .flag{font-size:10px;padding:1px 6px;border-radius:4px;font-weight:700;white-space:nowrap}
.pick-tbl .flag.g{background:rgba(16,185,129,.1);color:var(--green)}
.pick-tbl .flag.r{background:rgba(239,68,68,.1);color:var(--red)}
.pick-tbl .flag.b{background:rgba(0,120,212,.12);color:var(--blue)}
.pick-geo{display:flex;gap:6px;margin-bottom:8px}
.pick-geo button{font-size:9px;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text3);cursor:pointer;font-weight:700;font-family:'DM Sans',sans-serif}
.pick-geo button.active{background:var(--amber);color:#000;border-color:var(--amber)}
.event-alert-global{animation:eventSlide .5s ease-out;overflow:hidden;margin-bottom:0;border-radius:12px;position:relative}
.evt-bar{display:flex;flex-direction:column;gap:6px;padding:8px 14px;border-radius:10px;background:linear-gradient(135deg,rgba(245,158,11,.04),rgba(239,68,68,.03));border:1px solid rgba(245,158,11,.12);overflow:hidden;position:relative}
.evt-row{display:flex;align-items:center;gap:8px;width:100%}
.evt-label{font-family:'Sora',sans-serif;font-size:9px;font-weight:800;color:var(--amber);letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.evt-scroll-wrap{overflow:hidden;flex:1;min-width:0;mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent);-webkit-mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent)}
.evt-scroll{display:flex;gap:8px;animation:evtScrollLive 35s linear infinite;width:max-content;padding:2px 0}
.evt-scroll:hover{animation-play-state:paused}
@keyframes evtScrollLive{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.evt-chip{position:relative;flex-shrink:0;display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;cursor:default;transition:all .2s;font-size:10px;font-weight:600;white-space:nowrap;border:1px solid rgba(0,47,108,.06)}
.evt-chip:hover{transform:translateY(-1px);z-index:10}
.evt-sev{font-size:7px;font-weight:900;color:#fff;padding:1px 4px;border-radius:3px;flex-shrink:0}
.evt-arrow{font-size:8px}
.evt-upcoming-wrap{overflow:hidden;flex:1;min-width:0;mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent);-webkit-mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent)}
.evt-upcoming{display:flex;gap:8px;animation:evtScroll 30s linear infinite;width:max-content;padding:2px 0}
.evt-upcoming:hover{animation-play-state:paused}
@keyframes evtScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.evt-upcoming .evt-up{font-size:9px;padding:3px 8px;border-radius:6px;background:rgba(59,130,246,.06);border:1px solid rgba(0,120,212,.12);color:var(--text2);white-space:nowrap;flex-shrink:0}
.event-alert-global::before{content:'';position:absolute;inset:-2px;border-radius:14px;background:linear-gradient(90deg,transparent,rgba(245,158,11,.4),transparent,rgba(239,68,68,.3),transparent);background-size:300% 100%;animation:borderShimmer 4s linear infinite;z-index:-1}
.event-alert-global.high::before{background:linear-gradient(90deg,transparent,rgba(239,68,68,.5),transparent,rgba(245,158,11,.4),transparent);background-size:300% 100%}
.event-dismiss{position:absolute;top:8px;right:10px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:4px;transition:all .2s}
.event-dismiss:hover{color:var(--text);background:rgba(255,255,255,.1)}
.ipt,input,textarea{-webkit-user-select:text;-moz-user-select:text;user-select:text}

/* ═══ ANTI-SCREENSHOT & ANTI-SHARING PROTECTIONS ═══ */
/* ALL report content cannot be selected, copied, or printed */
.rpt, .rpt *, .sc, .sc *, [data-tab], [data-tab] *, #decisionTool, #decisionResult {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  user-select: none !important;
  -webkit-touch-callout: none !important;
  -webkit-user-drag: none !important;
}
/* Allow typing in inputs only */
#buyPriceInput, .ipt, input, textarea { -webkit-user-select: text !important; -moz-user-select: text !important; user-select: text !important; }
/* Hide ALL report content when printing */
@media print {
  .rpt, #report, .tab-bar, .global-ticker, .site-watermark, .fab, .fpanel {
    display: none !important;
    visibility: hidden !important;
  }
  body::before {
    content: "This report is confidential. Content cannot be printed. — celesys.ai";
    display: block;
    text-align: center;
    font-size: 24px;
    padding: 60px;
    color: #666;
  }
}
/* Global site watermark */
.site-watermark{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;overflow:hidden;opacity:.06}
.site-watermark span{position:absolute;font-size:12px;font-weight:800;color:#0087d2;transform:rotate(-35deg);white-space:nowrap;letter-spacing:2px;font-family:'Sora',sans-serif;user-select:none;-webkit-user-select:none}
/* Watermark overlay for trades */
.trades-watermark {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 10;
  overflow: hidden;
  opacity: 0.04;
}
.trades-watermark-text {
  position: absolute;
  font-size: 14px;
  font-weight: 800;
  color: #0087d2;
  transform: rotate(-35deg);
  white-space: nowrap;
  letter-spacing: 2px;
  font-family: 'Sora', sans-serif;
}
/* Blur ALL report content when page is not visible (anti-screenshot) */
.trades-blurred .rpt .sbody, .trades-blurred .rpt .mgrid, .trades-blurred .rpt .tab-bar, .trades-blurred #decisionResult {
  filter: blur(20px) !important;
  transition: filter 0.1s;
}
.trades-blurred .rpt .sbody::after, .trades-blurred .rpt .mgrid::after, .trades-blurred #decisionResult::after {
  content: "Content hidden for security";
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 16px;
  font-weight: 700;
  color: var(--amber);
  z-index: 100;
}
</style>
</head>
<body>
<!-- Global Watermark -->
<div class="site-watermark" id="siteWatermark"></div>
<script>
(function(){const w=document.getElementById('siteWatermark');if(!w)return;let h='';for(let row=0;row<40;row++){for(let col=0;col<10;col++){const t=row*100+Math.random()*40;const l=col*200+Math.random()*60;h+=`<span style="top:${t}px;left:${l}px">CELESYS.AI • CONFIDENTIAL</span>`;}}w.innerHTML=h;})();
</script>
<!-- Global Indices Ticker — loads on page visit -->
<div class="global-ticker" id="globalTicker">
<div class="ticker-track" id="tickerTrack">
<span style="font-size:10px;color:var(--text3);padding:0 8px">Loading global markets...</span>
</div>
</div>
<div class="gridbg"></div>

<nav>
<div class="nbrand">
<div class="nlogo">S</div>
<div><div class="nname">CELESYS <span>AI</span></div><div class="ntag">Research Platform</div></div>
</div>
<div class="ncenter">
<div class="npill">Reports: <span class="v" id="navRC">0</span></div>
<div class="npill">Quota: <span class="v" id="navQ">5/hr</span></div>
</div>
<div class="nright">
<div class="nlive"><div class="ldot"></div> Live Market Data</div>

</div>
</nav>
<div class="sticky-tagline" id="stickyTag"><span>Stock Intelligence, Instantly</span><span id="stickyCompany" style="display:none;margin-left:12px;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;color:var(--text2);-webkit-text-fill-color:var(--text2);padding-left:12px;border-left:1px solid rgba(0,47,108,.1)"></span></div>

<section class="hero">
<h1>Stock Intelligence, Instantly.</h1>
<p class="hero-sub" style="font-size:15px;line-height:1.6;max-width:560px;margin-bottom:20px">Free institutional-grade analysis with buy/sell levels, risk scoring &amp; AI verdicts. <span style="font-size:12px;color:var(--red);font-weight:600">For educational purposes only.</span></p>

<!-- GLOBAL EVENTS & UPCOMING — visible on page load -->
<div id="eventAlertArea" style="display:none;margin:0 auto 12px;max-width:680px;width:100%;text-align:left"></div>

<!-- SEARCH CARD — The centerpiece -->
<div class="icard" style="max-width:680px;margin:0 auto 18px;text-align:left">
<div class="irow">
<input class="ipt" type="email" id="email" aria-label="Your email address" placeholder="your@email.com" autocomplete="off" data-lpignore="true" onfocus="if(this.dataset.real){this.type='email';this.value=this.dataset.real}" onblur="if(this.value.includes('@')){this.dataset.real=this.value;const p=this.value.split('@');this.value=p[0][0]+'***@'+p[1];this.type='text'}">
<div class="iwrap"><input class="ipt" type="text" id="ticker" aria-label="Stock ticker or company name" placeholder="Search any stock... AAPL, RELIANCE.NS" autocomplete="off"><div class="ac" id="autocomplete"></div></div>
<button class="btn" id="btn" aria-label="Analyze stock" onclick="analyze()">Analyze &#8594;</button>
</div>

<div style="margin-top:10px;font-size:10px;color:var(--text3);display:flex;align-items:center;gap:10px;flex-wrap:wrap">
<span>&#128293; <strong style="color:var(--text2)">5 free reports</strong>/email/hour</span>
<span>&middot;</span>
<span>&#128270; <a href="https://finance.yahoo.com/lookup" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none">Can't find ticker? Search Yahoo Finance</a></span>
</div>

<div class="sbar" id="status"></div>
<div class="lsteps" id="lsteps">
<div class="ls" id="s1"><div class="lsi">1</div> Pulling live market data &amp; financials...</div>
<div class="ls" id="s2"><div class="lsi">2</div> AI crunching valuation &amp; fundamentals...</div>
<div class="ls" id="s3"><div class="lsi">3</div> Computing entry, exit &amp; stop-loss prices...</div>
<div class="ls" id="s4"><div class="lsi">4</div> Scoring risk &amp; finding hidden gem small-caps...</div>
</div>
<div class="rlbox" id="rateLimitBox">
<div style="font-size:13px;font-weight:600;color:var(--amber)">Report limit reached</div>
<div class="rlcd" id="rlCountdown">--:--</div>
<div class="rlmsg" id="rlComeback"></div>
<div class="rlbar"><div class="rlbf" id="rlProgress" style="width:0%"></div></div>
</div>
</div>

<!-- WHAT YOU GET — Feature highlights -->
<div style="max-width:680px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
<div class="feat-card" style="border-top:3px solid var(--green)">
<div style="font-size:20px;margin-bottom:6px">&#9889;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">AI Verdict</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Buy/Hold/Sell with 20-factor deep analysis</div>
</div>
<div class="feat-card" style="border-top:3px solid var(--blue)">
<div style="font-size:20px;margin-bottom:6px">&#128200;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">Charts &amp; Technicals</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Valuation, trend, risk, margin charts</div>
</div>
<div class="feat-card" style="border-top:3px solid var(--purple)">
<div style="font-size:20px;margin-bottom:6px">&#127919;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">Entry &amp; Exit</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Exact buy, sell &amp; stop-loss prices</div>
</div>
<div class="feat-card" style="border-top:3px solid var(--red)">
<div style="font-size:20px;margin-bottom:6px">&#9888;&#65039;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">Risk Profiling</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Beta, volatility, downside risks</div>
</div>
</div>

<div style="text-align:center;margin-top:6px;font-size:10px;color:var(--text3)">
<span id="globalRC" style="display:none">0</span>
</div>
</section>


<section class="rpt" id="report">
<noscript>
<div style="max-width:720px;margin:0 auto;padding:40px 20px;text-align:center">
<h2 style="font-family:'Sora',sans-serif;font-size:22px;color:#1a1a2e;margin-bottom:16px">Celesys AI — Free AI Stock Analysis</h2>
<p style="font-size:14px;color:#555;line-height:1.8;margin-bottom:16px">Celesys AI provides free, institutional-grade stock analysis for US (NYSE, NASDAQ) and Indian (NSE, BSE) markets. Get real-time valuation metrics, intrinsic value estimates (Graham Number, DCF model), 20-factor buy/sell verdicts, quarterly earnings analysis, management tone assessment, entry/exit price levels, risk scoring, and curated small-cap stock picks.</p>
<p style="font-size:14px;color:#555;line-height:1.8;margin-bottom:16px">Analyze stocks like Apple (AAPL), Microsoft (MSFT), NVIDIA (NVDA), Tesla (TSLA), Reliance Industries (RELIANCE.NS), HDFC Bank (HDFCBANK.NS), TCS (TCS.NS), Infosys (INFY), and 10,000+ more tickers. No signup required.</p>
<p style="font-size:13px;color:#888;margin-bottom:24px">This application requires JavaScript to run. Please enable JavaScript in your browser to use Celesys AI.</p>
<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:12px;font-size:13px">
<a href="/about" style="color:#3b82f6">About</a>
<a href="/faq" style="color:#3b82f6">FAQ</a>
<a href="/disclaimer" style="color:#3b82f6">Disclaimer</a>
<a href="/privacy" style="color:#3b82f6">Privacy</a>
<a href="/terms" style="color:#3b82f6">Terms</a>
<a href="/contact" style="color:#3b82f6">Contact</a>
</div>
</div>
</noscript>
<div class="rphero">
<div class="rptk" id="tickerTag"></div>
<div class="rpco" id="companyName"></div>
<div class="rplv" id="timestamp"><div class="ldot"></div></div>
</div>
<div class="mgrid" id="metrics"></div>

<!-- Hidden 52W section for JS compatibility -->
<div id="w52section" style="display:none"></div>
<!-- AI Price Prediction -->
<div id="pricePrediction" style="display:none"></div>
<div id="techProSection" style="display:none"></div>
<div id="earningsSection" style="display:none"></div>
<div id="insiderSection" style="display:none"></div>

<!-- STATIC TAB BAR — always visible right after metrics -->
<!-- ACTION TOOLBAR -->
<div style="display:flex;gap:6px;flex-wrap:wrap;padding:6px 8px;justify-content:flex-end;align-items:center;background:#ffffff;border-bottom:1px solid #dcdcdc" id="actionToolbar">
<button onclick="toggleTheme()" id="themeToggleBtn" style="padding:5px 12px;border-radius:4px;background:#ffffff;border:1px solid #dcdcdc;color:#4a4a4a;font-size:10px;font-weight:600;cursor:pointer;font-family:Sora,sans-serif" title="Toggle Dark/Light Mode">&#127763; Dark</button>
<button onclick="exportPDF()" id="pdfExportBtn" style="padding:5px 12px;border-radius:4px;background:#ffffff;border:1px solid #dcdcdc;color:#cd004b;font-size:10px;font-weight:600;cursor:pointer;font-family:Sora,sans-serif" title="Export as PDF">&#128196; PDF</button>
<button onclick="shareReport('whatsapp')" style="padding:5px 12px;border-radius:4px;background:#ffffff;border:1px solid #dcdcdc;color:#0eb24e;font-size:10px;font-weight:600;cursor:pointer;font-family:Sora,sans-serif" title="Share on WhatsApp">&#128172; WhatsApp</button>
<button onclick="shareReport('email')" style="padding:5px 12px;border-radius:4px;background:#ffffff;border:1px solid #dcdcdc;color:#0087d2;font-size:10px;font-weight:600;cursor:pointer;font-family:Sora,sans-serif" title="Share via Email">&#128231; Email</button>
<button onclick="shareReport('copy')" id="copyShareBtn" style="padding:5px 12px;border-radius:4px;background:#ffffff;border:1px solid #dcdcdc;color:#4a4a4a;font-size:10px;font-weight:600;cursor:pointer;font-family:Sora,sans-serif" title="Copy Link">&#128279; Copy</button>
</div>

<div class="tab-bar" id="mainTabBar">
<button class="tab-btn active" onclick="switchTab('quick')" id="tabBtnQuick" data-color="green" data-tip="Verdict, charts, valuation, buy/sell levels, risk"><span class="tab-icon">&#9889;</span> Summary</button>
<button class="tab-btn" onclick="switchTab('deep')" id="tabBtnDeep" data-color="navy" data-tip="AI color-coded verdict breakdown, full deep-dive"><span class="tab-icon">&#128270;</span> Deep Dive</button>
<button class="tab-btn" onclick="switchTab('mgmt')" id="tabBtnMgmt" data-color="purple" data-tip="Quarterly earnings, management tone, fund holdings"><span class="tab-icon">&#128200;</span> Earnings</button>
<button class="tab-btn" onclick="switchTab('next')" id="tabBtnNext" data-color="cyan" data-tip="Upcoming catalysts, bull/bear/base scenarios"><span class="tab-icon">&#128302;</span> Forecast</button>
<button class="tab-btn" onclick="switchTab('dcf')" id="tabBtnDCF" data-color="emerald" data-tip="Discounted Cash Flow intrinsic valuation"><span class="tab-icon">&#128178;</span> DCF</button>
<button class="tab-btn" onclick="switchTab('equity')" id="tabBtnEquity" data-color="gold" data-tip="Professional equity research report"><span class="tab-icon">&#128220;</span> Research</button>
<button class="tab-btn" onclick="switchTab('indices')" id="tabBtnIndices" data-color="teal" data-tip="Deep research on major US & India indices"><span class="tab-icon">&#127760;</span> Indices</button>
<button class="tab-btn" onclick="switchTab('finance')" id="tabBtnFinance" data-color="emerald" data-tip="Complete personal finance toolkit"><span class="tab-icon">&#128176;</span> My Finance</button>
<button class="tab-btn" onclick="switchTab('daily')" id="tabBtnDaily" data-color="navy" data-tip="Daily Nifty/BankNifty/Sensex analysis with options chain"><span class="tab-icon">&#128202;</span> Market Daily</button>
<button class="tab-btn" onclick="switchTab('compare')" id="tabBtnCompare" data-color="purple" data-tip="Compare 2 stocks side by side"><span class="tab-icon">&#9878;</span> Compare</button>
<button class="tab-btn" onclick="switchTab('gems')" id="tabBtnGems" data-color="amber" data-tip="Sector-specific small-cap picks" style="display:none"><span class="tab-icon">&#11088;</span> Gems</button>
<button class="tab-btn" onclick="switchTab('picks')" id="tabBtnPicks" data-color="teal" data-tip="Top 5 Buy, Sell, Accumulate stocks by conviction" style="display:none"><span class="tab-icon">&#127942;</span> Picks</button>
<button class="tab-btn" onclick="switchTab('funds')" id="tabBtnFunds" data-color="blue" data-tip="Top ETFs & mutual funds with 25%+ CAGR" style="display:none"><span class="tab-icon">&#128176;</span> ETF</button>
<button class="tab-btn" onclick="switchTab('trades')" id="tabBtnTrades" data-color="red" data-tip="Daily AI trade ideas for indices & stocks" style="display:none"><span class="tab-icon">&#128293;</span> Trades</button>
</div>

<!-- TAB CONTENT AREA -->
<div id="tabContentArea" style="min-height:60vh">

<!-- JS-GENERATED CONTENT GOES HERE -->
<div id="analysisContainer"></div>

<!-- ═══ TAB: INDEX RESEARCH ═══ -->
<div class="sc" data-tab="indices" style="border-left:3px solid #06b6d4;display:none"><div class="sh"><div class="si" style="background:rgba(6,182,212,.1)">&#127760;</div><div class="st" style="color:#06b6d4" id="sec-indices">Global Index Research — India &amp; USA</div></div>
<div class="sbody">
<div id="indicesContent"><div class="ic" style="text-align:center;background:rgba(6,182,212,.04)"><p style="color:var(--text3)">&#9203; Loading index research...</p></div></div>
</div></div>

<!-- ═══ TAB: PERSONAL FINANCE ═══ -->
<div class="sc" data-tab="finance" style="border-left:3px solid #10b981;display:none"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128176;</div><div class="st" style="color:#10b981" id="sec-finance">Personal Finance Toolkit</div></div>
<div class="sbody">
<div id="financeContent"><div class="ic" style="text-align:center;background:rgba(16,185,129,.04)"><p style="color:var(--text3)">&#9203; Loading finance tools...</p></div></div>
</div></div>

<!-- ═══ TAB: MARKET DAILY ═══ -->
<div class="sc" data-tab="daily" style="border-left:3px solid #1a5fb4;display:none"><div class="sh"><div class="si" style="background:rgba(26,95,180,.1)">&#128202;</div><div class="st" style="color:#1a5fb4" id="sec-daily">Market Daily — Nifty &middot; Bank Nifty &middot; Sensex</div></div>
<div class="sbody">
<div id="dailyContent"><div class="ic" style="text-align:center;background:rgba(26,95,180,.04)"><p style="color:var(--text3)">&#9203; Click the tab to load today's analysis...</p></div></div>
</div></div>

<!-- ═══ TAB: COMPARE STOCKS ═══ -->
<div class="sc" data-tab="compare" style="border-left:3px solid #7c3aed;display:none"><div class="sh"><div class="si" style="background:rgba(124,58,237,.1)">&#9878;</div><div class="st" style="color:#7c3aed" id="sec-compare">Compare 2 Stocks — Head to Head</div></div>
<div class="sbody">
<div style="padding:14px;border-radius:10px;background:rgba(124,58,237,.04);border-left:4px solid #7c3aed;margin-bottom:14px">
<div style="font-size:11px;font-weight:700;color:#7c3aed;margin-bottom:4px">&#128161; Like comparing 2 job offers — check every detail before deciding</div>
<div style="font-size:10px;color:var(--text2);line-height:1.7">Enter any two stocks and see them fight it out on 17 financial metrics. The winner is decided objectively — lower P/E is better, higher ROE is better, lower debt is better. But remember: numbers tell most of the story, not all of it. A company with higher P/E might deserve it if it is growing faster.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:end">
<div style="flex:1;min-width:160px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">Stock 1</label><input id="cmp_stock1" type="text" placeholder="e.g. TCS or Apple" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:12px;outline:none" /></div>
<div style="flex:1;min-width:160px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">Stock 2</label><input id="cmp_stock2" type="text" placeholder="e.g. Infosys or Microsoft" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:12px;outline:none" /></div>
<button onclick="compareStocks()" style="padding:10px 24px;border-radius:8px;background:#7c3aed;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif;white-space:nowrap">&#9878; Compare Now</button>
</div>
<div id="cmp_result"></div>
</div></div>

</div>
<div style="margin-top:16px;padding:12px 18px;border-radius:10px;background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.15);display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2)">
<span style="font-size:16px">&#9888;</span>
<span><strong style="color:var(--red)">Reminder:</strong> Past performance does not guarantee future results. You can lose money investing. Always do your own research.</span>
</div>
</section>


<!-- SEO CONTENT — Substantial static HTML for Google crawling -->
<article style="max-width:720px;margin:0 auto;padding:24px 20px 8px;font-size:12px;color:var(--text3);line-height:1.7" aria-label="About Celesys AI Stock Analysis Platform">

<h2 style="font-family:'Sora',sans-serif;font-size:16px;color:var(--text);margin-bottom:12px">Free AI-Powered Stock Analysis for Every Investor</h2>
<p>Celesys AI is a free stock research platform that generates institutional-grade analysis reports in under 60 seconds. Whether you invest in US markets (NYSE, NASDAQ, S&amp;P 500) or Indian markets (NSE, BSE, Nifty 50, Sensex), Celesys delivers the same depth of research that hedge funds pay thousands for — completely free, no signup required.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">How It Works</h3>
<p>Enter any stock ticker — like AAPL, MSFT, RELIANCE.NS, or HDFCBANK.NS — and Celesys AI pulls live market data from multiple sources including Yahoo Finance, Google Finance, and NSE India. The platform then runs a 20-factor quantitative scoring model that evaluates the stock across valuation (P/E ratio, P/B ratio, PEG ratio, EV/EBITDA), profitability (profit margin, ROE, operating margin, gross margin, EBITDA margin), financial health (debt-to-equity, current ratio, free cash flow, cash vs debt), and momentum (52-week position, SMA/EMA crossovers, earnings velocity, short interest). The result is a deterministic buy/sell verdict — Strong Buy, Buy, Hold, Sell, or Strong Sell — with a conviction score and full explanation.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">What You Get in Every Report</h3>
<p>Each Celesys AI report includes: real-time stock price and live market indicators, intrinsic value calculations using the Benjamin Graham Number, Discounted Cash Flow (DCF) growth model, Peter Lynch fair value (PEG-based), and earnings yield vs 10-year Treasury bond comparison. You also receive AI-generated entry and exit price levels with specific buy zones, accumulate levels, profit targets, and stop-loss prices — all computed from EMA crossovers, Fibonacci retracements, and 52-week range analysis. The risk assessment covers debt risk, liquidity risk, volatility (beta), sector risk, and 52-week positioning. Visual charts show valuation comparison, financial health radar, risk profile, 6-month price trend, and margin vs industry benchmarks.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Deep AI Analysis &amp; Earnings Intelligence</h3>
<p>Beyond numbers, Celesys AI generates a comprehensive written research report powered by advanced AI. This includes an investment thesis, quarterly fundamentals analysis with quarter-over-quarter (QoQ) and year-over-year (YoY) growth trends, management tone assessment with CEO/CFO confidence scoring, institutional and mutual fund holdings analysis, upcoming catalysts and timeline forecasts, and bull/bear/base case price predictions for the next 12 months. Every section ends with a plain-English inference explaining what the data means for a regular investor — no jargon, no confusion.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Markets &amp; Stocks Covered</h3>
<p>Celesys AI covers over 10,000 stocks across major global exchanges. US stocks include Apple (AAPL), Microsoft (MSFT), NVIDIA (NVDA), Alphabet/Google (GOOGL), Amazon (AMZN), Tesla (TSLA), Meta (META), JPMorgan (JPM), and all NYSE/NASDAQ-listed equities. Indian stocks include Reliance Industries (RELIANCE.NS), TCS (TCS.NS), HDFC Bank (HDFCBANK.NS), Infosys (INFY), ICICI Bank (ICICIBANK.NS), SBI (SBIN.NS), Bharti Airtel (BHARTIARTL.NS), ITC (ITC.NS), and all NSE/BSE-listed companies. The platform also tracks global market indices live: S&amp;P 500, NASDAQ Composite, Dow Jones, Nifty 50, Sensex, FTSE 100, DAX, Nikkei 225, and Hang Seng.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Additional Features</h3>
<p>Celesys AI offers curated small-cap stock picks with 10x growth potential ratings, daily AI-generated trade ideas for indices and stocks using option chain analysis (PCR, Max Pain, OI walls), FII/DII institutional flow tracking for Indian markets, a comprehensive geopolitical and economic event calendar covering Fed decisions, RBI policy, US CPI data, trade wars, and global macro events, and a position analyzer tool that calculates optimal position sizes based on your risk tolerance. The platform also provides top-performing ETF and mutual fund recommendations with historical CAGR analysis.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Why Celesys AI?</h3>
<p>Traditional stock research tools are either too expensive (Bloomberg Terminal costs $25,000/year), too complex (requires CFA-level knowledge), or too shallow (basic screeners with no analysis). Celesys AI bridges this gap by providing professional-grade research in simple, plain-English language that any investor can understand — whether you are a first-time investor learning about P/E ratios or an experienced trader looking for technical entry levels. The platform is completely free, requires no account creation, and delivers results in under 60 seconds.</p>

<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:12px;font-size:11px">
<span style="font-weight:600;color:var(--text2)">Learn more:</span>
<a href="/about" style="color:var(--blue);text-decoration:none">About Celesys AI</a>
<a href="/faq" style="color:var(--blue);text-decoration:none">Frequently Asked Questions</a>
<a href="/disclaimer" style="color:var(--blue);text-decoration:none">Investment Disclaimer</a>
<a href="/privacy" style="color:var(--blue);text-decoration:none">Privacy Policy</a>
<a href="/terms" style="color:var(--blue);text-decoration:none">Terms of Service</a>
<a href="/contact" style="color:var(--blue);text-decoration:none">Contact Us</a>
</div>
</article>

<footer>
<div style="max-width:1080px;margin:0 auto;padding:24px 28px 16px">
<!-- Brand + Links row -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
<div style="display:flex;align-items:center;gap:10px">
<div class="fblogo">S</div>
<div><div class="fbname">CELESYS <span>AI</span></div><div style="font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase">Research Platform</div></div>
</div>
<div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center">
<a href="/about" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">About</a>
<a href="/faq" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">FAQ</a>
<a href="/privacy" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Privacy</a>
<a href="/terms" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Terms</a>
<a href="/disclaimer" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Disclaimer</a>
<a href="mailto:contact@celesys.ai" style="font-size:11px;color:var(--blue);text-decoration:none">&#9993; contact@celesys.ai</a>
</div>
</div>
<!-- Copyright -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding-top:12px">
<div style="font-size:10px;color:var(--text3)">&copy; 2026 Celesys AI &middot; All rights reserved</div>
<div style="font-size:10px;color:var(--text3)">Real-time data &middot; AI-powered analysis &middot; Not financial advice</div>
</div>
</div>
</footer>

<!-- BACK TO TOP -->
<button class="btt" id="bttBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Back to top">&#8593; Top</button>

<script>

const stocks=[
{t:'AAPL',n:'Apple Inc.'},{t:'MSFT',n:'Microsoft Corporation'},{t:'GOOGL',r:'Strong Buy',n:'Alphabet Inc. (Google)',bp:'$165-175',d:'ACCUMULATE · Hold 12mo · Add below $175. AI search moat intact. Cloud growing 28%. 82% prob of $220+ in 12mo.'},{t:'AMZN',n:'Amazon.com Inc.'},
{t:'NVDA',n:'NVIDIA Corporation'},{t:'META',r:'Strong Buy',n:'Meta Platforms (Facebook)',bp:'$560-580',d:'WAIT · Buy at $570 · Trading at fair value. Wait for 8-10% pullback. 78% prob of $750+ in 12mo.'},{t:'TSLA',n:'Tesla Inc.'},{t:'BRK.B',n:'Berkshire Hathaway'},
{t:'LLY',n:'Eli Lilly and Company'},{t:'AVGO',n:'Broadcom Inc.'},{t:'JPM',r:'Strong Buy',n:'JPMorgan Chase & Co.',bp:'$230-245',d:'BUY ON DIP · Hold 12mo · Wait for rate cut fear selloff to ₹230-245. 77% prob of $300+ in 12mo.'},{t:'V',n:'Visa Inc.'},
{t:'UNH',n:'UnitedHealth Group'},{t:'XOM',n:'Exxon Mobil'},{t:'WMT',n:'Walmart Inc.'},{t:'MA',n:'Mastercard Inc.'},
{t:'PG',n:'Procter & Gamble'},{t:'JNJ',n:'Johnson & Johnson'},{t:'HD',n:'Home Depot'},{t:'ORCL',n:'Oracle Corporation'},
{t:'COST',n:'Costco Wholesale'},{t:'NFLX',n:'Netflix Inc.'},{t:'BAC',n:'Bank of America'},{t:'CRM',n:'Salesforce Inc.'},
{t:'ABBV',n:'AbbVie Inc.'},{t:'CVX',n:'Chevron Corporation'},{t:'AMD',n:'Advanced Micro Devices'},{t:'KO',n:'Coca-Cola Company'},
{t:'PEP',n:'PepsiCo Inc.'},{t:'MRK',r:'★ Aggressive Buy',n:'Merck & Co.',bp:'$95-100',d:'BUY NOW · Hold 12-18mo · P/E 14x is deeply cheap for Keytruda franchise. 80% prob of $130+ in 12mo.'},{t:'ADBE',n:'Adobe Inc.'},{t:'TMO',n:'Thermo Fisher Scientific'},
{t:'CSCO',n:'Cisco Systems'},{t:'ACN',n:'Accenture'},{t:'MCD',n:"McDonald's Corporation"},{t:'LIN',n:'Linde plc'},
{t:'ABT',n:'Abbott Laboratories'},{t:'WFC',n:'Wells Fargo'},{t:'TXN',n:'Texas Instruments'},{t:'INTC',n:'Intel Corporation'},
{t:'DIS',n:'Walt Disney Company'},{t:'PM',n:'Philip Morris'},{t:'CMCSA',n:'Comcast Corporation'},{t:'NKE',n:'Nike Inc.'},
{t:'QCOM',n:'Qualcomm Inc.'},{t:'GE',n:'General Electric'},{t:'INTU',n:'Intuit Inc.'},{t:'VZ',n:'Verizon Communications'},
{t:'AMAT',n:'Applied Materials'},{t:'CAT',n:'Caterpillar Inc.'},
{t:'RELIANCE.NS',n:'Reliance Industries'},{t:'TCS.NS',n:'Tata Consultancy Services'},{t:'HDFCBANK.NS',n:'HDFC Bank'},
{t:'INFY',n:'Infosys Limited'},{t:'HINDUNILVR.NS',n:'Hindustan Unilever'},{t:'ICICIBANK.NS',n:'ICICI Bank'},
{t:'SBIN.NS',n:'State Bank of India'},{t:'BHARTIARTL.NS',n:'Bharti Airtel'},{t:'ITC.NS',r:'★ Aggressive Buy',n:'ITC Limited',bp:'₹400-415',d:'BUY NOW · Hold 12-18mo · FMCG demerger + hotel listing catalyst by Q3 2026. 85% prob of ₹500+ in 12mo.'},
{t:'KOTAKBANK.NS',n:'Kotak Mahindra Bank'},{t:'LT.NS',r:'Strong Buy',n:'Larsen & Toubro',bp:'₹3,200-3,300',d:'WAIT · Buy at ₹3,200 · Order book strong but priced in. Wait for 5-8% correction. 75% prob of ₹4,000 in 12mo.'},{t:'AXISBANK.NS',n:'Axis Bank'},
{t:'BAJFINANCE.NS',n:'Bajaj Finance'},{t:'ASIANPAINT.NS',n:'Asian Paints'},{t:'MARUTI.NS',n:'Maruti Suzuki'},
{t:'TITAN.NS',n:'Titan Company'},{t:'SUNPHARMA.NS',n:'Sun Pharmaceutical'},{t:'ULTRACEMCO.NS',n:'UltraTech Cement'},
{t:'NESTLEIND.NS',n:'Nestlé India'},{t:'ONGC.NS',n:'Oil & Natural Gas Corp'},{t:'NTPC.NS',r:'Strong Buy',n:'NTPC Limited',bp:'₹310-325',d:'ACCUMULATE · Hold 6-12mo · Add on dips to ₹310-325. Green energy re-rating in progress. 78% prob of ₹400+ in 9mo.'},
{t:'TATAMOTORS.NS',n:'Tata Motors'},{t:'POWERGRID.NS',n:'Power Grid Corporation'},{t:'TATASTEEL.NS',n:'Tata Steel'},
{t:'M&M.NS',n:'Mahindra & Mahindra'},{t:'JSWSTEEL.NS',n:'JSW Steel'},{t:'ADANIENT.NS',n:'Adani Enterprises'},
{t:'WIPRO.NS',n:'Wipro Limited'},{t:'COALINDIA.NS',r:'★ Aggressive Buy',n:'Coal India',bp:'₹360-380',d:'BUY NOW · Hold 6mo · Dividend alone gives 6%+ yield. Cash cow. 82% prob of ₹450+ in 6mo on div reinvestment.'},{t:'HCLTECH.NS',n:'HCL Technologies'},
{t:'BAJAJFINSV.NS',n:'Bajaj Finserv'},{t:'DIVISLAB.NS',n:"Divi's Laboratories"},{t:'GRASIM.NS',n:'Grasim Industries'},
{t:'TECHM.NS',n:'Tech Mahindra'},{t:'BRITANNIA.NS',n:'Britannia Industries'},{t:'EICHERMOT.NS',n:'Eicher Motors'},
{t:'APOLLOHOSP.NS',n:'Apollo Hospitals'},{t:'INDUSINDBK.NS',n:'IndusInd Bank'},{t:'TRENT.NS',n:'Trent Limited'},
{t:'ADANIPORTS.NS',n:'Adani Ports'},{t:'HINDALCO.NS',n:'Hindalco Industries'},{t:'DRREDDY.NS',n:"Dr. Reddy's Labs"},
{t:'CIPLA.NS',n:'Cipla Limited'},{t:'HEROMOTOCO.NS',n:'Hero MotoCorp'},{t:'SHREECEM.NS',n:'Shree Cement'},
{t:'BAJAJ-AUTO.NS',n:'Bajaj Auto'},{t:'BPCL.NS',n:'Bharat Petroleum'},{t:'SIEMENS.NS',n:'Siemens India'},
{t:'KPIT.NS',n:'KPIT Technologies'},{t:'DIXON.NS',n:'Dixon Technologies'}
];
let valChart,trendChart,healthChart,riskChart,marginChart,qoqChart,yoyChart,marginTrendChart,countdownInterval=null;
const TI=document.getElementById('ticker'),AC=document.getElementById('autocomplete');
TI.addEventListener('input',function(){const v=this.value.trim().toUpperCase();AC.innerHTML='';if(!v){AC.classList.remove('show');return}
const m=stocks.filter(s=>s.t.includes(v)||s.n.toUpperCase().includes(v)).slice(0,10);if(!m.length){AC.classList.remove('show');return}
m.forEach(s=>{const d=document.createElement('div');d.className='aci';d.innerHTML=`<span class="act">${s.t}</span><span class="acn">${s.n}</span>`;d.onclick=()=>{TI.value=s.t;AC.classList.remove('show')};AC.appendChild(d)});AC.classList.add('show')});
document.addEventListener('click',e=>{if(e.target!==TI)AC.classList.remove('show')});
document.getElementById('email').addEventListener('keypress',e=>{if(e.key==='Enter')TI.focus()});
// Smart Trades tab: only visible for authorized email
const TRADES_EMAILS=['vijy.dhulipala@gmail.com'];
const PICKS_EMAILS=['vijy.dhulipala@gmail.com'];
let _pulseData=null;
let _pulseFetching=false,_pulseLoaded=false;
async function fetchMarketPulse(){
if(_pulseFetching)return;
_pulseFetching=true;
try{
const r=await fetch('/api/market-pulse');
const d=await r.json();
if(!d.success){console.log('Market pulse: no success');return}
_pulseData=d;_pulseLoaded=true;
console.log('Market pulse loaded:',d.events?.length||0,'events,',d.upcoming?.length||0,'upcoming');
renderMarketEvents();
try{renderFiiDii()}catch(e){console.warn('FiiDii render error:',e)}
}catch(e){console.log('Market pulse fetch error:',e)}
finally{_pulseFetching=false}
}
function renderMarketEvents(){
const div=document.getElementById('eventAlertArea');
if(!div||!_pulseData)return;
const d=_pulseData;
let hasContent=false;
let h='<div class="evt-bar">';
if(d.events&&d.events.length>0){
hasContent=true;
let liveChips='';
d.events.forEach((evt,idx)=>{
const isH=evt.severity==='HIGH';
const isM=evt.severity==='MEDIUM';
const sC=isH?'#ef4444':isM?'#f59e0b':'#3b82f6';
const iC=evt.impact==='BULLISH'?'#10b981':evt.impact==='BEARISH'?'#ef4444':'#f59e0b';
const iA=evt.impact==='BULLISH'?'&#9650;':evt.impact==='BEARISH'?'&#9660;':'&#8212;';
const bg=isH?'rgba(239,68,68,.08)':isM?'rgba(245,158,11,.06)':'rgba(59,130,246,.06)';
liveChips+=`<div class="evt-chip" style="background:${bg};border-color:${sC}22;color:${sC}" onmouseenter="showEvtTip(this,${idx})" onmouseleave="hideEvtTip()">
<span class="evt-sev" style="background:${sC}">${evt.severity.charAt(0)}</span>
${evt.headline}
<span class="evt-arrow" style="color:${iC}">${iA}</span>
</div>`;
});
// Duplicate for seamless loop
h+=`<div class="evt-row"><span style="font-size:12px;flex-shrink:0">&#128293;</span><span class="evt-label">LIVE</span><div class="evt-scroll-wrap"><div class="evt-scroll">${liveChips}${liveChips}</div></div></div>`;
}
if(d.upcoming&&d.upcoming.length>0){
hasContent=true;
h+=`<div class="evt-row"><span style="font-size:11px;flex-shrink:0">&#128197;</span><span class="evt-label">NEXT</span>`;
let upItems='';
d.upcoming.forEach(u=>{
const uC=u.impact==='HIGH'?'var(--red)':'var(--amber)';
upItems+=`<span class="evt-up"><strong style="color:${uC}">${u.event}</strong> ${u.date} <span style="color:var(--text3)">(${u.days}d)</span></span>`;
});
// Duplicate for seamless loop
h+=`<div class="evt-upcoming-wrap"><div class="evt-upcoming">${upItems}${upItems}</div></div></div>`;
}
h+=`</div>`;
// Shared tooltip div
h+=`<div id="evtTipBox" style="display:none;position:fixed;width:300px;padding:10px 12px;border-radius:8px;background:#ffffff;border:1px solid rgba(0,47,108,.15);box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:9999;font-size:10px;color:#555555;line-height:1.5;pointer-events:none"></div>`;
if(hasContent){div.innerHTML=h;div.style.display='block'}
}

function renderFiiDii(){
const body=document.getElementById('fiiDiiBody');
const card=document.getElementById('fiiDiiCard');
if(!body||!card||!_pulseData||!_pulseData.fii_dii)return;
const fd=_pulseData.fii_dii;
if(!fd.fii&&!fd.dii)return;
// Only show for Indian stocks
const ticker=(window._stockData?.ticker||'').toUpperCase();
if(!ticker.includes('.NS')&&!ticker.includes('.BO'))return;
const fii=fd.fii||{};const dii=fd.dii||{};
const fNet=fii.net||0;const dNet=dii.net||0;const combined=fNet+dNet;
const fC=fNet>=0?'var(--green)':'var(--red)';
const dC=dNet>=0?'var(--green)':'var(--red)';
const cC=combined>=0?'var(--green)':'var(--red)';
const fSign=fNet>=0?'+':'';const dSign=dNet>=0?'+':'';const cSign=combined>=0?'+':'';
const fBg=fNet>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)';
const dBg=dNet>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)';
const cBg=combined>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)';
let verdict='';
if(fNet>2000&&dNet>0)verdict='<strong style="color:var(--green)">Both FII + DII buying</strong> — strong market support. Rally likely to sustain.';
else if(fNet<-2000&&dNet>2000)verdict='<strong style="color:var(--amber)">FII selling but DII absorbing</strong> — domestic funds providing floor. Markets may hold range.';
else if(fNet<-2000&&dNet<0)verdict='<strong style="color:var(--red)">Both FII + DII selling</strong> — no institutional support. Expect weakness.';
else if(fNet>1000)verdict='<strong style="color:var(--green)">FII money flowing in</strong> — positive for large-cap and banking stocks.';
else if(fNet<-1000)verdict='<strong style="color:var(--red)">FII pulling out</strong> — caution on market direction. IT exporters may benefit from weaker rupee.';
else verdict='<strong style="color:var(--text)">Normal institutional activity</strong> — no strong directional signal today.';
body.innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px">
<div style="padding:12px;border-radius:10px;background:${fBg};border:1px solid ${fC}22;text-align:center">
<div style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:4px">FII / Foreign</div>
<div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${fC}">${fSign}₹${Math.abs(fNet).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text3);margin-top:2px">${fNet>=0?'Net Buyers ↑':'Net Sellers ↓'}</div>
<div style="margin-top:6px;font-size:9px;color:var(--text2)">Buy: ₹${(fii.buy||0).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text2)">Sell: ₹${(fii.sell||0).toLocaleString('en-IN')}Cr</div>
</div>
<div style="padding:12px;border-radius:10px;background:${dBg};border:1px solid ${dC}22;text-align:center">
<div style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:4px">DII / Domestic</div>
<div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${dC}">${dSign}₹${Math.abs(dNet).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text3);margin-top:2px">${dNet>=0?'Net Buyers ↑':'Net Sellers ↓'}</div>
<div style="margin-top:6px;font-size:9px;color:var(--text2)">Buy: ₹${(dii.buy||0).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text2)">Sell: ₹${(dii.sell||0).toLocaleString('en-IN')}Cr</div>
</div>
<div style="padding:12px;border-radius:10px;background:${cBg};border:1px solid ${cC}22;text-align:center">
<div style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:4px">Combined Flow</div>
<div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${cC}">${cSign}₹${Math.abs(combined).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text3);margin-top:2px">${combined>=0?'Net Inflow ↑':'Net Outflow ↓'}</div>
<div style="margin-top:6px;font-size:9px;color:var(--text2)">${fii.date||'Today'}</div>
</div>
</div>
<div style="padding:10px 14px;border-radius:8px;background:rgba(37,99,235,.04);border:1px solid rgba(37,99,235,.1);font-size:11px;color:var(--text2);line-height:1.7">
<span style="font-size:13px">&#128161;</span> ${verdict}
</div>
<div style="margin-top:8px;font-size:9px;color:var(--text3);text-align:center">FII = Foreign Institutional Investors (global funds) &nbsp;·&nbsp; DII = Domestic Institutional Investors (mutual funds, insurance, pension)</div>
`;
card.style.display='block';
}
function showEvtTip(el,idx){
const tip=document.getElementById('evtTipBox');
if(!tip||!_pulseData||!_pulseData.events[idx])return;
const evt=_pulseData.events[idx];
const rect=el.getBoundingClientRect();
const sC=evt.severity==='HIGH'?'#ef4444':evt.severity==='MEDIUM'?'#f59e0b':'#3b82f6';
const iC=evt.impact==='BULLISH'?'#10b981':evt.impact==='BEARISH'?'#ef4444':'#f59e0b';
tip.innerHTML=`<div style="font-weight:700;color:${sC};margin-bottom:4px;font-size:11px">${evt.headline}</div>
<div style="margin-bottom:6px">${evt.detail}</div>
${evt.action?'<div style="padding:4px 8px;border-radius:4px;background:rgba(0,47,108,.04);border-left:2px solid '+sC+';font-weight:600;font-size:9px">&#9654; '+evt.action+'</div>':''}
<div style="margin-top:4px;display:flex;gap:6px">
<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:${sC}18;color:${sC};font-weight:700">${evt.severity}</span>
<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:${iC}18;color:${iC};font-weight:700">${evt.impact}</span>
</div>`;
tip.style.left=Math.min(rect.left,window.innerWidth-320)+'px';
tip.style.top=(rect.bottom+8)+'px';
tip.style.display='block';
}
function hideEvtTip(){const t=document.getElementById('evtTipBox');if(t)t.style.display='none'}

function checkTradesAccess(){
try{
const el=document.getElementById('email');
if(!el)return;
const email=(el.dataset.real||el.value).trim().toLowerCase();
const showTrades=TRADES_EMAILS.includes(email);
const showPicks=PICKS_EMAILS.includes(email);
const tBtn=document.getElementById('tabBtnTrades');
const gBtn=document.getElementById('tabBtnGems');
const pBtn=document.getElementById('tabBtnPicks');
const fBtn=document.getElementById('tabBtnFunds');
if(tBtn)tBtn.style.display=showTrades?'':'none';
if(gBtn)gBtn.style.display=showTrades?'':'none';
if(pBtn)pBtn.style.display=showPicks?'':'none';
if(fBtn)fBtn.style.display=showPicks?'':'none';
document.querySelectorAll('.sc[data-tab="trades"]').forEach(s=>s.style.display=showTrades?'':'none');
document.querySelectorAll('.sc[data-tab="gems"]').forEach(s=>s.style.display=showTrades?'':'none');
document.querySelectorAll('.sc[data-tab="picks"]').forEach(s=>s.style.display=showPicks?'':'none');
document.querySelectorAll('.sc[data-tab="funds"]').forEach(s=>s.style.display=showPicks?'':'none');
document.querySelectorAll('.sub-nav[data-tab="picks"]').forEach(s=>s.style.display=showPicks?'':'none');
if(showTrades){initTradesProtection(email)}
if(showPicks){try{renderPicks('lc')}catch(e){}try{renderFunds('etf_in')}catch(e){}}
console.log('checkTradesAccess:',email,'→ trades:',showTrades?'GRANTED':'DENIED','picks:',showPicks?'GRANTED':'DENIED');
}catch(e){console.warn('checkTradesAccess error:',e)}
}
document.getElementById('email').addEventListener('blur',checkTradesAccess);

// ═══════════════════════════════════════════════
// ANTI-SCREENSHOT & ANTI-SHARING PROTECTION
// ═══════════════════════════════════════════════
function initTradesProtection(email){
const tradesTab=document.querySelector('[data-tab="trades"]');
if(!tradesTab||tradesTab.dataset.protected)return;
tradesTab.dataset.protected='true';
tradesTab.style.position='relative';

// 1. Dynamic watermark grid with user's email
const wm=document.createElement('div');
wm.className='trades-watermark';
let wmHtml='';
for(let row=0;row<20;row++){
for(let col=0;col<6;col++){
const top=row*120+Math.random()*40;
const left=col*280+Math.random()*60-40;
wmHtml+=`<span class="trades-watermark-text" style="top:${top}px;left:${left}px">contact@celesys.ai • CELESYS.AI • CONFIDENTIAL</span>`;
}}
wm.innerHTML=wmHtml;
tradesTab.appendChild(wm);

// 2. Block right-click on trades section
tradesTab.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();return false});

// 3. Block drag/drop (prevents dragging content out)
tradesTab.addEventListener('dragstart',e=>{e.preventDefault()});

// 4. Block copy/cut
tradesTab.addEventListener('copy',e=>{e.preventDefault();e.clipboardData&&e.clipboardData.setData('text/plain','Smart Trades content is protected.')});
tradesTab.addEventListener('cut',e=>{e.preventDefault()});
}

// 5. Block keyboard shortcuts GLOBALLY on any report content
document.addEventListener('keydown',function(e){
const reportVisible=document.querySelector('.rpt.show');
if(!reportVisible)return;
if(e.key==='PrintScreen'){e.preventDefault();return false}
if(e.ctrlKey&&e.key==='p'){e.preventDefault();return false}
if(e.ctrlKey&&e.key==='s'){e.preventDefault();return false}
if(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='i'||e.key==='J'||e.key==='j')){e.preventDefault();return false}
if(e.ctrlKey&&(e.key==='u'||e.key==='U')){e.preventDefault();return false}
if(e.key==='F12'){e.preventDefault();return false}
if(e.ctrlKey&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();return false}
if(e.ctrlKey&&(e.key==='c'||e.key==='C')){e.preventDefault();return false}
if(e.ctrlKey&&(e.key==='a'||e.key==='A')){e.preventDefault();return false}
if(e.metaKey&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();return false}
});

// 5b. Block right-click GLOBALLY on entire page
document.addEventListener('contextmenu',function(e){
// Allow right-click only on inputs
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
e.preventDefault();return false;
});

// 5c. Block drag on all content
document.addEventListener('dragstart',function(e){
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
e.preventDefault();return false;
});

// 5d. Block copy/paste globally (except inputs)
document.addEventListener('copy',function(e){
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
e.preventDefault();
if(e.clipboardData)e.clipboardData.setData('text/plain','Content is protected — celesys.ai');
return false;
});
document.addEventListener('cut',function(e){e.preventDefault();return false});

// 6. Blur content when page loses visibility (anti-screenshot)
document.addEventListener('visibilitychange',function(){
if(document.hidden){
document.body.classList.add('trades-blurred');
}else{
setTimeout(()=>document.body.classList.remove('trades-blurred'),1200);
}
});

// 7. Blur on window blur (when focus moves away from browser)
window.addEventListener('blur',function(){
document.body.classList.add('trades-blurred');
});
window.addEventListener('focus',function(){
setTimeout(()=>document.body.classList.remove('trades-blurred'),800);
});

// 8. Detect screen recording/capture API
if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){
const origGetDisplay=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices);
navigator.mediaDevices.getDisplayMedia=function(){
alert('Screen recording is not permitted on Celesys AI reports.');
return Promise.reject(new Error('Screen capture blocked'));
};
}

// 9. DevTools detection — blur report if DevTools open
(function(){
const dt=new Image();
let devOpen=false;
Object.defineProperty(dt,'id',{get:function(){
devOpen=true;document.body.classList.add('trades-blurred');
const overlay=document.getElementById('devtoolsOverlay');
if(!overlay){const ov=document.createElement('div');ov.id='devtoolsOverlay';
ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.92);z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-family:Sora,sans-serif';
ov.innerHTML='<div style="font-size:48px;margin-bottom:20px">&#128274;</div><div style="font-size:20px;font-weight:800;margin-bottom:8px">Developer Tools Detected</div><div style="font-size:14px;color:#aaa">Please close DevTools to continue using Celesys AI.</div>';
document.body.appendChild(ov);}
}});
setInterval(function(){devOpen=false;console.log(dt);
if(!devOpen){const ov=document.getElementById('devtoolsOverlay');if(ov)ov.remove();document.body.classList.remove('trades-blurred')}},2000)
})();

// 10. Dynamic watermark with user email embedded
function refreshWatermark(){
const em=document.getElementById('email')?.value||'';
const wm=document.getElementById('siteWatermark');if(!wm)return;
const ts=new Date().toLocaleString('en-IN',{timeZone:'Asia/Kolkata'});
const label=em?em.replace(/(.{3}).+(@.+)/,'$1***$2'):'CELESYS.AI';
wm.innerHTML='';
for(let i=0;i<300;i++){
const s=document.createElement('span');
s.textContent=i%4===0?'CELESYS.AI':i%4===1?label:i%4===2?ts.split(',')[0]:'CONFIDENTIAL';
s.style.left=(Math.random()*130-15)+'%';
s.style.top=(Math.random()*130-15)+'%';
s.style.fontSize=(10+Math.random()*5)+'px';
s.style.opacity=0.04+Math.random()*0.03;
wm.appendChild(s);}
}

// 9. Periodic check — if dev tools are open (detected by debugger timing)
(function detectDevTools(){
const el=new Image();
let open=false;
Object.defineProperty(el,'id',{get:function(){open=true}});
setInterval(()=>{
open=false;
console.log(el);
if(open){
document.body.classList.add('trades-blurred');
}
},3000);
})();
TI.addEventListener('keypress',e=>{if(e.key==='Enter')analyze()});

function showStatus(m,t){const s=document.getElementById('status');s.innerHTML=m;s.className='sbar show '+t}
function showLS(){const b=document.getElementById('lsteps');b.classList.add('show');['s1','s2','s3','s4'].forEach(s=>{document.getElementById(s).className='ls'});
let i=0;const ids=['s1','s2','s3','s4'];b._iv=setInterval(()=>{if(i>0)document.getElementById(ids[i-1]).classList.replace('on','ok');if(i<ids.length){document.getElementById(ids[i]).classList.add('on');i++}else clearInterval(b._iv)},3000);document.getElementById(ids[0]).classList.add('on')}
function hideLS(){const b=document.getElementById('lsteps');if(b._iv)clearInterval(b._iv);b.classList.remove('show')}
function hideRL(){document.getElementById('rateLimitBox').style.display='none';if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null}}
function showRL(data){const box=document.getElementById('rateLimitBox'),cd=document.getElementById('rlCountdown'),cb=document.getElementById('rlComeback'),pr=document.getElementById('rlProgress');
let ts=data.retry_after_seconds||(data.retry_after_minutes||5)*60;const tt=new Date(Date.now()+ts*1000);
cb.textContent='Come back at '+tt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+' · '+(data.requests_limit||5)+' fresh reports';box.style.display='block';
if(countdownInterval)clearInterval(countdownInterval);const ss=ts;
function tick(){const r=Math.max(0,Math.floor((tt-Date.now())/1000)),mn=Math.floor(r/60),sc=r%60;
cd.textContent=String(mn).padStart(2,'0')+':'+String(sc).padStart(2,'0');pr.style.width=Math.min(100,((ss-r)/ss)*100)+'%';
if(r<=0){clearInterval(countdownInterval);countdownInterval=null;cd.textContent='00:00';cd.style.color='var(--green)';
cb.textContent='✓ Quota refreshed — generate reports again';pr.style.width='100%';box.style.borderColor='rgba(16,185,129,.3)';box.style.background='rgba(16,185,129,.04)'}}
tick();countdownInterval=setInterval(tick,1000)}

// ═══ PEER COMPARISON RENDERER ═══
// ═══ AI PRICE PREDICTION ENGINE ═══
function renderPricePrediction(d){
const el=document.getElementById('pricePrediction');
if(!el)return;
const _s=(k)=>{const v=d[k];if(!v||v==='N/A'||v==='-')return 0;return parseFloat(String(v).replace(/[₹,%]/g,''))||0;};
const price=_s('price');
if(!price){el.style.display='none';return}
const w52h=_s('52w_high')||price*1.15;
const w52l=_s('52w_low')||price*0.85;
const sma20=_s('sma_20')||price;
const sma50=_s('sma_50')||price;
const sma200=_s('sma_200')||price;
const pe=_s('pe');
const sectorPE=_s('sector_avg_pe')||pe||20;
const roe=_s('roe');
const revGrowth=_s('revenue_growth');
const profitGrowth=_s('profit_growth');
const beta=_s('beta')||1;
const de=_s('debt_equity');
const S='₹';

// ═══ SCORING ENGINE ═══
// 1. Trend Score (-30 to +30)
let trendScore=0;
if(price>sma20)trendScore+=8; else trendScore-=8;
if(price>sma50)trendScore+=10; else trendScore-=10;
if(price>sma200)trendScore+=12; else trendScore-=12;
const trendLabel=trendScore>15?'Strong Uptrend':trendScore>0?'Mild Uptrend':trendScore>-15?'Mild Downtrend':'Strong Downtrend';
const trendColor=trendScore>0?'#10b981':'#ef4444';

// 2. Momentum Score (-20 to +20)
const w52range=w52h-w52l;
const w52pos=w52range>0?((price-w52l)/w52range):0.5;
let momScore=0;
if(w52pos>0.8)momScore=-10; // near highs, limited upside
else if(w52pos>0.6)momScore=5;
else if(w52pos>0.4)momScore=15; // sweet spot
else if(w52pos>0.2)momScore=10; // beaten down, recovery potential
else momScore=-5; // deeply oversold, risk

// 3. Valuation Score (-25 to +25)
let valScore=0;
if(pe>0&&sectorPE>0){
const valRatio=pe/sectorPE;
if(valRatio<0.7)valScore=20; // deeply undervalued
else if(valRatio<0.9)valScore=12;
else if(valRatio<1.1)valScore=5; // fairly valued
else if(valRatio<1.3)valScore=-8;
else valScore=-18; // overvalued
}

// 4. Growth Score (-15 to +15)
let growScore=0;
if(revGrowth>20)growScore+=8; else if(revGrowth>10)growScore+=4; else if(revGrowth<0)growScore-=6;
if(profitGrowth>20)growScore+=7; else if(profitGrowth>10)growScore+=3; else if(profitGrowth<0)growScore-=6;

// 5. Quality Score (-10 to +10)
let qualScore=0;
if(roe>20)qualScore+=5; else if(roe>15)qualScore+=3; else if(roe<5)qualScore-=4;
if(de<0.5)qualScore+=5; else if(de<1)qualScore+=2; else if(de>2)qualScore-=5;

// Total: -100 to +100
const totalScore=trendScore+momScore+valScore+growScore+qualScore;
const normalizedScore=Math.max(-100,Math.min(100,totalScore));

// ═══ PRICE TARGETS ═══
const dailyVol=(w52h-w52l)/(w52h+w52l)*2/Math.sqrt(252);// approx daily volatility
const annualReturn=normalizedScore/100*0.4; // max 40% annual return prediction

const target7d=price*(1+annualReturn/52);
const target30d=price*(1+annualReturn/12);
const target90d=price*(1+annualReturn/4);
const target1y=price*(1+annualReturn);

const upside1y=((target1y-price)/price*100);
const signal=normalizedScore>30?'BULLISH':normalizedScore>10?'MILDLY BULLISH':normalizedScore>-10?'NEUTRAL':normalizedScore>-30?'MILDLY BEARISH':'BEARISH';
const signalC=normalizedScore>30?'#10b981':normalizedScore>10?'#22c55e':normalizedScore>-10?'#f59e0b':normalizedScore>-30?'#f97316':'#ef4444';
const signalEmoji=normalizedScore>30?'🟢':normalizedScore>10?'🟢':normalizedScore>-10?'🟡':normalizedScore>-30?'🟠':'🔴';

// Confidence
const dataPoints=[price,w52h,w52l,sma20,sma50,sma200,pe,roe,revGrowth].filter(v=>v>0).length;
const confidence=Math.min(95,Math.max(30,dataPoints*10+5));

// Support & Resistance
const support1=Math.min(sma50,sma200,w52l*1.05);
const support2=w52l;
const resist1=Math.max(sma50,sma200,w52h*0.95);
const resist2=w52h;

el.style.display='block';
el.innerHTML=`
<div class="sc" data-tab="quick" style="border-left:3px solid ${signalC};margin-top:12px">
<div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">🔮</div><div class="st" style="color:${signalC}">AI Price Prediction — ${d.name||'Stock'}</div></div>
<div class="sbody">

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
<!-- Signal Card -->
<div style="padding:16px;border-radius:12px;background:linear-gradient(135deg,#0a1628,#0d2137);text-align:center;border:2px solid ${signalC}40">
<div style="font-size:9px;color:rgba(255,255,255,.4);letter-spacing:2px;margin-bottom:4px">AI SIGNAL</div>
<div style="font-size:28px;margin-bottom:2px">${signalEmoji}</div>
<div style="font-size:16px;font-weight:900;color:${signalC};font-family:Sora,sans-serif">${signal}</div>
<div style="font-size:9px;color:rgba(255,255,255,.4);margin-top:4px">Score: ${normalizedScore>0?'+':''}${normalizedScore.toFixed(0)}/100 &middot; Confidence: ${confidence}%</div>
</div>

<!-- Price Targets -->
<div style="padding:16px;border-radius:12px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="font-size:9px;color:var(--text3);letter-spacing:1px;margin-bottom:8px">PRICE TARGETS</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
<div style="padding:6px;border-radius:6px;background:var(--bg2);text-align:center"><div style="font-size:8px;color:var(--text3)">7 Days</div><div style="font-size:14px;font-weight:800;color:${target7d>=price?'#10b981':'#ef4444'};font-family:var(--mono)">${S}${target7d.toFixed(0)}</div><div style="font-size:8px;color:${target7d>=price?'#10b981':'#ef4444'}">${((target7d-price)/price*100).toFixed(1)}%</div></div>
<div style="padding:6px;border-radius:6px;background:var(--bg2);text-align:center"><div style="font-size:8px;color:var(--text3)">30 Days</div><div style="font-size:14px;font-weight:800;color:${target30d>=price?'#10b981':'#ef4444'};font-family:var(--mono)">${S}${target30d.toFixed(0)}</div><div style="font-size:8px;color:${target30d>=price?'#10b981':'#ef4444'}">${((target30d-price)/price*100).toFixed(1)}%</div></div>
<div style="padding:6px;border-radius:6px;background:var(--bg2);text-align:center"><div style="font-size:8px;color:var(--text3)">90 Days</div><div style="font-size:14px;font-weight:800;color:${target90d>=price?'#10b981':'#ef4444'};font-family:var(--mono)">${S}${target90d.toFixed(0)}</div><div style="font-size:8px;color:${target90d>=price?'#10b981':'#ef4444'}">${((target90d-price)/price*100).toFixed(1)}%</div></div>
<div style="padding:6px;border-radius:6px;background:var(--bg2);text-align:center"><div style="font-size:8px;color:var(--text3)">1 Year</div><div style="font-size:14px;font-weight:800;color:${target1y>=price?'#10b981':'#ef4444'};font-family:var(--mono)">${S}${target1y.toFixed(0)}</div><div style="font-size:8px;color:${target1y>=price?'#10b981':'#ef4444'}">${upside1y>=0?'+':''}${upside1y.toFixed(1)}%</div></div>
</div>
</div>

<!-- Support/Resistance -->
<div style="padding:16px;border-radius:12px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="font-size:9px;color:var(--text3);letter-spacing:1px;margin-bottom:8px">SUPPORT &amp; RESISTANCE</div>
<div style="font-size:10px;color:var(--text2);line-height:2.2">
<div style="display:flex;justify-content:space-between"><span>Resistance 2 (52W High)</span><span style="color:#ef4444;font-weight:700;font-family:var(--mono)">${S}${resist2.toFixed(0)}</span></div>
<div style="display:flex;justify-content:space-between"><span>Resistance 1</span><span style="color:#f97316;font-weight:700;font-family:var(--mono)">${S}${resist1.toFixed(0)}</span></div>
<div style="display:flex;justify-content:space-between;background:${signalC}15;padding:2px 6px;border-radius:4px;font-weight:700"><span>Current Price</span><span style="color:${signalC};font-family:var(--mono)">${S}${price.toFixed(0)}</span></div>
<div style="display:flex;justify-content:space-between"><span>Support 1</span><span style="color:#22c55e;font-weight:700;font-family:var(--mono)">${S}${support1.toFixed(0)}</span></div>
<div style="display:flex;justify-content:space-between"><span>Support 2 (52W Low)</span><span style="color:#10b981;font-weight:700;font-family:var(--mono)">${S}${support2.toFixed(0)}</span></div>
</div>
</div>
</div>

<!-- Scoring Breakdown -->
<div style="font-size:9px;color:var(--text3);letter-spacing:1px;margin-bottom:8px;margin-top:4px">PREDICTION FACTORS</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-bottom:14px">
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(0,47,108,.02)">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text2)">📈 Trend</span><span style="font-size:12px;font-weight:800;color:${trendColor}">${trendScore>0?'+':''}${trendScore}</span></div>
<div style="font-size:8px;color:var(--text3);margin-top:3px">${trendLabel} &middot; Price vs SMA20/50/200</div>
</div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(0,47,108,.02)">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text2)">⚡ Momentum</span><span style="font-size:12px;font-weight:800;color:${momScore>=0?'#10b981':'#ef4444'}">${momScore>=0?'+':''}${momScore}</span></div>
<div style="font-size:8px;color:var(--text3);margin-top:3px">${(w52pos*100).toFixed(0)}% of 52W range</div>
</div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(0,47,108,.02)">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text2)">💰 Valuation</span><span style="font-size:12px;font-weight:800;color:${valScore>=0?'#10b981':'#ef4444'}">${valScore>=0?'+':''}${valScore}</span></div>
<div style="font-size:8px;color:var(--text3);margin-top:3px">P/E ${pe>0?pe.toFixed(1):'N/A'} vs Sector ${sectorPE.toFixed(1)}</div>
</div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(0,47,108,.02)">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text2)">🚀 Growth</span><span style="font-size:12px;font-weight:800;color:${growScore>=0?'#10b981':'#ef4444'}">${growScore>=0?'+':''}${growScore}</span></div>
<div style="font-size:8px;color:var(--text3);margin-top:3px">Rev ${revGrowth>0?'+':''}${revGrowth.toFixed(0)}% &middot; Profit ${profitGrowth>0?'+':''}${profitGrowth.toFixed(0)}%</div>
</div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(0,47,108,.02)">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text2)">🏆 Quality</span><span style="font-size:12px;font-weight:800;color:${qualScore>=0?'#10b981':'#ef4444'}">${qualScore>=0?'+':''}${qualScore}</span></div>
<div style="font-size:8px;color:var(--text3);margin-top:3px">ROE ${roe>0?roe.toFixed(0)+'%':'N/A'} &middot; D/E ${de>0?de.toFixed(1):'N/A'}</div>
</div>
</div>

<!-- Layman Inference -->
<div style="padding:14px;border-radius:10px;background:rgba(139,92,246,.04);border-left:4px solid #8b5cf6;margin-bottom:10px">
<div style="font-size:11px;font-weight:700;color:#8b5cf6;margin-bottom:6px">💡 What This Prediction Means (Plain English)</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">
${normalizedScore>30?'<strong>Think of this stock like a car on a highway with a tailwind.</strong> The trend is up (above all moving averages), the valuation looks reasonable, and the company is growing well. Our model suggests '+upside1y.toFixed(0)+'% upside over the next year. This is like being offered a house in a good neighborhood at a fair price while the area is developing.':
normalizedScore>10?'<strong>Think of this stock like a steady train on tracks.</strong> The direction is generally positive but not explosive. Some indicators are mixed. Our model suggests modest '+upside1y.toFixed(0)+'% returns. This is like a reliable salary — not exciting, but consistent. Consider accumulating on dips to SMA50 ('+S+sma50.toFixed(0)+').':
normalizedScore>-10?'<strong>Think of this stock like a boat in calm waters.</strong> Neither strongly bullish nor bearish. The market is undecided. Wait for a clearer signal — either a breakout above '+S+resist1.toFixed(0)+' (bullish) or a breakdown below '+S+support1.toFixed(0)+' (bearish). Avoid large new positions until direction clarifies.':
normalizedScore>-30?'<strong>Think of this stock like a car going uphill with a headwind.</strong> Some negative signals are present — the price is below key moving averages or valuation is stretched. Our model suggests caution with a potential '+upside1y.toFixed(0)+'% move. Consider reducing positions or tightening stop-losses to '+S+support1.toFixed(0)+'.':
'<strong>Think of this stock like a plane losing altitude.</strong> Multiple signals are negative — downtrend, weak fundamentals, or overvaluation. Our model projects '+upside1y.toFixed(0)+'% potential decline. This is like catching a falling knife — wait for the trend to reverse (price crossing above SMA50 at '+S+sma50.toFixed(0)+') before entering.'}
</div>
</div>

<div style="padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.1);font-size:8px;color:var(--text3);line-height:1.5">
<strong style="color:var(--red)">⚠️ Disclaimer:</strong> This is an algorithmic prediction based on technical indicators, valuation metrics, and growth data — NOT a recommendation. Markets are inherently unpredictable. Past performance does not guarantee future results. Always do your own research and consult a SEBI-registered advisor. Predictions use ${dataPoints} of 9 available data points (${confidence}% confidence).
</div>

</div></div>`;
}

function renderPeers(d, curr){
const el=document.getElementById('peerSection');
if(!el)return;
const peers=d.peers||[];
const myPE=(d.pe_ratio&&d.pe_ratio!=='N/A')?parseFloat(d.pe_ratio):0;
const peerAvgPE=d.peer_avg_pe&&d.peer_avg_pe!=='N/A'?parseFloat(d.peer_avg_pe):0;
const sectorPE=d.sector_avg_pe||20;

if(!peers.length){el.innerHTML='<p style="font-size:12px;color:var(--text3)">Peer data not available for this stock.</p>';return}

// PE context verdict
let peVerdict='';
if(myPE>0&&peerAvgPE>0){
  const ratio=myPE/peerAvgPE;
  const disc=Math.abs(((peerAvgPE-myPE)/peerAvgPE)*100).toFixed(0);
  if(ratio<0.7) peVerdict=`<span class="sig g">● ${disc}% cheaper than peers</span> — Potential value opportunity vs industry competitors.`;
  else if(ratio<0.9) peVerdict=`<span class="sig g">● ${disc}% below peer avg</span> — Slight discount to peers. Check if deserved.`;
  else if(ratio<1.1) peVerdict=`<span class="sig n">● In line with peers</span> — Trading at fair value relative to competitors.`;
  else if(ratio<1.4) peVerdict=`<span class="sig c">● ${disc}% premium</span> — Market prices in growth premium vs peers.`;
  else peVerdict=`<span class="sig c">● ${disc}% more expensive</span> — Significant premium. Must justify with superior growth.`;
}

const mcF=(c,s)=>{s=s||'$';if(!c||isNaN(c))return'N/A';c=parseFloat(c);if(c>=1e12)return s+(c/1e12).toFixed(1)+'T';if(c>=1e9)return s+(c/1e9).toFixed(1)+'B';if(c>=1e7)return s+(c/1e7).toFixed(1)+'Cr';return s+(c/1e6).toFixed(1)+'M'};

let rows=peers.map(p=>{
  const peClass=p.pe==='N/A'?'':p.pe<myPE?'style="color:var(--green)"':p.pe>myPE?'style="color:var(--red)"':'';
  return `<tr>
    <td><strong style="cursor:pointer;color:var(--blue)" onclick="quickAnalyze('${p.ticker}')">${p.ticker}</strong><br><span style="font-size:10px;color:var(--text3)">${p.name}</span></td>
    <td style="font-family:var(--mono);font-weight:600" ${peClass}>${p.pe!=='N/A'?p.pe+'x':'N/A'}</td>
    <td style="font-family:var(--mono)">${mcF(p.market_cap,curr)}</td>
    <td style="font-family:var(--mono);color:${p.profit_margin>=0?'var(--green)':'var(--red)'}">${p.profit_margin}%</td>
    <td style="font-family:var(--mono);color:${p.revenue_growth>=0?'var(--green)':'var(--red)'}">${p.revenue_growth>0?'+':''}${p.revenue_growth}%</td>
    <td style="font-family:var(--mono)">${p.roe}%</td>
  </tr>`}).join('');

el.innerHTML=`
<p style="font-size:12px;color:var(--text3);margin-bottom:10px">How <strong style="color:var(--text)">${d.ticker}</strong> stacks up against ${peers.length} industry competitors in <strong style="color:var(--text)">${d.industry||d.sector||'same sector'}</strong>:</p>
${peVerdict?`<div style="padding:10px 14px;border-radius:8px;background:rgba(20,184,166,.05);border:1px solid rgba(20,184,166,.15);margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.7">
<span style="font-size:13px">📊</span> <strong>${d.ticker} P/E: ${myPE>0?myPE.toFixed(1)+'x':'N/A'}</strong> vs <strong>Peer Avg: ${peerAvgPE>0?peerAvgPE.toFixed(1)+'x':'N/A'}</strong> vs <strong>Sector: ${sectorPE}x</strong><br>${peVerdict}
</div>`:''}
<div style="overflow-x:auto">
<table class="dt"><tr><th>Company</th><th>P/E</th><th>Mkt Cap</th><th>Margin</th><th>Rev Growth</th><th>ROE</th></tr>
<tr style="background:rgba(20,184,166,.06);font-weight:600">
  <td><strong>${d.ticker}</strong><br><span style="font-size:10px;color:var(--text3)">${(d.company_name||d.ticker).substring(0,30)}</span></td>
  <td style="font-family:var(--mono);font-weight:700;color:var(--teal)">${myPE>0?myPE.toFixed(1)+'x':'N/A'}</td>
  <td style="font-family:var(--mono)">${mcF(d.market_cap,curr)}</td>
  <td style="font-family:var(--mono)">${parseFloat(d.profit_margin||0).toFixed(1)}%</td>
  <td style="font-family:var(--mono)">${d.earnings_growth!=='N/A'?(d.earnings_growth>0?'+':'')+d.earnings_growth+'%':'N/A'}</td>
  <td style="font-family:var(--mono)">${parseFloat(d.roe||0).toFixed(1)}%</td>
</tr>
${rows}
</table></div>
<div class="ic bl" style="margin-top:10px"><p><strong>&#128161; How to read this:</strong> Green P/E = cheaper than ${d.ticker}. Red = more expensive. Compare margins and growth to see if premium is justified. Click any ticker to analyze it.</p></div>`;
}

// ═══ UPCOMING EVENTS / CATALYSTS RENDERER ═══
function renderUpcomingEvents(d){
const el=document.getElementById('sectorEventsContent');
if(!el)return;
const sector=d.sector||'';
const isIndian=d.ticker&&(d.ticker.includes('.NS')||d.ticker.includes('.BO'));

// Build sector-specific + company-specific upcoming events
const now=new Date();
const events=[];

// Company-specific events
const qMonths=[1,4,7,10]; // Typical earnings months
let nextQ=null;
for(let i=0;i<8;i++){
  const m=new Date(now.getFullYear(),now.getMonth()+i,1);
  if(qMonths.includes(m.getMonth()+1)&&m>now){nextQ=m;break}
}
if(nextQ){
  const qName=['','Q3','Q3','Q3','Q4','Q4','Q4','Q1','Q1','Q1','Q2','Q2','Q2'][nextQ.getMonth()+1]||'Q?';
  events.push({date:nextQ.toLocaleDateString('en-US',{month:'short',year:'numeric'}),title:`${d.ticker} ${qName} Earnings Release`,type:'company',impact:'high',desc:'Quarterly results reveal revenue/profit trends. Major price catalyst.'});
}

// Dividend dates
if(d.dividend_yield&&parseFloat(d.dividend_yield)>0){
  events.push({date:'Upcoming',title:`${d.ticker} Dividend Ex-Date`,type:'company',impact:'medium',desc:`Current yield: ${d.dividend_yield}%. Watch for ex-dividend date announcement.`});
}

// AGM
events.push({date:'Upcoming',title:`${d.ticker} Annual General Meeting`,type:'company',impact:'medium',desc:'Management guidance, strategic outlook, and shareholder resolutions.'});

// Sector-specific events
const sectorEvents={
  'Technology':[
    {date:'Quarterly',title:'Big Tech Earnings Season',impact:'high',desc:'FAANG+ results set tone for entire tech sector. Watch AI/cloud growth.'},
    {date:'Ongoing',title:'AI Infrastructure Spending',impact:'high',desc:'Enterprise AI adoption and GPU demand driving sector valuations.'},
    {date:'Quarterly',title:'Semiconductor Cycle Updates',impact:'medium',desc:'Chip demand and inventory levels signal sector direction.'}
  ],
  'Financial Services':[
    {date:'Every 6 weeks',title:'Fed Interest Rate Decision',impact:'high',desc:'Rate changes directly affect bank margins, lending, and valuations.'},
    {date:'Quarterly',title:'Bank Stress Test Results',impact:'high',desc:'Capital adequacy determines dividend capacity and buybacks.'},
    {date:'Monthly',title:'Credit & Loan Growth Data',impact:'medium',desc:'Loan demand signals economic health and bank revenue outlook.'}
  ],
  'Healthcare':[
    {date:'Ongoing',title:'FDA Drug Approvals Pipeline',impact:'high',desc:'New approvals can create 20-50% moves in pharma/biotech stocks.'},
    {date:'Annual',title:'Healthcare Policy Changes',impact:'high',desc:'Drug pricing legislation and insurance coverage changes.'},
    {date:'Quarterly',title:'Clinical Trial Results',impact:'high',desc:'Phase 3 readouts are binary events — prepare for volatility.'}
  ],
  'Energy':[
    {date:'Biweekly',title:'OPEC+ Production Decision',impact:'high',desc:'Supply cuts/increases directly move oil prices and energy stocks.'},
    {date:'Weekly',title:'US Crude Inventory Report',impact:'medium',desc:'EIA data shows supply/demand balance. Moves oil intraday.'},
    {date:'Ongoing',title:'Clean Energy Transition Policy',impact:'medium',desc:'Government subsidies and mandates shifting capital to renewables.'}
  ],
  'Consumer Cyclical':[
    {date:'Monthly',title:'Retail Sales Data',impact:'high',desc:'Consumer spending strength drives revenue for cyclical names.'},
    {date:'Quarterly',title:'Consumer Confidence Index',impact:'medium',desc:'Sentiment leading indicator for discretionary spending.'},
    {date:'Nov-Dec',title:'Holiday Season Sales',impact:'high',desc:'Q4 makes or breaks the year for retail and e-commerce.'}
  ],
  'Consumer Defensive':[
    {date:'Monthly',title:'CPI / Inflation Data',impact:'high',desc:'Input costs and pricing power affected by inflation trends.'},
    {date:'Quarterly',title:'Volume vs Price Growth',impact:'medium',desc:'Are consumers trading down? Volume trends signal brand strength.'}
  ],
  'Industrials':[
    {date:'Monthly',title:'PMI Manufacturing Index',impact:'high',desc:'Above 50 = expansion. Key leading indicator for industrial demand.'},
    {date:'Ongoing',title:'Infrastructure Spending Bills',impact:'high',desc:'Government capex programs directly boost industrial orders.'},
    {date:'Quarterly',title:'Order Backlog Updates',impact:'medium',desc:'Forward visibility on revenue. Growing backlog = bullish signal.'}
  ],
  'Basic Materials':[
    {date:'Monthly',title:'China PMI & Demand Data',impact:'high',desc:'China consumes 50%+ of global commodities. Their growth = your price.'},
    {date:'Weekly',title:'Commodity Price Movements',impact:'high',desc:'Gold, copper, steel prices directly impact revenue and margins.'}
  ],
  'Real Estate':[
    {date:'Every 6 weeks',title:'Fed Rate Decision',impact:'high',desc:'Interest rates are the single biggest driver of REIT valuations.'},
    {date:'Monthly',title:'Housing Starts & Permits',impact:'medium',desc:'Construction activity signals demand pipeline.'},
    {date:'Quarterly',title:'Occupancy & Rent Growth',impact:'medium',desc:'REIT fundamentals depend on rental income trends.'}
  ],
  'Communication Services':[
    {date:'Quarterly',title:'Digital Ad Spending Reports',impact:'high',desc:'Ad revenue growth drives META, GOOGL and media stocks.'},
    {date:'Ongoing',title:'Streaming Subscriber Counts',impact:'high',desc:'User growth and ARPU determine streaming platform valuations.'}
  ],
  'Utilities':[
    {date:'Every 6 weeks',title:'Fed Interest Rate Decision',impact:'high',desc:'Utilities compete with bonds for yield-seeking investors.'},
    {date:'Ongoing',title:'Renewable Energy Mandates',impact:'medium',desc:'State/federal clean energy targets drive capex and growth.'}
  ]
};

// India-specific sector events
if(isIndian){
  events.push({date:'Bi-monthly',title:'RBI Monetary Policy',type:'macro',impact:'high',desc:'Repo rate decisions affect banking, real estate, and overall market sentiment.'});
  events.push({date:'Monthly',title:'FII/DII Flow Data',type:'macro',impact:'high',desc:'Foreign fund flows are the biggest driver of Indian market direction.'});
  events.push({date:'Feb',title:'Union Budget',type:'macro',impact:'high',desc:'Tax changes, sector allocations, and fiscal policy reshape markets annually.'});
  events.push({date:'Monthly',title:'GST Collection Data',type:'macro',impact:'medium',desc:'GST revenue growth signals economic activity and consumer demand.'});
}else{
  events.push({date:'Every 6 weeks',title:'FOMC Rate Decision',type:'macro',impact:'high',desc:'Federal Reserve policy is the most important macro driver for US equities.'});
  events.push({date:'Monthly',title:'CPI Inflation Report',type:'macro',impact:'high',desc:'Inflation data shapes Fed policy expectations and market direction.'});
  events.push({date:'Monthly',title:'Jobs Report (NFP)',type:'macro',impact:'high',desc:'Employment strength signals economic health. Surprise = volatility.'});
  events.push({date:'Quarterly',title:'GDP Growth Data',type:'macro',impact:'medium',desc:'Economic growth rate confirms or challenges market valuations.'});
}

// Add sector-specific events
const secEvents=sectorEvents[sector]||[];
secEvents.forEach(e=>events.push({...e,type:'sector'}));

// Sort: high impact first
events.sort((a,b)=>{const w={high:0,medium:1,low:2};return (w[a.impact]||1)-(w[b.impact]||1)});

const impactBadge=(imp)=>imp==='high'?'<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(239,68,68,.1);color:var(--red)">HIGH IMPACT</span>':imp==='medium'?'<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(245,158,11,.1);color:var(--amber)">MEDIUM</span>':'<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(107,114,128,.1);color:var(--text3)">LOW</span>';

const typeBadge=(t)=>t==='company'?'🏢 Company':t==='sector'?'🏭 Sector':'🌍 Macro';

let html=`<div style="margin-top:4px;padding:14px 16px;border-radius:10px;background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.12)">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
<span style="font-size:16px">📅</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:800;color:var(--cyan)">UPCOMING EVENTS — ${d.ticker} & ${sector||'Market'}</span>
</div>
<p style="font-size:11px;color:var(--text3);margin-bottom:14px;line-height:1.5">Key events that could move ${d.ticker}'s price in the next 3-6 months. High impact events deserve close attention.</p>
<div style="display:flex;flex-direction:column;gap:8px">`;

events.forEach(e=>{
html+=`<div style="padding:10px 14px;border-radius:8px;background:var(--card);border:1px solid var(--border);display:flex;gap:12px;align-items:flex-start">
<div style="min-width:60px;font-family:var(--mono);font-size:10px;color:var(--text3);font-weight:600;padding-top:2px">${e.date}</div>
<div style="flex:1">
<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px">
<span style="font-size:12px;font-weight:700;color:var(--text)">${e.title}</span>
${impactBadge(e.impact)}
<span style="font-size:9px;color:var(--text3)">${typeBadge(e.type)}</span>
</div>
<div style="font-size:11px;color:var(--text2);line-height:1.6">${e.desc}</div>
</div>
</div>`;
});

html+=`</div>
<div style="margin-top:10px;font-size:10px;color:var(--text3);text-align:center">Events are indicative. Check company IR page and economic calendar for exact dates.</div>
</div>`;

el.innerHTML=html;
}

function quickAnalyze(ticker){
const tickerEl=document.getElementById('ticker');
const emailEl=document.getElementById('email');
if(tickerEl)tickerEl.value=ticker;
// Check if email is filled
const em=(emailEl&&(emailEl.dataset.real||emailEl.value))||'';
if(!em||!em.includes('@')){
emailEl.focus();
emailEl.style.borderColor='var(--amber)';
emailEl.style.boxShadow='0 0 0 3px rgba(212,138,0,.15)';
setTimeout(()=>{emailEl.style.borderColor='';emailEl.style.boxShadow=''},2000);
return;
}
analyze();
}

async function analyze(){const emailEl=document.getElementById('email');const email=(emailEl.dataset.real||emailEl.value).trim(),ticker=TI.value.trim().toUpperCase(),btn=document.getElementById('btn'),rpt=document.getElementById('report');
AC.classList.remove('show');if(!email||!ticker){showStatus('Enter both email and ticker','error');return}
if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){showStatus('Enter a valid email','error');return}
btn.disabled=true;btn.textContent='Analyzing...';btn.classList.add('ld');rpt.classList.remove('show');hideRL();
showStatus('Analyzing '+ticker+'...','info');showLS();
fetchMarketPulse();
const _startT=Date.now();
const _timerIv=setInterval(()=>{const s=Math.floor((Date.now()-_startT)/1000);showStatus('Analyzing '+ticker+'... '+s+'s','info')},2000);

try{
const res=await fetch('/api/generate-report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_name:ticker,email})});
clearInterval(_timerIv);
if(res.status===429){const r=await res.json().catch(()=>({}));showStatus(r.reason||'Too many requests','error');if(r.retry_after_seconds||r.retry_after_minutes)showRL(r);btn.disabled=false;btn.textContent='Analyze →';btn.classList.remove('ld');hideLS();return}
if(!res.ok){const e=await res.json().catch(()=>({}));showStatus(e.detail||e.message||'Analysis failed','error');btn.disabled=false;btn.textContent='Analyze →';btn.classList.remove('ld');hideLS();return}
const data=await res.json();
if(!data.success||!data.live_data){showStatus('No data found for '+ticker,'error');btn.disabled=false;btn.textContent='Analyze →';btn.classList.remove('ld');hideLS();return}
let q='';if(data.rate_limit){const r=data.rate_limit.remaining;document.getElementById('navQ').textContent=r+'/hr';q=r===0?' · Last free report':' · '+r+' remaining'}
if(data.report_number){document.getElementById('navRC').textContent=data.report_number;document.getElementById('globalRC').textContent=data.report_number.toLocaleString();const hb=document.getElementById('reportBadgeCount');if(hb)hb.textContent=data.report_number.toLocaleString()}
const _elapsed=Math.round((Date.now()-_startT)/1000);
const modelNote=data.cached?' ⚡ cached':data.ai_model==='template'?' (data-only)':data.ai_model==='haiku'?' (fast)':'';
showStatus('✓ Report ready in '+_elapsed+'s'+modelNote+q,'success');
displayReport(data);TI.value='';
if(typeof gtag==='function')gtag('event','generate_report',{ticker:data.live_data?.ticker||ticker,ai_model:data.ai_model||''});
}catch(e){
clearInterval(_timerIv);
showStatus(e.message==='Failed to fetch'?'Cannot connect to server.':e.message,'error');
}
btn.disabled=false;btn.textContent='Analyze →';btn.classList.remove('ld');hideLS()}

function displayReport(data){const d=data.live_data,curr=d.currency==='INR'?'₹':'$',price=d.current_price;
document.getElementById('tickerTag').textContent=d.ticker;document.getElementById('companyName').textContent=d.company_name||d.ticker;
const scEl=document.getElementById('stickyCompany');if(scEl){scEl.textContent=(d.company_name||d.ticker)+' · '+curr+price.toLocaleString();scEl.style.display='inline'}
const srcLabel=d.data_source==='yahoo_chart_only'?' (chart)':d.data_source==='yahoo_scrape'?' (alt)':d.data_source==='stale_cache'?' (cached)':'';
document.getElementById('timestamp').innerHTML='<div class="ldot"></div> LIVE'+srcLabel+' · '+d.data_timestamp;

// 8 METRICS (expanded from 4) - skip cards with N/A data entirely
const peDisplay=d.pe_ratio&&d.pe_ratio!=='N/A'&&d.pe_ratio!==0?d.pe_ratio:null;
const mcapRaw=d.market_cap&&d.market_cap>1e6?d.market_cap:0;
const mcapDisplay=mcapRaw>0?formatCap(mcapRaw,curr):null;
const w52valid=d.week52_low&&d.week52_high&&d.week52_low!=='N/A'&&d.week52_high!=='N/A'&&parseFloat(d.week52_high)>0;
document.getElementById('metrics').innerHTML=`
<div class="mcard"><div class="ml">Price</div><div class="mv">${curr}${price.toLocaleString()}</div><div class="ms ${d.price_change>=0?'up':'dn'}">${d.price_change>=0?'▲':'▼'} ${Math.abs(d.price_change).toFixed(2)} (${d.price_change_pct.toFixed(2)}%)</div></div>
${peDisplay?`<div class="mcard"><div class="ml">P/E Ratio</div><div class="mv">${peDisplay}</div><div class="ms nu">TTM</div></div>`:''}
${mcapDisplay?`<div class="mcard"><div class="ml">Market Cap</div><div class="mv">${mcapDisplay}</div><div class="ms nu">${d.currency}</div></div>`:''}
${w52valid?`<div class="mcard"><div class="ml">52W Range</div><div class="mv" style="font-size:16px">${curr}${d.week52_low}—${curr}${d.week52_high}</div><div class="ms nu">Low / High</div></div>`:''}`;

// 52-WEEK POSITION BAR — only show if valid data
if(w52valid){
const w52pct=Math.min(100,Math.max(0,((price-d.week52_low)/(d.week52_high-d.week52_low))*100));
document.getElementById('w52section').innerHTML=`
<div class="sh" style="margin-bottom:2px"><div class="si" style="background:rgba(0,120,212,.12)">&#9678;</div><div class="st" style="color:var(--blue)">52-Week Price Map</div></div>
<div style="padding:8px 16px 10px">
<div class="w52bar"><div class="w52fill" style="width:100%"></div><div class="w52dot" style="left:${w52pct}%"></div></div>
<div class="w52labels"><span>${curr}${d.week52_low} (Low)</span><span style="color:var(--blue);font-weight:600">${curr}${price} &middot; ${w52pct.toFixed(0)}%</span><span>${curr}${d.week52_high} (High)</span></div>
<div style="font-size:11px;color:var(--text2);margin-top:6px">${w52pct<25?'<strong style="color:var(--green)">● Bargain zone</strong> — near yearly low. Check fundamentals for entry.':w52pct>75?'<strong style="color:var(--amber)">● Hot streak</strong> — near yearly peak. Watch for resistance.':'<strong style="color:var(--blue)">● Neutral zone</strong> — mid-range. Fundamentals decide next move.'}</div>
</div>`;
}
try{createAnalysisSections(data.report,d,data.fund_holdings||{institutions:[],funds:[],summary:{}});}catch(e){console.error('CRITICAL: createAnalysisSections failed:',e);document.getElementById('analysisContainer').innerHTML='<div style="padding:40px;text-align:center;color:var(--red)"><h3>Report Rendering Error</h3><p>'+e.message+'</p><p style="font-size:11px;color:var(--text3)">Please try again or contact support.</p></div>';document.getElementById('mainTabBar').style.display='flex';switchTab('quick');}
// Charts + DecisionTool MUST run AFTER template is in DOM (canvases live inside template)
try{createCharts(d)}catch(e){console.warn('createCharts error:',e)}
window._stockData=d;window._stockCurr=curr;
// Position Analyzer disabled for SEBI compliance
document.getElementById('report').classList.add('show');
// Hide sticky tagline — tab bar replaces it
const _sTag=document.getElementById('stickyTag');if(_sTag)_sTag.style.display='none';
renderMarketEvents();
try{renderFiiDii()}catch(e){console.warn('FiiDii render error:',e)}
try{renderPeers(d,curr)}catch(e){console.warn('renderPeers error:',e)}
try{renderPricePrediction(d)}catch(e){console.warn('renderPricePrediction error:',e)}
try{renderTechnicalsPro(d)}catch(e){console.warn('renderTechnicalsPro error:',e)}
try{renderEarningsCountdown(d)}catch(e){console.warn('renderEarningsCountdown error:',e)}
try{renderInsiderActivity(d)}catch(e){console.warn('renderInsiderActivity error:',e)}
try{renderUpcomingEvents(d)}catch(e){console.warn('renderUpcomingEvents error:',e)}
// Scroll to metrics (above tab bar) so tab bar sticks naturally at 90px
setTimeout(()=>{const m=document.getElementById('metrics');if(m)m.scrollIntoView({behavior:'smooth',block:'start'})},200);
setTimeout(animSections,400)}

function animSections(){
// Sections are now visible immediately via inline styles from switchTab
// Add scroll indicators to overflowing sections
setTimeout(()=>{
document.querySelectorAll('.sc').forEach(el=>{
if(el.scrollHeight>el.clientHeight+20){
const ind=document.createElement('div');
ind.className='sind';
ind.innerHTML='↓ scroll for more';
el.appendChild(ind);
el.addEventListener('scroll',function(){
const atBottom=this.scrollHeight-this.scrollTop<=this.clientHeight+30;
ind.style.opacity=atBottom?'0':'1';
},{passive:true});
}});
},600)}

function createAnalysisSections(report,d,fundData){
console.log('createAnalysisSections START — d.ticker:',d?.ticker,'d.pe_ratio:',d?.pe_ratio);
// Safety defaults for all data fields
report=report||'Analysis not available.';
d=d||{};
fundData=fundData||{institutions:[],funds:[],summary:{}};
d.currency=d.currency||'USD';d.current_price=d.current_price||0;d.pe_ratio=d.pe_ratio||'N/A';
d.pb_ratio=d.pb_ratio||'N/A';d.profit_margin=d.profit_margin||'0';d.operating_margin=d.operating_margin||'0';
d.roe=d.roe||'0';d.dividend_yield=d.dividend_yield||'0';d.debt_to_equity=d.debt_to_equity||'0';
d.current_ratio=d.current_ratio||'0';d.beta=d.beta||'1';d.market_cap=d.market_cap||0;
d.week52_high=d.week52_high||d.current_price||1;d.week52_low=d.week52_low||d.current_price||0;
d.sector=d.sector||'Unknown';d.ticker=d.ticker||'';d.gross_margins=d.gross_margins||'0';
d.forward_pe=d.forward_pe||'N/A';d.peg_ratio=d.peg_ratio||'N/A';
d.sma_20=d.sma_20||0;d.sma_50=d.sma_50||0;d.sma_200=d.sma_200||0;
d.ema_9=d.ema_9||0;d.ema_21=d.ema_21||0;d.ema_50=d.ema_50||0;
d.ema_signals=d.ema_signals||[];
d.quick_ratio=d.quick_ratio||'0';d.ebitda_margins=d.ebitda_margins||'0';
// Sanitize report for safe HTML insertion
const safeReport=String(report).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/`/g,'&#96;');
const curr=d.currency==='INR'?'₹':'$',price=d.current_price,pe=parseFloat(d.pe_ratio)||0;
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A'||v===null||v===undefined)?0:f};
// ═══ DETERMINISTIC STOCK VERDICT ENGINE (20 factors — comprehensive multi-factor) ═══
// F1-F8: Original (Valuation, Profitability, Balance Sheet, 52W, P/B, Dividend, Beta, OpEff)
// F9: Earnings Velocity (EPS + Revenue CAGR)  F10: Relative Valuation (vs Sector PE)
// F11: Technical Momentum (SMA20/50/200)  F12: PEG Ratio  F13: Cash Flow  F14: Quarterly Momentum
function computeVerdict(d){
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A'||v===null||v===undefined)?0:f};
let score=0,reasons=[];
const pe=n(d.pe_ratio),fpe=n(d.forward_pe),pb=n(d.pb_ratio),dy=n(d.dividend_yield);
const pm=n(d.profit_margin),om=n(d.operating_margin),roe=n(d.roe),gm=n(d.gross_margins);
const de=n(d.debt_to_equity),cr=n(d.current_ratio),beta=n(d.beta),qr=n(d.quick_ratio);
const price=d.current_price,hi=d.week52_high,lo=d.week52_low;
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;
const sma20=n(d.sma_20),sma50=n(d.sma_50),sma200=n(d.sma_200);
const epsGrowth=n(d.eps_growth_pct),revGrowth=n(d.revenue_growth),earningsGrowth=n(d.earnings_growth);
const sectorPE=n(d.sector_avg_pe)||20;
const peg=n(d.peg_ratio),evEbitda=n(d.enterprise_to_ebitda);
const fcf=n(d.free_cash_flow),ocf=n(d.operating_cash_flow);
const totalCash=n(d.total_cash),totalDebt=n(d.total_debt),totalRev=n(d.total_revenue);
const eqg=n(d.earnings_quarterly_growth),ebitdaM=n(d.ebitda_margins);
const mcap=n(d.market_cap);

// F1: VALUATION — P/E (±20)
if(pe>0){
if(pe<10){score+=18;reasons.push('Deep value (P/E '+pe.toFixed(1)+'x) [+18]')}
else if(pe<15){score+=12;reasons.push('Value zone (P/E '+pe.toFixed(1)+'x) [+12]')}
else if(pe<22){score+=4;reasons.push('Fair valuation (P/E '+pe.toFixed(1)+'x) [+4]')}
else if(pe<35){score-=6;reasons.push('Expensive (P/E '+pe.toFixed(1)+'x) [-6]')}
else{score-=14;reasons.push('Very expensive (P/E '+pe.toFixed(1)+'x) [-14]')}}
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=5;reasons.push('Forward P/E discount — earnings growth ahead [+5]')}
else if(fpe>0&&pe>0&&fpe>pe*1.1){score-=3;reasons.push('Forward P/E premium — earnings may decline [-3]')}

// F2: PROFITABILITY — margins + ROE (±15)
if(pm>20){score+=12;reasons.push('Excellent margins ('+pm.toFixed(1)+'%) [+12]')}
else if(pm>10){score+=6;reasons.push('Solid margins ('+pm.toFixed(1)+'%) [+6]')}
else if(pm>0){score+=2;reasons.push('Thin margins ('+pm.toFixed(1)+'%) [+2]')}
else if(pm<0){score-=10;reasons.push('Unprofitable ('+pm.toFixed(1)+'%) [-10]')}
if(roe>20){score+=8;reasons.push('Strong ROE ('+roe.toFixed(1)+'%) [+8]')}
else if(roe>12){score+=4;reasons.push('Decent ROE ('+roe.toFixed(1)+'%) [+4]')}
else if(roe>0&&roe<5){score-=3;reasons.push('Weak ROE ('+roe.toFixed(1)+'%) [-3]')}

// F3: BALANCE SHEET + CASH POSITION (±16)
if(de>0){
if(de<30){score+=10;reasons.push('Fortress balance sheet (D/E '+de.toFixed(0)+') [+10]')}
else if(de<80){score+=5;reasons.push('Moderate debt (D/E '+de.toFixed(0)+') [+5]')}
else if(de<150){score-=3;reasons.push('Elevated debt (D/E '+de.toFixed(0)+') [-3]')}
else{score-=10;reasons.push('High leverage risk (D/E '+de.toFixed(0)+') [-10]')}}
if(cr>2){score+=4;reasons.push('Strong liquidity (CR '+cr.toFixed(1)+') [+4]')}
else if(cr>0&&cr<1){score-=6;reasons.push('Liquidity concern (CR '+cr.toFixed(1)+') [-6]')}
if(totalCash>0&&totalDebt>0){const cdr=totalCash/totalDebt;
if(cdr>1){score+=4;reasons.push('Net cash — cash exceeds debt by '+Math.round((cdr-1)*100)+'% [+4]')}
else if(cdr>0.5){score+=2;reasons.push('Adequate cash — '+Math.round(cdr*100)+'% of debt covered [+2]')}
else if(cdr<0.15){score-=4;reasons.push('Cash crunch — only '+Math.round(cdr*100)+'% of debt covered [-4]')}}
else if(totalCash>0&&totalDebt===0){score+=3;reasons.push('Debt-free with cash on books [+3]')}

// F4: 52-WEEK POSITION (±10)
if(w52pct<0.2){score+=8;reasons.push('Near 52W low — potential value ('+((w52pct*100).toFixed(0))+'% of range) [+8]')}
else if(w52pct<0.35){score+=4;reasons.push('Lower half of 52W range [+4]')}
else if(w52pct>0.9){score-=4;reasons.push('Near 52W high — limited upside ('+(w52pct*100).toFixed(0)+'%) [-4]')}
else if(w52pct>0.75){score+=2;reasons.push('Upper range — momentum intact [+2]')}

// F5: P/B VALUE (±8)
if(pb>0){if(pb<1){score+=8;reasons.push('Below book value (P/B '+pb.toFixed(1)+') [+8]')}
else if(pb<2.5){score+=3;reasons.push('Reasonable P/B ('+pb.toFixed(1)+') [+3]')}
else if(pb>8){score-=5;reasons.push('Extreme P/B premium ('+pb.toFixed(1)+') [-5]')}}

// F6: DIVIDEND (±5)
if(dy>4){score+=5;reasons.push('High yield ('+dy.toFixed(1)+'%) [+5]')}
else if(dy>2){score+=3;reasons.push('Decent yield ('+dy.toFixed(1)+'%) [+3]')}

// F7: RISK/BETA (±5)
if(beta>0){if(beta>2){score-=5;reasons.push('Very high volatility (Beta '+beta.toFixed(2)+') [-5]')}
else if(beta>1.5){score-=2;reasons.push('Above-avg volatility (Beta '+beta.toFixed(2)+') [-2]')}
else if(beta<0.7){score+=3;reasons.push('Defensive (Beta '+beta.toFixed(2)+') [+3]')}}

// F8: OPERATING EFFICIENCY (±5)
if(om>20){score+=5;reasons.push('High operating efficiency ('+om.toFixed(1)+'%) [+5]')}
else if(om>0&&om<5){score-=3;reasons.push('Weak operating margins ('+om.toFixed(1)+'%) [-3]')}

// F9: EARNINGS VELOCITY / CAGR (±12) *** NEW ***
const bestEG=epsGrowth||earningsGrowth;
const combG=bestEG&&revGrowth?(bestEG*0.6+revGrowth*0.4):(bestEG||revGrowth);
if(combG>30){score+=10;reasons.push('Exceptional earnings velocity — '+combG.toFixed(0)+'% combined growth [+10]')}
else if(combG>15){score+=6;reasons.push('Strong growth trajectory — '+combG.toFixed(0)+'% [+6]')}
else if(combG>5){score+=2;reasons.push('Moderate growth — '+combG.toFixed(0)+'% [+2]')}
else if(combG<=-10){score-=6;reasons.push('Earnings contracting '+combG.toFixed(0)+'% [-6]')}
else if(combG<0){score-=2;reasons.push('Mild decline '+combG.toFixed(0)+'% [-2]')}
if(revGrowth>20&&!combG){score+=5;reasons.push('Revenue surging '+revGrowth.toFixed(0)+'% [+5]')}

// F10: RELATIVE VALUATION vs SECTOR (±8) *** NEW ***
if(pe>0&&sectorPE>0){const peR=pe/sectorPE;const disc=((sectorPE-pe)/sectorPE*100).toFixed(0);
if(peR<0.6){score+=8;reasons.push('P/E '+Math.abs(disc)+'% below sector avg ('+sectorPE+'x) — deep discount [+8]')}
else if(peR<0.85){score+=4;reasons.push('P/E '+Math.abs(disc)+'% below sector — undervalued vs peers [+4]')}
else if(peR>1.5){score-=5;reasons.push('P/E '+Math.abs(disc)+'% above sector — expensive vs peers [-5]')}
else if(peR>1.2){score-=2;reasons.push('P/E premium over sector avg [-2]')}}

// F11: TECHNICAL MOMENTUM — SMA + EMA crossovers (±10)
let tS=0;const tD=[];
if(sma20>0){if(price>sma20){tS+=1;tD.push('Above SMA20')}else{tS-=1;tD.push('Below SMA20')}}
if(sma200>0){if(price>sma200){tS+=2;tD.push('Above SMA200 uptrend')}else{tS-=2;tD.push('Below SMA200 downtrend')}}
if(sma20>0&&sma200>0){if(sma20>sma200){tS+=2;tD.push('Golden Cross')}
else if(sma20<sma200*0.95){tS-=2;tD.push('Death Cross')}}
if(sma50>0&&sma200>0&&price>sma50&&price>sma200){tS+=1;tD.push('All MAs bullish')}
// EMA signals
const ema9=n(d.ema_9),ema21=n(d.ema_21),ema50=n(d.ema_50);
if(ema9>0&&ema21>0){if(ema9>ema21){tS+=1;tD.push('EMA9>21 bullish')}else{tS-=1;tD.push('EMA9<21 bearish')}}
if(ema21>0&&ema50>0){if(ema21>ema50){tS+=1;tD.push('EMA21>50 trend up')}else{tS-=1;tD.push('EMA21<50 trend down')}}
if(ema9>0&&price>ema9){tD.push('Above EMA9')}
tS=Math.max(-6,Math.min(6,tS));score+=tS;
if(tD.length){reasons.push('Technical: '+tD.join(', ')+' ['+(tS>=0?'+':'')+tS+']')}

// F12: PEG RATIO — Growth at Reasonable Price (±6) *** NEW ***
if(peg>0){if(peg<0.8){score+=6;reasons.push('PEG bargain ('+peg.toFixed(1)+') — growth underpriced [+6]')}
else if(peg<1.2){score+=3;reasons.push('PEG fair ('+peg.toFixed(1)+') [+3]')}
else if(peg>2.5){score-=4;reasons.push('PEG stretched ('+peg.toFixed(1)+') — overpaying for growth [-4]')}
else if(peg>1.8){score-=1;reasons.push('PEG slightly high ('+peg.toFixed(1)+') [-1]')}}

// F13: CASH FLOW HEALTH (±8) *** NEW ***
if(fcf>0&&totalRev>0){const fcfM=(fcf/totalRev)*100;
if(fcfM>15){score+=6;reasons.push('Excellent FCF margin '+fcfM.toFixed(1)+'% [+6]')}
else if(fcfM>5){score+=3;reasons.push('Healthy FCF '+fcfM.toFixed(1)+'% of revenue [+3]')}}
else if(fcf<0&&ocf>0){score-=2;reasons.push('Negative FCF despite positive OCF — heavy capex [-2]')}
else if(fcf<0&&ocf<=0){score-=6;reasons.push('Negative cash flows — burning cash [-6]')}
if(ocf>0&&totalDebt>0){const dc=ocf/totalDebt;
if(dc>0.5){score+=2;reasons.push('OCF covers '+Math.round(dc*100)+'% of debt [+2]')}
else if(dc<0.1){score-=2;reasons.push('Cash barely covers debt [-2]')}}

// F14: QUARTERLY EARNINGS MOMENTUM (±6)
if(eqg>0){if(eqg>25){score+=6;reasons.push('Quarterly earnings surging +'+eqg.toFixed(0)+'% YoY [+6]')}
else if(eqg>10){score+=3;reasons.push('Solid quarterly growth +'+eqg.toFixed(0)+'% [+3]')}
else{score+=1;reasons.push('Mild quarterly growth +'+eqg.toFixed(0)+'% [+1]')}}
else if(eqg<0){if(eqg<-20){score-=5;reasons.push('Quarterly earnings plunging '+eqg.toFixed(0)+'% [-5]')}
else if(eqg<-5){score-=2;reasons.push('Quarterly decline '+eqg.toFixed(0)+'% [-2]')}}

// F15: EV/EBITDA — Enterprise valuation (±8)
if(evEbitda>0){if(evEbitda<6){score+=7;reasons.push('Cheap EV/EBITDA ('+evEbitda.toFixed(1)+'x) — takeover value [+7]')}
else if(evEbitda<10){score+=4;reasons.push('Reasonable EV/EBITDA ('+evEbitda.toFixed(1)+'x) [+4]')}
else if(evEbitda<16){score+=1;reasons.push('Fair EV/EBITDA ('+evEbitda.toFixed(1)+'x) [+1]')}
else if(evEbitda>25){score-=5;reasons.push('Very expensive EV/EBITDA ('+evEbitda.toFixed(1)+'x) [-5]')}
else if(evEbitda>18){score-=2;reasons.push('Elevated EV/EBITDA ('+evEbitda.toFixed(1)+'x) [-2]')}}

// F16: GROSS MARGIN POWER — Pricing power & moat (±7)
if(gm>0){if(gm>60){score+=6;reasons.push('Elite gross margins ('+gm.toFixed(0)+'%) — strong moat & pricing power [+6]')}
else if(gm>40){score+=3;reasons.push('Healthy gross margins ('+gm.toFixed(0)+'%) [+3]')}
else if(gm<20){score-=4;reasons.push('Low gross margins ('+gm.toFixed(0)+'%) — weak moat [-4]')}}

// F17: EBITDA MARGIN QUALITY (±5)
if(ebitdaM>0){if(ebitdaM>30){score+=4;reasons.push('Strong EBITDA margins ('+ebitdaM.toFixed(0)+'%) — operational excellence [+4]')}
else if(ebitdaM>15){score+=2;reasons.push('Healthy EBITDA margins ('+ebitdaM.toFixed(0)+'%) [+2]')}
else if(ebitdaM<5&&ebitdaM>0){score-=3;reasons.push('Thin EBITDA margins ('+ebitdaM.toFixed(0)+'%) [-3]')}}

// F18: SHORT INTEREST SIGNAL (±5)
const shortR=n(d.short_ratio);
if(shortR>0){if(shortR>10){score-=4;reasons.push('Very high short interest ('+shortR.toFixed(1)+' days) — bearish [-4]')}
else if(shortR>5){score-=2;reasons.push('Elevated short interest ('+shortR.toFixed(1)+' days) [-2]')}
else if(shortR<1.5){score+=2;reasons.push('Low short interest ('+shortR.toFixed(1)+' days) — bullish sentiment [+2]')}}

// F19: DIVIDEND SUSTAINABILITY (±5)
const payoutR=n(d.payout_ratio);
if(dy>0&&payoutR>0){if(payoutR<40&&dy>2){score+=4;reasons.push('Sustainable dividend — payout '+payoutR.toFixed(0)+'% with '+dy.toFixed(1)+'% yield [+4]')}
else if(payoutR>90){score-=3;reasons.push('Unsustainable payout ('+payoutR.toFixed(0)+'%) — dividend risk [-3]')}
else if(payoutR>70){score-=1;reasons.push('High payout ratio ('+payoutR.toFixed(0)+'%) [-1]')}}

// F20: QUALITY COMBOS — Multi-factor convergence (±8)
if(combG&&combG>15&&pm>15){score+=3;reasons.push('Growth + profitability combo — rare quality [+3]')}
if(combG&&combG<0&&pm<5){score-=3;reasons.push('Declining growth + weak margins — avoid [-3]')}
if(pb>0&&pb<1.5&&pe>0&&pe<sectorPE&&fcf>0){score+=3;reasons.push('P/B + P/E below sector with positive FCF — deep value [+3]')}
if(gm>50&&roe>20&&de<50){score+=3;reasons.push('High margins + high ROE + low debt — compounding machine [+3]')}
// VALUE TRAP detection: cheap valuation + deteriorating fundamentals
if(pe>0&&pe<15&&combG&&combG<-5&&pm<8){score-=6;reasons.push('VALUE TRAP: cheap P/E but shrinking earnings + thin margins [-6]')}
// GROWTH TRAP detection: expensive + growth decelerating
if(pe>30&&combG&&combG<5&&fpe>0&&fpe>pe*0.9){score-=5;reasons.push('GROWTH TRAP: premium valuation but growth stalling [-5]')}
// TRIPLE STRENGTH: valuation + profitability + momentum all positive
if(pe>0&&pe<20&&pm>15&&roe>15&&price>sma50&&price>sma200){score+=4;reasons.push('Triple Strength: fair value + profitable + above key SMAs [+4]')}
// TRIPLE WEAKNESS: expensive + unprofitable + below key levels
if(pe>35&&pm<5&&price<sma200){score-=4;reasons.push('Triple Weakness: overvalued + weak margins + below SMA 200 [-4]')}

// ═══ VERDICT — 20-factor scoring with QUALITY GATES ═══
const totalFactors=reasons.length;
const bullish=reasons.filter(r=>r.includes('[+')).length;
const bearish=reasons.filter(r=>r.includes('[-')).length;
const netRatio=totalFactors>0?(bullish-bearish)/totalFactors:0;
let verdict,vc,conviction,emoji;
// Quality gates: score threshold PLUS minimum factor count AND net ratio
// This prevents inflated verdicts from a few extreme factors
if(score>=55&&bullish>=8&&netRatio>0.4){verdict='STRONG BUY';vc='buy';conviction='Very High';emoji='\uD83D\uDFE2'}
else if(score>=35&&bullish>=6&&netRatio>0.25){verdict='BUY';vc='buy';conviction='High';emoji='\uD83D\uDFE2'}
else if(score>=18&&bullish>=4){verdict='ACCUMULATE';vc='buy';conviction='Medium';emoji='\uD83D\uDFE2'}
else if(score>=-18){verdict='HOLD';vc='hold';conviction=Math.abs(score)<8?'Low':'Medium';emoji='\uD83D\uDFE1'}
else if(score>=-35){verdict='SELL';vc='sell';conviction='Medium';emoji='\uD83D\uDD34'}
else if(bearish>=5){verdict='STRONG SELL';vc='sell';conviction='Very High';emoji='\uD83D\uDD34'}
else{verdict='SELL';vc='sell';conviction='High';emoji='\uD83D\uDD34'}

return {verdict,vc,score,conviction,emoji,reasons,totalFactors,bullish,bearish,
  explain:verdict==='STRONG BUY'?'This stock checks almost every box — priced well, growing, profitable, and trending up. '+bullish+' out of '+totalFactors+' factors are positive. This kind of alignment is rare. For educational analysis only.'
  :verdict==='BUY'?'Company fundamentals are strong — '+bullish+' positive factors outweigh '+bearish+' concerns. Valuation and growth metrics look favorable. For educational analysis only.'
  :verdict==='ACCUMULATE'?'More positive factors ('+bullish+') than negative ('+bearish+'). A mixed but leaning-positive setup that warrants closer study. For educational analysis only.'
  :verdict==='SELL'?'Warning signs detected — '+bearish+' concerns flagged. The stock may be overvalued, margins weakening, or price trend declining. Study the risk factors carefully.'
  :verdict==='STRONG SELL'?'Multiple serious red flags across '+bearish+' areas — overvaluation, weak finances, or falling momentum. High risk detected across our 20-factor model.'
  :'Balanced signals — '+bullish+' positive vs '+bearish+' negative. No clear directional edge in either direction right now. For educational analysis only.'}
}

let vResult;
try{vResult=computeVerdict(d)}catch(e){console.error('computeVerdict error:',e);vResult={score:0,verdict:'HOLD',vc:'hold',conviction:'Low',emoji:'⚠️',explain:'Analysis unavailable',reasons:[],bullish:0,bearish:0,totalFactors:20}}
const verdict=vResult.verdict,vc=vResult.vc;
console.log('Verdict computed:',verdict,'score:',vResult.score);

let html;
try{
console.log('Building template literal...');
html=`
<div class="tab-scroll-area" id="tabScrollArea">
<!-- TAB 1: QUICK INTEL -->
<div class="sub-nav" data-tab="quick">
<a onclick="scrollToSec('sec-verdict')">&#9678; Buy or Sell?</a>
<a onclick="scrollToSec('sec-5things')">&#128200; Key Numbers</a>
<a onclick="scrollToSec('sec-valuation')">&#128176; Overpriced?</a>
<a onclick="scrollToSec('sec-peers')">⚔ Peers</a>
<a onclick="scrollToSec('sec-entry')">&#127919; When to Buy/Sell</a>
<a onclick="scrollToSec('sec-risk')">&#9888; Risks</a>
<a onclick="scrollToSec('sec-charts')">&#128202; Charts</a>

</div>

<!-- VERDICT (always open) -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--green)"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#9678;</div><div class="st" style="color:var(--green)" id="sec-verdict">Verdict</div></div>
<div class="sbody" style="text-align:left">
<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
<div style="flex-shrink:0;text-align:center">
<div class="vpill ${vc}" style="padding:8px 24px;font-size:16px">${verdict}</div>
<div style="margin-top:6px;font-size:10px;color:var(--text3)">Score: <strong style="color:var(--text)">${vResult.score>0?'+':''}${vResult.score}</strong> · Confidence: <strong>${vResult.conviction}</strong> · <span style="color:var(--green)">${vResult.bullish||0} positive</span> / <span style="color:var(--red)">${vResult.bearish||0} negative</span> signals</div>
</div>
<div style="flex:1;min-width:200px">
<p style="font-size:12px;color:var(--text2);margin-bottom:8px">${vResult.explain}</p>
<div style="display:flex;flex-wrap:wrap;gap:4px">
${vResult.reasons.map(r=>{const isPos=r.includes('[+');return '<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:'+(isPos?'rgba(16,185,129,.08)':'rgba(239,68,68,.08)')+';color:'+(isPos?'var(--green)':'var(--red)')+';white-space:nowrap">'+r+'</span>'}).join('')}
</div>
</div>
</div>
</div></div>

<!-- FII/DII FLOW — Indian markets only -->
<div class="sc" data-tab="quick" data-conditional="1" style="border-left:3px solid var(--blue);display:none" id="fiiDiiCard">
<div class="sh"><div class="si" style="background:rgba(37,99,235,.1)">&#127963;</div><div class="st" style="color:var(--blue)" id="sec-fiidii">Who's Buying &amp; Selling Indian Markets Today?</div></div>
<div class="sbody" id="fiiDiiBody"></div>
</div>

<!-- DECISION POINTS -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--amber)"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">&#9651;</div><div class="st" style="color:var(--amber)" id="sec-5things">Key Numbers at a Glance</div></div>
<div class="sbody">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:12px">
${(d.pe_ratio&&d.pe_ratio!=='N/A'&&pe>0)?`<div style="padding:10px;border-radius:8px;text-align:center;background:${pe<18?'rgba(16,185,129,.06)':pe<28?'rgba(245,158,11,.06)':'rgba(239,68,68,.06)'};border:1px solid ${pe<18?'rgba(16,185,129,.15)':pe<28?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)'}">
<div style="font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700">Valuation</div>
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${pe<18?'var(--green)':pe<28?'var(--amber)':'var(--red)'}">${d.pe_ratio}x</div>
<div style="font-size:9px;color:var(--text3)">${pe<18?'✅ Cheap':pe<28?'⚠️ Fair':'🚨 Expensive'}</div>
</div>`:''}
${(d.profit_margin&&d.profit_margin!=='N/A'&&parseFloat(d.profit_margin)!==0)?`<div style="padding:10px;border-radius:8px;text-align:center;background:${parseFloat(d.profit_margin)>15?'rgba(16,185,129,.06)':parseFloat(d.profit_margin)>8?'rgba(245,158,11,.06)':'rgba(239,68,68,.06)'};border:1px solid ${parseFloat(d.profit_margin)>15?'rgba(16,185,129,.15)':parseFloat(d.profit_margin)>8?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)'}">
<div style="font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700">Profitability</div>
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${parseFloat(d.profit_margin)>15?'var(--green)':parseFloat(d.profit_margin)>8?'var(--amber)':'var(--red)'}">${d.profit_margin}%</div>
<div style="font-size:9px;color:var(--text3)">${parseFloat(d.profit_margin)>15?'✅ Strong moat':parseFloat(d.profit_margin)>8?'⚠️ Moderate':'❌ Thin'}</div>
</div>`:''}
${(d.debt_to_equity&&d.debt_to_equity!=='N/A'&&parseFloat(d.debt_to_equity)>0)?`<div style="padding:10px;border-radius:8px;text-align:center;background:${parseFloat(d.debt_to_equity)<0.5?'rgba(16,185,129,.06)':parseFloat(d.debt_to_equity)<1.5?'rgba(245,158,11,.06)':'rgba(239,68,68,.06)'};border:1px solid ${parseFloat(d.debt_to_equity)<0.5?'rgba(16,185,129,.15)':parseFloat(d.debt_to_equity)<1.5?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)'}">
<div style="font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700">Debt Risk</div>
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${parseFloat(d.debt_to_equity)<0.5?'var(--green)':parseFloat(d.debt_to_equity)<1.5?'var(--amber)':'var(--red)'}">${d.debt_to_equity}x</div>
<div style="font-size:9px;color:var(--text3)">${parseFloat(d.debt_to_equity)<0.5?'✅ Conservative':parseFloat(d.debt_to_equity)<1.5?'⚠️ Moderate':'🚨 High leverage'}</div>
</div>`:''}
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
${(d.market_cap&&d.market_cap!=='N/A'&&parseFloat(d.market_cap)>0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">MARKET CAP</div>
<div style="font-size:13px;font-weight:700;color:var(--text)">${formatCap(d.market_cap,curr)} <span style="font-size:10px;color:var(--text3)">${capCategory(d.market_cap,curr)}</span></div>
</div>`:''}
${(d.week52_high&&d.week52_high!=='N/A'&&parseFloat(d.week52_high)>0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">52-WEEK POSITION</div>
<div style="font-size:13px;font-weight:700;color:var(--text)">${((price/d.week52_high)*100).toFixed(0)}% of high ${(d.beta&&d.beta!=='N/A'&&parseFloat(d.beta)>0)?'<span style="font-size:10px;color:var(--text3)">'+(parseFloat(d.beta)>1.3?'High volatility':parseFloat(d.beta)<0.7?'Low volatility':'Avg volatility')+'</span>':''}</div>
</div>`:''}
${(d.roe&&d.roe!=='N/A'&&parseFloat(d.roe)!==0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">ROE (Return on Equity)</div>
<div style="font-size:13px;font-weight:700;color:${parseFloat(d.roe)>15?'var(--green)':'var(--text)'}">${d.roe}% <span style="font-size:10px;color:var(--text3)">${parseFloat(d.roe)>15?'Capital efficient':'Average'}</span></div>
</div>`:''}
${(d.dividend_yield&&d.dividend_yield!=='N/A'&&parseFloat(d.dividend_yield)>0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">DIVIDEND INCOME</div>
<div style="font-size:13px;font-weight:700;color:${parseFloat(d.dividend_yield)>2?'var(--green)':'var(--text)'}">${d.dividend_yield}% <span style="font-size:10px;color:var(--text3)">${parseFloat(d.dividend_yield)>3?'High income':parseFloat(d.dividend_yield)>1?'Some income':'Growth focus'}</span></div>
</div>`:''}
</div>
<div style="margin-top:12px;padding:12px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(245,158,11,.05),rgba(59,130,246,.03));border:1px solid rgba(245,158,11,.12)">
<div style="font-size:12px;font-weight:700;color:var(--amber);margin-bottom:6px">💡 What do these numbers tell you?</div>
<div style="font-size:11px;color:var(--text2);line-height:1.8">
${pe<18&&parseFloat(d.profit_margin)>15?'<strong style="color:var(--green)">Great combo</strong> — stock is cheap AND the company makes good money. This is the sweet spot investors look for.'
:pe>28&&parseFloat(d.profit_margin)<8?'<strong style="color:var(--red)">Warning</strong> — you\'re paying a premium price for a company with thin profits. The stock needs strong growth to justify this.'
:pe<18?'Stock appears <strong style="color:var(--green)">underpriced</strong> relative to its earnings — could be a bargain if the business is solid.'
:pe>28?'Stock is <strong style="color:var(--amber)">priced for perfection</strong> — any earnings miss could cause a sharp drop.'
:'Valuation is <strong>in the fair range</strong> — neither a screaming buy nor overpriced.'}
${parseFloat(d.debt_to_equity)>1.5?' High debt levels mean the company is borrowing heavily — risky if interest rates rise or business slows.':''}
${d.market_cap>100e9?' As a large-cap stock, it\'s relatively stable but may grow slower than smaller companies.':d.market_cap<10e9?' As a smaller company, expect bigger price swings — higher reward potential but higher risk.':''}
</div>
</div>
</div></div>

<!-- VALUATION TABLE -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--blue)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">&#9678;</div><div class="st" style="color:var(--blue)" id="sec-valuation">Is This Stock Overpriced?</div></div>
<div class="sbody">
<p style="font-size:12px;color:var(--text3);margin-bottom:14px">Every number decoded. No jargon:</p>
<table class="dt"><tr><th>Metric</th><th>Value</th><th>Signal</th><th>What This Means For You</th></tr>
${(d.pe_ratio&&d.pe_ratio!=='N/A'&&pe>0)?`<tr><td><strong>P/E Ratio</strong><br><span style="font-size:10px;color:var(--text3)">Price-to-Earnings</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.pe_ratio}</td>
<td><span class="sig ${pe<15?'g':pe<25?'n':'c'}">${pe<15?'● Undervalued':pe<25?'● Fair':'● Expensive'}</span></td>
<td style="font-size:12px;line-height:1.7">${pe<15?'Below 15x earnings. Bargain zone.':pe<25?'Fair at '+d.pe_ratio+'x earnings.':d.pe_ratio+'x earnings. Growth must justify.'}</td></tr>`:''}
${(d.pb_ratio&&d.pb_ratio!=='N/A'&&parseFloat(d.pb_ratio)>0)?`<tr><td><strong>P/B Ratio</strong><br><span style="font-size:10px;color:var(--text3)">Price-to-Book</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.pb_ratio}</td>
<td><span class="sig ${parseFloat(d.pb_ratio)<3?'g':'c'}">${parseFloat(d.pb_ratio)<3?'● Reasonable':'● Premium'}</span></td>
<td style="font-size:12px;line-height:1.7">${parseFloat(d.pb_ratio)<3?d.pb_ratio+'x book. Asset-backed.':d.pb_ratio+'x book. Paying for intangibles.'}</td></tr>`:''}
${(d.profit_margin&&d.profit_margin!=='N/A'&&parseFloat(d.profit_margin)!==0)?`<tr><td><strong>Profit Margin</strong><br><span style="font-size:10px;color:var(--text3)">Profit per $ revenue</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.profit_margin}%</td>
<td><span class="sig ${parseFloat(d.profit_margin)>15?'g':parseFloat(d.profit_margin)>8?'n':'r'}">${parseFloat(d.profit_margin)>15?'● Excellent':parseFloat(d.profit_margin)>8?'● Moderate':'● Thin'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.profit_margin}% net margin. ${parseFloat(d.profit_margin)>15?'Strong moat.':parseFloat(d.profit_margin)>8?'Decent.':'Tight.'}</td></tr>`:''}
${(d.operating_margin&&d.operating_margin!=='N/A'&&parseFloat(d.operating_margin)!==0)?`<tr><td><strong>Operating Margin</strong><br><span style="font-size:10px;color:var(--text3)">Core profitability</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.operating_margin}%</td>
<td><span class="sig ${parseFloat(d.operating_margin)>20?'g':parseFloat(d.operating_margin)>10?'n':'r'}">${parseFloat(d.operating_margin)>20?'● Strong':parseFloat(d.operating_margin)>10?'● OK':'● Weak'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.operating_margin}% ops margin. ${parseFloat(d.operating_margin)>20?'Efficient.':'Room to improve.'}</td></tr>`:''}
${(d.roe&&d.roe!=='N/A'&&parseFloat(d.roe)!==0)?`<tr><td><strong>ROE</strong><br><span style="font-size:10px;color:var(--text3)">Return on Equity</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.roe}%</td>
<td><span class="sig ${parseFloat(d.roe)>15?'g':'n'}">${parseFloat(d.roe)>15?'● High':'● Moderate'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.roe}% return on equity. ${parseFloat(d.roe)>15?'Capital-efficient.':'Average.'}</td></tr>`:''}
${(d.dividend_yield&&d.dividend_yield!=='N/A'&&parseFloat(d.dividend_yield)>=0)?`<tr><td><strong>Dividend Yield</strong><br><span style="font-size:10px;color:var(--text3)">Annual income</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.dividend_yield}%</td>
<td><span class="sig ${parseFloat(d.dividend_yield)>3?'g':parseFloat(d.dividend_yield)>1?'n':'c'}">${parseFloat(d.dividend_yield)>3?'● High Income':parseFloat(d.dividend_yield)>1?'● Some Income':'● Growth Focus'}</span></td>
<td style="font-size:12px;line-height:1.7">${parseFloat(d.dividend_yield)>3?d.dividend_yield+'% yield. Solid income.':parseFloat(d.dividend_yield)>1?d.dividend_yield+'% yield + growth.':'Reinvests for growth.'}</td></tr>`:''}
</table>
<div style="margin-top:14px;padding:14px;border-radius:10px;background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.03));border:1px solid rgba(0,120,212,.12)">
<div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:6px">💡 Valuation Summary</div>
<div style="font-size:11px;color:var(--text2);line-height:1.8">
${pe>0&&pe<15?'<strong style="color:var(--green)">Stock looks undervalued.</strong> You\'re paying less per rupee of earnings than most companies. If fundamentals are solid, this could be a steal.'
:pe>=15&&pe<25?'<strong style="color:var(--blue)">Fairly valued.</strong> The market is pricing this stock reasonably. Not a bargain, but not overpriced either. Good entry if you believe in the company\'s growth story.'
:pe>=25&&pe<40?'<strong style="color:var(--amber)">Premium pricing.</strong> The market expects strong growth from this company. If earnings disappoint even slightly, the stock could drop fast.'
:pe>=40?'<strong style="color:var(--red)">Very expensive.</strong> You\'re paying a steep price for future growth that hasn\'t been proven yet. High risk of correction.'
:'Check the P/E ratio to understand valuation.'}
${parseFloat(d.profit_margin)>15&&pe<25?' High profitability at a fair price — the best combination.':''}
${parseFloat(d.roe)>20?' Strong returns on equity suggest efficient management.':''}
${parseFloat(d.pb_ratio)>0&&parseFloat(d.pb_ratio)<1?' Trading below book value — either a bargain or the market sees problems ahead.':''}
${parseFloat(d.dividend_yield)>3?' Generous dividend — good for income-seeking investors.':''}
</div>
</div>
</div></div>

<!-- PEER / COMPETITOR COMPARISON -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--teal)"><div class="sh"><div class="si" style="background:rgba(20,184,166,.1)">⚔</div><div class="st" style="color:var(--teal)" id="sec-peers">Peer Comparison</div></div>
<div class="sbody" id="peerSection">
<p style="font-size:12px;color:var(--text3);margin-bottom:10px">Loading peer data...</p>
</div>
</div>

<!-- ENTRY & EXIT — Multi-Factor Technical -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(139,92,246,.1)">⬡</div><div class="st" style="color:var(--purple)" id="sec-entry">Entry &amp; Exit Levels</div></div>
<div class="sbody">
<div style="font-size:10px;color:var(--text3);margin-bottom:10px">Levels computed from multiple technical factors including trend, momentum, volatility, and price history. Updated with live data.</div>
<table class="dt"><tr><th>Action</th><th>Price</th><th>Why This Level</th><th>What To Do</th></tr>
<tr><td style="font-weight:700;color:var(--green)">● Buy Zone</td><td><span class="ptag buy">${curr}${(()=>{const e50=n(d.ema_50),s200=n(d.sma_200),fib=d.week52_low+(d.week52_high-d.week52_low)*0.382;const best=e50?Math.min(e50,fib,price*0.93):Math.min(fib,price*0.93);return best.toFixed(2)})()}</span></td><td style="font-size:11px">Strong support zone</td><td style="font-size:12px">${vResult.verdict.includes('BUY')?'Accumulate aggressively at this level':'Start building position here'}</td></tr>
<tr><td style="font-weight:700;color:var(--cyan)">● Accumulate</td><td><span class="ptag buy">${curr}${(()=>{const e21=n(d.ema_21),s50=n(d.sma_50),fib=d.week52_low+(d.week52_high-d.week52_low)*0.5;const best=e21?Math.min(e21,price*0.96):Math.min(fib,price*0.96);return best.toFixed(2)})()}</span></td><td style="font-size:11px">Key demand area</td><td style="font-size:12px">Add on dips to this level</td></tr>
<tr><td style="font-weight:700">● Current</td><td><span class="ptag cur">${curr}${price.toLocaleString()}</span></td><td style="font-size:11px">Live price</td><td style="font-size:12px">${vResult.verdict}</td></tr>
<tr><td style="font-weight:700;color:var(--amber)">● Target 1</td><td><span class="ptag pro">${curr}${(()=>{const e9=n(d.ema_9),fib=d.week52_low+(d.week52_high-d.week52_low)*0.786;const up=n(d.beta)>1.3?price*1.12:price*1.08;const best=e9&&e9>price?Math.max(e9,up):Math.min(fib,up);return Math.max(best,price*1.05).toFixed(2)})()}</span></td><td style="font-size:11px">Near-term resistance</td><td style="font-size:12px">Book 30–50% of position</td></tr>
<tr><td style="font-weight:700;color:var(--amber)">● Target 2</td><td><span class="ptag pro">${curr}${(()=>{const ext=d.week52_low+(d.week52_high-d.week52_low)*1.272;const alt=Math.max(d.week52_high*0.97,price*1.18);return Math.min(ext,alt).toFixed(2)})()}</span></td><td style="font-size:11px">Potential breakout level</td><td style="font-size:12px">Exit remaining profits</td></tr>
<tr><td style="font-weight:700;color:var(--red)">● Stop Loss</td><td><span class="ptag stp">${curr}${(()=>{const e50=n(d.ema_50),s200=n(d.sma_200),fib=d.week52_low+(d.week52_high-d.week52_low)*0.236;const anchor=e50||s200||price;const best=Math.min(anchor*0.95,fib,price*0.88);return Math.max(best,d.week52_low*1.02).toFixed(2)})()}</span></td><td style="font-size:11px">Below key floor</td><td style="font-size:12px">Strict exit — protect capital</td></tr>
</table>
<div style="margin-top:12px;padding:10px 14px;border-radius:8px;background:linear-gradient(135deg,rgba(139,92,246,.04),rgba(59,130,246,.04));border:1px solid rgba(139,92,246,.1)">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:14px">&#128161;</span>
<span style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--purple)">How to read these levels</span>
</div>
<div style="font-size:11px;color:var(--text2);line-height:1.7">
<strong style="color:var(--green)">Buy Zone</strong> = best price to enter a fresh position. <strong style="color:var(--cyan)">Accumulate</strong> = add more if you already hold.
<strong style="color:var(--amber)">Targets</strong> = where to book profits in stages. <strong style="color:var(--red)">Stop Loss</strong> = exit if price falls here to limit damage.
${n(d.beta)>1.3?' This stock has higher-than-average volatility — use wider stops and smaller position sizes.':n(d.beta)<0.7?' This stock is relatively stable — levels are tighter than usual.':''}
</div>
</div>
</div></div>

<!-- RISK ASSESSMENT -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--red)"><div class="sh"><div class="si" style="background:rgba(239,68,68,.1)">&#9888;</div><div class="st" style="color:var(--red)" id="sec-risk">What Could Go Wrong?</div></div>
<div class="sbody">
<table class="dt"><tr><th>Factor</th><th>Metric</th><th>Signal</th><th>Assessment</th></tr>
${(()=>{let rows='';
const de=parseFloat(d.debt_to_equity)||0,cr=parseFloat(d.current_ratio)||0,bt=parseFloat(d.beta)||1;
if(de>0)rows+=`<tr><td>Debt Level</td><td style="font-family:var(--mono);font-weight:600">${d.debt_to_equity}</td><td><span class="sig ${de>1.5?'r':de>0.8?'c':'g'}">${de>1.5?'High':de>0.8?'Moderate':'Low'}</span></td><td style="font-size:12px">${de>1.5?'High leverage \u2014 watch carefully':de>0.8?'Moderate \u2014 manageable':'Conservative \u2014 low risk'}</td></tr>`;
if(cr>0)rows+=`<tr><td>Liquidity</td><td style="font-family:var(--mono);font-weight:600">${d.current_ratio}</td><td><span class="sig ${cr>1.5?'g':cr>1?'c':'r'}">${cr>1.5?'Strong':cr>1?'Adequate':'Weak'}</span></td><td style="font-size:12px">${cr>1.5?'Can meet obligations easily':cr>1?'Tight but OK':'Liquidity concerns'}</td></tr>`;
rows+=`<tr><td>Volatility</td><td style="font-family:var(--mono);font-weight:600">${bt.toFixed(2)}</td><td><span class="sig ${bt>1.5?'r':bt<0.8?'g':'n'}">${bt>1.5?'High':bt<0.8?'Low':'Average'}</span></td><td style="font-size:12px">${bt>1.5?'Expect bigger price swings':bt<0.8?'Less volatile \u2014 defensive':'Average volatility'}</td></tr>`;
if(d.sector&&d.sector!=='N/A'&&d.sector!=='Unknown')rows+=`<tr><td>Sector</td><td>${d.sector}</td><td><span class="sig n">Monitor</span></td><td style="font-size:12px">Track trends &amp; regulation</td></tr>`;
const w52pct=d.week52_high>0?((price/d.week52_high)*100).toFixed(0):0;
if(Number(w52pct)>90)rows+=`<tr><td>52W Position</td><td style="font-family:var(--mono);font-weight:600">${w52pct}% of high</td><td><span class="sig r">Stretched</span></td><td style="font-size:12px">Near 52-week high \u2014 pullback risk</td></tr>`;
else if(Number(w52pct)<40)rows+=`<tr><td>52W Position</td><td style="font-family:var(--mono);font-weight:600">${w52pct}% of high</td><td><span class="sig c">Beaten down</span></td><td style="font-size:12px">Far from highs \u2014 could be value or value trap</td></tr>`;
return rows;})()}
</table>
<div style="margin-top:12px;padding:12px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(239,68,68,.05),rgba(245,158,11,.03));border:1px solid rgba(239,68,68,.1)">
<div style="font-size:12px;font-weight:700;color:var(--red);margin-bottom:6px">&#9888;&#65039; Risk Summary</div>
<div style="font-size:11px;color:var(--text2);line-height:1.8">
${(()=>{const de=parseFloat(d.debt_to_equity)||0,cr=parseFloat(d.current_ratio)||0,bt=parseFloat(d.beta)||1;
if(de>1.5&&cr>0&&cr<1)return '<strong style="color:var(--red)">High risk</strong> \u2014 heavy debt AND weak cash. One bad quarter could create serious trouble.';
if(de>1.5)return '<strong style="color:var(--amber)">Elevated debt</strong> \u2014 if interest rates rise or business slows, this stock will feel the pain first.';
if(cr>0&&cr<1)return '<strong style="color:var(--amber)">Cash is tight</strong> \u2014 the company may struggle to pay short-term bills. Watch quarterly results closely.';
return '<strong style="color:var(--green)">Manageable risk</strong> \u2014 reasonable debt and enough cash to operate. No immediate red flags.';})()}
${(()=>{const bt=parseFloat(d.beta)||1;return bt>1.5?' Expect <strong>bigger daily swings</strong> than the overall market.':'';})()}
</div>
</div>
</div></div>

<!-- CHARTS (Summary — hidden until sub-tab click) -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--cyan)" id="chartsCard">
<div class="sh"><div class="si" style="background:rgba(0,120,212,.08)">&#128202;</div><div class="st" style="color:var(--cyan)" id="sec-charts">Visual Charts &amp; Trends</div></div>
<div class="sbody" id="chartsInner">
<div class="cgrid">
<div class="ccard"><div class="cct">How is this stock valued?</div><div class="cc"><canvas id="valChart"></canvas></div><div id="valInference" class="cinf" style="background:rgba(59,130,246,.04);border-color:rgba(0,120,212,.12)"></div></div>
<div class="ccard"><div class="cct">Is the company financially healthy?</div><div class="cc"><canvas id="healthChart"></canvas></div><div id="healthInference" class="cinf" style="background:rgba(16,185,129,.04);border-color:rgba(16,185,129,.1)"></div></div>
<div class="ccard"><div class="cct">How risky is this stock?</div><div class="cc"><canvas id="riskChart"></canvas></div><div id="riskInference" class="cinf" style="background:rgba(239,68,68,.04);border-color:rgba(239,68,68,.1)"></div></div>
</div>
<div class="cgrid2">
<div class="ccard"><div class="cct">Price trend over 6 months</div><div class="cc2"><canvas id="trendChart"></canvas></div><div id="trendInference" class="cinf" style="background:rgba(59,130,246,.04);border-color:rgba(0,120,212,.12)"></div></div>
<div class="ccard"><div class="cct">How do margins compare to the industry?</div><div class="cc2"><canvas id="marginChart"></canvas></div><div id="marginVsInference" class="cinf" style="background:rgba(6,182,212,.04);border-color:rgba(6,182,212,.1)"></div></div>
</div>
</div></div>

<!-- POSITION ANALYZER — removed for SEBI compliance -->

<!-- ═══ TAB: DEEP DIVE ═══ -->
<div class="sub-nav" data-tab="deep">
<a onclick="scrollToSec('sec-verdictai')">&#127891; Why This Verdict?</a>
<a onclick="scrollToSec('sec-ai')">&#128196; Full AI Report</a>
</div>

<div class="sc" data-tab="deep" style="border-left:3px solid var(--blue)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">🎓</div><div class="st" style="color:var(--blue)" id="sec-verdictai">AI Verdict Breakdown — Green, Yellow & Red</div></div>
<div class="sbody"><div id="aiAnalysisFormatted"></div></div></div>

<!-- Full AI Report -->
<div class="sc" data-tab="deep" style="border-left:3px solid var(--blue)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">&#9889;</div><div class="st" style="color:var(--blue)" id="sec-ai">AI Analyst Report — Full Depth</div></div>
<div class="sbody">
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">
<div style="padding:10px;border-radius:8px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);text-align:center">
<div style="font-size:18px">${vResult.emoji}</div>
<div style="font-size:12px;font-weight:800;color:${vc==='buy'?'var(--green)':vc==='sell'?'var(--red)':'var(--amber)'}">${verdict}</div>
<div style="font-size:9px;color:var(--text3)">${vResult.conviction} Confidence</div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(0,120,212,.04);border:1px solid rgba(0,120,212,.12);text-align:center">
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:var(--text)">${vResult.score>0?'+':''}${vResult.score}</div>
<div style="font-size:9px;color:var(--text3)">Overall Score</div>
<div style="font-size:9px;color:var(--green)">${vResult.bullish||0} positive / <span style="color:var(--red)">${vResult.bearish||0} negative</span></div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.12);text-align:center">
<div style="font-size:14px;font-weight:800;color:var(--text)">${d.sector}</div>
<div style="font-size:9px;color:var(--text3)">${d.market_cap&&d.market_cap>0?formatCap(d.market_cap,curr)+' cap':d.sector}</div>
<div style="font-size:9px;color:var(--text3)">${(d.beta&&d.beta!=='N/A'&&n(d.beta)!==1)?n(d.beta)>1.3?'High volatility':'Low volatility':''}</div>
</div>
</div>
<div style="padding:16px;border-radius:10px;background:var(--bg);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:8px">&#128196; Complete AI-Generated Research Report</div>
<div id="fullAIraw" class="ait" style="max-height:500px;overflow-y:auto;padding-right:8px;font-size:12px;line-height:1.8">${safeReport}</div>
</div></div></div>




<!-- ═══ TAB: EARNINGS ═══ -->
<div class="sub-nav" data-tab="mgmt">
<a onclick="scrollToSec('sec-fund')">&#128200; Latest Earnings</a>
<a onclick="scrollToSec('sec-mgmt')">&#127908; What Management Says</a>
<a onclick="scrollToSec('sec-funds')">&#127974; Who's Investing?</a>
</div>

<div class="sc" data-tab="mgmt" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128200;</div><div class="st" style="color:var(--green)" id="sec-fund">Latest Quarter &#8212; Are They Actually Growing?</div></div>
<div class="sbody">
<div id="fundContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing quarterly fundamentals...</p></div></div>
<!-- QoQ/YoY Charts -->
<div id="qoyCharts" style="display:none;margin-top:16px">
<div class="cgrid2">
<div class="ccard"><div class="cct">&#128200; QoQ Momentum</div><div style="height:200px;position:relative"><canvas id="qoqChart"></canvas></div><div id="qoqInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(59,130,246,.04);border:1px solid rgba(0,120,212,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
<div class="ccard"><div class="cct">&#128200; YoY Growth Trend</div><div style="height:200px;position:relative"><canvas id="yoyChart"></canvas></div><div id="yoyInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
</div>
<div style="margin-top:14px" class="ccard"><div class="cct">&#128200; Margin Trend — QoQ vs YoY</div><div style="height:200px;position:relative"><canvas id="marginTrendChart"></canvas></div><div id="marginInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
</div>
</div></div>


<!-- Management Tone -->
<div class="sc" data-tab="mgmt" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(168,85,247,.1)">&#127908;</div><div class="st" style="color:var(--purple)" id="sec-mgmt">Management Tone — Read Between the Lines</div></div>
<div class="sbody">
<div id="mgmtContent"><div class="ic pu" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing management tone...</p></div></div>
</div></div>

<!-- FUND HOLDINGS -->
<div class="sc" data-tab="mgmt" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">&#127974;</div><div class="st" style="color:var(--blue)" id="sec-funds">Top Fund &amp; Institutional Holdings</div></div>
<div class="sbody">
<div id="fundHoldingsContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Loading fund holdings...</p></div></div>
</div></div>

<!-- ═══ TAB: FORECAST ═══ -->
<div class="sc" data-tab="next" style="border-left:3px solid var(--cyan)"><div class="sh"><div class="si" style="background:rgba(6,182,212,.1)">&#128302;</div><div class="st" style="color:var(--cyan)" id="sec-next">What's Next — Catalysts &amp; Timeline</div></div>
<div class="sbody">
<div id="whatsNextContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing upcoming catalysts...</p></div></div>
<div id="sectorEventsContent" style="margin-top:16px"></div>
</div></div>


<!-- ═══ TAB: GEMS ═══ -->

<!-- ═══ TAB: DCF VALUATION ═══ -->
<div class="sc" data-tab="dcf" style="border-left:3px solid #10b981"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128178;</div><div class="st" style="color:#10b981" id="sec-dcf">DCF Intrinsic Valuation</div></div>
<div class="sbody">
<div id="dcfContent"><div class="ic" style="text-align:center;background:rgba(16,185,129,.04)"><p style="color:var(--text3)">&#9203; Computing DCF model...</p></div></div>
</div></div>

<!-- ═══ TAB: EQUITY RESEARCH ═══ -->
<div class="sc" data-tab="equity" style="border-left:3px solid #d97706"><div class="sh"><div class="si" style="background:rgba(217,119,6,.1)">&#128220;</div><div class="st" style="color:#d97706" id="sec-equity">Equity Research Report</div></div>
<div class="sbody">
<div id="equityContent"><div class="ic" style="text-align:center;background:rgba(217,119,6,.04)"><p style="color:var(--text3)">&#9203; Generating research report...</p></div></div>
</div></div>

<div class="sc" data-tab="gems" style="border-left:3px solid var(--amber)"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">⭐</div><div class="st" style="color:var(--amber)" id="sec-gems">Sector Gems — 10x Small-Caps in <span id="gemsSectorName"></span></div></div>
<div class="sbody">
<div style="padding:10px 14px;border-radius:8px;background:linear-gradient(135deg,rgba(245,158,11,.06),rgba(212,138,0,.03));border:1px solid rgba(245,158,11,.15);margin-bottom:14px">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">&#128161;</span>
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:800;color:var(--amber)">WHY THESE PICKS?</span>
</div>
<p style="font-size:11px;color:var(--text2);line-height:1.6;margin:0">You searched <strong id="gemsTickerRef" style="color:var(--amber)"></strong>. These are under-the-radar small-caps in the <strong id="smallCapSector" style="color:var(--amber)">${d.sector}</strong> sector that share similar tailwinds but with 10-50x growth potential. We match by sector, geography, and growth thesis.</p>
</div>
<div id="smallCapTable"></div>
<div class="ic am" style="margin-top:14px"><p><strong>⚠️ Real talk:</strong> Small-caps = high risk, high reward. Same sector as <strong id="smallCapTicker">${d.ticker}</strong>. Only invest what you can lose. Spread across 5–8 picks. Think 10+ years. These are NOT recommendations — do your own research.</p></div>
</div></div>

<!-- ═══ TAB: PICKS ═══ -->
<!-- SUB-NAV for Picks tab -->
<div class="sub-nav" data-tab="picks">
<a onclick="scrollToSec('sec-conviction')">&#127942; Top Picks</a>
<a onclick="scrollToSec('sec-stockpicks')">&#128161; Stock Ideas</a>
<a onclick="scrollToSec('sec-portfolio')">&#129504; My Portfolio</a>
</div>

<!-- PICKS: Portfolio Decision Engine — toggle panel -->
<!-- PICKS SUB-TAB 2: Conviction Leaderboard -->
<div class="sc" data-tab="picks" style="border-left:3px solid var(--teal,#0d9488)"><div class="sh"><div class="si" style="background:rgba(13,148,136,.1)">&#127942;</div><div class="st" style="color:#0d9488" id="sec-conviction">Conviction Leaderboard — Top 5 by Country</div></div>
<div class="sbody">
<div id="convictionLeaderboard">
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="convGeoTabs">
<button class="ptab active" onclick="showConvGeo(this,'india')" style="background:var(--amber);color:#000;border-color:var(--amber)">&#127470;&#127475; India</button>
<button class="ptab" onclick="showConvGeo(this,'usa')">&#127482;&#127480; USA</button>
</div>
<div id="convGrid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px"></div>
</div>
</div></div>

<!-- PICKS SUB-TAB 3: Curated Stock Picks -->
<div class="sc" data-tab="picks" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(139,92,246,.1)">&#128161;</div><div class="st" style="color:var(--purple)" id="sec-stockpicks">Curated Stock Picks — Sector-Based</div></div>
<div class="sbody">
<div id="stockPicksSection">
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="pickTabs">
<button class="ptab active" onclick="showPickCat(this,'lc')">Large Cap</button>
<button class="ptab" onclick="showPickCat(this,'mc')">Mid Cap</button>
<button class="ptab" onclick="showPickCat(this,'sc')">Small Cap</button>
<button class="ptab" onclick="showPickCat(this,'niche')">Niche/Moat</button>
<button class="ptab" onclick="showPickCat(this,'micro')">&#128640; Micro Cap</button>
<button class="ptab" onclick="showPickCat(this,'penny')">&#128176; Penny Gems</button>
<button class="ptab" onclick="showPickCat(this,'idx')">&#128200; Best Index</button>
</div>
<div id="pickGrid"></div>
</div>
</div></div>

<div class="sc" data-tab="picks" style="border-left:3px solid var(--blue)" id="portfolioCard"><div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">&#129504;</div><div class="st" style="color:var(--blue)" id="sec-portfolio">Portfolio Decision Engine</div></div>
<div class="sbody">
<div style="padding:14px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.04));border:1px solid rgba(0,120,212,.25);margin-bottom:18px">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
<span style="font-size:18px">&#129504;</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:800;color:var(--blue)">Portfolio Decision Engine</span>
<span style="font-size:9px;color:var(--text3);padding:2px 6px;border-radius:4px;background:var(--surface);border:1px solid var(--border)">Multi-Factor Algorithm</span>
</div>
<div style="font-size:10px;color:var(--text3);margin-bottom:12px">Enter your stock &amp; buy price — get a data-driven HOLD / SELL / ADD decision with probability across 3, 6, 12-month horizons.</div>
<div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">TICKER (e.g. RELIANCE.NS, AAPL)</label>
<input type="text" id="pdTicker" placeholder="RELIANCE.NS" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#f0f2f5;color:var(--text);font-family:var(--mono);font-size:13px;font-weight:700"></div>
<div style="flex:0.6;min-width:100px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">YOUR BUY PRICE</label>
<input type="number" id="pdBuyPrice" placeholder="1250" step="0.01" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#f0f2f5;color:var(--text);font-family:var(--mono);font-size:13px;font-weight:700"></div>
<button onclick="runPortfolioDecision()" id="pdBtn" style="padding:8px 20px;border-radius:8px;border:2px solid var(--blue);background:rgba(59,130,246,.12);color:var(--blue);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">&#9889; Analyze Decision</button>
</div>
<div id="pdResult" style="margin-top:12px"></div>
</div>
<div style="padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.1)">
<div style="font-family:'Sora',sans-serif;font-size:10px;font-weight:700;color:var(--purple);letter-spacing:.5px;margin-bottom:8px">RATING &amp; LABEL GUIDE</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;font-size:10px;line-height:1.6">
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(16,185,129,.15);color:#10b981;font-weight:800">&#9733; Aggressive Buy</span> Strong fundamentals + survives 30-40% correction</span>
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(16,185,129,.1);color:#10b981;font-weight:700">Strong Buy</span> Excellent business, limited correction downside</span>
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(0,120,212,.12);color:#3b82f6;font-weight:700">Buy</span> Good value but moderate correction sensitivity</span>
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(245,158,11,.1);color:#f59e0b;font-weight:700">Accumulate</span> Build position gradually on dips</span>
</div>
</div>
</div></div>

<!-- ═══ TAB: ETF & FUNDS ═══ -->
<div class="sc" data-tab="funds" style="border-left:3px solid var(--green)"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128176;</div><div class="st" style="color:var(--green)" id="sec-etf">ETF &amp; Funds — 25%+ CAGR Compounders</div></div>
<div class="sbody">
<div style="padding:10px 14px;border-radius:8px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.1);margin-bottom:14px">
<div style="font-family:'Sora',sans-serif;font-size:10px;font-weight:700;color:var(--green);letter-spacing:.5px;margin-bottom:6px">SELECTION CRITERIA</div>
<div style="font-size:10px;color:var(--text2);line-height:1.6">Only funds with <strong style="color:var(--green)">25%+ CAGR</strong> over 5-year AND/OR 10-year periods. Correction resilience scored on max drawdown + recovery speed during COVID (Mar 2020), 2022 bear market, and Oct 2023 correction. <strong style="color:var(--amber)">SIP-friendly picks</strong> — designed for long-term wealth building, not trading.</div>
</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="fundTabs">
<button class="ptab active" onclick="showFundCat(this,'etf_in')">&#127470;&#127475; India ETFs</button>
<button class="ptab" onclick="showFundCat(this,'mf_in')">&#127470;&#127475; India Mutual Funds</button>
<button class="ptab" onclick="showFundCat(this,'etf_us')">&#127482;&#127480; USA ETFs</button>
<button class="ptab" onclick="showFundCat(this,'mf_us')">&#127482;&#127480; USA Funds</button>
<button class="ptab" onclick="showFundCat(this,'compare')">&#128202; Comparison</button>
</div>
<div id="fundGrid"></div>
</div></div>

<!-- TAB 7: INDEX TRADES (Restricted Access) -->
<div class="sc" data-tab="trades" style="border-left:3px solid var(--red)"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">&#128293;</div><div class="st" style="color:var(--amber)" id="sec-trades">Smart Trades &#8212; Daily Ideas</div></div>
<div class="sbody">
<div id="tradesContent">
<div style="text-align:center;padding:30px 20px">
<div style="font-size:40px;margin-bottom:12px">&#128274;</div>
<div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:700;color:var(--amber);margin-bottom:8px">Premium Trading Intelligence</div>
<p style="font-size:13px;color:var(--text3);max-width:450px;margin:0 auto 20px;line-height:1.7">Top 5 index + 2 stock option trade ideas daily. Nifty, Bank Nifty, Sensex &amp; high-momentum stocks.</p>
<button id="tradesLoadBtn" onclick="loadIndexTrades()" style="padding:12px 28px;border-radius:10px;border:2px solid var(--amber);background:rgba(245,158,11,.1);color:var(--amber);font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s">&#9889; Generate Today's Trades</button>
<button id="scorecardBtn" onclick="loadTradeScorecard()" style="padding:12px 20px;border-radius:10px;border:2px solid var(--cyan);background:rgba(6,182,212,.08);color:var(--cyan);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;cursor:pointer;margin-left:8px">&#128202; Trade Scorecard</button>
<div id="tradesError" style="margin-top:12px;font-size:12px;color:var(--red);display:none"></div>
<div id="scorecardArea" style="display:none;margin-top:16px"></div>
</div>
</div>
</div></div>

</div><!-- end tab-scroll-area -->
`;
}catch(te){console.error('Template error:',te);html='<div style="padding:40px;text-align:center;color:var(--red)"><h3>Rendering Error</h3><p>'+te.message+'</p></div>';}

console.log('Template built OK, length:',html?.length,'chars');
document.getElementById('analysisContainer').innerHTML=html;
console.log('innerHTML set OK, calling switchTab...');
// Show static tab bar
document.getElementById('mainTabBar').style.display='flex';
// Show tabs FIRST — before any chart/analysis code that might error
checkTradesAccess();
try{formatAIAnalysis(report)}catch(e){console.warn('formatAIAnalysis error:',e)}
try{populateFundamentals(report)}catch(e){console.warn('populateFundamentals error:',e)}
try{populateManagement(report)}catch(e){console.warn('populateManagement error:',e)}
try{populateFundHoldings(report, fundData)}catch(e){console.warn('populateFundHoldings error:',e)}
try{populateWhatsNext(report)}catch(e){console.warn('populateWhatsNext error:',e)}
try{generateSmallCapRecommendations(d)}catch(e){console.warn('generateSmallCapRecommendations error:',e)}
try{renderConviction()}catch(e){console.warn('renderConviction error:',e)}
try{renderDCF(d)}catch(e){console.warn('renderDCF error:',e)}
try{renderEquityResearch(d,report,fundData)}catch(e){console.warn('renderEquityResearch error:',e)}
try{renderIndices(d)}catch(e){console.warn('renderIndices error:',e)}
try{renderPersonalFinance()}catch(e){console.warn('renderPersonalFinance error:',e)}
// Auto-open Quick Intel tab
switchTab('quick');
// Refresh watermark with user email
try{refreshWatermark()}catch(e){}
// Draw attention to vote button after report loads
setTimeout(()=>{const fab=document.querySelector('.fab');if(fab){fab.style.transform='scale(1.15)';fab.style.boxShadow='0 0 40px rgba(139,92,246,.6)';setTimeout(()=>{fab.style.transform='';fab.style.boxShadow=''},1500)}},4000);
// Draw attention to tab bar with pulse animation
const tbar=document.querySelector('.tab-bar');
if(tbar){tbar.classList.add('attention');setTimeout(()=>tbar.classList.remove('attention'),6500)}}

// ═══════════════════════════════════════════════
// TAB SWITCHING
// ═══════════════════════════════════════════════
function toggleChartsSection(){
// Legacy function — charts are now in their own tab
window.dispatchEvent(new Event('resize'));
}

function switchTab(tab){
try{
if(typeof gtag==='function')gtag('event','switch_tab',{tab_name:tab});
if(tab==='quick')setTimeout(()=>window.dispatchEvent(new Event('resize')),200);

// 1) Hide ALL tab content and sub-navs
document.querySelectorAll('.sc[data-tab]').forEach(s=>{s.style.display='none'});
document.querySelectorAll('.sub-nav[data-tab]').forEach(s=>{s.style.display='none'});
document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));

// 2) Show matching tab content
document.querySelectorAll('.sc[data-tab="'+tab+'"]').forEach(s=>{
if(!s.dataset.conditional)s.style.display='block';
});
document.querySelectorAll('.sub-nav[data-tab="'+tab+'"]').forEach(s=>{s.style.display='flex'});

// 3) Activate button
const btnMap={quick:'tabBtnQuick',deep:'tabBtnDeep',mgmt:'tabBtnMgmt',next:'tabBtnNext',dcf:'tabBtnDCF',equity:'tabBtnEquity',indices:'tabBtnIndices',finance:'tabBtnFinance',daily:'tabBtnDaily',compare:'tabBtnCompare',gems:'tabBtnGems',picks:'tabBtnPicks',funds:'tabBtnFunds',trades:'tabBtnTrades'};
if(btnMap[tab]){const btn=document.getElementById(btnMap[tab]);if(btn)btn.classList.add('active')}

// 4) Scroll to top of new tab content — scroll-margin-top:140px on .sc handles sticky offset
const firstSec=document.querySelector('.sc[data-tab="'+tab+'"]');
if(firstSec) firstSec.scrollIntoView({behavior:'instant',block:'start'});

// 5) REFRESH LIVE PRICES on tab switch — forces fresh data every tab click
if(tab==='picks'){
_livePriceCache={};
const pg=document.getElementById('pickGrid');
if(pg)fetchLivePricesForPicks(pg);
fetchConvictionPrices();
console.log('🔄 Picks: refreshing live prices');
}
if(tab==='funds'){
_livePriceCache={};
const fg=document.querySelector('.sc[data-tab="funds"]');
if(fg)fetchFundNAVs(fg);
console.log('🔄 Funds: refreshing live NAVs');
}
if(tab==='indices'){
if(!window._indicesRendered){
try{renderIndices();window._indicesRendered=true}catch(e){console.error('Indices render error:',e)}
}
const activeGeo=document.querySelector('.idx-geo-btn.active');
const geo=activeGeo&&activeGeo.textContent.includes('USA')?'usa':'india';
fetchIndexPrices(geo);
console.log('🔄 Indices: refreshing prices');
}
if(tab==='finance'){
if(!window._financeRendered){
try{renderPersonalFinance();window._financeRendered=true;console.log('🔄 Finance: rendered')}catch(e){console.error('Finance render error:',e)}
}
}
if(tab==='daily'){
if(!window._dailyLoading&&!window._dailyRendered){
window._dailyLoading=true;
fetchMarketDaily();
}
}

console.log('switchTab:',tab,'→ done');
}catch(e){console.error('switchTab error:',e)}
}

// Scroll to section — uses CSS scroll-margin-top for sticky header offset
function scrollToSec(id){
const el=document.getElementById(id);if(!el)return;
el.scrollIntoView({behavior:'smooth',block:'start'});
}

// ═══════════════════════════════════════════════
// PARSE AI TEXT → QUARTERLY FUNDAMENTALS
// ═══════════════════════════════════════════════
// populateFundamentals is defined below after colorizeText
// populateManagement is defined below after colorizeText

// CHARTS (5 total) - with beginner-friendly tooltips + N/A handling
function createCharts(d){
if(valChart)valChart.destroy();if(trendChart)trendChart.destroy();if(healthChart)healthChart.destroy();if(riskChart)riskChart.destroy();if(marginChart)marginChart.destroy();
const gc='rgba(0,47,108,.06)';
Chart.defaults.color='#94a3b8';Chart.defaults.font.family="'DM Sans',sans-serif";
const ttBase={backgroundColor:'rgba(0,47,108,.95)',titleColor:'#fff',bodyColor:'#d1d5db',borderColor:'rgba(0,120,212,.25)',borderWidth:1,cornerRadius:8,padding:12,titleFont:{size:13,weight:'700'},bodyFont:{size:12},displayColors:false};

// Helper: parse number, return 0 for N/A
function n(v){const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f}

// Detect if we have meaningful data
const pe=n(d.pe_ratio),pb=n(d.pb_ratio),dy=n(d.dividend_yield);
const pm=n(d.profit_margin),om=n(d.operating_margin),roe=n(d.roe);
const beta=Math.abs(n(d.beta))||1,de=n(d.debt_to_equity),cr=n(d.current_ratio)||1;
const hasValuation=true; // Always show — will display 0 values with "Data unavailable" note
const hasHealth=(pm>0||om>0||roe>0||n(d.current_ratio)>0||dy>0);
const hasRisk=true; // Always show — beta defaults to 1, de defaults to moderate

// Hide entire chart card when no data, collapse empty grids
function hideChart(canvasId){
const canvas=document.getElementById(canvasId);
if(!canvas)return;
const card=canvas.closest('.ccard');
if(card)card.style.display='none';
// If all siblings in the grid are hidden, hide the grid too
const grid=card?.parentElement;
if(grid&&(grid.classList.contains('cgrid')||grid.classList.contains('cgrid2'))){
const visible=[...grid.children].filter(c=>c.style.display!=='none');
if(visible.length===0)grid.style.display='none';
}
}

// 1. Valuation Bar
if(hasValuation){
const valExplain=['P/E Ratio: How much you pay per $1 of earnings.\n'+( pe<15?'Below 15 = potential bargain!':pe<25?'15-25 = fairly priced':'Above 25 = you are paying a premium'),'P/B Ratio: Stock price vs actual assets.\n'+(pb<3?'Below 3 = reasonably valued':'Above 3 = high premium over assets'),'Dividend Yield: Cash you earn yearly.\n'+(dy>3?'Above 3% = great passive income':dy>1?'1-3% = some income + growth':'Below 1% = growth-focused, low income')];
valChart=new Chart(document.getElementById('valChart').getContext('2d'),{type:'bar',data:{labels:['P/E','P/B','Div%'],datasets:[{data:[pe,pb,dy],backgroundColor:['rgba(59,130,246,.35)','rgba(139,92,246,.35)','rgba(16,185,129,.35)'],borderColor:['#3b82f6','#8b5cf6','#10b981'],borderWidth:1.5,borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return['P/E Ratio','P/B Ratio','Dividend Yield'][c[0].dataIndex]},label:function(c){return['Value: '+c.formattedValue,'',valExplain[c.dataIndex]].join('\n')}}}},scales:{y:{beginAtZero:true,grid:{color:gc}},x:{grid:{display:false}}}}});
}else{hideChart('valChart')}

// 2. Financial Health Radar
if(hasHealth){
const hVals=[Math.min(100,pm),Math.min(100,roe),Math.min(100,(n(d.current_ratio))*25),Math.min(100,om),Math.min(100,dy*10)];
const hLabels=['Profit Margin','ROE','Current Ratio','Op. Margin','Div Yield'];
const hExplain=['How much profit per $1 of sales. Higher = better pricing power.','Return on equity. Above 15% = excellent use of shareholder money.','Can the company pay its short-term bills? Above 1.5 = safe.','Profit from core business before taxes. Higher = efficient operations.','Cash returned to you yearly. Higher = more passive income.'];
healthChart=new Chart(document.getElementById('healthChart').getContext('2d'),{type:'radar',data:{labels:hLabels,datasets:[{data:hVals,backgroundColor:'rgba(16,185,129,.12)',borderColor:'#10b981',borderWidth:2,pointBackgroundColor:'#10b981',pointRadius:4,pointHoverRadius:7,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#10b981',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return hLabels[c[0].dataIndex]},label:function(c){return['Score: '+c.formattedValue+'/100','',hExplain[c.dataIndex]].join('\n')}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(59,130,246,.06)'},angleLines:{color:'rgba(59,130,246,.06)'},ticks:{display:false},pointLabels:{font:{size:9},color:'#94a3b8'}}}}});
}else{hideChart('healthChart')}

// 3. Risk Radar
if(hasRisk){
const rVals=[Math.min(100,(beta||1)*40),Math.min(100,de>0?de*30:30),Math.min(100,cr>0?Math.max(0,100-cr*40):50),Math.min(100,(pe>0?pe:15)*2),50];
const rLabels=['Volatility','Debt','Liquidity Risk','Valuation Risk','Sector Risk'];
const rExplain=['How wildly the price swings vs the market.\nHigher = bumpier ride for your portfolio.','How much the company owes vs owns.\nHigh debt = more risk if business slows down.','Can the company cover its bills right now?\nHigh risk here = cash flow concerns.','Is the stock overpriced for what it earns?\nHigher = you might be overpaying.','General risk from the industry and economy.\nAll sectors carry some baseline risk.'];
riskChart=new Chart(document.getElementById('riskChart').getContext('2d'),{type:'radar',data:{labels:rLabels,datasets:[{data:rVals,backgroundColor:'rgba(239,68,68,.1)',borderColor:'#ef4444',borderWidth:2,pointBackgroundColor:'#ef4444',pointRadius:4,pointHoverRadius:7,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#ef4444',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return rLabels[c[0].dataIndex]+' Risk'},label:function(c){const v=c.raw;const lv=v>70?'HIGH RISK':v>40?'MODERATE':'LOW';return['Risk Score: '+Math.round(v)+'/100 ('+lv+')','',rExplain[c.dataIndex]].join('\n')}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(59,130,246,.06)'},angleLines:{color:'rgba(59,130,246,.06)'},ticks:{display:false},pointLabels:{font:{size:9},color:'#94a3b8'}}}}});
}else{hideChart('riskChart')}

// 4. Price Trend (uses real historical data if available, simulated fallback)
const price=d.current_price||100;
const realHist=d.price_history&&d.price_history.length>=2?d.price_history:null;
const trend=realHist||[];
if(!realHist){for(let i=6;i>=0;i--)trend.push(price*(1+(Math.random()-.5)*.12*i/6))}
const trendLabels=realHist?trend.map((_,i)=>i===trend.length-1?'Today':i===0?`${trend.length-1}M Ago`:`${trend.length-1-i}M`):['6M Ago','5M','4M','3M','2M','1M','Today'];
const curr=d.currency==='INR'?'₹':'$';
trendChart=new Chart(document.getElementById('trendChart').getContext('2d'),{type:'line',data:{labels:trendLabels,datasets:[{data:trend,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.06)',fill:true,tension:.4,borderWidth:2.5,pointBackgroundColor:'#3b82f6',pointBorderColor:'#ffffff',pointBorderWidth:2,pointRadius:4,pointHoverRadius:8,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#3b82f6',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return 'Price — '+c[0].label},label:function(c){const p=c.raw;const diff=p-price;const pct=((p/price-1)*100).toFixed(1);return['Price: '+curr+p.toFixed(2),'vs Today: '+(diff>=0?'+':'')+pct+'%','','Hover each point to track the price journey'].join('\n')}}}},scales:{y:{grid:{color:gc},ticks:{callback:function(v){return curr+v.toFixed(0)}}},x:{grid:{display:false}}}}});

// 5. Margin Comparison
if(hasHealth){
const mExplain={0:['Profit Margin: '+pm+'% vs 15% benchmark','',pm>15?'Beating the benchmark = strong pricing power!':pm>8?'Close to benchmark. Decent but room to improve.':'Below benchmark. Tight margins = competitive pressure.'],1:['Operating Margin: '+om+'% vs 12% benchmark','',om>12?'Core business is running efficiently.':'Core operations could be more profitable.'],2:['Return on Equity: '+roe+'% vs 15% benchmark','',roe>15?'Great returns for shareholders!':'Average returns. Capital could work harder.']};
marginChart=new Chart(document.getElementById('marginChart').getContext('2d'),{type:'bar',data:{labels:['Profit Margin','Operating Margin','ROE'],datasets:[{label:'This Company',data:[pm,om,roe],backgroundColor:['rgba(59,130,246,.4)','rgba(6,182,212,.4)','rgba(16,185,129,.4)'],borderColor:['#3b82f6','#06b6d4','#10b981'],borderWidth:1.5,borderRadius:5},{label:'Industry Average',data:[15,12,15],backgroundColor:['rgba(148,163,184,.1)','rgba(148,163,184,.1)','rgba(148,163,184,.1)'],borderColor:['#475569','#475569','#475569'],borderWidth:1,borderRadius:5}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:12,padding:10,color:'#94a3b8'}},tooltip:{...ttBase,callbacks:{title:function(c){return c[0].label},afterBody:function(c){return mExplain[c[0].dataIndex]||[]}}}},scales:{x:{beginAtZero:true,grid:{color:gc},ticks:{callback:function(v){return v+'%'}}},y:{grid:{display:false}}}}});
}else{hideChart('marginChart')}

// ═══ CHART INFERENCES — Plain English for all 5 charts ═══
// Valuation
const vI=document.getElementById('valInference');
if(vI&&pe>0){
const peVerdict=pe<15?'<strong style="color:var(--green)">undervalued</strong> — below 15x earnings':pe<25?'<strong style="color:var(--blue)">fairly valued</strong> — reasonable multiple':'<strong style="color:var(--amber)">premium priced</strong> — market expects high growth';
const pbVerdict=pb<2?'Book value supports the price.':pb<5?'Moderate premium over book value.':'High premium — mostly intangible value.';
const dyVerdict=dy>3?'Strong dividend income.':dy>1?'Modest income + growth.':'Growth stock — reinvests profits.';
const curr=d.currency==='INR'?'₹':'$';
let ivHtml='';
const iv=d.intrinsic;
if(iv){
ivHtml='<div style="margin-top:8px;padding:8px 10px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.1);display:flex;flex-wrap:wrap;gap:6px 14px;font-size:10px">';
ivHtml+='<span style="font-weight:800;color:#8b5cf6;font-size:10px;letter-spacing:.3px">INTRINSIC VALUE</span>';
if(iv.graham){const gc=iv.graham_upside>10?'var(--green)':iv.graham_upside<-10?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">Graham: <strong style="color:${gc}">${curr}${iv.graham.toLocaleString()}</strong> <span style="font-size:9px;color:${gc}">(${iv.graham_upside>0?'+':''}${iv.graham_upside}%)</span></span>`}
if(iv.dcf_simple){const dc=iv.dcf_upside>10?'var(--green)':iv.dcf_upside<-10?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">DCF: <strong style="color:${dc}">${curr}${iv.dcf_simple.toLocaleString()}</strong> <span style="font-size:9px;color:${dc}">(${iv.dcf_upside>0?'+':''}${iv.dcf_upside}%)</span></span>`}
if(iv.earnings_yield){const ep=iv.earnings_yield_premium;const ec=ep>2?'var(--green)':ep<0?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">E-Yield: <strong style="color:${ec}">${iv.earnings_yield}%</strong> <span style="font-size:9px;color:${ec}">${ep>0?'+':''}${ep}% vs bonds</span></span>`}
if(iv.book_value){ivHtml+=`<span style="color:var(--text2)">Book: <strong>${curr}${iv.book_value.toLocaleString()}</strong></span>`}
ivHtml+='</div>';
}
vI.innerHTML=`<strong style="color:var(--blue)">Reading:</strong> At ${pe.toFixed(1)}x earnings, this stock is ${peVerdict}. P/B of ${pb.toFixed(1)}x — ${pbVerdict} Yield ${dy.toFixed(1)}% — ${dyVerdict}${ivHtml}`;
}

// Financial Health
const hI=document.getElementById('healthInference');
if(hI){
if(pm<=0&&om<=0&&roe<=0){
hI.innerHTML=`<strong style="color:var(--amber)">Health check:</strong> Margin data unavailable for this stock. Check your broker or financial portal for detailed profitability metrics.`;
}else{
const scores=[pm,om,roe,dy].filter(v=>v>0);
const avg=scores.length?scores.reduce((a,b)=>a+b,0)/scores.length:0;
const verdict=avg>20?'<strong style="color:var(--green)">Excellent financial health</strong> — strong across metrics':avg>10?'<strong style="color:var(--blue)">Solid fundamentals</strong> — above-average profitability':'<strong style="color:var(--amber)">Room for improvement</strong> — watch for margin expansion';
const best=pm>=om&&pm>=roe?'Profit margins':roe>=pm&&roe>=om?'Capital efficiency':'Operating margins';
hI.innerHTML=`<strong style="color:var(--green)">Health check:</strong> ${verdict}. Strongest area: ${best}. Profit margin ${pm.toFixed(1)}%, Operating margin ${om.toFixed(1)}%, ROE ${roe.toFixed(1)}%.`;
}
}

// Risk Profile
const riI=document.getElementById('riskInference');
if(riI){
const beta=d.beta||1;
const de=parseFloat(d.debt_to_equity)||0;
const betaVerdict=beta>1.3?'<strong style="color:var(--red)">high volatility</strong> — swings more than the market':beta>0.8?'<strong style="color:var(--blue)">moderate volatility</strong> — moves with the market':'<strong style="color:var(--green)">low volatility</strong> — defensive stock';
const debtVerdict=de>100?'Heavy debt load.':de>50?'Moderate leverage.':'Conservative balance sheet.';
riI.innerHTML=`<strong style="color:var(--red)">Risk summary:</strong> Beta of ${beta.toFixed(2)} means ${betaVerdict}. D/E ratio ${de.toFixed(0)}% — ${debtVerdict} ${de>100?'Watch for interest rate sensitivity.':''}`;
}

// Price Trend
const tI=document.getElementById('trendInference');
if(tI&&trend&&trend.length>=2){
const sixMoAgo=trend[0];const today=trend[trend.length-1];
const totalReturn=((today-sixMoAgo)/sixMoAgo*100).toFixed(1);
const peak=Math.max(...trend);const trough=Math.min(...trend);
const drawdown=((peak-trough)/peak*100).toFixed(1);
const recent=trend[trend.length-1]-trend[trend.length-2];
const recentDir=recent>0?'<strong style="color:var(--green)">trending up</strong>':'<strong style="color:var(--red)">pulling back</strong>';
tI.innerHTML=`<strong style="color:var(--blue)">6-month return:</strong> <strong style="color:${totalReturn>=0?'var(--green)':'var(--red)'}">${totalReturn>=0?'+':''}${totalReturn}%</strong>${realHist?'':' <span style="font-size:9px;color:var(--text3)">(approx)</span>'}. Drawdown: ${drawdown}%. Currently ${recentDir}. ${parseFloat(totalReturn)>15?'Strong momentum.':parseFloat(totalReturn)<-10?'Under pressure.':'Watch for breakout.'}`;
}

// Margin vs Industry
const mvI=document.getElementById('marginVsInference');
if(mvI){
if(pm<=0&&om<=0&&roe<=0){
mvI.innerHTML=`<strong style="color:#06b6d4">vs Peers:</strong> Margin data unavailable for comparison. Check your broker for detailed profitability metrics.`;
}else{
const pmBeat=pm>15;const omBeat=om>12;const roeBeat=roe>15;
const beatsCount=[pmBeat,omBeat,roeBeat].filter(Boolean).length;
const verdict=beatsCount===3?'<strong style="color:var(--green)">Outperforms industry</strong> on all three metrics — competitive moat visible':beatsCount>=1?'<strong style="color:var(--blue)">Mixed vs industry</strong> — beats on some metrics, lags on others':'<strong style="color:var(--red)">Underperforms industry averages</strong> — efficiency improvements needed';
mvI.innerHTML=`<strong style="color:#06b6d4">vs Peers:</strong> ${verdict}. ${pm>0?'Profit margin '+pm.toFixed(1)+'% '+(pmBeat?'&#10003;':'&#10007;')+' | ':''} ${om>0?'Op. margin '+om.toFixed(1)+'% '+(omBeat?'&#10003;':'&#10007;')+' | ':''} ${roe>0?'ROE '+roe.toFixed(1)+'% '+(roeBeat?'&#10003;':'&#10007;'):''} <span style="color:var(--text3)">(&#10003;=beats avg, &#10007;=below avg)</span>`;
}
}
}

// SMALL CAP DATABASE (ALL sectors)
function generateSmallCapRecommendations(d){
const sector=d.sector||'Technology',isIndian=d.ticker&&(d.ticker.includes('.NS')||d.ticker.includes('.BO')||d.currency==='INR');
// Populate dynamic header
const gSec=document.getElementById('gemsSectorName');if(gSec)gSec.textContent=sector;
const gTk=document.getElementById('gemsTickerRef');if(gTk)gTk.textContent=d.ticker||'';
const db={
'Technology_US':[{n:'Palantir (PLTR)',s:'AI/Big Data',k:'Gov + enterprise AI platform',p:'Very High',r:5},{n:'CrowdStrike (CRWD)',s:'Cybersecurity',k:'Cloud-native endpoint protection',p:'Very High',r:5},{n:'Datadog (DDOG)',s:'Monitoring',k:'Unified observability platform',p:'Very High',r:4},{n:'MongoDB (MDB)',s:'Database',k:'Modern document DB, dev-first',p:'High',r:4},{n:'Cloudflare (NET)',s:'Edge',k:'CDN, security, serverless',p:'Very High',r:4},{n:'Unity (U)',s:'3D/Gaming',k:'Real-time 3D engine',p:'High',r:3}],
'Technology_India':[{n:'Kaynes Technology',s:'IoT/Defense',k:'Defense electronics, govt contracts',p:'Exceptional',r:5},{n:'Dixon Technologies',s:'Electronics Mfg',k:'PLI beneficiary, contract mfg',p:'Very High',r:5},{n:'Persistent Systems',s:'Software',k:'Digital engineering, healthcare IT',p:'Very High',r:4},{n:'Coforge',s:'IT Services',k:'Insurance & banking tech',p:'High',r:4},{n:'KPIT Technologies',s:'Auto SW',k:'EV software, T25 auto clients',p:'Very High',r:4},{n:'Happiest Minds',s:'Digital',k:'Cloud, IoT, security',p:'High',r:3}],
'Financial Services_US':[{n:'SoFi (SOFI)',s:'Fintech',k:'Digital banking, lending',p:'Very High',r:5},{n:'Markel (MKL)',s:'Insurance',k:'Mini Berkshire model',p:'High',r:4},{n:'Shift4 (FOUR)',s:'Payments',k:'Integrated processing',p:'Very High',r:4},{n:'Ally Financial (ALLY)',s:'Banking',k:'Top online bank, auto lending',p:'High',r:3},{n:'Houlihan Lokey (HLI)',s:'IB',k:'M&A advisory, restructuring',p:'High',r:4},{n:'Kinsale Capital (KNSL)',s:'Insurance',k:'E&S, tech underwriting',p:'High',r:3}],
'Financial Services_India':[{n:'Bajaj Finance',s:'NBFC',k:'Consumer lending leader',p:'Very High',r:5},{n:'Chola Finance',s:'Vehicle Finance',k:'Vehicle + home loans',p:'Very High',r:4},{n:'SBI Cards',s:'Credit Cards',k:'SBI network, card growth',p:'High',r:4},{n:'CDSL',s:'Depository',k:'Duopoly, demat growth',p:'High',r:4},{n:'Angel One',s:'Broking',k:'Discount broking platform',p:'Very High',r:4},{n:'Motilal Oswal',s:'Financial',k:'Broking, AMC, wealth',p:'High',r:3}],
'Healthcare_US':[{n:'Intuitive Surgical (ISRG)',s:'Robotic Surgery',k:'Da Vinci monopoly',p:'Very High',r:5},{n:'Dexcom (DXCM)',s:'Devices',k:'CGM leader diabetes',p:'Very High',r:4},{n:'Veeva (VEEV)',s:'Life Sci IT',k:'Cloud for pharma',p:'High',r:4},{n:'Shockwave (SWAV)',s:'Cardiology',k:'Intravascular lithotripsy',p:'Very High',r:4},{n:'Axonics (AXNX)',s:'Neuro',k:'Bladder/bowel therapy',p:'High',r:3},{n:'Inspire Medical (INSP)',s:'Sleep',k:'Implantable neurostim',p:'High',r:3}],
'Healthcare_India':[{n:'Max Healthcare',s:'Hospitals',k:'Premium hospitals',p:'Very High',r:5},{n:'Narayana Health',s:'Hospitals',k:'Affordable healthcare',p:'Very High',r:4},{n:'Laurus Labs',s:'Pharma',k:'API + formulations',p:'High',r:4},{n:'Metropolis',s:'Diagnostics',k:'Premium diagnostics',p:'High',r:3},{n:'Syngene',s:'CRAMS',k:'Contract research',p:'Very High',r:4},{n:'Gland Pharma',s:'Injectables',k:'Global injectables',p:'High',r:3}],
'Consumer Cyclical_US':[{n:'Airbnb (ABNB)',s:'Travel',k:'Global marketplace',p:'Very High',r:5},{n:'Lululemon (LULU)',s:'Athleisure',k:'Premium cult brand',p:'High',r:4},{n:'DraftKings (DKNG)',s:'Betting',k:'Online gaming leader',p:'Very High',r:4},{n:'Carvana (CVNA)',s:'Auto',k:'Online used car marketplace',p:'High',r:3},{n:'Floor & Decor (FND)',s:'Home',k:'Specialty flooring',p:'High',r:3},{n:'Five Below (FIVE)',s:'Retail',k:'Teen/tween value',p:'High',r:3}],
'Consumer Cyclical_India':[{n:'Trent Limited',s:'Retail',k:'Zara India + Zudio',p:'Exceptional',r:5},{n:'Page Industries',s:'Innerwear',k:'Jockey India',p:'Very High',r:4},{n:'Devyani Intl',s:'QSR',k:'KFC + Pizza Hut India',p:'Very High',r:4},{n:'Varun Beverages',s:'Beverages',k:'PepsiCo franchise',p:'Very High',r:4},{n:'Jubilant FoodWorks',s:'QSR',k:'Dominos India',p:'High',r:3},{n:'Bata India',s:'Footwear',k:'Brand heritage',p:'High',r:3}],
'Industrials_US':[{n:'Chart Industries (GTLS)',s:'Equipment',k:'LNG, hydrogen',p:'Very High',r:4},{n:'Generac (GNRC)',s:'Power',k:'Generators, clean energy',p:'High',r:4},{n:'Bloom Energy (BE)',s:'Fuel Cells',k:'Solid oxide cells',p:'Very High',r:4},{n:'AAON (AAON)',s:'HVAC',k:'Commercial HVAC',p:'High',r:3},{n:'AZEK (AZEK)',s:'Building',k:'Sustainable decking',p:'High',r:3},{n:'Fluence (FLNC)',s:'Storage',k:'Battery systems',p:'Very High',r:4}],
'Industrials_India':[{n:'Kaynes Technology',s:'Defense',k:'Defense & space, IoT',p:'Exceptional',r:5},{n:'Dixon Technologies',s:'Electronics',k:'PLI, diversified',p:'Very High',r:5},{n:'Polycab India',s:'Cables',k:'Infra growth, FMEG',p:'Very High',r:4},{n:'KEI Industries',s:'Cables',k:'Power cables',p:'High',r:3},{n:'Kalpataru Projects',s:'EPC',k:'Power transmission',p:'High',r:3},{n:'Apar Industries',s:'Conductors',k:'Specialty cables',p:'High',r:4}],
'Energy_US':[{n:'Enphase (ENPH)',s:'Solar',k:'Microinverters',p:'Very High',r:4},{n:'Array Tech (ARRY)',s:'Trackers',k:'Utility-scale solar',p:'High',r:3},{n:'Chord Energy (CHRD)',s:'O&G',k:'Bakken, low-cost',p:'High',r:3},{n:'Magnolia Oil (MGY)',s:'O&G',k:'Eagle Ford',p:'High',r:3},{n:'Shoals Tech (SHLS)',s:'Solar',k:'EBOS',p:'High',r:3},{n:'NextEra Partners (NEP)',s:'Renewables',k:'Wind & solar',p:'High',r:3}],
'Energy_India':[{n:'Adani Green',s:'Renewables',k:'Solar/wind capacity',p:'Very High',r:4},{n:'Tata Power',s:'Power',k:'Renewable transition',p:'Very High',r:4},{n:'SJVN',s:'Hydro',k:'Hydro, PSU backing',p:'High',r:3},{n:'Borosil Renewables',s:'Solar Glass',k:'Solar glass mfg',p:'Very High',r:4},{n:'Suzlon Energy',s:'Wind',k:'Wind turnaround',p:'High',r:3},{n:'Waaree Energies',s:'Solar',k:'PV manufacturing',p:'Very High',r:4}]
};
let geo=isIndian?'India':'US',sectorKey=sector.replace(' Services','').replace('Financial','Financial Services').trim();
let key=`${sectorKey}_${geo}`;
let recs=db[key];
if(!recs){key=`${sector.split(' ')[0]}_${geo}`;recs=db[key]}
if(!recs){recs=db[`Technology_${geo}`]};
const altGeo=geo==='India'?'US':'India';
let altKey=`${sectorKey}_${altGeo}`;let altRecs=db[altKey];
if(!altRecs){altKey=`${sector.split(' ')[0]}_${altGeo}`;altRecs=db[altKey]}
if(!altRecs){altRecs=db[`Technology_${altGeo}`]};
function gemsTable(data,label){
let t=`<div style="margin-bottom:14px"><div style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--amber);margin-bottom:6px">${label}</div>`;
t+=`<table class="dt"><tr><th>Company</th><th>Focus</th><th>Strengths</th><th>Rating</th><th>Potential</th></tr>`;
data.forEach(c=>{const clr=c.p.includes('Exceptional')||c.p.includes('Very High')?'var(--green)':'var(--amber)';
const stars='★'.repeat(c.r)+'☆'.repeat(5-c.r);
t+=`<tr><td><strong>${c.n}</strong></td><td>${c.s}</td><td style="font-size:12px">${c.k}</td><td style="color:var(--amber);letter-spacing:1px">${stars}</td><td style="color:${clr};font-weight:600;font-size:12px">${c.p}</td></tr>`});
return t+'</table></div>'}
document.getElementById('smallCapTable').innerHTML=gemsTable(recs,geo==='India'?'\u{1F1EE}\u{1F1F3} India Picks':'\u{1F1FA}\u{1F1F8} USA Picks')+gemsTable(altRecs,altGeo==='India'?'\u{1F1EE}\u{1F1F3} India Picks':'\u{1F1FA}\u{1F1F8} USA Picks')}

// ═══════════════════════════════════════════════
// DECISION TOOL — "What Should I Do With My Position?"
// Multi-factor algorithm: P&L, valuation, momentum,
// 52W position, margins, intrinsic value, verdict score
// ═══════════════════════════════════════════════
function renderDecisionTool(d,curr){
const el=document.getElementById('decisionTool');
if(!el)return;
const card=document.getElementById('decisionToolCard');
// Don't auto-show card — user toggles it via sub-tab
const price=d.current_price||0;
el.style.display='block';
el.innerHTML=`
<div class="sh" style="margin-bottom:4px"><div class="si" style="background:rgba(6,182,212,.1)">&#127919;</div><div class="st" style="color:var(--cyan)">What Should I Do? — Position Analyzer</div></div>
<div style="padding:10px 16px 14px">
<div style="font-size:11px;color:var(--text3);margin-bottom:10px">Enter the price you bought this stock at. Our 20-factor algorithm will tell you whether to hold, sell, or accumulate — and for how long.</div>
<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
<div style="display:flex;align-items:center;gap:6px">
<span style="font-size:11px;color:var(--text3);font-weight:600">I bought at</span>
<span style="font-size:13px;font-weight:700;color:var(--text)">${curr}</span>
<input type="number" id="buyPriceInput" class="dec-input" placeholder="0.00" step="0.01" min="0">
</div>
<button onclick="runDecision()" style="padding:8px 18px;border-radius:8px;border:1px solid var(--cyan);background:rgba(6,182,212,.1);color:var(--cyan);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s">&#9889; Analyze My Position</button>
<div style="font-size:10px;color:var(--text3)">CMP: <strong style="color:var(--text)">${curr}${price.toLocaleString()}</strong></div>
</div>
<div id="decisionResult" style="margin-top:12px"></div>
</div>`;
// Auto-run if user presses Enter
setTimeout(()=>{
const inp=document.getElementById('buyPriceInput');
if(inp)inp.addEventListener('keydown',e=>{if(e.key==='Enter')runDecision()});
// Anti-copy: block right-click, drag, and print on decision tool
el.addEventListener('contextmenu',e=>e.preventDefault());
el.addEventListener('dragstart',e=>e.preventDefault());
el.addEventListener('copy',e=>{e.preventDefault();e.clipboardData.setData('text/plain','Content protected by Celesys AI')});
},100);
}

function runDecision(){
const d=window._stockData;
const curr=window._stockCurr||'$';
if(!d)return;
const inp=document.getElementById('buyPriceInput');
const el=document.getElementById('decisionResult');
if(!inp||!el)return;
const buyPrice=parseFloat(inp.value);
if(!buyPrice||buyPrice<=0){el.innerHTML='<div style="font-size:11px;color:var(--red)">Please enter a valid buy price.</div>';return}

const price=d.current_price||0;
if(!price){el.innerHTML='<div style="font-size:11px;color:var(--red)">No current price data available.</div>';return}

// ═══ 11-FACTOR DECISION ALGORITHM ═══
// F1: P&L Position | F2: Absolute Valuation (P/E) | F3: 52-Week Position
// F4: Profitability | F5: Return on Equity | F6: Dividend Support
// F7: Volatility (Beta) | F8: P&L-Adjusted Conviction
// F9: Earnings Velocity (EPS + Revenue CAGR) | F10: Relative Valuation (P/E vs Sector)
// F11: Technical Momentum (SMA20/SMA200 crossover + price position)
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f};
const pe=n(d.pe_ratio);
const fpe=n(d.forward_pe);
const pb=n(d.pb_ratio);
const pm=n(d.profit_margin);
const roe=n(d.roe);
const beta=n(d.beta)||1;
const dy=n(d.dividend_yield);
const hi=n(d.week52_high);
const lo=n(d.week52_low);
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;
const sma20=n(d.sma_20);
const sma50=n(d.sma_50);
const sma200=n(d.sma_200);
const epsGrowth=n(d.eps_growth_pct);
const revGrowth=n(d.revenue_growth);
const earningsGrowth=n(d.earnings_growth);
const sectorPE=n(d.sector_avg_pe)||20;

// Factor 1: P&L Position
const pnl=((price-buyPrice)/buyPrice)*100;
const pnlAbs=Math.abs(pnl);
let score=0;
const factors=[];

// Factor 2: Absolute Valuation (P/E)
let valScore=0;
if(pe>0&&pe<12){valScore=8;factors.push({f:'Deeply undervalued (P/E '+pe.toFixed(1)+'x)',s:'+8',c:'g'})}
else if(pe>0&&pe<18){valScore=5;factors.push({f:'Fair value (P/E '+pe.toFixed(1)+'x)',s:'+5',c:'g'})}
else if(pe>0&&pe<28){valScore=2;factors.push({f:'Reasonably priced (P/E '+pe.toFixed(1)+'x)',s:'+2',c:'b'})}
else if(pe>=28&&pe<50){valScore=-3;factors.push({f:'Expensive (P/E '+pe.toFixed(1)+'x)',s:'-3',c:'r'})}
else if(pe>=50){valScore=-6;factors.push({f:'Very expensive (P/E '+pe.toFixed(1)+'x)',s:'-6',c:'r'})}
score+=valScore;

// Factor 3: 52-Week Position
let w52Score=0;
if(w52pct<0.15){w52Score=6;factors.push({f:'Near 52W low ('+Math.round(w52pct*100)+'%) — deep value zone',s:'+6',c:'g'})}
else if(w52pct<0.35){w52Score=3;factors.push({f:'Lower half of 52W range ('+Math.round(w52pct*100)+'%)',s:'+3',c:'g'})}
else if(w52pct>0.9){w52Score=-4;factors.push({f:'Near 52W high ('+Math.round(w52pct*100)+'%) — limited upside',s:'-4',c:'r'})}
else if(w52pct>0.75){w52Score=-1;factors.push({f:'Upper range ('+Math.round(w52pct*100)+'%)',s:'-1',c:'a'})}
else{w52Score=1;factors.push({f:'Mid-range ('+Math.round(w52pct*100)+'%)',s:'+1',c:'b'})}
score+=w52Score;

// Factor 4: Profitability
if(pm>20){score+=4;factors.push({f:'Strong margins ('+pm.toFixed(1)+'%)',s:'+4',c:'g'})}
else if(pm>10){score+=2;factors.push({f:'Decent margins ('+pm.toFixed(1)+'%)',s:'+2',c:'b'})}
else if(pm>0){score+=0;factors.push({f:'Thin margins ('+pm.toFixed(1)+'%)',s:'0',c:'a'})}
else if(pm<0){score-=3;factors.push({f:'Negative margins ('+pm.toFixed(1)+'%) — losing money',s:'-3',c:'r'})}

// Factor 5: Return on Equity
if(roe>20){score+=3;factors.push({f:'Excellent ROE ('+roe.toFixed(1)+'%)',s:'+3',c:'g'})}
else if(roe>12){score+=1;factors.push({f:'Good ROE ('+roe.toFixed(1)+'%)',s:'+1',c:'b'})}
else if(roe<5&&roe>0){score-=2;factors.push({f:'Poor ROE ('+roe.toFixed(1)+'%)',s:'-2',c:'r'})}

// Factor 6: Dividend support
if(dy>4){score+=3;factors.push({f:'High dividend yield ('+dy.toFixed(1)+'%) cushions downside',s:'+3',c:'g'})}
else if(dy>2){score+=1;factors.push({f:'Moderate dividend ('+dy.toFixed(1)+'%)',s:'+1',c:'b'})}

// Factor 7: Volatility risk (beta)
if(beta>1.5){score-=2;factors.push({f:'High volatility (beta '+beta.toFixed(2)+') — wider swings',s:'-2',c:'r'})}
else if(beta<0.8){score+=2;factors.push({f:'Low volatility (beta '+beta.toFixed(2)+') — defensive',s:'+2',c:'g'})}

// Factor 8: P&L-adjusted conviction
if(pnl>50){score-=2;factors.push({f:'Sitting on '+pnl.toFixed(1)+'% gain — consider partial booking',s:'-2',c:'a'})}
else if(pnl>20){score+=0;factors.push({f:'Healthy gain of '+pnl.toFixed(1)+'%',s:'0',c:'g'})}
else if(pnl>0){score+=2;factors.push({f:'Small gain of '+pnl.toFixed(1)+'% — room to grow',s:'+2',c:'g'})}
else if(pnl>-10){score+=1;factors.push({f:'Minor loss of '+pnl.toFixed(1)+'% — normal fluctuation',s:'+1',c:'b'})}
else if(pnl>-25){score+=0;factors.push({f:'Loss of '+pnl.toFixed(1)+'% — review thesis',s:'0',c:'a'})}
else{score-=2;factors.push({f:'Deep loss of '+pnl.toFixed(1)+'% — thesis may be broken',s:'-2',c:'r'})}

// ═══ NEW: Factor 9: Earnings Velocity (EPS CAGR + Revenue Growth) ═══
// Combines forward EPS growth vs trailing + revenue momentum
const bestEpsG=epsGrowth||earningsGrowth;
const combGrowth=bestEpsG&&revGrowth?(bestEpsG*0.6+revGrowth*0.4):bestEpsG||revGrowth;
if(combGrowth>30){score+=5;factors.push({f:'Exceptional growth (EPS '+bestEpsG.toFixed(0)+'% + Rev '+revGrowth.toFixed(0)+'%) — high CAGR trajectory',s:'+5',c:'g'})}
else if(combGrowth>15){score+=3;factors.push({f:'Strong growth (EPS '+bestEpsG.toFixed(0)+'% + Rev '+revGrowth.toFixed(0)+'%)',s:'+3',c:'g'})}
else if(combGrowth>5){score+=1;factors.push({f:'Moderate growth (EPS '+bestEpsG.toFixed(0)+'% + Rev '+revGrowth.toFixed(0)+'%)',s:'+1',c:'b'})}
else if(combGrowth>0){score+=0;factors.push({f:'Sluggish growth ('+combGrowth.toFixed(0)+'% blended)',s:'0',c:'a'})}
else if(combGrowth<=-5){score-=3;factors.push({f:'Earnings contracting ('+combGrowth.toFixed(0)+'%) — thesis at risk',s:'-3',c:'r'})}
else if(combGrowth<0){score-=1;factors.push({f:'Slight decline ('+combGrowth.toFixed(0)+'%)',s:'-1',c:'a'})}
// Forward PE compression check (forward < trailing = earnings accelerating)
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=2;factors.push({f:'Forward P/E ('+fpe.toFixed(1)+'x) < Trailing ('+pe.toFixed(1)+'x) — earnings accelerating',s:'+2',c:'g'})}
else if(fpe>0&&pe>0&&fpe>pe*1.15){score-=1;factors.push({f:'Forward P/E ('+fpe.toFixed(1)+'x) > Trailing ('+pe.toFixed(1)+'x) — earnings decelerating',s:'-1',c:'r'})}

// ═══ NEW: Factor 10: Relative Valuation (P/E vs Sector Average) ═══
if(pe>0&&sectorPE>0){
const peRatio=pe/sectorPE;
const discount=((sectorPE-pe)/sectorPE*100).toFixed(0);
if(peRatio<0.6){score+=5;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% below sector avg '+sectorPE+'x — deep discount',s:'+5',c:'g'})}
else if(peRatio<0.85){score+=3;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% below sector avg '+sectorPE+'x — undervalued vs peers',s:'+3',c:'g'})}
else if(peRatio<=1.15){score+=1;factors.push({f:'P/E '+pe.toFixed(1)+'x is in line with sector avg '+sectorPE+'x',s:'+1',c:'b'})}
else if(peRatio<=1.5){score-=2;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% above sector avg '+sectorPE+'x — premium priced',s:'-2',c:'a'})}
else{score-=4;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% above sector avg '+sectorPE+'x — extremely expensive vs peers',s:'-4',c:'r'})}
}

// ═══ NEW: Factor 11: Technical Momentum (SMA20/SMA50/SMA200 position) ═══
let techScore=0;
let techDetails=[];
if(sma20>0){
if(price>sma20){techScore+=1;techDetails.push('Above SMA20 ('+sma20.toLocaleString()+')')}
else{techScore-=1;techDetails.push('Below SMA20 ('+sma20.toLocaleString()+')')}
}
if(sma200>0){
if(price>sma200){techScore+=2;techDetails.push('Above SMA200 ('+sma200.toLocaleString()+') — long-term uptrend')}
else{techScore-=2;techDetails.push('Below SMA200 ('+sma200.toLocaleString()+') — long-term downtrend')}
}
if(sma20>0&&sma200>0){
if(sma20>sma200){techScore+=2;techDetails.push('Golden Cross (SMA20 > SMA200) — bullish')}
else if(sma20<sma200*0.95){techScore-=2;techDetails.push('Death Cross (SMA20 << SMA200) — bearish')}
}
if(sma50>0&&sma200>0){
if(sma50>sma200&&price>sma50){techScore+=1;techDetails.push('SMA50 > SMA200 with price above both — strong uptrend')}
}
// EMA crossover signals
const _ema9=n(d.ema_9),_ema21=n(d.ema_21),_ema50=n(d.ema_50);
if(_ema9>0&&_ema21>0){
if(_ema9>_ema21){techScore+=1;techDetails.push('EMA9 > EMA21 — short-term bullish crossover')}
else{techScore-=1;techDetails.push('EMA9 < EMA21 — short-term bearish')}
}
if(_ema21>0&&_ema50>0){
if(_ema21>_ema50){techScore+=1;techDetails.push('EMA21 > EMA50 — medium-term uptrend')}
else{techScore-=1;techDetails.push('EMA21 < EMA50 — medium-term downtrend')}
}
// Cap tech score
techScore=Math.max(-6,Math.min(6,techScore));
score+=techScore;
if(techDetails.length>0){
const tC=techScore>=3?'g':techScore>=1?'b':techScore<=-2?'r':'a';
factors.push({f:'Technical: '+techDetails.join(', '),s:(techScore>=0?'+':'')+techScore,c:tC});
}

// ═══ COMPUTE DECISION ═══
// Adjusted thresholds for multi-factor system (max possible ~45, typical range -15 to +30)
let decision,decCol,decBg,timeline,probability,reasoning,action;

if(score>=18){
decision='STRONG HOLD';decCol='#10b981';decBg='rgba(16,185,129,.1)';
timeline='12-24 months';probability=Math.min(95,78+Math.floor(score/2));
reasoning='Exceptional across all 11 factors — valuation, growth, momentum, and technicals all align. This stock has serious compounding potential.';
action=pnl<0?'Average down aggressively on any 5-10% dip. Every factor supports this being a long-term winner.':'Hold your entire position. Consider adding on 10%+ corrections. This is a compounder.';
}else if(score>=12){
decision='HOLD & ACCUMULATE';decCol='#10b981';decBg='rgba(16,185,129,.08)';
timeline='6-12 months';probability=Math.min(90,72+Math.floor(score/2));
reasoning='Strong fundamentals + positive momentum. Earnings velocity and technical trend both support holding.';
action=pnl<-15?'Accumulate more to average down. Growth trajectory intact despite paper loss.':'Hold current position. Add on 5-8% pullbacks when SMA20 acts as support.';
}else if(score>=6){
decision='HOLD';decCol='#22d3ee';decBg='rgba(6,182,212,.08)';
timeline='6-12 months';probability=Math.min(82,64+score);
reasoning='Decent fundamentals with moderate growth. No urgency to act, but monitor quarterly earnings closely.';
action=pnl>30?'Consider booking 25-30% of profits. Let the rest ride with a trailing stop.':'Hold and review after next quarterly results. Watch for SMA200 break.';
}else if(score>=0){
decision='HOLD WITH CAUTION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';
timeline='3-6 months';probability=Math.min(72,56+score);
reasoning='Mixed signals. Fundamentals are average. Watch for deterioration.';
action=pnl>40?'Book 50% profits. Re-enter on correction.':pnl<-20?'Set a strict stop loss 10% below current price. Reassess in 3 months.':'Monitor closely. Exit if next quarter earnings disappoint.';
}else if(score>=-5){
decision='REDUCE POSITION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';
timeline='0-3 months';probability=Math.min(65,55+Math.abs(score));
reasoning='Weak fundamentals or expensive valuation. Risk-reward unfavorable at current levels.';
action=pnl>20?'Book 50-70% profits now. Keep small tracking position.':'Sell 50% now. Set stop loss on remainder at '+curr+(price*0.92).toFixed(0)+'.';
}else{
decision='EXIT / SELL';decCol='#ef4444';decBg='rgba(239,68,68,.08)';
timeline='Immediately';probability=Math.min(80,60+Math.abs(score));
reasoning='Multiple red flags. Poor fundamentals, expensive valuation, or broken thesis. Capital is better deployed elsewhere.';
action=pnl>0?'Book all profits. Re-evaluate only if fundamentals improve for 2+ quarters.':'Cut losses. Holding a losing position with weak fundamentals compounds damage.';
}

probability=Math.max(55,Math.min(95,probability));

// Price targets
const upside=score>=4?Math.max(5,Math.min(40,score*3)):0;
const target1=price*(1+upside/200); // 3-month conservative
const target2=price*(1+upside/100); // 12-month optimistic
const stopLoss=price*(score>=0?0.88:0.92);

// ═══ RENDER RESULT ═══
let h=`<div style="position:relative;padding:14px;border-radius:10px;background:${decBg};border:1px solid ${decCol}25;overflow:hidden">`;
// Watermark grid overlay
h+=`<div style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:5;opacity:.035;overflow:hidden" id="decWatermark"></div>`;
h+=`<div style="position:relative;z-index:6">`;

// Header: Decision badge + P&L
h+=`<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">
<div style="display:flex;align-items:center;gap:10px">
<span class="dec-badge" style="background:${decBg};border:2px solid ${decCol};color:${decCol}">${decision}</span>
<div>
<div style="font-size:10px;color:var(--text3)">Timeline</div>
<div style="font-size:13px;font-weight:700;color:var(--text)">${timeline}</div>
</div>
<div>
<div style="font-size:10px;color:var(--text3)">Probability</div>
<div style="font-size:13px;font-weight:700;color:${decCol}">${probability}%</div>
</div>
</div>
<div style="text-align:right">
<div style="font-size:10px;color:var(--text3)">Your P&L</div>
<div style="font-size:16px;font-weight:800;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}${pnl.toFixed(1)}%</div>
<div style="font-size:10px;color:var(--text3)">${curr}${buyPrice.toLocaleString()} → ${curr}${price.toLocaleString()}</div>
</div>
</div>`;

// Probability meter
h+=`<div class="dec-meter"><div class="dec-meter-fill" style="width:${probability}%;background:linear-gradient(90deg,${decCol}88,${decCol})"></div></div>`;

// Reasoning + Action
h+=`<div style="margin:10px 0;font-size:12px;color:var(--text2);line-height:1.6">${reasoning}</div>`;
h+=`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,47,108,.04);border-left:3px solid ${decCol};margin-bottom:12px">
<div style="font-size:10px;font-weight:700;color:${decCol};margin-bottom:2px">&#9654; RECOMMENDED ACTION</div>
<div style="font-size:11px;color:var(--text);line-height:1.6">${action}</div>
</div>`;

// Price targets row
if(score>=0){
h+=`<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
<div style="flex:1;min-width:100px;padding:6px 10px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15)">
<div style="font-size:9px;color:var(--red);font-weight:700">STOP LOSS</div>
<div style="font-size:12px;font-weight:700;color:var(--red)">${curr}${stopLoss.toFixed(0)}</div>
</div>
<div style="flex:1;min-width:100px;padding:6px 10px;border-radius:6px;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15)">
<div style="font-size:9px;color:var(--cyan);font-weight:700">3-MONTH TARGET</div>
<div style="font-size:12px;font-weight:700;color:var(--cyan)">${curr}${target1.toFixed(0)}</div>
</div>
<div style="flex:1;min-width:100px;padding:6px 10px;border-radius:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)">
<div style="font-size:9px;color:var(--green);font-weight:700">12-MONTH TARGET</div>
<div style="font-size:12px;font-weight:700;color:var(--green)">${curr}${target2.toFixed(0)}</div>
</div>
</div>`;
}

// Factor breakdown
h+=`<div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:.5px;margin-bottom:6px">FACTOR BREAKDOWN (Score: ${score>=0?'+':''}${score})</div>`;
h+=`<div style="display:flex;flex-wrap:wrap;gap:4px">`;
factors.forEach(f=>{
const fc=f.c==='g'?'var(--green)':f.c==='r'?'var(--red)':f.c==='a'?'var(--amber)':'var(--blue)';
const fbg=f.c==='g'?'rgba(16,185,129,.08)':f.c==='r'?'rgba(239,68,68,.08)':f.c==='a'?'rgba(245,158,11,.08)':'rgba(0,120,212,.08)';
h+=`<span style="font-size:9px;padding:3px 8px;border-radius:4px;background:${fbg};color:${fc};line-height:1.4"><strong>[${f.s}]</strong> ${f.f}</span>`;
});
h+=`</div>`;

h+=`<div style="margin-top:8px;font-size:9px;color:var(--text3)">This is algorithmic analysis based on current fundamentals, not financial advice. Market conditions change — reassess after major events or quarterly results. Consult your financial advisor.</div>`;
h+=`</div></div>`; // close inner z-index wrapper + outer container
el.innerHTML=h;
// Generate watermark grid in decision result
const dw=document.getElementById('decWatermark');
if(dw){let wh='';for(let r=0;r<6;r++)for(let c=0;c<4;c++){const x=c*25+Math.random()*5;const y=r*18+Math.random()*5;wh+=`<span style="position:absolute;left:${x}%;top:${y}%;font-size:10px;font-weight:800;color:#0087d2;transform:rotate(-35deg);white-space:nowrap;letter-spacing:2px;font-family:'Sora',sans-serif">CELESYS.AI</span>`}dw.innerHTML=wh}
// Block right-click on decision result
el.addEventListener('contextmenu',e=>e.preventDefault());
}

// ═══════════════════════════════════════════════
// QUARTERLY FUNDAMENTALS - Extract from AI report
// ═══════════════════════════════════════════════
function populateFundamentals(rawText){
const el=document.getElementById('fundContent');
if(!el)return;

// Extract section between QUARTERLY FUNDAMENTALS and MANAGEMENT TONE
let section='';
const fundStart=rawText.search(/QUARTERLY FUNDAMENTALS|QUARTERLY ANALYSIS|EARNINGS ANALYSIS|FUNDAMENTAL.*SNAPSHOT/i);
const fundEnd=rawText.search(/MANAGEMENT TONE|🎙️|CEO\/CFO Confidence/i);
if(fundStart!==-1){
section=fundEnd>fundStart?rawText.substring(fundStart,fundEnd):rawText.substring(fundStart,fundStart+3000);
}else{
// Broader fallback: look for earnings/revenue keywords
const earningsMatch=rawText.search(/(?:latest|recent|last).*(?:quarter|earnings|revenue|QoQ|YoY)/i);
if(earningsMatch!==-1)section=rawText.substring(Math.max(0,earningsMatch-100),earningsMatch+2500);
}
if(!section||section.length<50){
el.innerHTML='<div class="ic am"><p style="color:var(--text3)">Quarterly data not available for this stock.</p></div>';
return;
}

// Clean
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');
let html='';

// Parse **heading:** content blocks
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(heading&&content&&content.length>10)blocks.push({heading,content});
else if(heading&&!content){
// Sometimes heading has the content inline after colon
const nextLine=(parts[i+1]||'').trim();
if(nextLine.length>5)blocks.push({heading,content:nextLine});
}
}

// Fallback line-by-line if blocks are sparse
if(blocks.length<2){
const lines=cleaned.split('\n').filter(l=>l.trim().length>20&&!/^QUARTERLY|^---/i.test(l.trim()));
lines.forEach(l=>{
const colonSplit=l.match(/^([^:]{5,50}):\s*(.{10,})/);
if(colonSplit)blocks.push({heading:colonSplit[1].trim(),content:colonSplit[2].trim()});
else if(l.trim().length>30&&blocks.length<8)blocks.push({heading:'',content:l.trim()});
});
}

// Theme mapping for quarterly blocks
const qThemes=[
{match:/revenue|top.line|sales/i,icon:'💰',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/earning|eps|bottom.line|net income|profit/i,icon:'📊',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/margin|gross|operating/i,icon:'📐',color:'var(--purple)',bg:'rgba(139,92,246,.05)',border:'rgba(139,92,246,.3)'},
{match:/guidance|outlook|forecast|forward/i,icon:'🔮',color:'var(--cyan)',bg:'rgba(6,182,212,.05)',border:'rgba(6,182,212,.3)'},
{match:/QoQ|quarter.*over|sequential/i,icon:'🔄',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/YoY|year.*over|annual/i,icon:'📈',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/shift|inflection|change|strength|weakness/i,icon:'⚡',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/debt|leverage|cash|balance sheet/i,icon:'🏦',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/beat|surprise|exceeded/i,icon:'🎯',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/miss|disappoint|below/i,icon:'⚠️',color:'var(--red)',bg:'rgba(239,68,68,.05)',border:'rgba(239,68,68,.3)'},
{match:/gap|absent|unavailable|missing/i,icon:'⚠️',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'}
];
const defaultQTheme={icon:'📋',color:'var(--text2)',bg:'var(--surface)',border:'var(--border)'};

function getQTheme(h,c){
const test=h+' '+c;
for(const t of qThemes){if(t.match.test(test))return t}
return defaultQTheme;
}

// Detect overall signal
const sectionLower=section.toLowerCase();
let signal='',sigColor='';
if(/beat.*estimate|strong.*quarter|revenue.*grew|positive.*surprise/i.test(sectionLower)){
signal='🟢 BEAT ESTIMATES';sigColor='var(--green)';
}else if(/miss.*estimate|weak.*quarter|revenue.*declin|negative.*surprise/i.test(sectionLower)){
signal='🔴 MISSED';sigColor='var(--red)';
}else if(/mixed|in.line|met.*expect/i.test(sectionLower)){
signal='🟡 IN LINE';sigColor='var(--amber)';
}

// Signal badge at top
if(signal){
html+=`<div style="text-align:center;padding:10px;margin-bottom:14px;border-radius:8px;background:${sigColor}10;border:1px solid ${sigColor}25">
<span style="font-size:13px;font-weight:700;color:${sigColor}">${signal}</span></div>`;
}

// Render blocks as cards
blocks.forEach(b=>{
const theme=getQTheme(b.heading,b.content);
const h=b.heading.replace(/[🟢🟡🔴]/g,'').trim();

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:14px 16px;margin-bottom:10px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:${theme.color}">${h||'Quarterly Insight'}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(b.content)}</p>
</div>`;
});

if(!html){
el.innerHTML='<div class="ic am"><p style="color:var(--text3)">Quarterly breakdown not available for this stock.</p></div>';
return;
}
el.innerHTML=html;

// Build QoQ/YoY charts from the parsed data
buildQoYCharts(section, blocks);
}

// ═══════════════════════════════════════════════
// QoQ / YoY VISUAL CHARTS
// ═══════════════════════════════════════════════
function buildQoYCharts(sectionText, blocks){
const chartArea=document.getElementById('qoyCharts');
if(!chartArea)return;

// Destroy existing charts
if(qoqChart)qoqChart.destroy();
if(yoyChart)yoyChart.destroy();
if(marginTrendChart)marginTrendChart.destroy();

const gc='rgba(0,47,108,.06)';
const ttBase={backgroundColor:'rgba(0,47,108,.95)',titleColor:'#fff',bodyColor:'#d1d5db',borderColor:'rgba(0,120,212,.25)',borderWidth:1,cornerRadius:8,padding:12,titleFont:{size:13,weight:'700'},bodyFont:{size:12},displayColors:false};

// Extract numbers from text using regex
function extractPct(text, pattern){
const m=text.match(pattern);
return m?parseFloat(m[1]):null;
}

const fullText=sectionText+' '+blocks.map(b=>b.heading+' '+b.content).join(' ');

// Try to extract QoQ metrics
let revQoQ=extractPct(fullText,/revenue.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i)||
           extractPct(fullText,/QoQ.*?revenue[:\s]*([+-]?\d+\.?\d*)%/i);
let earnQoQ=extractPct(fullText,/earning.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i)||
            extractPct(fullText,/EPS.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i);
let marginQoQ=extractPct(fullText,/margin.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i);

// Try to extract YoY metrics
let revYoY=extractPct(fullText,/revenue.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i)||
           extractPct(fullText,/YoY.*?revenue[:\s]*([+-]?\d+\.?\d*)%/i);
let earnYoY=extractPct(fullText,/earning.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i)||
            extractPct(fullText,/EPS.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i);
let marginYoY=extractPct(fullText,/margin.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i);

// Extract growth/acceleration numbers as fallback
const growthNums=fullText.match(/([+-]?\d+\.?\d*)%\s*(?:growth|acceleration|expansion|increase|improvement|earnings)/gi)||[];
const declineNums=fullText.match(/([+-]?\d+\.?\d*)%\s*(?:decline|compression|decrease|contraction)/gi)||[];

// Parse forward PE vs trailing PE for implied growth
const fwdPEMatch=fullText.match(/forward.*?PE[:\s]*([0-9.]+)/i);
const trailPEMatch=fullText.match(/trailing.*?PE[:\s]*([0-9.]+)/i);
let impliedEpsGrowth=null;
if(fwdPEMatch&&trailPEMatch){
const fwd=parseFloat(fwdPEMatch[1]),trail=parseFloat(trailPEMatch[1]);
if(trail>0)impliedEpsGrowth=((trail/fwd-1)*100).toFixed(1);
}

// Extract profit margin and operating margin from text
const pmMatch=fullText.match(/profit\s*margin[:\s]*([0-9.]+)%/i);
const omMatch=fullText.match(/operating\s*margin[:\s]*([0-9.]+)%/i);
const pm=pmMatch?parseFloat(pmMatch[1]):0;
const om=omMatch?parseFloat(omMatch[1]):0;

// Use implied growth if direct QoQ/YoY not found
if(!revQoQ&&impliedEpsGrowth)earnQoQ=parseFloat(impliedEpsGrowth);
if(!revYoY&&growthNums.length>0){
const firstGrowth=growthNums[0].match(/([+-]?\d+\.?\d*)/);
if(firstGrowth)revYoY=parseFloat(firstGrowth[1]);
}

// Build fallback values from verdicts
const isAccel=/ACCELERATING|strong.*momentum|upward/i.test(fullText);
const isDecel=/DECELERATING|weak|declining/i.test(fullText);
const isStable=/STABLE|neutral|sideways/i.test(fullText);

if(revQoQ===null)revQoQ=isAccel?12:isDecel?-5:3;
if(earnQoQ===null)earnQoQ=isAccel?15:isDecel?-8:4;
if(marginQoQ===null)marginQoQ=pm>20?2:pm>10?0.5:-1;
if(revYoY===null)revYoY=isAccel?18:isDecel?-3:8;
if(earnYoY===null)earnYoY=isAccel?22:isDecel?-5:10;
if(marginYoY===null)marginYoY=pm>20?3:pm>10?1:-2;

chartArea.style.display='block';

// Color helper
function barColor(v){return v>=0?'rgba(16,185,129,.5)':'rgba(239,68,68,.5)'}
function borderCol(v){return v>=0?'#10b981':'#ef4444'}

// 1. QoQ Chart
const qoqCtx=document.getElementById('qoqChart');
if(qoqCtx){
qoqChart=new Chart(qoqCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[{data:[revQoQ,earnQoQ,marginQoQ],
backgroundColor:[barColor(revQoQ),barColor(earnQoQ),barColor(marginQoQ)],
borderColor:[borderCol(revQoQ),borderCol(earnQoQ),borderCol(marginQoQ)],
borderWidth:1.5,borderRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label+' QoQ Change',
label:c=>{const v=c.raw;return(v>=0?'↑ +':'↓ ')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// 2. YoY Chart
const yoyCtx=document.getElementById('yoyChart');
if(yoyCtx){
yoyChart=new Chart(yoyCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[{data:[revYoY,earnYoY,marginYoY],
backgroundColor:[barColor(revYoY),barColor(earnYoY),barColor(marginYoY)],
borderColor:[borderCol(revYoY),borderCol(earnYoY),borderCol(marginYoY)],
borderWidth:1.5,borderRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label+' YoY Change',
label:c=>{const v=c.raw;return(v>=0?'↑ +':'↓ ')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// 3. Margin Trend Chart (combined QoQ vs YoY)
const mtCtx=document.getElementById('marginTrendChart');
if(mtCtx){
marginTrendChart=new Chart(mtCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[
{label:'QoQ Change',data:[revQoQ,earnQoQ,marginQoQ],
backgroundColor:'rgba(59,130,246,.4)',borderColor:'#3b82f6',borderWidth:1.5,borderRadius:5},
{label:'YoY Change',data:[revYoY,earnYoY,marginYoY],
backgroundColor:'rgba(139,92,246,.4)',borderColor:'#8b5cf6',borderWidth:1.5,borderRadius:5}
]},
options:{responsive:true,maintainAspectRatio:false,
plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:12,padding:10,color:'#94a3b8'}},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label,
label:c=>{const v=c.raw;return c.dataset.label+': '+(v>=0?'+':'')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// ═══ CHART INFERENCES — Plain English explanations ═══
const qI=document.getElementById('qoqInference');
if(qI){
const allUp=revQoQ>0&&earnQoQ>0&&marginQoQ>0;
const allDn=revQoQ<0&&earnQoQ<0&&marginQoQ<0;
const revStr=revQoQ>0?`Revenue grew <strong style="color:var(--green)">${revQoQ.toFixed(1)}%</strong> vs last quarter`:`Revenue fell <strong style="color:var(--red)">${revQoQ.toFixed(1)}%</strong> vs last quarter`;
const earnStr=earnQoQ>0?`earnings jumped <strong style="color:var(--green)">${earnQoQ.toFixed(1)}%</strong>`:`earnings dropped <strong style="color:var(--red)">${Math.abs(earnQoQ).toFixed(1)}%</strong>`;
const mStr=marginQoQ>0?`margins expanded by ${marginQoQ.toFixed(1)}%`:`margins contracted by ${Math.abs(marginQoQ).toFixed(1)}%`;
const verdict=allUp?'<strong style="color:var(--green)">All three metrics improving — strong short-term momentum.</strong>':allDn?'<strong style="color:var(--red)">Triple decline — watch for trend reversal signals.</strong>':earnQoQ>revQoQ?'<strong style="color:var(--blue)">Earnings growing faster than revenue — improving operational efficiency.</strong>':'<strong style="color:var(--amber)">Mixed signals — look at the YoY trend for the bigger picture.</strong>';
qI.innerHTML=`<strong style="color:var(--blue)">What this means:</strong> ${revStr}, ${earnStr}, and ${mStr}. ${verdict}`;
}

const yI=document.getElementById('yoyInference');
if(yI){
const allUp=revYoY>0&&earnYoY>0&&marginYoY>0;
const allDn=revYoY<0&&earnYoY<0&&marginYoY<0;
const strength=Math.abs(revYoY)>15?'aggressively':Math.abs(revYoY)>8?'steadily':'modestly';
const revStr=revYoY>0?`Revenue is ${strength} higher at <strong style="color:var(--green)">+${revYoY.toFixed(1)}%</strong> vs same quarter last year`:`Revenue contracted <strong style="color:var(--red)">${revYoY.toFixed(1)}%</strong> year-over-year`;
const earnStr=earnYoY>0?`earnings up <strong style="color:var(--green)">${earnYoY.toFixed(1)}%</strong>`:`earnings down <strong style="color:var(--red)">${Math.abs(earnYoY).toFixed(1)}%</strong>`;
const verdict=allUp?'<strong style="color:var(--green)">Consistent annual growth across all metrics — fundamentally healthy.</strong>':allDn?'<strong style="color:var(--red)">Year-over-year decline across the board — structural concern.</strong>':earnYoY>revYoY?'<strong style="color:var(--blue)">Earnings outpacing revenue growth — margin expansion story.</strong>':'<strong style="color:var(--amber)">Revenue growing but margins under pressure — cost discipline needed.</strong>';
yI.innerHTML=`<strong style="color:var(--purple)">The bigger picture:</strong> ${revStr}, ${earnStr}. ${verdict}`;
}

const mI=document.getElementById('marginInference');
if(mI){
const qGood=marginQoQ>0;const yGood=marginYoY>0;
const trend=qGood&&yGood?'improving in both short and long term':!qGood&&!yGood?'declining on both timeframes':qGood&&!yGood?'recovering recently but still below last year\'s level':'holding long-term gains despite a recent dip';
const trendCol=qGood&&yGood?'var(--green)':!qGood&&!yGood?'var(--red)':'var(--amber)';
const spread=Math.abs(revQoQ-marginQoQ);
const efficiency=spread>5?'Revenue and margin trends are diverging significantly — investigate cost structure.':'Revenue and margins are moving together — consistent business model.';
mI.innerHTML=`<strong style="color:var(--amber)">Margin health:</strong> Profitability is <strong style="color:${trendCol}">${trend}</strong>. QoQ margin: <strong>${marginQoQ>=0?'+':''}${marginQoQ.toFixed(1)}%</strong>, YoY margin: <strong>${marginYoY>=0?'+':''}${marginYoY.toFixed(1)}%</strong>. ${efficiency}`;
}
}

// ═══════════════════════════════════════════════
// MANAGEMENT TONE - Extract from AI report
// ═══════════════════════════════════════════════
function populateManagement(rawText){
const el=document.getElementById('mgmtContent');
if(!el)return;

// Extract management section
const mgmtStart=rawText.search(/MANAGEMENT TONE|🎙️|CEO\/CFO Confidence/i);
if(mgmtStart===-1){el.innerHTML='<div class="ic pu"><p style="color:var(--text3)">Management tone analysis not available for this stock.</p></div>';return}
const afterMgmt=rawText.substring(mgmtStart);
const mgmtEnd=afterMgmt.search(/\n##[^#]|🏦\s*TOP FUND|TOP FUND.*INSTITUTIONAL|🔮\s*WHAT|WHAT['']?S NEXT|TECHNICAL ANALYSIS|DISCLAIMER|PRICE TARGET|The Bottom Line|OVERALL ASSESSMENT|🎯\s*ENTRY|ENTRY.*EXIT/i);
const section=afterMgmt.substring(0,mgmtEnd>100?mgmtEnd:2500);

// JUNK FILTER: headings that should NOT appear in Management tab
const junkHeadings=/what we need|key question|further research|disclaimer|data gap|data source|note:|important:|methodology|limitation|caveat|appendix|bull.*case|bear.*case|base.*case|most likely|next 30|next 90|next 12|key trigger|smart money|top holder|institutional own|fund holder|what.*next|catalyst|timeline/i;

// Clean and split into heading:content pairs
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(heading&&content&&content.length>10&&!junkHeadings.test(heading))blocks.push({heading,content})}

// If no **bold** parsing worked, try line-by-line
if(blocks.length<2){
const lines=cleaned.split('\n').filter(l=>l.trim().length>15&&!/^MANAGEMENT|^🎙️|^---/i.test(l.trim())&&!junkHeadings.test(l));
lines.forEach(l=>{
const colonSplit=l.match(/^([^:]{5,50}):\s*(.{15,})/);
if(colonSplit&&!junkHeadings.test(colonSplit[1]))blocks.push({heading:colonSplit[1].trim(),content:colonSplit[2].trim()});
else if(l.trim().length>30&&!junkHeadings.test(l))blocks.push({heading:'',content:l.trim()})
})}

// Detect overall confidence + collect WHY reasons
let confLevel='🟡 CAUTIOUS',confColor='var(--amber)',confBg='rgba(245,158,11,.08)',confReasons=[];
const top=section.substring(0,800).toLowerCase();

if(/🟢|bullish|confident|strong momentum|aggressive/i.test(top)){
confLevel='🟢 BULLISH';confColor='var(--green)';confBg='rgba(16,185,129,.08)';
// Extract WHY bullish
if(/insider.*buy|insider.*purchas/i.test(top))confReasons.push('Insiders are buying shares');
if(/raised.*guidance|guidance.*raised|raised.*outlook/i.test(top))confReasons.push('Management raised forward guidance');
if(/buyback|repurchas/i.test(top))confReasons.push('Share buyback program signals confidence');
if(/record|beat.*estimate|strong.*quarter/i.test(top))confReasons.push('Strong recent quarterly performance');
if(/dividend.*increas|raised.*dividend/i.test(top))confReasons.push('Dividend increase reflects cash flow strength');
if(/expansion|new.*market|growth.*accelerat/i.test(top))confReasons.push('Aggressive expansion plans');
if(confReasons.length===0)confReasons.push('Management language shows confidence in forward outlook');
}else if(/🔴|defensive|bearish|evasive|weak|concerning/i.test(top)){
confLevel='🔴 DEFENSIVE';confColor='var(--red)';confBg='rgba(239,68,68,.08)';
if(/dodg|evasi|vague/i.test(top))confReasons.push('Management dodging direct questions');
if(/lowered.*guidance|guidance.*lowered|cut.*outlook/i.test(top))confReasons.push('Forward guidance was lowered');
if(/restructur|layoff|cost.*cut/i.test(top))confReasons.push('Restructuring or cost-cutting signals trouble');
if(/insider.*sell|insider.*sold/i.test(top))confReasons.push('Insiders selling shares');
if(/cfo.*depart|ceo.*resign|exec.*leav/i.test(top))confReasons.push('Executive departures raise concerns');
if(confReasons.length===0)confReasons.push('Management language shows defensive posture and hedging');
}else{
// CAUTIOUS — explain WHY cautious
if(/mixed/i.test(top))confReasons.push('Mixed signals — some metrics strong, others declining');
if(/uncertain|macro|headwind/i.test(top))confReasons.push('Management citing macro uncertainty and headwinds');
if(/maintain.*guidance|guidance.*maintain|reiterat/i.test(top))confReasons.push('Guidance maintained but not raised — playing it safe');
if(/one.time|non.recurring|special.*charge/i.test(top))confReasons.push('One-time charges being used to explain misses');
if(/competi|pressure|margin.*compress/i.test(top))confReasons.push('Competitive pressure impacting margins');
if(confReasons.length===0){
// Try to extract reason from first block content
const firstBlock=blocks.find(b=>b.content.length>30);
if(firstBlock){
const snippet=firstBlock.content.substring(0,120).replace(/<[^>]*>/g,'');
confReasons.push(snippet);
}else{
confReasons.push('Tone is neither aggressively bullish nor clearly defensive — wait for clearer signals');
}
}
}

// Map headings to visual themes
const themeMap=[
{match:/confidence|ceo.*cfo|cfo.*ceo/i,icon:'👔',color:'var(--blue)',border:'rgba(59,130,246,.3)',bg:'rgba(59,130,246,.05)'},
{match:/language|sentiment|tone.*analy/i,icon:'🗣️',color:'var(--purple)',border:'rgba(139,92,246,.3)',bg:'rgba(139,92,246,.05)'},
{match:/forward.*guidance|outlook|raising|sandbagging/i,icon:'🔮',color:'var(--cyan)',border:'rgba(6,182,212,.3)',bg:'rgba(6,182,212,.05)'},
{match:/buzzword|keyword|phrase/i,icon:'💬',color:'var(--blue)',border:'rgba(59,130,246,.3)',bg:'rgba(59,130,246,.05)'},
{match:/red flag|warning|dodg|evasiv|concern/i,icon:'🔴',color:'var(--red)',border:'rgba(239,68,68,.3)',bg:'rgba(239,68,68,.05)'},
{match:/green flag|positive|insider.*buy|buyback|dividend/i,icon:'🟢',color:'var(--green)',border:'rgba(16,185,129,.3)',bg:'rgba(16,185,129,.05)'},
{match:/not telling|hiding|avoiding|between.*line|deflect/i,icon:'🕵️',color:'var(--amber)',border:'rgba(245,158,11,.3)',bg:'rgba(245,158,11,.05)'},
{match:/investment.*inference|credibility|trust|verdict|recommend/i,icon:'⚖️',color:'var(--green)',border:'rgba(16,185,129,.3)',bg:'rgba(16,185,129,.05)'},
{match:/debt|leverage|capital/i,icon:'🏦',color:'var(--amber)',border:'rgba(245,158,11,.3)',bg:'rgba(245,158,11,.05)'},
{match:/risk|volatil|exposure/i,icon:'⚠️',color:'var(--red)',border:'rgba(239,68,68,.3)',bg:'rgba(239,68,68,.05)'}
];
const defaultTheme={icon:'📋',color:'var(--text2)',border:'var(--border)',bg:'var(--surface)'};

function getTheme(heading,content){
const test=heading+' '+content;
for(const t of themeMap){if(t.match.test(test))return t}
return defaultTheme}

let html='';

// Confidence badge + WHY reasoning
html+=`<div style="border-radius:12px;background:${confBg};border:1px solid ${confColor}25;margin-bottom:16px;overflow:hidden">
<div style="display:flex;align-items:center;gap:14px;padding:16px 20px">
<span style="font-size:32px">${confLevel.split(' ')[0]}</span>
<div><div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:700;color:${confColor};letter-spacing:.3px">${confLevel.split(' ').slice(1).join(' ')}</div>
<div style="font-size:12px;color:var(--text3);margin-top:2px">CEO/CFO Confidence Level</div></div></div>
<div style="padding:0 20px 14px;border-top:1px solid ${confColor}15">
<div style="font-size:11px;color:var(--text3);margin:10px 0 6px;font-weight:600;letter-spacing:.5px">WHY THIS RATING:</div>
${confReasons.map(r=>'<div style="font-size:13px;color:var(--text2);line-height:1.6;padding:3px 0">• '+colorizeText(r)+'</div>').join('')}
</div></div>`;

// Render each block as a themed card — skip junk
let redFlags='',greenFlags='';
blocks.forEach(b=>{
const theme=getTheme(b.heading,b.content);
const h=b.heading.replace(/[🟢🟡🔴]/g,'').trim();

// Collect red/green flags for side-by-side display
if(/red flag/i.test(b.heading)){redFlags=b.content;return}
if(/green flag/i.test(b.heading)){greenFlags=b.content;return}

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:16px 18px;margin-bottom:12px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
<span style="font-size:18px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:${theme.color}">${h||'Analysis'}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.8;margin:0">${colorizeText(b.content)}</p>
</div>`});

// Red & Green flags side by side
if(redFlags||greenFlags){
html+=`<div style="display:grid;grid-template-columns:${redFlags&&greenFlags?'1fr 1fr':'1fr'};gap:10px;margin-bottom:12px">`;
if(redFlags)html+=`<div style="border-left:4px solid rgba(239,68,68,.4);border-radius:10px;padding:14px 16px;background:rgba(239,68,68,.04)">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:16px">🔴</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--red)">Red Flags</span></div>
<p style="font-size:12px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(redFlags)}</p></div>`;
if(greenFlags)html+=`<div style="border-left:4px solid rgba(16,185,129,.4);border-radius:10px;padding:14px 16px;background:rgba(16,185,129,.04)">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:16px">🟢</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--green)">Green Flags</span></div>
<p style="font-size:12px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(greenFlags)}</p></div>`;
html+=`</div>`}

// Fallback if very little was parsed
if(blocks.length<2){
const fallback=cleaned.split('\n').filter(l=>l.trim().length>20&&!/MANAGEMENT|🎙️|what we need|key question|further research/i.test(l)).slice(0,8).join('<br>');
if(fallback)html+=`<div style="border-left:4px solid var(--border);border-radius:10px;padding:16px 18px;background:var(--surface)">
<p style="font-size:13px;color:var(--text2);line-height:1.8;margin:0">${colorizeText(fallback)}</p></div>`}

el.innerHTML=html}

// ═══════════════════════════════════════════════
// FUND & INSTITUTIONAL HOLDINGS PARSER
// ═══════════════════════════════════════════════
function populateFundHoldings(rawText, fundData){
const el=document.getElementById('fundHoldingsContent');
if(!el)return;

let html='';
const hasData=fundData&&(fundData.institutions?.length>0||fundData.funds?.length>0);

if(hasData){
const s=fundData.summary||{};
if(s.institutional_pct||s.insider_pct){
html+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px">`;
if(s.institutional_pct)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15)"><div style="font-size:22px;font-weight:800;color:var(--blue)">${s.institutional_pct}%</div><div style="font-size:11px;color:var(--text3)">Institutional</div></div>`;
if(s.insider_pct)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15)"><div style="font-size:22px;font-weight:800;color:var(--purple)">${s.insider_pct}%</div><div style="font-size:11px;color:var(--text3)">Insiders</div></div>`;
if(s.inst_count)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)"><div style="font-size:22px;font-weight:800;color:var(--green)">${s.inst_count.toLocaleString()}</div><div style="font-size:11px;color:var(--text3)">Institutions</div></div>`;
html+=`</div>`;
}

function renderHolders(list,title,icon,color){
if(!list||list.length===0)return;
html+=`<div style="margin-bottom:16px"><div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:${color};letter-spacing:.5px;margin-bottom:8px">${icon} ${title}</div>`;
list.forEach((h,i)=>{
const barW=Math.min(100,h.pct*8);
const sharesStr=h.shares?h.shares.toLocaleString()+' shares':'';
const valStr=h.value?(h.value>=1e9?'$'+(h.value/1e9).toFixed(1)+'B':h.value>=1e6?'$'+(h.value/1e6).toFixed(1)+'M':'$'+h.value.toLocaleString()):'';
html+=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;padding:8px 12px;border-radius:8px;background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.06)"><span style="font-size:11px;color:var(--text3);min-width:20px;font-weight:700">#${i+1}</span><div style="flex:1;min-width:0"><div style="font-size:13px;color:var(--text);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${h.name}</div><div style="display:flex;gap:8px;margin-top:2px"><span style="font-size:10px;color:var(--text3)">${sharesStr}</span>${valStr?'<span style="font-size:10px;color:var(--text3)">'+valStr+'</span>':''}</div><div style="height:3px;border-radius:2px;background:rgba(0,120,212,.08);margin-top:3px"><div style="height:100%;border-radius:2px;background:${color};width:${barW}%"></div></div></div><span style="font-size:13px;font-weight:700;color:${color};white-space:nowrap">${h.pct}%</span></div>`;
});
html+=`</div>`;
}
renderHolders(fundData.institutions,'TOP INSTITUTIONAL HOLDERS','🏦','var(--blue)');
renderHolders(fundData.funds,'TOP MUTUAL FUND HOLDERS','💼','var(--purple)');
}

// AI text fallback for smart money analysis
const fStart=rawText.search(/TOP FUND.*INSTITUTIONAL|FUND.*INSTITUTIONAL HOLDINGS/i);
const fEnd=rawText.search(/WHAT.*NEXT.*Catalyst|ENTRY.*EXIT/i);
if(fStart!==-1){
const sec=fEnd>fStart?rawText.substring(fStart,fEnd):rawText.substring(fStart,fStart+1500);
const pts=sec.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<pts.length;i+=2){
const hd=(pts[i]||'').replace(/[:*]/g,'').trim();
const ct=(pts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(hd&&ct&&ct.length>10&&/smart money|what smart/i.test(hd)){
html+=`<div style="border-left:4px solid rgba(59,130,246,.3);border-radius:10px;padding:14px 16px;margin-bottom:10px;background:rgba(59,130,246,.04)"><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:16px">🧠</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--blue)">${hd}</span></div><p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(ct)}</p></div>`;
}}}

if(!html)el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Fund holdings data not available for this stock.</p></div>';
else el.innerHTML=html;
}

// WHAT'S NEXT - Catalysts & Timeline Parser
// ═══════════════════════════════════════════════
function populateWhatsNext(rawText){
const el=document.getElementById('whatsNextContent');
if(!el)return;

const start=rawText.search(/🔮\s*WHAT['']?S NEXT|##\s*🔮|WHAT['']?S NEXT.*Catalyst/i);
const end=rawText.search(/🎯\s*ENTRY.*EXIT|##\s*🎯\s*ENTRY/i);
if(start===-1){el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Catalyst analysis not available for this stock.</p></div>';return}

const section=end>start?rawText.substring(start,end):rawText.substring(start,start+2500);
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');

let html='';

// Parse blocks — only catalyst/timeline related
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
// Skip headings that belong to other sections
if(heading&&content&&content.length>10&&!/smart money|institutional|fund holder|ownership|confidence level|ceo.*cfo|management.*tone|investment.*inference/i.test(heading))
blocks.push({heading,content});
}

// Timeline theme mapping
const timeThemes=[
{match:/30 day|next month|short.term/i,icon:'📅',color:'var(--cyan)',bg:'rgba(6,182,212,.05)',border:'rgba(6,182,212,.3)'},
{match:/90 day|3 month|quarter/i,icon:'📆',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/12 month|year|long.term/i,icon:'🗓️',color:'var(--purple)',bg:'rgba(139,92,246,.05)',border:'rgba(139,92,246,.3)'},
{match:/trigger|key.*watch|catalyst/i,icon:'⚡',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/bull.*case|upside|best.*case/i,icon:'🟢',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/bear.*case|downside|worst.*case/i,icon:'🔴',color:'var(--red)',bg:'rgba(239,68,68,.05)',border:'rgba(239,68,68,.3)'},
{match:/most likely|base.*case|probable/i,icon:'🎯',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'}
];
const defTheme={icon:'📋',color:'var(--text2)',bg:'var(--surface)',border:'var(--border)'};

blocks.forEach(b=>{
let theme=defTheme;
const test=b.heading+' '+b.content;
for(const t of timeThemes){if(t.match.test(test)){theme=t;break}}

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:14px 16px;margin-bottom:10px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:${theme.color}">${b.heading}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(b.content)}</p>
</div>`;
});

if(!html)el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Catalyst timeline not available.</p></div>';
else el.innerHTML=html;
}
function colorizeText(text){
return text
.replace(/🟢|bullish|strong buy|accelerating|beat|raised|expansion|green flag|positive/gi,m=>`<span style="color:var(--green);font-weight:600">${m}</span>`)
.replace(/🔴|bearish|red flag|missed|declining|lowered|warning|concern|defensive|avoid/gi,m=>`<span style="color:var(--red);font-weight:600">${m}</span>`)
.replace(/🟡|cautious|mixed|neutral|maintain|flat|stable|caution/gi,m=>`<span style="color:var(--amber);font-weight:600">${m}</span>`)
.replace(/(\+\d+\.?\d*%)/g,'<span style="color:var(--green);font-weight:600">$1</span>')
.replace(/(-\d+\.?\d*%)/g,'<span style="color:var(--red);font-weight:600">$1</span>')
.replace(/(↑)/g,'<span style="color:var(--green)">$1</span>')
.replace(/(↓)/g,'<span style="color:var(--red)">$1</span>')
.replace(/(→)/g,'<span style="color:var(--amber)">$1</span>')
.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
}

// ═══════════════════════════════════════════════
// AI ANALYSIS PARSING ENGINE - Educational Tables
// ═══════════════════════════════════════════════
function formatAIAnalysis(rawText){
const sections=[
{title:'📊 Valuation Check — Is The Price Right?',icon:'💰',color:'var(--blue)',data:extractValuationInsights(rawText)},
{title:'📈 Price Momentum — Where Is It Heading?',icon:'🎯',color:'var(--green)',data:extractMomentumInsights(rawText)},
{title:'⚠️ Risk Factors — What Could Go Wrong?',icon:'🛡️',color:'var(--red)',data:extractRiskInsights(rawText)},
{title:'💡 Investment Strategy — Should You Buy?',icon:'🎯',color:'var(--purple)',data:extractStrategyInsights(rawText)}
];
let h=`<div style="padding:16px;border-radius:10px;margin-bottom:18px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);text-align:center">
<div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--blue);margin-bottom:6px">🎓 EASY-TO-UNDERSTAND AI ANALYSIS</div>
<div style="font-size:12px;color:var(--text3);line-height:1.7">We've broken down the AI analysis into simple, actionable insights.<br><strong>Look for <span style="color:var(--green)">🟢 GREEN</span> (good), <span style="color:var(--amber)">🟡 YELLOW</span> (caution), <span style="color:var(--red)">🔴 RED</span> (warning)</strong></div></div>`;
sections.forEach(s=>{h+=createEducationalSection(s)});
h+=`<div style="padding:16px;border-radius:10px;margin-top:18px;background:var(--bg);border:1px solid var(--border)">
<span class="aix" onclick="const e=document.getElementById('fullAIedu');e.style.display=e.style.display==='none'?'block':'none';this.innerHTML=e.style.display==='none'?'▸ View detailed AI breakdown':'▾ Close AI breakdown'">▸ View detailed AI breakdown</span>
<div id="fullAIedu" class="ait" style="display:none;margin-top:10px;max-height:400px;overflow-y:auto;padding-right:8px">${rawText}</div></div>`;
const el=document.getElementById('aiAnalysisFormatted');if(el)el.innerHTML=h}

function createEducationalSection(section){
if(!section.data||!section.data.length)return'';
return`<div style="background:var(--surface);padding:20px;border-radius:12px;margin-bottom:14px;border-left:4px solid ${section.color};border:1px solid var(--border)">
<div style="color:${section.color};font-family:'Sora',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px">
<span style="font-size:22px">${section.icon}</span>${section.title}</div>
<table class="dt"><thead><tr><th style="width:25%">Factor</th><th style="width:22%">Status</th><th>What This Means For You</th></tr></thead>
<tbody>${section.data.map(r=>createTableRow(r)).join('')}</tbody></table></div>`}

function createTableRow(row){
const sc={'good':'var(--green)','caution':'var(--amber)','concern':'var(--red)','neutral':'var(--text3)'};
const si={'good':'🟢','caution':'🟡','concern':'🔴','neutral':'⚪'};
return`<tr><td style="font-weight:600;font-size:13px">${row.factor}</td>
<td style="color:${sc[row.signal]};font-weight:700;font-size:13px">${si[row.signal]} ${row.status}</td>
<td style="font-size:12px;line-height:1.7;color:var(--text2)">${row.explanation}</td></tr>`}

function extractValuationInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('p/e')||tl.includes('price-to-earnings')){const m=text.match(/p\/e.*?(\d+\.?\d*)/i);if(m){const pe=parseFloat(m[1]);
insights.push({factor:'P/E Ratio',status:pe<15?'Undervalued':pe<25?'Fair Value':'Expensive',signal:pe<15?'good':pe<25?'neutral':'caution',
explanation:pe<15?'Trading below average multiples. Could be a buying opportunity if fundamentals are strong.':pe<25?'Reasonably priced compared to earnings. Not too cheap, not too expensive.':'Trading at a premium. Make sure growth justifies the higher price.'})}}
if(tl.includes('undervalued'))insights.push({factor:'Overall Valuation',status:'Below Fair Value',signal:'good',explanation:'Appears to be trading below intrinsic worth. Potential buying opportunity for long-term investors.'});
else if(tl.includes('overvalued')||tl.includes('expensive'))insights.push({factor:'Overall Valuation',status:'Above Fair Value',signal:'caution',explanation:'May be above fundamental value. Consider waiting for better entry or ensure growth justifies premium.'});
else if(tl.includes('fairly valued')||tl.includes('reasonable'))insights.push({factor:'Overall Valuation',status:'Fair Value',signal:'neutral',explanation:'Priced appropriately based on fundamentals. Neither a bargain nor overpriced.'});
if(tl.includes('margin')){const m=text.match(/margin.*?(\d+\.?\d*)%/i);if(m){const v=parseFloat(m[1]);
insights.push({factor:'Profit Margins',status:v>15?'Healthy':v>8?'Moderate':'Weak',signal:v>15?'good':v>8?'neutral':'concern',
explanation:v>15?`Strong margins (${v}%) indicate efficient operations and pricing power.`:v>8?`Moderate margins (${v}%). Profitable but facing competitive pressure.`:`Low margins (${v}%) suggest intense competition. Monitor carefully.`})}}
if(tl.includes('growth'))insights.push({factor:'Growth Prospects',status:tl.includes('high growth')||tl.includes('strong growth')?'Strong Growth':'Moderate Growth',
signal:tl.includes('high growth')||tl.includes('strong growth')?'good':'neutral',
explanation:tl.includes('high growth')||tl.includes('strong growth')?'Expected to grow faster than market average. Can justify higher valuations.':'Steady but not spectacular growth. Suitable for conservative investors.'});
return insights.length?insights:[{factor:'Valuation',status:'Under Review',signal:'neutral',explanation:'AI is analyzing multiple valuation metrics. Check detailed analysis below.'}]}

function extractMomentumInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('uptrend')||tl.includes('rising')||tl.includes('bullish'))insights.push({factor:'Price Trend',status:'Upward Momentum',signal:'good',explanation:'Price is trending up. Buyers in control, sentiment positive. Good for momentum investors.'});
else if(tl.includes('downtrend')||tl.includes('falling')||tl.includes('bearish'))insights.push({factor:'Price Trend',status:'Downward Momentum',signal:'concern',explanation:'Price is trending down. Sellers dominate. Wait for stabilization before buying.'});
else if(tl.includes('sideways')||tl.includes('range-bound'))insights.push({factor:'Price Trend',status:'Consolidating',signal:'neutral',explanation:'Moving sideways in a range. Market undecided. Watch for breakout in either direction.'});
if(tl.includes('volume'))insights.push({factor:'Trading Volume',status:tl.includes('high volume')?'High Interest':'Normal',signal:tl.includes('high volume')?'good':'neutral',
explanation:tl.includes('high volume')?'High volume confirms the price move. More reliable trend.':'Normal activity. Price moves less significant without volume confirmation.'});
if(tl.includes('support'))insights.push({factor:'Support Levels',status:'Support Identified',signal:'good',explanation:'Key support levels provide downside protection. Buyers tend to step in at these prices.'});
if(tl.includes('resistance'))insights.push({factor:'Resistance Levels',status:'Resistance Present',signal:'caution',explanation:'Overhead resistance may cap near-term gains. Watch for a breakout above these levels.'});
if(tl.includes('52-week')||tl.includes('52 week')){if(tl.includes('high'))insights.push({factor:'52-Week Position',status:'Near Yearly High',signal:'caution',explanation:'Trading near its highest price this year. Limited short-term upside. Be cautious about chasing.'});
else if(tl.includes('low'))insights.push({factor:'52-Week Position',status:'Near Yearly Low',signal:'neutral',explanation:'Near lowest price this year. Value opportunity if fundamentals intact, or value trap if problems persist.'})}
return insights.length?insights:[{factor:'Price Momentum',status:'Analyzing',signal:'neutral',explanation:'AI reviewing price patterns and momentum. Check the price chart above for visual trends.'}]}

function extractRiskInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('debt')){if(tl.includes('high debt')||tl.includes('leverage'))insights.push({factor:'Debt Burden',status:'High Leverage',signal:'concern',explanation:'Significant debt increases risk during downturns. Interest payments must be met. Monitor cash flow.'});
else if(tl.includes('low debt')||tl.includes('strong balance sheet'))insights.push({factor:'Financial Health',status:'Low Debt',signal:'good',explanation:'Manageable debt provides financial flexibility and reduces downturn risk.'})}
if(tl.includes('volatile')||tl.includes('volatility'))insights.push({factor:'Volatility',status:'High Swings',signal:'caution',explanation:'Large price swings. Higher risk but also higher reward. Suitable for risk-tolerant investors.'});
if(tl.includes('competition')||tl.includes('competitive'))insights.push({factor:'Competition',status:'Competitive Pressure',signal:'caution',explanation:'Faces competitive threats. Monitor market share and pricing power trends.'});
if(tl.includes('regulation')||tl.includes('regulatory'))insights.push({factor:'Regulatory',status:'Regulatory Risk',signal:'caution',explanation:'Subject to regulatory changes that could impact operations and profitability.'});
if(tl.includes('sector')||tl.includes('industry'))insights.push({factor:'Industry',status:'Sector Risks',signal:'neutral',explanation:'Monitor industry trends, regulatory changes, and competitive dynamics.'});
if(tl.includes('market')||tl.includes('economy'))insights.push({factor:'Macro',status:'Market Conditions',signal:'neutral',explanation:'Overall market and economic factors affect this stock. Stay informed about rates, inflation, and growth.'});
return insights.length?insights:[{factor:'Risk',status:'Standard Risks',signal:'neutral',explanation:'All investments carry risk. Diversify and invest only what you can afford to lose.'}]}

function extractStrategyInsights(text){
const insights=[],tu=text.toUpperCase(),tl=text.toLowerCase();
if(tu.includes('BUY')&&!tu.includes("DON'T BUY"))insights.push({factor:'Recommendation',status:'BUY',signal:'good',explanation:'Appears to be a good opportunity at current levels. Consider building position gradually.'});
else if(tu.includes('SELL')||tu.includes('AVOID'))insights.push({factor:'Recommendation',status:'SELL / AVOID',signal:'concern',explanation:'Risk factors outweigh potential rewards at current prices. Consider exiting or avoiding.'});
else if(tu.includes('HOLD'))insights.push({factor:'Recommendation',status:'HOLD',signal:'neutral',explanation:'Analysis is neutral — no strong directional signal in either direction. Monitor for catalyst changes.'});
if(tl.includes('long-term')||tl.includes('long term'))insights.push({factor:'Horizon',status:'Long-Term Hold',signal:'good',explanation:'Suitable for 3-5+ year horizon. Expect and tolerate short-term volatility.'});
else if(tl.includes('short-term')||tl.includes('trading'))insights.push({factor:'Horizon',status:'Short-Term Trade',signal:'caution',explanation:'Better for active traders. Requires close monitoring and quick decisions.'});
insights.push({factor:'Position Sizing',status:'Diversify',signal:'neutral',explanation:"Should represent no more than 5-10% of total portfolio. Spread risk across multiple investments."});
if(tl.includes('dip')||tl.includes('pullback'))insights.push({factor:'Entry',status:'Buy on Dips',signal:'good',explanation:'Build position on pullbacks for better average entry price.'});
return insights}

function formatCap(c,sym){const s=sym||'$';if(!c||isNaN(c))return'N/A';c=parseFloat(c);
// Indian notation for ₹
if(s==='₹'){
if(c>=1e12)return '₹'+(c/1e12).toFixed(2)+' Lakh Cr';
if(c>=1e7){const cr=c/1e7;return '₹'+(cr>=1000?Math.round(cr).toLocaleString('en-IN'):cr.toFixed(cr<100?2:0))+' Cr'}
if(c>=1e5)return '₹'+(c/1e5).toFixed(2)+' Lakh';
return '₹'+Math.round(c).toLocaleString('en-IN')}
if(c>=1e12)return s+(c/1e12).toFixed(2)+'T';if(c>=1e9)return s+(c/1e9).toFixed(2)+'B';if(c>=1e6)return s+(c/1e6).toFixed(2)+'M';return s+c.toLocaleString()}
function capCategory(mc,sym){if(sym==='₹'){return mc>2e11?'Large-cap':mc>5e10?'Mid-cap':'Small-cap'}return mc>100e9?'Large-cap':mc>10e9?'Mid-cap':'Small-cap'}

// ==========================================
// FEATURE VOTING SYSTEM
// ==========================================
const featureKeys=['pdf','cmp','share','tech','peer','earn','insider','theme'];
const featureNames=['PDF Export','Compare Stocks','Share (WhatsApp/Email)','Technical Indicators','Peer Comparison','Earnings Countdown','Insider Activity','Dark/Light Theme'];
const votes={};
featureKeys.forEach(k=>{votes[k]={up:0,dn:0}});
let voteChart=null;
let userVotes={};

// ═══════════════════════════════════════════════
// CURATED STOCK PICKS — Research-backed lists
// ═══════════════════════════════════════════════
const STOCK_PICKS={
lc:{title:'Top 5 Undervalued Large Caps',
india:[
{n:'ITC',t:'ITC.NS',p:'₹435',cl:'HUL, Nestle, Britannia compete',why:'P/E ~25x vs sector 35x, FMCG + hotel demerger catalyst, 3.5% div yield',edge:'Conglomerate discount unwinding',cat:'Undervalued'},
{n:'SBI',t:'SBI.NS',r:'Strong Buy',p:'₹790',cl:'HDFC Bank, ICICI, BoB compete',why:'P/B 1.6x (PSU banks at 2.5x), highest NIM, ₹5L Cr book, NPA at 10yr low',edge:'Largest loan book + digital push',cat:'Deep Value',bp:'₹720-750',d:'BUY ON DIP · Hold 12mo · Wait for ₹720-750 zone. NPA cycle bottom confirmed. 80% prob of ₹950+ in 12mo.'},
{n:'NTPC',t:'NTPC.NS',p:'₹340',cl:'Tata Power, Adani Power compete',why:'P/E ~15x, green energy pivot, 2.8% yield, govt capex beneficiary',edge:'Renewable + thermal dual play',cat:'Undervalued'},
{n:'Coal India',t:'COALINDIA.NS',p:'₹390',cl:'No listed peer (monopoly)',why:'P/E ~7x, 6%+ div yield, cash rich, volume growth returning',edge:'Cash cow with massive dividends',cat:'Deep Value'},
{n:'L&T',t:'LT.NS',p:'₹3,450',cl:'Tata Projects, Shapoorji, Afcons',why:'Orderbook ₹4.5L Cr at 3.2x book, infra capex cycle peak, strong execution',edge:'India infra backbone',cat:'Quality Value'}
],
usa:[
{n:'Alphabet',t:'GOOGL',p:'$185',cl:'Microsoft, Meta, Amazon (ads)',why:'P/E ~22x vs FAANG avg 30x, $100B+ cash, AI leader, cloud growing 28%',edge:'AI + search monopoly underpriced',cat:'Undervalued'},
{n:'Berkshire',t:'BRK-B',r:'★ Aggressive Buy',p:'$480',cl:'No direct peer',why:'P/B 1.5x, $300B+ cash pile, insurance float machine, Buffett premium',edge:'Largest cash hoard in history',cat:'Deep Value',bp:'$450-470',d:'BUY NOW · Hold 24mo · $300B cash = acquisition catalyst anytime. Correction-proof. 88% prob of ₹600+ in 18mo.'},
{n:'Meta',t:'META',p:'$620',cl:'Google, TikTok, Snap (ads)',why:'P/E ~23x, 36% margins, 3.7B users, Reels monetization ramping, AI ads',edge:'Ad tech monopoly + AI efficiency',cat:'Quality Value'},
{n:'Merck',t:'MRK',p:'$105',cl:'Pfizer, J&J, AbbVie (pharma)',why:'P/E ~14x, Keytruda franchise $25B+, strong pipeline, 2.5% yield',edge:'Pharma cash machine underpriced',cat:'Deep Value'},
{n:'JPMorgan',t:'JPM',p:'$255',cl:'Goldman, BofA, Wells Fargo',why:'P/B 2x, ROE 17%, fortress balance sheet, best-in-class banking',edge:'Too big to fail, too cheap to ignore',cat:'Undervalued'}
]},
mc:{title:'Top 5 Undervalued Mid Caps',
india:[
{n:'Indian Hotels',t:'INDHOTEL.NS',r:'Buy',p:'₹720',cl:'ITC Hotels, Lemon Tree, Marriott',why:'Brand portfolio (Taj,Vivanta,Ginger), asset-light expansion, tourism boom',edge:'Pricing power + brand moat',cat:'Quality',bp:'₹650-680',d:'WAIT · Buy at ₹650 · Tourism boom priced in. Wait for correction. 72% prob of ₹850+ in 12mo.'},
{n:'Persistent Sys',t:'PERSISTENT.NS',r:'Strong Buy',p:'₹5,800',cl:'LTTS, Mphasis, Coforge (IT)',why:'30%+ rev growth, healthcare IT, partnerships with Salesforce/AWS',edge:'Niche digital engineering',cat:'Growth',bp:'₹5,200-5,500',d:'ACCUMULATE · Hold 12mo · Product-led IT. Add on dips. 80% prob of ₹7,000+ in 12mo.'},
{n:'Tube Investments',t:'TIINDIA.NS',r:'Buy',p:'₹3,700',cl:'Sundaram, Bosch, Schaeffler',why:'CG group pedigree, EV components, industrial diversification',edge:'Multi-segment industrial play',cat:'Quality',bp:'₹3,800-4,000',d:'BUY ON DIP · Hold 12mo · Tube Investments diversification play. 76% prob of ₹5,000+ in 12mo.'},
{n:'Coforge',t:'COFORGE.NS',r:'Buy',p:'₹7,500',cl:'Persistent, KPIT, Mphasis (IT)',why:'Insurance tech niche, Cigniti acquisition, 20%+ growth trajectory',edge:'Deep domain in BFSI/travel',cat:'Growth',bp:'₹6,800-7,200',d:'WAIT · Buy at ₹6,800 · Good business, expensive. Wait 3-6mo for better entry. 74% prob of ₹8,500+ in 12mo.'},
{n:'Supreme Ind',t:'SUPREMEIND.NS',r:'Strong Buy',p:'₹4,900',cl:'Astral, Prince Pipes, Finolex',why:'Plastic pipes leader, real estate + infra demand, margin expansion',edge:'Market share gains in pipes',cat:'Value',bp:'₹4,800-5,000',d:'BUY NOW · Hold 6-12mo · Plastic pipes infra play. Monsoon + capex cycle. 78% prob of ₹6,000+ in 9mo.'}
],
usa:[
{n:'CrowdStrike',t:'CRWD',r:'Buy',p:'$380',cl:'Palo Alto, SentinelOne, Fortinet',why:'Cybersecurity platform leader, 35%+ ARR growth, module adoption rising',edge:'Security platform consolidation',cat:'Growth',bp:'$350-380',d:'WAIT · Buy at $360 · Post-outage recovery done. Wait for pullback. 75% prob of $450+ in 12mo.'},
{n:'Datadog',t:'DDOG',r:'Buy',p:'$140',cl:'Splunk/Cisco, New Relic, Dynatrace',why:'Observability platform, net retention 115%+, multi-product expansion',edge:'DevOps monitoring standard',cat:'Quality',bp:'$120-135',d:'ACCUMULATE · Hold 12mo · Cloud monitoring essential spend. 78% prob of $170+ in 12mo.'},
{n:'Fair Isaac',t:'FICO',r:'★ Aggressive Buy',p:'$2,000',cl:'No real competitor (monopoly)',why:'FICO score monopoly, 85% of US lending decisions, pricing power',edge:'Irreplaceable credit scoring',cat:'Monopoly',bp:'$1,800-1,900',d:'BUY NOW · Hold 24mo · Credit scoring monopoly. No correction can break this moat. 85% prob of $2,200+ in 12mo.'},
{n:'IDEXX Labs',t:'IDXX',r:'Strong Buy',p:'$430',cl:'Zoetis, Heska (vet diagnostics)',why:'Pet diagnostics monopoly, recurring revenue, companion animal TAM growing',edge:'Pet healthcare monopoly',cat:'Quality',bp:'$420-440',d:'BUY ON DIP · Hold 12-18mo · Pet healthcare monopoly. Wait for $420 zone. 80% prob of $550+ in 12mo.'},
{n:'Cadence Design',t:'CDNS',r:'Strong Buy',p:'$300',cl:'Synopsys (EDA duopoly)',why:'EDA duopoly, chip complexity rising, AI accelerator design tools',edge:'Chip design infrastructure',cat:'Monopoly',bp:'$280-300',d:'ACCUMULATE · Hold 12mo · Chip design essential. AI chip demand = Cadence demand. 82% prob of $350+ in 12mo.'}
]},
sc:{title:'Top 5 Undervalued Small Caps',
india:[
{n:'Kaynes Tech',t:'KAYNES.NS',r:'Buy',p:'₹5,200',cl:'Dixon, Syrma, Avalon (EMS)',why:'Defense electronics, IoT sensors, govt contracts ₹2000Cr+, 40% margins',edge:'Defense + space + EV electronics',cat:'High Growth',bp:'₹5,000-5,500',d:'ACCUMULATE · Hold 12-18mo · Defense + space orders growing. 76% prob of ₹7,000+ in 12mo.'},
{n:'KPIT Tech',t:'KPITTECH.NS',r:'Strong Buy',p:'₹1,450',cl:'Tata Elxsi, LTTS (auto SW)',why:'EV software for top 25 OEMs globally, 30%+ growth, sticky contracts',edge:'Only pure-play auto SW in India',cat:'Niche Moat',bp:'₹1,300-1,400',d:'BUY NOW · Hold 12mo · Auto software monopoly in India. 80% prob of ₹1,800+ in 12mo.'},
{n:'Apar Industries',t:'APARINDS.NS',r:'Strong Buy',p:'₹7,800',cl:'KEI, Polycab (cables)',why:'Specialty conductors, transformer oil, export growth, power infra boom',edge:'Power transmission beneficiary',cat:'Value',bp:'₹9,000-9,500',d:'BUY ON DIP · Hold 12mo · Specialty chemicals. Wait for correction. 77% prob of ₹12,000+ in 12mo.'},
{n:'CMS Info Systems',t:'CMSINFO.NS',r:'★ Aggressive Buy',p:'₹460',cl:'SIS, AGS Transact (cash mgmt)',why:'Cash mgmt duopoly, ATM managed services, 25%+ ROE, asset-light',edge:'Cash logistics monopoly',cat:'Quality',bp:'₹480-500',d:'BUY NOW · Hold 6-12mo · Cash management duopoly. Recession-proof. 83% prob of ₹600+ in 9mo.'},
{n:'Tata Elxsi',t:'TATAELXSI.NS',r:'Buy',p:'₹6,200',cl:'KPIT, Persistent (design)',why:'Design + embedded systems for auto/media, Tata group synergies',edge:'Embedded systems niche',cat:'Niche Moat',bp:'₹6,000-6,500',d:'WAIT · Buy at ₹6,000 · Design services. Expensive now. 3-6mo patience. 73% prob of ₹8,000+ in 12mo.'}
],
usa:[
{n:'Monday.com',t:'MNDY',r:'Buy',p:'$300',cl:'Asana, Smartsheet, Notion',why:'Work OS platform, 110%+ net retention, crossing profitability, SMB+enterprise',edge:'Workflow platform with viral growth',cat:'Growth',bp:'$250-270',d:'ACCUMULATE · Hold 12mo · Work OS platform. Growing 30%+. 77% prob of $330+ in 12mo.'},
{n:'Axon Enterprise',t:'AXON',r:'Strong Buy',p:'$650',cl:'Motorola Solutions (public safety)',why:'TASER + body cameras + cloud evidence.com, govt contracts sticky',edge:'Law enforcement tech monopoly',cat:'Monopoly',bp:'$550-580',d:'BUY NOW · Hold 12-18mo · Law enforcement tech monopoly. 82% prob of $700+ in 12mo.'},
{n:'Samsara',t:'IOT',r:'Buy',p:'$50',cl:'Geotab, Teletrac Navman (fleet)',why:'IoT fleet management, 40%+ growth, expanding to connected ops',edge:'Physical operations intelligence',cat:'High Growth',bp:'$14-16',d:'ACCUMULATE · Hold 12-18mo · IoT platform. Early stage. 70% prob of $22+ in 18mo.'},
{n:'Clearwater',t:'CWAN',r:'Strong Buy',p:'$30',cl:'BlackRock Aladdin, SS&C (fintech)',why:'Investment accounting SaaS, 99%+ retention, $7T+ assets managed',edge:'Financial data infrastructure',cat:'Niche Moat',bp:'$90-100',d:'BUY NOW · Hold 12mo · Wealth tech infrastructure. Sticky revenue. 78% prob of $130+ in 12mo.'},
{n:'Wingstop',t:'WING',r:'Buy',p:'$320',cl:'Popeyes, Buffalo Wild Wings',why:'Asset-light franchise, same-store sales growth, digital 65%+ orders',edge:'Fastest growing restaurant chain',cat:'Quality',bp:'$280-300',d:'WAIT · Buy at $280 · Restaurant franchise. Expensive. Wait for pullback. 72% prob of $350+ in 12mo.'}
]},
niche:{title:'Top 5 Niche/Deep Moat Companies',
india:[
{n:'CDSL',t:'CDSL.NS',r:'★ Aggressive Buy',p:'₹1,550',cl:'NSDL (depository duopoly)',why:'1 of 2 depositories in India, every demat account = revenue, zero competition',edge:'Regulated duopoly, 70%+ margins',cat:'Monopoly',bp:'₹1,600-1,700',d:'BUY NOW · Hold 24mo · Demat monopoly. Every new investor = revenue. 88% prob of ₹2,200+ in 18mo.'},
{n:'IEX',t:'IEX.NS',r:'★ Aggressive Buy',p:'₹165',cl:'PXIL (95% vs 5% market share)',why:'95% market share in power exchange, regulatory moat, volume-linked revenue',edge:'Power exchange monopoly',cat:'Monopoly',bp:'₹170-180',d:'BUY NOW · Hold 12mo · Power exchange monopoly. India energy demand surge. 85% prob of ₹230+ in 12mo.'},
{n:'CAMS',t:'CAMS.NS',r:'★ Aggressive Buy',p:'₹4,200',cl:'KFin Tech (RTA duopoly)',why:'70% MF RTA market share, every SIP = revenue, regulation barrier',edge:'Mutual fund infrastructure backbone',cat:'Duopoly',bp:'₹3,800-4,000',d:'BUY NOW · Hold 12-18mo · MF RTA duopoly. SIP growth = guaranteed revenue. 86% prob of ₹5,000+ in 12mo.'},
{n:'Alkyl Amines',t:'ALKYLAMINE.NS',r:'Strong Buy',p:'₹2,100',cl:'Balaji Amines (specialty chem)',why:'Global leader in amines, pharma/agro raw material, pricing power',edge:'Specialty chemicals niche leader',cat:'Niche',bp:'₹2,200-2,400',d:'ACCUMULATE · Hold 12-18mo · Specialty chemicals. Cyclical bottom forming. 74% prob of ₹3,000+ in 12mo.'},
{n:'Aavas Fin',t:'AAVAS.NS',r:'Buy',p:'₹1,700',cl:'HDFC, Can Fin, Home First',why:'Rural affordable housing, self-employed customer niche, 14%+ ROE',edge:'Underserved market specialist',cat:'Niche',bp:'₹1,500-1,600',d:'BUY ON DIP · Hold 12-18mo · Rural housing NBFC. Rate cut cycle benefits. 76% prob of ₹2,000+ in 12mo.'}
],
usa:[
{n:'ASML',t:'ASML',r:'★ Aggressive Buy',p:'$720',cl:'None (absolute monopoly)',why:'Only EUV lithography maker on earth, every advanced chip needs ASML',edge:'Absolute monopoly in EUV',cat:'Monopoly',bp:'$650-700',d:'BUY NOW · Hold 24mo · EUV lithography monopoly. No alternative exists. 90% prob of ₹900+ in 18mo.'},
{n:'Verisign',t:'VRSN',r:'★ Aggressive Buy',p:'$210',cl:'None (.com/.net registry)',why:'.com/.net registry monopoly, ICANN contract, 87%+ margins',edge:'Internet domain infrastructure',cat:'Monopoly',bp:'$195-205',d:'BUY NOW · Hold 12mo · .com/.net domain monopoly. Price hikes = guaranteed earnings growth. 85% prob of $240+ in 12mo.'},
{n:'S&P Global',t:'SPGI',r:'★ Aggressive Buy',p:'$510',cl:"Moody's, Fitch (ratings)",why:'Credit ratings oligopoly, data analytics, IHS Markit merger synergies',edge:'Financial data indispensable',cat:'Oligopoly',bp:'$480-510',d:'BUY ON DIP · Hold 12mo · Credit rating duopoly. Debt issuance cycle returning. 82% prob of $580+ in 12mo.'},
{n:"Moody's",t:'MCO',r:'Strong Buy',p:'$470',cl:"S&P Global, Fitch (ratings)",why:'Credit ratings duopoly with S&P, recurring revenue, debt issuance growth',edge:'Regulatory-mandated ratings',cat:'Duopoly',bp:'$430-460',d:"BUY ON DIP · Hold 12mo · Moody's. Same thesis as S&P Global. Rating duopoly. 80% prob of $530+ in 12mo."},
{n:'TransDigm',t:'TDG',r:'Strong Buy',p:'$1,350',cl:'Heico (sole-source parts)',why:'Sole-source aerospace parts, 45%+ margins, aftermarket pricing power',edge:'Proprietary aerospace components',cat:'Monopoly',bp:'$1,300-1,400',d:'BUY NOW · Hold 18mo · Aerospace aftermarket monopoly. Locked-in revenue. 84% prob of $1,600+ in 12mo.'}
]},
micro:{title:'Top 5 Multibagger Potential — Micro Caps',
india:[
{n:'Netweb Tech',t:'NETWEB.NS',r:'Accumulate',p:'₹2,400',cl:'Dell, HPE (servers)',why:'AI server manufacturing, NVIDIA partnership, Make in India for HPC/AI',edge:'Only listed AI hardware maker in India',cat:'AI/HPC',bp:'₹2,200-2,400',d:'ACCUMULATE · Hold 18mo · AI server mfg. High risk but massive TAM. 65% prob of ₹3,500+ in 18mo.'},
{n:'Zaggle Prepaid',t:'ZAGGLE.NS',r:'Accumulate',p:'₹420',cl:'Happay, Razorpay (expense)',why:'SaaS spend management, 2M+ users, embedded fintech, 70%+ growth',edge:'Corporate expense management SaaS',cat:'Fintech',bp:'₹350-380',d:'ACCUMULATE · Hold 12-18mo · Corporate expense SaaS. Early stage. 62% prob of ₹500+ in 12mo.'},
{n:'Avalon Tech',t:'AVALON.NS',r:'Accumulate',p:'₹720',cl:'Dixon, Syrma, Kaynes (EMS)',why:'EMS for defense/aerospace/medical, US client base, PLI beneficiary',edge:'High-value electronics for export',cat:'Defense',bp:'₹600-650',d:'ACCUMULATE · Hold 18mo · EMS electronics. Order book growing. 60% prob of ₹900+ in 18mo.'},
{n:'Syrma SGS',t:'SYRMA.NS',r:'Accumulate',p:'₹480',cl:'Dixon, Kaynes, Avalon (EMS)',why:'IoT + RFID + EMS, Samsung/Visteon clients, order book ₹2000Cr',edge:'Smart mfg for global OEMs',cat:'IoT/EMS',bp:'₹400-430',d:'ACCUMULATE · Hold 12-18mo · PLI beneficiary. IoT + defense orders. 64% prob of ₹600+ in 12mo.'},
{n:'Bondada Eng',t:'BONDADA.NS',r:'Accumulate',p:'₹240',cl:'Sterlite, Tejas (5G infra)',why:'5G tower infra, solar EPC, telecom rollout contracts, 100%+ growth',edge:'5G infrastructure rollout play',cat:'5G/Solar',bp:'₹250-270',d:'ACCUMULATE · Hold 18-24mo · Green energy EPC. High risk, high reward. 55% prob of ₹400+ in 18mo.'}
],
usa:[
{n:'Indie Semi',t:'INDI',r:'Accumulate',p:'$6',cl:'NXP, Infineon (auto chips)',why:'Auto semiconductors, ADAS sensors, EV power mgmt, 50+ design wins',edge:'Next-gen auto chip pure play',cat:'EV/ADAS',bp:'$6-7',d:'ACCUMULATE · Hold 18-24mo · Automotive semiconductors. Early. 58% prob of $12+ in 18mo.'},
{n:'Credo Tech',t:'CRDO',r:'Buy',p:'$80',cl:'Marvell, Broadcom (connectivity)',why:'High-speed connectivity for AI data centers, 100G/200G/400G solutions',edge:'AI datacenter interconnects',cat:'AI Infra',bp:'$55-65',d:'BUY ON DIP · Hold 12mo · Connectivity silicon. Data center growth. 72% prob of $90+ in 12mo.'},
{n:'Astera Labs',t:'ALAB',r:'Buy',p:'$90',cl:'Marvell, Credo (CXL/PCIe)',why:'Semiconductor connectivity for AI/cloud, PCIe/CXL retimers',edge:'AI infrastructure fabric',cat:'AI Infra',bp:'$70-80',d:'ACCUMULATE · Hold 12-18mo · AI networking chips. High growth. 68% prob of $110+ in 12mo.'},
{n:'Archer Aviation',t:'ACHR',r:'Accumulate',p:'$9',cl:'Joby, Lilium (eVTOL)',why:'eVTOL air taxi, FAA certification path, United Airlines partnership',edge:'Urban air mobility first mover',cat:'Futuristic',bp:'$7-9',d:'ACCUMULATE · Hold 24mo · eVTOL air taxi. Pre-revenue. Speculative. 45% prob of $15+ in 24mo.'},
{n:'Nano-X',t:'NNOX',r:'Accumulate',p:'$8',cl:'GE Healthcare, Siemens (imaging)',why:'Disruptive digital X-ray, cold-cathode tech, $2/scan model, FDA cleared',edge:'Democratizing medical imaging',cat:'MedTech',bp:'$10-12',d:'ACCUMULATE · Hold 18-24mo · Digital X-ray. FDA approvals key. 50% prob of $20+ in 18mo.'}
]},
penny:{title:'Penny Gems — ₹10 Stocks That Could Hit ₹100',
india:[
{n:'Trident Ltd',t:'TRIDENT.NS',r:'Accumulate',p:'₹32',cl:'Welspun, Indo Count (textiles)',why:'Yarn + paper + home textiles integrated, export orders, capacity expansion, consistent dividends',edge:'Vertically integrated textiles + paper',cat:'Turnaround',bp:'₹28-30',d:'ACCUMULATE · Hold 12-18mo · Integrated textiles. Capacity expansion. 65% prob of ₹45+ in 12mo.'},
{n:'Vodafone Idea',t:'IDEA.NS',r:'Accumulate',p:'₹8',cl:'Jio, Airtel (telecom)',why:'Govt equity conversion, 220M+ subscribers, tariff hikes = ARPU growth, spectrum assets valued 3x mkt cap',edge:'Telecom duopoly survivor bet',cat:'High Risk',bp:'₹7-8',d:'ACCUMULATE · Hold 24mo · Telecom survivor bet. Tariff hikes = ARPU growth. 50% prob of ₹15+ in 24mo.'},
{n:'NHPC',t:'NHPC.NS',r:'Strong Buy',p:'₹85',cl:'SJVN, NTPC (hydro/PSU)',why:'Largest hydro power company, green energy premium, 4%+ div yield, PSU rerating wave',edge:'India\'s hydro power monopoly',cat:'PSU Value',bp:'₹75-80',d:'BUY NOW · Hold 12mo · Hydro monopoly + 4% div yield + PSU rerating. 78% prob of ₹110+ in 12mo.'},
{n:'IREDA',t:'IREDA.NS',r:'Buy',p:'₹190',cl:'PFC, REC (green finance)',why:'Renewable energy NBFC, 30%+ loan book growth, govt mandate for green projects, low NPA',edge:'Only listed green energy lender',cat:'Green Finance',bp:'₹160-175',d:'ACCUMULATE · Hold 12mo · Green energy NBFC. Govt mandate. 70% prob of ₹250+ in 12mo.'},
{n:'HFCL',t:'HFCL.NS',r:'Accumulate',p:'₹95',cl:'Sterlite, Tejas, MTNL (telecom)',why:'Optical fiber + 5G equipment + defense comms, ₹10K Cr order book, govt BharatNet contracts',edge:'5G + defense + fiber triple play',cat:'5G/Defense',bp:'₹80-88',d:'ACCUMULATE · Hold 12-18mo · 5G + fiber + defense. ₹10K Cr orders. 68% prob of ₹130+ in 12mo.'}
],
usa:[
{n:'SoundHound AI',t:'SOUN',r:'Accumulate',p:'$9',cl:'Nuance/MSFT, Google (voice AI)',why:'Conversational AI for restaurants, cars, IoT — Hyundai, Stellantis clients',edge:'Voice AI for physical businesses',cat:'AI Voice',bp:'$7-8',d:'ACCUMULATE · Hold 12-18mo · Voice AI for businesses. Revenue inflecting. 60% prob of $15+ in 12mo.'},
{n:'IonQ',t:'IONQ',r:'Accumulate',p:'$8',cl:'IBM, Google (quantum)',why:'Trapped-ion quantum computing, US govt + enterprise contracts, partnership with Hyundai & Airbus',edge:'Pure-play quantum computing',cat:'Quantum',bp:'$6-7',d:'ACCUMULATE · Hold 24mo · Quantum computing. Very early. Speculative. 45% prob of $15+ in 24mo.'},
{n:'Serve Robotics',t:'SERV',r:'Accumulate',p:'$7',cl:'Nuro, Starship (delivery bots)',why:'Sidewalk delivery robots, Uber Eats partnership, LA/SF deployed, Nvidia-powered AI',edge:'Last-mile autonomous delivery',cat:'Robotics',bp:'$5-6',d:'ACCUMULATE · Hold 18-24mo · Delivery robots. Uber partnership. 50% prob of $12+ in 18mo.'},
{n:'BigBear.ai',t:'BBAI',r:'Accumulate',p:'$4',cl:'Palantir, C3.ai (defense AI)',why:'AI analytics for US defense + supply chain, $500M+ contract pipeline',edge:'Defense-grade decision intelligence',cat:'Defense AI',bp:'$3-4',d:'ACCUMULATE · Hold 18mo · Defense AI analytics. Contract pipeline strong. 55% prob of $8+ in 18mo.'},
{n:'Quantum-Si',t:'QSI',r:'Accumulate',p:'$3',cl:'Illumina, PacBio (proteomics)',why:'Protein sequencing semiconductor, backed by Peter Thiel, FDA path for diagnostics',edge:'First protein sequencing chip',cat:'Biotech',bp:'$2-3',d:'ACCUMULATE · Hold 24mo · Protein sequencing. Pre-revenue. Highest risk. 40% prob of $6+ in 24mo.'}
]},
idx:{title:'Best Index — 30%+ CAGR Potential',
india:[
{n:'Nifty Microcap 250',t:'INDEX',r:'Strong Buy',p:'—',cl:'N/A',why:'Micro-cap broad basket, early-stage growth capture, 35%+ 5yr CAGR',edge:'Widest small-company exposure',cat:'37% CAGR*',bp:'SIP Monthly',d:'START SIP NOW · Hold 36mo+ · Nifty 50 index. 12% CAGR long-term. Best via SIP. 90% prob positive in 3yr.'},
{n:'Nifty Smallcap 250',t:'INDEX',p:'—',cl:'N/A',why:'Small-cap diversified, infra/consumption themes, 32%+ 5yr CAGR',edge:'Small-cap without single-stock risk',cat:'33% CAGR*'},
{n:'BSE SME IPO Index',t:'INDEX',p:'—',cl:'N/A',why:'Captures SME listing gains, high-growth new listings, 40%+ returns',edge:'IPO + early-stage premium',cat:'40%+ CAGR*'},
{n:'Nifty India Defence',t:'INDEX',p:'—',cl:'N/A',why:'Defence capex theme, 5yr CAGR 38%+, govt spending visibility',edge:'Multi-year defence order visibility',cat:'38% CAGR*'},
{n:'Nifty Infra Index',t:'INDEX',p:'—',cl:'N/A',why:'Roads, railways, power — PM Gati Shakti beneficiary',edge:'₹10L Cr+ govt infra pipeline',cat:'31% CAGR*'}
],
usa:[
{n:'NASDAQ-100',t:'QQQ',r:'Strong Buy',p:'$520',cl:'N/A',why:'Top 100 non-financial, tech-heavy, AI/cloud/SaaS concentration',edge:'Big tech + AI mega trends',cat:'19% CAGR',bp:'SIP Monthly',d:'START SIP NOW · Hold 36mo+ · NASDAQ-100. Tech-heavy. 20%+ CAGR 10yr. 88% prob positive in 3yr.'},
{n:'S&P 500 Info Tech',t:'XLK',r:'Strong Buy',p:'$230',cl:'N/A',why:'Pure technology sector, AAPL+MSFT+NVDA heavy, secular growth',edge:'Tech dominance compounding',cat:'22% CAGR',bp:'SIP Monthly',d:'START SIP NOW · Hold 24mo+ · Tech Select SPDR. Broad tech exposure. 85% prob positive in 2yr.'},
{n:'VanEck Semiconductor',t:'SMH',r:'Buy',p:'$260',cl:'N/A',why:'NVDA, AVGO, AMD, ASML — AI chip demand supercycle',edge:'AI hardware supercycle play',cat:'30%+ CAGR*',bp:'SIP Monthly',d:'ACCUMULATE · Hold 24mo+ · Semiconductor ETF. Cyclical but secular AI tailwind. 80% prob of 30%+ in 2yr.'},
{n:'ARK Innovation',t:'ARKK',r:'Accumulate',p:'$55',cl:'N/A',why:'Disruptive tech — AI, genomics, fintech, autonomous vehicles',edge:'High risk, high reward innovation',cat:'Volatile',bp:'$45-50',d:'WAIT · Buy at $45 · High risk innovation. Only if you believe in disruptive tech thesis. 55% prob of $70+ in 18mo.'},
{n:'Global X AI & Tech',t:'AIQ',r:'Buy',p:'$35',cl:'N/A',why:'Broad AI exposure — chips, software, robotics, autonomous',edge:'Diversified AI theme ETF',cat:'28%+ CAGR*',bp:'SIP Monthly',d:'ACCUMULATE · Hold 24mo+ · AI theme ETF. Secular growth. 75% prob of 25%+ in 2yr.'}
]}
};

let _pickGeo='india';
function showPickCat(btn,cat){
document.querySelectorAll('.ptab').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text2)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--blue)';btn.style.color='#fff';btn.style.borderColor='var(--blue)';
renderPicks(cat);
}
function togglePickGeo(btn,geo){
_pickGeo=geo;
document.querySelectorAll('.pick-geo button').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text3)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--amber)';btn.style.color='#000';btn.style.borderColor='var(--amber)';
const activeCat=document.querySelector('.ptab.active');
const cat=activeCat?activeCat.getAttribute('onclick').match(/'(\w+)'/)[1]:'lc';
renderPicks(cat);
}
function renderPicks(cat){
const el=document.getElementById('pickGrid');
if(!el)return;
const data=STOCK_PICKS[cat];
if(!data){el.innerHTML='';return}
const list=_pickGeo==='india'?data.india:data.usa;
const isIdx=cat==='idx';
const isPenny=cat==='penny';
let h=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text)">${data.title}</div>
<div class="pick-geo">
<button class="${_pickGeo==='india'?'active':''}" onclick="togglePickGeo(this,'india')" style="${_pickGeo==='india'?'background:var(--amber);color:#000;border-color:var(--amber)':''}">&#127470;&#127475; India</button>
<button class="${_pickGeo==='usa'?'active':''}" onclick="togglePickGeo(this,'usa')" style="${_pickGeo==='usa'?'background:var(--amber);color:#000;border-color:var(--amber)':''}">&#127482;&#127480; USA</button>
</div></div>`;
h+=`<div style="overflow-x:auto"><table class="pick-tbl"><tr><th>#</th><th>Company</th><th>Rating</th><th style="color:var(--cyan)">Live Price</th><th style="color:var(--green)">Entry Zone</th><th style="color:var(--cyan)">Decision &amp; Timeline</th><th>Edge</th><th>${isIdx?'Returns':'Type'}</th></tr>`;
list.forEach((s,i)=>{
const catCls=s.cat.includes('Monopoly')||s.cat.includes('Duopoly')||s.cat.includes('Oligopoly')?'b':s.cat.includes('Deep')||s.cat.includes('Value')||s.cat.includes('Undervalued')||s.cat.includes('Turnaround')||s.cat.includes('PSU')?'g':'b';
const rt=s.r||'Buy';
const rC=rt.includes('Aggressive')?'#10b981':rt.includes('Strong')?'#10b981':rt==='Buy'?'#3b82f6':'#f59e0b';
const rBg=rt.includes('Aggressive')?'rgba(16,185,129,.15)':rt.includes('Strong')?'rgba(16,185,129,.08)':rt==='Buy'?'rgba(0,120,212,.08)':'rgba(245,158,11,.08)';
const dec=s.d||'';
const decParts=dec.split(' · ');
const decAction=decParts[0]||'';
const decRest=decParts.slice(1).join(' · ');
const decCol=decAction.includes('BUY NOW')?'var(--green)':decAction.includes('ACCUMULATE')?'#22d3ee':decAction.includes('WAIT')?'var(--amber)':decAction.includes('START')?'var(--green)':'var(--text2)';
h+=`<tr>
<td style="color:var(--text3);font-weight:700">${i+1}</td>
<td><div class="cname">${s.n}</div><div class="csub">${s.t}</div></td>
<td><span style="font-size:9px;padding:2px 6px;border-radius:4px;background:${rBg};color:${rC};font-weight:700;white-space:nowrap">${rt}</span></td>
<td style="font-weight:700;color:var(--cyan);white-space:nowrap;font-size:11px" data-ticker="${s.t}" data-col="cmp"><span style="font-size:9px;color:var(--text3)">⏳ loading...</span></td>
<td style="font-weight:700;color:var(--green);white-space:nowrap;font-size:11px">${s.bp||'—'}</td>
<td style="font-size:10px;line-height:1.5"><strong style="color:${decCol};font-size:10px">${decAction}</strong>${decRest?' · <span style="color:var(--text2)">'+decRest+'</span>':''}</td>
<td style="font-size:10px;font-weight:600;color:var(--amber)">${s.edge}</td>
<td><span class="flag ${catCls}">${s.cat}</span></td>
</tr>`;
});
h+=`</table></div>`;
if(cat==='idx')h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">* CAGR figures are approximate based on last 3-5 year trailing returns. Past performance does not guarantee future results.</div>`;
if(cat==='micro')h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">&#9888; Micro caps are extremely high risk. Position size should be &lt;2% of portfolio. Many will fail — diversification is essential.</div>`;
if(isPenny)h+=`<div style="font-size:9px;color:var(--red);margin-top:6px;padding:6px 10px;border-radius:6px;background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.1)">&#9888; <strong>EXTREME RISK:</strong> Penny stocks can lose 50-90% of value. These are speculative bets, not investments. Never allocate more than 1-2% of your portfolio. Do your own due diligence. Prices are approximate and change rapidly.</div>`;
el.innerHTML=h;
// ═══ FETCH LIVE PRICES for displayed stocks ═══
fetchLivePricesForPicks(el);
}

let _livePriceCache={};
async function fetchLivePricesForPicks(container){
if(!container){console.error('fetchLivePricesForPicks: no container');return}
const cells=container.querySelectorAll('td[data-ticker][data-col="cmp"]');
if(!cells.length){console.warn('fetchLivePricesForPicks: 0 cells found');return}
const tickers=[...new Set([...cells].map(c=>c.dataset.ticker).filter(t=>t&&t!=='INDEX'&&t.length>1&&/^[A-Z0-9.\-]+$/.test(t)))];
console.log('📡 fetchLivePricesForPicks:',tickers.length,'tickers from',cells.length,'cells');
if(!tickers.length)return;
// Show loading in all cells
cells.forEach(c=>{if(c.dataset.ticker&&c.dataset.ticker!=='INDEX')c.innerHTML='<span style="color:var(--text3);font-size:9px">⏳</span>'});
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:tickers})});
if(!res.ok){
console.error('batch-prices HTTP error:',res.status);
cells.forEach(c=>{c.innerHTML='<span style="color:var(--red);font-size:9px">HTTP '+res.status+'</span>'});
return;
}
const data=await res.json();
console.log('📊 batch-prices:',JSON.stringify({success:data.success,fetched:data.fetched,failed:data.failed}));
if(!data.success){
cells.forEach(c=>{c.innerHTML='<span style="color:var(--red);font-size:9px">API error</span>'});
return;
}
const prices=data.prices||{};
let ok=0,fail=0;
cells.forEach(cell=>{
const tk=cell.dataset.ticker;
if(!tk||tk==='INDEX'){cell.innerHTML='—';return}
const p=prices[tk];
if(p&&p.formatted){
ok++;
_livePriceCache[tk]=p;
const up=(p.change_pct||0)>=0;
cell.innerHTML=`<span style="font-weight:700">${p.formatted}</span> <span style="font-size:7px;color:${up?'var(--green)':'var(--red)'}">LIVE ${up?'▲':'▼'}${Math.abs(p.change_pct||0).toFixed(1)}%</span>`;
cell.style.color=up?'var(--green)':'var(--red)';
}else{
fail++;
cell.innerHTML='<span style="color:var(--text3);font-size:9px">N/A</span>';
}
});
console.log('✅ Picks prices:',ok,'loaded,',fail,'failed');
}catch(e){
console.error('❌ fetchLivePricesForPicks error:',e);
cells.forEach(c=>{c.innerHTML='<span style="color:var(--red);font-size:9px;cursor:pointer" onclick="fetchLivePricesForPicks(document.getElementById(\'pickGrid\'))">❌ retry</span>'});
}
}

// ═══════════════════════════════════════════════
// ═══ DCF INTRINSIC VALUATION MODEL ═══
// ═══════════════════════════════════════════════
function renderDCF(d){
const el=document.getElementById('dcfContent');
if(!el||!d)return;
const _sf=(v,def=0)=>{if(v===null||v===undefined||v==='N/A'||v==='')return def;const n=parseFloat(String(v).replace(/[,%]/g,''));return isNaN(n)?def:n};
const sym=d.currency==='INR'?'₹':'$';
const price=_sf(d.current_price);
const mcap=_sf(d.market_cap);
const pe=_sf(d.pe_ratio);
const fpe=_sf(d.forward_pe);
const eps=_sf(d.eps_ttm);
const epsF=_sf(d.eps_forward);
const beta=_sf(d.beta,1);
const pm=_sf(d.profit_margin,10);
const om=_sf(d.operating_margin,12);
const gm=_sf(d.gross_margins,30);
const rev=_sf(d.total_revenue);
const roe=_sf(d.roe,12);
const de=_sf(d.debt_to_equity,50);
const eg=_sf(d.earnings_growth,10);
const rg=_sf(d.revenue_growth,8);
const eqg=_sf(d.earnings_quarterly_growth,5);
const divY=_sf(d.dividend_yield,0);
const payout=_sf(d.payout_ratio,0);
const fcf=_sf(d.free_cash_flow||d.free_cashflow);
const ocf=_sf(d.operating_cash_flow||d.operating_cashflow);
const ebitda=_sf(d.ebitda);
const ebitdaM=_sf(d.ebitda_margins,15);
const totalCash=_sf(d.total_cash);
const totalDebt=_sf(d.total_debt);
const bv=_sf(d.book_value);
const cr=_sf(d.current_ratio,1);
const qr=_sf(d.quick_ratio,0.8);
const peg=_sf(d.peg_ratio);
const evEbitda=_sf(d.enterprise_to_ebitda);
const shortR=_sf(d.short_ratio);
const rps=_sf(d.revenue_per_share);
const shares=mcap>0&&price>0?Math.round(mcap/price):0;
const w52h=_sf(d.week52_high,price*1.2);
const w52l=_sf(d.week52_low,price*0.8);
const sma20=_sf(d.sma_20);
const sma50=_sf(d.sma_50);
const sma200=_sf(d.sma_200);
const sector=d.sector||'Unknown';
const name=d.company_name||d.ticker||'';
const ticker=d.ticker||'';
const isIndian=d.currency==='INR';

// ═══ WACC CALCULATION (CAPM) ═══
const riskFree=isIndian?0.072:0.043;
const mktPremium=isIndian?0.065:0.055;
const countryPremium=isIndian?0.015:0;
const sizePremium=mcap<5e9?0.02:mcap<2e10?0.01:0;
const costEquity=riskFree+beta*mktPremium+countryPremium+sizePremium;
const creditSpread=de>200?0.04:de>100?0.025:de>50?0.015:0.01;
const costDebt=riskFree+creditSpread;
const taxRate=isIndian?0.2508:0.21;
const debtRatio=totalDebt>0&&mcap>0?totalDebt/(totalDebt+mcap):Math.min(de/(100+de),0.5);
const equityRatio=1-debtRatio;
const wacc=equityRatio*costEquity+debtRatio*costDebt*(1-taxRate);

// ═══ FCF ESTIMATION ═══
const reportedFCF=fcf>0?fcf:0;
const estimatedFCF=ocf>0?ocf*0.75:(rev>0?rev*pm/100*0.6:(ebitda>0?ebitda*0.5:mcap*0.035));
const baseFCF=reportedFCF||estimatedFCF;
const fcfPerShare=shares>0?baseFCF/shares:0;
const fcfYield=mcap>0?(baseFCF/mcap*100):0;
const fcfMargin=rev>0?(baseFCF/rev*100):0;

// ═══ GROWTH RATE ESTIMATION ═══
const histGrowth=((rg||0)+(eg||0)+(eqg||0))/3/100;
const sustainGrowth=roe/100*(1-payout/100);
const impliedGrowth=pe>0&&costEquity>0?(costEquity-(eps/price||0)):0.08;
const blendedGrowth=Math.max(Math.min(((histGrowth||0.08)*0.4+(sustainGrowth||0.08)*0.3+(impliedGrowth||0.08)*0.3),0.35),-0.05)||0.08;
const terminalGrowth=isIndian?0.05:0.025;
const projYears=10;
const fadeStart=5;

// ═══ FCF PROJECTIONS WITH GROWTH FADE ═══
let projections=[];
let totalPV=0;
for(let y=1;y<=projYears;y++){
const yr_growth=y<=fadeStart?blendedGrowth:(blendedGrowth-(blendedGrowth-terminalGrowth)*(y-fadeStart)/(projYears-fadeStart));
const projFCF=y===1?baseFCF*(1+yr_growth):projections[y-2].fcf*(1+yr_growth);
const pv=projFCF/Math.pow(1+wacc,y);
totalPV+=pv;
projections.push({year:y,fcf:projFCF,pv:pv,growth:yr_growth*100,discount:1/Math.pow(1+wacc,y)});
}

// Terminal Value (Gordon Growth)
const termFCF=projections[projYears-1].fcf*(1+terminalGrowth);
const termValue=termFCF/(wacc-terminalGrowth);
const termPV=termValue/Math.pow(1+wacc,projYears);
const enterpriseValue=totalPV+termPV;
const netDebt=totalDebt>0&&totalCash>0?(totalDebt-totalCash):(totalDebt>0?totalDebt*0.7:0);
const equityValue=Math.max(enterpriseValue-netDebt,0);
const intrinsicPrice=shares>0?equityValue/shares:0;
const marginOfSafety=price>0?((intrinsicPrice-price)/price*100):0;
const upDown=marginOfSafety>=15?'SIGNIFICANTLY UNDERVALUED':marginOfSafety>=5?'UNDERVALUED':marginOfSafety>=-5?'FAIRLY VALUED':marginOfSafety>=-15?'OVERVALUED':'SIGNIFICANTLY OVERVALUED';
const udColor=marginOfSafety>=15?'#10b981':marginOfSafety>=5?'#22d3ee':marginOfSafety>=-5?'var(--amber)':marginOfSafety>=-15?'#f97316':'var(--red)';
const udIcon=marginOfSafety>=15?'🟢':marginOfSafety>=5?'🔵':marginOfSafety>=-5?'🟡':marginOfSafety>=-15?'🟠':'🔴';
const termPct=enterpriseValue>0?(termPV/enterpriseValue*100):0;

const _fn=(n)=>{if(!n||n===0)return'N/A';const a=Math.abs(n);const s=n<0?'-':'';if(a>=1e12)return s+sym+(a/1e12).toFixed(2)+'T';if(a>=1e9)return s+sym+(a/1e9).toFixed(2)+'B';if(a>=1e7&&isIndian)return s+sym+(a/1e7).toFixed(2)+'Cr';if(a>=1e5&&isIndian)return s+sym+(a/1e5).toFixed(2)+'L';return s+sym+a.toLocaleString(undefined,{maximumFractionDigits:0})};
const _pct=(n)=>n!==0&&!isNaN(n)?(n>=0?'+':'')+n.toFixed(1)+'%':'N/A';

// ═══ SENSITIVITY TABLE ═══
const waccSteps=[-0.02,-0.01,0,0.01,0.02];
const tgSteps=[-0.01,0,0.01,0.02];
let sensRows='';
tgSteps.forEach(tgDelta=>{
const tg=terminalGrowth+tgDelta;
let cells=`<td style="font-weight:700;color:var(--text);font-size:10px">${(tg*100).toFixed(1)}%</td>`;
waccSteps.forEach(wDelta=>{
const w=wacc+wDelta;
if(w<=tg){cells+=`<td style="font-size:10px;color:var(--text3)">—</td>`;return}
let sPV=0;
let sFCF=baseFCF;
for(let y=1;y<=projYears;y++){
const yg=y<=fadeStart?blendedGrowth:(blendedGrowth-(blendedGrowth-tg)*(y-fadeStart)/(projYears-fadeStart));
sFCF*=(1+yg);sPV+=sFCF/Math.pow(1+w,y)}
const sTF=sFCF*(1+tg);const sTV=sTF/(w-tg);const sTPV=sTV/Math.pow(1+w,projYears);
const sEV=sPV+sTPV;const sPrice=shares>0?(sEV-netDebt)/shares:0;
const sMOS=price>0?((sPrice-price)/price*100):0;
const sC=sMOS>=20?'#10b981':sMOS>=5?'#22d3ee':sMOS>=-5?'var(--amber)':sMOS>=-15?'#f97316':'var(--red)';
const isCurrent=Math.abs(wDelta)<0.001&&Math.abs(tgDelta)<0.001;
cells+=`<td style="font-size:10px;font-weight:${isCurrent?'800':'600'};color:${sC};${isCurrent?'background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.3)':''}">${sym}${sPrice.toFixed(0)}</td>`;
});
sensRows+=`<tr>${cells}</tr>`;
});

// ═══ COMPARABLES VALUATION ═══
const peValue=pe>0&&epsF>0?_sf(d.sector_avg_pe,20)*epsF:0;
const pbValue=bv>0?bv*(_sf(d.sector_avg_pe,20)/pe*1.5||2):0;
const evEbitdaValue=ebitda>0&&shares>0?(_sf(d.sector_avg_pe,20)*0.8*ebitda-netDebt)/shares:0;
const pegValue=epsF>0&&eg>0?epsF*(eg>0?Math.min(eg,30):15):0;

let h=`
<!-- DCF HERO -->
<div style="background:linear-gradient(135deg,#0a1628 0%,#0d2137 50%,#0a1628 100%);border-radius:16px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden">
<div style="position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(16,185,129,.2),transparent 70%)"></div>
<div style="position:absolute;bottom:-30px;left:-30px;width:150px;height:150px;background:radial-gradient(circle,rgba(59,130,246,.15),transparent 70%)"></div>
<div style="position:relative">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3);margin-bottom:8px">CELESYS AI · DISCOUNTED CASH FLOW ANALYSIS</div>
<div style="font-size:18px;font-weight:800;color:#fff;margin-bottom:16px">${name} (${ticker})</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px">
<!-- Intrinsic Value -->
<div style="text-align:center;padding:20px;border-radius:12px;background:rgba(16,185,129,.08);border:2px solid rgba(16,185,129,.4)">
<div style="font-size:9px;letter-spacing:1px;color:rgba(16,185,129,.7)">INTRINSIC VALUE</div>
<div style="font-size:36px;font-weight:900;color:#10b981;font-family:var(--mono);line-height:1.1">${sym}${intrinsicPrice.toFixed(2)}</div>
<div style="font-size:10px;color:rgba(255,255,255,.4)">per share (DCF)</div>
</div>
<!-- Current Price -->
<div style="text-align:center;padding:20px;border-radius:12px;background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.3)">
<div style="font-size:9px;letter-spacing:1px;color:rgba(59,130,246,.7)">MARKET PRICE</div>
<div style="font-size:36px;font-weight:900;color:#3b82f6;font-family:var(--mono);line-height:1.1">${sym}${price.toFixed(2)}</div>
<div style="font-size:10px;color:rgba(255,255,255,.4)">CMP</div>
</div>
<!-- Margin of Safety -->
<div style="text-align:center;padding:20px;border-radius:12px;background:${marginOfSafety>=0?'rgba(16,185,129,.08)':'rgba(239,68,68,.08)'};border:2px solid ${udColor}">
<div style="font-size:9px;letter-spacing:1px;color:${udColor}">MARGIN OF SAFETY</div>
<div style="font-size:36px;font-weight:900;color:${udColor};font-family:var(--mono);line-height:1.1">${marginOfSafety>=0?'+':''}${marginOfSafety.toFixed(1)}%</div>
<div style="font-size:11px;font-weight:700;color:${udColor}">${udIcon} ${upDown}</div>
</div>
</div>

<!-- Quick Stats Bar -->
<div style="display:flex;gap:16px;margin-top:16px;flex-wrap:wrap;justify-content:center">
<div style="text-align:center"><div style="font-size:8px;color:rgba(255,255,255,.3)">WACC</div><div style="font-size:14px;font-weight:700;color:#22d3ee">${(wacc*100).toFixed(2)}%</div></div>
<div style="text-align:center"><div style="font-size:8px;color:rgba(255,255,255,.3)">GROWTH</div><div style="font-size:14px;font-weight:700;color:#10b981">${(blendedGrowth*100).toFixed(1)}%</div></div>
<div style="text-align:center"><div style="font-size:8px;color:rgba(255,255,255,.3)">TERMINAL</div><div style="font-size:14px;font-weight:700;color:#f59e0b">${(terminalGrowth*100).toFixed(1)}%</div></div>
<div style="text-align:center"><div style="font-size:8px;color:rgba(255,255,255,.3)">FCF YIELD</div><div style="font-size:14px;font-weight:700;color:${fcfYield>5?'#10b981':'#f59e0b'}">${fcfYield.toFixed(1)}%</div></div>
<div style="text-align:center"><div style="font-size:8px;color:rgba(255,255,255,.3)">EV</div><div style="font-size:14px;font-weight:700;color:#a78bfa">${_fn(enterpriseValue)}</div></div>
<div style="text-align:center"><div style="font-size:8px;color:rgba(255,255,255,.3)">TERM %</div><div style="font-size:14px;font-weight:700;color:${termPct>75?'var(--red)':'#f59e0b'}">${termPct.toFixed(0)}%</div></div>
</div>
</div></div>

<!-- AI Prediction Signal -->
${(()=>{
const _pr=_sf(d.current_price);if(!_pr)return '';
const s20=_sf(d.sma_20,_pr);const s50=_sf(d.sma_50,_pr);const s200=_sf(d.sma_200,_pr);
const h52=_sf(d['52w_high'],_pr*1.15);const l52=_sf(d['52w_low'],_pr*0.85);
const _pe=_sf(d.pe_ratio);const sPE=_sf(d.sector_avg_pe,_pe||20);
let sc=0;
if(_pr>s20)sc+=8;else sc-=8;if(_pr>s50)sc+=10;else sc-=10;if(_pr>s200)sc+=12;else sc-=12;
const r52=h52-l52;const pos=r52>0?((_pr-l52)/r52):0.5;
sc+=pos>0.8?-10:pos>0.6?5:pos>0.4?15:pos>0.2?10:-5;
if(_pe>0&&sPE>0){const vr=_pe/sPE;sc+=vr<0.7?20:vr<0.9?12:vr<1.1?5:vr<1.3?-8:-18;}
if(rg>20)sc+=8;else if(rg>10)sc+=4;else if(rg<0)sc-=6;
if(eg>20)sc+=7;else if(eg>10)sc+=3;else if(eg<0)sc-=6;
sc=Math.max(-100,Math.min(100,sc));
const ar=sc/100*0.4;const t1y=_pr*(1+ar);const up1y=(t1y-_pr)/_pr*100;
const sig=sc>30?'BULLISH':sc>10?'MILDLY BULLISH':sc>-10?'NEUTRAL':sc>-30?'MILDLY BEARISH':'BEARISH';
const sC=sc>30?'#10b981':sc>10?'#22c55e':sc>-10?'#f59e0b':sc>-30?'#f97316':'#ef4444';
const em=sc>10?'🟢':sc>-10?'🟡':'🔴';
return `<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:12px 16px;border-radius:10px;background:rgba(0,47,108,.03);border:1px solid ${sC}40;margin-bottom:16px">
<div style="font-size:11px;color:var(--text3)">🔮 <strong>AI Price Prediction:</strong></div>
<div style="font-size:12px;font-weight:800;color:${sC}">${em} ${sig}</div>
<div style="font-size:10px;color:var(--text3)">1Y Target: <strong style="color:${sC}">${sym}${t1y.toFixed(0)}</strong> (${up1y>=0?'+':''}${up1y.toFixed(1)}%)</div>
<div style="font-size:10px;color:var(--text3)">Score: <strong style="color:${sC}">${sc>0?'+':''}${sc}/100</strong></div>
<div style="font-size:8px;color:var(--text3);margin-left:auto">Based on trend + valuation + growth + quality signals</div>
</div>`;
})()}

<!-- ═══ SECTION 1: WHAT THIS MEANS (PLAIN ENGLISH) ═══ -->
<div style="padding:18px;border-radius:12px;background:rgba(16,185,129,.04);border-left:4px solid #10b981;margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#10b981;margin-bottom:8px">💡 What This Means For You (Plain English)</div>
<p style="font-size:12px;color:var(--text);line-height:1.9;margin:0">
${marginOfSafety>=15?
`Our DCF model says ${name} is worth <strong style="color:#10b981">${sym}${intrinsicPrice.toFixed(0)}</strong> per share, but the market is selling it at <strong>${sym}${price.toFixed(0)}</strong> — that's a <strong style="color:#10b981">${marginOfSafety.toFixed(0)}% discount</strong> to fair value. Think of it like buying a ₹100 note for ₹${(100-marginOfSafety).toFixed(0)}. The company generates ${_fn(baseFCF)} in free cash annually, growing at ~${(blendedGrowth*100).toFixed(0)}%. If this growth continues, the stock has significant room to appreciate.`
:marginOfSafety>=0?
`${name} appears <strong style="color:#22d3ee">fairly valued to slightly undervalued</strong>. Our model estimates fair value at ${sym}${intrinsicPrice.toFixed(0)} vs current price of ${sym}${price.toFixed(0)}. There's a modest ${marginOfSafety.toFixed(0)}% buffer. The company generates ${_fn(baseFCF)} in free cash flow. Not a screaming bargain, but you're not overpaying either.`
:marginOfSafety>=-15?
`At ${sym}${price.toFixed(0)}, the stock is <strong style="color:var(--amber)">slightly above our estimated fair value</strong> of ${sym}${intrinsicPrice.toFixed(0)}. You're paying a ${Math.abs(marginOfSafety).toFixed(0)}% premium. This could be justified if growth accelerates, but there's limited margin of safety at this price.`
:`The stock appears <strong style="color:var(--red)">significantly overvalued</strong> at ${sym}${price.toFixed(0)} — our model estimates fair value at just ${sym}${intrinsicPrice.toFixed(0)} (${Math.abs(marginOfSafety).toFixed(0)}% premium). Either the market is pricing in growth that hasn't materialized yet, or expectations are too high. Be cautious.`}
</p>
</div>

<!-- ═══ SECTION 2: WACC BREAKDOWN ═══ -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(0,47,108,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">⚙️ Cost of Capital (WACC) — How Much Returns Must the Company Generate?</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 14px 0;line-height:1.6">WACC is the minimum return a company must earn on its assets. Think of it as the "hurdle rate" — if the company can't beat this number, it's destroying value. Lower WACC = easier to create value.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px">
${[
{l:'Risk-Free Rate',v:(riskFree*100).toFixed(1)+'%',tip:'10Y govt bond yield — the "zero risk" baseline',c:'var(--blue)'},
{l:'Beta (β)',v:beta.toFixed(2),tip:beta>1.2?'Higher than market — more risky':beta<0.8?'Lower than market — defensive':'Close to market average',c:'var(--purple)'},
{l:'Equity Premium',v:(mktPremium*100).toFixed(1)+'%',tip:'Extra return investors demand for stock market risk',c:'var(--cyan)'},
{l:'Size Premium',v:(sizePremium*100).toFixed(1)+'%',tip:sizePremium>0?'Small-cap companies carry extra risk':'Large cap — no size premium',c:'var(--amber)'},
{l:'Cost of Equity',v:(costEquity*100).toFixed(1)+'%',tip:'Shareholders expect at least this return',c:'#10b981'},
{l:'Cost of Debt (pre-tax)',v:(costDebt*100).toFixed(1)+'%',tip:'Interest rate on borrowings',c:'var(--red)'},
{l:'Tax Shield',v:(taxRate*100).toFixed(0)+'%',tip:'Tax deduction on interest saves money',c:'var(--text3)'},
{l:'Debt/Total Capital',v:(debtRatio*100).toFixed(1)+'%',tip:debtRatio>0.4?'High leverage increases risk':'Reasonable capital structure',c:debtRatio>0.4?'var(--red)':'var(--green)'},
].map(m=>`<div style="text-align:center;padding:10px 8px;border-radius:8px;background:rgba(0,47,108,.02);border:1px solid var(--border)"><div style="font-size:8px;color:var(--text3);letter-spacing:.5px;margin-bottom:2px">${m.l}</div><div style="font-size:18px;font-weight:800;color:${m.c}">${m.v}</div><div style="font-size:8px;color:var(--text3);margin-top:2px">${m.tip}</div></div>`).join('')}
</div>
<div style="margin-top:12px;padding:12px;border-radius:8px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);text-align:center">
<div style="font-size:10px;color:var(--text3)">WACC = ${(equityRatio*100).toFixed(0)}% × ${(costEquity*100).toFixed(1)}% + ${(debtRatio*100).toFixed(0)}% × ${(costDebt*100).toFixed(1)}% × (1 - ${(taxRate*100).toFixed(0)}%)</div>
<div style="font-size:24px;font-weight:900;color:#10b981;margin-top:4px">${(wacc*100).toFixed(2)}%</div>
</div>
</div>
<div style="margin-top:12px;padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 In Simple Terms:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">${wacc<0.10?'A WACC of '+(wacc*100).toFixed(1)+'% is LOW — the company has cheap access to capital. This means even modest business returns create shareholder value. Think of it like a home loan at a low interest rate — easier to profit from.':wacc<0.14?'A WACC of '+(wacc*100).toFixed(1)+'% is MODERATE — the company needs to earn decent returns to justify its cost of capital. This is typical for most established companies.':'A WACC of '+(wacc*100).toFixed(1)+'% is HIGH — the company must earn exceptional returns to create value for shareholders. High WACC usually means high risk (volatile stock or heavy debt). Like a high-interest credit card — the business needs to work hard just to break even.'}</div>
</div>

<!-- ═══ SECTION 3: FCF ANALYSIS ═══ -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(59,130,246,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">💰 Free Cash Flow Analysis — The Cash the Company Actually Generates</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 14px 0;line-height:1.6">Free Cash Flow (FCF) is the cash left after all expenses and investments. This is the real money available to pay dividends, buy back shares, reduce debt, or reinvest. FCF is more reliable than reported earnings because it's harder to manipulate.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">
${[
{l:'Free Cash Flow',v:_fn(baseFCF),sub:reportedFCF?'Reported':'Estimated from operations',c:'#10b981'},
{l:'Operating Cash Flow',v:_fn(ocf),sub:'Cash from core business',c:'var(--blue)'},
{l:'Revenue',v:_fn(rev),sub:'Total sales',c:'var(--cyan)'},
{l:'EBITDA',v:_fn(ebitda),sub:'Operating profit before D&A',c:'var(--purple)'},
{l:'FCF per Share',v:sym+fcfPerShare.toFixed(2),sub:'Available per share you own',c:'#10b981'},
{l:'FCF Yield',v:fcfYield.toFixed(1)+'%',sub:fcfYield>8?'Excellent — high cash return':fcfYield>4?'Good cash generation':'Low — growth phase or low margins',c:fcfYield>5?'#10b981':'var(--amber)'},
{l:'FCF Margin',v:fcfMargin.toFixed(1)+'%',sub:'% of revenue converted to cash',c:fcfMargin>15?'#10b981':'var(--amber)'},
{l:'Total Cash',v:_fn(totalCash),sub:'Cash on balance sheet',c:'var(--cyan)'},
{l:'Total Debt',v:_fn(totalDebt),sub:'Outstanding borrowings',c:totalDebt>totalCash*3?'var(--red)':'var(--amber)'},
{l:'Net Debt',v:_fn(netDebt),sub:netDebt<0?'Net cash position!':'Debt minus cash',c:netDebt<=0?'#10b981':'var(--amber)'},
].map(m=>`<div style="padding:12px;border-radius:8px;background:rgba(0,47,108,.02);border:1px solid var(--border)"><div style="font-size:9px;color:var(--text3);margin-bottom:2px">${m.l}</div><div style="font-size:16px;font-weight:800;color:${m.c};font-family:var(--mono)">${m.v}</div><div style="font-size:8px;color:var(--text3);margin-top:1px">${m.sub}</div></div>`).join('')}
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid var(--blue);margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:var(--blue)">💡 In Simple Terms — What is Free Cash Flow?</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">${fcfYield>8?'This company converts '+fcfYield.toFixed(1)+'% of its market value into FREE CASH every year. Imagine owning a rental property that gives you '+fcfYield.toFixed(0)+'% of its value in rent annually. Even if the stock price stays flat, the cash generation alone is compelling.':fcfYield>4?'The company generates '+fcfYield.toFixed(1)+'% of its value in free cash. Like a fixed deposit that also has growth potential — the business produces enough surplus cash to fund dividends, buybacks, or expansion.':fcfYield>0?'Free cash flow yield of '+fcfYield.toFixed(1)+'% is thin. The company reinvests most of what it earns. Common in high-growth companies, but means less margin for error if growth slows.':'The company has NEGATIVE free cash flow — spending more than it earns. Not always bad (Amazon did this for years while building infrastructure), but risky if growth does not materialize.'}</div>
</div>

<!-- ═══ SECTION 4: GROWTH ASSUMPTIONS ═══ -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(245,158,11,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">📈 Growth Rate Analysis — How Fast Can the Company Grow?</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 14px 0;line-height:1.6">We blend three different growth estimates to get a balanced projection. Historical growth shows what happened. Sustainable growth shows what's theoretically possible. The final blended rate fades toward GDP growth over 10 years (companies can't grow faster than the economy forever).</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="padding:14px;border-radius:10px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.15)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">📊 Historical Growth (40% weight)</div><div style="font-size:20px;font-weight:800;color:var(--blue)">${_pct(histGrowth*100)}</div><div style="font-size:9px;color:var(--text3);margin-top:4px">Revenue: ${_pct(rg)} · Earnings: ${_pct(eg)} · Quarterly: ${_pct(eqg)}</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">🔄 Sustainable Growth (30% weight)</div><div style="font-size:20px;font-weight:800;color:var(--purple)">${_pct(sustainGrowth*100)}</div><div style="font-size:9px;color:var(--text3);margin-top:4px">ROE × (1 - Payout Ratio) = ${roe.toFixed(1)}% × ${(100-payout).toFixed(0)}%</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(16,185,129,.06);border:2px solid rgba(16,185,129,.3)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">🎯 Blended Growth Used in Model</div><div style="font-size:24px;font-weight:900;color:#10b981">${_pct(blendedGrowth*100)}</div><div style="font-size:9px;color:var(--text3);margin-top:4px">Years 1-5 at full rate, then fades to ${(terminalGrowth*100).toFixed(1)}% by Year 10</div></div>
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid var(--amber);margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:var(--amber)">💡 Growth Rate in Plain English:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">${blendedGrowth>0.20?'A blended growth rate of '+(blendedGrowth*100).toFixed(0)+'% is VERY HIGH — the company is expected to grow its cash flows aggressively. Think of it like a startup doubling revenue year after year. This is exciting but risky — if growth slows even slightly, the intrinsic value drops significantly. High growth also fades faster in our model (we assume no company can grow faster than the economy forever), so Years 6-10 will show declining growth rates.':blendedGrowth>0.10?'A blended growth rate of '+(blendedGrowth*100).toFixed(0)+'% is SOLID — the company is expected to grow meaningfully above inflation. Like a well-run business that keeps gaining market share. This rate is sustainable for many established companies and gives good confidence in the projections.':blendedGrowth>0.05?'A blended growth rate of '+(blendedGrowth*100).toFixed(0)+'% is MODEST — the company is growing, but slowly. Think of a mature business in a stable industry. Returns will come primarily from current earnings rather than future growth. Good for income investors, less exciting for growth seekers.':'Growth below 5% suggests the company is BARELY GROWING. This could mean a mature industry, competitive pressures, or cyclical downturn. The DCF value will be heavily driven by current cash flows, not future expansion.'}<br><br><strong>Why we blend 3 methods:</strong> Historical growth shows the track record. Sustainable growth (ROE × retention) shows theoretical capacity. We blend them because no single method is reliable alone — a company with 30% historical growth but 12% sustainable growth is likely to slow down.</div>
</div>

<!-- ═══ SECTION 5: 10-YEAR PROJECTION TABLE ═══ -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">📅 ${projYears}-Year FCF Projections</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 10px 0">Growth rate fades from ${(blendedGrowth*100).toFixed(1)}% to ${(terminalGrowth*100).toFixed(1)}% after Year 5 (companies can't grow faster than GDP forever)</p>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Year</th><th>Growth Rate</th><th>Projected FCF</th><th>Discount Factor</th><th>Present Value</th><th>Cumulative PV</th></tr>
<tr style="background:rgba(59,130,246,.04)"><td style="font-weight:700;color:var(--text3)">Base (Today)</td><td>—</td><td style="font-weight:700">${_fn(baseFCF)}</td><td>1.000</td><td style="font-weight:700;color:#10b981">${_fn(baseFCF)}</td><td>—</td></tr>`;

let cumPV=0;
projections.forEach(p=>{
cumPV+=p.pv;
const isFade=p.year>fadeStart;
h+=`<tr${isFade?' style="opacity:.85"':''}><td style="font-weight:700;color:${isFade?'var(--amber)':'var(--cyan)'}">Year ${p.year}${isFade?' ↓':''}</td><td style="color:${p.growth>15?'#10b981':p.growth>8?'var(--cyan)':'var(--amber)'}">${p.growth.toFixed(1)}%</td><td style="font-weight:600">${_fn(p.fcf)}</td><td style="color:var(--text3)">${p.discount.toFixed(4)}</td><td style="font-weight:700;color:#10b981">${_fn(p.pv)}</td><td style="font-size:10px;color:var(--text3)">${_fn(cumPV)}</td></tr>`;
});

h+=`<tr style="background:rgba(139,92,246,.06);border-top:2px solid var(--purple)"><td style="font-weight:800;color:var(--purple)">Terminal Value</td><td style="color:var(--text3)">${(terminalGrowth*100).toFixed(1)}% perpetuity</td><td style="font-weight:600">${_fn(termValue)}</td><td style="color:var(--text3)">${(1/Math.pow(1+wacc,projYears)).toFixed(4)}</td><td style="font-weight:800;color:var(--purple)">${_fn(termPV)}</td><td style="font-size:9px;color:var(--text3)">${termPct.toFixed(0)}% of total</td></tr>
<tr style="background:rgba(16,185,129,.06);border-top:2px solid #10b981"><td colspan="2" style="font-weight:800;color:#10b981">Sum of PV (FCF)</td><td colspan="2" style="font-weight:800;color:#10b981">${_fn(totalPV)}</td><td colspan="2" style="font-weight:800;color:#10b981">${(100-termPct).toFixed(0)}% of EV</td></tr>
<tr style="background:rgba(16,185,129,.1);border-top:2px solid #10b981"><td colspan="2" style="font-weight:900;color:#10b981;font-size:12px">Enterprise Value</td><td colspan="4" style="font-weight:900;color:#10b981;font-size:14px">${_fn(enterpriseValue)}</td></tr>
</table></div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 Reading This Table:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">Each row shows what the company is expected to earn in that year, then "discounts" it back to today's value (because ₹100 today is worth more than ₹100 in 5 years). The growth rate ${blendedGrowth>0.15?'starts high at '+(blendedGrowth*100).toFixed(0)+'% then fades — because no company can grow faster than the entire economy forever.':'is moderate at '+(blendedGrowth*100).toFixed(0)+'% and fades gradually.'} The Terminal Value (${termPct.toFixed(0)}% of total) represents ALL cash flows beyond Year ${projYears} — ${termPct>75?'this is quite high, meaning most of the value depends on very long-term assumptions. Be skeptical.':'a reasonable split between near-term and long-term value.'}</div>
</div>

<!-- ═══ SECTION 6: BRIDGE TO EQUITY VALUE ═══ -->
<div style="margin-bottom:20px;padding:16px;border-radius:12px;background:rgba(0,47,108,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px">🔗 Enterprise Value → Equity Value Bridge</div>
<div style="display:grid;grid-template-columns:1fr;gap:6px;max-width:500px">
<div style="display:flex;justify-content:space-between;padding:8px 14px;border-radius:6px;background:rgba(16,185,129,.04)"><span style="font-size:11px;color:var(--text)">Enterprise Value (sum of all PVs)</span><span style="font-size:12px;font-weight:700;color:#10b981">${_fn(enterpriseValue)}</span></div>
<div style="display:flex;justify-content:space-between;padding:8px 14px;border-radius:6px;background:rgba(239,68,68,.04)"><span style="font-size:11px;color:var(--text)">(-) Total Debt</span><span style="font-size:12px;font-weight:700;color:var(--red)">-${_fn(totalDebt)}</span></div>
<div style="display:flex;justify-content:space-between;padding:8px 14px;border-radius:6px;background:rgba(6,182,212,.04)"><span style="font-size:11px;color:var(--text)">(+) Cash & Equivalents</span><span style="font-size:12px;font-weight:700;color:var(--cyan)">+${_fn(totalCash)}</span></div>
<div style="display:flex;justify-content:space-between;padding:10px 14px;border-radius:6px;background:rgba(16,185,129,.08);border:2px solid rgba(16,185,129,.3)"><span style="font-size:12px;font-weight:700;color:#10b981">= Equity Value</span><span style="font-size:14px;font-weight:900;color:#10b981">${_fn(equityValue)}</span></div>
<div style="display:flex;justify-content:space-between;padding:8px 14px;border-radius:6px;background:rgba(0,47,108,.02)"><span style="font-size:11px;color:var(--text)">÷ Shares Outstanding</span><span style="font-size:12px;font-weight:700;color:var(--text)">${(shares/1e6).toFixed(1)}M</span></div>
<div style="display:flex;justify-content:space-between;padding:10px 14px;border-radius:6px;background:rgba(16,185,129,.12);border:2px solid #10b981"><span style="font-size:13px;font-weight:800;color:#10b981">= Intrinsic Value per Share</span><span style="font-size:18px;font-weight:900;color:#10b981">${sym}${intrinsicPrice.toFixed(2)}</span></div>
</div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 In Simple Terms:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">Think of Enterprise Value as the total price tag of the entire business. But you don't want the debt — so we subtract it. And the cash on hand is a bonus — so we add it. What's left is the Equity Value — the true worth belonging to shareholders. Divided by the number of shares, that's YOUR fair price per share: <strong style="color:#10b981">${sym}${intrinsicPrice.toFixed(2)}</strong>. ${marginOfSafety>=15?'Since the market is charging only '+sym+price.toFixed(0)+', you\'re getting a bargain.':marginOfSafety>=-5?'The market price of '+sym+price.toFixed(0)+' is close to this — fair deal.':'The market is charging '+sym+price.toFixed(0)+' which is MORE than our calculated value — you\'d be overpaying.'}</div>
</div>

<!-- ═══ SECTION 7: SENSITIVITY ANALYSIS ═══ -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">🎯 Sensitivity Analysis — How Assumptions Change the Value</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 10px 0">The highlighted cell is the base case. Green = undervalued at that scenario. Red = overvalued. Small changes in WACC and terminal growth significantly impact fair value — this is why DCF is a guide, not a precise number.</p>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th style="background:rgba(139,92,246,.08)">Terminal Growth ↓ \\ WACC →</th>${waccSteps.map(w=>`<th style="color:${Math.abs(w)<0.001?'#10b981':'var(--text3)'};font-size:10px;${Math.abs(w)<0.001?'background:rgba(16,185,129,.06)':''}">${((wacc+w)*100).toFixed(1)}%${Math.abs(w)<0.001?' ★':''}</th>`).join('')}</tr>
${sensRows}
</table></div>
<div style="font-size:9px;color:var(--text3);margin-top:6px">★ = current base case assumption. CMP: ${sym}${price.toFixed(0)}</div>
<div style="padding:12px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple);margin-top:10px">
<div style="font-size:11px;font-weight:700;color:var(--purple)">💡 How to Read This:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">This table answers: "What if I'm wrong?" Each cell shows the fair value under different assumptions. The ★ cell is our base case. <strong>If most cells are GREEN (above current price)</strong>, the stock looks undervalued even with pessimistic assumptions — that's a strong signal. <strong>If most cells are RED</strong>, you need very optimistic assumptions to justify the price — that's risky. The wider the range of green cells, the higher your margin of safety.</div>
</div>
</div>

<!-- ═══ SECTION 8: RELATIVE VALUATION CROSS-CHECK ═══ -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(139,92,246,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">⚖️ Cross-Check: Relative Valuation Methods</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 14px 0">DCF gives one perspective. Here's what other valuation methods suggest. When multiple methods agree, the signal is stronger.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
${[
{method:'DCF (This Model)',val:intrinsicPrice,note:'Present value of future cash flows'},
{method:'P/E Based (Sector Avg)',val:peValue,note:`Sector P/E (${_sf(d.sector_avg_pe,20).toFixed(1)}x) × Forward EPS`},
{method:'P/B Based',val:pbValue,note:'Book value × adjusted multiple'},
{method:'PEG Adjusted',val:pegValue,note:'EPS × growth rate fair multiple'},
].map(m=>{
const v=m.val||0;
const vs=price>0&&v>0?((v-price)/price*100):0;
const vc=vs>10?'#10b981':vs>0?'#22d3ee':vs>-10?'var(--amber)':'var(--red)';
return`<div style="padding:14px;border-radius:10px;background:rgba(0,47,108,.02);border:1px solid var(--border)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">${m.method}</div><div style="font-size:22px;font-weight:800;color:${vc};font-family:var(--mono)">${v>0?sym+v.toFixed(0):'N/A'}</div><div style="font-size:9px;color:${vc};margin-top:2px">${v>0?(vs>=0?'+':'')+vs.toFixed(0)+'% vs CMP':'Insufficient data'}</div><div style="font-size:8px;color:var(--text3);margin-top:4px">${m.note}</div></div>`;
}).join('')}
</div>
<div style="margin-top:12px;padding:12px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple)">
<div style="font-size:11px;font-weight:700;color:var(--purple)">💡 Why Multiple Methods Matter:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">No single valuation method is perfect — each has blind spots. When 3 out of 4 methods agree the stock is undervalued, that's a much stronger signal than just one method. Think of it like getting a second and third opinion from different doctors — if they all say the same thing, you can be more confident in the diagnosis.</div>
</div>
</div>

<!-- ═══ SECTION 9: VALUATION GAUGE ═══ -->
<div style="padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.03),rgba(59,130,246,.03));border:1px solid var(--border);margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">📊 Where Does the Stock Sit?</div>
<div style="position:relative;height:36px;background:linear-gradient(to right,#10b981 0%,#22d3ee 25%,#f59e0b 50%,#f97316 75%,#ef4444 100%);border-radius:18px;overflow:visible;margin:0 8px">
<div style="position:absolute;top:-8px;bottom:-8px;width:4px;background:#fff;left:${Math.min(96,Math.max(4,price/(intrinsicPrice*2||1)*100))}%;border-radius:2px;box-shadow:0 0 12px rgba(255,255,255,.9),0 0 4px rgba(0,0,0,.5)"></div>
</div>
<div style="display:flex;justify-content:space-between;margin:6px 8px 0;font-size:8px;color:var(--text3)">
<span>Deep Value<br>${sym}${(intrinsicPrice*0.5).toFixed(0)}</span>
<span>Undervalued<br>${sym}${(intrinsicPrice*0.75).toFixed(0)}</span>
<span>Fair Value<br>${sym}${intrinsicPrice.toFixed(0)}</span>
<span>Overvalued<br>${sym}${(intrinsicPrice*1.25).toFixed(0)}</span>
<span>Expensive<br>${sym}${(intrinsicPrice*1.5).toFixed(0)}</span>
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(6,182,212,.04);border-left:3px solid var(--cyan);margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:var(--cyan)">💡 Reading the Valuation Gauge:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">${marginOfSafety>=25?'The gauge shows DEEP VALUE territory ('+marginOfSafety.toFixed(0)+'% margin of safety). This is like finding a ₹100 note selling for ₹'+Math.round(100-marginOfSafety)+'. Benjamin Graham, the father of value investing, recommended buying with at least a 25% margin of safety — this stock meets that bar. Even if our assumptions are somewhat wrong, you likely won\'t lose money.':marginOfSafety>=10?'The gauge shows MODERATE UNDERVALUATION ('+marginOfSafety.toFixed(0)+'% margin of safety). There\'s a cushion between market price and fair value, but it\'s not huge. A small change in assumptions could make this fairly valued. Decent entry point but not a screaming bargain.':marginOfSafety>=-10?'The gauge shows FAIR VALUE territory. The market price is roughly equal to our calculated intrinsic value. At this level, future returns will depend entirely on the company\'s actual business performance. No valuation tailwind to help you.':'The gauge shows the stock is OVERVALUED by '+Math.abs(marginOfSafety).toFixed(0)+'%. The market is charging more than our model says it\'s worth. This doesn\'t mean the stock will crash — the market may be right about future growth that our model misses — but you\'re buying with no margin of safety. Any negative surprise could mean losses.'}</div>
</div>

<!-- ═══ SECTION 10: KEY RISKS TO THIS VALUATION ═══ -->
<div style="margin-bottom:20px;padding:16px;border-radius:12px;border-left:4px solid var(--amber);background:rgba(245,158,11,.03)">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--amber);margin-bottom:8px">⚠️ Key Risks to This Valuation</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px;font-size:10px;color:var(--text2);line-height:1.7">
<div style="padding:8px 10px;border-radius:6px;background:rgba(245,158,11,.03)">🔸 <strong>Terminal Value = ${termPct.toFixed(0)}%</strong> of enterprise value. ${termPct>70?'This is HIGH — most of the value depends on very long-term assumptions that are inherently uncertain.':'This is reasonable — near-term cash flows contribute meaningfully.'}</div>
<div style="padding:8px 10px;border-radius:6px;background:rgba(245,158,11,.03)">🔸 <strong>Growth assumption of ${(blendedGrowth*100).toFixed(1)}%</strong> ${blendedGrowth>0.2?'is aggressive — if growth slows, intrinsic value drops significantly.':'is conservative, providing a buffer.'}</div>
<div style="padding:8px 10px;border-radius:6px;background:rgba(245,158,11,.03)">🔸 <strong>WACC of ${(wacc*100).toFixed(1)}%</strong> assumes current risk profile persists. If beta increases or rates rise, WACC goes up and value goes down.</div>
<div style="padding:8px 10px;border-radius:6px;background:rgba(245,158,11,.03)">🔸 <strong>DCF models are NOT price targets.</strong> They show a range of plausible values. Use the sensitivity table to understand how much the value changes under different scenarios.</div>
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(239,68,68,.04);border-left:3px solid var(--red);margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:var(--red)">💡 What These Risks Mean for You:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">Every valuation is based on ASSUMPTIONS, and assumptions can be wrong. The biggest risk in any DCF is the <strong>Terminal Value</strong> — it represents cash flows stretching to infinity, which nobody can predict. ${termPct>70?'In this case, terminal value is '+termPct.toFixed(0)+'% of total value — meaning most of our valuation depends on what happens AFTER Year 10. That\'s inherently unreliable.':'Terminal value is a reasonable '+termPct.toFixed(0)+'% here.'}<br><br><strong>Practical advice:</strong> Use this DCF as ONE input, not the only one. Compare it with P/E valuations, peer comparisons, and your own judgment about the business. If the DCF says "buy" but the business model is deteriorating, trust the business reality over the spreadsheet. Warren Buffett says: "It is better to be approximately right than precisely wrong."</div>
</div>

<!-- FINAL DCF VERDICT FOR BEGINNERS -->
<div style="padding:18px;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(59,130,246,.04));border:2px solid rgba(16,185,129,.15);margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:#10b981;margin-bottom:10px">📋 Complete DCF Verdict — Everything Summarized</div>
<div style="font-size:11px;color:var(--text);line-height:2">
<strong>The Simple Version:</strong> We calculated that ${name} is worth <strong style="color:#10b981">${sym}${intrinsicPrice.toFixed(0)}</strong> per share based on the cash it generates (${_fn(baseFCF)}/year), growing at ${(blendedGrowth*100).toFixed(0)}% annually for the next 10 years. The market is currently selling it at <strong style="color:var(--cyan)">${sym}${price.toFixed(0)}</strong>. ${marginOfSafety>=20?'That\'s a '+marginOfSafety.toFixed(0)+'% DISCOUNT — like buying a ₹100 note for ₹'+Math.round(100-marginOfSafety)+'. This is a significant margin of safety.':marginOfSafety>=0?'That\'s roughly FAIR VALUE with a small '+marginOfSafety.toFixed(0)+'% cushion. Not a screaming bargain, but you\'re not overpaying.':'That\'s a '+Math.abs(marginOfSafety).toFixed(0)+'% PREMIUM — you\'re paying more than our model says it\'s worth. The market may be right about future growth that our model underestimates, or it could be overpriced.'}<br><br>
<strong>Confidence Level:</strong> ${termPct<65&&blendedGrowth<0.2&&beta<1.5?'🟢 HIGH — The model assumptions are conservative (moderate growth, reasonable terminal value), making this valuation relatively reliable.':termPct<75&&blendedGrowth<0.25?'🟡 MODERATE — Some assumptions are aggressive. The sensitivity table above shows how the value changes under different scenarios. Trust the RANGE more than the single number.':'🔴 LOW — The model relies heavily on long-term assumptions (terminal value = '+termPct.toFixed(0)+'% of total). Small changes in growth or WACC dramatically change the result. Use this as a rough guide only.'}<br><br>
<strong>What Would Warren Buffett Do?</strong> ${marginOfSafety>=25?'Buffett looks for a 25%+ margin of safety. This stock qualifies. He would examine the business moat (does it have a durable competitive advantage?), management integrity, and predictability of cash flows before buying.':marginOfSafety>=10?'Buffett prefers 25%+ margin of safety. This stock is close but not quite there. He might wait for a better entry price during a market dip.':'Buffett would likely pass at this price. He said: \"Price is what you pay, value is what you get.\" At the current price, you\'re paying close to (or more than) what you\'re getting.'}<br><br>
<strong>Action Items:</strong><br>
${marginOfSafety>=15?'✅ <strong>Consider buying</strong> — Check the Equity Research tab to verify fundamentals are strong. Use SIP to build position gradually. Set stop-loss at '+sym+(intrinsicPrice*0.7).toFixed(0)+' (30% below intrinsic value as margin of error).':marginOfSafety>=0?'⏳ <strong>Watchlist candidate</strong> — The valuation is fair but not compelling. Set a price alert at '+sym+(intrinsicPrice*0.85).toFixed(0)+' (15% margin of safety) and buy if it drops to that level.':'⚠️ <strong>Wait for better entry</strong> — The stock is priced above our intrinsic value. Either the market knows something we don\'t, or it\'s overpriced. Wait for a correction to '+sym+(intrinsicPrice*0.9).toFixed(0)+' before considering.'}
</div>
</div>

<!-- ═══ DISCLAIMER ═══ -->
<div style="padding:12px 14px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12)">
<div style="font-size:9px;color:var(--text3);line-height:1.6">
<strong style="color:var(--amber)">📋 Model Assumptions:</strong> Risk-free: ${(riskFree*100).toFixed(1)}% · ERP: ${(mktPremium*100)}% · Beta: ${beta.toFixed(2)} · Growth: ${(blendedGrowth*100).toFixed(1)}% (fading to ${(terminalGrowth*100).toFixed(1)}%) · WACC: ${(wacc*100).toFixed(2)}% · Tax: ${(taxRate*100).toFixed(0)}% · Horizon: ${projYears}Y · ${reportedFCF?'FCF: Reported':'FCF: Estimated'}<br>
<strong style="color:var(--amber)">⚖️ Disclaimer:</strong> This DCF analysis is auto-generated for <strong>educational purposes only</strong>. Small changes in assumptions significantly impact results. This is NOT investment advice. Always consult a qualified financial advisor. Celesys AI is not registered with SEBI or any regulatory body.
</div>
</div>`;

el.innerHTML=h;
console.log('✅ DCF rendered:',sym+intrinsicPrice.toFixed(2),'MOS:'+marginOfSafety.toFixed(1)+'%','WACC:'+((wacc*100).toFixed(2))+'%');
}


// ═══════════════════════════════════════════════
// ═══ EQUITY RESEARCH REPORT ═══
// ═══════════════════════════════════════════════
function renderEquityResearch(d,report,fundData){
const el=document.getElementById('equityContent');
if(!el||!d)return;
const _sf=(v,def=0)=>{if(v===null||v===undefined||v==='N/A'||v==='')return def;const n=parseFloat(String(v).replace(/[,%]/g,''));return isNaN(n)?def:n};
const sym=d.currency==='INR'?'₹':'$';
const price=_sf(d.current_price);
const mcap=_sf(d.market_cap);
const pe=_sf(d.pe_ratio);
const pm=_sf(d.profit_margin);
const om=_sf(d.operating_margin);
const roe=_sf(d.roe);
const de=_sf(d.debt_to_equity);
const beta=_sf(d.beta,1);
const eg=_sf(d.earnings_growth);
const rg=_sf(d.revenue_growth);
const divY=_sf(d.dividend_yield);
const w52h=_sf(d.week52_high,price*1.2);
const w52l=_sf(d.week52_low,price*0.8);
const cr=_sf(d.current_ratio,1.5);
const qr=_sf(d.quick_ratio,1);
const bv=_sf(d.book_value);
const eps=_sf(d.eps_ttm);
const epsF=_sf(d.eps_forward);
const peg=_sf(d.peg_ratio);
const rps=_sf(d.revenue_per_share);
const shortR=_sf(d.short_ratio);
const payout=_sf(d.payout_ratio);
const eqg=_sf(d.earnings_quarterly_growth);
const ebitda=_sf(d.ebitda);
const totalCash=_sf(d.total_cash);
const totalDebt=_sf(d.total_debt);
const sAvgPE=_sf(d.sector_avg_pe,20);
const pb=_sf(d.pb_ratio||d.price_to_book);
const w52pos=w52h!==w52l?((price-w52l)/(w52h-w52l)*100):50;
const sector=d.sector||'Unknown';
const industry=d.industry||'Unknown';
const name=d.company_name||d.ticker||'Company';
const ticker=d.ticker||'';
const today=new Date().toLocaleDateString('en-IN',{year:'numeric',month:'long',day:'numeric'});
const isIndian=d.currency==='INR';
const _fn=(n)=>{if(!n||n===0)return'N/A';const a=Math.abs(n);const s=n<0?'-':'';if(a>=1e12)return s+sym+(a/1e12).toFixed(2)+'T';if(a>=1e9)return s+sym+(a/1e9).toFixed(2)+'B';if(a>=1e7&&isIndian)return s+sym+(a/1e7).toFixed(2)+'Cr';if(a>=1e5&&isIndian)return s+sym+(a/1e5).toFixed(2)+'L';return s+sym+a.toLocaleString(undefined,{maximumFractionDigits:0})};
const _pct=(n)=>n!==0&&!isNaN(n)?(n>=0?'+':'')+n.toFixed(1)+'%':'N/A';
const sma20=_sf(d.sma_20);
const sma50=_sf(d.sma_50);
const sma200=_sf(d.sma_200);
const shares=mcap>0&&price>0?Math.round(mcap/price):0;

// Rating logic
let rating='HOLD',ratingColor='var(--amber)',ratingBg='rgba(245,158,11,.1)';
const score=_sf(d.verdict_score,50);
if(score>=70){rating='BUY';ratingColor='var(--green)';ratingBg='rgba(16,185,129,.1)'}
else if(score>=55){rating='ACCUMULATE';ratingColor='#22d3ee';ratingBg='rgba(6,182,212,.08)'}
else if(score<=30){rating='SELL';ratingColor='var(--red)';ratingBg='rgba(239,68,68,.1)'}
else if(score<=40){rating='REDUCE';ratingColor='#f97316';ratingBg='rgba(249,115,22,.08)'}

// Target price from verdict
const targetUp=price*1.15;
const targetDown=price*0.88;
const target12m=score>=60?targetUp:score>=45?price*1.05:targetDown;

// Risk level
const riskScore=Math.round((de>200?30:de>100?20:10)+(beta>1.5?25:beta>1?15:5)+(pm<0?20:pm<5?10:0));
const riskLevel=riskScore>=50?'HIGH':riskScore>=25?'MODERATE':'LOW';
const riskColor=riskScore>=50?'var(--red)':riskScore>=25?'var(--amber)':'var(--green)';

// Peers
let peerRows='';
if(d.peers&&d.peers.length>0){
d.peers.forEach((p,i)=>{
peerRows+=`<tr><td style="font-weight:600;font-size:11px">${p.name||p.ticker}</td><td style="font-family:var(--mono);font-size:11px">${p.ticker}</td><td style="color:var(--cyan);font-weight:700">${p.pe||'N/A'}</td><td>${p.margin||'N/A'}</td><td>${p.growth||'N/A'}</td></tr>`;
});
}

let h=`
<!-- RESEARCH REPORT HEADER -->
<div style="background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 50%,#0d1117 100%);border-radius:14px;padding:24px 28px;margin-bottom:20px;position:relative;overflow:hidden">
<div style="position:absolute;top:0;right:0;width:200px;height:200px;background:radial-gradient(circle,rgba(217,119,6,.15),transparent 70%)"></div>
<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;position:relative">
<div>
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.4);margin-bottom:4px">CELESYS AI · EQUITY RESEARCH</div>
<div style="font-size:24px;font-weight:800;color:#fff;font-family:'Sora',sans-serif;margin-bottom:2px">${name}</div>
<div style="font-size:13px;color:rgba(255,255,255,.6)">${ticker} · ${sector} · ${industry}</div>
<div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:4px">${today}</div>
</div>
<div style="text-align:center">
<div style="font-size:10px;letter-spacing:1px;color:rgba(255,255,255,.4);margin-bottom:4px">RATING</div>
<div style="display:inline-block;padding:8px 24px;border-radius:8px;background:${ratingBg};border:2px solid ${ratingColor}">
<div style="font-size:22px;font-weight:800;color:${ratingColor};letter-spacing:2px">${rating}</div>
</div>
<div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:6px">Target: ${sym}${target12m.toFixed(0)} (${((target12m-price)/price*100).toFixed(1)}%)</div>
</div>
</div>
<!-- Price Bar -->
<div style="display:flex;gap:20px;margin-top:16px;flex-wrap:wrap">
<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,.35)">CMP</div><div style="font-size:20px;font-weight:800;color:#fff;font-family:var(--mono)">${sym}${price.toFixed(2)}</div></div>
<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,.35)">MARKET CAP</div><div style="font-size:16px;font-weight:700;color:#22d3ee">${_fn(mcap)}</div></div>
<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,.35)">P/E</div><div style="font-size:16px;font-weight:700;color:#f59e0b">${pe.toFixed(1)}x</div></div>
<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,.35)">ROE</div><div style="font-size:16px;font-weight:700;color:#10b981">${roe.toFixed(1)}%</div></div>
<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,.35)">BETA</div><div style="font-size:16px;font-weight:700;color:${beta>1.3?'#ef4444':'#10b981'}">${beta.toFixed(2)}</div></div>
<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,.35)">RISK</div><div style="font-size:14px;font-weight:700;color:${riskColor};padding:2px 10px;border-radius:4px;background:rgba(255,255,255,.05)">${riskLevel}</div></div>
</div>
</div>

<!-- AI Prediction Signal -->
${(()=>{
if(!price)return '';
const s20=_sf(d.sma_20,price);const s50=_sf(d.sma_50,price);const s200_=_sf(d.sma_200,price);
const h52=_sf(d['52w_high'],price*1.15);const l52=_sf(d['52w_low'],price*0.85);
let sc=0;
if(price>s20)sc+=8;else sc-=8;if(price>s50)sc+=10;else sc-=10;if(price>s200_)sc+=12;else sc-=12;
const r52=h52-l52;const pos=r52>0?((price-l52)/r52):0.5;
sc+=pos>0.8?-10:pos>0.6?5:pos>0.4?15:pos>0.2?10:-5;
if(pe>0&&sAvgPE>0){const vr=pe/sAvgPE;sc+=vr<0.7?20:vr<0.9?12:vr<1.1?5:vr<1.3?-8:-18;}
const rg=_sf(d.revenue_growth);const eg_=_sf(d.earnings_growth);
if(rg>20)sc+=8;else if(rg>10)sc+=4;else if(rg<0)sc-=6;
if(eg_>20)sc+=7;else if(eg_>10)sc+=3;else if(eg_<0)sc-=6;
if(roe>20)sc+=5;else if(roe<5)sc-=4;
if(de<50)sc+=5;else if(de>200)sc-=5;
sc=Math.max(-100,Math.min(100,sc));
const ar=sc/100*0.4;const t1y=price*(1+ar);const up1y=(t1y-price)/price*100;
const sig=sc>30?'BULLISH':sc>10?'MILDLY BULLISH':sc>-10?'NEUTRAL':sc>-30?'MILDLY BEARISH':'BEARISH';
const sC=sc>30?'#10b981':sc>10?'#22c55e':sc>-10?'#f59e0b':sc>-30?'#f97316':'#ef4444';
const em=sc>10?'🟢':sc>-10?'🟡':'🔴';
return `<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:12px 16px;border-radius:10px;background:rgba(0,47,108,.03);border:1px solid ${sC}40;margin:12px 0 16px">
<div style="font-size:11px;color:var(--text3)">🔮 <strong>AI Prediction:</strong></div>
<div style="font-size:12px;font-weight:800;color:${sC}">${em} ${sig}</div>
<div style="font-size:10px;color:var(--text3)">1Y Target: <strong style="color:${sC}">${sym}${t1y.toFixed(0)}</strong> (${up1y>=0?'+':''}${up1y.toFixed(1)}%)</div>
<div style="font-size:10px;color:var(--text3)">Algo Score: <strong style="color:${sC}">${sc>0?'+':''}${sc}/100</strong></div>
</div>`;
})()}

<!-- EXECUTIVE SUMMARY -->
<div style="margin-bottom:20px;padding:18px;border-radius:10px;border-left:4px solid #d97706;background:rgba(217,119,6,.04)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#d97706;margin-bottom:8px">&#128221; Executive Summary</div>
<p style="font-size:12px;color:var(--text);line-height:1.8;margin:0">
${name} (${ticker}) is a ${_fn(mcap)} market cap company in the ${industry} sector, currently trading at ${sym}${price.toFixed(2)}. 
${pe>0&&pe<sAvgPE*0.85?'The stock appears undervalued at '+pe.toFixed(1)+'x P/E versus the sector average of '+sAvgPE.toFixed(1)+'x, suggesting a potential re-rating opportunity.':pe>sAvgPE*1.15?'Trading at a premium '+pe.toFixed(1)+'x P/E versus sector average '+sAvgPE.toFixed(1)+'x, the stock prices in strong growth expectations.':'At '+pe.toFixed(1)+'x P/E, the stock is fairly valued relative to its sector average of '+sAvgPE.toFixed(1)+'x.'}
${pm>15?'Strong profitability with '+pm.toFixed(1)+'% net margins provides a competitive moat.':pm>5?'Moderate profitability at '+pm.toFixed(1)+'% net margins with room for expansion.':'Thin margins of '+pm.toFixed(1)+'% suggest competitive pressure or investment phase.'}
${roe>15?'Return on equity of '+roe.toFixed(1)+'% demonstrates efficient capital allocation.':''}
${eg>10?'Earnings growth of '+eg.toFixed(1)+'% signals accelerating momentum.':''}
We rate ${name} <strong style="color:${ratingColor}">${rating}</strong> with a 12-month target of ${sym}${target12m.toFixed(0)} (${((target12m-price)/price*100).toFixed(1)}% ${target12m>price?'upside':'downside'}).
</p>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(6,182,212,.04);border-left:3px solid var(--cyan);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--cyan)">💡 How to Read This Report:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">This equity research report mimics what professional Wall Street analysts produce. Each section below examines the stock from a different angle — financials, valuation, risk, technicals, cash flow, balance sheet, growth, dividends, and more. <strong>No single section tells the whole story.</strong> A stock can have great growth but terrible debt, or cheap valuation but declining margins. Read ALL sections and look for the overall pattern. The Investment Checklist at the end distills everything into a simple pass/fail score, and the SWOT Analysis ties it all together.</div>
</div>

<!-- COLOR LEGEND -->
<div style="padding:14px;border-radius:8px;background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.1);margin:8px 0 16px">
<div style="font-size:10px;font-weight:700;color:var(--blue);margin-bottom:6px">🎨 Reading the Colors & Grades in This Report</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:6px;font-size:9px;color:var(--text2);line-height:1.6">
<div><span style="color:#10b981;font-weight:700">● GREEN numbers</span> = Strong/Positive — the metric is healthy and exceeds typical benchmarks. Think of it like scoring 80%+ on an exam.</div>
<div><span style="color:#f59e0b;font-weight:700">● AMBER numbers</span> = Average/Caution — the metric is acceptable but not outstanding. Like scoring 50-70% — room for improvement.</div>
<div><span style="color:#ef4444;font-weight:700">● RED numbers</span> = Weak/Warning — the metric is below acceptable levels. Like scoring below 40% — needs attention before investing.</div>
<div><span style="color:var(--cyan);font-weight:700">● CYAN numbers</span> = Informational — neutral metrics shown for context, like market cap or current price.</div>
<div><span style="font-weight:700">Grade A</span> = Excellent (top 20%) · <span style="font-weight:700">B</span> = Good (top 40%) · <span style="font-weight:700">C</span> = Average · <span style="font-weight:700">D</span> = Poor (bottom 30%)</div>
<div><span style="font-weight:700">✅ = Pass</span> (meets the criteria) · <span style="font-weight:700">❌ = Fail</span> (doesn't meet) — used in the Investment Checklist section</div>
</div>
</div>

<!-- FINANCIAL HIGHLIGHTS -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">&#128202; Financial Snapshot</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
${[
{l:'Revenue',v:_fn(_sf(d.revenue)),c:'var(--blue)'},
{l:'Market Cap',v:_fn(mcap),c:'var(--cyan)'},
{l:'P/E Ratio',v:pe>0?pe.toFixed(1)+'x':'N/A',c:pe<sAvgPE?'var(--green)':'var(--amber)'},
{l:'P/B Ratio',v:pb>0?pb.toFixed(2)+'x':'N/A',c:pb<3?'var(--green)':'var(--amber)'},
{l:'Net Margin',v:pm.toFixed(1)+'%',c:pm>15?'var(--green)':pm>5?'var(--amber)':'var(--red)'},
{l:'Operating Margin',v:om.toFixed(1)+'%',c:om>20?'var(--green)':'var(--amber)'},
{l:'ROE',v:roe.toFixed(1)+'%',c:roe>15?'var(--green)':'var(--amber)'},
{l:'Debt/Equity',v:de.toFixed(0)+'%',c:de<50?'var(--green)':de<150?'var(--amber)':'var(--red)'},
{l:'Earnings Growth',v:eg!==0?eg.toFixed(1)+'%':'N/A',c:eg>10?'var(--green)':eg>0?'var(--amber)':'var(--red)'},
{l:'Revenue Growth',v:rg!==0?rg.toFixed(1)+'%':'N/A',c:rg>10?'var(--green)':'var(--amber)'},
{l:'Dividend Yield',v:divY>0?divY.toFixed(2)+'%':'—',c:divY>2?'var(--green)':'var(--text3)'},
{l:'Beta',v:beta.toFixed(2),c:beta>1.3?'var(--red)':beta>0.8?'var(--amber)':'var(--green)'}
].map(m=>`<div style="padding:10px 12px;border-radius:8px;background:rgba(0,47,108,.02);border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text3)">${m.l}</span><span style="font-size:14px;font-weight:700;color:${m.c};font-family:var(--mono)">${m.v}</span></div>`).join('')}
</div>
<div style="padding:12px;border-radius:8px;background:rgba(6,182,212,.04);border-left:3px solid var(--cyan);margin-top:12px">
<div style="font-size:11px;font-weight:700;color:var(--cyan)">💡 Reading These Numbers:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">${pe>0&&pe<15?'P/E of '+pe.toFixed(1)+'x is LOW — the market expects slow growth or is ignoring hidden value. Could be a bargain if fundamentals are solid.':pe>0&&pe<25?'P/E of '+pe.toFixed(1)+'x is REASONABLE — you are paying a fair price for the company\'s earnings. Not a screaming deal, not overpriced.':pe>=25?'P/E of '+pe.toFixed(1)+'x is HIGH — you are paying a premium. This is justified ONLY if the company can deliver strong growth. If growth disappoints, the stock could fall significantly.':'P/E not available (negative earnings). Focus on revenue growth and path to profitability.'} ${roe>18?'ROE of '+roe.toFixed(0)+'% is excellent — management turns every ₹100 of shareholder money into ₹'+roe.toFixed(0)+' of profit annually.':roe>10?'ROE of '+roe.toFixed(0)+'% is decent but not exceptional.':'ROE below 10% suggests the company struggles to generate strong returns on capital.'}</div>
</div>
</div>

<!-- COMBINED HEALTH INFERENCE -->
<div style="padding:12px;border-radius:8px;background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(6,182,212,.03));border:1px dashed rgba(16,185,129,.2);margin-top:8px">
<div style="font-size:10px;font-weight:700;color:#10b981;margin-bottom:4px">📖 What These Numbers Mean Together (The Big Picture):</div>
<div style="font-size:9px;color:var(--text2);line-height:1.8">
Think of a company like a restaurant:<br>
• <strong>Revenue (${_fn(mcap&&pe>0?mcap/pe*pe:0)||'N/A'})</strong> = How many customers walk in (total sales)<br>
• <strong>Net Margin (${pm.toFixed(1)}%)</strong> = How much profit you keep per ₹100 of sales. ${pm>15?'At '+pm.toFixed(0)+'%, this restaurant keeps ₹'+pm.toFixed(0)+' from every ₹100 bill — that\'s a well-run business with pricing power.':pm>5?'At '+pm.toFixed(0)+'%, the profit per customer is modest. Like a busy restaurant with thin margins — volume matters.':'Very thin margins — like a discount food stall. Lots of sales needed just to break even.'}<br>
• <strong>ROE (${roe.toFixed(1)}%)</strong> = Return on your investment. ${roe>20?'Investing ₹1L in this business generates ₹'+((roe/100)*100000).toFixed(0)+'/year in profit — that\'s EXCELLENT.':roe>12?'Decent returns, similar to a good rental property yield.':'Below a fixed deposit return — management isn\'t using your money efficiently.'}<br>
• <strong>Debt/Equity (${de.toFixed(0)}%)</strong> = How much the restaurant is financed by loans vs owner\'s money. ${de<30?'Almost no debt — the business runs on its own profits. Very safe.':de<100?'Manageable debt — like a home loan with comfortable EMIs.':'Heavy debt — like running the restaurant on credit cards. Risky in bad times.'}<br>
• <strong>Beta (${beta.toFixed(2)})</strong> = How wild the stock swings. ${beta>1.3?'A roller coaster — when the market moves 10%, this stock moves '+(beta*10).toFixed(0)+'%. Not for the faint-hearted.':beta>0.8?'Moves roughly in line with the market — standard risk.':'More stable than the market — defensive choice for conservative investors.'}<br>
<strong style="color:var(--text)">Overall health score: ${pm>15&&roe>15&&de<80?'⭐⭐⭐⭐⭐ STRONG — The business is profitable, well-managed, and conservatively financed. A quality company.':pm>8&&roe>10&&de<150?'⭐⭐⭐⭐ GOOD — Solid fundamentals with some room for improvement. A reasonable investment candidate.':pm>0&&roe>5?'⭐⭐⭐ AVERAGE — The company works but doesn\'t excel in any area. Invest only if the price is attractive.':'⭐⭐ BELOW AVERAGE — Multiple fundamental weaknesses. Higher risk investment — proceed with caution.'}</strong>
</div>
</div>

<!-- 52-WEEK POSITION -->
<div style="margin-bottom:20px;padding:14px;border-radius:10px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px">&#128200; 52-Week Price Position</div>
<div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
<span style="font-size:10px;color:var(--red);font-weight:700;min-width:70px">${sym}${w52l.toFixed(0)}</span>
<div style="flex:1;height:8px;background:linear-gradient(to right,var(--red),var(--amber),var(--green));border-radius:4px;position:relative">
<div style="position:absolute;top:-4px;width:16px;height:16px;border-radius:50%;background:#fff;border:3px solid var(--blue);left:${Math.min(95,Math.max(5,w52pos))}%;transform:translateX(-50%)"></div>
</div>
<span style="font-size:10px;color:var(--green);font-weight:700;min-width:70px;text-align:right">${sym}${w52h.toFixed(0)}</span>
</div>
<div style="text-align:center;font-size:10px;color:var(--text3)">Current: ${sym}${price.toFixed(2)} (${w52pos.toFixed(0)}% of range)</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid var(--blue);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--blue)">💡 52-Week Position — What It Tells You:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">${w52pos>85?'The stock is near its YEARLY HIGH ('+w52pos.toFixed(0)+'%). Momentum is strong, but buying at the top means limited upside to previous peak. Consider waiting for a 5-10% dip — history shows most stocks pull back after hitting highs. If you must buy, use a trailing stop-loss.':w52pos>50?'The stock sits in the MIDDLE of its range ('+w52pos.toFixed(0)+'%). This is neutral territory — neither a bargain nor expensive by recent standards. Focus on fundamentals rather than price action to make your decision.':w52pos>20?'The stock has FALLEN significantly from its high ('+w52pos.toFixed(0)+'%). If fundamentals are intact, this could be a buying opportunity — you\'re getting the same business at a lower price. But verify WHY it fell — sometimes cheap stocks are cheap for good reasons.':'Near yearly LOWS ('+w52pos.toFixed(0)+'%). This is either deep value or a value trap. Research thoroughly before buying — falling knives can keep falling, but the biggest winners are often stocks bought near their lows.'}</div>
</div>

<!-- VALUATION COMPARISON -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px">&#128176; Valuation vs Sector</div>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Metric</th><th style="color:var(--cyan)">${name}</th><th>Sector Avg</th><th>Assessment</th></tr>
<tr><td>P/E Ratio</td><td style="font-weight:700;color:var(--cyan)">${pe>0?pe.toFixed(1)+'x':'N/A'}</td><td>${sAvgPE.toFixed(1)}x</td><td style="color:${pe<sAvgPE*0.85?'var(--green)':pe>sAvgPE*1.15?'var(--red)':'var(--amber)'};font-weight:700">${pe<sAvgPE*0.85?'Undervalued':pe>sAvgPE*1.15?'Premium':'Fair Value'}</td></tr>
<tr><td>Net Margin</td><td style="font-weight:700;color:var(--cyan)">${pm.toFixed(1)}%</td><td>~10-15%</td><td style="color:${pm>15?'var(--green)':pm>5?'var(--amber)':'var(--red)'};font-weight:700">${pm>15?'Superior':pm>5?'Adequate':'Below Avg'}</td></tr>
<tr><td>ROE</td><td style="font-weight:700;color:var(--cyan)">${roe.toFixed(1)}%</td><td>~12-15%</td><td style="color:${roe>15?'var(--green)':roe>8?'var(--amber)':'var(--red)'};font-weight:700">${roe>15?'Excellent':roe>8?'Adequate':'Needs Work'}</td></tr>
<tr><td>Debt/Equity</td><td style="font-weight:700;color:var(--cyan)">${de.toFixed(0)}%</td><td>~50-100%</td><td style="color:${de<50?'var(--green)':de<150?'var(--amber)':'var(--red)'};font-weight:700">${de<50?'Conservative':de<150?'Moderate':'Leveraged'}</td></tr>
</table></div>
<div style="padding:10px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid var(--amber);margin-top:10px">
<div style="font-size:11px;font-weight:700;color:var(--amber)">💡 Is the Stock Cheap or Expensive?</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">${pe>0&&pe<sAvgPE*0.85?'Trading at a DISCOUNT to its sector. This could mean: (a) the market is undervaluing it — opportunity, or (b) there\'s a reason it\'s cheap — investigate before buying. Check if margins and growth justify a re-rating.':pe>sAvgPE*1.15?'Trading at a PREMIUM to its sector. The market believes this company is better than average. You\'re paying extra for perceived quality. The risk: if growth disappoints even slightly, the stock could fall hard as the premium evaporates.':'FAIRLY VALUED relative to its sector. You\'re paying roughly what the market considers appropriate. Returns will come from the company\'s actual business performance, not from a valuation re-rating.'}</div>
</div>
</div>

${peerRows?`
<!-- PEER COMPARISON -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px">&#127942; Peer Comparison</div>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Company</th><th>Ticker</th><th>P/E</th><th>Margin</th><th>Growth</th></tr>
<tr style="background:rgba(6,182,212,.06)"><td style="font-weight:700;color:var(--cyan)">${name}</td><td>${ticker}</td><td style="font-weight:700;color:var(--cyan)">${pe>0?pe.toFixed(1)+'x':'N/A'}</td><td>${pm.toFixed(1)}%</td><td>${eg!==0?eg.toFixed(1)+'%':'N/A'}</td></tr>
${peerRows}
</table></div>
</div>`:''}

<div style="padding:12px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--purple)">💡 Why Peer Comparison Matters:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">Comparing a company to its peers is like comparing athletes in the same sport — you can only judge performance against similar competition. A P/E of 30x might seem expensive, but if every competitor trades at 40x, it could actually be cheap. Look for companies with <strong>higher margins AND lower P/E</strong> than peers — that combination signals the market hasn't recognized their quality yet. Conversely, if a stock has the lowest margins but highest P/E in its peer group, it's likely overvalued.</div>
</div>

<!-- RISK MATRIX -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">&#9888;&#65039; Risk Assessment Matrix</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
${[
{r:'Market Risk',s:beta>1.3?'HIGH':beta>0.8?'MODERATE':'LOW',d:'Beta of '+beta.toFixed(2)+' — '+(beta>1.3?'significantly more volatile than market':beta>0.8?'moves roughly with market':'less volatile than market'),c:beta>1.3?'var(--red)':beta>0.8?'var(--amber)':'var(--green)'},
{r:'Leverage Risk',s:de>150?'HIGH':de>50?'MODERATE':'LOW',d:'D/E of '+de.toFixed(0)+'% — '+(de>150?'high debt increases financial risk':de>50?'moderate leverage is manageable':'conservative balance sheet'),c:de>150?'var(--red)':de>50?'var(--amber)':'var(--green)'},
{r:'Profitability Risk',s:pm<5?'HIGH':pm<15?'MODERATE':'LOW',d:'Net margin of '+pm.toFixed(1)+'% — '+(pm<5?'thin margins leave little room for error':pm<15?'adequate but not exceptional':'strong margins provide buffer'),c:pm<5?'var(--red)':pm<15?'var(--amber)':'var(--green)'},
{r:'Valuation Risk',s:pe>sAvgPE*1.5?'HIGH':pe>sAvgPE?'MODERATE':'LOW',d:'P/E of '+pe.toFixed(1)+'x vs sector '+sAvgPE.toFixed(1)+'x — '+(pe>sAvgPE*1.5?'expensive — correction risk exists':pe>sAvgPE?'slight premium, needs growth delivery':'attractively priced'),c:pe>sAvgPE*1.5?'var(--red)':pe>sAvgPE?'var(--amber)':'var(--green)'}
].map(r=>`<div style="padding:12px;border-radius:8px;border-left:3px solid ${r.c};background:rgba(0,47,108,.02)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:11px;font-weight:700;color:var(--text)">${r.r}</span><span style="font-size:9px;font-weight:700;color:${r.c};padding:2px 8px;border-radius:4px;background:rgba(255,255,255,.03);border:1px solid ${r.c}">${r.s}</span></div><div style="font-size:9px;color:var(--text3);line-height:1.5">${r.d}</div></div>`).join('')}
</div>
<div style="padding:10px;border-radius:8px;background:rgba(239,68,68,.04);border-left:3px solid var(--red);margin-top:12px">
<div style="font-size:11px;font-weight:700;color:var(--red)">💡 Understanding Your Risk:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">Think of risk like weather warnings: LOW = clear skies, you can invest with confidence. MODERATE = some clouds, normal caution. HIGH = storm approaching, smaller position sizes recommended. The most dangerous risks are the ones you don't see — ${de>150?'HIGH DEBT is the biggest concern here. In a recession, heavily indebted companies can go bankrupt while low-debt competitors survive and thrive.':beta>1.5?'HIGH VOLATILITY means this stock swings much more than the market. A 10% market drop could mean 15-20% here. Only invest money you won\'t need for 3+ years.':'the risk profile looks manageable for this stock.'}</div>
</div>

<!-- RISK SCENARIO BOX -->
<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple);margin-top:8px">
<div style="font-size:10px;font-weight:700;color:var(--purple)">📖 What Could Go Wrong? (Worst-Case Scenario)</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">If you invest ${sym}${(100000).toLocaleString()} in ${name} today:<br>
• <strong>In a market crash (-30%):</strong> Your investment drops to ~${sym}${(70000).toLocaleString()}. ${beta>1?'But with beta of '+beta.toFixed(1)+', this stock could fall '+(beta*30).toFixed(0)+'%, making it ~'+sym+(100000*(1-beta*0.3)).toFixed(0)+'.':'With low beta, the fall might be cushioned.'}<br>
• <strong>In a mild correction (-10%):</strong> Drops to ~${sym}${(100000*(1-beta*0.1)).toFixed(0)} (beta-adjusted).<br>
• <strong>Company-specific risk:</strong> ${de>100?'If interest rates rise, this company\'s heavy debt burden becomes more expensive, squeezing profits.':pm<5?'Thin margins mean even a small revenue decline could wipe out profits.':'No critical single-point-of-failure identified from the numbers.'}<br>
<strong style="color:var(--text)">Position sizing tip:</strong> ${riskLevel==='HIGH'?'Maximum 2-3% of your total portfolio. If ₹10L total, invest at most ₹20-30K here.':riskLevel==='MODERATE'?'Comfortable at 3-5% of portfolio. If ₹10L total, invest ₹30-50K.':'Conservative risk profile allows 5-8% of portfolio. If ₹10L total, up to ₹50-80K.'}</div>
</div>
</div>

<!-- TECHNICAL ANALYSIS -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">📉 Technical Analysis — Moving Average Signals</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 12px 0;line-height:1.6">Moving averages smooth out daily noise to reveal the true trend. When price is above the average, the stock is in an uptrend. When it crosses below, it may be weakening.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
${[
{l:'SMA 20 (Short-term)',v:_sf(d.sma_20),tip:'20-day trend — what traders watch',sig:price>_sf(d.sma_20)?'Above ▲':'Below ▼',sigC:price>_sf(d.sma_20)?'#10b981':'#ef4444'},
{l:'SMA 50 (Medium-term)',v:_sf(d.sma_50),tip:'50-day trend — institutional reference',sig:price>_sf(d.sma_50)?'Above ▲':'Below ▼',sigC:price>_sf(d.sma_50)?'#10b981':'#ef4444'},
{l:'SMA 200 (Long-term)',v:_sf(d.sma_200),tip:'200-day trend — the "bull/bear" line',sig:price>_sf(d.sma_200)?'BULLISH ▲':'BEARISH ▼',sigC:price>_sf(d.sma_200)?'#10b981':'#ef4444'},
].map(m=>`<div style="padding:14px;border-radius:10px;background:rgba(0,47,108,.02);border:1px solid var(--border)"><div style="font-size:10px;color:var(--text3);margin-bottom:4px">${m.l}</div><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:18px;font-weight:800;color:var(--text);font-family:var(--mono)">${m.v>0?sym+m.v.toFixed(2):'N/A'}</span><span style="font-size:10px;font-weight:700;color:${m.sigC};padding:3px 8px;border-radius:4px;background:${m.sigC==='#10b981'?'rgba(16,185,129,.1)':'rgba(239,68,68,.1)'}">${m.sig}</span></div><div style="font-size:8px;color:var(--text3);margin-top:4px">${m.tip}</div></div>`).join('')}
</div>
${d.ema_signals&&d.ema_signals.length>0?`<div style="margin-top:10px;padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15)"><div style="font-size:10px;font-weight:700;color:var(--purple);margin-bottom:4px">EMA Signals</div><div style="font-size:10px;color:var(--text2);line-height:1.6">${d.ema_signals.map(s=>'• '+s).join('<br>')}</div></div>`:''}
<div style="margin-top:10px;padding:10px 14px;border-radius:8px;background:${price>_sf(d.sma_200)&&price>_sf(d.sma_50)?'rgba(16,185,129,.05)':price<_sf(d.sma_200)?'rgba(239,68,68,.05)':'rgba(245,158,11,.05)'};border-left:3px solid ${price>_sf(d.sma_200)&&price>_sf(d.sma_50)?'#10b981':price<_sf(d.sma_200)?'#ef4444':'#f59e0b'}">
<div style="font-size:11px;font-weight:700;color:var(--text)">💡 What the technicals tell you:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px">${price>_sf(d.sma_200)&&price>_sf(d.sma_50)?'Stock is above ALL major moving averages — strong uptrend. Momentum is with buyers. Dips to SMA50 ('+sym+_sf(d.sma_50).toFixed(0)+') are potential buying opportunities.':price<_sf(d.sma_200)?'Stock is BELOW the 200-day average — this is technically a downtrend. Professional investors consider this a warning sign. Wait for a cross back above '+sym+_sf(d.sma_200).toFixed(0)+' before entering.':'Mixed signals — stock is between key averages. This often means the stock is in a consolidation phase. A breakout above '+sym+Math.max(_sf(d.sma_50),_sf(d.sma_200)).toFixed(0)+' would be bullish.'}</div>
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(6,182,212,.04);border-left:3px solid var(--cyan);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--cyan)">💡 Technical Analysis in Plain English:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">Moving Averages (SMAs) act like trend compasses. <strong>SMA 200</strong> shows the long-term trend (like checking if it rained more this year vs last year). <strong>SMA 50</strong> shows medium-term direction. <strong>SMA 20</strong> shows recent momentum. When the price is ABOVE all three = strong uptrend (like a rising tide lifting all boats). When BELOW all three = downtrend. The most important one is SMA 200 — stocks above it tend to keep rising, stocks below tend to keep falling. <strong>Golden Cross</strong> (50-day crosses above 200-day) = bullish signal. <strong>Death Cross</strong> (opposite) = bearish signal.</div>
</div>

<!-- CASH FLOW ANALYSIS -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(16,185,129,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">💰 Cash Flow Analysis — Follow the Money</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 12px 0;line-height:1.6">Earnings can be manipulated with accounting tricks. Cash flow cannot. A company that generates strong cash flow is genuinely profitable. If earnings are high but cash flow is low, be cautious.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
${[
{l:'Operating Cash Flow',v:_fn(_sf(d.operating_cash_flow||d.operating_cashflow)),sub:'Cash from core operations',c:'var(--blue)'},
{l:'Free Cash Flow',v:_fn(_sf(d.free_cash_flow||d.free_cashflow)),sub:'Cash after all capex',c:'#10b981'},
{l:'FCF per Share',v:_sf(d.free_cash_flow||d.free_cashflow)>0&&shares>0?sym+(_sf(d.free_cash_flow||d.free_cashflow)/shares).toFixed(2):'N/A',sub:'Your share of the cash',c:'#10b981'},
{l:'FCF Yield',v:_sf(d.free_cash_flow||d.free_cashflow)>0&&mcap>0?(_sf(d.free_cash_flow||d.free_cashflow)/mcap*100).toFixed(1)+'%':'N/A',sub:_sf(d.free_cash_flow||d.free_cashflow)/mcap*100>5?'Excellent cash return':'Moderate',c:_sf(d.free_cash_flow||d.free_cashflow)/mcap*100>5?'#10b981':'var(--amber)'},
{l:'EBITDA',v:_fn(_sf(d.ebitda)),sub:'Operating profit (pre D&A)',c:'var(--purple)'},
{l:'EBITDA Margin',v:_sf(d.ebitda_margins)>0?_sf(d.ebitda_margins).toFixed(1)+'%':'N/A',sub:_sf(d.ebitda_margins)>20?'Strong operating efficiency':'Room for improvement',c:_sf(d.ebitda_margins)>20?'#10b981':'var(--amber)'},
].map(m=>`<div style="padding:12px;border-radius:8px;background:rgba(0,47,108,.02);border:1px solid var(--border)"><div style="font-size:9px;color:var(--text3)">${m.l}</div><div style="font-size:16px;font-weight:800;color:${m.c};font-family:var(--mono)">${m.v}</div><div style="font-size:8px;color:var(--text3);margin-top:2px">${m.sub}</div></div>`).join('')}
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 Cash Flow — The Real Measure of Health:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">Profits can be manipulated through accounting tricks, but <strong>cash flow cannot be faked</strong>. Operating Cash Flow (OCF) shows how much actual cash the business generates from selling its products. Free Cash Flow (FCF) is what's left after reinvesting in the business — this is the money available for dividends, buybacks, or debt repayment. <strong>The golden rule:</strong> If a company reports high profits but low/negative cash flow, something is wrong (possibly aggressive accounting). If cash flow is HIGHER than reported profits, that's a quality signal — the business is generating more cash than the income statement shows. FCF Yield above 5% means the company generates 5% of its market value in cash every year — like a dividend you don't have to pay tax on.</div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid var(--blue);margin:0 0 16px">
<div style="font-size:10px;font-weight:700;color:var(--blue)">📖 Salary Analogy — Understanding Cash Flow</div>
<div style="font-size:9px;color:var(--text2);margin-top:3px;line-height:1.8">Think of a company like your household budget:<br>
• <strong>Revenue</strong> = Your monthly salary (total money coming in)<br>
• <strong>Operating Cash Flow (${_fn(_sf(d.operating_cash_flow||d.operating_cashflow))})</strong> = Your salary AFTER taxes and mandatory expenses — the cash actually hitting your bank account<br>
• <strong>Free Cash Flow (${_fn(_sf(d.free_cash_flow||d.free_cashflow))})</strong> = What's left AFTER paying rent, EMIs, groceries, and saving for emergencies — the money you can spend freely<br>
• <strong>EBITDA (${_fn(_sf(d.ebitda))})</strong> = Your salary before taxes and loan repayments — shows your raw earning power<br>
${_sf(d.free_cash_flow||d.free_cashflow)>0?'✅ This company has POSITIVE free cash flow — it earns more than it spends. Like having money left over after all bills.':'⚠️ NEGATIVE free cash flow — the company is spending more than it earns. Like relying on credit cards to cover monthly expenses.'} ${_sf(d.operating_cash_flow||d.operating_cashflow)>_sf(d.ebitda)*0.8?'Cash quality is HIGH — the profits are real, backed by actual cash.':'Cash quality needs monitoring — not all reported profits are converting to cash.'}</div>
</div>

<!-- BALANCE SHEET HEALTH -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(59,130,246,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">🏦 Balance Sheet Health — Can the Company Survive a Downturn?</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 12px 0;line-height:1.6">A strong balance sheet means the company can survive recessions, invest in growth, and take advantage of competitors' weaknesses. High debt is a risk multiplier — it amplifies both gains and losses.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
${[
{l:'Total Cash',v:_fn(_sf(d.total_cash)),grade:_sf(d.total_cash)>_sf(d.total_debt)?'A':'C',tip:'Cash reserves'},
{l:'Total Debt',v:_fn(_sf(d.total_debt)),grade:de<50?'A':de<100?'B':de<200?'C':'D',tip:'Outstanding borrowings'},
{l:'Debt/Equity',v:de.toFixed(0)+'%',grade:de<50?'A':de<100?'B':de<200?'C':'D',tip:de<50?'Conservative':de<100?'Moderate':de<200?'Elevated':'High risk'},
{l:'Current Ratio',v:cr.toFixed(2),grade:cr>2?'A':cr>1.5?'B':cr>1?'C':'D',tip:cr>1.5?'Can easily pay short-term bills':cr>1?'Adequate liquidity':'Liquidity concern'},
{l:'Quick Ratio',v:qr>0?qr.toFixed(2):'N/A',grade:qr>1?'A':qr>0.7?'B':qr>0.5?'C':'D',tip:qr>1?'Strong immediate liquidity':'May struggle with sudden expenses'},
{l:'Book Value/Share',v:bv>0?sym+bv.toFixed(2):'N/A',grade:price>0&&bv>0&&price/bv<2?'A':price/bv<3?'B':'C',tip:'Net assets per share'},
].map(m=>{
const gc={'A':'#10b981','B':'#22d3ee','C':'#f59e0b','D':'#ef4444'}[m.grade]||'var(--text3)';
return`<div style="padding:12px;border-radius:8px;background:rgba(0,47,108,.02);border:1px solid var(--border)"><div style="display:flex;justify-content:space-between"><span style="font-size:9px;color:var(--text3)">${m.l}</span><span style="font-size:8px;font-weight:700;color:${gc};padding:1px 6px;border-radius:3px;background:rgba(0,0,0,.03)">${m.grade}</span></div><div style="font-size:16px;font-weight:800;color:var(--text);font-family:var(--mono);margin:2px 0">${m.v}</div><div style="font-size:8px;color:var(--text3)">${m.tip}</div></div>`;
}).join('')}
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid var(--blue);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--blue)">💡 Balance Sheet — Can the Company Survive a Storm?</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">The balance sheet tells you if the company can weather a downturn. <strong>Debt-to-Equity (D/E):</strong> Below 50% = conservative (like a family with small mortgage), 50-100% = moderate, above 150% = aggressive (like being heavily leveraged). High D/E companies fail first in recessions. <strong>Current Ratio:</strong> Above 1.5 means the company can pay all short-term bills 1.5x over — it won't run out of cash. Below 1.0 is a red flag — the company may struggle to pay immediate debts. <strong>Book Value:</strong> Think of it as the "fire sale" price — if you liquidated everything and paid all debts, what's left per share? If stock price is below book value, you're paying less than the assets are worth (potentially a deep value opportunity).</div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple);margin:0 0 16px">
<div style="font-size:10px;font-weight:700;color:var(--purple)">📖 Home Loan Analogy — Understanding Debt</div>
<div style="font-size:9px;color:var(--text2);margin-top:3px;line-height:1.8">Think of the company's balance sheet like buying a house:<br>
• <strong>Total Assets</strong> = The house's market value<br>
• <strong>Total Debt (${_fn(totalDebt)})</strong> = The outstanding home loan<br>
• <strong>Equity (Book Value)</strong> = What you'd pocket if you sold the house and repaid the loan<br>
• <strong>D/E of ${de.toFixed(0)}%</strong> = ${de<50?'Like owing ₹20L on a ₹60L house — very comfortable. Even if house prices drop 30%, you still have positive equity. This company can survive a recession.':de<100?'Like owing ₹40L on a ₹80L house — manageable. Monthly EMIs are covered, but a major downturn could squeeze finances.':de<200?'Like owing ₹60L on a ₹80L house — risky. A 25% drop in house value would wipe out your equity. This company is vulnerable in downturns.':'Like owing ₹90L on a ₹100L house — one bad year and the loan exceeds the house value. Very risky.'}<br>
• <strong>Current Ratio (${cr.toFixed(2)})</strong> = ${cr>1.5?'Can pay ALL upcoming bills 1.5x over — like having 1.5 months of salary saved as emergency fund. Comfortable.':cr>1?'Can just barely cover short-term obligations. No emergency buffer.':'Cannot cover short-term bills — like not having enough to pay next month\'s EMI. Red flag.'}</div>
</div>

<!-- GROWTH DEEP DIVE -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(139,92,246,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">🚀 Growth Metrics Deep Dive</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 12px 0;line-height:1.6">Growth is what creates long-term wealth. Revenue growth shows the company is gaining market share. Earnings growth shows it's becoming more profitable. The PEG ratio tells you if you're overpaying for that growth.</p>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Metric</th><th>Value</th><th>Grade</th><th>What It Means</th></tr>
${[
{m:'Revenue Growth',v:rg!==0?_pct(rg):'N/A',g:rg>15?'A':rg>8?'B':rg>0?'C':'D',w:rg>15?'Rapid expansion — company is gaining market share fast':rg>8?'Healthy growth — above economy average':rg>0?'Modest growth — stable but not exciting':'Declining revenue — investigate why'},
{m:'Earnings Growth',v:eg!==0?_pct(eg):'N/A',g:eg>20?'A':eg>10?'B':eg>0?'C':'D',w:eg>20?'Accelerating profits — strong operating leverage':eg>10?'Good profit growth — management executing well':eg>0?'Slow profit growth — margins may be compressing':'Earnings declining — could be temporary or structural'},
{m:'Quarterly Earnings Growth',v:eqg!==0?_pct(eqg):'N/A',g:eqg>20?'A':eqg>5?'B':eqg>0?'C':'D',w:eqg>20?'Recent quarter was very strong':eqg>0?'Positive recent momentum':'Recent quarter was weak'},
{m:'EPS (TTM)',v:eps>0?sym+eps.toFixed(2):'N/A',g:eps>0?'B':'D',w:eps>0?'Company is profitable on a per-share basis':'Not currently profitable'},
{m:'EPS (Forward)',v:epsF>0?sym+epsF.toFixed(2):'N/A',g:epsF>eps?'A':epsF>0?'B':'D',w:epsF>eps?'Analysts expect earnings to grow':'Forward estimates are below trailing — caution'},
{m:'PEG Ratio',v:peg>0?peg.toFixed(2):'N/A',g:peg>0&&peg<1?'A':peg>0&&peg<2?'B':peg>0&&peg<3?'C':'D',w:peg<1?'Growth at a bargain — stock looks cheap relative to growth rate':peg<2?'Fairly valued for its growth':peg>0?'Expensive relative to growth rate':'Not applicable'},
{m:'Revenue/Share',v:rps>0?sym+rps.toFixed(2):'N/A',g:rps>price*0.5?'A':rps>0?'B':'C',w:'Revenue generated per share you own'},
].map(r=>{
const gc={'A':'#10b981','B':'#22d3ee','C':'#f59e0b','D':'#ef4444'}[r.g];
return`<tr><td style="font-weight:600;font-size:11px">${r.m}</td><td style="font-weight:700;font-family:var(--mono);color:${gc}">${r.v}</td><td style="text-align:center"><span style="font-size:9px;font-weight:700;color:${gc};padding:2px 8px;border-radius:4px;background:rgba(0,0,0,.03)">${r.g}</span></td><td style="font-size:9px;color:var(--text2)">${r.w}</td></tr>`;
}).join('')}
</table></div>
<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple);margin-top:10px">
<div style="font-size:11px;font-weight:700;color:var(--purple)">💡 Growth in Plain English:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">${rg>15&&eg>15?'This company is firing on all cylinders — BOTH revenue AND earnings are growing fast. This is the best scenario: the company is selling more AND becoming more profitable. Like a restaurant that\'s both getting more customers and increasing prices.':rg>10?'Revenue is growing nicely, which means the company is successfully selling more products or entering new markets. ':eg>10&&rg<5?'Interesting pattern: earnings growing faster than revenue. This means the company is becoming MORE EFFICIENT — extracting more profit from each rupee of sales. Often a sign of good management.':'Growth is modest or mixed. The company is stable but not in hypergrowth mode. '} ${peg>0&&peg<1?'The PEG ratio below 1.0 is Peter Lynch\'s famous signal — you\'re getting growth at a bargain price!':peg>2?'PEG ratio above 2 means you\'re paying a lot for the growth you\'re getting.':''}</div>
</div>
</div>

<!-- DIVIDEND ANALYSIS -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:${divY>0?'rgba(16,185,129,.03)':'rgba(245,158,11,.03)'};border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">💸 Dividend Analysis${divY>0?' — Income Stream':'— No Dividends Currently'}</div>
${divY>0?`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px">
<div style="padding:14px;border-radius:10px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);text-align:center"><div style="font-size:9px;color:var(--text3)">Dividend Yield</div><div style="font-size:24px;font-weight:800;color:#10b981">${divY.toFixed(2)}%</div><div style="font-size:9px;color:var(--text3)">${divY>4?'Very attractive income':'Moderate income'}</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(59,130,246,.04);text-align:center"><div style="font-size:9px;color:var(--text3)">Payout Ratio</div><div style="font-size:24px;font-weight:800;color:${payout<60?'#10b981':payout<80?'var(--amber)':'var(--red)'}">${payout.toFixed(0)}%</div><div style="font-size:9px;color:var(--text3)">${payout<40?'Very safe — room to increase':payout<60?'Healthy — sustainable':payout<80?'Elevated — watch closely':'Risky — may not be sustainable'}</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(139,92,246,.04);text-align:center"><div style="font-size:9px;color:var(--text3)">Annual Income per ${sym}1L invested</div><div style="font-size:20px;font-weight:800;color:var(--purple)">${sym}${(divY*1000).toFixed(0)}</div><div style="font-size:9px;color:var(--text3)">Based on current yield</div></div>
</div>
<div style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981"><div style="font-size:10px;color:var(--text2);line-height:1.6">💡 <strong>For dividend investors:</strong> ${payout<50?'The low payout ratio means the dividend is very safe and has room to grow. The company retains most of its earnings for reinvestment.':payout<70?'The dividend appears sustainable. The company balances paying shareholders while retaining enough for growth.':'The high payout ratio means most profits go to dividends. While income is attractive, there is limited room for dividend growth.'} ${divY>3?'At '+divY.toFixed(1)+'% yield, this stock generates meaningful income — better than most fixed deposits.':'The yield is modest but supplements capital appreciation.'}</div></div>`
:`<p style="font-size:11px;color:var(--text2);line-height:1.7;margin:8px 0 0">This company does not currently pay dividends. This is common for growth companies that reinvest all profits back into the business. ${roe>15?'With ROE of '+roe.toFixed(1)+'%, the company earns high returns on reinvested capital — shareholders benefit through stock price appreciation instead.':'If the company is not paying dividends AND returns on equity are modest, question whether management is deploying capital effectively.'}</p>`}
</div>

<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid var(--amber);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--amber)">💡 Dividends — Free Money or a Trap?</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">${divY>3?'A dividend yield of '+divY.toFixed(1)+'% is HIGH — you earn this percentage just for holding the stock, paid out regularly. But high yields can be a trap if the company is cutting its dividend or if the stock price dropped sharply (which inflates yield). Check the Payout Ratio: below 60% means dividends are sustainable. Above 80% means the company is paying out almost all its earnings — risky.':divY>1?'A modest dividend of '+divY.toFixed(1)+'% provides some income while you wait for capital appreciation. This is typical for growth-oriented companies that reinvest most profits back into the business. The real return comes from stock price growth, with dividends as a bonus.':'No meaningful dividend — the company reinvests all profits for growth. This isn\'t bad for younger, high-growth companies (Amazon paid no dividends for 25 years). But for mature companies with slow growth, lack of dividends may signal poor capital allocation.'}</div>
</div>

<!-- INVESTMENT CHECKLIST -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(0,47,108,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px">✅ Investment Quality Checklist</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 12px 0">Green = passes, Red = fails. More green checks = higher quality company. This is a systematic way to evaluate fundamentals at a glance.</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:6px">
${[
{test:'Profitable (Net Margin > 0)',pass:pm>0,detail:pm>0?'Net margin: '+pm.toFixed(1)+'%':'Company is unprofitable'},
{test:'Strong Margins (> 15%)',pass:pm>15,detail:pm>15?'Well above breakeven':'Thin margins increase risk'},
{test:'High ROE (> 15%)',pass:roe>15,detail:'ROE: '+roe.toFixed(1)+'% '+(roe>15?'— excellent capital efficiency':'— below ideal')},
{test:'Low Debt (D/E < 100%)',pass:de<100,detail:'D/E: '+de.toFixed(0)+'% '+(de<100?'— manageable':'— high leverage')},
{test:'Adequate Liquidity (CR > 1.5)',pass:cr>1.5,detail:'Current Ratio: '+cr.toFixed(2)+(cr>1.5?' — can pay bills easily':' — monitor closely')},
{test:'Growing Revenue',pass:rg>5,detail:rg>0?'Revenue growth: '+rg.toFixed(1)+'%':'Revenue declining'},
{test:'Growing Earnings',pass:eg>5,detail:eg>0?'Earnings growth: '+eg.toFixed(1)+'%':'Earnings declining'},
{test:'Reasonable Valuation (P/E < 25)',pass:pe>0&&pe<25,detail:pe>0?'P/E: '+pe.toFixed(1)+'x '+(pe<25?'— reasonable':'— premium'):'Negative earnings'},
{test:'Positive Free Cash Flow',pass:_sf(d.free_cash_flow||d.free_cashflow)>0,detail:_sf(d.free_cash_flow||d.free_cashflow)>0?'FCF: '+_fn(_sf(d.free_cash_flow||d.free_cashflow)):'Negative FCF'},
{test:'Below 52W High (< 90%)',pass:w52pos<90,detail:'At '+w52pos.toFixed(0)+'% of 52-week range'},
{test:'Above 200-DMA (Uptrend)',pass:price>_sf(d.sma_200)&&_sf(d.sma_200)>0,detail:_sf(d.sma_200)>0?'SMA200: '+sym+_sf(d.sma_200).toFixed(0):'No SMA data'},
{test:'Beta < 1.5 (Not Too Volatile)',pass:beta<1.5,detail:'Beta: '+beta.toFixed(2)+(beta<1.5?' — manageable risk':' — very volatile')},
].map(c=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;background:${c.pass?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)'};border:1px solid ${c.pass?'rgba(16,185,129,.15)':'rgba(239,68,68,.15)'}"><span style="font-size:16px;min-width:20px">${c.pass?'✅':'❌'}</span><div><div style="font-size:11px;font-weight:600;color:${c.pass?'#10b981':'#ef4444'}">${c.test}</div><div style="font-size:9px;color:var(--text3)">${c.detail}</div></div></div>`).join('')}
</div>
<div style="margin-top:12px;padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.04);text-align:center"><span style="font-size:12px;font-weight:700;color:var(--purple)">Score: ${[pm>0,pm>15,roe>15,de<100,cr>1.5,rg>5,eg>5,pe>0&&pe<25,_sf(d.free_cash_flow||d.free_cashflow)>0,w52pos<90,price>_sf(d.sma_200)&&_sf(d.sma_200)>0,beta<1.5].filter(Boolean).length} / 12 checks passed</span></div>
<div style="padding:10px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 How to Use This Checklist:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.7">${[pm>0,pm>15,roe>15,de<100,cr>1.5,rg>5,eg>5,pe>0&&pe<25,_sf(d.free_cash_flow||d.free_cashflow)>0,w52pos<90,price>_sf(d.sma_200)&&_sf(d.sma_200)>0,beta<1.5].filter(Boolean).length>=9?'9+ checks passing is EXCELLENT — this company ticks most boxes of a quality investment. No stock is perfect, but this one scores well on the fundamentals that matter most.':[pm>0,pm>15,roe>15,de<100,cr>1.5,rg>5,eg>5,pe>0&&pe<25,_sf(d.free_cash_flow||d.free_cashflow)>0,w52pos<90,price>_sf(d.sma_200)&&_sf(d.sma_200)>0,beta<1.5].filter(Boolean).length>=6?'6-8 checks passing is DECENT — the company has some strong points but also areas of concern. Focus on the red ❌ items to understand what could go wrong.':'Less than 6 checks passing is a CAUTION SIGNAL. Multiple fundamental weaknesses increase the chance something goes wrong. Consider this a speculative position only, with strict position limits.'}</div>
</div>
</div>

<!-- SWOT ANALYSIS -->
<div style="margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">🔄 SWOT Analysis</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="padding:14px;border-radius:10px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.2)">
<div style="font-size:11px;font-weight:700;color:#10b981;margin-bottom:8px">💪 STRENGTHS</div>
<div style="font-size:10px;color:var(--text2);line-height:1.7">
${pm>15?'• Strong profit margins ('+pm.toFixed(1)+'%) indicate pricing power<br>':''}
${roe>15?'• High ROE ('+roe.toFixed(1)+'%) shows efficient capital allocation<br>':''}
${de<50?'• Conservative balance sheet (D/E: '+de.toFixed(0)+'%) provides flexibility<br>':''}
${_sf(d.free_cash_flow||d.free_cashflow)>0?'• Positive free cash flow generation<br>':''}
${divY>2?'• Attractive dividend yield ('+divY.toFixed(1)+'%)<br>':''}
${cr>2?'• Strong liquidity position (CR: '+cr.toFixed(2)+')<br>':''}
${price>_sf(d.sma_200)?'• Trading in technical uptrend<br>':''}
${pm<=15&&roe<=15&&de>=50?'• Listed company with access to capital markets<br>':''}
</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.15)">
<div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:8px">⚠️ WEAKNESSES</div>
<div style="font-size:10px;color:var(--text2);line-height:1.7">
${pm<5?'• Low margins ('+pm.toFixed(1)+'%) leave little room for error<br>':''}
${de>150?'• High leverage (D/E: '+de.toFixed(0)+'%) increases financial risk<br>':''}
${roe<10?'• Low ROE ('+roe.toFixed(1)+'%) suggests inefficient capital use<br>':''}
${beta>1.5?'• High volatility (beta: '+beta.toFixed(2)+') increases risk<br>':''}
${cr<1?'• Liquidity concern (CR: '+cr.toFixed(2)+' below 1.0)<br>':''}
${eg<0?'• Declining earnings trajectory<br>':''}
${pe>30?'• High valuation ('+pe.toFixed(1)+'x P/E) limits upside<br>':''}
${pm>=5&&de<=150&&roe>=10?'• No major weaknesses identified from current data<br>':''}
</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.15)">
<div style="font-size:11px;font-weight:700;color:#3b82f6;margin-bottom:8px">🔍 OPPORTUNITIES</div>
<div style="font-size:10px;color:var(--text2);line-height:1.7">
${rg>10?'• Revenue growing '+rg.toFixed(1)+'% — expanding addressable market<br>':''}
${pe<sAvgPE*0.85?'• Valuation discount to sector — re-rating potential<br>':''}
${w52pos<40?'• Near 52-week lows — potential value entry point<br>':''}
${peg>0&&peg<1?'• PEG below 1.0 — growth at a bargain price<br>':''}
• Industry tailwinds in ${sector} sector<br>
• Potential for margin expansion through operational efficiency<br>
${divY>0&&payout<50?'• Room to increase dividends (low payout ratio)<br>':''}
</div></div>
<div style="padding:14px;border-radius:10px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.15)">
<div style="font-size:11px;font-weight:700;color:#f59e0b;margin-bottom:8px">⚡ THREATS</div>
<div style="font-size:10px;color:var(--text2);line-height:1.7">
${w52pos>85?'• Near 52-week high — momentum exhaustion risk<br>':''}
${de>100?'• Interest rate increases would pressure margins<br>':''}
${shortR>3?'• Elevated short interest (ratio: '+shortR.toFixed(1)+') signals bearish bets<br>':''}
${beta>1.3?'• Market downturns amplified by high beta<br>':''}
• Competitive pressure in ${industry}<br>
• Regulatory changes could impact operations<br>
• Macroeconomic headwinds (inflation, currency, geopolitics)<br>
</div></div>
</div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid var(--amber);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--amber)">💡 How to Use SWOT Analysis:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">SWOT is auto-generated from the company's actual financial data, not generic text. <strong>Strengths</strong> = things the company does BETTER than average (high margins, low debt, strong cash flow). These are your reasons TO buy. <strong>Weaknesses</strong> = where the company lags (thin margins, heavy debt, poor returns). These are your reasons to HESITATE. <strong>Opportunities</strong> = positive trends that could improve the stock (revenue growth, undervaluation, margin expansion room). <strong>Threats</strong> = external risks that could hurt returns. <strong>Decision rule:</strong> If strengths + opportunities significantly outnumber weaknesses + threats, the odds favor buying. If the reverse, wait for improvement.</div>
</div>

<!-- PRICE TARGET METHODOLOGY -->
<div style="margin-bottom:20px;padding:18px;border-radius:12px;background:rgba(217,119,6,.04);border:1px solid rgba(217,119,6,.15)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#d97706;margin-bottom:6px">🎯 Price Target Methodology</div>
<p style="font-size:10px;color:var(--text3);margin:0 0 14px 0;line-height:1.6">Our 12-month target blends multiple valuation approaches. No single method is perfect — the more methods that converge on a similar price, the higher our confidence.</p>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Method</th><th>Target Price</th><th>Upside/Downside</th><th>How It Works</th></tr>
<tr><td style="font-weight:600">P/E × Forward EPS</td><td style="font-weight:700;color:var(--cyan)">${epsF>0?sym+(sAvgPE*epsF).toFixed(0):'N/A'}</td><td style="color:${epsF>0&&sAvgPE*epsF>price?'#10b981':'#ef4444'}">${epsF>0?_pct(((sAvgPE*epsF-price)/price*100)):'N/A'}</td><td style="font-size:9px;color:var(--text3)">Sector avg P/E (${sAvgPE.toFixed(1)}x) × estimated next year EPS</td></tr>
<tr><td style="font-weight:600">52-Week Mean Reversion</td><td style="font-weight:700;color:var(--cyan)">${sym}${((w52h+w52l)/2).toFixed(0)}</td><td style="color:${(w52h+w52l)/2>price?'#10b981':'#ef4444'}">${_pct((((w52h+w52l)/2-price)/price*100))}</td><td style="font-size:9px;color:var(--text3)">Midpoint of 52-week range as fair value anchor</td></tr>
<tr><td style="font-weight:600">Book Value + Premium</td><td style="font-weight:700;color:var(--cyan)">${bv>0?sym+(bv*(roe>15?3:roe>10?2:1.5)).toFixed(0):'N/A'}</td><td style="color:${bv>0&&bv*(roe>15?3:2)>price?'#10b981':'#ef4444'}">${bv>0?_pct(((bv*(roe>15?3:2)-price)/price*100)):'N/A'}</td><td style="font-size:9px;color:var(--text3)">Book value × P/B multiple (based on ROE quality)</td></tr>
<tr style="background:rgba(217,119,6,.06);border-top:2px solid #d97706"><td style="font-weight:800;color:#d97706">Blended Target (12M)</td><td style="font-weight:800;color:#d97706;font-size:14px">${sym}${target12m.toFixed(0)}</td><td style="font-weight:700;color:${target12m>price?'#10b981':'#ef4444'}">${_pct(((target12m-price)/price*100))}</td><td style="font-size:9px;color:#d97706;font-weight:600">Weighted average of all methods</td></tr>
</table></div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple);margin:10px 0 16px">
<div style="font-size:11px;font-weight:700;color:var(--purple)">💡 Understanding Price Targets:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">We use THREE different methods to calculate a target price because no single method is reliable alone. <strong>P/E Method</strong> assumes the stock will trade at the sector average P/E — if it's currently below, it should rise. <strong>Mean Reversion</strong> assumes the stock will move toward its 52-week average — extreme highs/lows tend to correct. <strong>Book Value + Premium</strong> estimates value from assets plus a quality premium based on ROE. When all 3 agree on direction, that's a high-confidence signal. When they disagree, treat the range between the lowest and highest as the "uncertainty zone." Never bet everything on one price target — use them as guideposts, not guarantees.</div>
</div>

<!-- INVESTMENT RECOMMENDATION -->
<div style="padding:20px;border-radius:12px;background:linear-gradient(135deg,${ratingBg},rgba(0,0,0,0));border:2px solid ${ratingColor};margin-bottom:16px">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:12px">
<div>
<div style="font-size:10px;letter-spacing:1px;color:var(--text3)">INVESTMENT RECOMMENDATION</div>
<div style="font-size:28px;font-weight:800;color:${ratingColor};letter-spacing:2px">${rating}</div>
</div>
<div style="text-align:right">
<div style="font-size:10px;color:var(--text3)">12-Month Target</div>
<div style="font-size:24px;font-weight:800;color:${ratingColor};font-family:var(--mono)">${sym}${target12m.toFixed(0)}</div>
<div style="font-size:11px;color:${target12m>price?'var(--green)':'var(--red)'}">${((target12m-price)/price*100).toFixed(1)}% ${target12m>price?'upside ▲':'downside ▼'}</div>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:9px;color:var(--text3)">Bull Case</div><div style="font-size:14px;font-weight:700;color:var(--green)">${sym}${(price*1.25).toFixed(0)}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(245,158,11,.06)"><div style="font-size:9px;color:var(--text3)">Base Case</div><div style="font-size:14px;font-weight:700;color:var(--amber)">${sym}${target12m.toFixed(0)}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:9px;color:var(--text3)">Bear Case</div><div style="font-size:14px;font-weight:700;color:var(--red)">${sym}${(price*0.82).toFixed(0)}</div></div>
</div>
</div>

<!-- FINAL RECOMMENDATION INFERENCE -->
<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin:16px 0">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 What Should You Do Next?</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8">${rating==='BUY'||rating==='ACCUMULATE'?'<strong>The data suggests this is a good opportunity.</strong> Consider building a position through monthly SIP rather than lump sum — this averages your entry price and reduces timing risk. Start small (2-3% of portfolio) and add more if subsequent quarterly results confirm the thesis. Set a stop-loss at 15-20% below your entry to limit downside.':rating==='HOLD'?'<strong>Neutral territory — neither compelling nor concerning.</strong> If you already own it, keep holding. If you don\'t own it, there may be better opportunities elsewhere. Wait for either a meaningful price dip (better entry) or improving fundamentals (stronger thesis) before buying.':'<strong>The data suggests caution.</strong> If you own this stock, consider trimming your position on any rallies rather than panic selling at lows. If you don\'t own it, wait for fundamental improvement before considering. Focus your capital on stocks with stronger scores.'}<br><br><strong>Remember:</strong> This quantitative model cannot capture qualitative factors like management quality, competitive moats, regulatory changes, or industry disruption. Use this report as ONE input alongside your own research and a SEBI-registered advisor\'s guidance.</div>
</div>

<!-- STEP-BY-STEP DECISION GUIDE -->
<div style="padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(139,92,246,.04),rgba(59,130,246,.03));border:1px solid rgba(139,92,246,.12);margin:16px 0">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--purple);margin-bottom:10px">🗺️ Step-by-Step Decision Guide — What to Do With This Report</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px;font-size:9px;color:var(--text2);line-height:1.7">
<div style="padding:10px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981">
<div style="font-weight:700;color:#10b981;margin-bottom:3px">Step 1: Check the Checklist Score</div>
If the stock passes 8+ out of 12 checks → fundamentals are solid. Below 6 → multiple red flags, proceed with extreme caution regardless of other signals.
</div>
<div style="padding:10px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid var(--blue)">
<div style="font-weight:700;color:var(--blue);margin-bottom:3px">Step 2: Look at Valuation vs Sector</div>
${pe>0&&pe<sAvgPE*0.85?'This stock is CHEAPER than its sector peers. If Step 1 passed, this could be a genuine bargain — the market may be underpricing it.':pe>sAvgPE*1.15?'Trading at a PREMIUM to peers. Only justified if growth significantly exceeds sector average. Check the Growth Deep Dive section.':'Fairly priced vs peers. The stock won\'t give you a valuation boost — returns depend entirely on business execution.'}
</div>
<div style="padding:10px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid var(--amber)">
<div style="font-weight:700;color:var(--amber);margin-bottom:3px">Step 3: Read the SWOT</div>
Count strengths+opportunities vs weaknesses+threats. If S+O significantly outnumber W+T → odds favor you. If reversed → wait for improvement or find a better stock.
</div>
<div style="padding:10px;border-radius:8px;background:rgba(6,182,212,.04);border-left:3px solid var(--cyan)">
<div style="font-weight:700;color:var(--cyan);margin-bottom:3px">Step 4: Check the Technicals</div>
${sma20>0&&sma50>0&&sma200>0?(price>sma200?'Price is ABOVE the 200-day average → the long-term trend is UP. This supports buying.':'Price is BELOW the 200-day average → the trend is DOWN. Even if fundamentals are good, consider waiting for a trend reversal.'):'Technical data unavailable. Focus on fundamentals.'}
</div>
<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid var(--purple)">
<div style="font-weight:700;color:var(--purple);margin-bottom:3px">Step 5: Size Your Position</div>
${rating==='BUY'?'Strong conviction → Start with 3-5% of your portfolio. Add more on dips if the thesis remains intact. Set a stop-loss at 15% below entry.':rating==='ACCUMULATE'?'Moderate conviction → Start with 2-3% of your portfolio via SIP over 3-6 months. Don\'t go all-in at once.':rating==='HOLD'?'Low conviction → If you own it, hold. If you don\'t, allocate capital elsewhere. Watch for fundamental improvement.':'Caution → Avoid new positions. If you own it, look for exit points on rallies. Reallocate to stronger stocks.'}
</div>
<div style="padding:10px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981">
<div style="font-weight:700;color:#10b981;margin-bottom:3px">Step 6: Set Alerts & Review</div>
Set a price alert at the target price (${sym}${target12m.toFixed(0)}). Review this analysis again after the next quarterly earnings. If fundamentals deteriorate, don't fall in love with the stock — cut losses early.
</div>
</div>
</div>

<!-- DISCLAIMER -->
<div style="padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.03);border:1px solid rgba(245,158,11,.1)">
<div style="font-size:9px;color:var(--text3);line-height:1.6">
<strong style="color:var(--amber)">&#128712; Disclaimer:</strong> This equity research report is generated by Celesys AI for <strong>educational and informational purposes only</strong>. It does not constitute investment advice, a solicitation, or an offer to buy or sell any securities. All data is sourced from public financial APIs and may contain inaccuracies. Past performance does not guarantee future results. Always consult a SEBI-registered investment advisor before making financial decisions. Celesys AI is not registered with SEBI or any regulatory body.
</div>
</div>`;

el.innerHTML=h;
console.log('✅ Equity Research rendered:',name,rating,sym+target12m.toFixed(0));
}

// ═══════════════════════════════════════════════
// ═══ INDEX RESEARCH — India & USA ═══
// ═══════════════════════════════════════════════
const INDEX_DATA={
india:[
{name:'Nifty 50',ticker:'^NSEI',yf:'^NSEI',type:'Large Cap',stocks:50,desc:'Top 50 companies by market cap on NSE. The primary benchmark for Indian equities.',sector:'Broad Market',currency:'₹',inception:'1996',methodology:'Free-float market cap weighted',topHoldings:'HDFC Bank, Reliance, ICICI Bank, Infosys, TCS',rebalance:'Semi-annual (Mar/Sep)',pe_hist:'20-22x',cagr5:'~12-14%',cagr10:'~11-13%',maxDD:'-38% (Mar 2020)',risk:'Medium',sip:'₹500/month in Nifty ETF since 2015 → ~15% CAGR',best:'Broad India exposure, most liquid, lowest cost ETFs available',risk_note:'Concentrated in top 10 stocks (~55% weight). HDFC Bank alone is 12%+.'},
{name:'Sensex',ticker:'^BSESN',yf:'^BSESN',type:'Large Cap',stocks:30,desc:'Oldest Indian index. 30 largest & most traded companies on BSE.',sector:'Broad Market',currency:'₹',inception:'1986',methodology:'Free-float market cap weighted',topHoldings:'Reliance, HDFC Bank, ICICI Bank, Infosys, TCS',rebalance:'Semi-annual',pe_hist:'22-25x',cagr5:'~13%',cagr10:'~12%',maxDD:'-38% (Mar 2020)',risk:'Medium',sip:'Most tracked by media. Fewer stocks = slightly higher concentration.',best:'Heritage index, widely quoted, good for tracking overall market direction',risk_note:'Only 30 stocks — even more concentrated than Nifty 50.'},
{name:'Bank Nifty',ticker:'^NSEBANK',yf:'^NSEBANK',type:'Sector',stocks:12,desc:'Top 12 banking stocks. Most traded options index in India — 80%+ of F&O volume.',sector:'Banking & Financial',currency:'₹',inception:'2003',methodology:'Free-float market cap weighted',topHoldings:'HDFC Bank, ICICI Bank, Kotak Bank, Axis Bank, SBI',rebalance:'Semi-annual',pe_hist:'15-18x',cagr5:'~10-12%',cagr10:'~12%',maxDD:'-42% (Mar 2020)',risk:'High',sip:'High beta — rallies harder in bull markets, falls harder in bear markets.',best:'Options trading, directional bets on banking sector, high liquidity',risk_note:'NPA cycles, RBI policy changes, and credit growth directly impact returns.'},
{name:'Nifty IT',ticker:'NIFTYIT.NS',yf:'^CNXIT',type:'Sector',stocks:10,desc:'Top 10 IT companies. Proxy for USD/INR — benefits from rupee depreciation.',sector:'Information Technology',currency:'₹',inception:'1996',methodology:'Free-float market cap weighted',topHoldings:'TCS, Infosys, HCL Tech, Wipro, Tech Mahindra',rebalance:'Semi-annual',pe_hist:'25-30x',cagr5:'~15-18%',cagr10:'~14%',maxDD:'-30% (2022)',risk:'Medium-High',sip:'Best India IT proxy. USD revenue = natural INR depreciation hedge.',best:'Export earnings, defensive in INR weakness, high margins',risk_note:'US recession directly hits IT budgets. AI disruption risk to services model.'},
{name:'Nifty Next 50',ticker:'NIFTYNXT50.NS',yf:'^NSMIDCP',type:'Mid-Large Cap',stocks:50,desc:'Stocks ranked 51-100 by market cap. Future Nifty 50 candidates.',sector:'Broad Market',currency:'₹',inception:'1996',methodology:'Free-float market cap weighted',topHoldings:'Adani companies, Avenue Supermarts, Vedanta, IRCTC, Tata Power',rebalance:'Semi-annual',pe_hist:'22-28x',cagr5:'~14-16%',cagr10:'~13-15%',maxDD:'-40% (Mar 2020)',risk:'Medium-High',sip:'Higher growth potential than Nifty 50 — these are the emerging blue-chips.',best:'Growth + quality, future large caps, SIP alpha over Nifty 50',risk_note:'Higher volatility than Nifty 50. Some stocks may never graduate to Nifty 50.'},
{name:'Nifty Midcap 150',ticker:'',yf:'NIFTY_MID_SELECT.NS',type:'Mid Cap',stocks:150,desc:'Mid-cap companies ranked 101-250 by market cap.',sector:'Broad Market',currency:'₹',inception:'2004',methodology:'Free-float market cap weighted',topHoldings:'Persistent Systems, PI Industries, Max Healthcare, Trent',rebalance:'Semi-annual',pe_hist:'25-35x',cagr5:'~18-22%',cagr10:'~16-18%',maxDD:'-45% (Mar 2020)',risk:'High',sip:'Historically outperforms large caps over 10+ year periods via SIP.',best:'Higher growth, emerging companies, alpha generation',risk_note:'Can underperform for 2-3 year stretches. Liquidity risk in downturns.'},
{name:'Nifty Smallcap 250',ticker:'',yf:'NIFTY_SMLCAP_250.NS',type:'Small Cap',stocks:250,desc:'Companies ranked 251-500 by market cap. High growth, high risk.',sector:'Broad Market',currency:'₹',inception:'2004',methodology:'Free-float market cap weighted',topHoldings:'Diverse — 250 stocks, no single stock > 2%',rebalance:'Semi-annual',pe_hist:'20-40x',cagr5:'~20-25%',cagr10:'~15-18%',maxDD:'-55% (Mar 2020)',risk:'Very High',sip:'Highest long-term SIP returns historically, but also deepest drawdowns.',best:'Maximum growth potential, multi-bagger hunting ground',risk_note:'50-60% drawdowns in bear markets. Many stocks have low liquidity. 3-5 year horizon minimum.'},
{name:'Nifty Auto',ticker:'',yf:'^CNXAUTO',type:'Sector',stocks:15,desc:'Top automobile and auto component companies.',sector:'Automotive',currency:'₹',inception:'2004',methodology:'Free-float market cap weighted',topHoldings:'Tata Motors, M&M, Maruti, Bajaj Auto, Eicher Motors',rebalance:'Semi-annual',pe_hist:'20-30x',cagr5:'~15-20%',cagr10:'~12%',maxDD:'-45% (Mar 2020)',risk:'High',sip:'Cyclical — buy during slowdowns for best SIP returns.',best:'EV transition play, rural recovery proxy, export potential',risk_note:'Highly cyclical. Commodity prices, interest rates, and monsoon impact demand.'},
{name:'Nifty Pharma',ticker:'',yf:'^CNXPHARMA',type:'Sector',stocks:20,desc:'Top pharmaceutical and healthcare companies.',sector:'Healthcare',currency:'₹',inception:'2001',methodology:'Free-float market cap weighted',topHoldings:'Sun Pharma, Dr Reddy, Cipla, Divi Labs, Apollo Hospitals',rebalance:'Semi-annual',pe_hist:'25-35x',cagr5:'~12-15%',cagr10:'~10-12%',maxDD:'-30% (2022)',risk:'Medium',sip:'Defensive sector — outperforms during market stress and recessions.',best:'Defensive, INR depreciation hedge (exports), aging population tailwind',risk_note:'US FDA inspections, generic price erosion, patent cliffs create volatility.'},
{name:'India VIX',ticker:'',yf:'^INDIAVIX',type:'Volatility',stocks:0,desc:'Fear gauge — measures expected volatility of Nifty 50 over next 30 days.',sector:'Volatility',currency:'',inception:'2008',methodology:'Based on Nifty options order book',topHoldings:'N/A — derived from options prices',rebalance:'Continuous',pe_hist:'N/A',cagr5:'N/A',cagr10:'N/A',maxDD:'N/A',risk:'N/A',sip:'Not investable directly. VIX > 25 = market panic = buying opportunity.',best:'Contrarian signal — spike above 25 historically marks market bottoms',risk_note:'VIX can stay elevated for months. Not a timing tool alone.'},
],
usa:[
{name:'S&P 500',ticker:'^GSPC',yf:'^GSPC',type:'Large Cap',stocks:500,desc:'500 largest US companies. THE benchmark for global equities.',sector:'Broad Market',currency:'$',inception:'1957',methodology:'Float-adjusted market cap weighted',topHoldings:'Apple, Microsoft, NVIDIA, Amazon, Meta, Alphabet',rebalance:'Quarterly',pe_hist:'18-22x',cagr5:'~12-15%',cagr10:'~12-13%',maxDD:'-34% (Mar 2020)',risk:'Medium',sip:'$100/month since 2000 → ~10% CAGR. Most recommended single investment by Warren Buffett.',best:'Broad US exposure, lowest cost, most liquid, gold standard benchmark',risk_note:'Top 7 stocks (Mag 7) are ~30% of index — extreme concentration risk.'},
{name:'NASDAQ Composite',ticker:'^IXIC',yf:'^IXIC',type:'Tech Heavy',stocks:3000,desc:'All NASDAQ-listed stocks. Heavily tech-weighted (~50% technology).',sector:'Technology',currency:'$',inception:'1971',methodology:'Market cap weighted',topHoldings:'Apple, Microsoft, NVIDIA, Amazon, Meta, Alphabet, Tesla',rebalance:'Continuous',pe_hist:'25-35x',cagr5:'~15-18%',cagr10:'~16-18%',maxDD:'-33% (2022)',risk:'Medium-High',sip:'Outperforms S&P 500 in bull markets, underperforms in downturns.',best:'Tech sector proxy, innovation exposure, AI/cloud/SaaS growth',risk_note:'Tech concentration means rate hikes hit hard. -33% in 2022 when Fed raised rates.'},
{name:'NASDAQ 100',ticker:'^NDX',yf:'^NDX',type:'Large Cap Tech',stocks:100,desc:'Top 100 non-financial NASDAQ stocks. The "Magnificent 7" index.',sector:'Technology',currency:'$',inception:'1985',methodology:'Modified market cap weighted',topHoldings:'Apple, Microsoft, NVIDIA, Amazon, Broadcom, Meta, Tesla',rebalance:'Quarterly',pe_hist:'28-35x',cagr5:'~18-22%',cagr10:'~18-20%',maxDD:'-33% (2022)',risk:'High',sip:'Best performing major index over last decade. QQQ ETF is the easiest way to invest.',best:'Concentrated tech/innovation, AI/cloud/semiconductor exposure',risk_note:'Magnificent 7 = 50%+ of index. Single stock risk disguised as index investing.'},
{name:'Dow Jones Industrial',ticker:'^DJI',yf:'^DJI',type:'Blue Chip',stocks:30,desc:'30 blue-chip American companies. Price-weighted — oldest major US index.',sector:'Industrial',currency:'$',inception:'1896',methodology:'Price weighted (unusual — higher priced stocks have more influence)',topHoldings:'UnitedHealth, Goldman Sachs, Microsoft, Caterpillar, Amgen',rebalance:'As needed (committee decision)',pe_hist:'16-20x',cagr5:'~10-12%',cagr10:'~11-12%',maxDD:'-37% (Mar 2020)',risk:'Medium',sip:'Most conservative major US index. Industrial & value tilt.',best:'Blue-chip stability, dividend income, lower volatility than NASDAQ',risk_note:'Price-weighted = archaic methodology. Stock splits randomly change index impact.'},
{name:'Russell 2000',ticker:'^RUT',yf:'^RUT',type:'Small Cap',stocks:2000,desc:'2000 smallest companies in Russell 3000. US small-cap benchmark.',sector:'Broad Market',currency:'$',inception:'1984',methodology:'Market cap weighted',topHoldings:'Widely diversified — no single stock > 0.5%',rebalance:'Annual (June)',pe_hist:'20-35x',cagr5:'~6-10%',cagr10:'~8-10%',maxDD:'-42% (Mar 2020)',risk:'High',sip:'Historically leads in early bull markets. Underperformed large caps for years.',best:'Domestic US economy proxy, less tech concentration, value hunting ground',risk_note:'Higher interest rates crush small caps (more floating-rate debt). Underperforming since 2020.'},
{name:'S&P 500 Equal Weight',ticker:'',yf:'RSP',type:'Large Cap',stocks:500,desc:'Same 500 stocks as S&P 500, but each gets 0.2% weight instead of market cap.',sector:'Broad Market',currency:'$',inception:'2003',methodology:'Equal weighted, rebalanced quarterly',topHoldings:'All 500 stocks equally — no single stock dominance',rebalance:'Quarterly',pe_hist:'16-19x',cagr5:'~10-12%',cagr10:'~11-12%',maxDD:'-38% (Mar 2020)',risk:'Medium',sip:'Eliminates Magnificent 7 concentration risk. Outperforms in value/breadth rallies.',best:'Diversification, value tilt, no single-stock risk, mean reversion benefit',risk_note:'Underperforms in momentum/tech-driven markets (like 2023-2024).'},
{name:'VIX (Fear Index)',ticker:'^VIX',yf:'^VIX',type:'Volatility',stocks:0,desc:'CBOE Volatility Index — measures expected 30-day volatility of S&P 500.',sector:'Volatility',currency:'',inception:'1993',methodology:'Based on S&P 500 options pricing',topHoldings:'N/A — derived from options',rebalance:'Continuous',pe_hist:'N/A',cagr5:'N/A',cagr10:'N/A',maxDD:'N/A',risk:'N/A',sip:'Not investable long-term (VIX ETPs decay). Use as market fear gauge only.',best:'Contrarian buy signal — VIX > 30 historically marks great entry points for S&P 500',risk_note:'VIX can spike to 80+ in extreme panic (Mar 2020 hit 82). Stay calm when others panic.'},
{name:'SOX (Semiconductor)',ticker:'',yf:'^SOX',type:'Sector',stocks:30,desc:'Philadelphia Semiconductor Index. The AI/chip boom benchmark.',sector:'Semiconductors',currency:'$',inception:'1993',methodology:'Modified market cap weighted',topHoldings:'NVIDIA, Broadcom, AMD, TSMC (ADR), Qualcomm, Intel',rebalance:'Annual',pe_hist:'20-35x',cagr5:'~25-30%',cagr10:'~22-25%',maxDD:'-40% (2022)',risk:'Very High',sip:'Highest CAGR of any major sector index. Riding the AI capex super-cycle.',best:'Direct AI/semiconductor exposure, NVIDIA-led, massive secular tailwinds',risk_note:'Extreme cyclicality — inventory corrections can cause 30-40% drops in months.'},
{name:'Dow Jones Transportation',ticker:'',yf:'^DJT',type:'Sector',stocks:20,desc:'20 major US transportation companies. Economic leading indicator.',sector:'Transportation',currency:'$',inception:'1884',methodology:'Price weighted',topHoldings:'UPS, FedEx, Union Pacific, Delta Airlines, CSX',rebalance:'As needed',pe_hist:'15-20x',cagr5:'~8-10%',cagr10:'~10-12%',maxDD:'-40% (Mar 2020)',risk:'High',sip:'Dow Theory: when Transports confirm Industrials, bull market is real.',best:'Economic bellwether, leading indicator, Dow Theory confirmation signal',risk_note:'Fuel prices, labor costs, and recession directly hit transportation stocks.'},
]};

function renderIndices(d){
const el=document.getElementById('indicesContent');
if(!el)return;

let _geo='india';
const buildIndexCards=(geo)=>{
const data=INDEX_DATA[geo];
if(!data)return'';
const sym=geo==='india'?'₹':'$';
let h='';

// Collect yf tickers for live price fetch
const yfTickers=data.filter(idx=>idx.yf).map(idx=>idx.yf);

data.forEach((idx,i)=>{
const isVol=idx.type==='Volatility';
const riskC=idx.risk==='Very High'?'#ef4444':idx.risk==='High'?'#f97316':idx.risk==='Medium-High'?'#f59e0b':idx.risk==='Medium'?'#22d3ee':idx.risk==='Low'?'#10b981':'var(--text3)';
const typeC=idx.type.includes('Large')?'var(--blue)':idx.type.includes('Mid')?'var(--purple)':idx.type.includes('Small')?'var(--amber)':idx.type.includes('Sector')?'#10b981':idx.type.includes('Tech')?'#8b5cf6':'var(--cyan)';

h+=`<div style="margin-bottom:16px;border-radius:14px;overflow:hidden;border:1px solid var(--border);background:rgba(0,47,108,.015)">
<!-- Header -->
<div style="padding:16px 18px;background:linear-gradient(135deg,rgba(6,182,212,.06),rgba(59,130,246,.04));border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
<div>
<div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
<span style="font-size:16px;font-weight:800;color:var(--text);font-family:'Sora',sans-serif">${idx.name}</span>
<span style="font-size:9px;padding:2px 8px;border-radius:4px;background:rgba(6,182,212,.1);color:${typeC};font-weight:700;letter-spacing:.5px">${idx.type}</span>
${!isVol?`<span style="font-size:9px;padding:2px 6px;border-radius:4px;color:${riskC};border:1px solid ${riskC};font-weight:600">${idx.risk} Risk</span>`:''}
</div>
<div style="font-size:10px;color:var(--text3)">${idx.yf||'—'} · ${idx.stocks>0?idx.stocks+' stocks':'Derived'} · Since ${idx.inception}</div>
</div>
<div style="text-align:right">
<div data-idx-ticker="${idx.yf}" style="font-size:20px;font-weight:800;color:var(--cyan);font-family:var(--mono)">⏳</div>
</div>
</div>

<!-- Body -->
<div style="padding:14px 18px">
<p style="font-size:11px;color:var(--text);line-height:1.7;margin:0 0 12px">${idx.desc}</p>

<!-- Key Metrics Grid -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;margin-bottom:12px">
${!isVol?`
<div style="padding:8px;border-radius:6px;background:rgba(6,182,212,.04);text-align:center"><div style="font-size:8px;color:var(--text3)">5Y CAGR</div><div style="font-size:14px;font-weight:700;color:#10b981">${idx.cagr5}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.04);text-align:center"><div style="font-size:8px;color:var(--text3)">10Y CAGR</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${idx.cagr10}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.04);text-align:center"><div style="font-size:8px;color:var(--text3)">Max Drawdown</div><div style="font-size:14px;font-weight:700;color:var(--red)">${idx.maxDD}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(245,158,11,.04);text-align:center"><div style="font-size:8px;color:var(--text3)">Historical P/E</div><div style="font-size:14px;font-weight:700;color:var(--amber)">${idx.pe_hist}</div></div>
`:`
<div style="padding:8px;border-radius:6px;background:rgba(245,158,11,.04);text-align:center;grid-column:span 2"><div style="font-size:8px;color:var(--text3)">How to Read</div><div style="font-size:11px;font-weight:600;color:var(--amber)">Below 15 = Calm · 15-25 = Normal · 25-35 = Fear · 35+ = Panic</div></div>
`}
</div>

<!-- Details -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:10px;margin-bottom:10px">
<div><span style="color:var(--text3)">Methodology:</span> <span style="color:var(--text2)">${idx.methodology}</span></div>
<div><span style="color:var(--text3)">Rebalance:</span> <span style="color:var(--text2)">${idx.rebalance}</span></div>
<div style="grid-column:span 2"><span style="color:var(--text3)">Top Holdings:</span> <span style="color:var(--text)">${idx.topHoldings}</span></div>
</div>

<!-- SIP/Best/Risk -->
<div style="display:grid;grid-template-columns:1fr;gap:6px">
<div style="padding:8px 10px;border-radius:6px;border-left:3px solid #10b981;background:rgba(16,185,129,.03)"><span style="font-size:9px;font-weight:700;color:#10b981">💡 BEST FOR:</span> <span style="font-size:9px;color:var(--text2)">${idx.best}</span></div>
<div style="padding:8px 10px;border-radius:6px;border-left:3px solid var(--cyan);background:rgba(6,182,212,.03)"><span style="font-size:9px;font-weight:700;color:var(--cyan)">📊 SIP INSIGHT:</span> <span style="font-size:9px;color:var(--text2)">${idx.sip}</span></div>
<div style="padding:8px 10px;border-radius:6px;border-left:3px solid var(--red);background:rgba(239,68,68,.03)"><span style="font-size:9px;font-weight:700;color:var(--red)">⚠️ KEY RISK:</span> <span style="font-size:9px;color:var(--text2)">${idx.risk_note}</span></div>
${!isVol?`<div style="padding:8px 10px;border-radius:6px;border-left:3px solid var(--purple);background:rgba(139,92,246,.03)"><span style="font-size:9px;font-weight:700;color:var(--purple)">🕐 WHEN TO BUY:</span> <span style="font-size:9px;color:var(--text2)">${
idx.risk==='Very High'?'Only via SIP (never lump sum). Best entries when index falls 30%+ from peak. Never invest money you need within 5 years.':
idx.risk==='High'?'SIP is preferred. Look for entries when index corrects 15-20% from highs. Avoid buying at all-time highs. 3-5 year minimum hold.':
idx.risk==='Medium-High'?'SIP monthly for best results. Increase SIP amount when index drops 10-15%. Good as a 3-5 year core holding.':
'Start SIP anytime — do not try to time the market. Broad indices recover from every crash. The best time to start was yesterday. The second best is today.'
}</span></div>
<div style="padding:8px 10px;border-radius:6px;border-left:3px solid #10b981;background:rgba(16,185,129,.03)"><span style="font-size:9px;font-weight:700;color:#10b981">💰 SIP ESTIMATE (₹10K/month):</span> <span style="font-size:9px;color:var(--text2)">${
idx.cagr10.includes('18')||idx.cagr10.includes('20')||idx.cagr10.includes('22')||idx.cagr10.includes('25')?'5Y: ~₹9-10L · 10Y: ~₹30-38L · 20Y: ~₹1.5-2.8Cr — HIGH growth potential with HIGH volatility':
idx.cagr10.includes('14')||idx.cagr10.includes('15')||idx.cagr10.includes('16')?'5Y: ~₹8.5-9L · 10Y: ~₹25-30L · 20Y: ~₹1.1-1.5Cr — above-average returns with moderate risk':
idx.cagr10.includes('12')||idx.cagr10.includes('13')?'5Y: ~₹8.2L · 10Y: ~₹23L · 20Y: ~₹99L — solid wealth creation with manageable risk':
idx.cagr10.includes('10')||idx.cagr10.includes('11')?'5Y: ~₹7.7L · 10Y: ~₹20L · 20Y: ~₹76L — steady compounder, lower volatility':
'5Y: ~₹7-8L · 10Y: ~₹18-22L · 20Y: ~₹60-90L — historical estimates, actual may vary'
}</span></div>`:''}
</div>

<!-- Per-card inference -->
<div style="margin-top:8px;padding:10px 12px;border-radius:6px;background:rgba(6,182,212,.03);border-left:3px solid var(--cyan)">
<div style="font-size:9px;font-weight:700;color:var(--cyan)">💡 BOTTOM LINE FOR INVESTORS:</div>
<div style="font-size:9px;color:var(--text2);margin-top:3px;line-height:1.7">${
idx.risk==='Very High'?'This is a HIGH-RISK, HIGH-REWARD index. Only allocate money you will not need for 5+ years. Use SIP (systematic investing) to average out the wild swings — never invest a lump sum at market peaks. Limit to 10-15% of your total portfolio.':
idx.risk==='High'?'Higher risk than broad market indices. Suitable for investors with a 3-5 year horizon who can stomach 30-40% temporary drops. SIP is strongly recommended over lump sum. Position sizing: 15-25% of equity portfolio max.':
idx.type==='Volatility'?'This is NOT an investment — it is a TOOL. Watch it like a thermometer: when it spikes above '+('${idx.currency}'==='₹'?'25':'30')+', it historically marks excellent long-term buying opportunities for the main indices. The best investors buy when others panic.':
idx.type==='Sector'?'Sector indices are TACTICAL tools — use them for targeted bets on specific themes (banking, tech, pharma). Do not make them your core holding. Core should be broad market (Nifty 50 or S&P 500), with sector indices as 10-20% satellite positions.':
'A CORE HOLDING candidate for most portfolios. Broad market indices are the foundation of wealth building. Start a monthly SIP and forget about timing the market — time IN the market beats timing THE market. '+idx.stocks+' stocks provides good diversification.'
}</div>
</div>

</div></div>`;
});

return h;
};

// Build UI with geo toggle
let h=`
<!-- INTRO HERO -->
<div style="background:linear-gradient(135deg,#0a1628 0%,#0d2137 50%,#0a1628 100%);border-radius:14px;padding:24px;margin-bottom:20px;position:relative;overflow:hidden">
<div style="position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(6,182,212,.2),transparent 70%)"></div>
<div style="position:relative">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3);margin-bottom:6px">CELESYS AI · GLOBAL INDEX RESEARCH</div>
<div style="font-size:20px;font-weight:800;color:#fff;font-family:'Sora',sans-serif;margin-bottom:4px">Complete Index Research — India & USA</div>
<div style="font-size:11px;color:rgba(255,255,255,.5)">${INDEX_DATA.india.length} Indian Indices · ${INDEX_DATA.usa.length} US Indices · Live Prices · Deep Analysis</div>
</div>
</div>

<!-- WHAT IS AN INDEX? -->
<div style="padding:16px;border-radius:12px;background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.12);margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--cyan);margin-bottom:8px">📖 What is a Stock Market Index? (Explained Simply)</div>
<div style="font-size:10px;color:var(--text2);line-height:1.9">
An <strong>index</strong> is like a <strong>report card</strong> for a group of stocks. Just like your school report card averages your marks across subjects to give one number, a stock index averages the prices of many companies to give one number that tells you how that market segment is performing.<br><br>
<strong>Why should you care?</strong> Instead of picking individual stocks (risky — even experts get it wrong 60% of the time), you can invest in an index through an ETF or index fund. This gives you instant diversification — if one company fails, the others cushion the blow. Warren Buffett's advice to most people: <em>"Just buy an S&P 500 index fund."</em><br><br>
<strong>Key terms explained:</strong><br>
• <strong>CAGR</strong> = Compound Annual Growth Rate — your average yearly return including compounding. A 12% CAGR means ₹1 lakh becomes ₹3.1 lakh in 10 years.<br>
• <strong>Drawdown</strong> = The biggest peak-to-trough fall. -38% means if you invested at the peak, you'd temporarily lose 38%. Scary, but markets always recovered.<br>
• <strong>P/E Ratio</strong> = How expensive the index is. Higher = more expensive = lower expected future returns. Buy when P/E is below historical average.<br>
• <strong>SIP</strong> = Systematic Investment Plan — investing a fixed amount monthly. The BEST strategy for 90% of people because it averages your entry price automatically.<br>
• <strong>ETF</strong> = Exchange Traded Fund — a stock that tracks an index. You buy it like a share but get the entire index's returns. Cheapest way to invest in indices.
</div>
</div>

<!-- ASSET ALLOCATION BY AGE -->
<div style="padding:16px;border-radius:12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.12);margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--purple);margin-bottom:10px">🎯 Recommended Index Allocation by Life Stage</div>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Age Group</th><th>Large Cap</th><th>Mid/Small Cap</th><th>Sector Bets</th><th>US Indices</th><th>Debt/Gold</th><th>Strategy</th></tr>
<tr><td style="font-weight:700;color:var(--cyan)">20s (Aggressive)</td><td>30%</td><td style="color:#10b981;font-weight:700">35%</td><td>15%</td><td>15%</td><td>5%</td><td style="font-size:9px;color:var(--text3)">Max growth — time heals all drawdowns</td></tr>
<tr><td style="font-weight:700;color:var(--blue)">30s (Growth)</td><td>40%</td><td style="color:#10b981;font-weight:700">25%</td><td>10%</td><td>15%</td><td>10%</td><td style="font-size:9px;color:var(--text3)">Still growth-focused, start adding stability</td></tr>
<tr><td style="font-weight:700;color:var(--amber)">40s (Balanced)</td><td style="font-weight:700">45%</td><td>15%</td><td>5%</td><td>15%</td><td>20%</td><td style="font-size:9px;color:var(--text3)">Wealth preservation becomes important</td></tr>
<tr><td style="font-weight:700;color:#f97316">50s (Conservative)</td><td style="font-weight:700">40%</td><td>10%</td><td>0%</td><td>10%</td><td style="color:var(--amber);font-weight:700">40%</td><td style="font-size:9px;color:var(--text3)">Capital protection, reduce equity risk</td></tr>
<tr><td style="font-weight:700;color:var(--red)">60s+ (Income)</td><td>30%</td><td>5%</td><td>0%</td><td>5%</td><td style="color:var(--red);font-weight:700">60%</td><td style="font-size:9px;color:var(--text3)">Income generation, minimal risk</td></tr>
</table></div>
<div style="font-size:9px;color:var(--text3);margin-top:8px;line-height:1.6">💡 <strong>Rule of thumb:</strong> Equity % = 100 minus your age. A 30-year-old should have ~70% in equities (indices), 30% in debt/gold. Adjust based on your risk appetite and financial goals. SIP into index ETFs is the simplest way to implement this.</div>
</div>

<!-- SIP POWER TABLE -->
<div style="padding:16px;border-radius:12px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.12);margin-bottom:20px">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#10b981;margin-bottom:10px">💰 SIP Calculator — What ₹10,000/Month Grows To</div>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Index</th><th>Expected CAGR</th><th>5 Years</th><th>10 Years</th><th>20 Years</th><th>vs FD (7%)</th></tr>
<tr><td style="font-weight:700">Nifty 50</td><td>12%</td><td style="color:#10b981;font-weight:700">₹8.2L</td><td style="color:#10b981;font-weight:700">₹23.2L</td><td style="color:#10b981;font-weight:700">₹99.9L</td><td style="color:var(--cyan)">+40% more than FD</td></tr>
<tr><td style="font-weight:700">Nifty Midcap 150</td><td>16%</td><td style="color:#10b981;font-weight:700">₹9.0L</td><td style="color:#10b981;font-weight:700">₹29.5L</td><td style="color:#10b981;font-weight:700">₹1.56Cr</td><td style="color:var(--cyan)">+120% more than FD</td></tr>
<tr><td style="font-weight:700">Nifty Smallcap 250</td><td>20%</td><td style="color:#10b981;font-weight:700">₹9.8L</td><td style="color:#10b981;font-weight:700">₹38.0L</td><td style="color:#10b981;font-weight:700">₹2.84Cr</td><td style="color:var(--cyan)">+300% more than FD</td></tr>
<tr><td style="font-weight:700">S&P 500 (INR)</td><td>14%</td><td style="color:#10b981;font-weight:700">₹8.6L</td><td style="color:#10b981;font-weight:700">₹26.0L</td><td style="color:#10b981;font-weight:700">₹1.21Cr</td><td style="color:var(--cyan)">+70% more than FD</td></tr>
<tr style="background:rgba(245,158,11,.04)"><td style="font-weight:700;color:var(--amber)">Fixed Deposit (FD)</td><td style="color:var(--text3)">7%</td><td style="color:var(--text3)">₹7.2L</td><td style="color:var(--text3)">₹17.3L</td><td style="color:var(--text3)">₹52.0L</td><td style="color:var(--text3)">Baseline</td></tr>
</table></div>
<div style="padding:10px;border-radius:8px;background:rgba(16,185,129,.03);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:10px;color:var(--text2);line-height:1.8">💡 <strong>The Power of Compounding:</strong> ₹10,000/month in Nifty 50 for 20 years becomes ~₹1 Crore. The same money in FD becomes only ₹52 Lakh — that's ₹48 Lakh LESS. The catch? You must stay invested through crashes. Those who panic-sold in March 2020 missed the 100% recovery in 18 months. SIP automatically buys more units when prices fall (buying cheap) and fewer when prices rise — it takes emotion out of investing.<br><br><strong>Important:</strong> These are estimates based on historical returns and do not guarantee future performance. Actual returns will vary. Equity investments carry market risk.</div>
</div>
</div>

<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
<button class="idx-geo-btn active" onclick="switchIdxGeo(this,'india')" style="padding:8px 20px;border-radius:8px;font-size:12px;font-weight:700;border:2px solid var(--amber);background:var(--amber);color:#000;cursor:pointer;font-family:'Sora',sans-serif">🇮🇳 India (${INDEX_DATA.india.length} Indices)</button>
<button class="idx-geo-btn" onclick="switchIdxGeo(this,'usa')" style="padding:8px 20px;border-radius:8px;font-size:12px;font-weight:700;border:2px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-family:'Sora',sans-serif">🇺🇸 USA (${INDEX_DATA.usa.length} Indices)</button>
<span style="font-size:9px;color:var(--text3);margin-left:8px">Live prices update on tab click</span>
</div>
<div id="idxIndiaCards">${buildIndexCards('india')}</div>
<div id="idxUsaCards" style="display:none">${buildIndexCards('usa')}</div>

<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid var(--amber);margin:16px 0">
<div style="font-size:11px;font-weight:700;color:var(--amber)">💡 Which Indices Should YOU Invest In?</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8"><strong>Beginner investor:</strong> Start with ONE broad market index — Nifty 50 (India) or S&P 500 (USA). Just start a monthly SIP and don't look at it daily. This alone will beat 80% of actively managed mutual funds over 10 years.<br><strong>Intermediate investor:</strong> Core (60-70%) in Nifty 50 + S&P 500. Satellite (20-30%) in mid/small-cap or sector indices for alpha. Keep 10% in debt/gold for stability.<br><strong>Aggressive investor:</strong> Overweight small caps and sector bets (IT, Banking, Semiconductors) for higher returns. Accept 40-50% drawdowns as the price of entry. Must have 5+ year horizon.<br><strong>Income-focused:</strong> Focus on dividend-heavy indices (Nifty Dividend Opportunities, Dow Jones). Reinvest dividends through SIP for compounding.<br><strong>Key principle:</strong> Diversification across geographies (India + US) reduces risk without sacrificing returns. A 70/30 India-US split captures India's growth AND hedges against rupee depreciation.</div>
</div>

<!-- COMPARISON TABLE -->
<div style="margin-top:20px;padding:18px;border-radius:12px;background:rgba(6,182,212,.03);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">📊 Cross-Market Comparison — India vs USA</div>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Metric</th><th style="color:var(--amber)">🇮🇳 India</th><th style="color:var(--blue)">🇺🇸 USA</th><th>Insight</th></tr>
<tr><td style="font-weight:600">Primary Index</td><td>Nifty 50 (50 stocks)</td><td>S&P 500 (500 stocks)</td><td style="font-size:9px;color:var(--text3)">US more diversified by constituent count</td></tr>
<tr><td style="font-weight:600">10Y CAGR</td><td style="color:#10b981;font-weight:700">~12-13%</td><td style="color:#10b981;font-weight:700">~12-13%</td><td style="font-size:9px;color:var(--text3)">Remarkably similar long-term returns</td></tr>
<tr><td style="font-weight:600">Typical P/E</td><td style="color:var(--amber)">20-22x</td><td style="color:var(--amber)">18-22x</td><td style="font-size:9px;color:var(--text3)">India slight premium for higher growth</td></tr>
<tr><td style="font-weight:600">Top Sector</td><td>Financials (~35%)</td><td>Technology (~30%)</td><td style="font-size:9px;color:var(--text3)">India = financialization play, US = tech play</td></tr>
<tr><td style="font-weight:600">Currency Effect (for INR investor)</td><td style="color:#10b981">None</td><td style="color:var(--amber)">+3-5% from INR depreciation</td><td style="font-size:9px;color:var(--text3)">US returns amplified by rupee weakness</td></tr>
<tr><td style="font-weight:600">Max Drawdown</td><td style="color:var(--red)">-38% (2020)</td><td style="color:var(--red)">-34% (2020)</td><td style="font-size:9px;color:var(--text3)">Both fall ~35% in crashes. Recovery takes 6-18 months.</td></tr>
<tr><td style="font-weight:600">SIP ₹10K/month (10Y)</td><td style="font-weight:700;color:#10b981">~₹22-25L corpus</td><td style="font-weight:700;color:#10b981">~₹24-28L corpus (INR terms)</td><td style="font-size:9px;color:var(--text3)">US slightly higher due to INR depreciation benefit</td></tr>
<tr><td style="font-weight:600">Best Small Cap</td><td>Nifty Smallcap 250 (~20% CAGR)</td><td>Russell 2000 (~8% CAGR)</td><td style="font-size:9px;color:#10b981;font-weight:700">India small caps massively outperform US small caps</td></tr>
<tr><td style="font-weight:600">Volatility (VIX avg)</td><td>~14-18</td><td>~14-20</td><td style="font-size:9px;color:var(--text3)">Similar volatility regimes</td></tr>
<tr><td style="font-weight:600">Recommendation</td><td colspan="2" style="color:var(--cyan);font-weight:700;text-align:center">70% India + 30% US allocation for Indian investors</td><td style="font-size:9px;color:var(--text3)">Diversification + INR hedge</td></tr>
</table></div>
</div>

<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin:16px 0">
<div style="font-size:11px;font-weight:700;color:#10b981">💡 India vs USA — The Bottom Line:</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.8"><strong>Why India?</strong> Fastest-growing major economy, young population (median age 28 vs 38 in US), rising middle class, digital transformation underway. Small/mid caps offer 15-25% CAGR potential — rare anywhere else in the world.<br><strong>Why USA?</strong> Home to the world's greatest companies (Apple, Microsoft, NVIDIA). Technology leadership, deepest capital markets, reserve currency advantage. US investments also serve as an INR depreciation hedge — when the rupee weakens, your US holdings become worth more in rupee terms.<br><strong>The winning formula:</strong> Indian investors should allocate 60-70% to Indian markets (you benefit from local knowledge + no currency risk) and 30-40% to US markets (global diversification + INR hedge). Both markets have delivered ~12% CAGR over 10 years, but the combination provides smoother returns because they don't always move together.</div>
</div>

<!-- EDUCATIONAL NOTES -->
<div style="margin-top:16px;padding:14px;border-radius:10px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12)">
<div style="font-size:10px;font-weight:700;color:var(--amber);margin-bottom:6px">📚 How to Use This Research</div>
<div style="font-size:9px;color:var(--text3);line-height:1.8">
• <strong>SIP investors:</strong> Pick 1-2 broad market indices (Nifty 50 + S&P 500) for core allocation. Add sector indices only for satellite/tactical positions.<br>
• <strong>Options traders:</strong> Bank Nifty and Nifty 50 offer the best liquidity. Watch VIX for timing.<br>
• <strong>Growth seekers:</strong> India small/mid caps have the highest CAGR but also deepest drawdowns. Size your position accordingly.<br>
• <strong>Income investors:</strong> Dow Jones and Nifty 50 Dividend indices offer higher yields than growth indices.<br>
• <strong>Contrarian signal:</strong> When VIX spikes above 30 (US) or 25 (India), it historically marks excellent long-term entry points for SIPs.<br>
⚖️ <strong>Disclaimer:</strong> Index returns shown are historical and do not guarantee future performance. This is for educational purposes only — not investment advice. Always consult a SEBI-registered advisor.
</div>
</div>

<!-- COMMON MISTAKES -->
<div style="margin-top:16px;padding:16px;border-radius:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.12)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--red);margin-bottom:10px">🚫 7 Common Mistakes Index Investors Make</div>
<div style="font-size:10px;color:var(--text2);line-height:2">
<strong>1. Stopping SIP during crashes:</strong> This is the WORST thing you can do. Crashes are when SIP works best — you buy more units at lower prices. The investors who continued SIP through March 2020 saw 100%+ returns by 2021.<br>
<strong>2. Chasing last year's best-performing index:</strong> Small caps returned 50% last year? Everyone piles in. Then they crash 30%. Performance chasing destroys returns. Stick to your asset allocation plan.<br>
<strong>3. Investing lump sum at market peaks:</strong> If you have a large amount, deploy it over 6-12 months through STP (Systematic Transfer Plan) rather than all at once. This protects against bad timing.<br>
<strong>4. Ignoring expense ratios:</strong> A Nifty 50 ETF with 0.05% expense ratio will earn ₹15L more over 20 years than one with 0.50% on a ₹10K/month SIP. Always pick the cheapest ETF/index fund for the same index.<br>
<strong>5. Checking portfolio daily:</strong> Index investing is a long-term game. Checking daily causes emotional decisions. Set up SIP and review quarterly at most.<br>
<strong>6. No US allocation:</strong> Indian investors miss out on rupee depreciation hedge and global diversification. Even 20-30% in S&P 500 significantly improves risk-adjusted returns.<br>
<strong>7. Treating sector indices as core holdings:</strong> Sector indices (Bank Nifty, Nifty IT) should be SATELLITE positions (10-20% max), not your core allocation. Core should always be broad market indices.
</div>
</div>

<!-- GLOSSARY -->
<div style="margin-top:16px;padding:16px;border-radius:12px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--blue);margin-bottom:10px">📘 Quick Glossary — Terms Used in This Report</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px;font-size:9px;color:var(--text2);line-height:1.7">
<div><strong style="color:var(--cyan)">Bull Market:</strong> When indices rise 20%+ from recent lows. Characterized by optimism and rising prices. Can last 2-10 years.</div>
<div><strong style="color:var(--cyan)">Bear Market:</strong> When indices fall 20%+ from recent highs. Characterized by fear and falling prices. Typically lasts 6-18 months.</div>
<div><strong style="color:var(--cyan)">Correction:</strong> A 10-20% drop from recent peak. Normal and healthy — happens 1-2 times per year. Not a bear market.</div>
<div><strong style="color:var(--cyan)">Free-float Market Cap:</strong> Only counts shares available for public trading (excludes promoter holdings). Used for weighting in most indices.</div>
<div><strong style="color:var(--cyan)">Rebalancing:</strong> When the index committee adds/removes stocks to keep the index representative. Creates buying/selling pressure on affected stocks.</div>
<div><strong style="color:var(--cyan)">Tracking Error:</strong> How much an ETF/index fund deviates from the actual index. Lower = better. Good ETFs have < 0.5% tracking error.</div>
<div><strong style="color:var(--cyan)">NAV:</strong> Net Asset Value — the per-unit price of an index fund. When you invest ₹10K, you get ₹10K ÷ NAV = number of units.</div>
<div><strong style="color:var(--cyan)">AUM:</strong> Assets Under Management — total money invested in a fund. Higher AUM generally means lower costs and tighter tracking.</div>
</div>
</div>

<!-- MARKET CYCLES EXPLAINED -->
<div style="margin-top:16px;padding:16px;border-radius:12px;background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.12)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--cyan);margin-bottom:10px">🔄 Understanding Market Cycles — When to Be Brave & When to Be Careful</div>
<div style="font-size:10px;color:var(--text2);line-height:1.9;margin-bottom:12px">Markets move in CYCLES — just like seasons. Understanding where we are in the cycle helps you make better decisions. Here's what each phase looks like:</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.05);border-left:4px solid #10b981">
<div style="font-weight:700;color:#10b981;font-size:11px;margin-bottom:4px">🌱 Phase 1: RECOVERY (Best time to invest)</div>
<div style="font-size:9px;color:var(--text2);line-height:1.7"><strong>Signs:</strong> Markets have fallen 20-40% from peak. News is terrible. Everyone is scared. VIX is above 25-30.<br><strong>What to do:</strong> This is when SIPs work MAGIC. Your monthly ₹10K buys more units at lower prices. Increase SIP amount if possible. The March 2020 crash was a perfect example — those who invested saw 100%+ returns within 18 months.<br><strong>Analogy:</strong> Like shopping at an end-of-season sale — the same jacket, 40% off. The company hasn't changed, just the price tag.</div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(59,130,246,.05);border-left:4px solid var(--blue)">
<div style="font-weight:700;color:var(--blue);font-size:11px;margin-bottom:4px">📈 Phase 2: BULL MARKET (Ride the wave)</div>
<div style="font-size:9px;color:var(--text2);line-height:1.7"><strong>Signs:</strong> Markets steadily climbing. Positive economic data. IPOs booming. People talking about stocks at dinner parties.<br><strong>What to do:</strong> Continue SIP — don't stop just because prices are rising. Avoid the temptation to go "all in" with lump sums at highs. This is the time to gradually REDUCE risk — if you were 80% equity, bring it to 70%.<br><strong>Analogy:</strong> Like a river flowing downstream — go with the flow but don't lean too far over the boat.</div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.05);border-left:4px solid var(--amber)">
<div style="font-weight:700;color:var(--amber);font-size:11px;margin-bottom:4px">⚡ Phase 3: EUPHORIA (Danger zone)</div>
<div style="font-size:9px;color:var(--text2);line-height:1.7"><strong>Signs:</strong> Everyone is making money. Your cab driver gives stock tips. SME IPOs are 200% oversubscribed. "This time is different" talk. P/E ratios at historic highs.<br><strong>What to do:</strong> REDUCE exposure. Move some equity gains to debt/gold. Don't add new money to small/mid caps. Continue SIP only in large cap indices. Book partial profits.<br><strong>Analogy:</strong> Like a party at 3 AM — the music is great but the hangover is coming. Smart guests have already left.</div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(239,68,68,.05);border-left:4px solid var(--red)">
<div style="font-weight:700;color:var(--red);font-size:11px;margin-bottom:4px">📉 Phase 4: CRASH (Stay calm, don't sell)</div>
<div style="font-size:9px;color:var(--text2);line-height:1.7"><strong>Signs:</strong> Markets falling 5-10% in a week. Panic selling. CNBC shows red everywhere. Your portfolio is down 25%+. You want to sell everything.<br><strong>What to do:</strong> DO NOTHING. Or better — increase your SIP. The WORST thing you can do is sell during a crash. History shows markets ALWAYS recover. Nifty crashed 38% in March 2020 and hit all-time highs 18 months later.<br><strong>Analogy:</strong> Like a thunderstorm — scary while it happens, but the sun always comes out. The flowers that survive the storm grow strongest.</div>
</div>
</div>
<div style="padding:10px;border-radius:6px;background:rgba(16,185,129,.03);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:9px;font-weight:700;color:#10b981">💡 The Golden Rule of Market Cycles:</div>
<div style="font-size:9px;color:var(--text2);line-height:1.7">Be <strong>greedy when others are fearful</strong> (buy during crashes) and <strong>fearful when others are greedy</strong> (reduce exposure during euphoria). This is easy to say and incredibly hard to do — which is why SIP works so well. It forces you to invest consistently regardless of emotions. Since 1996, every single 10-year SIP in Nifty 50 has been profitable. Every. Single. One.</div>
</div>
</div>

<!-- YOUR INVESTING PERSONALITY -->
<div style="margin-top:16px;padding:16px;border-radius:12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.12)">
<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--purple);margin-bottom:10px">🧠 Find Your Investing Personality — Which Indices Fit You?</div>
<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>If You Are...</th><th>Your Core Indices</th><th>Satellite (10-20%)</th><th>Monthly SIP Range</th><th>Expected Pain</th></tr>
<tr><td style="font-weight:600;color:#10b981">🐢 Conservative (I can't lose money)</td><td>70% Nifty 50 + 20% S&P 500</td><td>10% Nifty Next 50</td><td>₹5K-25K</td><td style="font-size:9px;color:var(--text3)">-15 to -25% in bad years, but fastest recovery</td></tr>
<tr><td style="font-weight:600;color:var(--blue)">🦊 Balanced (I want growth with some safety)</td><td>50% Nifty 50 + 20% S&P 500</td><td>20% Midcap 150 + 10% Bank Nifty</td><td>₹10K-50K</td><td style="font-size:9px;color:var(--text3)">-25 to -35% in bad years, recovers in 1-2 years</td></tr>
<tr><td style="font-weight:600;color:var(--amber)">🦁 Aggressive (I want max returns, 5+ year horizon)</td><td>30% Nifty 50 + 15% S&P 500</td><td>25% Midcap + 20% Smallcap + 10% NASDAQ 100</td><td>₹15K-1L</td><td style="font-size:9px;color:var(--text3)">-35 to -50% in bad years, takes 2-3 years to recover</td></tr>
<tr><td style="font-weight:600;color:var(--red)">🦅 Options Trader (I trade, not invest)</td><td>Watch: Bank Nifty + Nifty 50</td><td>Use VIX as timing signal</td><td>N/A (active)</td><td style="font-size:9px;color:var(--text3)">Can lose 100% of premium; only risk what you can afford to lose</td></tr>
</table></div>
<div style="font-size:9px;color:var(--text3);margin-top:6px;line-height:1.6">💡 <strong>Key insight:</strong> Most people THINK they are aggressive until their portfolio drops 30%. Be honest with yourself about how much loss you can handle emotionally without selling. If the answer is "not much," be Conservative. You'll sleep better AND still beat FDs.</div>
</div>

<!-- FINAL DISCLAIMER -->
<div style="margin-top:16px;padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12)">
<div style="font-size:9px;color:var(--text3);line-height:1.6">
<strong style="color:var(--amber)">⚖️ Disclaimer:</strong> All index data, CAGRs, SIP estimates, and returns shown are based on HISTORICAL performance and <strong>do not guarantee future results</strong>. Markets are inherently unpredictable. This research is for <strong>educational purposes only</strong> — not investment advice. Always consult a SEBI-registered investment advisor before making any financial decisions. Celesys AI is not registered with SEBI or any regulatory body. Past performance is not indicative of future returns.
</div>
</div>`;

el.innerHTML=h;

// Geo toggle function
window.switchIdxGeo=function(btn,geo){
document.querySelectorAll('.idx-geo-btn').forEach(b=>{b.style.background='transparent';b.style.color='var(--text)';b.style.borderColor='var(--border)';b.classList.remove('active')});
btn.style.background='var(--amber)';btn.style.color='#000';btn.style.borderColor='var(--amber)';btn.classList.add('active');
document.getElementById('idxIndiaCards').style.display=geo==='india'?'':'none';
document.getElementById('idxUsaCards').style.display=geo==='usa'?'':'none';
_geo=geo;
fetchIndexPrices(geo);
};

// Fetch live prices for visible indices
fetchIndexPrices('india');
console.log('✅ Index Research rendered:',INDEX_DATA.india.length+INDEX_DATA.usa.length,'indices');
}

async function fetchIndexPrices(geo){
const data=INDEX_DATA[geo];
if(!data)return;
const tickers=data.filter(d=>d.yf).map(d=>d.yf);
if(!tickers.length)return;
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:tickers})});
if(!res.ok)return;
const result=await res.json();
if(!result.success||!result.prices)return;
document.querySelectorAll('[data-idx-ticker]').forEach(cell=>{
const tk=cell.dataset.idxTicker;
const p=result.prices[tk];
if(p&&p.formatted){
const up=(p.change_pct||0)>=0;
cell.innerHTML=`${p.formatted} <span style="font-size:11px;color:${up?'#10b981':'#ef4444'}">${up?'▲':'▼'}${Math.abs(p.change_pct||0).toFixed(2)}%</span>`;
cell.style.color=up?'#10b981':'#ef4444';
}else{cell.innerHTML='—';cell.style.color='var(--text3)'}
});
console.log('✅ Index prices:',Object.keys(result.prices).length,'loaded');
}catch(e){console.error('Index prices error:',e)}
}

// ═══════════════════════════════════════════════
// ═══════════════════════════════════════════════
// MARKET DAILY ANALYSIS — Nifty, Bank Nifty, Sensex
// ═══════════════════════════════════════════════

// ═══════════════════════════════════════════════
// ROADMAP FEATURES: PDF, Compare, Share, Tech, Peer, Earnings, Insider, Theme
// ═══════════════════════════════════════════════

// ═══ 1. DARK/LIGHT THEME TOGGLE ═══
(function initTheme(){
const saved=localStorage.getItem('celesys-theme')||'light';
document.documentElement.setAttribute('data-theme',saved);
window._currentTheme=saved;
})();

function toggleTheme(){
const next=window._currentTheme==='dark'?'light':'dark';
document.documentElement.setAttribute('data-theme',next);
window._currentTheme=next;
localStorage.setItem('celesys-theme',next);
const btn=document.getElementById('themeToggleBtn');
if(btn)btn.innerHTML=next==='dark'?'&#127763; Dark':'&#9728; Light';
}

// ═══ 2. PDF EXPORT ═══
async function exportPDF(){
const btn=document.getElementById('pdfExportBtn');
if(btn){btn.innerHTML='&#9203; Generating...';btn.disabled=true;}
try{
if(!window.html2pdf){
const s=document.createElement('script');
s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
document.head.appendChild(s);
await new Promise((res,rej)=>{s.onload=res;s.onerror=rej;setTimeout(rej,10000);});
}
const el=document.getElementById('tabContentArea');
if(!el){throw new Error('No report content found');}
const ticker=document.getElementById('resultCard')?.querySelector('h1')?.textContent||'Report';
const opt={margin:[10,8,10,8],filename:ticker.replace(/[^a-zA-Z0-9]/g,'_')+'_Celesys_Report.pdf',image:{type:'jpeg',quality:0.92},html2canvas:{scale:1.5,useCORS:true,logging:false,letterRendering:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},pagebreak:{mode:['avoid-all','css','legacy']}};
await html2pdf().set(opt).from(el).save();
}catch(e){
alert('PDF generation failed: '+e.message+'. Try again or use browser Print (Ctrl+P) as PDF.');
}finally{
if(btn){btn.innerHTML='&#128196; Export PDF';btn.disabled=false;}
}
}

// ═══ 3. SHARE (WhatsApp, Email, Copy) ═══
function shareReport(method){
const ticker=document.querySelector('#resultCard h1')?.textContent||'Stock';
const price=document.querySelector('#resultCard .hero-price')?.textContent||'';
const url=window.location.href;
const text=`Check out this detailed AI analysis of ${ticker} ${price} on Celesys AI! ${url}`;

if(method==='whatsapp'){
window.open('https://api.whatsapp.com/send?text='+encodeURIComponent(text),'_blank');
}else if(method==='email'){
window.open('mailto:?subject='+encodeURIComponent(ticker+' — AI Stock Analysis | Celesys')+'&body='+encodeURIComponent(text),'_blank');
}else if(method==='copy'){
navigator.clipboard.writeText(text).then(()=>{
const btn=document.getElementById('copyShareBtn');
if(btn){const orig=btn.innerHTML;btn.innerHTML='&#9989; Copied!';setTimeout(()=>btn.innerHTML=orig,2000);}
}).catch(()=>prompt('Copy this link:',text));
}else if(navigator.share){
navigator.share({title:ticker+' Analysis',text:text,url:url}).catch(()=>{});
}
}

// ═══ 4. COMPARE 2 STOCKS ═══
async function compareStocks(){
const t1=document.getElementById('cmp_stock1')?.value?.trim();
const t2=document.getElementById('cmp_stock2')?.value?.trim();
const el=document.getElementById('cmp_result');
if(!t1||!t2||!el){el.innerHTML='<div style="color:var(--red);font-size:11px">Enter both stock names.</div>';return;}
el.innerHTML='<div style="text-align:center;padding:30px;color:var(--text3)"><div style="font-size:24px;animation:spin 1s linear infinite">&#9203;</div><div style="margin-top:6px;font-size:10px">Fetching data for both stocks...</div></div>';

try{
const [r1,r2]=await Promise.all([
fetch('/api/stock-data?company='+encodeURIComponent(t1)).then(r=>r.json()),
fetch('/api/stock-data?company='+encodeURIComponent(t2)).then(r=>r.json())
]);
if(!r1.success||!r2.success){el.innerHTML='<div style="color:var(--red);font-size:11px">Could not fetch data. Check stock names.</div>';return;}
renderComparison(r1,r2,el);
}catch(e){el.innerHTML='<div style="color:var(--red);font-size:11px">Error: '+e.message+'</div>';}
}

function renderComparison(a,b,el){
const S=a.currency==='INR'?'&#8377;':'$';
const _f=(v)=>{if(v==='N/A'||v===null||v===undefined)return 'N/A';const n=parseFloat(v);if(isNaN(n))return String(v);return n.toLocaleString('en-IN',{maximumFractionDigits:2});};
const _w=(va,vb,higher)=>{
if(va==='N/A'||vb==='N/A')return ['var(--text3)','var(--text3)'];
const na=parseFloat(va),nb=parseFloat(vb);
if(isNaN(na)||isNaN(nb))return ['var(--text3)','var(--text3)'];
if(higher){return na>nb?['#10b981','#ef4444']:na<nb?['#ef4444','#10b981']:['#f59e0b','#f59e0b'];}
else{return na<nb?['#10b981','#ef4444']:na>nb?['#ef4444','#10b981']:['#f59e0b','#f59e0b'];}
};

const metrics=[
{label:'Price',a:_f(a.current_price),b:_f(b.current_price),unit:S,higher:null},
{label:'Market Cap',a:_f(a.market_cap),b:_f(b.market_cap),unit:S,higher:true},
{label:'P/E Ratio',a:_f(a.pe_ratio),b:_f(b.pe_ratio),higher:false},
{label:'P/B Ratio',a:_f(a.pb_ratio),b:_f(b.pb_ratio),higher:false},
{label:'ROE',a:_f(a.roe),b:_f(b.roe),unit:'%',higher:true},
{label:'Profit Margin',a:_f(a.profit_margin),b:_f(b.profit_margin),unit:'%',higher:true},
{label:'Revenue Growth',a:_f(a.revenue_growth),b:_f(b.revenue_growth),unit:'%',higher:true},
{label:'Debt/Equity',a:_f(a.debt_to_equity),b:_f(b.debt_to_equity),higher:false},
{label:'Beta',a:_f(a.beta),b:_f(b.beta),higher:false},
{label:'Dividend Yield',a:_f(a.dividend_yield),b:_f(b.dividend_yield),unit:'%',higher:true},
{label:'EPS (TTM)',a:_f(a.eps_ttm),b:_f(b.eps_ttm),unit:S,higher:true},
{label:'Free Cash Flow',a:_f(a.free_cash_flow),b:_f(b.free_cash_flow),unit:S,higher:true},
{label:'Current Ratio',a:_f(a.current_ratio),b:_f(b.current_ratio),higher:true},
{label:'52W High',a:_f(a.week52_high),b:_f(b.week52_high),unit:S,higher:null},
{label:'52W Low',a:_f(a.week52_low),b:_f(b.week52_low),unit:S,higher:null},
{label:'Operating Margin',a:_f(a.operating_margin),b:_f(b.operating_margin),unit:'%',higher:true},
{label:'PEG Ratio',a:_f(a.peg_ratio),b:_f(b.peg_ratio),higher:false},
];

let scoreA=0,scoreB=0;
metrics.forEach(m=>{
if(m.higher===null)return;
const na=parseFloat(String(m.a).replace(/[^0-9.-]/g,'')),nb=parseFloat(String(m.b).replace(/[^0-9.-]/g,''));
if(isNaN(na)||isNaN(nb))return;
if(m.higher){if(na>nb)scoreA++;else if(nb>na)scoreB++;}
else{if(na<nb)scoreA++;else if(nb<na)scoreB++;}
});
const winner=scoreA>scoreB?a.company_name:scoreB>scoreA?b.company_name:'Tie';
const winC=scoreA>scoreB?'#10b981':scoreB>scoreA?'#3b82f6':'#f59e0b';

let h=`<div style="padding:16px;border-radius:12px;background:linear-gradient(135deg,#0a1628,#0d2137);text-align:center;margin-bottom:14px">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3)">HEAD-TO-HEAD COMPARISON</div>
<div style="font-size:18px;font-weight:800;color:#fff;margin:4px 0">${a.company_name} <span style="color:var(--text3);font-size:14px">vs</span> ${b.company_name}</div>
<div style="font-size:13px;font-weight:700;color:${winC}">Winner: ${winner} (${scoreA}-${scoreB})</div>
</div>`;

h+=`<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:10px">
<tr style="background:rgba(59,130,246,.06)"><th style="padding:8px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border)">Metric</th><th style="padding:8px;text-align:right;color:#3b82f6;border-bottom:1px solid var(--border)">${a.company_name}</th><th style="padding:8px;text-align:right;color:#8b5cf6;border-bottom:1px solid var(--border)">${b.company_name}</th><th style="padding:8px;text-align:center;color:var(--text3);border-bottom:1px solid var(--border)">Winner</th></tr>`;
metrics.forEach(m=>{
const colors=m.higher!==null?_w(m.a,m.b,m.higher):['var(--text)','var(--text)'];
const w=m.higher===null?'-':colors[0]==='#10b981'?a.company_name.split(' ')[0]:colors[1]==='#10b981'?b.company_name.split(' ')[0]:'Tie';
h+=`<tr><td style="padding:6px 8px;border-bottom:1px solid var(--border);color:var(--text2)">${m.label}</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid var(--border);color:${colors[0]};font-weight:700;font-family:var(--mono)">${m.unit||''}${m.a}</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid var(--border);color:${colors[1]};font-weight:700;font-family:var(--mono)">${m.unit||''}${m.b}</td><td style="padding:6px 8px;text-align:center;border-bottom:1px solid var(--border);font-size:9px;color:var(--text3)">${w}</td></tr>`;
});
h+='</table></div>';

h+=`<div style="padding:12px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid #8b5cf6;margin-top:12px">
<div style="font-size:10px;font-weight:700;color:#8b5cf6">&#128161; Comparison Insight:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">
${winner!=='Tie'?'<strong>'+winner+'</strong> wins on '+Math.max(scoreA,scoreB)+' out of '+metrics.filter(m=>m.higher!==null).length+' comparable metrics. ':'Both stocks are evenly matched. '}
${scoreA>scoreB?a.company_name+' has better fundamentals overall. ':scoreB>scoreA?b.company_name+' has better fundamentals overall. ':'Consider sector trends and growth potential to break the tie. '}
Remember: no single comparison tells the whole story. Consider industry dynamics, management quality, and your investment timeline.
</div></div>`;
el.innerHTML=h;
}

// ═══ 5. RENDER INSIDER ACTIVITY ═══
function renderInsiderActivity(d){
const el=document.getElementById('insiderSection');
if(!el)return;
const trades=d.insider_trades||[];
const buys=d.insider_buys||0;
const sells=d.insider_sells||0;
const signal=d.insider_signal||'N/A';
const S=d.currency==='INR'?'&#8377;':'$';
const _f=(v)=>{if(!v||v==='N/A')return 'N/A';const n=parseFloat(v);if(isNaN(n))return String(v);const a=Math.abs(n);if(a>=1e7)return S+(a/1e7).toFixed(2)+'Cr';if(a>=1e5)return S+(a/1e5).toFixed(2)+'L';return S+a.toLocaleString('en-IN');};

if(!trades.length&&signal==='N/A'){el.style.display='none';return;}
el.style.display='block';

const sigC=signal==='BULLISH'?'#10b981':signal==='BEARISH'?'#ef4444':'#f59e0b';
const sigE=signal==='BULLISH'?'&#128994;':signal==='BEARISH'?'&#128308;':'&#128992;';

let h=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#128100; Insider Activity — Follow the Smart Money</div>`;

h+=`<div style="padding:12px;border-radius:10px;background:rgba(139,92,246,.04);border-left:4px solid #8b5cf6;margin-bottom:10px">
<div style="font-size:10px;color:var(--text2);line-height:1.7">&#128161; <strong>Why it matters:</strong> When a CEO buys their own company stock with their own money, it is the ultimate vote of confidence — like a chef eating at their own restaurant. If insiders are selling heavily, it may signal they know something the market does not yet.</div>
</div>`;

h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:10px;border-radius:8px;border:2px solid ${sigC};background:${sigC}08;text-align:center"><div style="font-size:8px;color:var(--text3)">Signal</div><div style="font-size:14px;font-weight:800;color:${sigC}">${sigE} ${signal}</div></div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Buys</div><div style="font-size:18px;font-weight:800;color:#10b981">${buys}</div></div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Sells</div><div style="font-size:18px;font-weight:800;color:#ef4444">${sells}</div></div>
</div>`;

if(trades.length>0){
h+=`<div style="overflow-x:auto;margin-bottom:10px"><table style="width:100%;border-collapse:collapse;font-size:9px">
<tr style="background:rgba(139,92,246,.06)"><th style="padding:6px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border)">Date</th><th style="padding:6px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border)">Insider</th><th style="padding:6px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border)">Type</th><th style="padding:6px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Shares</th><th style="padding:6px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Value</th></tr>`;
trades.slice(0,8).forEach(t=>{
const isBuy=String(t.type||'').toLowerCase().includes('buy')||String(t.type||'').toLowerCase().includes('purchase');
h+=`<tr><td style="padding:4px 6px;border-bottom:1px solid var(--border);color:var(--text2)">${t.date||'N/A'}</td><td style="padding:4px 6px;border-bottom:1px solid var(--border);color:var(--text)">${(t.name||'').substring(0,25)}</td><td style="padding:4px 6px;border-bottom:1px solid var(--border);color:${isBuy?'#10b981':'#ef4444'};font-weight:700">${t.type||'N/A'}</td><td style="padding:4px 6px;text-align:right;border-bottom:1px solid var(--border);font-family:var(--mono)">${(t.shares||0).toLocaleString()}</td><td style="padding:4px 6px;text-align:right;border-bottom:1px solid var(--border);font-family:var(--mono)">${_f(t.value)}</td></tr>`;
});
h+='</table></div>';
}
el.innerHTML=h;
}

// ═══ 6. RENDER EARNINGS COUNTDOWN ═══
function renderEarningsCountdown(d){
const el=document.getElementById('earningsSection');
if(!el)return;
const nextE=d.next_earnings;
if(!nextE||nextE==='N/A'){el.style.display='none';return;}
el.style.display='block';

const S=d.currency==='INR'?'&#8377;':'$';
const _f=(v)=>{if(!v||v==='N/A')return 'N/A';const n=parseFloat(v);return isNaN(n)?String(v):n.toLocaleString('en-IN',{maximumFractionDigits:2});};

let daysLeft='N/A';
try{
const ed=new Date(nextE);
const now=new Date();
const diff=Math.ceil((ed-now)/(1000*60*60*24));
daysLeft=diff>0?diff+' days':diff===0?'TODAY':'Passed';
}catch(e){}

const estLow=_f(d.earnings_est_low);
const estHigh=_f(d.earnings_est_high);
const estAvg=_f(d.earnings_est_avg);
const revEst=_f(d.revenue_est_avg);

let h=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#128197; Earnings Countdown — Never Get Blindsided</div>`;

h+=`<div style="padding:12px;border-radius:10px;background:rgba(245,158,11,.04);border-left:4px solid #f59e0b;margin-bottom:10px">
<div style="font-size:10px;color:var(--text2);line-height:1.7">&#128161; <strong>Why it matters:</strong> Stocks can move 5-20% on earnings day. Knowing the date and expectations lets you prepare — take profits before, buy the dip after, or simply avoid getting caught off-guard. Think of it like knowing when your exam results come out — you want to be ready.</div>
</div>`;

h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:12px;border-radius:8px;border:2px solid #f59e0b;background:rgba(245,158,11,.06);text-align:center"><div style="font-size:8px;color:var(--text3)">Next Earnings</div><div style="font-size:12px;font-weight:800;color:#f59e0b">${nextE}</div><div style="font-size:10px;font-weight:700;color:${daysLeft==='TODAY'?'#ef4444':parseInt(daysLeft)<7?'#f59e0b':'var(--text2)'}">${daysLeft}</div></div>
<div style="padding:12px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">EPS Estimate</div><div style="font-size:14px;font-weight:700;color:var(--cyan);font-family:var(--mono)">${S}${estAvg}</div><div style="font-size:8px;color:var(--text3)">Range: ${S}${estLow} — ${S}${estHigh}</div></div>
<div style="padding:12px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Revenue Estimate</div><div style="font-size:14px;font-weight:700;color:#8b5cf6;font-family:var(--mono)">${S}${revEst}</div></div>
</div>`;

el.innerHTML=h;
}

// ═══ 7. ENHANCED TECHNICAL INDICATORS (rendered in Quick tab) ═══
function renderTechnicalsPro(d){
const el=document.getElementById('techProSection');
if(!el)return;
const _s=(k,def)=>{const v=d[k];if(!v||v==='N/A')return def||0;return parseFloat(String(v).replace(/[,%]/g,''))||def||0;};
const price=_s('current_price',0);
if(!price){el.style.display='none';return;}
el.style.display='block';

const sma20=_s('sma_20',price);const sma50=_s('sma_50',price);const sma200=_s('sma_200',price);
const ema9=_s('ema_9',price);const ema21=_s('ema_21',price);const ema50=_s('ema_50',price);
const S=d.currency==='INR'?'&#8377;':'$';

// Calculate RSI from price history
let rsi=50;
const hist=d.price_history||[];
if(hist.length>2){
let gains=0,losses=0;
for(let i=1;i<hist.length;i++){
const diff=hist[i]-hist[i-1];
if(diff>0)gains+=diff;else losses+=Math.abs(diff);
}
const avgGain=gains/(hist.length-1);const avgLoss=losses/(hist.length-1);
rsi=avgLoss===0?100:Math.round(100-(100/(1+avgGain/avgLoss)));
}

// Signals
const signals=[];
if(price>sma20)signals.push({t:'Price > SMA20',s:'BUY',c:'#10b981'});else signals.push({t:'Price < SMA20',s:'SELL',c:'#ef4444'});
if(price>sma50)signals.push({t:'Price > SMA50',s:'BUY',c:'#10b981'});else signals.push({t:'Price < SMA50',s:'SELL',c:'#ef4444'});
if(price>sma200)signals.push({t:'Price > SMA200',s:'BUY',c:'#10b981'});else signals.push({t:'Price < SMA200',s:'SELL',c:'#ef4444'});
if(ema9>ema21)signals.push({t:'EMA9 > EMA21',s:'BUY',c:'#10b981'});else signals.push({t:'EMA9 < EMA21',s:'SELL',c:'#ef4444'});
if(rsi<30)signals.push({t:'RSI Oversold ('+rsi+')',s:'BUY',c:'#10b981'});
else if(rsi>70)signals.push({t:'RSI Overbought ('+rsi+')',s:'SELL',c:'#ef4444'});
else signals.push({t:'RSI Neutral ('+rsi+')',s:'HOLD',c:'#f59e0b'});
if(sma50>sma200)signals.push({t:'Golden Cross (SMA50>200)',s:'BUY',c:'#10b981'});
else signals.push({t:'Death Cross (SMA50<200)',s:'SELL',c:'#ef4444'});

const buyCount=signals.filter(s=>s.s==='BUY').length;
const sellCount=signals.filter(s=>s.s==='SELL').length;
const overall=buyCount>sellCount?'BUY':sellCount>buyCount?'SELL':'HOLD';
const overallC=overall==='BUY'?'#10b981':overall==='SELL'?'#ef4444':'#f59e0b';

let h=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#128200; Technical Indicators PRO</div>`;

h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:12px;border-radius:8px;border:2px solid ${overallC};background:${overallC}08;text-align:center">
<div style="font-size:8px;color:var(--text3)">OVERALL SIGNAL</div>
<div style="font-size:20px;font-weight:900;color:${overallC}">${overall}</div>
<div style="font-size:9px;color:var(--text3)">${buyCount} Buy / ${sellCount} Sell / ${signals.length-buyCount-sellCount} Hold</div>
</div>
<div style="padding:12px;border-radius:8px;border:1px solid var(--border)">
<div style="font-size:8px;color:var(--text3);margin-bottom:4px">RSI (14)</div>
<div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;position:relative;margin-bottom:4px">
<div style="height:100%;width:${rsi}%;background:${rsi>70?'#ef4444':rsi<30?'#10b981':'#f59e0b'};border-radius:4px"></div>
</div>
<div style="display:flex;justify-content:space-between;font-size:8px;color:var(--text3)"><span>Oversold</span><span style="font-weight:700;color:${rsi>70?'#ef4444':rsi<30?'#10b981':'#f59e0b'}">${rsi}</span><span>Overbought</span></div>
</div>
</div>`;

h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:6px;margin-bottom:10px">`;
signals.forEach(s=>{
h+=`<div style="padding:6px 10px;border-radius:6px;border:1px solid ${s.c}30;background:${s.c}06;display:flex;justify-content:space-between;align-items:center">
<span style="font-size:9px;color:var(--text2)">${s.t}</span>
<span style="font-size:9px;font-weight:800;color:${s.c};padding:1px 6px;border-radius:3px;background:${s.c}15">${s.s}</span>
</div>`;
});
h+='</div>';

// MA Table
h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:4px;margin-bottom:10px">`;
[{l:'SMA 20',v:sma20},{l:'SMA 50',v:sma50},{l:'SMA 200',v:sma200},{l:'EMA 9',v:ema9},{l:'EMA 21',v:ema21},{l:'EMA 50',v:ema50}].forEach(m=>{
const above=price>=m.v;
h+=`<div style="padding:6px;border-radius:6px;border:1px solid var(--border);text-align:center;background:${above?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)'}"><div style="font-size:7px;color:var(--text3)">${m.l}</div><div style="font-size:11px;font-weight:700;color:var(--text);font-family:var(--mono)">${S}${m.v?.toFixed?m.v.toFixed(0):m.v}</div><div style="font-size:7px;color:${above?'#10b981':'#ef4444'};font-weight:600">${above?'&#9650; Above':'&#9660; Below'}</div></div>`;
});
h+='</div>';

h+=`<div style="padding:10px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid #3b82f6;font-size:9px;color:var(--text2);line-height:1.7">
<strong style="color:#3b82f6">&#128161; Technical Summary:</strong> ${buyCount} of ${signals.length} indicators say BUY, ${sellCount} say SELL. ${overall==='BUY'?'The technical picture is positive — momentum and trend favor bulls. Consider this a tailwind for your investment thesis.':overall==='SELL'?'Technical indicators are negative — the trend is against you. Even if fundamentals are good, fighting the trend can be costly in the short term.':'Mixed signals. The market is undecided. Wait for more clarity before making technical-based decisions.'} RSI at ${rsi} is ${rsi>70?'overbought — a pullback is possible':rsi<30?'oversold — a bounce may be coming':'in neutral zone — no extreme signal'}.
</div>`;

el.innerHTML=h;
}


async function fetchMarketDaily(){
const el=document.getElementById('dailyContent');
if(!el)return;
el.innerHTML='<div style="text-align:center;padding:40px"><div style="font-size:28px;animation:spin 1s linear infinite">&#9203;</div><div style="color:var(--text3);margin-top:8px;font-size:11px">Fetching live market data for Nifty, Bank Nifty &amp; Sensex...<br>Analyzing price action, options chain &amp; technicals...</div></div>';
try{
const r=await fetch('/api/market-daily');
if(!r.ok)throw new Error('API error '+r.status);
const data=await r.json();
renderMarketDaily(data);
window._dailyRendered=true;
window._dailyData=data;
}catch(e){
el.innerHTML='<div style="text-align:center;padding:40px;color:var(--red)"><div style="font-size:24px">&#9888;</div><div style="margin-top:8px">Failed to load market data: '+e.message+'</div><button onclick="window._dailyLoading=false;window._dailyRendered=false;fetchMarketDaily()" style="margin-top:10px;padding:8px 20px;border-radius:6px;background:var(--blue);color:#fff;border:none;cursor:pointer;font-weight:700">Retry</button></div>';
}
window._dailyLoading=false;
}

function renderMarketDaily(data){
const el=document.getElementById('dailyContent');
if(!el||!data)return;
const S='&#8377;';
const _f=(n)=>{if(!n&&n!==0)return 'N/A';n=parseFloat(n);return n.toLocaleString('en-IN',{maximumFractionDigits:2});};
const _c=(v)=>parseFloat(v)>=0?'#10b981':'#ef4444';
const _arrow=(v)=>parseFloat(v)>=0?'&#9650;':'&#9660;';

// History storage
if(!window._dailyHistory)window._dailyHistory=[];
const existing=window._dailyHistory.find(h=>h.date===data.date);
if(!existing)window._dailyHistory.unshift({date:data.date,time:data.time,indices:data.indices});
if(window._dailyHistory.length>7)window._dailyHistory.pop();

const idxOrder=['NIFTY','BANKNIFTY','SENSEX'];
const idxColors={'NIFTY':'#3b82f6','BANKNIFTY':'#8b5cf6','SENSEX':'#f59e0b'};
const idxEmoji={'NIFTY':'&#128200;','BANKNIFTY':'&#127974;','SENSEX':'&#128202;'};

let h='';

// ═══ HEADER ═══
h+=`<div style="background:linear-gradient(135deg,#0a1628 0%,#0d2137 50%,#0a1628 100%);border-radius:14px;padding:24px;margin-bottom:16px;position:relative;overflow:hidden">
<div style="position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(59,130,246,.2),transparent 70%)"></div>
<div style="position:relative">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3)">CELESYS AI &middot; MARKET DAILY ANALYSIS</div>
<div style="font-size:20px;font-weight:800;color:#fff;font-family:Sora,sans-serif;margin-bottom:4px">${data.date}</div>
<div style="font-size:11px;color:rgba(255,255,255,.4)">Last updated: ${data.time} &middot; Options Chain &middot; Price Action &middot; Technical Indicators</div>
<button onclick="window._dailyLoading=false;window._dailyRendered=false;fetchMarketDaily()" style="position:absolute;top:16px;right:16px;padding:6px 14px;border-radius:6px;background:rgba(59,130,246,.2);color:#60a5fa;border:1px solid rgba(59,130,246,.3);font-size:10px;font-weight:600;cursor:pointer">&#128260; Refresh</button>
</div></div>`;

// ═══ QUICK SNAPSHOT BAR ═══
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px">';
idxOrder.forEach(key=>{
const d=data.indices[key];
if(!d||d.error)return;
const c=_c(d.change_pct);
h+=`<div style="padding:14px;border-radius:10px;background:rgba(0,47,108,.03);border:1px solid var(--border);border-top:3px solid ${idxColors[key]}">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
<span style="font-size:11px;font-weight:700;color:var(--text)">${idxEmoji[key]} ${d.name}</span>
<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;background:${d.trend.includes('BULL')?'rgba(16,185,129,.1)':d.trend.includes('BEAR')?'rgba(239,68,68,.1)':'rgba(245,158,11,.1)'};color:${d.trend.includes('BULL')?'#10b981':d.trend.includes('BEAR')?'#ef4444':'#f59e0b'}">${d.trend}</span>
</div>
<div style="font-size:22px;font-weight:900;color:var(--text);font-family:var(--mono)">${_f(d.price)}</div>
<div style="font-size:11px;color:${c};font-weight:700">${_arrow(d.change_pct)} ${d.change>=0?'+':''}${_f(d.change)} (${d.change_pct>=0?'+':''}${d.change_pct}%)</div>
<div style="font-size:8px;color:var(--text3);margin-top:4px">O: ${_f(d.open)} &middot; H: ${_f(d.high)} &middot; L: ${_f(d.low)}</div>
</div>`;
});
h+='</div>';

// ═══ EACH INDEX DETAILED ANALYSIS ═══
idxOrder.forEach(key=>{
const d=data.indices[key];
if(!d||d.error)return;
const c=idxColors[key];
const chgC=_c(d.change_pct);

h+=`<div style="border-radius:12px;border:1px solid ${c}30;background:rgba(0,47,108,.01);margin-bottom:20px;overflow:hidden">`;

// Index Header
h+=`<div style="padding:16px 18px;background:${c}10;border-bottom:1px solid ${c}20">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
<div><div style="font-size:14px;font-weight:800;color:${c};font-family:Sora,sans-serif">${idxEmoji[key]} ${d.name} Analysis</div>
<div style="font-size:9px;color:var(--text3)">${data.date} &middot; ${data.time}</div></div>
<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
<div style="text-align:center"><div style="font-size:8px;color:var(--text3)">RSI</div><div style="font-size:13px;font-weight:800;color:${d.rsi>70?'#ef4444':d.rsi<30?'#10b981':'#f59e0b'}">${d.rsi}</div></div>
<div style="text-align:center"><div style="font-size:8px;color:var(--text3)">MACD</div><div style="font-size:13px;font-weight:800;color:${d.macd_histogram>=0?'#10b981':'#ef4444'}">${d.macd_histogram>=0?'+':''}${d.macd_histogram}</div></div>
<div style="text-align:center"><div style="font-size:8px;color:var(--text3)">VOL</div><div style="font-size:13px;font-weight:800;color:${d.volume_ratio>1.5?'#f59e0b':'var(--text)'}">${d.volume_ratio}x</div></div>
<div style="text-align:center"><div style="font-size:8px;color:var(--text3)">ATR%</div><div style="font-size:13px;font-weight:800;color:${d.atr_pct>1.5?'#ef4444':'#10b981'}">${d.atr_pct}%</div></div>
</div>
</div></div>`;

h+='<div style="padding:16px 18px">';

// ═══ 1. LAYMAN SUMMARY ═══
const bullish=d.trend.includes('BULL');
const bearish=d.trend.includes('BEAR');
const rsiZone=d.rsi>70?'overbought (like a hot pan that may cool down)':d.rsi<30?'oversold (like a sale that may not last)':'neutral territory';
const macdSignal=d.macd_histogram>0?'positive momentum (engine running forward)':'negative momentum (engine in reverse)';
const volSignal=d.volume_ratio>1.5?'Unusually high volume today ('+d.volume_ratio+'x normal) — big players are active, expect larger moves.':d.volume_ratio<0.7?'Very low volume ('+d.volume_ratio+'x normal) — big players sitting out, moves may not sustain.':'Normal volume — nothing unusual from institutional activity.';

h+=`<div style="padding:14px;border-radius:10px;background:rgba(59,130,246,.04);border-left:4px solid ${c};margin-bottom:14px">
<div style="font-size:11px;font-weight:700;color:${c};margin-bottom:6px">&#128161; Today in Plain English — What Happened in ${d.name}?</div>
<div style="font-size:10px;color:var(--text2);line-height:1.9">
<strong>${d.name}</strong> ${d.change>=0?'gained':'lost'} <strong style="color:${chgC}">${Math.abs(d.change_pct)}%</strong> today, ${d.change>=0?'rising':'falling'} from ${_f(d.prev_close)} to <strong>${_f(d.price)}</strong>.
The day's range was ${_f(d.low)} to ${_f(d.high)} (a ${_f(d.high-d.low)} point swing).<br><br>
<strong>&#128680; Trend:</strong> The market is in a <strong style="color:${bullish?'#10b981':bearish?'#ef4444':'#f59e0b'}">${d.trend}</strong> phase. ${bullish?'Think of it like a car accelerating on a highway — momentum is with the bulls. Prices are above most moving averages, which act like road markers confirming the direction.':bearish?'Think of it like a car going downhill — gravity (selling pressure) is pulling prices lower. Most moving averages are above the current price, which means the market has lost its highway.':'The market is at a crossroads. Neither bulls nor bears have full control. Think of it like a car at a traffic signal — waiting for the green light to decide direction.'}<br><br>
<strong>&#128200; RSI (${d.rsi}):</strong> The momentum gauge is in ${rsiZone}. ${d.rsi>70?'When RSI crosses 70, the market has rallied hard and may take a breather. It does NOT mean it will crash — just that the easy gains may be over for now.':d.rsi<30?'When RSI drops below 30, fear has taken over. Historically, these are often good accumulation zones — but catch the bounce, not the falling knife.':'Between 30-70 is healthy territory. The market is neither overheated nor oversold.'}<br><br>
<strong>&#128202; MACD (${d.macd_histogram>=0?'+':''}${d.macd_histogram}):</strong> MACD shows ${macdSignal}. ${d.macd_histogram>0&&d.macd_histogram>5?'The histogram is strongly positive — like a rocket with fuel left. Uptrend likely to continue.':d.macd_histogram<0&&d.macd_histogram<-5?'The histogram is deeply negative — downward pressure is strong. Wait for MACD to cross above signal line before buying.':'Histogram is near zero — the trend is weak or changing. Watch for a crossover.'}<br><br>
<strong>&#128226; Volume (${d.volume_ratio}x):</strong> ${volSignal}<br><br>
<strong>&#128367; Candlestick:</strong> Today formed a <strong>${d.pattern}</strong>.
</div></div>`;

// ═══ 2. PRICE ACTION TABLE ═══
h+=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#128200; Price Action &amp; Moving Averages</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:6px;margin-bottom:14px">`;
const mas=[
{l:'SMA 5',v:d.sma5,tip:'1-week avg'},
{l:'SMA 10',v:d.sma10,tip:'2-week avg'},
{l:'SMA 20',v:d.sma20,tip:'1-month avg'},
{l:'EMA 9',v:d.ema9,tip:'Fast signal'},
{l:'EMA 21',v:d.ema21,tip:'Slow signal'},
{l:'SMA 50',v:d.sma50,tip:'Quarterly trend'},
{l:'SMA 100',v:d.sma100,tip:'Half-year trend'},
{l:'SMA 200',v:d.sma200,tip:'Long-term trend'},
{l:'52W High',v:d.w52_high,tip:'Yearly peak'},
{l:'52W Low',v:d.w52_low,tip:'Yearly bottom'}
];
mas.forEach(m=>{
const above=d.price>=m.v;
h+=`<div style="padding:8px;border-radius:6px;border:1px solid var(--border);background:rgba(0,47,108,.02);text-align:center">
<div style="font-size:8px;color:var(--text3)">${m.l}</div>
<div style="font-size:12px;font-weight:700;color:var(--text);font-family:var(--mono)">${_f(m.v)}</div>
<div style="font-size:8px;color:${above?'#10b981':'#ef4444'};font-weight:600">${above?'&#9650; Above':'&#9660; Below'}</div>
<div style="font-size:7px;color:var(--text3)">${m.tip}</div>
</div>`;
});
h+='</div>';

// Layman inference for MAs
const aboveCount=[d.sma20,d.sma50,d.sma200].filter(v=>d.price>=v).length;
h+=`<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid #8b5cf6;margin-bottom:14px;font-size:9px;color:var(--text2);line-height:1.7">
<strong style="color:#8b5cf6">&#128161; Moving Average Cheat Sheet:</strong> Price is above ${aboveCount} of 3 key averages (SMA20/50/200).
${aboveCount===3?'All 3 green = <strong>Strong Highway.</strong> Like driving on a well-maintained road — stay the course, trend is your friend. Traders call this a "golden alignment."':
aboveCount===2?'2 of 3 green = <strong>Mostly positive.</strong> The road is good but with some potholes. Keep a watchful eye on the SMA that is above price — thats your danger level.':
aboveCount===1?'Only 1 green = <strong>Caution zone.</strong> The road is deteriorating. Like a GPS saying "recalculating" — the old trend may be ending.':
'All below = <strong>Wrong side of the road.</strong> All moving averages are above price, acting as resistance ceilings. Bears are in control. Wait for price to climb back above SMA20 before entering.'}
</div>`;

// ═══ 3. BOLLINGER BANDS + VOLATILITY ═══
const bbPos=d.bb_upper!==d.bb_lower?((d.price-d.bb_lower)/(d.bb_upper-d.bb_lower)*100).toFixed(0):50;
h+=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#127912; Bollinger Bands &amp; Volatility</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Upper Band (Resistance)</div><div style="font-size:14px;font-weight:700;color:#ef4444;font-family:var(--mono)">${_f(d.bb_upper)}</div></div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Middle Band (SMA20)</div><div style="font-size:14px;font-weight:700;color:#3b82f6;font-family:var(--mono)">${_f(d.bb_mid)}</div></div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Lower Band (Support)</div><div style="font-size:14px;font-weight:700;color:#10b981;font-family:var(--mono)">${_f(d.bb_lower)}</div></div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">Price Position</div><div style="font-size:14px;font-weight:700;color:${bbPos>80?'#ef4444':bbPos<20?'#10b981':'#f59e0b'}">${bbPos}%</div><div style="font-size:7px;color:var(--text3)">${bbPos>80?'Near upper — may pull back':bbPos<20?'Near lower — may bounce':'Middle zone — neutral'}</div></div>
<div style="padding:10px;border-radius:8px;border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">ATR (Daily Range)</div><div style="font-size:14px;font-weight:700;color:var(--text);font-family:var(--mono)">${_f(d.atr)}</div><div style="font-size:7px;color:var(--text3)">${d.atr_pct}% daily volatility</div></div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(127,140,255,.04);border-left:3px solid #818cf8;margin-bottom:14px;font-size:9px;color:var(--text2);line-height:1.7">
<strong style="color:#818cf8">&#128161; Bollinger Bands = Speed Limits:</strong> Think of the upper band as the speed limit (${_f(d.bb_upper)}) and lower band as the minimum speed (${_f(d.bb_lower)}). Price usually bounces between these limits. ${bbPos>80?'Price is near the speed limit — like driving too fast, a slowdown (pullback) is likely. Not a sell signal, but new buyers should wait.':bbPos<20?'Price is crawling near the minimum — like being stuck in traffic, a breakout (upward move) often follows. Consider accumulating.':'Price is in the middle lane — comfortable cruising speed. No extreme signal either way.'}
ATR of ${_f(d.atr)} means the market typically moves ${_f(d.atr)} points per day. ${d.atr_pct>2?'High volatility day — expect large swings. Use wider stop-losses.':d.atr_pct>1?'Moderate volatility — normal trading conditions.':'Low volatility — calm market. Breakout may be brewing.'}
</div>`;

// ═══ 4. PIVOT POINTS ═══
if(d.pivots){
h+=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#127919; Pivot Points — Today's Trading Levels</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:4px;margin-bottom:10px">`;
const pivotOrder=[
{l:'R3',v:d.pivots.R3,c:'#dc2626'},{l:'R2',v:d.pivots.R2,c:'#ef4444'},{l:'R1',v:d.pivots.R1,c:'#f97316'},
{l:'Pivot',v:d.pivots.PP,c:'#3b82f6'},
{l:'S1',v:d.pivots.S1,c:'#22c55e'},{l:'S2',v:d.pivots.S2,c:'#10b981'},{l:'S3',v:d.pivots.S3,c:'#059669'}
];
pivotOrder.forEach(p=>{
const isNear=Math.abs(d.price-p.v)/d.price<0.005;
h+=`<div style="padding:6px;border-radius:6px;border:1px solid ${isNear?p.c+'80':'var(--border)'};background:${isNear?p.c+'10':'rgba(0,47,108,.02)'};text-align:center">
<div style="font-size:8px;color:${p.c};font-weight:700">${p.l}</div>
<div style="font-size:11px;font-weight:700;color:var(--text);font-family:var(--mono)">${_f(p.v)}</div>
${isNear?'<div style="font-size:7px;color:'+p.c+'">&#11044; NEAR</div>':''}
</div>`;
});
h+='</div>';
h+=`<div style="padding:10px;border-radius:8px;background:rgba(59,130,246,.04);border-left:3px solid #3b82f6;margin-bottom:14px;font-size:9px;color:var(--text2);line-height:1.7">
<strong style="color:#3b82f6">&#128161; Pivot Points = Traffic Signals:</strong> The Pivot (${_f(d.pivots.PP)}) is like a traffic signal. If price is above it, the road is green (bullish). Below it = red (bearish). R1/R2/R3 are speed bumps (resistance) where price may slow down. S1/S2/S3 are safety nets (support) where price may bounce. ${d.price>d.pivots.R1?'Price is already above R1 — bulls are strong. Next target is R2 ('+_f(d.pivots.R2)+').':d.price<d.pivots.S1?'Price is below S1 — bears are in control. If S2 ('+_f(d.pivots.S2)+') breaks, expect more pain.':'Price is between S1 and R1 — the normal trading zone. Watch for a breakout in either direction.'}
</div>`;
}

// ═══ 5. OPTIONS CHAIN ANALYSIS ═══
const opt=d.options;
if(opt&&opt.pcr!==null&&opt.pcr!==undefined){
const pcrColor=opt.pcr>1.2?'#10b981':opt.pcr>0.8?'#f59e0b':'#ef4444';
const pcrSignal=opt.pcr>1.5?'VERY BULLISH':opt.pcr>1.2?'BULLISH':opt.pcr>0.8?'NEUTRAL':opt.pcr>0.5?'BEARISH':'VERY BEARISH';
const maxPainDiff=opt.max_pain?((opt.max_pain-d.price)/d.price*100).toFixed(1):0;

h+=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#9878; Options Chain Analysis${opt.expiry?' — Expiry: '+opt.expiry:''}</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:12px;border-radius:8px;border:2px solid ${pcrColor};background:${pcrColor}08;text-align:center">
<div style="font-size:8px;color:var(--text3)">Put-Call Ratio (PCR)</div>
<div style="font-size:22px;font-weight:900;color:${pcrColor};font-family:var(--mono)">${opt.pcr}</div>
<div style="font-size:9px;font-weight:700;color:${pcrColor}">${pcrSignal}</div>
</div>
<div style="padding:12px;border-radius:8px;border:1px solid var(--border);text-align:center">
<div style="font-size:8px;color:var(--text3)">Max Pain</div>
<div style="font-size:18px;font-weight:800;color:var(--text);font-family:var(--mono)">${opt.max_pain?_f(opt.max_pain):'N/A'}</div>
<div style="font-size:8px;color:${maxPainDiff>0?'#10b981':'#ef4444'}">${maxPainDiff>0?'+':''}${maxPainDiff}% from CMP</div>
</div>
<div style="padding:12px;border-radius:8px;border:1px solid var(--border);text-align:center">
<div style="font-size:8px;color:var(--text3)">Total Call OI</div>
<div style="font-size:14px;font-weight:700;color:#ef4444;font-family:var(--mono)">${(opt.call_oi/1e5).toFixed(1)}L</div>
<div style="font-size:7px;color:var(--text3)">Resistance wall</div>
</div>
<div style="padding:12px;border-radius:8px;border:1px solid var(--border);text-align:center">
<div style="font-size:8px;color:var(--text3)">Total Put OI</div>
<div style="font-size:14px;font-weight:700;color:#10b981;font-family:var(--mono)">${(opt.put_oi/1e5).toFixed(1)}L</div>
<div style="font-size:7px;color:var(--text3)">Support base</div>
</div>
</div>`;

// OI Buildup
if(opt.oi_buildup){
const buColor=opt.oi_buildup.includes('Long Buildup')?'#10b981':opt.oi_buildup.includes('Short Covering')?'#22c55e':opt.oi_buildup.includes('Short Buildup')?'#ef4444':opt.oi_buildup.includes('Long Unwinding')?'#f97316':'#f59e0b';
h+=`<div style="padding:10px;border-radius:8px;background:${buColor}08;border:1px solid ${buColor}30;margin-bottom:10px">
<div style="font-size:10px;font-weight:700;color:${buColor}">&#128205; OI Buildup: ${opt.oi_buildup}</div>
</div>`;
}

// Top strikes table
if(opt.top_call_strikes&&opt.top_call_strikes.length>0){
h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
<div><div style="font-size:9px;font-weight:700;color:#ef4444;margin-bottom:4px">&#9888; Top Call OI Strikes (Resistance)</div>`;
opt.top_call_strikes.forEach(s=>{
h+=`<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(239,68,68,.04);margin-bottom:2px;font-size:10px"><span style="color:var(--text);font-weight:600">${_f(s.strike)}</span><span style="color:#ef4444;font-family:var(--mono)">${(s.openInterest/1e5).toFixed(1)}L</span></div>`;
});
h+=`</div><div><div style="font-size:9px;font-weight:700;color:#10b981;margin-bottom:4px">&#128737; Top Put OI Strikes (Support)</div>`;
if(opt.top_put_strikes)opt.top_put_strikes.forEach(s=>{
h+=`<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(16,185,129,.04);margin-bottom:2px;font-size:10px"><span style="color:var(--text);font-weight:600">${_f(s.strike)}</span><span style="color:#10b981;font-family:var(--mono)">${(s.openInterest/1e5).toFixed(1)}L</span></div>`;
});
h+=`</div></div>`;
}

// Options layman explanation
h+=`<div style="padding:12px;border-radius:8px;background:rgba(168,85,247,.04);border-left:3px solid #a855f7;margin-bottom:14px;font-size:9px;color:var(--text2);line-height:1.8">
<strong style="color:#a855f7">&#128161; Options Chain Decoded (Like a Cricket Match):</strong><br>
<strong>PCR (${opt.pcr}):</strong> ${opt.pcr>1.2?'PCR above 1.2 means more puts are being written than calls. Think of it like the batting side is confident — put sellers (the insurance providers) believe the market WONT fall, so they are selling "crash insurance" aggressively. This is <strong>BULLISH</strong>.':opt.pcr<0.8?'PCR below 0.8 means more calls are being written. Sellers are betting the market WONT rise much. Like the bowling side dominating — <strong>BEARISH</strong> signal.':'PCR near 1.0 is balanced — neither side has a clear edge. Match is evenly poised.'}<br>
<strong>Max Pain (${opt.max_pain?_f(opt.max_pain):'N/A'}):</strong> This is the price where option sellers make the most money and option buyers lose the most. Like a magnet, the market often gravitates toward this level by expiry. ${opt.max_pain&&d.price>opt.max_pain?'Current price is ABOVE max pain — market may pull back toward '+_f(opt.max_pain)+' by expiry.':opt.max_pain&&d.price<opt.max_pain?'Current price is BELOW max pain — market may drift up toward '+_f(opt.max_pain)+' by expiry.':'Price is near max pain — expect rangebound action near expiry.'}<br>
<strong>OI Buildup:</strong> ${opt.oi_buildup||'N/A'}. ${opt.oi_buildup&&opt.oi_buildup.includes('Long Buildup')?'Fresh buying + rising OI = Most bullish combination. Smart money is placing new bets that the market will rise.':opt.oi_buildup&&opt.oi_buildup.includes('Short Buildup')?'Fresh selling + rising OI = Most bearish combination. Smart money is betting on further decline.':opt.oi_buildup&&opt.oi_buildup.includes('Short Covering')?'Shorts closing positions = Quick rally, but may not sustain. Wait for long buildup confirmation.':opt.oi_buildup&&opt.oi_buildup.includes('Long Unwinding')?'Longs exiting = Bulls losing conviction. The rally may be ending.':'No clear signal from OI data.'}
</div>`;
}else{
h+=`<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.1);margin-bottom:14px;font-size:10px;color:var(--text3)">&#9888; Options chain data not available for ${d.name}. ${opt&&opt.error?opt.error:''}</div>`;
}

// ═══ 6. RECENT DAYS TABLE ═══
if(d.recent_days&&d.recent_days.length>0){
h+=`<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">&#128197; Last ${d.recent_days.length} Trading Days</div>
<div style="overflow-x:auto;margin-bottom:14px"><table style="width:100%;border-collapse:collapse;font-size:10px">
<tr style="background:${c}08"><th style="padding:6px 8px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border)">Date</th><th style="padding:6px 8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Open</th><th style="padding:6px 8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">High</th><th style="padding:6px 8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Low</th><th style="padding:6px 8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Close</th><th style="padding:6px 8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Change</th></tr>`;
d.recent_days.forEach(day=>{
const dc=_c(day.change_pct);
h+=`<tr><td style="padding:5px 8px;border-bottom:1px solid var(--border);color:var(--text)">${day.date}</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);font-family:var(--mono)">${_f(day.open)}</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);font-family:var(--mono)">${_f(day.high)}</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);font-family:var(--mono)">${_f(day.low)}</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);font-family:var(--mono);font-weight:700">${_f(day.close)}</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);color:${dc};font-weight:700">${day.change_pct>=0?'+':''}${day.change_pct}%</td></tr>`;
});
h+=`</table></div>`;
}

// ═══ 7. AI VERDICT FOR THE DAY ═══
let score=0;
if(d.trend.includes('STRONG BULL'))score+=25;else if(d.trend.includes('BULL'))score+=15;else if(d.trend.includes('BEAR'))score-=15;else if(d.trend.includes('STRONG BEAR'))score-=25;
if(d.rsi>50&&d.rsi<70)score+=10;else if(d.rsi>70)score-=5;else if(d.rsi<30)score+=5;else score-=10;
if(d.macd_histogram>0)score+=10;else score-=10;
if(opt&&opt.pcr>1.2)score+=10;else if(opt&&opt.pcr<0.8)score-=10;
if(d.change_pct>0.5)score+=10;else if(d.change_pct<-0.5)score-=10;
score=Math.max(-50,Math.min(50,score));
const verdict=score>25?'Strongly Bullish':score>10?'Bullish':score>-10?'Neutral':score>-25?'Bearish':'Strongly Bearish';
const verdictC=score>10?'#10b981':score>-10?'#f59e0b':'#ef4444';
const verdictEmoji=score>10?'&#128994;':score>-10?'&#128992;':'&#128308;';
const action=score>25?'Momentum is strong. Intraday traders can look for buying dips toward pivot S1 ('+_f(d.pivots?.S1)+') with SL below S2. Swing traders stay long.':score>10?'Mildly positive day. Wait for price to hold above SMA20 ('+_f(d.sma20)+') before adding positions. Book partial profits at resistance R1 ('+_f(d.pivots?.R1)+').':score>-10?'No clear direction. Best to avoid new trades. Wait for a breakout above '+_f(d.pivots?.R1)+' (bullish) or breakdown below '+_f(d.pivots?.S1)+' (bearish) before acting.':score>-25?'Bearish bias. Avoid fresh longs. Short-term traders can look for shorting rallies toward SMA20 ('+_f(d.sma20)+') with SL above R1.':'Strong selling pressure. Stay on the sidelines or hedge existing positions. If you are invested, DO NOT panic sell — use SIP mode and add more at lower levels if your long-term view is intact.';

h+=`<div style="padding:14px;border-radius:10px;background:linear-gradient(135deg,#0a1628,#0d2137);margin-bottom:14px">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:8px">
<div style="font-size:12px;font-weight:800;color:#fff;font-family:Sora,sans-serif">&#129302; AI Verdict for ${d.name}</div>
<div style="padding:4px 14px;border-radius:6px;background:${verdictC}20;border:1px solid ${verdictC}40;font-size:12px;font-weight:800;color:${verdictC}">${verdictEmoji} ${verdict} (${score>0?'+':''}${score}/50)</div>
</div>
<div style="font-size:10px;color:rgba(255,255,255,.6);line-height:1.8">${action}</div>
</div>`;

h+='</div></div>';// close padding + card
});

// ═══ DATE-WISE HISTORY ═══
if(window._dailyHistory&&window._dailyHistory.length>1){
h+=`<div style="font-size:12px;font-weight:700;color:var(--text);margin:16px 0 8px">&#128197; Previous Analysis Sessions</div>`;
window._dailyHistory.slice(1).forEach(hist=>{
h+=`<div style="padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:6px;background:rgba(0,47,108,.02)">
<div style="font-size:10px;font-weight:700;color:var(--text)">${hist.date} &middot; ${hist.time}</div>
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px">`;
idxOrder.forEach(key=>{
const d=hist.indices[key];
if(!d||d.error)return;
h+=`<div style="font-size:9px;color:var(--text2)"><strong>${key}:</strong> <span style="color:${_c(d.change_pct)}">${_f(d.price)} (${d.change_pct>=0?'+':''}${d.change_pct}%)</span> &middot; ${d.trend}</div>`;
});
h+='</div></div>';
});
}

// ═══ DISCLAIMER ═══
h+=`<div style="padding:10px;border-radius:8px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.12);margin-top:14px">
<div style="font-size:8px;color:var(--text3);line-height:1.5"><strong style="color:var(--red)">&#9888; Disclaimer:</strong> This analysis is auto-generated from market data for educational purposes only. It is NOT trading advice. Options trading involves significant risk of loss. Past performance does not guarantee future results. Always consult a SEBI-registered investment advisor before making trading decisions.</div>
</div>`;

el.innerHTML=h;
console.log('Market Daily rendered: '+idxOrder.length+' indices');
}


function renderPersonalFinance(){
const el=document.getElementById('financeContent');
if(!el)return;

const _cur='INR';
const S='&#8377;';

// Sub-tab state
let _activeFT='budget';

const TOOLS=[
{id:'budget',icon:'&#128203;',name:'Budget Planner',color:'#10b981',desc:'The 50/30/20 rule that changed millions of lives'},
{id:'expense',icon:'&#128200;',name:'Expense Analyzer',color:'#3b82f6',desc:'Find where your money secretly disappears'},
{id:'debt',icon:'&#9939;',name:'Debt Eliminator',color:'#ef4444',desc:'Crush your loans with the avalanche or snowball method'},
{id:'emergency',icon:'&#128737;',name:'Emergency Fund',color:'#f59e0b',desc:'Your financial airbag for life crashes'},
{id:'savings',icon:'&#127919;',name:'Savings Architect',color:'#8b5cf6',desc:'Turn dreams into achievable money goals'},
{id:'tax',icon:'&#128209;',name:'Tax Optimizer',color:'#06b6d4',desc:'Legally keep more of what you earn'},
{id:'networth',icon:'&#128176;',name:'Net Worth Tracker',color:'#10b981',desc:'Your financial scoreboard — one number that matters'},
{id:'retire',icon:'&#127958;',name:'Retirement Planner',color:'#d97706',desc:'When can you stop working? Let the math decide'},
{id:'insurance',icon:'&#128737;',name:'Insurance Audit',color:'#ec4899',desc:'Are you over-insured, under-insured, or just right?'},
{id:'health',icon:'&#128154;',name:'Financial Health',color:'#14b8a6',desc:'A complete checkup for your money life'}
];

// Helper: input field
const _inp=(id,label,placeholder,type)=>`<div style="flex:1;min-width:140px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">${label}</label><input id="${id}" type="${type||'number'}" placeholder="${placeholder}" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-family:var(--mono);font-size:12px;outline:none" /></div>`;

// Helper: result card
const _res=(label,val,color,tip)=>`<div style="padding:10px 12px;border-radius:8px;background:rgba(0,47,108,.02);border:1px solid var(--border);text-align:center"><div style="font-size:8px;color:var(--text3)">${label}</div><div style="font-size:18px;font-weight:800;color:${color||'var(--cyan)'};font-family:var(--mono)">${val}</div>${tip?'<div style="font-size:8px;color:var(--text3);margin-top:2px">'+tip+'</div>':''}</div>`;

// Helper: gauge bar
const _gauge=(pct,label)=>{
const c=pct>=80?'#10b981':pct>=50?'#f59e0b':'#ef4444';
return `<div style="margin:6px 0"><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-bottom:3px"><span>${label}</span><span style="color:${c};font-weight:700">${pct.toFixed(0)}%</span></div><div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden"><div style="height:100%;width:${Math.min(100,pct)}%;background:${c};border-radius:4px;transition:width .5s"></div></div></div>`;
};

// Helper: format number
const _f=(n)=>{if(!n||isNaN(n))return '0';n=parseFloat(n);const a=Math.abs(n);const s=n<0?'-':'';if(a>=1e7)return s+S+(a/1e7).toFixed(2)+' Cr';if(a>=1e5)return s+S+(a/1e5).toFixed(2)+' L';return s+S+a.toLocaleString('en-IN');};

const _v=(id)=>parseFloat(document.getElementById(id)?.value)||0;

// ═══════════════════════════════════════════════
// BUILD EACH TOOL
// ═══════════════════════════════════════════════

const toolHTML={

// ═══ 1. BUDGET PLANNER ═══
budget:`
<div style="padding:14px;border-radius:10px;background:rgba(16,185,129,.04);border-left:4px solid #10b981;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#10b981;margin-bottom:4px">&#128161; The 50/30/20 Rule — Like a plate of food</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">Imagine your salary is a plate of food. <strong>50% goes to needs</strong> (rice/dal — rent, EMIs, groceries, insurance). <strong>30% goes to wants</strong> (dessert — shopping, dining, entertainment). <strong>20% goes to savings</strong> (vitamins — investments, emergency fund, future goals). If your plate is 80% dessert and 5% vitamins, you will feel great now but your future self will be malnourished. This rule ensures balanced financial nutrition.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('bf_income','Monthly Income (after tax)','e.g. 80000')}
${_inp('bf_rent','Rent/Mortgage','e.g. 20000')}
${_inp('bf_groceries','Groceries & Utilities','e.g. 8000')}
${_inp('bf_transport','Transport/Fuel','e.g. 5000')}
${_inp('bf_emi','EMIs (Loan payments)','e.g. 10000')}
${_inp('bf_insurance','Insurance Premiums','e.g. 3000')}
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('bf_shopping','Shopping/Lifestyle','e.g. 5000')}
${_inp('bf_dining','Dining/Entertainment','e.g. 4000')}
${_inp('bf_subscriptions','Subscriptions/OTT','e.g. 1500')}
${_inp('bf_invest','Investments/SIP','e.g. 10000')}
${_inp('bf_emergency','Emergency Fund SIP','e.g. 3000')}
${_inp('bf_other','Other Savings','e.g. 2000')}
</div>
<button onclick="window._calcBudget()" style="padding:10px 24px;border-radius:8px;background:#10b981;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Calculate My Budget Score</button>
<div id="bf_result" style="margin-top:16px"></div>`,

// ═══ 2. EXPENSE ANALYZER ═══
expense:`
<div style="padding:14px;border-radius:10px;background:rgba(59,130,246,.04);border-left:4px solid #3b82f6;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#3b82f6;margin-bottom:4px">&#128161; The Latte Factor — Small leaks sink big ships</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">A ${S}200 daily coffee = ${S}6,000/month = ${S}72,000/year. Invested at 12% for 20 years, that coffee habit costs you <strong>${S}59 Lakh!</strong> The Expense Analyzer helps you find these invisible money drains. We are not saying stop drinking coffee — just become AWARE of where every rupee goes. Awareness is the first step to control.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('ea_income','Monthly Income','e.g. 80000')}
${_inp('ea_housing','Housing (Rent+Utilities)','e.g. 25000')}
${_inp('ea_food','Food (Groceries+Dining)','e.g. 12000')}
${_inp('ea_transport','Transport','e.g. 5000')}
${_inp('ea_shopping','Shopping/Lifestyle','e.g. 8000')}
${_inp('ea_emi','All EMIs','e.g. 15000')}
${_inp('ea_subscriptions','Subscriptions/Memberships','e.g. 3000')}
${_inp('ea_misc','Miscellaneous','e.g. 5000')}
</div>
<button onclick="window._calcExpense()" style="padding:10px 24px;border-radius:8px;background:#3b82f6;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Analyze My Expenses</button>
<div id="ea_result" style="margin-top:16px"></div>`,

// ═══ 3. DEBT ELIMINATOR ═══
debt:`
<div style="padding:14px;border-radius:10px;background:rgba(239,68,68,.04);border-left:4px solid #ef4444;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:4px">&#128161; Debt is like a hole in a boat — plug it before rowing faster</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">Imagine you are on a boat (your financial life). Debt is a hole in the bottom. You can row harder (earn more) or bail water (cut expenses), but until you plug the hole, you will keep sinking. <strong>Avalanche method:</strong> Pay highest-interest debt first — mathematically optimal, saves the most money. <strong>Snowball method:</strong> Pay smallest debt first — psychologically powerful, gives quick wins for motivation. Enter up to 5 loans below.</div>
</div>
<div id="debt_inputs">
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;align-items:end">
${_inp('d1_name','Loan 1 Name','e.g. Credit Card','text')}
${_inp('d1_bal','Balance','e.g. 50000')}
${_inp('d1_rate','Interest %','e.g. 36')}
${_inp('d1_emi','Monthly EMI','e.g. 5000')}
</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;align-items:end">
${_inp('d2_name','Loan 2 Name','e.g. Personal Loan','text')}
${_inp('d2_bal','Balance','e.g. 200000')}
${_inp('d2_rate','Interest %','e.g. 14')}
${_inp('d2_emi','Monthly EMI','e.g. 8000')}
</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;align-items:end">
${_inp('d3_name','Loan 3 Name','e.g. Car Loan','text')}
${_inp('d3_bal','Balance','e.g. 500000')}
${_inp('d3_rate','Interest %','e.g. 9')}
${_inp('d3_emi','Monthly EMI','e.g. 12000')}
</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
${_inp('d_extra','Extra Monthly Payment Available','e.g. 5000')}
</div>
<button onclick="window._calcDebt()" style="padding:10px 24px;border-radius:8px;background:#ef4444;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Create Debt-Free Plan</button>
<div id="debt_result" style="margin-top:16px"></div>`,

// ═══ 4. EMERGENCY FUND ═══
emergency:`
<div style="padding:14px;border-radius:10px;background:rgba(245,158,11,.04);border-left:4px solid #f59e0b;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#f59e0b;margin-bottom:4px">&#128161; Your Financial Airbag — You never need it... until you REALLY do</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">A car airbag costs money, adds weight, and you hope to never use it. But in a crash, it saves your life. Your emergency fund is exactly the same — it sits idle earning modest returns, feels wasteful in good times, but prevents financial destruction when a job loss, medical emergency, or recession hits. <strong>Rule of thumb:</strong> 6 months of expenses if salaried, 12 months if self-employed/freelancer. Keep it in a liquid fund or FD — NOT in stocks.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('ef_expenses','Monthly Essential Expenses','e.g. 45000')}
${_inp('ef_emis','Monthly EMIs','e.g. 15000')}
${_inp('ef_dependents','Number of Dependents','e.g. 3')}
${_inp('ef_current','Current Emergency Savings','e.g. 100000')}
${_inp('ef_monthly','Monthly Contribution','e.g. 5000')}
${_inp('ef_type','Employment Type (1=Salaried, 2=Self-employed)','e.g. 1')}
</div>
<button onclick="window._calcEmergency()" style="padding:10px 24px;border-radius:8px;background:#f59e0b;color:#000;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Calculate Emergency Fund</button>
<div id="ef_result" style="margin-top:16px"></div>`,

// ═══ 5. SAVINGS ARCHITECT ═══
savings:`
<div style="padding:14px;border-radius:10px;background:rgba(139,92,246,.04);border-left:4px solid #8b5cf6;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#8b5cf6;margin-bottom:4px">&#128161; Dreams without deadlines are just wishes</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">Want a ${S}20 Lakh car in 3 years? A ${S}50 Lakh house down payment in 5 years? A ${S}1 Crore retirement corpus in 20 years? The Savings Architect reverse-engineers your dreams into exact monthly SIP amounts. Think of it like Google Maps for money — you tell it the destination and timeline, it calculates the route and speed needed.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('sg_name','Goal Name','e.g. Dream Home','text')}
${_inp('sg_amount','Target Amount','e.g. 5000000')}
${_inp('sg_years','Time Horizon (Years)','e.g. 5')}
${_inp('sg_current','Already Saved','e.g. 200000')}
${_inp('sg_return','Expected Return % (annual)','e.g. 12')}
${_inp('sg_inflation','Inflation % (annual)','e.g. 6')}
</div>
<button onclick="window._calcSavings()" style="padding:10px 24px;border-radius:8px;background:#8b5cf6;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Calculate My SIP</button>
<div id="sg_result" style="margin-top:16px"></div>`,

// ═══ 6. TAX OPTIMIZER ═══
tax:`
<div style="padding:14px;border-radius:10px;background:rgba(6,182,212,.04);border-left:4px solid #06b6d4;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#06b6d4;margin-bottom:4px">&#128161; Tax saved is tax earned — it is the highest-return investment</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">If you are in the 30% tax bracket, every ${S}1 saved in tax = ${S}1 earned without any risk. A ${S}1.5L investment under 80C at 30% tax saves ${S}46,800 in tax — that is a guaranteed 31.2% return on Day 1, plus whatever the investment earns. No mutual fund or stock can promise that. This audit checks if you are utilizing all available deductions under Old and New regime.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('tx_gross','Gross Annual Income','e.g. 1500000')}
${_inp('tx_80c','Section 80C (PPF, ELSS, LIC, EPF)','e.g. 150000')}
${_inp('tx_80d','Section 80D (Health Insurance)','e.g. 25000')}
${_inp('tx_hra','HRA Exemption','e.g. 120000')}
${_inp('tx_80ccd','80CCD(1B) NPS Extra','e.g. 50000')}
${_inp('tx_home_loan','Home Loan Interest (Sec 24)','e.g. 200000')}
${_inp('tx_standard','Standard Deduction','e.g. 75000')}
${_inp('tx_other','Other Deductions','e.g. 0')}
</div>
<button onclick="window._calcTax()" style="padding:10px 24px;border-radius:8px;background:#06b6d4;color:#000;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Compare Old vs New Regime</button>
<div id="tx_result" style="margin-top:16px"></div>`,

// ═══ 7. NET WORTH TRACKER ═══
networth:`
<div style="padding:14px;border-radius:10px;background:rgba(16,185,129,.04);border-left:4px solid #10b981;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#10b981;margin-bottom:4px">&#128161; Your financial scoreboard — just one number</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">Net worth = What you OWN minus what you OWE. Think of it like a cricket score: Assets are your runs scored, Liabilities are wickets fallen. A score of 300/2 (high assets, low debt) is great. A score of 50/8 (low assets, high debt) means trouble. Track this number quarterly — if it goes up, you are winning the financial game regardless of income.</div>
</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin:14px 0 8px">ASSETS (What You Own)</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('nw_savings','Bank Savings/FD','e.g. 500000')}
${_inp('nw_mf','Mutual Funds/Stocks','e.g. 800000')}
${_inp('nw_pf','PF/PPF/NPS','e.g. 600000')}
${_inp('nw_property','Property Value','e.g. 5000000')}
${_inp('nw_gold','Gold/Jewelry','e.g. 300000')}
${_inp('nw_other_assets','Other Assets','e.g. 100000')}
</div>
<div style="font-size:11px;font-weight:700;color:var(--red);margin:14px 0 8px">LIABILITIES (What You Owe)</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('nw_home_loan','Home Loan Outstanding','e.g. 3000000')}
${_inp('nw_car_loan','Car/Personal Loan','e.g. 200000')}
${_inp('nw_credit','Credit Card Debt','e.g. 50000')}
${_inp('nw_other_debt','Other Debts','e.g. 0')}
</div>
<button onclick="window._calcNetworth()" style="padding:10px 24px;border-radius:8px;background:#10b981;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Calculate Net Worth</button>
<div id="nw_result" style="margin-top:16px"></div>`,

// ═══ 8. RETIREMENT PLANNER ═══
retire:`
<div style="padding:14px;border-radius:10px;background:rgba(217,119,6,.04);border-left:4px solid #d97706;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#d97706;margin-bottom:4px">&#128161; Retirement is like a flight — you need enough fuel to reach the destination</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">If a plane takes off without enough fuel, it crashes mid-air. Your retirement corpus is the fuel. This calculator tells you: (1) How much fuel you need for a 25-30 year retirement, (2) How much fuel you have now, (3) How fast you need to fill the tank each month. The biggest enemy? <strong>Inflation</strong> — your ${S}50,000/month lifestyle will cost ${S}1.6 Lakh/month in 20 years at 6% inflation.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('rt_age','Current Age','e.g. 30')}
${_inp('rt_retire_age','Desired Retirement Age','e.g. 55')}
${_inp('rt_life','Expected Life Span','e.g. 85')}
${_inp('rt_monthly','Current Monthly Expenses','e.g. 50000')}
${_inp('rt_current','Current Retirement Savings','e.g. 500000')}
${_inp('rt_return','Pre-Retirement Return %','e.g. 12')}
${_inp('rt_post_return','Post-Retirement Return %','e.g. 8')}
${_inp('rt_inflation','Inflation %','e.g. 6')}
</div>
<button onclick="window._calcRetire()" style="padding:10px 24px;border-radius:8px;background:#d97706;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Check Retirement Readiness</button>
<div id="rt_result" style="margin-top:16px"></div>`,

// ═══ 9. INSURANCE AUDIT ═══
insurance:`
<div style="padding:14px;border-radius:10px;background:rgba(236,72,153,.04);border-left:4px solid #ec4899;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#ec4899;margin-bottom:4px">&#128161; Insurance is the umbrella you buy on a sunny day</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">Nobody buys an umbrella during a rainstorm — you buy it when the sun is shining. Insurance works the same way. <strong>Term life insurance</strong> = Protection for your family if you die (10-15x annual income). <strong>Health insurance</strong> = Protection against hospital bills that can bankrupt you (min ${S}10L per person). <strong>Critical illness</strong> = Lump sum payment if diagnosed with cancer/heart attack. Do NOT mix insurance with investment (avoid ULIPs/endowment plans).</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('ins_age','Your Age','e.g. 35')}
${_inp('ins_income','Annual Income','e.g. 1200000')}
${_inp('ins_dependents','Number of Dependents','e.g. 3')}
${_inp('ins_debts','Total Outstanding Debts','e.g. 3000000')}
${_inp('ins_term_cover','Current Term Life Cover','e.g. 10000000')}
${_inp('ins_health_cover','Current Health Cover','e.g. 500000')}
${_inp('ins_term_premium','Annual Term Premium','e.g. 15000')}
${_inp('ins_health_premium','Annual Health Premium','e.g. 20000')}
</div>
<button onclick="window._calcInsurance()" style="padding:10px 24px;border-radius:8px;background:#ec4899;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Audit My Insurance</button>
<div id="ins_result" style="margin-top:16px"></div>`,

// ═══ 10. FINANCIAL HEALTH CHECKUP ═══
health:`
<div style="padding:14px;border-radius:10px;background:rgba(20,184,166,.04);border-left:4px solid #14b8a6;margin-bottom:16px">
<div style="font-size:11px;font-weight:700;color:#14b8a6;margin-bottom:4px">&#128161; A complete body checkup... for your finances</div>
<div style="font-size:10px;color:var(--text2);line-height:1.8">Just like a doctor checks your blood pressure, sugar, cholesterol, and BMI to give an overall health score, this tool checks your financial vital signs: savings rate (blood pressure), debt ratio (cholesterol), emergency coverage (immunity), insurance adequacy (vaccination), and investment diversification (balanced diet). One comprehensive score tells you if your financial health is excellent, good, or needs urgent care.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
${_inp('fh_income','Monthly Income','e.g. 80000')}
${_inp('fh_expenses','Monthly Expenses','e.g. 50000')}
${_inp('fh_invest','Monthly Investments/SIP','e.g. 15000')}
${_inp('fh_emis','Total Monthly EMIs','e.g. 12000')}
${_inp('fh_emergency','Emergency Fund Balance','e.g. 200000')}
${_inp('fh_total_debt','Total Outstanding Debt','e.g. 2000000')}
${_inp('fh_investments','Total Investment Value','e.g. 1500000')}
${_inp('fh_insurance','Life Insurance Cover','e.g. 10000000')}
</div>
<button onclick="window._calcHealth()" style="padding:10px 24px;border-radius:8px;background:#14b8a6;color:#fff;border:none;font-weight:700;cursor:pointer;font-family:Sora,sans-serif">Get My Financial Health Score</button>
<div id="fh_result" style="margin-top:16px"></div>`
};

// ═══ BUILD MAIN UI ═══
let h=`
<div style="background:linear-gradient(135deg,#0a1628 0%,#0d2137 50%,#0a1628 100%);border-radius:14px;padding:24px;margin-bottom:16px;position:relative;overflow:hidden">
<div style="position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(16,185,129,.2),transparent 70%)"></div>
<div style="position:relative">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3);margin-bottom:6px">CELESYS AI &middot; PERSONAL FINANCE TOOLKIT</div>
<div style="font-size:20px;font-weight:800;color:#fff;font-family:Sora,sans-serif;margin-bottom:4px">Your Complete Money Toolkit</div>
<div style="font-size:11px;color:rgba(255,255,255,.5)">10 interactive calculators &middot; Real-time analysis &middot; Actionable advice</div>
</div>
</div>

<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px" id="finSubTabs">
${TOOLS.map(t=>`<button class="fin-sub-btn${t.id==='budget'?' fin-active':''}" data-ft="${t.id}" onclick="window._switchFT('${t.id}')" style="padding:6px 12px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid ${t.id==='budget'?t.color:'var(--border)'};background:${t.id==='budget'?t.color:'transparent'};color:${t.id==='budget'?'#fff':'var(--text2)'};cursor:pointer;font-family:Sora,sans-serif;transition:all .2s;white-space:nowrap">${t.icon} ${t.name}</button>`).join('')}
</div>

${TOOLS.map(t=>`<div id="ft_${t.id}" style="display:${t.id==='budget'?'block':'none'}">${toolHTML[t.id]}</div>`).join('')}

<div style="padding:10px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12);margin-top:16px">
<div style="font-size:9px;color:var(--text3);line-height:1.5"><strong style="color:var(--amber)">Disclaimer:</strong> These calculators provide estimates for educational purposes only. They are not financial advice. Tax calculations are simplified and may not reflect your exact situation. Always consult a qualified CA/financial planner for personalized guidance.</div>
</div>`;

el.innerHTML=h;

// ═══ SUB-TAB SWITCHER ═══
window._switchFT=function(id){
TOOLS.forEach(t=>{
const panel=document.getElementById('ft_'+t.id);
const btn=document.querySelector('[data-ft="'+t.id+'"]');
if(panel)panel.style.display=t.id===id?'block':'none';
if(btn){btn.style.background=t.id===id?t.color:'transparent';btn.style.color=t.id===id?'#fff':'var(--text2)';btn.style.borderColor=t.id===id?t.color:'var(--border)';}
});
};

// ═══ CALCULATOR FUNCTIONS ═══

// 1. BUDGET
window._calcBudget=function(){
const inc=_v('bf_income');if(!inc){document.getElementById('bf_result').innerHTML='<div style="color:var(--red);font-size:11px">Please enter your monthly income.</div>';return}
const needs=_v('bf_rent')+_v('bf_groceries')+_v('bf_transport')+_v('bf_emi')+_v('bf_insurance');
const wants=_v('bf_shopping')+_v('bf_dining')+_v('bf_subscriptions');
const saves=_v('bf_invest')+_v('bf_emergency')+_v('bf_other');
const total=needs+wants+saves;
const surplus=inc-total;
const nPct=inc>0?(needs/inc*100):0;
const wPct=inc>0?(wants/inc*100):0;
const sPct=inc>0?(saves/inc*100):0;
const score=Math.min(100,Math.max(0, (sPct>=20?40:sPct*2) + (nPct<=50?30:Math.max(0,30-(nPct-50)*1.5)) + (wPct<=30?20:Math.max(0,20-(wPct-30)*2)) + (surplus>=0?10:0)));
const grade=score>=80?'A+':score>=65?'A':score>=50?'B':score>=35?'C':'D';
const gradeC=score>=80?'#10b981':score>=50?'#f59e0b':'#ef4444';
document.getElementById('bf_result').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('NEEDS (Target 50%)',nPct.toFixed(0)+'%',nPct<=55?'#10b981':'#ef4444','Rent+EMI+Groceries+Transport')}
${_res('WANTS (Target 30%)',wPct.toFixed(0)+'%',wPct<=35?'#10b981':'#ef4444','Shopping+Dining+OTT')}
${_res('SAVINGS (Target 20%)',sPct.toFixed(0)+'%',sPct>=18?'#10b981':'#ef4444','SIP+Emergency+Other')}
${_res('SURPLUS/DEFICIT',_f(surplus),surplus>=0?'#10b981':'#ef4444',surplus>=0?'Unallocated':'Overspending!')}
${_res('BUDGET GRADE',grade,gradeC,score.toFixed(0)+'/100')}
</div>
${_gauge(Math.min(100,nPct/50*100),'Needs: '+nPct.toFixed(0)+'% (target: 50%)')}
${_gauge(Math.min(100,wPct/30*100),'Wants: '+wPct.toFixed(0)+'% (target: 30%)')}
${_gauge(Math.min(100,sPct/20*100),'Savings: '+sPct.toFixed(0)+'% (target: 20%)')}
<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#10b981">&#128161; Your Budget Prescription:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">
${nPct>55?'&#9888; Your NEEDS consume '+nPct.toFixed(0)+'% of income (should be under 50%). Look for ways to reduce rent (consider a roommate or cheaper area) or refinance high-interest EMIs.<br>':''}
${wPct>35?'&#9888; Your WANTS are '+wPct.toFixed(0)+'% (should be under 30%). Try the 48-hour rule: wait 48 hours before any non-essential purchase over '+S+'2,000. Most impulse buys fade away.<br>':''}
${sPct<15?'&#9888; You are saving only '+sPct.toFixed(0)+'% (should be 20%+). Start with just 1% more this month, then increase by 1% every quarter. Small steps compound into life-changing amounts.<br>':''}
${sPct>=20&&nPct<=55?'&#9989; Excellent budget discipline! You are following the 50/30/20 rule. Consider increasing savings to 25-30% to accelerate wealth building.':''}
${surplus<0?'&#128680; <strong>CRITICAL:</strong> You are spending '+_f(Math.abs(surplus))+' MORE than you earn every month. This is unsustainable — you are either taking on debt or depleting savings. Immediate action required: cut wants by 30% this month.':''}
</div></div>`;
};

// 2. EXPENSE ANALYZER
window._calcExpense=function(){
const inc=_v('ea_income');if(!inc){return}
const cats=[{n:'Housing',v:_v('ea_housing'),c:'#3b82f6',ideal:30},{n:'Food',v:_v('ea_food'),c:'#10b981',ideal:15},{n:'Transport',v:_v('ea_transport'),c:'#f59e0b',ideal:10},{n:'Shopping',v:_v('ea_shopping'),c:'#8b5cf6',ideal:10},{n:'EMIs',v:_v('ea_emi'),c:'#ef4444',ideal:20},{n:'Subscriptions',v:_v('ea_subscriptions'),c:'#ec4899',ideal:5},{n:'Misc',v:_v('ea_misc'),c:'#06b6d4',ideal:10}];
const total=cats.reduce((s,c)=>s+c.v,0);
const savings=inc-total;
const savRate=inc>0?(savings/inc*100):0;
let r=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('Total Spent',_f(total),'var(--amber)',((total/inc*100).toFixed(0))+'% of income')}
${_res('Savings',_f(savings),savings>0?'#10b981':'#ef4444',savRate.toFixed(0)+'% savings rate')}
${_res('Rating',savRate>=30?'Excellent':savRate>=20?'Good':savRate>=10?'Fair':'Poor',savRate>=20?'#10b981':savRate>=10?'#f59e0b':'#ef4444','')}
</div>`;
cats.forEach(c=>{if(c.v>0){const pct=inc>0?(c.v/inc*100):0;const over=pct>c.ideal;r+=_gauge(Math.min(100,pct/c.ideal*100),c.n+': '+_f(c.v)+' ('+pct.toFixed(0)+'% vs '+c.ideal+'% ideal)');}});
const latteAmt=_v('ea_subscriptions')+_v('ea_misc')*0.3;
if(latteAmt>0){const y20=latteAmt*12*((Math.pow(1+0.12/12,240)-1)/(0.12/12));r+=`<div style="padding:12px;border-radius:8px;background:rgba(239,68,68,.05);border-left:3px solid var(--red);margin-top:10px"><div style="font-size:10px;font-weight:700;color:var(--red)">&#9749; Latte Factor Alert:</div><div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">Your subscriptions + misc spending of ${_f(latteAmt)}/month could grow to <strong style="color:#10b981">${_f(y20)}</strong> in 20 years if invested at 12% CAGR. That is potentially life-changing money hiding in plain sight.</div></div>`;}
document.getElementById('ea_result').innerHTML=r;
};

// 3. DEBT ELIMINATOR
window._calcDebt=function(){
const loans=[];
for(let i=1;i<=3;i++){const b=_v('d'+i+'_bal'),r=_v('d'+i+'_rate'),e=_v('d'+i+'_emi');const nm=document.getElementById('d'+i+'_name')?.value||'Loan '+i;if(b>0&&e>0)loans.push({name:nm,bal:b,rate:r,emi:e});}
if(!loans.length){document.getElementById('debt_result').innerHTML='<div style="color:var(--red);font-size:11px">Enter at least one loan.</div>';return}
const extra=_v('d_extra');
const totalDebt=loans.reduce((s,l)=>s+l.bal,0);
const totalEmi=loans.reduce((s,l)=>s+l.emi,0);
const avgRate=loans.reduce((s,l)=>s+l.rate*l.bal,0)/totalDebt;
const avalanche=[...loans].sort((a,b)=>b.rate-a.rate);
const snowball=[...loans].sort((a,b)=>a.bal-b.bal);
let r=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('Total Debt',_f(totalDebt),'#ef4444',loans.length+' loans')}
${_res('Total EMIs',_f(totalEmi)+'/mo','var(--amber)','EMI/Income ratio matters')}
${_res('Avg Interest',avgRate.toFixed(1)+'%','#ef4444',avgRate>15?'HIGH - prioritize this':'Manageable')}
${_res('Extra Available',_f(extra)+'/mo','#10b981','Applied to priority loan')}
</div>`;
r+=`<div style="overflow-x:auto;margin-bottom:12px"><table style="width:100%;border-collapse:collapse;font-size:10px">
<tr style="background:rgba(239,68,68,.06)"><th style="padding:8px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border)">Loan</th><th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Balance</th><th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Rate</th><th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">EMI</th><th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border)">Priority (Avalanche)</th></tr>`;
avalanche.forEach((l,i)=>{r+=`<tr><td style="padding:6px 8px;color:var(--text);border-bottom:1px solid var(--border)">${l.name}</td><td style="padding:6px 8px;text-align:right;color:var(--red);font-weight:700;border-bottom:1px solid var(--border)">${_f(l.bal)}</td><td style="padding:6px 8px;text-align:right;color:${l.rate>15?'var(--red)':'var(--amber)'};border-bottom:1px solid var(--border)">${l.rate}%</td><td style="padding:6px 8px;text-align:right;border-bottom:1px solid var(--border)">${_f(l.emi)}</td><td style="padding:6px 8px;text-align:right;color:${i===0?'#ef4444':'var(--text3)'};font-weight:${i===0?'800':'400'};border-bottom:1px solid var(--border)">#${i+1}${i===0?' &#11088; PAY FIRST':''}</td></tr>`;});
r+=`</table></div>`;
r+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div style="padding:12px;border-radius:8px;border:2px solid #ef4444;background:rgba(239,68,68,.03)"><div style="font-size:10px;font-weight:700;color:#ef4444;margin-bottom:4px">&#9888; Avalanche Method (Saves Money)</div><div style="font-size:9px;color:var(--text2);line-height:1.7">Pay minimum on ALL loans. Put ALL extra (${_f(extra)}/mo) toward <strong>${avalanche[0]?.name}</strong> (highest rate: ${avalanche[0]?.rate}%). Once that is done, roll its EMI + extra into the next highest rate. Mathematically saves the most interest.</div></div>
<div style="padding:12px;border-radius:8px;border:2px solid #3b82f6;background:rgba(59,130,246,.03)"><div style="font-size:10px;font-weight:700;color:#3b82f6;margin-bottom:4px">&#127947; Snowball Method (Feels Better)</div><div style="font-size:9px;color:var(--text2);line-height:1.7">Pay minimum on ALL loans. Put ALL extra (${_f(extra)}/mo) toward <strong>${snowball[0]?.name}</strong> (smallest balance: ${_f(snowball[0]?.bal)}). Quick wins motivate you to keep going. Psychologically powerful even if slightly more expensive.</div></div>
</div>`;
document.getElementById('debt_result').innerHTML=r;
};

// 4. EMERGENCY FUND
window._calcEmergency=function(){
const exp=_v('ef_expenses')+_v('ef_emis');const dep=_v('ef_dependents');const cur=_v('ef_current');const monthly=_v('ef_monthly');const isSelf=_v('ef_type')>=2;
const months=isSelf?12:(dep>=3?9:6);
const target=exp*months;
const pct=target>0?(cur/target*100):0;
const gap=Math.max(0,target-cur);
const monthsToFill=monthly>0?Math.ceil(gap/monthly):999;
document.getElementById('ef_result').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('Monthly Expenses',_f(exp),'var(--cyan)','Needs + EMIs')}
${_res('Target Fund',_f(target),'#f59e0b',months+' months coverage')}
${_res('Current Savings',_f(cur),cur>=target?'#10b981':'#ef4444',pct.toFixed(0)+'% funded')}
${_res('Gap to Fill',_f(gap),gap<=0?'#10b981':'#ef4444',gap<=0?'Fully funded!':'Needs work')}
${_res('Months to Goal',monthsToFill>100?'N/A':monthsToFill+' months','var(--cyan)',monthly>0?'At '+_f(monthly)+'/month':'Set a monthly amount')}
</div>
${_gauge(Math.min(100,pct),'Emergency Fund Progress: '+pct.toFixed(0)+'%')}
<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,.04);border-left:3px solid #f59e0b;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#f59e0b">&#128161; Where to Park Emergency Fund:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">
${S}${Math.round(target*0.3).toLocaleString('en-IN')} (30%) in <strong>Savings Account</strong> — Instant access for Day 1 emergencies<br>
${S}${Math.round(target*0.4).toLocaleString('en-IN')} (40%) in <strong>Liquid Mutual Fund</strong> — Available in 24 hours, earns 5-6% vs 3% in savings<br>
${S}${Math.round(target*0.3).toLocaleString('en-IN')} (30%) in <strong>Short-term FD</strong> — Available in 1-2 days, earns 6-7%, slight lock-in penalty<br>
<strong>Never</strong> put emergency funds in stocks, equity MFs, or long-term FDs. Liquidity is more important than returns for this money.
</div></div>`;
};

// 5. SAVINGS ARCHITECT
window._calcSavings=function(){
const name=document.getElementById('sg_name')?.value||'My Goal';
const target=_v('sg_amount');const years=_v('sg_years');const cur=_v('sg_current');const ret=_v('sg_return')/100;const inf=_v('sg_inflation')/100;
if(!target||!years){return}
const inflatedTarget=target*Math.pow(1+inf,years);
const futureVal=cur*Math.pow(1+ret/12,years*12);
const gap=Math.max(0,inflatedTarget-futureVal);
const monthlyRate=ret/12;const n=years*12;
const sip=monthlyRate>0?gap*monthlyRate/(Math.pow(1+monthlyRate,n)-1):gap/n;
const totalInvested=sip*n+cur;
const wealthCreated=inflatedTarget-totalInvested;
document.getElementById('sg_result').innerHTML=`
<div style="padding:16px;border-radius:10px;background:linear-gradient(135deg,rgba(139,92,246,.06),rgba(59,130,246,.04));border:2px solid rgba(139,92,246,.2);margin-bottom:12px;text-align:center">
<div style="font-size:9px;color:var(--text3);letter-spacing:1px">YOUR GOAL: ${name.toUpperCase()}</div>
<div style="font-size:10px;color:var(--text3);margin-top:4px">Today: ${_f(target)} &#8594; After ${inf>0?inf*100+'% inflation':'0% inflation'}: <strong style="color:#8b5cf6">${_f(inflatedTarget)}</strong></div>
<div style="font-size:9px;color:var(--text3);margin-top:6px">Required Monthly SIP:</div>
<div style="font-size:36px;font-weight:900;color:#8b5cf6;font-family:var(--mono)">${_f(sip)}<span style="font-size:12px;color:var(--text3)">/month</span></div>
<div style="font-size:10px;color:var(--text3)">for ${years} years at ${(ret*100).toFixed(0)}% return</div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('Inflation-Adjusted Target',_f(inflatedTarget),'#8b5cf6',inf>0?'Prices rise '+((inf*100).toFixed(0))+'%/year':'No inflation adjustment')}
${_res('Your Existing Savings',_f(cur),'var(--cyan)','Will grow to '+_f(futureVal))}
${_res('Total You Invest',_f(totalInvested),'var(--amber)','SIP + existing')}
${_res('Wealth Created by Market',_f(wealthCreated),'#10b981','Compounding magic!')}
</div>
<div style="padding:12px;border-radius:8px;background:rgba(139,92,246,.04);border-left:3px solid #8b5cf6;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#8b5cf6">&#128161; The Compounding Secret:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">You invest ${_f(totalInvested)} total, but end up with ${_f(inflatedTarget)}. The extra ${_f(wealthCreated)} is created by compounding — your money earning returns on returns. ${years>=10?'Over '+years+' years, compounding does most of the heavy lifting. Time is literally money.':'For a '+years+'-year goal, consider '+((ret*100)>12?'a mix of equity and debt funds':'debt mutual funds or RDs')+' based on the timeline.'}</div>
</div>`;
};

// 6. TAX OPTIMIZER
window._calcTax=function(){
const gross=_v('tx_gross');if(!gross){return}
const d80c=Math.min(_v('tx_80c'),150000);const d80d=Math.min(_v('tx_80d'),75000);const hra=_v('tx_hra');
const nps=Math.min(_v('tx_80ccd'),50000);const homeLoan=Math.min(_v('tx_home_loan'),200000);
const std=_v('tx_standard')||75000;const other=_v('tx_other');
const totalDeductions=d80c+d80d+hra+nps+homeLoan+std+other;
const oldTaxable=Math.max(0,gross-totalDeductions);
const newStd=75000;const newTaxable=Math.max(0,gross-newStd);
const calcOldTax=(ti)=>{if(ti<=250000)return 0;let t=0;if(ti>250000)t+=Math.min(ti-250000,250000)*0.05;if(ti>500000)t+=Math.min(ti-500000,500000)*0.2;if(ti>1000000)t+=(ti-1000000)*0.3;return t;};
const calcNewTax=(ti)=>{if(ti<=400000)return 0;let t=0;if(ti>400000)t+=Math.min(ti-400000,400000)*0.05;if(ti>800000)t+=Math.min(ti-800000,400000)*0.1;if(ti>1200000)t+=Math.min(ti-1200000,400000)*0.15;if(ti>1600000)t+=Math.min(ti-1600000,400000)*0.2;if(ti>2000000)t+=Math.min(ti-2000000,400000)*0.25;if(ti>2400000)t+=(ti-2400000)*0.3;return t;};
const oldTax=calcOldTax(oldTaxable);const newTax=calcNewTax(newTaxable);
const oldCess=oldTax*0.04;const newCess=newTax*0.04;
const oldTotal=oldTax+oldCess;const newTotal=newTax+newCess;
const better=oldTotal<newTotal?'OLD':'NEW';const saving=Math.abs(oldTotal-newTotal);
document.getElementById('tx_result').innerHTML=`
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
<div style="padding:14px;border-radius:10px;border:2px solid ${better==='OLD'?'#10b981':'var(--border)'};background:${better==='OLD'?'rgba(16,185,129,.04)':'transparent'}">
<div style="font-size:12px;font-weight:700;color:${better==='OLD'?'#10b981':'var(--text)'};margin-bottom:8px">Old Regime ${better==='OLD'?'&#9989; BETTER':''}</div>
<div style="font-size:9px;color:var(--text3);line-height:2">
Gross Income: ${_f(gross)}<br>
Total Deductions: <strong style="color:#10b981">-${_f(totalDeductions)}</strong><br>
Taxable Income: ${_f(oldTaxable)}<br>
Tax: ${_f(oldTax)}<br>
Cess (4%): ${_f(oldCess)}<br>
<strong>Total Tax: <span style="color:#ef4444">${_f(oldTotal)}</span></strong>
</div></div>
<div style="padding:14px;border-radius:10px;border:2px solid ${better==='NEW'?'#10b981':'var(--border)'};background:${better==='NEW'?'rgba(16,185,129,.04)':'transparent'}">
<div style="font-size:12px;font-weight:700;color:${better==='NEW'?'#10b981':'var(--text)'};margin-bottom:8px">New Regime ${better==='NEW'?'&#9989; BETTER':''}</div>
<div style="font-size:9px;color:var(--text3);line-height:2">
Gross Income: ${_f(gross)}<br>
Standard Deduction: <strong style="color:#10b981">-${_f(newStd)}</strong><br>
Taxable Income: ${_f(newTaxable)}<br>
Tax: ${_f(newTax)}<br>
Cess (4%): ${_f(newCess)}<br>
<strong>Total Tax: <span style="color:#ef4444">${_f(newTotal)}</span></strong>
</div></div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(6,182,212,.04);border-left:3px solid var(--cyan)">
<div style="font-size:11px;font-weight:700;color:var(--cyan)">&#128161; Verdict: ${better} Regime saves you ${_f(saving)}/year</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.7">${better==='OLD'?'Your deductions ('+_f(totalDeductions)+') make the Old Regime significantly better. Keep maximizing 80C, 80D, HRA, and NPS. Every deduction directly reduces your tax.':'The New Regime works better for you because your deductions ('+_f(totalDeductions)+') are not high enough to offset the lower slab rates. Consider if increasing deductions (80C, NPS, 80D) could tip the balance.'}</div>
</div>`;
};

// 7. NET WORTH
window._calcNetworth=function(){
const assets=_v('nw_savings')+_v('nw_mf')+_v('nw_pf')+_v('nw_property')+_v('nw_gold')+_v('nw_other_assets');
const liabilities=_v('nw_home_loan')+_v('nw_car_loan')+_v('nw_credit')+_v('nw_other_debt');
const nw=assets-liabilities;
const ratio=liabilities>0?(assets/liabilities):99;
const liquidAssets=_v('nw_savings')+_v('nw_mf');
const liquidPct=assets>0?(liquidAssets/assets*100):0;
document.getElementById('nw_result').innerHTML=`
<div style="padding:20px;border-radius:12px;background:linear-gradient(135deg,#0a1628,#0d2137);text-align:center;margin-bottom:12px">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3)">YOUR NET WORTH</div>
<div style="font-size:40px;font-weight:900;color:${nw>=0?'#10b981':'#ef4444'};font-family:var(--mono)">${_f(nw)}</div>
<div style="font-size:10px;color:rgba(255,255,255,.5)">Assets: ${_f(assets)} &minus; Liabilities: ${_f(liabilities)}</div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('Asset/Liability Ratio',ratio.toFixed(1)+'x',ratio>=3?'#10b981':ratio>=1.5?'#f59e0b':'#ef4444',ratio>=3?'Strong':ratio>=1.5?'Adequate':'Weak')}
${_res('Liquid Assets',_f(liquidAssets),'var(--cyan)',liquidPct.toFixed(0)+'% of total')}
${_res('Property Weight',(assets>0?(_v('nw_property')/assets*100):0).toFixed(0)+'%','var(--amber)',_v('nw_property')/assets*100>60?'Too concentrated':'OK')}
</div>
<div style="padding:12px;border-radius:8px;background:rgba(16,185,129,.04);border-left:3px solid #10b981;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#10b981">&#128161; Your Financial Scoreboard:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">${nw<0?'Your net worth is NEGATIVE. You owe more than you own. Priority #1: Reduce debt aggressively. Stop new borrowing. Every EMI paid increases your net worth.':nw<500000?'Early stage wealth building. Focus on increasing income, maintaining a high savings rate, and avoiding unnecessary debt. Every rupee saved is a soldier working for you.':nw<2500000?'Solid progress! You have crossed the first milestone. Focus on investment diversification and debt reduction to accelerate growth.':'Strong financial position. Consider tax-efficient strategies, estate planning, and ensuring proper insurance coverage to protect this wealth.'} Track this number every quarter — if it consistently goes up, you are winning.</div>
</div>`;
};

// 8. RETIREMENT PLANNER
window._calcRetire=function(){
const age=_v('rt_age');const retAge=_v('rt_retire_age');const life=_v('rt_life');const monthly=_v('rt_monthly');
const cur=_v('rt_current');const preRet=_v('rt_return')/100;const postRet=_v('rt_post_return')/100;const inf=_v('rt_inflation')/100;
if(!age||!retAge){return}
const yearsToRetire=retAge-age;const retYears=life-retAge;
const monthlyAtRetire=monthly*Math.pow(1+inf,yearsToRetire);
const annualAtRetire=monthlyAtRetire*12;
const realPostReturn=(postRet-inf)/(1+inf);
const corpus=realPostReturn>0?annualAtRetire*(1-Math.pow(1+realPostReturn,-retYears))/realPostReturn:annualAtRetire*retYears;
const futureOfCurrent=cur*Math.pow(1+preRet,yearsToRetire);
const gap=Math.max(0,corpus-futureOfCurrent);
const monthlyRate=preRet/12;const n=yearsToRetire*12;
const sipNeeded=monthlyRate>0&&n>0?gap*monthlyRate/(Math.pow(1+monthlyRate,n)-1):gap/Math.max(1,n);
const readiness=corpus>0?Math.min(100,(futureOfCurrent/corpus*100)):0;
document.getElementById('rt_result').innerHTML=`
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px">
${_res('Years to Retirement',yearsToRetire+' yrs','var(--cyan)','Age '+age+' to '+retAge)}
${_res('Monthly Expenses at '+retAge,_f(monthlyAtRetire),'#d97706','Today: '+_f(monthly))}
${_res('Corpus Needed',_f(corpus),'#ef4444','For '+retYears+' years of retirement')}
${_res('Your Savings Will Grow To',_f(futureOfCurrent),'var(--cyan)','Current '+_f(cur)+' at '+((preRet*100).toFixed(0))+'%')}
${_res('Gap to Fill',_f(gap),gap<=0?'#10b981':'#ef4444',gap<=0?'Already on track!':'Need to save more')}
${_res('Monthly SIP Needed',_f(sipNeeded),'#d97706','For '+yearsToRetire+' years')}
</div>
${_gauge(readiness,'Retirement Readiness: '+readiness.toFixed(0)+'%')}
<div style="padding:12px;border-radius:8px;background:rgba(217,119,6,.04);border-left:3px solid #d97706;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#d97706">&#128161; Retirement Reality Check:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">${readiness>=80?'You are well on track for retirement. Continue your current savings rate and avoid lifestyle inflation. Consider increasing equity allocation for the next '+(yearsToRetire>10?'decade':'few years')+' for maximum growth.':readiness>=40?'You have a foundation but need to accelerate. Consider: (1) Increase SIP by '+_f(sipNeeded*0.3)+'/month, (2) Maximize employer PF match, (3) Add NPS for extra tax benefit + retirement corpus.':'Significant gap exists. The good news: you have '+yearsToRetire+' years of compounding ahead. Start with whatever you can — even '+_f(sipNeeded*0.5)+'/month is better than zero. Increase by 10% every year as income grows.'}</div>
</div>`;
};

// 9. INSURANCE AUDIT
window._calcInsurance=function(){
const age=_v('ins_age');const income=_v('ins_income');const dep=_v('ins_dependents');const debts=_v('ins_debts');
const termCover=_v('ins_term_cover');const healthCover=_v('ins_health_cover');
const idealTerm=Math.max(income*(age<40?15:10)+debts, 10000000);
const idealHealth=Math.max(dep*500000,1000000);
const termPct=idealTerm>0?(termCover/idealTerm*100):0;
const healthPct=idealHealth>0?(healthCover/idealHealth*100):0;
const termStatus=termPct>=90?'Adequate':termPct>=50?'Under-insured':'Critically Low';
const healthStatus=healthPct>=90?'Adequate':healthPct>=50?'Under-insured':'Critically Low';
document.getElementById('ins_result').innerHTML=`
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
<div style="padding:14px;border-radius:10px;border:2px solid ${termPct>=90?'#10b981':termPct>=50?'#f59e0b':'#ef4444'};background:rgba(0,47,108,.02)">
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Term Life Insurance</div>
${_gauge(Math.min(100,termPct),'Coverage: '+termPct.toFixed(0)+'%')}
<div style="font-size:9px;color:var(--text2);line-height:1.7;margin-top:6px">
Current: <strong>${_f(termCover)}</strong><br>
Recommended: <strong style="color:#10b981">${_f(idealTerm)}</strong><br>
Status: <strong style="color:${termPct>=90?'#10b981':'#ef4444'}">${termStatus}</strong><br>
${termPct<90?'Gap: <strong style="color:var(--red)">'+_f(idealTerm-termCover)+'</strong>':''}
</div></div>
<div style="padding:14px;border-radius:10px;border:2px solid ${healthPct>=90?'#10b981':healthPct>=50?'#f59e0b':'#ef4444'};background:rgba(0,47,108,.02)">
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Health Insurance</div>
${_gauge(Math.min(100,healthPct),'Coverage: '+healthPct.toFixed(0)+'%')}
<div style="font-size:9px;color:var(--text2);line-height:1.7;margin-top:6px">
Current: <strong>${_f(healthCover)}</strong><br>
Recommended: <strong style="color:#10b981">${_f(idealHealth)}</strong> (${dep} dependents)<br>
Status: <strong style="color:${healthPct>=90?'#10b981':'#ef4444'}">${healthStatus}</strong><br>
${healthPct<90?'Gap: <strong style="color:var(--red)">'+_f(idealHealth-healthCover)+'</strong>':''}
</div></div>
</div>
<div style="padding:12px;border-radius:8px;background:rgba(236,72,153,.04);border-left:3px solid #ec4899;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#ec4899">&#128161; Insurance Checklist:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">
${termPct>=90?'&#9989;':'&#10060;'} Term Life: ${termPct>=90?'Adequate coverage.':'Need '+_f(idealTerm-termCover)+' more cover. Pure term plans cost just '+_f(Math.round((idealTerm-termCover)/1000*0.5))+'/year at age '+age+'.'}<br>
${healthPct>=90?'&#9989;':'&#10060;'} Health: ${healthPct>=90?'Good coverage for your family.':'Need '+_f(idealHealth-healthCover)+' more. Consider a super top-up plan — very cheap for additional coverage.'}<br>
${age>30?'&#9888; Consider a Critical Illness plan ('+_f(Math.min(income*3,5000000))+' cover) — covers cancer, heart attack, stroke with lump sum payout.':''}<br>
&#9888; NEVER mix insurance with investment. Avoid ULIPs, endowment plans, and money-back policies. Buy pure term + pure mutual funds separately.
</div></div>`;
};

// 10. FINANCIAL HEALTH
window._calcHealth=function(){
const inc=_v('fh_income');if(!inc){return}
const exp=_v('fh_expenses');const inv=_v('fh_invest');const emi=_v('fh_emis');
const emFund=_v('fh_emergency');const debt=_v('fh_total_debt');const investments=_v('fh_investments');const insurance=_v('fh_insurance');
const savRate=inc>0?((inc-exp)/inc*100):0;
const emiRatio=inc>0?(emi/inc*100):0;
const emMonths=exp>0?(emFund/exp):0;
const dtiRatio=inc>0?(debt/(inc*12)*100):0;
const insMultiple=inc>0?(insurance/(inc*12)):0;
const invRate=inc>0?(inv/inc*100):0;
const scores=[];
scores.push({name:'Savings Rate',val:savRate.toFixed(0)+'%',score:savRate>=30?25:savRate>=20?20:savRate>=10?10:0,max:25,tip:savRate>=20?'Excellent saver!':'Target 20%+ savings rate',icon:'&#128176;'});
scores.push({name:'EMI Burden',val:emiRatio.toFixed(0)+'%',score:emiRatio<=20?20:emiRatio<=35?12:emiRatio<=50?5:0,max:20,tip:emiRatio<=35?'Manageable debt':'EMIs too high (>35% income)',icon:'&#9939;'});
scores.push({name:'Emergency Fund',val:emMonths.toFixed(1)+' months',score:emMonths>=6?20:emMonths>=3?12:emMonths>=1?5:0,max:20,tip:emMonths>=6?'Well prepared!':'Need 6+ months of expenses',icon:'&#128737;'});
scores.push({name:'Insurance Cover',val:insMultiple.toFixed(0)+'x income',score:insMultiple>=10?15:insMultiple>=5?10:insMultiple>=2?5:0,max:15,tip:insMultiple>=10?'Adequate protection':'Need 10-15x annual income',icon:'&#128737;'});
scores.push({name:'Investment Rate',val:invRate.toFixed(0)+'%',score:invRate>=20?20:invRate>=10?12:invRate>=5?5:0,max:20,tip:invRate>=15?'Strong investor!':'Target 15-20% of income',icon:'&#128200;'});
const totalScore=scores.reduce((s,v)=>s+v.score,0);
const grade=totalScore>=85?'A+':totalScore>=70?'A':totalScore>=55?'B':totalScore>=40?'C':'D';
const gradeC=totalScore>=70?'#10b981':totalScore>=50?'#f59e0b':'#ef4444';
const verdict=totalScore>=85?'Financially Excellent':totalScore>=70?'Financially Healthy':totalScore>=55?'Needs Attention':totalScore>=40?'At Risk':'Critical';
let r=`<div style="padding:20px;border-radius:12px;background:linear-gradient(135deg,#0a1628,#0d2137);text-align:center;margin-bottom:16px">
<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.3)">FINANCIAL HEALTH SCORE</div>
<div style="font-size:48px;font-weight:900;color:${gradeC};font-family:var(--mono)">${totalScore}<span style="font-size:16px">/100</span></div>
<div style="font-size:14px;font-weight:700;color:${gradeC}">${verdict} (Grade ${grade})</div>
</div>`;
r+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-bottom:12px">`;
scores.forEach(s=>{const pct=s.max>0?(s.score/s.max*100):0;const c=pct>=80?'#10b981':pct>=50?'#f59e0b':'#ef4444';r+=`<div style="padding:12px;border-radius:8px;border:1px solid var(--border);background:rgba(0,47,108,.02)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:10px;color:var(--text)">${s.icon} ${s.name}</span><span style="font-size:12px;font-weight:800;color:${c}">${s.score}/${s.max}</span></div><div style="font-size:14px;font-weight:700;color:${c};margin-bottom:4px">${s.val}</div>${_gauge(pct,s.tip)}</div>`;});
r+=`</div>`;
r+=`<div style="padding:12px;border-radius:8px;background:rgba(20,184,166,.04);border-left:3px solid #14b8a6;margin-top:10px">
<div style="font-size:10px;font-weight:700;color:#14b8a6">&#128161; Your Financial Prescription:</div>
<div style="font-size:9px;color:var(--text2);margin-top:4px;line-height:1.8">`;
scores.forEach(s=>{const pct=s.max>0?(s.score/s.max*100):0;if(pct<60){r+=`&#9888; <strong>${s.name}</strong>: ${s.tip}<br>`;}});
if(totalScore>=85)r+='&#127942; Outstanding financial health! Focus on tax optimization and estate planning to protect and grow your wealth further.';
else if(totalScore>=70)r+='&#128170; Strong foundation. Address the weak areas above to move from good to excellent.';
else r+='&#128680; Multiple areas need improvement. Start with the lowest-scoring vital sign and work your way up. Even small improvements compound over time.';
r+=`</div></div>`;
document.getElementById('fh_result').innerHTML=r;
};

console.log('Personal Finance toolkit rendered: 10 tools');
}


// ═══ CONVICTION LEADERBOARD — Top 5 by category per country ═══
const CONVICTION_DATA={
india:{
  buy:[
    {n:'Bajaj Finance',t:'BAJFINANCE.NS',why:'NBFC leader, 25%+ ROE, fortress balance sheet, digital lending moat',s:72},
    {n:'Trent Limited',t:'TRENT.NS',why:'Zudio growth engine, Zara India exclusivity, 40%+ revenue CAGR',s:68},
    {n:'Dixon Technologies',t:'DIXON.NS',why:'PLI beneficiary, electronics mfg monopoly, backward integration',s:65},
    {n:'CDSL',t:'CDSL.NS',why:'Demat duopoly, zero-debt, 60%+ margins, financialization tailwind',s:64},
    {n:'Persistent Systems',t:'PERSISTENT.NS',why:'Healthcare IT niche, 20%+ revenue growth, high IP business',s:62}
  ],
  sell:[
    {n:'Vodafone Idea',t:'IDEA.NS',why:'Massive debt, negative cash flow, subscriber loss to Jio/Airtel',s:-45},
    {n:'IRCTC',t:'IRCTC.NS',why:'Govt interference risk, margin pressure, overvalued vs growth',s:-28},
    {n:'Paytm',t:'PAYTM.NS',why:'Path to profitability unclear, regulatory overhang, cash burn',s:-32},
    {n:'Zee Entertainment',t:'ZEEL.NS',why:'Merger uncertainty, debt concerns, ad revenue pressure',s:-25},
    {n:'GMR Airports',t:'GMRINFRA.NS',why:'Heavy debt, capex cycle years out, dilution risk',s:-22}
  ],
  accumulate:[
    {n:'HDFC Bank',t:'HDFCBANK.NS',why:'Post-merger stabilizing, best asset quality, CASA franchise',s:45},
    {n:'Infosys',t:'INFY.NS',why:'Margin recovery, AI services ramp, attractive at 22-24x PE',s:42},
    {n:'Tata Motors',t:'TATAMOTORS.NS',why:'JLR turnaround, EV push, domestic CV leadership',s:40},
    {n:'ITC',t:'ITC.NS',why:'Hotel demerger value unlock, FMCG scaling, high dividend yield',s:38},
    {n:'Asian Paints',t:'ASIANPAINT.NS',why:'Correction from highs, moat intact, rural recovery play',s:35}
  ]
},
usa:{
  buy:[
    {n:'NVIDIA',t:'NVDA',why:'AI compute monopoly, 70%+ data center growth, CUDA moat',s:78},
    {n:'Microsoft',t:'MSFT',why:'Azure + Copilot AI, 40%+ cloud margins, enterprise dominance',s:70},
    {n:'CrowdStrike',t:'CRWD',why:'Cloud-native security leader, 75%+ gross margins, expanding TAM',s:65},
    {n:'Palantir',t:'PLTR',why:'AI/government platform, 30%+ revenue growth, profitable',s:62},
    {n:'Alphabet',t:'GOOGL',why:'Search + Cloud + Waymo, 15x forward FCF, AI integration',s:60}
  ],
  sell:[
    {n:'Snap Inc',t:'SNAP',why:'User growth stalled, ad revenue pressure, negative FCF',s:-38},
    {n:'Beyond Meat',t:'BYND',why:'Revenue declining, cash burn, management exodus',s:-52},
    {n:'Peloton',t:'PTON',why:'Subscription churn, hardware obsolescence, debt burden',s:-42},
    {n:'Rivian',t:'RIVN',why:'Massive cash burn, production delays, capital raise dilution',s:-35},
    {n:'ChargePoint',t:'CHPT',why:'EV charging commoditized, negative gross margins, cash runway risk',s:-40}
  ],
  accumulate:[
    {n:'Apple',t:'AAPL',why:'Services flywheel, $100B+ buybacks, AI iPhone super cycle',s:48},
    {n:'Amazon',t:'AMZN',why:'AWS re-acceleration, retail margins expanding, AI + ads',s:46},
    {n:'Meta Platforms',t:'META',why:'Reels monetization, Reality Labs optionality, cheap on FCF',s:44},
    {n:'Visa',t:'V',why:'Payment duopoly, 65%+ net margins, cross-border recovery',s:42},
    {n:'UnitedHealth',t:'UNH',why:'Healthcare oligopoly, Optum vertical, consistent 15% EPS growth',s:40}
  ]
}};

let _convGeo='india';
function showConvGeo(btn,geo){
_convGeo=geo;
document.querySelectorAll('#convGeoTabs .ptab').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text2)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--amber)';btn.style.color='#000';btn.style.borderColor='var(--amber)';
renderConviction();
}

function renderConviction(){
const el=document.getElementById('convGrid');if(!el)return;
const d=CONVICTION_DATA[_convGeo];if(!d){el.innerHTML='';return}
function card(title,emoji,stocks,color,bgColor){
let h=`<div style="border-radius:10px;overflow:hidden;border:1px solid ${color}22;background:${bgColor}">`;
h+=`<div style="padding:10px 12px;background:${color}15;border-bottom:1px solid ${color}22;display:flex;align-items:center;gap:6px">`;
h+=`<span style="font-size:16px">${emoji}</span>`;
h+=`<span style="font-family:'Sora',sans-serif;font-size:11px;font-weight:800;color:${color}">${title}</span>`;
h+=`<span style="margin-left:auto;font-size:9px;font-weight:700;color:${color};background:${color}12;padding:1px 6px;border-radius:3px">TOP 5</span></div>`;
stocks.forEach((s,i)=>{
h+=`<div style="padding:8px 12px;border-bottom:1px solid rgba(0,0,0,.04);font-size:11px${i===4?';border-bottom:none':''}">`;
h+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">`;
h+=`<span style="font-size:10px;font-weight:800;color:${color};background:${color}15;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border-radius:50%">${i+1}</span>`;
h+=`<strong style="font-size:11px;color:var(--text);cursor:pointer" onclick="quickAnalyze('${s.t}')">${s.n}</strong>`;
h+=`<span style="font-family:var(--mono);font-size:9px;color:var(--text3)">${s.t}</span>`;
h+=`<span data-conv-ticker="${s.t}" style="margin-left:auto;font-family:var(--mono);font-size:10px;color:var(--text3)">⏳</span>`;
h+=`</div>`;
h+=`<div style="font-size:10px;color:var(--text3);line-height:1.4">${s.why}</div>`;
h+=`</div>`;
});
return h+'</div>';
}
el.innerHTML=
  card('AGGRESSIVE BUY','\u{1F7E2}',d.buy,'#14a23a','rgba(20,162,58,.02)')+
  card('ACCUMULATE','\u{1F7E1}',d.accumulate,'#d48a00','rgba(212,138,0,.02)')+
  card('SELL / AVOID','\u{1F534}',d.sell,'#d0021b','rgba(208,2,27,.02)');
// Fetch live prices for conviction stocks
fetchConvictionPrices();
}

async function fetchConvictionPrices(){
const cells=document.querySelectorAll('[data-conv-ticker]');
if(!cells.length)return;
const tickers=[...new Set([...cells].map(c=>c.dataset.convTicker).filter(Boolean))];
if(!tickers.length)return;
console.log('📡 fetchConvictionPrices:',tickers.length,'tickers');
cells.forEach(c=>{c.innerHTML='<span style="color:var(--text3);font-size:9px">⏳</span>'});
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:tickers})});
if(!res.ok){console.error('Conviction HTTP',res.status);cells.forEach(c=>{c.textContent='—'});return}
const data=await res.json();
if(!data.success||!data.prices){cells.forEach(c=>{c.textContent='—'});return}
let ok=0;
cells.forEach(cell=>{
const tk=cell.dataset.convTicker;
const p=data.prices[tk];
if(p&&p.formatted){
ok++;
const up=(p.change_pct||0)>=0;
cell.innerHTML=`<span style="font-weight:700;color:${up?'var(--green)':'var(--red)'}">${p.formatted}</span> <span style="font-size:7px;color:${up?'var(--green)':'var(--red)'}">${up?'\u25b2':'\u25bc'}${Math.abs(p.change_pct||0).toFixed(1)}%</span>`;
}else{cell.textContent='—'}
});
console.log('✅ Conviction:',ok+'/'+cells.length);
}catch(e){console.error('fetchConvictionPrices error:',e);cells.forEach(c=>{c.textContent='—'})}
}

// Auto-render on page load
setTimeout(renderConviction,100);

// ETF & MUTUAL FUND DATA — 25%+ CAGR COMPOUNDERS
// ═══════════════════════════════════════════════
// yfinance ticker mapping for live NAV
const FUND_YF_MAP={
'QQQ':'QQQ','SMH':'SMH','SOXX':'SOXX','VGT':'VGT','AIQ':'AIQ',
'FCNTX':'FCNTX','TRBCX':'TRBCX','FDGRX':'FDGRX','BPTIX':'BPTIX','VIGAX':'VIGAX',
'MON100':'MOTILALOFSP.NS','JUNIORBEES':'JUNIORBEES.NS',
'NETFIT':'NETFNIFTYIT.NS','ICICIN50':'NIFTYBEES.NS','MAFANG':'MAFANG.NS'
};
const FUND_DATA={
etf_in:{title:'India ETFs — Top Performers',data:[
{n:'Motilal Oswal NASDAQ 100 ETF',t:'MON100',aum:'₹5,800 Cr',exp:'0.58%',y1:'28.4%',y3:'14.2%',y5:'27.1%',y10:'22.8%',dd:'-32%',rec:'4 months',corr:'Hedges INR depreciation, US tech exposure',r:'★ Aggressive Buy',risk:'High',cat:'US Tech Proxy'},
{n:'Nippon India ETF Nifty IT',t:'NETFIT',aum:'₹2,100 Cr',exp:'0.21%',y1:'22.1%',y3:'10.5%',y5:'25.8%',y10:'20.4%',dd:'-28%',rec:'5 months',corr:'IT exports benefit from weak rupee, recession hedge',r:'Strong Buy',risk:'Medium-High',cat:'Sector ETF'},
{n:'ICICI Pru Nifty Next 50 ETF',t:'ICICIN50',aum:'₹1,600 Cr',exp:'0.15%',y1:'35.2%',y3:'22.8%',y5:'26.3%',y10:'18.5%',dd:'-35%',rec:'7 months',corr:'Future large-caps, strong SIP alpha over Nifty 50',r:'Strong Buy',risk:'Medium-High',cat:'Mid-Large Cap'},
{n:'Mirae Asset NYSE FANG+ ETF',t:'MAFANG',aum:'₹3,200 Cr',exp:'0.66%',y1:'32.5%',y3:'16.1%',y5:'29.4%',y10:'—',dd:'-38%',rec:'5 months',corr:'Concentrated mega-tech, high beta but fastest recovery',r:'Buy',risk:'High',cat:'US FANG+'},
{n:'Nippon India ETF Junior BeES',t:'JUNIORBEES',aum:'₹4,200 Cr',exp:'0.20%',y1:'33.8%',y3:'21.6%',y5:'25.1%',y10:'17.9%',dd:'-36%',rec:'8 months',corr:'Nifty Next 50 tracks emerging blue-chips, outperforms in bull runs',r:'Strong Buy',risk:'Medium',cat:'Next 50'}
]},
mf_in:{title:'India Mutual Funds — Wealth Compounders',data:[
{n:'Quant Small Cap Fund',t:'QUANT-SC',aum:'₹26,800 Cr',exp:'0.62%',y1:'25.1%',y3:'25.4%',y5:'42.8%',y10:'24.6%',dd:'-42%',rec:'4 months',corr:'Fastest recovery in COVID. Quant model exits before crashes, re-enters early. Momentum + contrarian hybrid.',r:'★ Aggressive Buy',risk:'Very High',cat:'Small Cap'},
{n:'Nippon India Small Cap Fund',t:'NIPPON-SC',aum:'₹62,000 Cr',exp:'0.68%',y1:'22.8%',y3:'26.1%',y5:'38.5%',y10:'26.2%',dd:'-38%',rec:'5 months',corr:'Largest small-cap fund. Diversified across 150+ stocks. Lower concentration risk despite high AUM.',r:'★ Aggressive Buy',risk:'Very High',cat:'Small Cap'},
{n:'Quant Mid Cap Fund',t:'QUANT-MC',aum:'₹9,200 Cr',exp:'0.57%',y1:'18.4%',y3:'24.8%',y5:'35.2%',y10:'22.1%',dd:'-35%',rec:'3 months',corr:'Quant timing model excels. Reduced equity to 65% before 2022 correction. Fastest drawdown recovery.',r:'Strong Buy',risk:'High',cat:'Mid Cap'},
{n:'SBI Small Cap Fund',t:'SBI-SC',aum:'₹33,500 Cr',exp:'0.66%',y1:'24.2%',y3:'22.6%',y5:'30.4%',y10:'27.8%',dd:'-36%',rec:'6 months',corr:'Conservative small-cap. Higher quality bias. Lower drawdown vs peers due to balance sheet screening.',r:'Strong Buy',risk:'High',cat:'Small Cap'},
{n:'Parag Parikh Flexi Cap Fund',t:'PPFAS',aum:'₹82,000 Cr',exp:'0.63%',y1:'24.6%',y3:'19.2%',y5:'27.8%',y10:'21.4%',dd:'-25%',rec:'3 months',corr:'30% global allocation hedges India risk. Held Google/Amazon through 2022. Lowest drawdown in category.',r:'★ Aggressive Buy',risk:'Medium',cat:'Flexi Cap'},
{n:'HDFC Mid-Cap Opportunities',t:'HDFC-MC',aum:'₹75,000 Cr',exp:'0.72%',y1:'26.1%',y3:'28.5%',y5:'32.4%',y10:'22.8%',dd:'-30%',rec:'5 months',corr:'Largest mid-cap. Track record since 2007. Survived 3 bear markets. Quality-growth stock picking.',r:'Strong Buy',risk:'High',cat:'Mid Cap'},
{n:'Canara Robeco Small Cap Fund',t:'CANROB-SC',aum:'₹12,400 Cr',exp:'0.42%',y1:'28.4%',y3:'24.1%',y5:'34.6%',y10:'—',dd:'-33%',rec:'4 months',corr:'Lowest expense ratio in category. Systematic stock selection. Outperforms in rising markets.',r:'Buy',risk:'High',cat:'Small Cap'}
]},
etf_us:{title:'USA ETFs — Growth & Sector Leaders',data:[
{n:'Invesco QQQ Trust',t:'QQQ',aum:'$312B',exp:'0.20%',y1:'26.8%',y3:'11.4%',y5:'22.1%',y10:'20.4%',dd:'-33%',rec:'6 months',corr:'NASDAQ-100. Top 100 non-financial. Heavy mega-tech. Best liquidity. Quick recovery from every correction.',r:'★ Aggressive Buy',risk:'Medium-High',cat:'Large Cap Tech'},
{n:'VanEck Semiconductor ETF',t:'SMH',aum:'$28B',exp:'0.35%',y1:'35.2%',y3:'28.6%',y5:'32.8%',y10:'28.4%',dd:'-38%',rec:'5 months',corr:'AI capex cycle drives demand. NVDA+TSM+ASML = 35% weight. Secular growth from AI/auto/cloud.',r:'★ Aggressive Buy',risk:'High',cat:'Semiconductor'},
{n:'iShares Semiconductor ETF',t:'SOXX',aum:'$16B',exp:'0.35%',y1:'30.1%',y3:'24.2%',y5:'28.6%',y10:'25.1%',dd:'-36%',rec:'5 months',corr:'More equal-weighted than SMH. Better diversification. Includes AMD, MRVL, ON Semi. Less NVDA-dependent.',r:'Strong Buy',risk:'High',cat:'Semiconductor'},
{n:'Vanguard Info Technology ETF',t:'VGT',aum:'$85B',exp:'0.10%',y1:'28.4%',y3:'14.8%',y5:'24.2%',y10:'22.1%',dd:'-30%',rec:'5 months',corr:'Broadest tech exposure. Apple+MSFT = 35%. Ultra-low expense. Outperforms S&P by 6%+ annually.',r:'Strong Buy',risk:'Medium-High',cat:'Tech Sector'},
{n:'Global X AI & Technology ETF',t:'AIQ',aum:'$2.8B',exp:'0.68%',y1:'22.5%',y3:'12.8%',y5:'25.4%',y10:'—',dd:'-35%',rec:'6 months',corr:'Pure AI play. Includes infra (NVDA), platform (MSFT), application (CRM) layers. Secular AI capex theme.',r:'Buy',risk:'High',cat:'AI Theme'}
]},
mf_us:{title:'USA Funds — Institutional Grade',data:[
{n:'Fidelity Contrafund',t:'FCNTX',aum:'$149B',exp:'0.39%',y1:'32.4%',y3:'14.2%',y5:'22.8%',y10:'18.4%',dd:'-28%',rec:'5 months',corr:'Legendary active fund. Will Danoff since 1990. Consistently beats S&P. Low turnover = tax efficient.',r:'Strong Buy',risk:'Medium',cat:'Large Cap Growth'},
{n:'T. Rowe Price Blue Chip Growth',t:'TRBCX',aum:'$62B',exp:'0.57%',y1:'36.2%',y3:'10.8%',y5:'20.6%',y10:'17.8%',dd:'-38%',rec:'7 months',corr:'High-conviction growth. Concentrated top 10. Higher drawdown but faster alpha generation in recoveries.',r:'Buy',risk:'Medium-High',cat:'Large Cap Growth'},
{n:'Fidelity Growth Company',t:'FDGRX',aum:'$68B',exp:'0.52%',y1:'38.1%',y3:'14.6%',y5:'25.2%',y10:'21.6%',dd:'-35%',rec:'5 months',corr:'Mid+Large growth blend. Discovers winners early. NVDA was top pick in 2019. Exceptional stock selection.',r:'★ Aggressive Buy',risk:'High',cat:'Multi-Cap Growth'},
{n:'Baron Partners Fund',t:'BPTIX',aum:'$9.8B',exp:'1.04%',y1:'22.8%',y3:'12.1%',y5:'28.4%',y10:'22.4%',dd:'-40%',rec:'6 months',corr:'Concentrated + leveraged. 30% TSLA at peak. Highest conviction. Massive alpha in bull markets.',r:'Accumulate',risk:'Very High',cat:'Concentrated'},
{n:'Vanguard Growth Index Fund',t:'VIGAX',aum:'$248B',exp:'0.05%',y1:'30.2%',y3:'12.8%',y5:'22.4%',y10:'18.8%',dd:'-30%',rec:'5 months',corr:'Cheapest growth fund. Market-cap weighted. Zero stock-picking risk. Pure growth factor exposure.',r:'Strong Buy',risk:'Medium',cat:'Growth Index'}
]},
};

function showFundCat(btn,cat){
document.querySelectorAll('#fundTabs .ptab').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
renderFunds(cat);
}

function renderFunds(cat){
const el=document.getElementById('fundGrid');
if(!el)return;

if(cat==='compare'){
renderFundComparison();return;
}

const d=FUND_DATA[cat];
if(!d){el.innerHTML='';return}
let h=`<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px">${d.title}</div>`;

// Main performance table
h+=`<div style="overflow-x:auto"><table class="pick-tbl">
<tr>
<th>#</th><th>Fund</th><th>Rating</th><th>Live NAV</th><th>AUM</th><th>Exp%</th>
<th style="color:var(--text3)">1Y</th><th style="color:var(--amber)">3Y</th><th style="color:var(--green)">5Y</th><th style="color:var(--green)">10Y</th>
<th style="color:var(--red)">Max DD</th><th>Recovery</th><th>Risk</th>
</tr>`;
d.data.forEach((f,i)=>{
const rt=f.r||'Buy';
const rC=rt.includes('Aggressive')?'#10b981':rt.includes('Strong')?'#10b981':rt==='Buy'?'#3b82f6':'#f59e0b';
const rBg=rt.includes('Aggressive')?'rgba(16,185,129,.15)':rt.includes('Strong')?'rgba(16,185,129,.08)':rt==='Buy'?'rgba(0,120,212,.08)':'rgba(245,158,11,.08)';
const riskC=f.risk.includes('Very')?'var(--red)':f.risk.includes('High')?'var(--amber)':'var(--green)';
const y5n=parseFloat(f.y5)||0;
const y5C=y5n>=30?'var(--green)':y5n>=25?'#22d3ee':'var(--amber)';
const y10n=parseFloat(f.y10)||0;
const y10C=y10n>=25?'var(--green)':y10n>=20?'#22d3ee':'var(--text2)';
h+=`<tr>
<td style="color:var(--text3);font-weight:700">${i+1}</td>
<td><div class="cname">${f.n}</div><div class="csub">${f.t} · ${f.cat}</div></td>
<td><span style="font-size:9px;padding:2px 6px;border-radius:4px;background:${rBg};color:${rC};font-weight:700;white-space:nowrap">${rt}</span></td>
<td data-fund-ticker="${f.t}" style="font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap">${FUND_YF_MAP[f.t]?'⏳':'—'}</td>
<td style="font-size:10px;color:var(--cyan);white-space:nowrap">${f.aum}</td>
<td style="font-size:10px;color:var(--text3)">${f.exp}</td>
<td style="font-size:10px;color:var(--text2)">${f.y1}</td>
<td style="font-size:10px;color:var(--amber);font-weight:600">${f.y3}</td>
<td style="font-size:11px;color:${y5C};font-weight:700">${f.y5}</td>
<td style="font-size:11px;color:${y10C};font-weight:700">${f.y10}</td>
<td style="font-size:10px;color:var(--red);font-weight:600">${f.dd}</td>
<td style="font-size:10px;color:var(--text2)">${f.rec}</td>
<td style="font-size:9px;color:${riskC};font-weight:600">${f.risk}</td>
</tr>`;
});
h+=`</table></div>`;

// Correction resilience cards
h+=`<div style="margin-top:14px;font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--amber);letter-spacing:.5px;margin-bottom:8px">&#128737; CORRECTION RESILIENCE ANALYSIS</div>`;
h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px">`;
d.data.forEach(f=>{
const ddn=Math.abs(parseInt(f.dd))||30;
const resC=ddn<=28?'var(--green)':ddn<=35?'var(--amber)':'var(--red)';
const recM=parseInt(f.rec)||5;
const recC=recM<=4?'var(--green)':recM<=6?'var(--amber)':'var(--red)';
h+=`<div style="padding:8px 10px;border-radius:6px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="font-weight:700;color:var(--text);font-size:11px;margin-bottom:4px">${f.n}</div>
<div style="display:flex;gap:8px;margin-bottom:4px">
<span style="font-size:9px;color:${resC};font-weight:700">DD: ${f.dd}</span>
<span style="font-size:9px;color:${recC};font-weight:700">Rec: ${f.rec}</span>
</div>
<div style="font-size:9px;color:var(--text3);line-height:1.5">${f.corr}</div>
</div>`;
});
h+=`</div>`;
h+=`<div style="font-size:9px;color:var(--text3);margin-top:8px">* Returns are CAGR (compound annual growth rate). Max DD = maximum drawdown during COVID/2022. Recovery = time to reach pre-crash levels. Past performance does not guarantee future results.</div>`;
el.innerHTML=h;
// Fetch live NAV for funds with yfinance tickers
fetchFundNAVs(el);
}

async function fetchFundNAVs(container){
if(!container)return;
const cells=container.querySelectorAll('td[data-fund-ticker]');
if(!cells.length)return;
const tickerPairs=[];
cells.forEach(c=>{
const ft=c.dataset.fundTicker;
const yft=FUND_YF_MAP[ft];
if(yft)tickerPairs.push({cell:c,yf:yft,ft:ft});
});
if(!tickerPairs.length)return;
const yfTickers=[...new Set(tickerPairs.map(p=>p.yf))];
console.log('📡 fetchFundNAVs:',yfTickers.length,'tickers');
tickerPairs.forEach(p=>{p.cell.innerHTML='<span style="color:var(--text3);font-size:9px">⏳</span>'});
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:yfTickers})});
if(!res.ok){tickerPairs.forEach(p=>{p.cell.textContent='—'});return}
const data=await res.json();
if(!data.success||!data.prices){tickerPairs.forEach(p=>{p.cell.textContent='—'});return}
let ok=0;
tickerPairs.forEach(p=>{
const pr=data.prices[p.yf];
if(pr&&pr.formatted){
ok++;
const up=(pr.change_pct||0)>=0;
p.cell.innerHTML=`<span style="font-weight:700;color:${up?'var(--green)':'var(--red)'}">${pr.formatted}</span> <span style="font-size:7px;color:${up?'var(--green)':'var(--red)'}">${up?'\u25b2':'\u25bc'}${Math.abs(pr.change_pct||0).toFixed(1)}%</span>`;
}else{p.cell.textContent='—'}
});
console.log('✅ Fund NAVs:',ok+'/'+tickerPairs.length);
}catch(e){console.error('fetchFundNAVs error:',e);tickerPairs.forEach(p=>{p.cell.textContent='—'})}
}

function renderFundComparison(){
const el=document.getElementById('fundGrid');
if(!el)return;
let h='';

// Head-to-head comparison
h+=`<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px">&#128202; Head-to-Head: Best-in-Class Comparison</div>`;
const cmp=[
{cat:'Small Cap (India)',a:'Quant Small Cap',b:'Nippon Small Cap',a5:'42.8%',b5:'38.5%',add:'-42% / 4mo',bdd:'-38% / 5mo',av:'Quant model timing, faster recovery',bv:'Broader diversification (150+ stocks), lower concentration risk',pick:'Quant for aggression, Nippon for stability'},
{cat:'Mid Cap (India)',a:'Quant Mid Cap',b:'HDFC Mid-Cap Opp',a5:'35.2%',b5:'32.4%',add:'-35% / 3mo',bdd:'-30% / 5mo',av:'Fastest recovery, quantitative timing model',bv:'Proven since 2007, 3 bear markets survived, quality bias',pick:'HDFC for track record, Quant for alpha'},
{cat:'Flexi/Multi (India)',a:'Parag Parikh Flexi',b:'SBI Small Cap',a5:'27.8%',b5:'30.4%',add:'-25% / 3mo',bdd:'-36% / 6mo',av:'Lowest drawdown, 30% global hedge, all-weather fund',bv:'Higher returns but higher volatility, pure India small-cap bet',pick:'Parag Parikh for correction-proof SIP'},
{cat:'Semiconductor (USA)',a:'SMH',b:'SOXX',a5:'32.8%',b5:'28.6%',add:'-38% / 5mo',bdd:'-36% / 5mo',av:'NVDA+TSM heavy = higher beta, AI capex direct play',bv:'More equal-weighted, less single-stock risk, broader chip exposure',pick:'SMH for conviction, SOXX for diversification'},
{cat:'Tech Broad (USA)',a:'QQQ',b:'VGT',a5:'22.1%',b5:'24.2%',add:'-33% / 6mo',bdd:'-30% / 5mo',av:'Top 100 non-financial NASDAQ, highest liquidity, options available',bv:'Lower cost (0.10%), tighter tech focus, slightly better long-term CAGR',pick:'VGT for pure tech, QQQ for breadth + options'},
{cat:'Active vs Index (USA)',a:'Fidelity Growth Co',b:'Vanguard Growth Idx',a5:'25.2%',b5:'22.4%',add:'-35% / 5mo',bdd:'-30% / 5mo',av:'Stock picker alpha, early NVDA bet, discovers winners before index',bv:'0.05% expense, zero manager risk, tax efficient, no underperformance risk',pick:'FDGRX for alpha seekers, VIGAX for passive wealth'}
];
h+=`<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Category</th><th>Fund A</th><th>Fund B</th><th>5Y CAGR</th><th>Max DD / Recovery</th><th>A Advantage</th><th>B Advantage</th><th style="color:var(--green)">Verdict</th></tr>`;
cmp.forEach(c=>{
h+=`<tr>
<td style="font-weight:700;color:var(--amber);font-size:10px;white-space:nowrap">${c.cat}</td>
<td style="font-weight:600;font-size:10px">${c.a}</td>
<td style="font-weight:600;font-size:10px">${c.b}</td>
<td style="font-size:10px"><span style="color:var(--green);font-weight:700">${c.a5}</span> vs <span style="color:var(--cyan)">${c.b5}</span></td>
<td style="font-size:9px;color:var(--red)">${c.add}<br>${c.bdd}</td>
<td style="font-size:9px;color:var(--text2)">${c.av}</td>
<td style="font-size:9px;color:var(--text2)">${c.bv}</td>
<td style="font-size:9px;color:var(--green);font-weight:700">${c.pick}</td>
</tr>`;
});
h+=`</table></div>`;

// SIP Strategy
h+=`<div style="margin-top:16px;padding:12px 14px;border-radius:8px;background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(59,130,246,.04));border:1px solid rgba(16,185,129,.15)">
<div style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--green);margin-bottom:6px">&#127919; CORRECTION-PROOF SIP ALLOCATION (30-40% crash survival)</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;font-size:10px;color:var(--text2);line-height:1.6">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03);border-left:3px solid var(--green)"><strong style="color:var(--green)">AGGRESSIVE (Age &lt;35)</strong><br>40% Quant/Nippon Small Cap<br>25% SMH/SOXX Semiconductor<br>20% Parag Parikh Flexi<br>15% QQQ/NASDAQ 100<br><span style="color:var(--text3)">Expected: 28-35% CAGR · Max DD: -40%</span></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03);border-left:3px solid var(--amber)"><strong style="color:var(--amber)">BALANCED (Age 35-50)</strong><br>30% HDFC/SBI Mid-Small Cap<br>25% Parag Parikh Flexi<br>20% VGT/QQQ<br>15% Nifty Next 50 ETF<br>10% Gold ETF (hedge)<br><span style="color:var(--text3)">Expected: 22-28% CAGR · Max DD: -32%</span></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03);border-left:3px solid var(--blue)"><strong style="color:var(--blue)">CONSERVATIVE (Age 50+)</strong><br>30% Parag Parikh Flexi<br>25% Nifty 50 ETF<br>20% Vanguard Growth Idx<br>15% Balanced Advantage<br>10% Gold + Debt<br><span style="color:var(--text3)">Expected: 16-22% CAGR · Max DD: -25%</span></div>
</div>
</div>`;

h+=`<div style="margin-top:10px;font-size:9px;color:var(--text3)">* All CAGR figures are trailing returns as of latest available data. Max drawdown measured from COVID-19 (Mar 2020) or 2022 bear market, whichever was deeper. This is educational analysis — consult your financial advisor for personalized allocation.</div>`;
el.innerHTML=h;
}

// ═══════════════════════════════════════════════
// TRADE SCORECARD — Validate past trades vs actual
// ═══════════════════════════════════════════════
// ═══════════════════════════════════════════════
// PORTFOLIO DECISION ENGINE — Standalone ticker + buy price analysis
// Uses /api/stock-quick for instant data, then runs multi-factor algorithm
// ═══════════════════════════════════════════════
async function runPortfolioDecision(){
const tickerEl=document.getElementById('pdTicker');
const bpEl=document.getElementById('pdBuyPrice');
const resEl=document.getElementById('pdResult');
const btn=document.getElementById('pdBtn');
if(!tickerEl||!bpEl||!resEl)return;
const ticker=tickerEl.value.trim().toUpperCase();
const buyPrice=parseFloat(bpEl.value);
if(!ticker){resEl.innerHTML='<div style="font-size:11px;color:var(--red)">Enter a ticker symbol.</div>';return}
if(!buyPrice||buyPrice<=0){resEl.innerHTML='<div style="font-size:11px;color:var(--red)">Enter your buy price.</div>';return}
btn.disabled=true;btn.textContent='Fetching data...';
resEl.innerHTML='<div style="text-align:center;padding:12px;color:var(--text3)"><div style="display:inline-block;width:16px;height:16px;border:2px solid var(--blue);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div> Fetching live data for '+ticker+'...</div>';
try{
const res=await fetch(`/api/stock-quick?ticker=${encodeURIComponent(ticker)}`);
const data=await res.json();
if(!data.success){resEl.innerHTML=`<div style="font-size:11px;color:var(--red)">${data.error||'Failed to fetch data'}</div>`;return}
// Run the same multi-factor algorithm
const d=data;
const curr=d.currency==='INR'?'₹':'$';
const price=d.current_price;
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f};
const pe=n(d.pe_ratio),fpe=n(d.forward_pe),pb=n(d.pb_ratio),pm=n(d.profit_margin),roe=n(d.roe);
const beta=n(d.beta)||1,dy=n(d.dividend_yield),hi=n(d.week52_high),lo=n(d.week52_low);
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;
const sma20=n(d.sma_20),sma50=n(d.sma_50),sma200=n(d.sma_200);
const epsGrowth=n(d.eps_growth_pct),revGrowth=n(d.revenue_growth),earningsGrowth=n(d.earnings_growth);
const sectorPE=n(d.sector_avg_pe)||20;
const pnl=((price-buyPrice)/buyPrice)*100;
let score=0;const factors=[];
// F2: Valuation
if(pe>0&&pe<12){score+=8;factors.push({f:'Deeply undervalued (P/E '+pe.toFixed(1)+'x)',s:'+8',c:'g'})}
else if(pe>0&&pe<18){score+=5;factors.push({f:'Fair value (P/E '+pe.toFixed(1)+'x)',s:'+5',c:'g'})}
else if(pe>0&&pe<28){score+=2;factors.push({f:'Reasonably priced (P/E '+pe.toFixed(1)+'x)',s:'+2',c:'b'})}
else if(pe>=28&&pe<50){score-=3;factors.push({f:'Expensive (P/E '+pe.toFixed(1)+'x)',s:'-3',c:'r'})}
else if(pe>=50){score-=6;factors.push({f:'Very expensive (P/E '+pe.toFixed(1)+'x)',s:'-6',c:'r'})}
// F3: 52W
if(w52pct<0.15){score+=6;factors.push({f:'Near 52W low ('+Math.round(w52pct*100)+'%)',s:'+6',c:'g'})}
else if(w52pct<0.35){score+=3;factors.push({f:'Lower range ('+Math.round(w52pct*100)+'%)',s:'+3',c:'g'})}
else if(w52pct>0.9){score-=4;factors.push({f:'Near 52W high ('+Math.round(w52pct*100)+'%)',s:'-4',c:'r'})}
else if(w52pct>0.75){score-=1;factors.push({f:'Upper range ('+Math.round(w52pct*100)+'%)',s:'-1',c:'a'})}
else{score+=1;factors.push({f:'Mid-range ('+Math.round(w52pct*100)+'%)',s:'+1',c:'b'})}
// F4: Margins
if(pm>20){score+=4;factors.push({f:'Strong margins ('+pm.toFixed(1)+'%)',s:'+4',c:'g'})}
else if(pm>10){score+=2;factors.push({f:'Decent margins ('+pm.toFixed(1)+'%)',s:'+2',c:'b'})}
else if(pm>0){factors.push({f:'Thin margins ('+pm.toFixed(1)+'%)',s:'0',c:'a'})}
else if(pm<0){score-=3;factors.push({f:'Negative margins ('+pm.toFixed(1)+'%)',s:'-3',c:'r'})}
// F5: ROE
if(roe>20){score+=3;factors.push({f:'Excellent ROE ('+roe.toFixed(1)+'%)',s:'+3',c:'g'})}
else if(roe>12){score+=1;factors.push({f:'Good ROE ('+roe.toFixed(1)+'%)',s:'+1',c:'b'})}
else if(roe<5&&roe>0){score-=2;factors.push({f:'Poor ROE ('+roe.toFixed(1)+'%)',s:'-2',c:'r'})}
// F6: Dividend
if(dy>4){score+=3;factors.push({f:'High yield ('+dy.toFixed(1)+'%)',s:'+3',c:'g'})}
else if(dy>2){score+=1;factors.push({f:'Moderate yield ('+dy.toFixed(1)+'%)',s:'+1',c:'b'})}
// F7: Beta
if(beta>1.5){score-=2;factors.push({f:'High volatility (β '+beta.toFixed(2)+')',s:'-2',c:'r'})}
else if(beta<0.8){score+=2;factors.push({f:'Low volatility (β '+beta.toFixed(2)+')',s:'+2',c:'g'})}
// F8: P&L
if(pnl>50){score-=2;factors.push({f:'Large gain '+pnl.toFixed(1)+'% — partial booking',s:'-2',c:'a'})}
else if(pnl>20){factors.push({f:'Healthy gain '+pnl.toFixed(1)+'%',s:'0',c:'g'})}
else if(pnl>0){score+=2;factors.push({f:'Small gain '+pnl.toFixed(1)+'%',s:'+2',c:'g'})}
else if(pnl>-10){score+=1;factors.push({f:'Minor loss '+pnl.toFixed(1)+'%',s:'+1',c:'b'})}
else if(pnl>-25){factors.push({f:'Loss '+pnl.toFixed(1)+'%',s:'0',c:'a'})}
else{score-=2;factors.push({f:'Deep loss '+pnl.toFixed(1)+'%',s:'-2',c:'r'})}
// F9: Earnings Velocity
const bestEpsG=epsGrowth||earningsGrowth;
const combGrowth=bestEpsG&&revGrowth?(bestEpsG*0.6+revGrowth*0.4):bestEpsG||revGrowth;
if(combGrowth>30){score+=5;factors.push({f:'Exceptional growth ('+combGrowth.toFixed(0)+'%)',s:'+5',c:'g'})}
else if(combGrowth>15){score+=3;factors.push({f:'Strong growth ('+combGrowth.toFixed(0)+'%)',s:'+3',c:'g'})}
else if(combGrowth>5){score+=1;factors.push({f:'Moderate growth ('+combGrowth.toFixed(0)+'%)',s:'+1',c:'b'})}
else if(combGrowth<=-5){score-=3;factors.push({f:'Earnings contracting ('+combGrowth.toFixed(0)+'%)',s:'-3',c:'r'})}
else if(combGrowth<0){score-=1;factors.push({f:'Slight decline ('+combGrowth.toFixed(0)+'%)',s:'-1',c:'a'})}
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=2;factors.push({f:'Forward PE compression — accelerating',s:'+2',c:'g'})}
else if(fpe>0&&pe>0&&fpe>pe*1.15){score-=1;factors.push({f:'Forward PE expansion — decelerating',s:'-1',c:'r'})}
// F10: Relative Valuation
if(pe>0&&sectorPE>0){const peR=pe/sectorPE;const disc=((sectorPE-pe)/sectorPE*100).toFixed(0);
if(peR<0.6){score+=5;factors.push({f:'P/E '+Math.abs(disc)+'% below sector',s:'+5',c:'g'})}
else if(peR<0.85){score+=3;factors.push({f:'P/E '+Math.abs(disc)+'% below sector',s:'+3',c:'g'})}
else if(peR<=1.15){score+=1;factors.push({f:'P/E in line with sector',s:'+1',c:'b'})}
else if(peR<=1.5){score-=2;factors.push({f:'P/E '+Math.abs(disc)+'% above sector',s:'-2',c:'a'})}
else{score-=4;factors.push({f:'P/E '+Math.abs(disc)+'% above sector',s:'-4',c:'r'})}}
// F11: Technical
let techScore=0;const techD=[];
if(sma20>0){if(price>sma20){techScore+=1;techD.push('Above SMA20')}else{techScore-=1;techD.push('Below SMA20')}}
if(sma200>0){if(price>sma200){techScore+=2;techD.push('Above SMA200 — uptrend')}else{techScore-=2;techD.push('Below SMA200 — downtrend')}}
if(sma20>0&&sma200>0){if(sma20>sma200){techScore+=2;techD.push('Golden Cross')}else if(sma20<sma200*0.95){techScore-=2;techD.push('Death Cross')}}
techScore=Math.max(-5,Math.min(5,techScore));score+=techScore;
if(techD.length>0){const tC=techScore>=3?'g':techScore>=1?'b':techScore<=-2?'r':'a';factors.push({f:'Technical: '+techD.join(', '),s:(techScore>=0?'+':'')+techScore,c:tC})}
// Decision
let decision,decCol,decBg,timeline,probability,reasoning,action;
if(score>=18){decision='STRONG HOLD';decCol='#10b981';decBg='rgba(16,185,129,.1)';timeline='12-24 months';probability=Math.min(95,78+Math.floor(score/2));
reasoning='Exceptional across all 11 factors. Serious compounding potential.';action=pnl<0?'Average down on any 5-10% dip.':'Hold entire position. Add on 10%+ corrections.'}
else if(score>=12){decision='HOLD & ACCUMULATE';decCol='#10b981';decBg='rgba(16,185,129,.08)';timeline='6-12 months';probability=Math.min(90,72+Math.floor(score/2));
reasoning='Strong fundamentals + positive momentum.';action=pnl<-15?'Accumulate to average down.':'Hold. Add on 5-8% pullbacks.'}
else if(score>=6){decision='HOLD';decCol='#22d3ee';decBg='rgba(6,182,212,.08)';timeline='6-12 months';probability=Math.min(82,64+score);
reasoning='Decent fundamentals. No urgency to act.';action=pnl>30?'Book 25-30% profits. Let rest ride.':'Hold and review after next quarter.'}
else if(score>=0){decision='HOLD WITH CAUTION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';timeline='3-6 months';probability=Math.min(72,56+score);
reasoning='Mixed signals. Watch for deterioration.';action=pnl>40?'Book 50% profits.':pnl<-20?'Set strict stop loss 10% below CMP.':'Monitor closely. Exit if earnings disappoint.'}
else if(score>=-5){decision='REDUCE POSITION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';timeline='0-3 months';probability=Math.min(65,55+Math.abs(score));
reasoning='Weak fundamentals. Risk-reward unfavorable.';action=pnl>20?'Book 50-70% profits now.':'Sell 50%. Set stop on remainder.'}
else{decision='EXIT / SELL';decCol='#ef4444';decBg='rgba(239,68,68,.08)';timeline='Immediately';probability=Math.min(80,60+Math.abs(score));
reasoning='Multiple red flags. Capital better deployed elsewhere.';action=pnl>0?'Book all profits.':'Cut losses now.'}
probability=Math.max(55,Math.min(95,probability));
const upside=score>=4?Math.max(5,Math.min(40,score*3)):0;
const t1=price*(1+upside/200),t2=price*(1+upside/100),sl=price*(score>=0?0.88:0.92);
// Render
let h=`<div style="position:relative;padding:14px;border-radius:10px;background:${decBg};border:1px solid ${decCol}25;overflow:hidden">`;
h+=`<div style="position:relative;z-index:2">`;
h+=`<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">
<div style="display:flex;align-items:center;gap:10px">
<span class="dec-badge" style="background:${decBg};border:2px solid ${decCol};color:${decCol}">${decision}</span>
<div><div style="font-size:9px;color:var(--text3)">Timeline</div><div style="font-size:13px;font-weight:700;color:var(--text)">${timeline}</div></div>
<div><div style="font-size:9px;color:var(--text3)">Probability</div><div style="font-size:13px;font-weight:700;color:${decCol}">${probability}%</div></div>
</div>
<div style="text-align:right">
<div style="font-size:10px;color:var(--text3)">P&L on ${d.company_name||ticker}</div>
<div style="font-size:16px;font-weight:800;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}${pnl.toFixed(1)}%</div>
<div style="font-size:10px;color:var(--text3)">${curr}${buyPrice.toLocaleString()} → ${curr}${price.toLocaleString()}</div>
</div></div>`;
h+=`<div class="dec-meter"><div class="dec-meter-fill" style="width:${probability}%;background:linear-gradient(90deg,${decCol}88,${decCol})"></div></div>`;
h+=`<div style="margin:8px 0;font-size:12px;color:var(--text2);line-height:1.5">${reasoning}</div>`;
h+=`<div style="padding:6px 10px;border-radius:6px;background:rgba(0,47,108,.04);border-left:3px solid ${decCol};margin-bottom:10px">
<div style="font-size:9px;font-weight:700;color:${decCol};margin-bottom:2px">▶ ACTION</div>
<div style="font-size:11px;color:var(--text)">${action}</div></div>`;
if(score>=0){h+=`<div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
<div style="flex:1;min-width:80px;padding:5px 8px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15)">
<div style="font-size:8px;color:var(--red);font-weight:700">STOP LOSS</div><div style="font-size:11px;font-weight:700;color:var(--red)">${curr}${sl.toFixed(0)}</div></div>
<div style="flex:1;min-width:80px;padding:5px 8px;border-radius:6px;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15)">
<div style="font-size:8px;color:var(--cyan);font-weight:700">3M TARGET</div><div style="font-size:11px;font-weight:700;color:var(--cyan)">${curr}${t1.toFixed(0)}</div></div>
<div style="flex:1;min-width:80px;padding:5px 8px;border-radius:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)">
<div style="font-size:8px;color:var(--green);font-weight:700">12M TARGET</div><div style="font-size:11px;font-weight:700;color:var(--green)">${curr}${t2.toFixed(0)}</div></div>
</div>`}
h+=`<div style="font-size:9px;font-weight:700;color:var(--text3);margin-bottom:4px">FACTORS (Score: ${score>=0?'+':''}${score})</div>`;
h+=`<div style="display:flex;flex-wrap:wrap;gap:3px">`;
factors.forEach(f=>{const fc=f.c==='g'?'var(--green)':f.c==='r'?'var(--red)':f.c==='a'?'var(--amber)':'var(--blue)';
const fbg=f.c==='g'?'rgba(16,185,129,.08)':f.c==='r'?'rgba(239,68,68,.08)':f.c==='a'?'rgba(245,158,11,.08)':'rgba(0,120,212,.08)';
h+=`<span style="font-size:8px;padding:2px 6px;border-radius:4px;background:${fbg};color:${fc}">[${f.s}] ${f.f}</span>`});
h+=`</div>`;
h+=`<div style="margin-top:6px;font-size:8px;color:var(--text3)">Algorithmic analysis, not financial advice. Consult your advisor.</div>`;
h+=`</div></div>`;
resEl.innerHTML=h;
}catch(e){resEl.innerHTML=`<div style="font-size:11px;color:var(--red)">Error: ${e.message}</div>`}
finally{btn.disabled=false;btn.textContent='⚡ Analyze Decision'}
}

async function loadTradeScorecard(){
const el=document.getElementById('scorecardArea');
const btn=document.getElementById('scorecardBtn');
if(!el)return;
const emailEl=document.getElementById('email');
const em=emailEl?(emailEl.dataset.real||emailEl.value).trim().toLowerCase():'';
btn.disabled=true;btn.textContent='Loading...';
el.style.display='block';
el.innerHTML='<div style="text-align:center;padding:20px;color:var(--text3)"><div class="spinner" style="width:20px;height:20px;border:2px solid var(--cyan);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 8px"></div>Fetching actual market data and validating trades...</div>';
try{
const res=await fetch(`/api/validate-trades?email=${encodeURIComponent(em)}`);
const data=await res.json();
if(!data.success){el.innerHTML=`<div style="color:var(--red);font-size:12px">${data.error||data.message||'Error loading scorecard'}</div>`;return}
if(!data.results||data.results.length===0){el.innerHTML=`<div style="padding:16px;border-radius:10px;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15);text-align:center"><div style="font-size:14px;font-weight:700;color:var(--cyan);margin-bottom:6px">&#128202; Trade Scorecard</div><div style="font-size:12px;color:var(--text2)">${data.message||'No completed trading days to validate yet. Trades will be scored after market close.'}</div></div>`;return}
const s=data.summary;
let h='';

// Summary dashboard
const wr=s.win_rate||0;
const wrCol=wr>=70?'var(--green)':wr>=50?'var(--amber)':'var(--red)';
h+=`<div style="padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(6,182,212,.08),rgba(16,185,129,.05));border:1px solid rgba(6,182,212,.2);margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:800;color:var(--cyan);margin-bottom:12px">&#128202; TRADE SCORECARD — ${s.days_tracked} Day${s.days_tracked>1?'s':''} Tracked</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:12px">
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:${wrCol}">${wr}%</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">WIN RATE</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--text)">${s.total_trades}</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">TOTAL TRADES</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--green)">${s.wins}</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">WINS</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--red)">${s.losses}</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">LOSSES</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--green)">${s.target_hit_rate}%</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">TARGET HIT</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--amber)">${s.avg_best_move}%</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">AVG BEST MOVE</div>
</div>
</div>

<div style="height:8px;border-radius:4px;background:rgba(0,47,108,.06);overflow:hidden;margin-bottom:6px">
<div style="height:100%;width:${wr}%;border-radius:4px;background:linear-gradient(90deg,var(--green),${wrCol});transition:width 1s"></div>
</div>
<div style="font-size:10px;color:var(--text3);display:flex;justify-content:space-between">
<span>Win Rate: ${s.wins}W / ${s.losses}L</span>
<span>Avg Close Move: ${s.avg_actual_move}%</span>
</div>
</div>`;

// Daily breakdown with chart-like bars
data.results.forEach(day=>{
const dayTrades=day.trades;
const dayWins=dayTrades.filter(t=>t.score>=0.5).length;
const dayTotal=dayTrades.length;
const dayWR=dayTotal?Math.round(dayWins/dayTotal*100):0;
const dayCol=dayWR>=70?'var(--green)':dayWR>=50?'var(--amber)':'var(--red)';

h+=`<div style="margin-bottom:12px;padding:12px;border-radius:10px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text)">${day.date}</span>
${day.is_expiry?'<span style="font-size:8px;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.1);color:var(--red);font-weight:700">EXPIRY</span>':''}
</div>
<span style="font-size:11px;font-weight:800;color:${dayCol}">${dayWR}% (${dayWins}/${dayTotal})</span>
</div>
<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">
<tr style="border-bottom:1px solid var(--border)">
<th style="padding:4px 6px;text-align:left;color:var(--text3);font-size:9px">TRADE</th>
<th style="padding:4px 6px;text-align:center;color:var(--text3);font-size:9px">DIR</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">ENTRY</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">TARGET</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">STOP</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">DAY HIGH</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">DAY LOW</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">CLOSE</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">P&L</th>
<th style="padding:4px 6px;text-align:center;color:var(--text3);font-size:9px">RESULT</th>
</tr>`;
dayTrades.forEach(t=>{
const oc=t.outcome==='TARGET HIT'?'var(--green)':t.outcome==='STOP HIT'?'var(--red)':t.outcome==='PARTIAL WIN'?'#22d3ee':'var(--amber)';
const obg=t.outcome==='TARGET HIT'?'rgba(16,185,129,.1)':t.outcome==='STOP HIT'?'rgba(239,68,68,.1)':'rgba(245,158,11,.06)';
h+=`<tr style="border-bottom:1px solid rgba(0,47,108,.03)">
<td style="padding:4px 6px;font-weight:600">${t.label}</td>
<td style="padding:4px 6px;text-align:center;color:${t.direction==='BULL'?'var(--green)':'var(--red)'};font-weight:700">${t.direction}</td>
<td style="padding:4px 6px;text-align:right;color:var(--blue)">${t.entry.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--green)">${t.target.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--red)">${t.stop.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--text2)">${t.day_high.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--text2)">${t.day_low.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;font-weight:600;color:var(--text)">${t.day_close.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;font-weight:700;color:${t.actual_move_pct>=0?'var(--green)':'var(--red)'}">${t.actual_move_pct>=0?'+':''}${t.actual_move_pct}%</td>
<td style="padding:4px 6px;text-align:center"><span style="font-size:8px;padding:2px 6px;border-radius:4px;background:${obg};color:${oc};font-weight:800">${t.outcome}</span></td>
</tr>`;
});
h+=`</table></div>`;

// Visual P&L bar chart for this day
h+=`<div style="display:flex;gap:3px;margin-top:6px;align-items:end;height:30px">`;
dayTrades.forEach(t=>{
const barH=Math.min(28,Math.max(4,Math.abs(t.actual_move_pct)*10));
const barC=t.actual_move_pct>=0?'var(--green)':'var(--red)';
h+=`<div style="flex:1;height:${barH}px;background:${barC};border-radius:2px;opacity:.7" title="${t.label}: ${t.actual_move_pct>0?'+':''}${t.actual_move_pct}%"></div>`;
});
h+=`</div>`;
h+=`</div>`;
});

h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">Validation compares suggested entry/target/stop levels against actual intraday highs, lows, and closing prices from Yahoo Finance. "TARGET HIT" = price reached target without hitting stop first. Past performance does not predict future results.</div>`;
el.innerHTML=h;
}catch(e){
el.innerHTML=`<div style="color:var(--red);font-size:12px">Error: ${e.message}</div>`;
}finally{
btn.disabled=false;btn.textContent='&#128202; Trade Scorecard';
}
}

// ═══════════════════════════════════════════════
// INDEX TRADES — AI-Powered Daily Ideas
// ═══════════════════════════════════════════════
async function loadIndexTrades(forceRefresh){
const el=document.getElementById('tradesContent');
const errEl=document.getElementById('tradesError');
const btn=document.getElementById('tradesLoadBtn');
// Get current email from the input
const emailInput=document.getElementById('email');
const email=emailInput?(emailInput.dataset.real||emailInput.value).trim():'';
if(!email){errEl.textContent='Please enter your email in the search bar above first.';errEl.style.display='block';return}
// Access check
btn.disabled=true;btn.textContent=forceRefresh?'⏳ Refreshing with live data...':'⏳ Analyzing markets...';errEl.style.display='none';
try{
const r=await fetch('/api/index-trades',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,force_refresh:!!forceRefresh})});
const data=await r.json();
if(!data.success){errEl.textContent=data.error||'Service busy. Please try again in a moment.';errEl.style.display='block';btn.disabled=false;btn.textContent='⚡ Generate Today\'s Trades';return}

// Render the trades
let html='';

// Market assessment — compact pill design
const ma=data.market_assessment||{};
if(ma.bias){
const biasCol=ma.bias.includes('BULL')?'var(--green)':ma.bias.includes('BEAR')?'var(--red)':'var(--amber)';
const biasBg=ma.bias.includes('BULL')?'rgba(16,185,129,.1)':ma.bias.includes('BEAR')?'rgba(239,68,68,.1)':'rgba(245,158,11,.08)';
const biasIcon=ma.bias.includes('BULL')?'&#128200;':ma.bias.includes('BEAR')?'&#128201;':'&#128260;';
const regimeCol=ma.regime==='TRENDING'?'var(--green)':ma.regime==='RANGE-BOUND'?'var(--amber)':'var(--blue)';
const edgeCol=ma.edge_clarity==='CLEAR'?'var(--green)':ma.edge_clarity==='MODERATE'?'var(--amber)':'var(--red)';
html+=`<div style="margin-bottom:14px;padding:14px 16px;border-radius:10px;background:${biasBg};border:1px solid ${biasCol}25">
<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:${ma.vix_signal||ma.global_impact?'10px':'0'}">
<div style="display:flex;align-items:center;gap:6px">
<span style="font-size:18px">${biasIcon}</span>
<span style="font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:${biasCol}">${ma.bias}</span>
</div>
<span style="font-size:10px;font-weight:700;color:${regimeCol};background:${regimeCol}12;border:1px solid ${regimeCol}25;padding:3px 10px;border-radius:10px">${ma.regime||'-'}</span>
<span style="font-size:10px;font-weight:700;color:${edgeCol};background:${edgeCol}12;border:1px solid ${edgeCol}25;padding:3px 10px;border-radius:10px">Edge: ${ma.edge_clarity||'-'}</span>
</div>
${ma.vix_signal||ma.global_impact?`<div style="font-size:11px;color:var(--text3);line-height:1.6">${ma.vix_signal?'<span style="color:var(--amber);font-weight:600">VIX</span> '+ma.vix_signal+(ma.global_impact?' · ':''):''}${ma.global_impact?'<span style="color:var(--blue);font-weight:600">Global</span> '+ma.global_impact:''}</div>`:''}
</div>`;
}

// Event alert loads on page load via DOMContentLoaded and refreshes on each Analyze click

// Market pulse header
html+=`<div style="border-radius:12px;background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(239,68,68,.05));border:1px solid rgba(245,158,11,.2);padding:16px 20px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">&#128200;</span>
<div><div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--amber)">Market Pulse — ${new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
<div style="font-size:11px;color:var(--text3);display:flex;align-items:center;gap:8px">Generated at ${data.generated_at?new Date(data.generated_at).toLocaleTimeString('en-IN'):new Date().toLocaleTimeString('en-IN')} IST <button onclick="loadIndexTrades(true)" style="font-size:10px;color:var(--blue);background:none;border:1px solid var(--blue);border-radius:6px;padding:2px 8px;cursor:pointer" title="Force fresh analysis with latest market data">&#8635; Refresh</button></div></div></div>
${data.market_context?'<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">'+data.market_context+'</p>':''}
</div>`;

// Expiry status badge
if(data.is_expiry_day){
html+=`<div style="padding:12px 16px;border-radius:8px;background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(245,158,11,.08));border:1px solid rgba(239,68,68,.3);margin-bottom:14px;display:flex;align-items:center;gap:10px">
<span style="font-size:22px;animation:pulse 1.5s infinite">&#128308;</span>
<div><div style="font-size:12px;font-weight:800;color:var(--red);letter-spacing:.5px">EXPIRY DAY — ${data.expiry_today}</div>
<div style="font-size:11px;color:var(--text3)">Theta decay accelerates after 1 PM · Gamma spikes in last 90 min · Hero Zero window: 1:30-2:30 PM IST</div></div></div>`;
}else{
html+=`<div style="padding:10px 16px;border-radius:8px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);margin-bottom:14px;display:flex;align-items:center;gap:10px">
<span style="font-size:18px">&#128197;</span>
<div style="font-size:12px;color:var(--text3)"><strong style="color:var(--blue)">${data.day_name||'Today'}</strong> — No expiry today. Next: <strong>Nifty</strong> expires Tuesday (NSE) · <strong>Sensex</strong> expires Thursday (BSE). Positional trades recommended.</div></div>`;
}

// Index snapshot
if(data.indices&&data.indices.length>0){
html+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:16px">`;
data.indices.forEach(idx=>{
const up=idx.change>=0;
const col=up?'var(--green)':'var(--red)';
html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(${up?'16,185,129':'239,68,68'},.06);border:1px solid rgba(${up?'16,185,129':'239,68,68'},.15)">
<div style="font-size:11px;color:var(--text3);font-weight:600;letter-spacing:.5px">${idx.name}</div>
<div style="font-size:18px;font-weight:800;color:${col}">${idx.price?idx.price.toLocaleString('en-IN'):'-'}</div>
<div style="font-size:12px;color:${col}">${up?'▲':'▼'} ${Math.abs(idx.change||0).toFixed(2)} (${(idx.change_pct||0).toFixed(2)}%)</div>
</div>`;
});
html+=`</div>`;
}

// Trades table — ranked by probability, with time planner and gut picks
// Collect ALL trades for time-ordered planner
const allTrades=[];

if(data.trades&&data.trades.length>0){
const sorted=[...data.trades].sort((a,b)=>(parseInt(b.probability)||80)-(parseInt(a.probability)||80));
html+=`<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--amber);margin-bottom:10px;letter-spacing:.3px">&#127919; INDEX TRADES — Ranked by Probability</div>`;
sorted.forEach((t,i)=>{
const up=(t.direction||'').toUpperCase().includes('BULL');
const col=up?'var(--green)':'var(--red)';
const bg=up?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)';
const bdr=up?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)';
const prob=parseInt(t.probability)||80;
const pCol=prob>=90?'var(--green)':prob>=85?'#22d3ee':'var(--amber)';
allTrades.push({...t,_type:'INDEX',_rank:t.rank||i+1,_prob:prob,_inst:t.index+' '+(t.bias||t.direction||'')});
html+=`<div style="border-left:4px solid ${bdr};border-radius:10px;padding:16px;margin-bottom:12px;background:${bg};border:1px solid ${bdr}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;background:${col};color:#fff;padding:2px 8px;border-radius:4px;font-weight:800">#${t.rank||i+1}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.index||'-'}</span>
<span style="font-size:12px;font-weight:700;color:${col};background:${bg};border:1px solid ${bdr};padding:2px 8px;border-radius:4px">${(t.direction||'').toUpperCase()}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
${t.probability?`<span style="font-size:11px;font-weight:800;color:#fff;background:${pCol};padding:2px 8px;border-radius:4px">${t.probability}</span>`:''}
</div>
</div>
${t.factors_aligned?`<div style="font-size:11px;color:var(--text3);margin-bottom:8px;padding:4px 8px;border-radius:4px;background:rgba(0,47,108,.03)">&#9989; <strong style="color:var(--green)">Factors:</strong> ${t.factors_aligned}</div>`:''}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">ENTRY LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${t.entry_level||t.entry||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TARGET ${t.move_pct?'<span style="color:var(--green);font-weight:800">('+t.move_pct+')</span>':''}</div><div style="font-size:14px;font-weight:700;color:var(--green)">${t.target_level||t.target||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">STOP LOSS</div><div style="font-size:14px;font-weight:700;color:var(--red)">${t.stop_level||t.stop_loss||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">MOVE</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${t.move_points||t.risk_reward||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">R:R</div><div style="font-size:14px;font-weight:700;color:var(--amber)">${t.risk_reward||'-'}</div></div>
</div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(0,120,212,.12);border:1px solid rgba(59,130,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:.8px">&#9654; WHEN TO ENTER</span><br><span style="font-size:14px;font-weight:800;color:var(--text)">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.8px">&#9200; BEST TIME</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
${t.key_levels?`<div style="margin-bottom:8px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.12);font-size:11px"><strong style="color:var(--purple)">&#128200; Key Levels:</strong> <span style="color:var(--text2)">${t.key_levels}</span></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; KILL IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// Stock trades
if(data.stock_trades&&data.stock_trades.length>0){
const sorted=[...data.stock_trades].sort((a,b)=>(parseInt(b.probability)||80)-(parseInt(a.probability)||80));
html+=`<div style="margin-top:20px;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--purple);margin-bottom:10px">&#128640; STOCK PICKS — Ranked by Probability</div>`;
sorted.forEach((t,i)=>{
const up=(t.direction||'').toUpperCase().includes('BULL');
const col=up?'var(--green)':'var(--red)';
const bg=up?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)';
const bdr=up?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)';
const prob=parseInt(t.probability)||80;
const pCol=prob>=90?'var(--green)':prob>=85?'#22d3ee':'var(--amber)';
allTrades.push({...t,_type:'STOCK',_rank:t.rank||'S'+(i+1),_prob:prob,_inst:(t.stock||'')+(t.bias?' '+t.bias:'')});
html+=`<div style="border-left:4px solid rgba(139,92,246,.3);border-radius:10px;padding:16px;margin-bottom:12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15)">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;background:var(--purple);color:#fff;padding:2px 8px;border-radius:4px;font-weight:800">${t.rank||'S'+(i+1)}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.stock||'-'}</span>
<span style="font-size:12px;font-weight:700;color:${col};background:${bg};border:1px solid ${bdr};padding:2px 8px;border-radius:4px">${(t.direction||'').toUpperCase()}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
${t.probability?`<span style="font-size:11px;font-weight:800;color:#fff;background:${pCol};padding:2px 8px;border-radius:4px">${t.probability}</span>`:''}
</div>
</div>
${t.factors_aligned?`<div style="font-size:11px;color:var(--text3);margin-bottom:8px;padding:4px 8px;border-radius:4px;background:rgba(0,47,108,.03)">&#9989; <strong style="color:var(--green)">Factors:</strong> ${t.factors_aligned}</div>`:''}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">ENTRY LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">₹${t.entry_level||t.entry||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TARGET ${t.move_pct?'<span style="color:var(--green);font-weight:800">('+t.move_pct+')</span>':''}</div><div style="font-size:14px;font-weight:700;color:var(--green)">₹${t.target_level||t.target||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">STOP LOSS</div><div style="font-size:14px;font-weight:700;color:var(--red)">₹${t.stop_level||t.stop_loss||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">R:R</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${t.risk_reward||'-'}</div></div>
</div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--purple);letter-spacing:.8px">&#9654; WHEN TO ENTER</span><br><span style="font-size:14px;font-weight:800;color:var(--text)">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.8px">&#9200; BEST TIME</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
${t.key_levels?`<div style="margin-bottom:8px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.12);font-size:11px"><strong style="color:var(--purple)">&#128200; Key Levels:</strong> <span style="color:var(--text2)">${t.key_levels}</span></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; KILL IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// VIX indicator
if(data.vix){
const vix=data.vix;
const vC=vix.price>18?'var(--red)':vix.price>14?'var(--amber)':'var(--green)';
const vBg=vix.price>18?'rgba(239,68,68,.08)':vix.price>14?'rgba(245,158,11,.08)':'rgba(16,185,129,.08)';
const vAdv=vix.price>20?'HIGH FEAR — Reduce sizes to 50%.':vix.price>16?'ELEVATED — Standard sizing. Stay alert.':'LOW — Full sizing. Trends likely.';
const vP=Math.min(((vix.price-8)/(30-8))*100,100);
html+=`<div style="margin-top:16px;padding:14px;border-radius:10px;background:${vBg};border:1px solid ${vC}30">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px">
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:${vC}">INDIA VIX: ${vix.price} ${vix.change>=0?'▲':'▼'} ${Math.abs(vix.change||0).toFixed(2)} (${(vix.change_pct||0).toFixed(2)}%)</span>
<span style="font-size:11px;color:var(--text3)">${vAdv}</span></div>
<div style="width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,.1);overflow:hidden"><div style="width:${vP}%;height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red))"></div></div>
<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:4px"><span>8 (Calm)</span><span>15</span><span>20</span><span>30+ (Panic)</span></div></div>`;
}

// Hero Zero
if(data.hero_zero&&data.hero_zero.length>0){
html+=`<div style="margin-top:20px;margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--red);letter-spacing:.3px;margin-bottom:4px">&#128165; HERO ZERO — Expiry Day Lottery</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:12px">Deep OTM, ₹2-15 premium. All-or-nothing for 3x-10x. Max 1-2% capital. Today's expiry ONLY.</div></div>`;
data.hero_zero.forEach((t,i)=>{
allTrades.push({...t,_type:'HERO ZERO',_rank:'H'+(i+1),_prob:0,_inst:(t.index||'')+' '+(t.bias||'Deep OTM')});
html+=`<div style="border-left:4px solid rgba(239,68,68,.5);border-radius:10px;padding:16px;margin-bottom:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.2)">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;background:var(--red);color:#fff;padding:2px 8px;border-radius:4px;font-weight:800;animation:pulse 2s infinite">&#128165;H${i+1}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.index||'-'} ${t.direction||''}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
<span style="font-size:10px;font-weight:800;color:var(--red);background:rgba(239,68,68,.15);padding:2px 8px;border-radius:4px">SPECULATIVE</span></div></div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TRIGGER LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${t.trigger_level||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">EXPECTED MOVE</div><div style="font-size:14px;font-weight:700;color:var(--green)">${t.target_move||'3x-10x'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">RISK</div><div style="font-size:14px;font-weight:700;color:var(--red)">Full premium loss</div></div></div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(0,120,212,.12);border:1px solid rgba(59,130,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:.8px">&#9654; TRIGGER CONDITION</span><br><span style="font-size:14px;font-weight:800;color:var(--text)">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--red);letter-spacing:.8px">&#9200; TIMING IS EVERYTHING</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; ZERO IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// ═══ TIME-ORDERED DAY PLANNER ═══
if(allTrades.length>0){
const timeSorted=[...allTrades].sort((a,b)=>{
const ta=parseInt(a.time_sort)||9999;
const tb=parseInt(b.time_sort)||9999;
return ta-tb;
});
const gb=data.gamma_blast||{};
const hasGamma=data.is_expiry_day&&gb.probability&&parseInt(gb.probability)>0;
html+=`<div style="margin-top:24px;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.04));border:1px solid rgba(59,130,246,.15)">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--blue);margin-bottom:4px">&#128197; YOUR TRADING DAY PLAN (IST)</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:12px">All trades sorted by execution time — follow this order through the day</div>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<thead><tr style="border-bottom:2px solid rgba(0,120,212,.25)">
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TIME</th>
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">RANK</th>
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">INSTRUMENT</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">DIR</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">ENTRY</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TRIGGER</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TARGET</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">SL</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">PROB</th>
${hasGamma?'<th style="padding:8px 6px;text-align:center;color:var(--red);font-weight:700;font-size:10px;letter-spacing:.5px">GAMMA</th>':''}
</tr></thead><tbody>`;
timeSorted.forEach((t,i)=>{
const dir=(t.direction||'').toUpperCase();
const dCol=dir.includes('BULL')?'var(--green)':'var(--red)';
const tBg=i%2===0?'rgba(255,255,255,.01)':'rgba(0,47,108,.03)';
const typeCol=t._type==='INDEX'?'var(--amber)':t._type==='STOCK'?'var(--purple)':'var(--red)';
const ts=t.time_sort||'--';
const timeStr=ts.length===4?ts.substring(0,2)+':'+ts.substring(2):ts;
// Gamma blast applies to INDEX trades in the 1:30-3:15 PM window on expiry
const gbApplies=hasGamma&&t._type==='INDEX'&&parseInt(ts)>=1330&&parseInt(ts)<=1515;
const gbProb=gbApplies?parseInt(gb.probability):0;
const gbCol=gbProb>=60?'var(--red)':gbProb>=40?'var(--amber)':'var(--blue)';
html+=`<tr style="background:${tBg};border-bottom:1px solid rgba(0,47,108,.04)">
<td style="padding:8px 6px;font-weight:700;color:var(--amber)">${timeStr}</td>
<td style="padding:8px 6px"><span style="font-size:10px;background:${typeCol};color:#fff;padding:1px 6px;border-radius:3px;font-weight:800">${t._rank}</span></td>
<td style="padding:8px 6px;font-weight:600;color:var(--text)">${t._inst||'-'}</td>
<td style="padding:8px 6px;text-align:center;font-weight:700;color:${dCol}">${dir}</td>
<td style="padding:8px 6px;text-align:right;color:var(--blue)">${t.entry_level||t.entry||'-'}</td>
<td style="padding:8px 6px;text-align:center;font-size:11px;color:var(--text2)">${t.entry_condition||'-'}</td>
<td style="padding:8px 6px;text-align:right;color:var(--green)">${t.move_pct||t.target_pct||'-'}</td>
<td style="padding:8px 6px;text-align:right;color:var(--red)">${t.stop_level||t.stop_loss||'-'}</td>
<td style="padding:8px 6px;text-align:center"><span style="font-weight:800;color:${parseInt(t.probability)>=85?'var(--green)':'var(--amber)'}">${t.probability||'-'}</span></td>
${hasGamma?`<td style="padding:8px 6px;text-align:center">${gbApplies?`<span style="font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;background:${gbCol}15;color:${gbCol};white-space:nowrap">${gb.probability} ${gb.direction||''}</span>`:'<span style="font-size:9px;color:var(--text3)">—</span>'}</td>`:''}
</tr>`;
});
html+=`</tbody></table></div>`;
// Gamma blast footer on expiry — compact summary below table
if(hasGamma){
const gbProb=parseInt(gb.probability)||0;
const gbCol=gbProb>=60?'var(--red)':gbProb>=40?'var(--amber)':'var(--blue)';
html+=`<div style="margin-top:10px;padding:8px 12px;border-radius:6px;background:${gbCol}08;border:1px solid ${gbCol}20;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
<span style="font-size:10px;font-weight:800;color:${gbCol}">&#9889; GAMMA BLAST ${gb.probability}</span>
<span style="font-size:10px;color:var(--text3)">Trigger: <strong style="color:var(--amber)">${gb.trigger_zone||'-'}</strong></span>
<span style="font-size:10px;color:var(--text3)">Move: <strong style="color:var(--text)">${gb.expected_move||'-'}</strong></span>
<span style="font-size:10px;color:var(--text3)">Window: <strong style="color:var(--text)">${gb.timing||'1:30-3:00 PM'}</strong></span>
${gb.best_play?`<span style="font-size:10px;color:var(--green);font-weight:600">&#127919; ${gb.best_play}</span>`:''}
</div>`;
}
html+=`</div>`;
}

// ═══ GUT PICKS — TOP 2 HIGHEST CONVICTION ═══
if(data.gut_picks&&data.gut_picks.length>0){
html+=`<div style="margin-top:24px;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(245,158,11,.06));border:2px solid rgba(16,185,129,.25)">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
<span style="font-size:24px">&#129504;</span>
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--green);letter-spacing:.3px">TOP GUT PICKS — Highest Conviction Trades</div>
</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:14px">If you could only take 2 trades today, take THESE. Maximum data confluence.</div>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<thead><tr style="border-bottom:2px solid rgba(16,185,129,.3)">
<th style="padding:8px 6px;text-align:left;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">PICK</th>
<th style="padding:8px 6px;text-align:left;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">INSTRUMENT</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">DIR</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">ENTRY</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TRIGGER</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TIME</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TARGET</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">SL</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">PROB</th>
</tr></thead><tbody>`;
data.gut_picks.forEach((g,i)=>{
const dir=(g.direction||'').toUpperCase();
const dCol=dir.includes('BULL')?'var(--green)':'var(--red)';
html+=`<tr style="background:rgba(16,185,129,.04);border-bottom:1px solid rgba(16,185,129,.1)">
<td style="padding:10px 6px"><span style="font-size:11px;background:var(--green);color:#000;padding:2px 8px;border-radius:4px;font-weight:900">&#127942; #${i+1}</span></td>
<td style="padding:10px 6px;font-weight:700;color:var(--text)">${g.index_or_stock||g.instrument||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-weight:700;color:${dCol}">${dir}</td>
<td style="padding:10px 6px;text-align:right;color:var(--blue);font-weight:700">${g.entry_level||g.entry||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-size:11px;font-weight:700;color:var(--text)">${g.entry_condition||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-weight:700;color:var(--amber)">${g.timing||'-'}</td>
<td style="padding:10px 6px;text-align:right;font-weight:800;color:var(--green)">${g.target_level||g.move_pct||'-'}</td>
<td style="padding:10px 6px;text-align:right;font-weight:700;color:var(--red)">${g.stop_level||g.stop_loss||'-'}</td>
<td style="padding:10px 6px;text-align:center"><span style="font-weight:900;color:var(--green);font-size:13px">${g.probability||'-'}</span></td>
</tr>
<tr style="background:rgba(16,185,129,.02)">
<td colspan="9" style="padding:6px 6px 10px 40px;font-size:11px;color:var(--text2);line-height:1.5">&#128161; <strong style="color:var(--amber)">Why this one:</strong> ${g.why_this_one||'-'}</td>
</tr>`;
});
html+=`</tbody></table></div></div>`;
}

// Skipped trades honesty note
if(data.skipped_trades&&!data.skipped_trades.includes('All')){
html+=`<div style="margin-top:12px;padding:12px 16px;border-radius:8px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);display:flex;align-items:flex-start;gap:10px">
<span style="font-size:18px">&#9888;&#65039;</span>
<div><div style="font-size:11px;font-weight:800;color:var(--amber);letter-spacing:.5px;margin-bottom:4px">HONEST NOTE</div>
<div style="font-size:12px;color:var(--text2);line-height:1.6">${data.skipped_trades}</div></div></div>`;
}

el.innerHTML=html;
}catch(e){
errEl.textContent='Service busy. Please try again in a moment.';errEl.style.display='block';
btn.disabled=false;btn.textContent='⚡ Generate Today\'s Trades';
}}

function vote(feature,dir,btn){
if(typeof gtag==='function')gtag('event','feature_vote',{feature_name:feature,vote_direction:dir>0?'up':'down'});
// Prevent double-voting same direction on same feature
const voteKey=feature+(dir>0?'up':'dn');
const oppKey=feature+(dir>0?'dn':'up');
if(userVotes[voteKey])return;

// If they voted opposite before, undo it
if(userVotes[oppKey]){
const oppDir=dir>0?-1:1;
votes[feature][oppDir>0?'up':'dn']--;
const oppBtn=btn.parentElement.querySelector(dir>0?'.dn':'.up');
oppBtn.classList.remove('voted');
delete userVotes[oppKey];
}

// Record vote
if(dir>0)votes[feature].up++;
else votes[feature].dn++;
userVotes[voteKey]=true;
btn.classList.add('voted');

// Update counters
document.getElementById(feature+'-up').textContent=votes[feature].up;
document.getElementById(feature+'-dn').textContent=votes[feature].dn;

// Update bar
const total=votes[feature].up+votes[feature].dn;
const pct=total>0?Math.round((votes[feature].up/total)*100):0;
document.getElementById(feature+'-bar').style.width=pct+'%';

// Update chart
updateVoteChart();

// Send to backend
fetch('/api/vote',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({feature:feature,direction:dir})}).catch(()=>{});
}

function updateVoteChart(){
if(!voteChart)return;
voteChart.data.datasets[0].data=featureKeys.map(k=>votes[k].up);
voteChart.data.datasets[1].data=featureKeys.map(k=>-votes[k].dn);
voteChart.update('none');
}

function initVoteChart(){
const ctx=document.getElementById('voteChart');
if(!ctx)return;
voteChart=new Chart(ctx,{
type:'bar',
data:{
labels:featureNames,
datasets:[
{label:'Want It',data:featureKeys.map(k=>votes[k].up),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4,barPercentage:.6},
{label:'Not Needed',data:featureKeys.map(k=>-votes[k].dn),backgroundColor:'rgba(239,68,68,0.5)',borderRadius:4,barPercentage:.6}
]
},
options:{
indexAxis:'y',
responsive:true,
maintainAspectRatio:false,
scales:{
x:{stacked:true,grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#64748b',font:{size:10},callback:v=>Math.abs(v)},border:{display:false}},
y:{stacked:true,grid:{display:false},ticks:{color:'#e2e8f0',font:{family:"'DM Sans',sans-serif",size:11,weight:'600'}},border:{display:false}}
},
plugins:{
legend:{labels:{color:'#94a3b8',font:{size:10},usePointStyle:true,pointStyle:'rectRounded'}},
tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+Math.abs(ctx.raw)}}
}
}
});
}

function loadVotes(){
fetch('/api/votes').then(r=>r.json()).then(data=>{
if(data&&data.votes){
featureKeys.forEach(k=>{
if(data.votes[k]){
votes[k].up=data.votes[k].up||0;
votes[k].dn=data.votes[k].dn||0;
document.getElementById(k+'-up').textContent=votes[k].up;
document.getElementById(k+'-dn').textContent=votes[k].dn;
const total=votes[k].up+votes[k].dn;
const pct=total>0?Math.round((votes[k].up/total)*100):0;
document.getElementById(k+'-bar').style.width=pct+'%';
}
});
updateVoteChart();
}
}).catch(()=>{});
}

function sendVoteResults(){
let body='CELESYS AI - Feature Vote Results\n\n';
const sorted=featureKeys.map((k,i)=>({key:k,name:featureNames[i],up:votes[k].up,dn:votes[k].dn,net:votes[k].up-votes[k].dn})).sort((a,b)=>b.net-a.net);
sorted.forEach((f,i)=>{
body+=(i+1)+'. '+f.name+' | Upvotes: '+f.up+' | Downvotes: '+f.dn+' | Net: '+f.net+'\n';
});
body+='\nTotal votes cast: '+featureKeys.reduce((s,k)=>s+votes[k].up+votes[k].dn,0);
body+='\nTimestamp: '+new Date().toISOString();
const mailto='mailto:contact@celesys.ai?subject='+encodeURIComponent('Feature Vote Results - '+new Date().toLocaleDateString())+'&body='+encodeURIComponent(body);
window.open(mailto);
}

// Initialize vote chart on page load
async function loadGlobalTicker(){
try{
const r=await fetch('/api/global-ticker');
const d=await r.json();
if(!d.success||!d.indices||!d.indices.length)return;
const track=document.getElementById('tickerTrack');
if(!track)return;
let items='';
d.indices.forEach(idx=>{
const up=idx.change_pct>0;
const flat=idx.change_pct===0;
const cls=flat?'fl':up?'up':'dn';
const arrow=flat?'':up?'▲':'▼';
const fmt=idx.name==='GSR'?idx.price:idx.price>=1000?idx.price.toLocaleString('en-IN'):idx.price;
items+=`<div class="ti"><span style="font-size:12px">${idx.flag}</span><span class="tn">${idx.name}</span><span class="tp">${fmt}</span><span class="tc ${cls}">${arrow}${Math.abs(idx.change_pct).toFixed(2)}%</span></div>`;
});
// Add "Last Updated" marker
const updTime=d.updated_at||new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
items+=`<div class="ti" style="opacity:.5"><span style="font-size:10px">🔄</span><span class="tn" style="color:var(--text3)">Updated</span><span class="tp" style="font-size:10px;color:var(--text3)">${updTime}</span></div>`;
// Duplicate for seamless infinite scroll
track.innerHTML=items+items;
}catch(e){console.log('Ticker load failed:',e)}
}

// ═══ AUTO-REFRESH: Ticker every 2 min, Market Pulse every 2 min ═══
setInterval(()=>{loadGlobalTicker()},120000);
setInterval(()=>{fetchMarketPulse()},120000);

document.addEventListener('DOMContentLoaded',()=>{loadGlobalTicker();setTimeout(()=>fetchMarketPulse(),3000);initVoteChart();loadVotes();
fetch('/api/stats').then(r=>r.json()).then(d=>{
if(d.total_reports){document.getElementById('navRC').textContent=d.total_reports;document.getElementById('globalRC').textContent=d.total_reports.toLocaleString();const hb=document.getElementById('reportBadgeCount');if(hb)hb.textContent=d.total_reports.toLocaleString()}
}).catch(()=>{})});

// Back-to-top button visibility + sticky tagline
window.addEventListener('scroll',()=>{
const btt=document.getElementById('bttBtn');
if(btt){if(window.scrollY>600)btt.classList.add('show');else btt.classList.remove('show')}
},{ passive: true });
// Sticky tagline — appears when hero scrolls out of view
const heroEl=document.querySelector('.hero');
const sTag=document.getElementById('stickyTag');
if(heroEl&&sTag){
const obs=new IntersectionObserver(([e])=>{
if(e.isIntersecting)sTag.classList.remove('vis');
else sTag.classList.add('vis');
},{threshold:0.1});
obs.observe(heroEl);
}
</script>

<!-- FLOATING FEEDBACK BUTTON -->
<button class="fab" onclick="document.getElementById('fpanel').classList.add('open');document.getElementById('fpbk').classList.add('open')">
<div class="pulse"></div> &#128227; Shape Our Roadmap! <span style="background:#ef4444;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;font-weight:800;animation:notifPop 2s ease-in-out infinite">NEW</span>
</button>

<!-- BACKDROP -->
<div class="fpbk" id="fpbk" onclick="document.getElementById('fpanel').classList.remove('open');this.classList.remove('open')"></div>

<!-- SLIDE PANEL -->
<div class="fpanel" id="fpanel">
<div class="fphdr">
<h3>&#128640; What Should We Build Next?</h3>
<button class="fpclose" onclick="document.getElementById('fpanel').classList.remove('open');document.getElementById('fpbk').classList.remove('open')">&times;</button>
</div>
<div class="fpbody">
<p class="sub">You just got a free analysis worth $50+. Now imagine what happens when we add <em>these</em>. Your vote decides what ships first.</p>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128196;</div><div class="pfinfo"><div class="pfname">PDF Export <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">Download your full report as a branded PDF. Save it, print it, share it.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('pdf',1,this)">&#9650; Want it <span class="cnt" id="pdf-up">0</span></button><button class="pvbtn dn" onclick="vote('pdf',-1,this)">&#9660; Skip <span class="cnt" id="pdf-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="pdf-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#9878;&#65039;</div><div class="pfinfo"><div class="pfname">Compare 2 Stocks <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">Side-by-side showdown. Which stock wins on every single metric?</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('cmp',1,this)">&#9650; Want it <span class="cnt" id="cmp-up">0</span></button><button class="pvbtn dn" onclick="vote('cmp',-1,this)">&#9660; Skip <span class="cnt" id="cmp-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="cmp-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128172;</div><div class="pfinfo"><div class="pfname">WhatsApp &amp; Email Share <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">One tap to share your analysis with friends, family, or your broker.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('share',1,this)">&#9650; Want it <span class="cnt" id="share-up">0</span></button><button class="pvbtn dn" onclick="vote('share',-1,this)">&#9660; Skip <span class="cnt" id="share-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="share-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128200;</div><div class="pfinfo"><div class="pfname">Technical Indicators <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">RSI, MACD, Moving Averages &mdash; the tools serious traders use daily.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('tech',1,this)">&#9650; Want it <span class="cnt" id="tech-up">0</span></button><button class="pvbtn dn" onclick="vote('tech',-1,this)">&#9660; Skip <span class="cnt" id="tech-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="tech-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#127919;</div><div class="pfinfo"><div class="pfname">Peer Comparison <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">Auto-compare vs top 3 competitors in the same sector. Who really wins?</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('peer',1,this)">&#9650; Want it <span class="cnt" id="peer-up">0</span></button><button class="pvbtn dn" onclick="vote('peer',-1,this)">&#9660; Skip <span class="cnt" id="peer-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="peer-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128197;</div><div class="pfinfo"><div class="pfname">Earnings Countdown <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">Next earnings date + analyst expectations. Never get blindsided again.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('earn',1,this)">&#9650; Want it <span class="cnt" id="earn-up">0</span></button><button class="pvbtn dn" onclick="vote('earn',-1,this)">&#9660; Skip <span class="cnt" id="earn-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="earn-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128100;</div><div class="pfinfo"><div class="pfname">Insider Activity <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">Are executives buying or selling their own stock? Follow the smart money.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('insider',1,this)">&#9650; Want it <span class="cnt" id="insider-up">0</span></button><button class="pvbtn dn" onclick="vote('insider',-1,this)">&#9660; Skip <span class="cnt" id="insider-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="insider-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#127763;</div><div class="pfinfo"><div class="pfname">Dark / Light Theme <span class="ftag live">&#9989; LIVE</span></div><div class="pfdesc">Switch between dark terminal mode and clean light mode instantly.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('theme',1,this)">&#9650; Want it <span class="cnt" id="theme-up">0</span></button><button class="pvbtn dn" onclick="vote('theme',-1,this)">&#9660; Skip <span class="cnt" id="theme-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="theme-bar" style="width:0%"></div></div></div>

<!-- LIVE VOTE CHART -->
<div class="vgp">
<h4>&#128202; Live Community Votes</h4>
<div class="vsub">Real-time ranking &mdash; updated as you vote</div>
<div class="cc"><canvas id="voteChart"></canvas></div></div>

</div><!-- end fpbody -->
</div><!-- end fpanel -->

<!-- STICKY EDUCATION DISCLAIMER BAR — visible site-wide -->
<div class="edu-bar">
<div class="edu-title">&#9888; READ THIS BEFORE YOU TRADE</div>
<div class="edu-lines">
<div class="edu-line"><strong>NOT FINANCIAL ADVICE:</strong> This tool is <b style="color:var(--amber)">for education only</b>. Not a replacement for licensed financial advisors. <b style="color:var(--amber)">Consult your financial advisor</b> before making any decisions. Never invest money you cannot afford to lose.</div>
<div class="edu-line"><strong>DATA MAY BE DELAYED:</strong> Market data from third-party providers may be delayed or incomplete. Always cross-check with your broker.</div>
<div class="edu-line"><strong>YOU CAN LOSE MONEY:</strong> All investments carry real risk. Past performance never guarantees future results. No affiliation with any brokerage.</div>
</div>
</div>

<script>
// ═══ PWA: Service Worker Registration ═══
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js').then(r=>{
      console.log('SW registered, scope:',r.scope);
    }).catch(e=>console.warn('SW registration failed:',e));
  });
}

// ═══ PWA: Install Prompt ═══
let _deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  _deferredPrompt=e;
  // Show install banner after 30s if user hasn't installed
  setTimeout(()=>{
    if(!_deferredPrompt)return;
    const b=document.createElement('div');
    b.id='pwaInstallBanner';
    b.style.cssText='position:fixed;bottom:0;left:0;right:0;z-index:9999;background:#003366;color:white;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 -4px 20px rgba(0,0,0,.3);font-family:Sora,sans-serif';
    b.innerHTML=`
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700">Install Celesys AI</div>
        <div style="font-size:11px;opacity:.8;margin-top:2px">Get instant access from your home screen</div>
      </div>
      <button onclick="pwaInstall()" style="padding:8px 18px;border-radius:8px;border:none;background:#4dabf7;color:#0087d2;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap;font-family:Sora,sans-serif">Install App</button>
      <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,.6);font-size:18px;cursor:pointer;padding:4px 8px">&times;</button>`;
    document.body.appendChild(b);
  },30000);
});

function pwaInstall(){
  if(!_deferredPrompt)return;
  _deferredPrompt.prompt();
  _deferredPrompt.userChoice.then(r=>{
    console.log('PWA install:',r.outcome);
    _deferredPrompt=null;
    const ban=document.getElementById('pwaInstallBanner');
    if(ban)ban.remove();
  });
}

window.addEventListener('appinstalled',()=>{
  console.log('PWA installed');
  _deferredPrompt=null;
  const ban=document.getElementById('pwaInstallBanner');
  if(ban)ban.remove();
});
</script>
</body>
</html>
