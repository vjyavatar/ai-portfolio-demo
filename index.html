<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Analytics 4 — Replace G-WW55EQ7ZB8 with your Measurement ID -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WW55EQ7ZB8"></script>
<script>
window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-WW55EQ7ZB8');
</script>

<!-- Google AdSense — Replace ca-pub-2084524493538975 with your publisher ID after approval -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2084524493538975" crossorigin="anonymous"></script>
<title>Celesys AI — Free Real-Time Stock Analysis in 60 Seconds</title>
<meta name="description" content="Wall Street intelligence for your wallet. Institutional-grade stock analysis with precision entry/exit targets, risk profiling, earnings alpha, insider sentiment and mutual fund holdings — in 60 seconds.">
<meta name="keywords" content="stock analysis, AI stock research, free stock analysis, real-time stock data, stock valuation, entry exit strategy, stop loss calculator, PE ratio checker, stock risk assessment, small cap stocks, Indian stocks NSE BSE, US stocks NYSE NASDAQ, investment research, stock screener, AI investment tool, portfolio analysis, stock recommendation, market intelligence, celesys, celesys ai">
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">
<meta name="author" content="Celesys AI">
<meta name="google-site-verification" content="googleb6e1e80f88761fcc">
<meta name="google-adsense-account" content="ca-pub-2084524493538975">
<link rel="canonical" href="https://celesys.ai">

<!-- Open Graph / Social Sharing -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://celesys.ai">
<meta property="og:title" content="Celesys AI — Free AI Stock Analysis in 60 Seconds">
<meta property="og:description" content="Get professional-grade stock analysis in 60 seconds. Real-time data, AI valuation, exact buy/sell prices, risk scoring, and hidden small-cap picks. Completely free.">
<meta property="og:site_name" content="Celesys AI">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://celesys.ai/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Celesys AI — Free AI Stock Analysis in 60 Seconds">
<meta name="twitter:description" content="Stop guessing. Get AI-powered stock analysis with real-time data, exact entry/exit prices, and risk scoring — free, in 60 seconds.">
<meta name="twitter:image" content="https://celesys.ai/og-image.png">
<meta name="twitter:site" content="@celesysai">

<!-- Additional SEO -->
<meta name="theme-color" content="#060a13">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Celesys AI">

<!-- Preconnect for performance (helps Core Web Vitals / SEO ranking) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- JSON-LD Structured Data (rich results in Google) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Celesys AI",
  "alternateName": "Celesys AI Stock Analysis",
  "url": "https://celesys.ai",
  "description": "Free AI-powered stock analysis platform providing real-time data, buy/sell targets, risk scoring, management tone analysis, and hidden small-cap picks in 60 seconds.",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "description": "5 free deep-dive reports per hour, no signup required"
  },
  "featureList": [
    "Real-time stock price data",
    "AI-powered buy/sell price targets",
    "Risk scoring and assessment",
    "Quarterly earnings QoQ and YoY analysis",
    "Management tone and confidence analysis",
    "Hidden small-cap stock recommendations",
    "US and Indian stock market coverage"
  ],
  "creator": {
    "@type": "Organization",
    "name": "Celesys AI",
    "url": "https://celesys.ai",
    "email": "contact@celesys.ai"
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is Celesys AI?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI is a free AI-powered stock analysis platform that provides real-time buy/sell targets, risk scoring, earnings analysis, and management tone reading for US and Indian stocks in 60 seconds."
      }
    },
    {
      "@type": "Question",
      "name": "Is Celesys AI free to use?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, Celesys AI is completely free. You get 5 deep-dive reports per hour with no signup, no credit card, and no hidden fees."
      }
    },
    {
      "@type": "Question",
      "name": "What stocks does Celesys AI cover?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI covers 100+ pre-loaded US and Indian stocks (NYSE, NASDAQ, NSE, BSE) and supports any valid ticker symbol from Yahoo Finance."
      }
    }
  ]
}
</script>

<!-- Structured Data / JSON-LD -->
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"Celesys AI","description":"Free AI-powered stock analysis with real-time market data, valuation metrics, entry/exit strategies, risk assessment, and small-cap recommendations.","url":"https://celesys.ai","applicationCategory":"FinanceApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"featureList":["Real-time stock data","AI-powered analysis","Entry and exit price targets","Risk scoring","Small-cap recommendations","52-week price mapping","Financial health radar","Margin vs industry comparison"]}

)});

// Highlight active section on scroll
let ticking=false;
window.addEventListener('scroll',()=>{
if(!ticking){requestAnimationFrame(()=>{
const scrollY=window.scrollY+200;
let activeIdx=0;
sectionIds.forEach((id,i)=>{
const el=document.getElementById(id);
if(el&&el.getBoundingClientRect().top+window.pageYOffset<=scrollY)activeIdx=i;
});
btns.forEach((b,i)=>{b.classList.toggle('active',i===activeIdx)});
ticking=false});ticking=true}
},{passive:true});
}

// User can copy prices and data freely
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Sora:wght@600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// User can copy prices and data freely
</script>
<style>
:root{--bg:#060a13;--bg2:#0b1120;--bg3:#111a2e;--surface:rgba(11,17,32,0.85);--glass:rgba(11,17,32,0.6);--border:rgba(59,130,246,0.1);--border2:rgba(59,130,246,0.25);--blue:#3b82f6;--blue2:#2563eb;--cyan:#06b6d4;--green:#10b981;--green2:#059669;--amber:#f59e0b;--red:#ef4444;--purple:#8b5cf6;--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;--mono:'IBM Plex Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:90px}

/* Grid background */
.gridbg{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(59,130,246,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,0.025) 1px,transparent 1px);background-size:48px 48px}
.gridbg::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 900px 500px at 50% 0%,rgba(59,130,246,0.06),transparent 70%)}

/* NAV */
nav{position:sticky;top:30px;z-index:99;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);background:rgba(6,10,19,0.88);border-bottom:1px solid var(--border);height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 32px}
.nbrand{display:flex;align-items:center;gap:11px}
.nlogo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--blue),var(--cyan));display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:#fff;box-shadow:0 0 16px rgba(59,130,246,.2)}
.nname{font-family:'Sora',sans-serif;font-size:15px;font-weight:700;letter-spacing:.3px;color:#fff}.nname span{color:var(--blue)}.ntag{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-weight:600;margin-top:-2px;display:block}
.ncenter{display:flex;gap:6px;align-items:center}
.npill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:500;background:rgba(59,130,246,.06);border:1px solid var(--border);color:var(--text3)}
.npill .v{color:var(--blue);font-family:var(--mono);font-weight:600}
.nright{display:flex;align-items:center;gap:6px}
.nlive{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:600;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:var(--green)}
.ldot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pdot 2s infinite}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* HERO */
.hero{position:relative;z-index:1;padding:64px 28px 48px;text-align:center}
.sticky-tagline{position:fixed;top:90px;left:0;width:100%;z-index:98;text-align:center;padding:6px 0;background:linear-gradient(90deg,rgba(6,10,19,.98),rgba(15,23,42,.98));border-bottom:1px solid rgba(59,130,246,.15);transform:translateY(-100%);opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none;backdrop-filter:blur(12px)}
.sticky-tagline.vis{transform:translateY(0);opacity:1;pointer-events:auto}
.sticky-tagline span{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;background:linear-gradient(135deg,#94a3b8,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.3px}
.hero-eye{display:inline-flex;align-items:center;gap:6px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);padding:7px 18px;border-radius:100px;font-size:12px;font-weight:600;color:var(--blue);margin-bottom:24px;letter-spacing:.3px}
.hero h1{font-family:'Sora',sans-serif;font-size:clamp(32px,5vw,56px);font-weight:800;line-height:1.15;margin-bottom:16px;background:linear-gradient(135deg,#fff 0%,var(--blue) 60%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-size:18px;color:var(--text2);max-width:580px;margin:0 auto 32px;line-height:1.7}
.hbadges{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.hb{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:8px;font-size:11px;font-weight:600;letter-spacing:.2px;border:1px solid var(--border);background:var(--glass);color:var(--text2)}

/* INPUT */
.isection{position:relative;z-index:1;max-width:720px;margin:0 auto;padding:0 20px 48px}
.icard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;backdrop-filter:blur(16px);position:relative;overflow:hidden}
.icard::before{content:'';position:absolute;top:-1px;left:50%;transform:translateX(-50%);width:100px;height:2px;background:linear-gradient(90deg,transparent,var(--blue),transparent);border-radius:2px}
.ilabel{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px}
.irow{display:grid;grid-template-columns:1fr 1fr 110px;gap:10px}
.iwrap{position:relative}
.ipt{width:100%;padding:12px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;font-size:14px;color:var(--text);font-family:'DM Sans',sans-serif;transition:all .3s;outline:none}
.ipt::placeholder{color:var(--text3)}.ipt:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.08)}
.ac{position:absolute;top:100%;left:0;right:0;background:var(--bg3);border:1.5px solid var(--border2);border-top:none;border-radius:0 0 10px 10px;max-height:280px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 16px 40px rgba(0,0,0,.5)}
.ac.show{display:block}
.aci{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:all .2s;display:flex;align-items:center;gap:8px}
.aci:hover{background:rgba(59,130,246,.05);padding-left:18px}
.act{font-family:var(--mono);font-weight:600;color:var(--blue);font-size:13px;min-width:75px}.acn{color:var(--text2);font-size:12px}
.btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .3s;background:linear-gradient(135deg,var(--blue2),var(--blue));color:#fff;letter-spacing:.2px}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.25)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.ld{background:var(--bg3);color:var(--blue);border:1.5px solid var(--border2)}
.hlp{margin-top:14px;font-size:11px;color:var(--text3);line-height:1.7}.hlp a{color:var(--blue);text-decoration:none}.hlp strong{color:var(--text2)}

/* STATUS */
.sbar{margin-top:14px;padding:12px 16px;border-radius:10px;display:none;font-size:13px;font-weight:500;border:1px solid;align-items:center;gap:8px}
.sbar.show{display:flex;animation:sld .3s ease}.sbar.info{background:rgba(59,130,246,.06);border-color:rgba(59,130,246,.2);color:var(--blue)}
.sbar.success{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.2);color:var(--green)}.sbar.error{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.2);color:var(--red)}
@keyframes sld{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

/* LOADING */
.lsteps{margin-top:14px;display:none}.lsteps.show{display:block}
.ls{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:12px;color:var(--text3);opacity:0;transform:translateX(-8px);transition:all .4s}
.ls.on{opacity:1;transform:translateX(0);color:var(--blue)}.ls.ok{opacity:1;transform:translateX(0);color:var(--green)}
.lsi{width:22px;height:22px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;font-family:var(--mono);transition:all .3s}
.ls.on .lsi{border-color:var(--blue);color:var(--blue);animation:pdot 1.5s infinite}.ls.ok .lsi{border-color:var(--green);background:var(--green);color:var(--bg)}

/* RATE LIMIT */
.rlbox{margin-top:14px;display:none;padding:20px;border-radius:12px;text-align:center;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.2)}
.rlbox .rlcd{font-family:var(--mono);font-size:38px;font-weight:700;color:var(--amber);margin:8px 0;letter-spacing:3px}
.rlbox .rlmsg{font-size:12px;color:var(--text3)}
.rlbox .rlbar{width:100%;height:3px;background:rgba(245,158,11,.1);border-radius:2px;margin-top:12px;overflow:hidden}
.rlbox .rlbf{height:100%;background:linear-gradient(90deg,var(--amber),var(--green));border-radius:2px;transition:width 1s linear}

/* REPORT */
.rpt{position:relative;z-index:1;max-width:1080px;margin:0 auto;padding:0 20px 64px;display:none}
.rpt.show{display:block;animation:fu .6s ease}
@keyframes fu{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

.rphero{text-align:center;margin-bottom:32px;padding:40px 28px;border-radius:16px;border:1px solid var(--border);background:linear-gradient(135deg,rgba(59,130,246,.03),rgba(6,182,212,.03));position:relative;overflow:hidden}
.rphero::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(59,130,246,.02),transparent,rgba(6,182,212,.02),transparent);animation:spin 25s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.rphero>*{position:relative;z-index:1}
.rptk{display:inline-block;font-family:var(--mono);font-size:13px;font-weight:600;color:var(--blue);background:rgba(59,130,246,.1);padding:5px 16px;border-radius:6px;border:1px solid rgba(59,130,246,.2);margin-bottom:12px;letter-spacing:.8px}
.rpco{font-family:'Sora',sans-serif;font-size:clamp(24px,3.5vw,36px);font-weight:800;margin-bottom:10px}
.rplv{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--green);font-weight:500}

/* METRICS */
.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.mcard{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px 16px;text-align:center;backdrop-filter:blur(10px);transition:all .3s;position:relative;overflow:hidden}
.mcard:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:0 8px 24px rgba(59,130,246,.08)}
.mcard::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--cyan));opacity:0;transition:opacity .3s}.mcard:hover::after{opacity:1}
.ml{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:600;margin-bottom:8px}
.mv{font-family:var(--mono);font-size:24px;font-weight:700;color:#fff;margin-bottom:4px}
.ms{font-size:12px;font-weight:600}.ms.up{color:var(--green)}.ms.dn{color:var(--red)}.ms.nu{color:var(--text3)}

/* CHARTS */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:24px}
.cgrid2{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px;margin-bottom:24px}
.ccard{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;backdrop-filter:blur(10px)}
.cct{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:14px;display:flex;align-items:center;gap:6px}
.cc{height:180px}
.cc2{height:200px}

/* STICKY INPUT */
.isection{position:relative;z-index:1}

/* SECTIONS - Always open, no accordion */
.sc{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:0;margin-bottom:12px;backdrop-filter:blur(10px);transition:all .4s;opacity:0;transform:translateY(16px);overflow:visible}
.sc.vis{opacity:1;transform:translateY(0)}.sc:hover{border-color:var(--border2)}
.sh{display:flex;align-items:center;gap:10px;padding:18px 24px 0}
.si{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.st{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;letter-spacing:-.2px;flex:1}
.sbody{padding:16px 24px 24px;overflow:visible}
.tab-bar{display:flex;gap:6px;margin-bottom:0;background:var(--bg2);border:1px solid var(--border);border-radius:12px 12px 0 0;padding:6px;position:sticky;top:0;z-index:10;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.tab-bar.attention{animation:tabPulse 2s ease 3;border-color:rgba(59,130,246,.5);box-shadow:0 0 20px rgba(59,130,246,.15)}
@keyframes tabPulse{0%,100%{border-color:rgba(59,130,246,.2);box-shadow:0 0 10px rgba(59,130,246,.05)}50%{border-color:rgba(59,130,246,.6);box-shadow:0 0 25px rgba(59,130,246,.2)}}
.tab-scroll-area{max-height:75vh;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 12px 12px;padding:18px;background:rgba(6,10,19,.4);scrollbar-width:thin;scrollbar-color:rgba(59,130,246,.2) transparent}
.tab-scroll-area::-webkit-scrollbar{width:6px}.tab-scroll-area::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px}.tab-scroll-area::-webkit-scrollbar-track{background:transparent}
.tab-btn{flex:1;padding:14px 20px;border:none;border-radius:9px;cursor:pointer;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;transition:all .3s;background:transparent;color:var(--text3);letter-spacing:.3px;display:flex;align-items:center;justify-content:center;gap:8px}
.tab-btn.active{background:linear-gradient(135deg,rgba(59,130,246,.2),rgba(139,92,246,.15));color:var(--text1);box-shadow:0 2px 12px rgba(59,130,246,.15)}
.tab-btn:hover:not(.active){background:rgba(255,255,255,.03);color:var(--text2)}
.tab-btn{position:relative}
.tab-btn::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:var(--surface);color:var(--text2);font-size:11px;font-weight:400;padding:8px 14px;border-radius:8px;border:1px solid var(--border);white-space:nowrap;max-width:280px;white-space:normal;text-align:center;line-height:1.5;opacity:0;pointer-events:none;transition:opacity .2s;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,.4)}
.tab-btn:hover::after{opacity:1}
.sc[data-tab]{display:none}.sc[data-tab].tab-visible{display:block;opacity:1;transform:translateY(0)}
.go-deeper-btn{display:block;width:100%;margin:18px 0;padding:16px;border:2px dashed rgba(139,92,246,.4);border-radius:12px;background:rgba(139,92,246,.06);color:var(--purple);font-family:'Sora',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .3s;text-align:center}
.go-deeper-btn:hover{background:rgba(139,92,246,.12);border-color:var(--purple);transform:translateY(-1px)}

/* Verdict */
.vpill{display:inline-flex;padding:10px 32px;border-radius:100px;font-family:'Sora',sans-serif;font-size:18px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;animation:vg 2s ease-in-out infinite alternate}
.vpill.buy{background:rgba(16,185,129,.12);color:var(--green);border:2px solid var(--green)}
.vpill.hold{background:rgba(245,158,11,.12);color:var(--amber);border:2px solid var(--amber)}
.vpill.sell{background:rgba(239,68,68,.12);color:var(--red);border:2px solid var(--red)}
@keyframes vg{0%{box-shadow:0 0 16px rgba(59,130,246,.05)}100%{box-shadow:0 0 32px rgba(59,130,246,.12)}}

/* Tables */
.dt{width:100%;border-collapse:collapse}
.dt th{padding:12px 14px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:600;border-bottom:1px solid var(--border);background:rgba(59,130,246,.02)}
.dt td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text2);transition:background .2s}
.dt tr:hover td{background:rgba(59,130,246,.02)}.dt tr:last-child td{border-bottom:none}

/* Decision list */
.dl{list-style:none;padding:0}.dl li{padding:12px 0 12px 32px;position:relative;font-size:13px;color:var(--text2);line-height:1.7;border-bottom:1px solid var(--border)}
.dl li:last-child{border-bottom:none}.dl li::before{content:'';position:absolute;left:0;top:16px;width:18px;height:18px;border-radius:50%;background:rgba(59,130,246,.1);border:1.5px solid var(--blue)}
.dl li strong{color:var(--text)}

/* Price tags */
.ptag{display:inline-block;padding:5px 12px;border-radius:6px;font-family:var(--mono);font-size:13px;font-weight:600}
.ptag.buy{background:rgba(16,185,129,.08);color:var(--green);border:1px solid rgba(16,185,129,.2)}
.ptag.cur{background:rgba(59,130,246,.08);color:var(--blue);border:1px solid rgba(59,130,246,.2)}
.ptag.pro{background:rgba(245,158,11,.08);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.ptag.stp{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2)}

/* Signals */
.sig{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:5px;font-size:11px;font-weight:700}
.sig.g{background:rgba(16,185,129,.1);color:var(--green)}.sig.c{background:rgba(245,158,11,.1);color:var(--amber)}
.sig.r{background:rgba(239,68,68,.1);color:var(--red)}.sig.n{background:rgba(148,163,184,.08);color:var(--text3)}

/* Info cards */
.ic{padding:18px;border-radius:10px;margin-bottom:12px;border-left:3px solid}
.ic h5{font-size:14px;font-weight:700;margin-bottom:6px}.ic p{font-size:13px;line-height:1.8;color:var(--text2)}
.ic.bl{background:rgba(59,130,246,.03);border-color:var(--blue)}.ic.bl h5{color:var(--blue)}
.ic.am{background:rgba(245,158,11,.03);border-color:var(--amber)}.ic.am h5{color:var(--amber)}
.ic.gr{background:rgba(16,185,129,.03);border-color:var(--green)}.ic.gr h5{color:var(--green)}
.ic.rd{background:rgba(239,68,68,.03);border-color:var(--red)}.ic.rd h5{color:var(--red)}
.ic.pu{background:rgba(139,92,246,.03);border-color:var(--purple)}.ic.pu h5{color:var(--purple)}

.aix{display:inline-flex;align-items:center;gap:5px;cursor:pointer;color:var(--blue);font-size:12px;font-weight:600;padding:6px 0;transition:color .2s}.aix:hover{color:#fff}
.ait{line-height:1.9;color:var(--text2);font-size:13px;white-space:pre-wrap}
.ait::-webkit-scrollbar{width:5px}.ait::-webkit-scrollbar-track{background:var(--bg);border-radius:3px}.ait::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px}.ait::-webkit-scrollbar-thumb:hover{background:rgba(59,130,246,.4)}

/* 52-week position bar */
.w52bar{position:relative;height:8px;background:rgba(148,163,184,.1);border-radius:4px;margin:16px 0 8px;overflow:visible}
.w52fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--red),var(--amber),var(--green))}
.w52dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:var(--blue);border:2px solid #fff;box-shadow:0 0 12px rgba(59,130,246,.4);z-index:2}
.w52labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;color:var(--text3)}

/* Score bar */
.scorebar{height:6px;background:rgba(148,163,184,.1);border-radius:3px;overflow:hidden;margin:6px 0}
.scorefill{height:100%;border-radius:3px;transition:width .8s ease}

/* Footer */
footer{position:relative;z-index:1;margin-top:32px;background:rgba(6,10,19,.95);border-top:1px solid var(--border)}
.ftop{max-width:1080px;margin:0 auto;padding:48px 28px 32px;display:grid;grid-template-columns:1.4fr 1fr 1fr;gap:40px}
.ftop h5{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:#fff;margin-bottom:14px}
.ftop p{font-size:12px;color:var(--text3);line-height:1.8;margin-bottom:8px}
.fbrand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.fblogo{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--cyan));display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:#fff}
.fbname{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:#fff}.fbname span{color:var(--blue)}
.ffeature{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text3);padding:5px 0}
.ffeature::before{content:'\2713';color:var(--green);font-weight:700;font-size:10px}
.fdisc{max-width:1080px;margin:0 auto;padding:0 28px 32px}
.fdbox{padding:24px;border-radius:12px;background:rgba(239,68,68,.05);border:1.5px solid rgba(239,68,68,.2);position:relative;overflow:hidden}
.fdbox::before{content:'\26A0';position:absolute;top:12px;right:16px;font-size:44px;opacity:.06}
.fdbox h4{color:var(--red);font-size:13px;font-weight:800;margin-bottom:12px;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:6px}
.fdbox p{color:var(--text2);font-size:12px;line-height:1.8;margin-bottom:8px;padding-left:14px;border-left:2px solid rgba(239,68,68,.15)}
.fdbox p strong{color:var(--red);font-weight:700}
.fdbox p:last-child{margin-bottom:0}
.fbot{max-width:1080px;margin:0 auto;padding:24px 28px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.fcopy{font-size:11px;color:var(--text3)}.fcopy strong{color:var(--text2)}
.flinks{display:flex;gap:16px}.flinks a{font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s}.flinks a:hover{color:var(--blue)}

@media(max-width:768px){.irow{grid-template-columns:1fr}.mgrid{grid-template-columns:1fr 1fr}.cgrid,.cgrid2{grid-template-columns:1fr}.hero{padding:40px 16px 32px}.ncenter,.nright{display:none}.sc{padding:20px 16px}.ftop{grid-template-columns:1fr;gap:24px}.fbot{flex-direction:column;text-align:center}.tab-btn{font-size:12px;padding:10px 8px;gap:4px}.tab-bar{position:sticky;top:0}.tab-scroll-area{max-height:70vh;padding:12px}.fab{bottom:96px;right:16px;padding:8px 16px;font-size:12px}.edu-bar{padding:10px 12px}.edu-bar .edu-lines{gap:3px 12px}.edu-bar .edu-line{font-size:9px}}
@media(max-width:480px){.mgrid{grid-template-columns:1fr}.hbadges{flex-direction:column;align-items:center}}

/* FLOATING FEEDBACK PANEL */
.fab{position:fixed;bottom:100px;right:24px;z-index:200;display:flex;align-items:center;gap:6px;padding:10px 20px;border-radius:100px;font-size:13px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--blue2),var(--purple));cursor:pointer;box-shadow:0 4px 20px rgba(59,130,246,.3);transition:all .3s;border:none;font-family:'DM Sans',sans-serif;letter-spacing:.2px;animation:fabBounce 3s ease-in-out infinite}
.edu-bar{position:fixed;bottom:0;left:0;width:100%;z-index:199;padding:14px 24px;background:rgba(10,12,20,.98);border-top:1px solid rgba(239,68,68,.15);backdrop-filter:blur(12px)}
.edu-bar .edu-title{font-family:'Sora',sans-serif;font-size:12px;font-weight:800;color:var(--red);letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.edu-bar .edu-lines{display:flex;flex-wrap:wrap;gap:4px 20px}
.edu-bar .edu-line{font-size:10px;color:var(--text3);line-height:1.5;padding-left:10px;border-left:2px solid rgba(239,68,68,.3)}
.edu-bar .edu-line strong{color:var(--red);font-weight:700;font-size:10px;letter-spacing:.3px}
.fab:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 8px 30px rgba(59,130,246,.4);animation:none}
.fab .pulse{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pdot 2s infinite}
@keyframes fabBounce{0%,100%{transform:translateY(0);box-shadow:0 4px 20px rgba(59,130,246,.3)}25%{transform:translateY(-8px);box-shadow:0 12px 30px rgba(139,92,246,.4)}50%{transform:translateY(0);box-shadow:0 4px 20px rgba(59,130,246,.3)}75%{transform:translateY(-4px);box-shadow:0 8px 25px rgba(139,92,246,.35)}}
@keyframes notifPop{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}

/* Slide panel */
.fpanel{position:fixed;top:0;right:-480px;width:460px;max-width:92vw;height:100vh;z-index:300;background:var(--bg2);border-left:1px solid var(--border2);overflow-y:auto;transition:right .4s cubic-bezier(.16,1,.3,1);box-shadow:-8px 0 40px rgba(0,0,0,.5)}
.fpanel.open{right:0}
.fpanel::-webkit-scrollbar{width:5px}.fpanel::-webkit-scrollbar-thumb{background:rgba(59,130,246,.2);border-radius:3px}
.fphdr{position:sticky;top:0;z-index:1;padding:20px 24px;background:rgba(11,17,32,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.fphdr h3{font-family:'Sora',sans-serif;font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--amber),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.fpclose{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.fpclose:hover{background:rgba(239,68,68,.1);color:var(--red);border-color:rgba(239,68,68,.2)}
.fpbody{padding:20px 24px 32px}
.fpbody .sub{font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:24px}

/* Feature cards (panel version) */
.pfcard{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;transition:all .3s}
.pfcard:hover{border-color:var(--border2)}
.pfcard .pfrow{display:flex;align-items:flex-start;gap:12px}
.pfcard .pficon{font-size:24px;flex-shrink:0;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(59,130,246,.05)}
.pfcard .pfinfo{flex:1;min-width:0}
.pfcard .pfname{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#fff;margin-bottom:3px;display:flex;align-items:center;gap:6px}
.pfcard .pfdesc{font-size:11px;color:var(--text3);line-height:1.6}
.pfcard .ftag{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;padding:2px 7px;border-radius:100px}
.ftag.hot{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.15)}
.ftag.new{background:rgba(16,185,129,.1);color:var(--green);border:1px solid rgba(16,185,129,.15)}
.ftag.pro{background:rgba(139,92,246,.1);color:var(--purple);border:1px solid rgba(139,92,246,.15)}

/* Vote buttons */
.pvbtns{display:flex;gap:6px;margin-top:10px}
.pvbtn{display:flex;align-items:center;gap:4px;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text3);font-family:'DM Sans',sans-serif}
.pvbtn:hover{transform:scale(1.05)}
.pvbtn.up:hover,.pvbtn.up.voted{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3);color:var(--green)}
.pvbtn.dn:hover,.pvbtn.dn.voted{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:var(--red)}
.pvbtn .cnt{font-family:var(--mono);font-size:10px}
.pvbar{margin-top:6px;height:3px;border-radius:2px;background:rgba(148,163,184,.08);overflow:hidden}
.pvbar .vfill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--blue));transition:width .5s ease}

/* Vote chart in panel */
.vgp{margin-top:20px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px}
.vgp h4{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:#fff;margin-bottom:4px;text-align:center}
.vgp .vsub{font-size:10px;color:var(--text3);text-align:center;margin-bottom:12px}
.vgp .cc{height:200px}

.sendbox{text-align:center;margin-top:16px}
.sendbtn{display:inline-flex;align-items:center;gap:6px;padding:9px 20px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid rgba(59,130,246,.3);background:rgba(59,130,246,.06);color:var(--blue);transition:all .3s;font-family:'DM Sans',sans-serif;width:100%}
.sendbtn:hover{background:rgba(59,130,246,.12)}

/* Backdrop */
.fpbk{position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .3s}
.fpbk.open{opacity:1;pointer-events:auto}

@media(max-width:768px){.fab{bottom:96px;right:16px;padding:8px 16px;font-size:12px}}

/* Allow users to copy prices, data, and analysis text */
.hbadges,.tab-bar,.fab,.nav,.sh{-webkit-user-select:none;-moz-user-select:none;user-select:none}

/* Back to top button */
.btt{position:fixed;bottom:100px;left:24px;z-index:200;padding:8px 16px;border-radius:100px;font-size:12px;font-weight:700;color:var(--text3);background:var(--surface);border:1px solid var(--border);cursor:pointer;opacity:0;transform:translateY(20px);transition:all .3s;font-family:'DM Sans',sans-serif}
.btt.show{opacity:1;transform:translateY(0)}
.btt:hover{color:var(--blue);border-color:var(--blue);background:rgba(59,130,246,.06)}

/* Scroll down hint between charts and tabs */
.scroll-hint{text-align:center;padding:16px 0;animation:scrollBounce 2s ease-in-out infinite}
.scroll-hint span{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--text3);background:var(--surface);padding:8px 18px;border-radius:100px;border:1px solid var(--border)}
@keyframes scrollBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
@keyframes eventSlide{from{opacity:0;transform:translateY(-20px);max-height:0}to{opacity:1;transform:translateY(0);max-height:300px}}
@keyframes eventGlow{0%,100%{box-shadow:0 0 15px rgba(245,158,11,.15),inset 0 0 15px rgba(245,158,11,.03)}50%{box-shadow:0 0 30px rgba(245,158,11,.25),inset 0 0 20px rgba(245,158,11,.05)}}
@keyframes eventGlowHigh{0%,100%{box-shadow:0 0 15px rgba(239,68,68,.2),inset 0 0 15px rgba(239,68,68,.03)}50%{box-shadow:0 0 35px rgba(239,68,68,.35),inset 0 0 20px rgba(239,68,68,.06)}}
@keyframes borderShimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.global-ticker{width:100%;overflow:hidden;background:rgba(10,12,20,.97);border-bottom:1px solid rgba(255,255,255,.06);padding:6px 0;position:fixed;top:0;left:0;z-index:100;backdrop-filter:blur(10px)}
.global-ticker .ticker-track{display:flex;gap:20px;animation:tickerScroll 40s linear infinite;width:max-content}
.global-ticker .ticker-track:hover{animation-play-state:paused}
.global-ticker .ti{display:flex;align-items:center;gap:5px;font-size:11px;white-space:nowrap;padding:0 4px}
.global-ticker .ti .tn{color:var(--text3);font-weight:600;font-size:10px}
.global-ticker .ti .tp{font-family:var(--mono);font-weight:700;font-size:11px}
.global-ticker .ti .tc{font-size:10px;font-weight:600}
.global-ticker .tc.up{color:var(--green)}.global-ticker .tc.dn{color:var(--red)}.global-ticker .tc.fl{color:var(--text3)}
.cinf{margin-top:8px;padding:8px 10px;border-radius:6px;border:1px solid;font-size:11px;color:var(--text2);line-height:1.6}
.cinf:empty{display:none}
.ptab{font-size:10px;padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;font-weight:600;transition:all .2s;font-family:'DM Sans',sans-serif}
.ptab.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.ptab:hover:not(.active){background:rgba(59,130,246,.1);border-color:var(--blue)}
.pick-tbl{width:100%;border-collapse:collapse;font-size:11px}
.pick-tbl th{text-align:left;padding:6px 8px;font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.5px;border-bottom:1px solid var(--border);text-transform:uppercase}
.pick-tbl td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--text2);vertical-align:top}
.pick-tbl tr:hover td{background:rgba(59,130,246,.03)}
.pick-tbl .cname{font-weight:700;color:var(--text);font-size:12px}
.pick-tbl .csub{font-size:9px;color:var(--text3)}
.pick-tbl .flag{font-size:10px;padding:1px 6px;border-radius:4px;font-weight:700;white-space:nowrap}
.pick-tbl .flag.g{background:rgba(16,185,129,.1);color:var(--green)}
.pick-tbl .flag.r{background:rgba(239,68,68,.1);color:var(--red)}
.pick-tbl .flag.b{background:rgba(59,130,246,.1);color:var(--blue)}
.pick-geo{display:flex;gap:6px;margin-bottom:8px}
.pick-geo button{font-size:9px;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text3);cursor:pointer;font-weight:700;font-family:'DM Sans',sans-serif}
.pick-geo button.active{background:var(--amber);color:#000;border-color:var(--amber)}
.event-alert-global{animation:eventSlide .5s ease-out;overflow:hidden;margin-bottom:0;border-radius:12px;position:relative}
.evt-scroll{display:flex;gap:6px;overflow-x:auto;padding:6px 0;scrollbar-width:none;-ms-overflow-style:none}
.evt-scroll::-webkit-scrollbar{display:none}
.evt-pill{position:relative;flex-shrink:0;padding:6px 12px;border-radius:8px;cursor:pointer;transition:all .2s;max-width:240px;border:1px solid rgba(255,255,255,.06)}
.evt-pill:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.evt-pill .evt-head{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.evt-pill .evt-detail{display:none;margin-top:6px;font-size:10px;color:var(--text2);line-height:1.5}
.evt-pill:hover .evt-detail{display:block}
.evt-pill:hover{max-width:400px}
.evt-pill .evt-sev{font-size:8px;font-weight:800;color:#fff;padding:1px 5px;border-radius:6px;flex-shrink:0}
.evt-pill .evt-imp{font-size:8px;font-weight:700;padding:1px 5px;border-radius:6px;flex-shrink:0;border:1px solid}
.evt-upcoming{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.evt-upcoming .evt-up{font-size:9px;padding:3px 8px;border-radius:6px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.1);color:var(--text2);white-space:nowrap}
.event-alert-global::before{content:'';position:absolute;inset:-2px;border-radius:14px;background:linear-gradient(90deg,transparent,rgba(245,158,11,.4),transparent,rgba(239,68,68,.3),transparent);background-size:300% 100%;animation:borderShimmer 4s linear infinite;z-index:-1}
.event-alert-global.high::before{background:linear-gradient(90deg,transparent,rgba(239,68,68,.5),transparent,rgba(245,158,11,.4),transparent);background-size:300% 100%}
.event-dismiss{position:absolute;top:8px;right:10px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:4px;transition:all .2s}
.event-dismiss:hover{color:var(--text);background:rgba(255,255,255,.1)}
.ipt,input,textarea{-webkit-user-select:text;-moz-user-select:text;user-select:text}

/* ═══ ANTI-SCREENSHOT & ANTI-SHARING PROTECTIONS ═══ */
/* Smart Trades content cannot be selected, copied, or printed */
[data-tab="trades"] {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  user-select: none !important;
  -webkit-touch-callout: none !important;
  -webkit-user-drag: none !important;
}
[data-tab="trades"] * {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  user-select: none !important;
}
/* Hide completely when printing */
@media print {
  [data-tab="trades"], #tabBtnTrades, .trades-watermark {
    display: none !important;
    visibility: hidden !important;
  }
  body::before {
    content: "Smart Trades content is protected and cannot be printed.";
    display: block;
    text-align: center;
    font-size: 24px;
    padding: 60px;
    color: #666;
  }
}
/* Watermark overlay for trades */
.trades-watermark {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 10;
  overflow: hidden;
  opacity: 0.04;
}
.trades-watermark-text {
  position: absolute;
  font-size: 14px;
  font-weight: 800;
  color: #fff;
  transform: rotate(-35deg);
  white-space: nowrap;
  letter-spacing: 2px;
  font-family: 'Sora', sans-serif;
}
/* Blur trades when page is not visible (anti-screenshot via tab switch) */
.trades-blurred [data-tab="trades"] .sbody {
  filter: blur(20px) !important;
  transition: filter 0.1s;
}
.trades-blurred [data-tab="trades"] .sbody::after {
  content: "Content hidden for security";
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 16px;
  font-weight: 700;
  color: var(--amber);
  z-index: 100;
}
</style>
</head>
<body>
<!-- Global Indices Ticker — loads on page visit -->
<div class="global-ticker" id="globalTicker">
<div class="ticker-track" id="tickerTrack">
<span style="font-size:10px;color:var(--text3);padding:0 8px">Loading global markets...</span>
</div>
</div>
<div class="gridbg"></div>

<nav>
<div class="nbrand">
<div class="nlogo">S</div>
<div><div class="nname">CELESYS <span>AI</span></div><div class="ntag">Research Platform</div></div>
</div>
<div class="ncenter">
<div class="npill">Reports: <span class="v" id="navRC">0</span></div>
<div class="npill">Quota: <span class="v" id="navQ">5/hr</span></div>
</div>
<div class="nright">
<div class="nlive"><div class="ldot"></div> Live Market Data</div>

</div>
</nav>
<div class="sticky-tagline" id="stickyTag"><span>Master Global Equities in 60 Seconds</span><span id="stickyCompany" style="display:none;margin-left:12px;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;color:var(--text2);-webkit-text-fill-color:var(--text2);padding-left:12px;border-left:1px solid rgba(255,255,255,.1)"></span></div>

<section class="hero">
<div class="hero-eye"><div class="ldot"></div> Live Market Data &middot; Updated Every Minute</div>
<h1>Master Global Equities in 60 Seconds.</h1>
<p class="hero-sub" style="font-size:16px;line-height:1.8;max-width:620px">Precision Entry &amp; Exit Targets &middot; Institutional Risk Profiling &middot; Earnings Alpha<br>Insider Sentiment<br><span style="color:var(--text3);font-size:14px">Institutional-grade reports at the speed of thought.</span></p>
<div class="hbadges">
<div class="hb" style="border-color:rgba(16,185,129,.3);color:var(--green)">&#10003; Zero Signup &middot; Zero Cost</div>
<div class="hb" style="border-color:rgba(59,130,246,.3);color:var(--blue)">&#9889; 60-Second Deep Dive</div>
<div class="hb" style="border-color:rgba(139,92,246,.3);color:var(--purple)">&#128200; Real-Time Market Data</div>
<div class="hb" style="border-color:rgba(6,182,212,.3);color:var(--cyan)">&#127919; <span id="reportBadgeCount" style="font-weight:800"></span> Reports &amp; Counting</div>
</div>

</section>

<section class="isection">
<div class="icard">
<div class="ilabel">Your next smart move starts here</div>
<div class="irow">
<input class="ipt" type="email" id="email" aria-label="Your email address" placeholder="your@email.com" autocomplete="off" data-lpignore="true" onfocus="if(this.dataset.real){this.type='email';this.value=this.dataset.real}" onblur="if(this.value.includes('@')){this.dataset.real=this.value;const p=this.value.split('@');this.value=p[0][0]+'***@'+p[1];this.type='text'}">
<div class="iwrap"><input class="ipt" type="text" id="ticker" aria-label="Stock ticker or company name" placeholder="Ticker or company..." autocomplete="off"><div class="ac" id="autocomplete"></div></div>
<button class="btn" id="btn" aria-label="Analyze stock" onclick="analyze()">Analyze &#8594;</button>
</div>
<div class="hlp">
Type to search <strong>100 stocks</strong> (US &amp; India) &middot; Or enter any valid ticker symbol<br>
&#128293; <strong>5 free deep-dive reports</strong> per email per hour &middot; No signup, no credit card<br>
&#128270; <strong>Ticker not showing?</strong> <a href="https://finance.yahoo.com/lookup" target="_blank" rel="noopener">Search for your stock ticker here</a> and paste it above
</div>
<div style="text-align:center;margin-top:10px;font-size:11px;color:var(--text3);letter-spacing:.3px">
<span id="globalRC" style="display:none">0</span>
</div>

<div class="sbar" id="status"></div>
<div class="lsteps" id="lsteps">
<div class="ls" id="s1"><div class="lsi">1</div> Pulling live market data &amp; financials...</div>
<div class="ls" id="s2"><div class="lsi">2</div> AI crunching valuation &amp; fundamentals...</div>
<div class="ls" id="s3"><div class="lsi">3</div> Computing entry, exit &amp; stop-loss prices...</div>
<div class="ls" id="s4"><div class="lsi">4</div> Scoring risk &amp; finding hidden gem small-caps...</div>
</div>
<div class="rlbox" id="rateLimitBox">
<div style="font-size:13px;font-weight:600;color:var(--amber)">Report limit reached</div>
<div class="rlcd" id="rlCountdown">--:--</div>
<div class="rlmsg" id="rlComeback"></div>
<div class="rlbar"><div class="rlbf" id="rlProgress" style="width:0%"></div></div>
</div>
</div>
</section>

<section class="rpt" id="report">
<div class="rphero">
<div class="rptk" id="tickerTag"></div>
<div class="rpco" id="companyName"></div>
<div class="rplv" id="timestamp"><div class="ldot"></div></div>
</div>
<div class="mgrid" id="metrics"></div>

<!-- 3 CHARTS ROW -->
<div class="cgrid">
<div class="ccard"><div class="cct">&#9678; Valuation Metrics <span style="font-size:10px;color:var(--text3);font-weight:400">&middot; hover bars for details</span></div><div class="cc"><canvas id="valChart"></canvas></div><div id="valInference" class="cinf" style="background:rgba(59,130,246,.04);border-color:rgba(59,130,246,.1)"></div></div>
<div class="ccard"><div class="cct">&#9678; Financial Health <span style="font-size:10px;color:var(--text3);font-weight:400">&middot; hover dots for details</span></div><div class="cc"><canvas id="healthChart"></canvas></div><div id="healthInference" class="cinf" style="background:rgba(16,185,129,.04);border-color:rgba(16,185,129,.1)"></div></div>
<div class="ccard"><div class="cct">&#9678; Risk Profile <span style="font-size:10px;color:var(--text3);font-weight:400">&middot; hover dots for details</span></div><div class="cc"><canvas id="riskChart"></canvas></div><div id="riskInference" class="cinf" style="background:rgba(239,68,68,.04);border-color:rgba(239,68,68,.1)"></div></div>
</div>
<!-- 2 CHARTS ROW -->
<div class="cgrid2">
<div class="ccard"><div class="cct">&#9678; Price Trend (6M) <span style="font-size:10px;color:var(--text3);font-weight:400">&middot; hover points to track</span></div><div class="cc2"><canvas id="trendChart"></canvas></div><div id="trendInference" class="cinf" style="background:rgba(59,130,246,.04);border-color:rgba(59,130,246,.1)"></div></div>
<div class="ccard"><div class="cct">&#9678; Margin vs Industry <span style="font-size:10px;color:var(--text3);font-weight:400">&middot; hover to compare</span></div><div class="cc2"><canvas id="marginChart"></canvas></div><div id="marginVsInference" class="cinf" style="background:rgba(6,182,212,.04);border-color:rgba(6,182,212,.1)"></div></div>
</div>

<!-- 52-WEEK POSITION -->
<div class="sc vis" id="w52section" style="opacity:1;transform:none"></div>

<div id="analysisContainer"></div>

<!-- POST-REPORT DISCLAIMER -->
<div style="margin-top:16px;padding:12px 18px;border-radius:10px;background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.15);display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2)">
<span style="font-size:16px">&#9888;</span>
<span><strong style="color:var(--red)">Reminder:</strong> Past performance does not guarantee future results. You can lose money investing. Always do your own research.</span>
</div>
</section>

<footer>
<div style="max-width:1080px;margin:0 auto;padding:24px 28px 16px">
<!-- Brand + Links row -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
<div style="display:flex;align-items:center;gap:10px">
<div class="fblogo">S</div>
<div><div class="fbname">CELESYS <span>AI</span></div><div style="font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase">Research Platform</div></div>
</div>
<div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center">
<a href="/about" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">About</a>
<a href="/faq" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">FAQ</a>
<a href="/privacy" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Privacy</a>
<a href="/terms" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Terms</a>
<a href="/disclaimer" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Disclaimer</a>
<a href="mailto:contact@celesys.ai" style="font-size:11px;color:var(--blue);text-decoration:none">&#9993; contact@celesys.ai</a>
</div>
</div>
<!-- Copyright -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding-top:12px">
<div style="font-size:10px;color:var(--text3)">&copy; 2026 Celesys AI &middot; All rights reserved</div>
<div style="font-size:10px;color:var(--text3)">Real-time data &middot; AI-powered analysis &middot; Not financial advice</div>
</div>
</div>
</footer>

<!-- BACK TO TOP -->
<button class="btt" id="bttBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Back to top">&#8593; Top</button>

<script>

const stocks=[
{t:'AAPL',n:'Apple Inc.'},{t:'MSFT',n:'Microsoft Corporation'},{t:'GOOGL',n:'Alphabet Inc. (Google)'},{t:'AMZN',n:'Amazon.com Inc.'},
{t:'NVDA',n:'NVIDIA Corporation'},{t:'META',n:'Meta Platforms (Facebook)'},{t:'TSLA',n:'Tesla Inc.'},{t:'BRK.B',n:'Berkshire Hathaway'},
{t:'LLY',n:'Eli Lilly and Company'},{t:'AVGO',n:'Broadcom Inc.'},{t:'JPM',n:'JPMorgan Chase & Co.'},{t:'V',n:'Visa Inc.'},
{t:'UNH',n:'UnitedHealth Group'},{t:'XOM',n:'Exxon Mobil'},{t:'WMT',n:'Walmart Inc.'},{t:'MA',n:'Mastercard Inc.'},
{t:'PG',n:'Procter & Gamble'},{t:'JNJ',n:'Johnson & Johnson'},{t:'HD',n:'Home Depot'},{t:'ORCL',n:'Oracle Corporation'},
{t:'COST',n:'Costco Wholesale'},{t:'NFLX',n:'Netflix Inc.'},{t:'BAC',n:'Bank of America'},{t:'CRM',n:'Salesforce Inc.'},
{t:'ABBV',n:'AbbVie Inc.'},{t:'CVX',n:'Chevron Corporation'},{t:'AMD',n:'Advanced Micro Devices'},{t:'KO',n:'Coca-Cola Company'},
{t:'PEP',n:'PepsiCo Inc.'},{t:'MRK',n:'Merck & Co.'},{t:'ADBE',n:'Adobe Inc.'},{t:'TMO',n:'Thermo Fisher Scientific'},
{t:'CSCO',n:'Cisco Systems'},{t:'ACN',n:'Accenture'},{t:'MCD',n:"McDonald's Corporation"},{t:'LIN',n:'Linde plc'},
{t:'ABT',n:'Abbott Laboratories'},{t:'WFC',n:'Wells Fargo'},{t:'TXN',n:'Texas Instruments'},{t:'INTC',n:'Intel Corporation'},
{t:'DIS',n:'Walt Disney Company'},{t:'PM',n:'Philip Morris'},{t:'CMCSA',n:'Comcast Corporation'},{t:'NKE',n:'Nike Inc.'},
{t:'QCOM',n:'Qualcomm Inc.'},{t:'GE',n:'General Electric'},{t:'INTU',n:'Intuit Inc.'},{t:'VZ',n:'Verizon Communications'},
{t:'AMAT',n:'Applied Materials'},{t:'CAT',n:'Caterpillar Inc.'},
{t:'RELIANCE.NS',n:'Reliance Industries'},{t:'TCS.NS',n:'Tata Consultancy Services'},{t:'HDFCBANK.NS',n:'HDFC Bank'},
{t:'INFY',n:'Infosys Limited'},{t:'HINDUNILVR.NS',n:'Hindustan Unilever'},{t:'ICICIBANK.NS',n:'ICICI Bank'},
{t:'SBIN.NS',n:'State Bank of India'},{t:'BHARTIARTL.NS',n:'Bharti Airtel'},{t:'ITC.NS',n:'ITC Limited'},
{t:'KOTAKBANK.NS',n:'Kotak Mahindra Bank'},{t:'LT.NS',n:'Larsen & Toubro'},{t:'AXISBANK.NS',n:'Axis Bank'},
{t:'BAJFINANCE.NS',n:'Bajaj Finance'},{t:'ASIANPAINT.NS',n:'Asian Paints'},{t:'MARUTI.NS',n:'Maruti Suzuki'},
{t:'TITAN.NS',n:'Titan Company'},{t:'SUNPHARMA.NS',n:'Sun Pharmaceutical'},{t:'ULTRACEMCO.NS',n:'UltraTech Cement'},
{t:'NESTLEIND.NS',n:'Nestlé India'},{t:'ONGC.NS',n:'Oil & Natural Gas Corp'},{t:'NTPC.NS',n:'NTPC Limited'},
{t:'TATAMOTORS.NS',n:'Tata Motors'},{t:'POWERGRID.NS',n:'Power Grid Corporation'},{t:'TATASTEEL.NS',n:'Tata Steel'},
{t:'M&M.NS',n:'Mahindra & Mahindra'},{t:'JSWSTEEL.NS',n:'JSW Steel'},{t:'ADANIENT.NS',n:'Adani Enterprises'},
{t:'WIPRO.NS',n:'Wipro Limited'},{t:'COALINDIA.NS',n:'Coal India'},{t:'HCLTECH.NS',n:'HCL Technologies'},
{t:'BAJAJFINSV.NS',n:'Bajaj Finserv'},{t:'DIVISLAB.NS',n:"Divi's Laboratories"},{t:'GRASIM.NS',n:'Grasim Industries'},
{t:'TECHM.NS',n:'Tech Mahindra'},{t:'BRITANNIA.NS',n:'Britannia Industries'},{t:'EICHERMOT.NS',n:'Eicher Motors'},
{t:'APOLLOHOSP.NS',n:'Apollo Hospitals'},{t:'INDUSINDBK.NS',n:'IndusInd Bank'},{t:'TRENT.NS',n:'Trent Limited'},
{t:'ADANIPORTS.NS',n:'Adani Ports'},{t:'HINDALCO.NS',n:'Hindalco Industries'},{t:'DRREDDY.NS',n:"Dr. Reddy's Labs"},
{t:'CIPLA.NS',n:'Cipla Limited'},{t:'HEROMOTOCO.NS',n:'Hero MotoCorp'},{t:'SHREECEM.NS',n:'Shree Cement'},
{t:'BAJAJ-AUTO.NS',n:'Bajaj Auto'},{t:'BPCL.NS',n:'Bharat Petroleum'},{t:'SIEMENS.NS',n:'Siemens India'},
{t:'KPIT.NS',n:'KPIT Technologies'},{t:'DIXON.NS',n:'Dixon Technologies'}
];
let valChart,trendChart,healthChart,riskChart,marginChart,qoqChart,yoyChart,marginTrendChart,countdownInterval=null;
const TI=document.getElementById('ticker'),AC=document.getElementById('autocomplete');
TI.addEventListener('input',function(){const v=this.value.trim().toUpperCase();AC.innerHTML='';if(!v){AC.classList.remove('show');return}
const m=stocks.filter(s=>s.t.includes(v)||s.n.toUpperCase().includes(v)).slice(0,10);if(!m.length){AC.classList.remove('show');return}
m.forEach(s=>{const d=document.createElement('div');d.className='aci';d.innerHTML=`<span class="act">${s.t}</span><span class="acn">${s.n}</span>`;d.onclick=()=>{TI.value=s.t;AC.classList.remove('show')};AC.appendChild(d)});AC.classList.add('show')});
document.addEventListener('click',e=>{if(e.target!==TI)AC.classList.remove('show')});
document.getElementById('email').addEventListener('keypress',e=>{if(e.key==='Enter')TI.focus()});
// Smart Trades tab: only visible for authorized email
const TRADES_EMAILS=['vijy.dhulipala@gmail.com'];
let _pulseData=null;
async function fetchMarketPulse(){
try{
const r=await fetch('/api/market-pulse');
const d=await r.json();
if(!d.success){console.log('Market pulse: no success');return}
_pulseData=d;
console.log('Market pulse loaded:',d.events?.length||0,'events,',d.upcoming?.length||0,'upcoming');
renderMarketEvents();
}catch(e){console.log('Market pulse fetch error:',e)}
}
function renderMarketEvents(){
const div=document.getElementById('eventAlertArea');
if(!div||!_pulseData)return;
const d=_pulseData;
let h='';
if(d.events&&d.events.length>0){
h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:12px">&#128293;</span>
<span style="font-family:'Sora',sans-serif;font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.5px">LIVE MARKET EVENTS</span>
<span style="font-size:9px;color:var(--text3)">hover for details</span>
</div><div class="evt-scroll">`;
d.events.forEach(evt=>{
const isH=evt.severity==='HIGH';
const isM=evt.severity==='MEDIUM';
const sC=isH?'#ef4444':isM?'#f59e0b':'#3b82f6';
const iC=evt.impact==='BULLISH'?'#10b981':evt.impact==='BEARISH'?'#ef4444':'#f59e0b';
const iE=evt.impact==='BULLISH'?'&#9650;':evt.impact==='BEARISH'?'&#9660;':'&#9654;';
const bg=isH?'rgba(239,68,68,.06)':isM?'rgba(245,158,11,.04)':'rgba(59,130,246,.04)';
h+=`<div class="evt-pill" style="background:${bg};border-color:${sC}20">
<div class="evt-head" style="color:${sC}">
<span class="evt-sev" style="background:${sC}">${evt.severity.charAt(0)}</span>
${evt.headline}
<span class="evt-imp" style="color:${iC};border-color:${iC}40">${iE} ${evt.impact}</span>
</div>
<div class="evt-detail">${evt.detail}${evt.action?'<div style="margin-top:4px;padding:4px 8px;border-radius:4px;background:rgba(255,255,255,.03);border-left:2px solid '+sC+';font-weight:600">'+evt.action+'</div>':''}</div>
</div>`;
});
h+=`</div>`;
}
if(d.upcoming&&d.upcoming.length>0){
h+=`<div class="evt-upcoming">
<span style="font-size:10px;color:var(--text3);padding:3px 0">&#128197;</span>`;
d.upcoming.forEach(u=>{
const uC=u.impact==='HIGH'?'var(--red)':'var(--amber)';
h+=`<span class="evt-up"><strong style="color:${uC}">${u.event}</strong> ${u.date} <span style="color:var(--text3)">(${u.days}d)</span></span>`;
});
h+=`</div>`;
}
if(h){div.innerHTML=h;div.style.display='block'}
}

function checkTradesAccess(){
try{
const el=document.getElementById('email');
if(!el)return;
const email=(el.dataset.real||el.value).trim().toLowerCase();
const show=TRADES_EMAILS.includes(email);
const tBtn=document.getElementById('tabBtnTrades');
const gBtn=document.getElementById('tabBtnGems');
if(tBtn)tBtn.style.display=show?'':'none';
if(gBtn)gBtn.style.display=show?'':'none';
document.querySelectorAll('.sc[data-tab="trades"]').forEach(s=>s.style.display=show?'':'none');
document.querySelectorAll('.sc[data-tab="gems"]').forEach(s=>s.style.display=show?'':'none');
if(show){initTradesProtection(email);try{renderPicks('lc')}catch(e){}}
console.log('checkTradesAccess:',email,'→',show?'GRANTED':'DENIED');
}catch(e){console.warn('checkTradesAccess error:',e)}
}
document.getElementById('email').addEventListener('blur',checkTradesAccess);

// ═══════════════════════════════════════════════
// ANTI-SCREENSHOT & ANTI-SHARING PROTECTION
// ═══════════════════════════════════════════════
function initTradesProtection(email){
const tradesTab=document.querySelector('[data-tab="trades"]');
if(!tradesTab||tradesTab.dataset.protected)return;
tradesTab.dataset.protected='true';
tradesTab.style.position='relative';

// 1. Dynamic watermark grid with user's email
const wm=document.createElement('div');
wm.className='trades-watermark';
let wmHtml='';
for(let row=0;row<20;row++){
for(let col=0;col<6;col++){
const top=row*120+Math.random()*40;
const left=col*280+Math.random()*60-40;
wmHtml+=`<span class="trades-watermark-text" style="top:${top}px;left:${left}px">contact@celesys.ai • CELESYS.AI • CONFIDENTIAL</span>`;
}}
wm.innerHTML=wmHtml;
tradesTab.appendChild(wm);

// 2. Block right-click on trades section
tradesTab.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();return false});

// 3. Block drag/drop (prevents dragging content out)
tradesTab.addEventListener('dragstart',e=>{e.preventDefault()});

// 4. Block copy/cut
tradesTab.addEventListener('copy',e=>{e.preventDefault();e.clipboardData&&e.clipboardData.setData('text/plain','Smart Trades content is protected.')});
tradesTab.addEventListener('cut',e=>{e.preventDefault()});
}

// 5. Block keyboard shortcuts globally when trades tab is active
document.addEventListener('keydown',function(e){
const tradesVisible=document.querySelector('[data-tab="trades"]')&&
document.querySelector('[data-tab="trades"]').style.display!=='none'&&
document.querySelector('.tab-btn-active')&&
document.querySelector('.tab-btn-active').id==='tabBtnTrades';
if(!tradesVisible)return;

// Block PrintScreen
if(e.key==='PrintScreen'){e.preventDefault();return false}
// Block Ctrl+P (print)
if(e.ctrlKey&&e.key==='p'){e.preventDefault();return false}
// Block Ctrl+S (save)
if(e.ctrlKey&&e.key==='s'){e.preventDefault();return false}
// Block Ctrl+Shift+I / Ctrl+Shift+J (dev tools)
if(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='i'||e.key==='J'||e.key==='j')){e.preventDefault();return false}
// Block Ctrl+U (view source)
if(e.ctrlKey&&(e.key==='u'||e.key==='U')){e.preventDefault();return false}
// Block F12 (dev tools)
if(e.key==='F12'){e.preventDefault();return false}
// Block Ctrl+Shift+S (screenshot in some browsers)
if(e.ctrlKey&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();return false}
// Block Ctrl+C (copy)
if(e.ctrlKey&&(e.key==='c'||e.key==='C')){e.preventDefault();return false}
// Block Ctrl+A (select all)
if(e.ctrlKey&&(e.key==='a'||e.key==='A')){e.preventDefault();return false}
// Block Windows+Shift+S (Windows snipping tool)
if(e.metaKey&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();return false}
});

// 6. Blur content when page loses visibility (alt-tab, screenshot tools)
document.addEventListener('visibilitychange',function(){
if(document.hidden){
document.body.classList.add('trades-blurred');
}else{
// Small delay before unblurring to catch screenshot tools
setTimeout(()=>document.body.classList.remove('trades-blurred'),800);
}
});

// 7. Blur on window blur (when focus moves away from browser)
window.addEventListener('blur',function(){
document.body.classList.add('trades-blurred');
});
window.addEventListener('focus',function(){
setTimeout(()=>document.body.classList.remove('trades-blurred'),600);
});

// 8. Detect and warn about screen recording/capture API
if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){
const origGetDisplay=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices);
navigator.mediaDevices.getDisplayMedia=function(){
alert('Screen recording is not allowed on Smart Trades content.');
return Promise.reject(new Error('Screen capture blocked'));
};
}

// 9. Periodic check — if dev tools are open (detected by debugger timing)
(function detectDevTools(){
const el=new Image();
let open=false;
Object.defineProperty(el,'id',{get:function(){open=true}});
setInterval(()=>{
open=false;
console.log(el);
if(open){
document.body.classList.add('trades-blurred');
}
},3000);
})();
TI.addEventListener('keypress',e=>{if(e.key==='Enter')analyze()});

function showStatus(m,t){const s=document.getElementById('status');s.innerHTML=m;s.className='sbar show '+t}
function showLS(){const b=document.getElementById('lsteps');b.classList.add('show');['s1','s2','s3','s4'].forEach(s=>{document.getElementById(s).className='ls'});
let i=0;const ids=['s1','s2','s3','s4'];b._iv=setInterval(()=>{if(i>0)document.getElementById(ids[i-1]).classList.replace('on','ok');if(i<ids.length){document.getElementById(ids[i]).classList.add('on');i++}else clearInterval(b._iv)},7000);document.getElementById(ids[0]).classList.add('on')}
function hideLS(){const b=document.getElementById('lsteps');if(b._iv)clearInterval(b._iv);b.classList.remove('show')}
function hideRL(){document.getElementById('rateLimitBox').style.display='none';if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null}}
function showRL(data){const box=document.getElementById('rateLimitBox'),cd=document.getElementById('rlCountdown'),cb=document.getElementById('rlComeback'),pr=document.getElementById('rlProgress');
let ts=data.retry_after_seconds||(data.retry_after_minutes||5)*60;const tt=new Date(Date.now()+ts*1000);
cb.textContent='Come back at '+tt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+' \u00B7 '+(data.requests_limit||5)+' fresh reports';box.style.display='block';
if(countdownInterval)clearInterval(countdownInterval);const ss=ts;
function tick(){const r=Math.max(0,Math.floor((tt-Date.now())/1000)),mn=Math.floor(r/60),sc=r%60;
cd.textContent=String(mn).padStart(2,'0')+':'+String(sc).padStart(2,'0');pr.style.width=Math.min(100,((ss-r)/ss)*100)+'%';
if(r<=0){clearInterval(countdownInterval);countdownInterval=null;cd.textContent='00:00';cd.style.color='var(--green)';
cb.textContent='\u2713 Quota refreshed \u2014 generate reports again';pr.style.width='100%';box.style.borderColor='rgba(16,185,129,.3)';box.style.background='rgba(16,185,129,.04)'}}
tick();countdownInterval=setInterval(tick,1000)}

async function analyze(){const emailEl=document.getElementById('email');const email=(emailEl.dataset.real||emailEl.value).trim(),ticker=TI.value.trim().toUpperCase(),btn=document.getElementById('btn'),rpt=document.getElementById('report');
AC.classList.remove('show');if(!email||!ticker){showStatus('Enter both email and ticker','error');return}
if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){showStatus('Enter a valid email','error');return}
try{const rl=await fetch('/api/check-rate-limit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});const rld=await rl.json();
if(!rld.allowed){showStatus(rld.reason,'error');showRL(rld);return}else hideRL()}catch(e){}
btn.disabled=true;btn.textContent='Analyzing...';btn.classList.add('ld');rpt.classList.remove('show');hideRL();
showStatus('Crunching the numbers on '+ticker+'...','info');showLS();
// Parallel: fetch market events for authorized users
fetchMarketPulse();
try{const res=await fetch('/api/generate-report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_name:ticker,email})});
if(res.status===429){const r=await res.json().catch(()=>({}));showStatus(r.reason||r.detail||'Too many requests','error');if(r.retry_after_seconds||r.retry_after_minutes)showRL(r);return}
if(res.status===503||res.status===504){const e=await res.json().catch(()=>({}));showStatus(e.detail||'Service busy. Try again in 30s.','error');return}
if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.detail||e.message||'Analysis failed')}
const data=await res.json();if(!data.success||!data.live_data)throw new Error('No data for this ticker');
let q='';if(data.rate_limit){const r=data.rate_limit.remaining;document.getElementById('navQ').textContent=r+'/hr';
q=r===0?' \u00B7 Last free report this hour':' \u00B7 '+r+' remaining'}
if(data.report_number)document.getElementById('navRC').textContent=data.report_number;
if(data.report_number){document.getElementById('globalRC').textContent=data.report_number.toLocaleString();const hb=document.getElementById('reportBadgeCount');if(hb)hb.textContent=data.report_number.toLocaleString()}
showStatus('\u2713 Your report is ready. Scroll down \u2014 this is the good stuff.'+q,'success');displayReport(data);TI.value='';
// GA4: Track report generation
if(typeof gtag==='function')gtag('event','generate_report',{ticker:data.live_data?.ticker||'',company:data.company_name||''});
}catch(e){let m=e.message;if(m==='Failed to fetch')m='Cannot connect to server.';
else if(m.toLowerCase().includes('rate limit')||m.toLowerCase().includes('too many')||m.toLowerCase().includes('temporarily')||m.toLowerCase().includes('all data sources'))m='All data sources busy. Try again in 30 seconds.';
showStatus(m,'error')}finally{btn.disabled=false;btn.textContent='Analyze \u2192';btn.classList.remove('ld');hideLS()}}

function displayReport(data){const d=data.live_data,curr=d.currency==='INR'?'\u20B9':'$',price=d.current_price;
document.getElementById('tickerTag').textContent=d.ticker;document.getElementById('companyName').textContent=d.company_name||d.ticker;
const scEl=document.getElementById('stickyCompany');if(scEl){scEl.textContent=(d.company_name||d.ticker)+' · '+curr+price.toLocaleString();scEl.style.display='inline'}
const srcLabel=d.data_source==='yahoo_chart_only'?' (chart)':d.data_source==='yahoo_scrape'?' (alt)':d.data_source==='stale_cache'?' (cached)':'';
document.getElementById('timestamp').innerHTML='<div class="ldot"></div> LIVE'+srcLabel+' \u00B7 '+d.data_timestamp;

// 8 METRICS (expanded from 4) - graceful N/A handling
const peDisplay=d.pe_ratio&&d.pe_ratio!=='N/A'&&d.pe_ratio!==0?d.pe_ratio:'—';
const peLabel=peDisplay==='—'?'<span style="font-size:9px;color:var(--text3)">Data pending</span>':'TTM';
const mcapDisplay=d.market_cap&&d.market_cap>0?formatCap(d.market_cap,curr):'—';
const mcapLabel=mcapDisplay==='—'?'<span style="font-size:9px;color:var(--text3)">Data pending</span>':d.currency;
document.getElementById('metrics').innerHTML=`
<div class="mcard"><div class="ml">Price</div><div class="mv">${curr}${price.toLocaleString()}</div><div class="ms ${d.price_change>=0?'up':'dn'}">${d.price_change>=0?'\u25B2':'\u25BC'} ${Math.abs(d.price_change).toFixed(2)} (${d.price_change_pct.toFixed(2)}%)</div></div>
<div class="mcard"><div class="ml">P/E Ratio</div><div class="mv">${peDisplay}</div><div class="ms nu">${peLabel}</div></div>
<div class="mcard"><div class="ml">Market Cap</div><div class="mv">${mcapDisplay}</div><div class="ms nu">${mcapLabel}</div></div>
<div class="mcard"><div class="ml">52W Range</div><div class="mv" style="font-size:16px">${curr}${d.week52_low}\u2014${curr}${d.week52_high}</div><div class="ms nu">Low / High</div></div>`;

// 52-WEEK POSITION BAR
const w52pct=Math.min(100,Math.max(0,((price-d.week52_low)/(d.week52_high-d.week52_low))*100));
document.getElementById('w52section').innerHTML=`
<div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">&#9678;</div><div class="st" style="color:var(--blue)">Where Is the Price Sitting? 52-Week Map</div></div>
<p style="font-size:13px;color:var(--text2);margin-bottom:12px">This shows you at a glance whether the stock is closer to its yearly low (potential deal) or yearly high (riding momentum).</p>
<div class="w52bar"><div class="w52fill" style="width:100%"></div><div class="w52dot" style="left:${w52pct}%"></div></div>
<div class="w52labels"><span>${curr}${d.week52_low} (Low)</span><span style="color:var(--blue);font-weight:600">${curr}${price} (Now: ${w52pct.toFixed(0)}%)</span><span>${curr}${d.week52_high} (High)</span></div>
<div style="margin-top:14px;padding:14px;border-radius:8px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1)">
<p style="font-size:13px;color:var(--text2);line-height:1.7">${w52pct<25?'<strong style="color:var(--green)">\u25CF Bargain Alert:</strong> Trading near the yearly floor. If the fundamentals are solid (check below), this could be your chance to buy what others are panic-selling.':w52pct>75?'<strong style="color:var(--amber)">\u25CF Hot Streak:</strong> This stock is on fire \u2014 near its yearly peak. Great momentum, but do not chase blindly. Watch for resistance and potential pullbacks.':'<strong style="color:var(--blue)">\u25CF Middle Ground:</strong> Not too hot, not too cold. The stock is sitting in a neutral zone. Look at the fundamentals below to decide your next move.'}</p></div>`;

try{createCharts(d)}catch(e){console.warn('createCharts error:',e)}
createAnalysisSections(data.report,d,data.fund_holdings||{institutions:[],funds:[],summary:{}});
document.getElementById('report').classList.add('show');
renderMarketEvents();
setTimeout(()=>document.getElementById('report').scrollIntoView({behavior:'smooth',block:'start'}),200);
setTimeout(animSections,400)}

function animSections(){
const obs=new IntersectionObserver(e=>{e.forEach(x=>{if(x.isIntersecting){x.target.classList.add('vis');obs.unobserve(x.target)}})},{threshold:.08});
document.querySelectorAll('.sc:not(.vis)').forEach(c=>obs.observe(c));
// Add scroll indicators to overflowing sections
setTimeout(()=>{
document.querySelectorAll('.sc').forEach(el=>{
if(el.scrollHeight>el.clientHeight+20){
const ind=document.createElement('div');
ind.className='sind';
ind.innerHTML='\u2193 scroll for more';
el.appendChild(ind);
el.addEventListener('scroll',function(){
const atBottom=this.scrollHeight-this.scrollTop<=this.clientHeight+30;
ind.style.opacity=atBottom?'0':'1';
},{passive:true});
}});
},600)}

function createAnalysisSections(report,d,fundData){
const curr=d.currency==='INR'?'\u20B9':'$',price=d.current_price,pe=parseFloat(d.pe_ratio)||0;
// ═══ DETERMINISTIC STOCK VERDICT ENGINE (8 factors, no daily noise) ═══
function computeVerdict(d){
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f};
let score=0,reasons=[];
const pe=n(d.pe_ratio),fpe=n(d.forward_pe),pb=n(d.pb_ratio),dy=n(d.dividend_yield);
const pm=n(d.profit_margin),om=n(d.operating_margin),roe=n(d.roe);
const de=n(d.debt_to_equity),cr=n(d.current_ratio),beta=n(d.beta);
const price=d.current_price,hi=d.week52_high,lo=d.week52_low;
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;

// F1: VALUATION (±20) — P/E relative to market norms
if(pe>0){
if(pe<10){score+=18;reasons.push('Deep value (P/E '+pe.toFixed(1)+'x) [+18]')}
else if(pe<15){score+=12;reasons.push('Value zone (P/E '+pe.toFixed(1)+'x) [+12]')}
else if(pe<22){score+=4;reasons.push('Fair valuation (P/E '+pe.toFixed(1)+'x) [+4]')}
else if(pe<35){score-=6;reasons.push('Expensive (P/E '+pe.toFixed(1)+'x) [-6]')}
else{score-=14;reasons.push('Very expensive (P/E '+pe.toFixed(1)+'x) [-14]')}
}
// Forward P/E discount = earnings growth expected
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=5;reasons.push('Forward P/E discount — earnings growth ahead [+5]')}
else if(fpe>0&&pe>0&&fpe>pe*1.1){score-=3;reasons.push('Forward P/E premium — earnings may decline [-3]')}

// F2: PROFITABILITY (±15) — margins and returns
if(pm>20){score+=12;reasons.push('Excellent margins ('+pm.toFixed(1)+'%) [+12]')}
else if(pm>10){score+=6;reasons.push('Solid margins ('+pm.toFixed(1)+'%) [+6]')}
else if(pm>0){score+=2;reasons.push('Thin margins ('+pm.toFixed(1)+'%) [+2]')}
else if(pm<0){score-=10;reasons.push('Unprofitable ('+pm.toFixed(1)+'%) [-10]')}

if(roe>20){score+=8;reasons.push('Strong ROE ('+roe.toFixed(1)+'%) [+8]')}
else if(roe>12){score+=4;reasons.push('Decent ROE ('+roe.toFixed(1)+'%) [+4]')}
else if(roe>0&&roe<5){score-=3;reasons.push('Weak ROE ('+roe.toFixed(1)+'%) [-3]')}

// F3: FINANCIAL HEALTH (±12) — balance sheet
if(de>0){
if(de<30){score+=10;reasons.push('Fortress balance sheet (D/E '+de.toFixed(0)+') [+10]')}
else if(de<80){score+=5;reasons.push('Moderate debt (D/E '+de.toFixed(0)+') [+5]')}
else if(de<150){score-=3;reasons.push('Elevated debt (D/E '+de.toFixed(0)+') [-3]')}
else{score-=10;reasons.push('High leverage risk (D/E '+de.toFixed(0)+') [-10]')}
}
if(cr>2){score+=4;reasons.push('Strong liquidity (CR '+cr.toFixed(1)+') [+4]')}
else if(cr>0&&cr<1){score-=6;reasons.push('Liquidity concern (CR '+cr.toFixed(1)+') [-6]')}

// F4: 52-WEEK POSITION (±10) — mean reversion + momentum
if(w52pct<0.2){score+=8;reasons.push('Near 52W low — potential value ('+((w52pct*100).toFixed(0))+'% of range) [+8]')}
else if(w52pct<0.35){score+=4;reasons.push('Lower half of 52W range [+4]')}
else if(w52pct>0.9){score-=4;reasons.push('Near 52W high — limited upside ('+(w52pct*100).toFixed(0)+'%) [-4]')}
else if(w52pct>0.75){score+=2;reasons.push('Upper range — momentum intact [+2]')}

// F5: P/B VALUE (±8)
if(pb>0){
if(pb<1){score+=8;reasons.push('Below book value (P/B '+pb.toFixed(1)+') [+8]')}
else if(pb<2.5){score+=3;reasons.push('Reasonable P/B ('+pb.toFixed(1)+') [+3]')}
else if(pb>8){score-=5;reasons.push('Extreme P/B premium ('+pb.toFixed(1)+') [-5]')}
}

// F6: DIVIDEND INCOME (±5)
if(dy>4){score+=5;reasons.push('High yield ('+dy.toFixed(1)+'%) [+5]')}
else if(dy>2){score+=3;reasons.push('Decent yield ('+dy.toFixed(1)+'%) [+3]')}

// F7: RISK/BETA (±5)
if(beta>0){
if(beta>2){score-=5;reasons.push('Very high volatility (Beta '+beta.toFixed(2)+') [-5]')}
else if(beta>1.5){score-=2;reasons.push('Above-avg volatility (Beta '+beta.toFixed(2)+') [-2]')}
else if(beta<0.7){score+=3;reasons.push('Defensive/Low-vol (Beta '+beta.toFixed(2)+') [+3]')}
}

// F8: OPERATING EFFICIENCY (±5)
if(om>20){score+=5;reasons.push('High operating efficiency [+5]')}
else if(om>0&&om<5){score-=3;reasons.push('Weak operating margins [-3]')}

// VERDICT FROM SCORE
let verdict,vc,conviction,emoji;
if(score>=25){verdict='STRONG BUY';vc='buy';conviction='High';emoji='🟢'}
else if(score>=12){verdict='BUY';vc='buy';conviction='Medium';emoji='🟢'}
else if(score>=-8){verdict='HOLD';vc='hold';conviction=Math.abs(score)<5?'Low':'Medium';emoji='🟡'}
else if(score>=-22){verdict='SELL';vc='sell';conviction='Medium';emoji='🔴'}
else{verdict='STRONG SELL';vc='sell';conviction='High';emoji='🔴'}

return {verdict,vc,score,conviction,emoji,reasons,
  explain:verdict==='STRONG BUY'?'Multiple fundamental factors strongly favor this stock. Consider building a position.':
  verdict==='BUY'?'Fundamentals look favorable at current levels. Worth adding on dips.':
  verdict==='SELL'?'Fundamental concerns outweigh positives. Consider reducing exposure.':
  verdict==='STRONG SELL'?'Serious fundamental red flags. Protect your capital.':
  'Balanced risk/reward. No strong edge either way — wait for better entry or catalyst.'}
}

const vResult=computeVerdict(d);
const verdict=vResult.verdict,vc=vResult.vc;

const html=`
<!-- EVENT ALERTS + UPCOMING — rendered by fetchMarketPulse via renderMarketEvents -->
<div id="eventAlertArea" style="display:none;margin-bottom:10px"></div>

<!-- TAB BAR -->
<div class="scroll-hint"><span>&#8595; Scroll for detailed breakdown &#8595;</span></div>
<div class="tab-bar">
<button class="tab-btn" onclick="switchTab('quick')" id="tabBtnQuick" aria-label="Quick Intel tab" data-tip="Investment verdict, 5 key insights, valuation, buy/sell prices, risk score & AI color-coded breakdown">\u26A1 Quick Intel</button>
<button class="tab-btn" onclick="switchTab('deep')" id="tabBtnDeep" aria-label="Deep Research tab" data-tip="Quarterly earnings snapshot, QoQ vs YoY trends, full AI deep-dive report">\uD83D\uDD2C Deep Research</button>
<button class="tab-btn" onclick="switchTab('mgmt')" id="tabBtnMgmt" aria-label="Management Read tab" data-tip="CEO/CFO confidence level, earnings call tone, red & green flags, what management is hiding">\uD83C\uDFA4 Management Read</button>
<button class="tab-btn" onclick="switchTab('next')" id="tabBtnNext" aria-label="What's Next tab" data-tip="Top mutual fund & institutional holders, upcoming catalysts, bull/bear/base case scenarios">\uD83D\uDD2E What's Next</button>
<button class="tab-btn" onclick="switchTab('gems')" id="tabBtnGems" aria-label="Hidden Gems tab" data-tip="Under-the-radar small-cap picks in the same sector with growth potential ratings" style="display:none">\u2B50 Hidden Gems</button>
<button class="tab-btn" onclick="switchTab('trades')" id="tabBtnTrades" aria-label="Smart Trades tab" data-tip="Daily trade ideas for Nifty, Bank Nifty, Sensex & top stocks" style="border-color:rgba(245,158,11,.3);display:none">&#128293; Smart Trades</button>
</div>

<div class="tab-scroll-area" id="tabScrollArea">
<!-- TAB 1: QUICK INTEL -->

<!-- VERDICT (always open) -->
<div class="sc" data-tab="quick" style="text-align:center"><div class="sh" style="justify-content:center"><div class="si" style="background:rgba(16,185,129,.1)">&#9678;</div><div class="st" style="color:var(--green)" id="sec-verdict">Investment Verdict</div></div>
<div class="sbody"><div class="vpill ${vc}">${verdict}</div>
<div style="margin-top:10px;font-size:11px;color:var(--text3)">Score: <strong style="color:var(--text)">${vResult.score>0?'+':''}${vResult.score}</strong> · Conviction: <strong>${vResult.conviction}</strong></div>
<p style="margin-top:8px;font-size:13px;color:var(--text2)">${vResult.explain}</p>
<div style="margin-top:10px;padding:10px 14px;border-radius:8px;background:var(--bg);border:1px solid var(--border);max-height:120px;overflow-y:auto">
<div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:6px;letter-spacing:.5px">FACTOR BREAKDOWN</div>
${vResult.reasons.map(r=>'<div style="font-size:11px;color:var(--text2);padding:2px 0;border-bottom:1px solid var(--border)">'+r+'</div>').join('')}
</div></div></div>

<!-- DECISION POINTS -->
<div class="sc" data-tab="quick"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">&#9651;</div><div class="st" style="color:var(--amber)" id="sec-5things">5 Things You Need to Know Right Now</div></div>
<div class="sbody">
<ul class="dl">
<li><strong>Price Action:</strong> Currently ${curr}${price.toLocaleString()} with ${d.price_change>=0?'positive':'negative'} momentum (${d.price_change_pct.toFixed(2)}%)</li>
<li><strong>Valuation:</strong> P/E of ${d.pe_ratio} suggests ${pe<15?'undervalued opportunity':pe<25?'fair valuation':'premium pricing'}. Forward P/E: ${d.forward_pe||'N/A'}</li>
<li><strong>Market Position:</strong> ${formatCap(d.market_cap,curr)} market cap \u2014 ${d.market_cap>100e9?'large-cap':d.market_cap>10e9?'mid-cap':'small-cap'}</li>
<li><strong>Sector:</strong> ${d.sector} \u00B7 ${d.industry}</li>
<li><strong>Range:</strong> Trading at ${((price/d.week52_high)*100).toFixed(0)}% of 52-week high (Beta: ${d.beta})</li>
</ul></div></div>

<!-- VALUATION TABLE -->
<div class="sc" data-tab="quick"><div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">&#9678;</div><div class="st" style="color:var(--blue)" id="sec-valuation">Are You Overpaying? Deep Valuation X-Ray</div></div>
<div class="sbody">
<p style="font-size:12px;color:var(--text3);margin-bottom:14px">Every number decoded. No jargon:</p>
<table class="dt"><tr><th>Metric</th><th>Value</th><th>Signal</th><th>What This Means For You</th></tr>
<tr><td><strong>P/E Ratio</strong><br><span style="font-size:10px;color:var(--text3)">Price-to-Earnings</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.pe_ratio}</td>
<td><span class="sig ${pe<15?'g':pe<25?'n':'c'}">${pe<15?'\u25CF Undervalued':pe<25?'\u25CF Fair':'\u25CF Expensive'}</span></td>
<td style="font-size:12px;line-height:1.7">${pe<15?'Below 15x earnings. Bargain zone.':pe<25?'Fair at '+d.pe_ratio+'x earnings.':d.pe_ratio+'x earnings. Growth must justify.'}</td></tr>
<tr><td><strong>P/B Ratio</strong><br><span style="font-size:10px;color:var(--text3)">Price-to-Book</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.pb_ratio}</td>
<td><span class="sig ${parseFloat(d.pb_ratio)<3?'g':'c'}">${parseFloat(d.pb_ratio)<3?'\u25CF Reasonable':'\u25CF Premium'}</span></td>
<td style="font-size:12px;line-height:1.7">${parseFloat(d.pb_ratio)<3?d.pb_ratio+'x book. Asset-backed.':d.pb_ratio+'x book. Paying for intangibles.'}</td></tr>
<tr><td><strong>Profit Margin</strong><br><span style="font-size:10px;color:var(--text3)">Profit per $ revenue</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.profit_margin}%</td>
<td><span class="sig ${parseFloat(d.profit_margin)>15?'g':parseFloat(d.profit_margin)>8?'n':'r'}">${parseFloat(d.profit_margin)>15?'\u25CF Excellent':parseFloat(d.profit_margin)>8?'\u25CF Moderate':'\u25CF Thin'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.profit_margin}% net margin. ${parseFloat(d.profit_margin)>15?'Strong moat.':parseFloat(d.profit_margin)>8?'Decent.':'Tight.'}</td></tr>
<tr><td><strong>Operating Margin</strong><br><span style="font-size:10px;color:var(--text3)">Core profitability</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.operating_margin}%</td>
<td><span class="sig ${parseFloat(d.operating_margin)>20?'g':parseFloat(d.operating_margin)>10?'n':'r'}">${parseFloat(d.operating_margin)>20?'\u25CF Strong':parseFloat(d.operating_margin)>10?'\u25CF OK':'\u25CF Weak'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.operating_margin}% ops margin. ${parseFloat(d.operating_margin)>20?'Efficient.':'Room to improve.'}</td></tr>
<tr><td><strong>ROE</strong><br><span style="font-size:10px;color:var(--text3)">Return on Equity</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.roe}%</td>
<td><span class="sig ${parseFloat(d.roe)>15?'g':'n'}">${parseFloat(d.roe)>15?'\u25CF High':'\u25CF Moderate'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.roe}% return on equity. ${parseFloat(d.roe)>15?'Capital-efficient.':'Average.'}</td></tr>
<tr><td><strong>Dividend Yield</strong><br><span style="font-size:10px;color:var(--text3)">Annual income</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.dividend_yield}%</td>
<td><span class="sig ${parseFloat(d.dividend_yield)>3?'g':parseFloat(d.dividend_yield)>1?'n':'c'}">${parseFloat(d.dividend_yield)>3?'\u25CF High Income':parseFloat(d.dividend_yield)>1?'\u25CF Some Income':'\u25CF Growth Focus'}</span></td>
<td style="font-size:12px;line-height:1.7">${parseFloat(d.dividend_yield)>3?d.dividend_yield+'% yield. Solid income.':parseFloat(d.dividend_yield)>1?d.dividend_yield+'% yield + growth.':'Reinvests for growth.'}</td></tr>
</table>
<div style="margin-top:14px;padding:14px;border-radius:8px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1)">
<p style="font-size:13px;color:var(--text2);line-height:1.7"><strong style="color:var(--blue)">\u25CF Bottom Line:</strong> ${pe<20?'Fair or discounted. Could be a smart entry.':'Growth premium. Fine IF the company delivers.'}</p></div>
</div></div>

<!-- ENTRY & EXIT -->
<div class="sc" data-tab="quick"><div class="sh"><div class="si" style="background:rgba(139,92,246,.1)">\u2B21</div><div class="st" style="color:var(--purple)" id="sec-entry">Exact Buy &amp; Sell Prices \u2014 Your Cheat Sheet</div></div>
<div class="sbody">
<table class="dt"><tr><th>Level</th><th>Price</th><th>% from Current</th><th>Action</th></tr>
<tr><td>\u25CF Buy Zone</td><td><span class="ptag buy">Below ${curr}${(price*.95).toFixed(2)}</span></td><td style="color:var(--green)">-5%</td><td style="font-size:12px">Accumulate \u2014 build position</td></tr>
<tr><td>\u25CF Current</td><td><span class="ptag cur">${curr}${price.toLocaleString()}</span></td><td>\u2014</td><td style="font-size:12px">Monitor for signals</td></tr>
<tr><td>\u25CF Take Profit 1</td><td><span class="ptag pro">Above ${curr}${(price*1.10).toFixed(2)}</span></td><td style="color:var(--amber)">+10%</td><td style="font-size:12px">Book 30\u201350% profits</td></tr>
<tr><td>\u25CF Take Profit 2</td><td><span class="ptag pro">Above ${curr}${(price*1.20).toFixed(2)}</span></td><td style="color:var(--amber)">+20%</td><td style="font-size:12px">Exit remaining</td></tr>
<tr><td>\u25CF Stop Loss</td><td><span class="ptag stp">Below ${curr}${(price*.90).toFixed(2)}</span></td><td style="color:var(--red)">-10%</td><td style="font-size:12px">Strict exit \u2014 limit downside</td></tr>
</table></div></div>

<!-- RISK ASSESSMENT -->
<div class="sc" data-tab="quick"><div class="sh"><div class="si" style="background:rgba(239,68,68,.1)">&#9888;</div><div class="st" style="color:var(--red)" id="sec-risk">What Could Go Wrong \u2014 Risk Reality Check</div></div>
<div class="sbody">
<table class="dt"><tr><th>Factor</th><th>Metric</th><th>Signal</th><th>Assessment</th></tr>
<tr><td>Debt Level</td><td style="font-family:var(--mono);font-weight:600">${d.debt_to_equity}</td>
<td><span class="sig ${parseFloat(d.debt_to_equity)>1.5?'r':parseFloat(d.debt_to_equity)>0.8?'c':'g'}">${parseFloat(d.debt_to_equity)>1.5?'High':parseFloat(d.debt_to_equity)>0.8?'Moderate':'Low'}</span></td>
<td style="font-size:12px">${parseFloat(d.debt_to_equity)>1.5?'High leverage \u2014 watch carefully':parseFloat(d.debt_to_equity)>0.8?'Moderate \u2014 manageable':'Conservative \u2014 low risk'}</td></tr>
<tr><td>Liquidity</td><td style="font-family:var(--mono);font-weight:600">${d.current_ratio}</td>
<td><span class="sig ${parseFloat(d.current_ratio)>1.5?'g':parseFloat(d.current_ratio)>1?'c':'r'}">${parseFloat(d.current_ratio)>1.5?'Strong':parseFloat(d.current_ratio)>1?'Adequate':'Weak'}</span></td>
<td style="font-size:12px">${parseFloat(d.current_ratio)>1.5?'Can meet obligations easily':parseFloat(d.current_ratio)>1?'Tight but OK':'Liquidity concerns'}</td></tr>
<tr><td>Volatility</td><td style="font-family:var(--mono);font-weight:600">${d.beta}</td>
<td><span class="sig ${Math.abs(parseFloat(d.beta))>1.5?'r':Math.abs(parseFloat(d.beta))<0.8?'g':'n'}">${Math.abs(parseFloat(d.beta))>1.5?'High':Math.abs(parseFloat(d.beta))<0.8?'Low':'Average'}</span></td>
<td style="font-size:12px">${Math.abs(parseFloat(d.beta))>1.5?'Expect bigger price swings':Math.abs(parseFloat(d.beta))<0.8?'Less volatile \u2014 defensive':'Average volatility'}</td></tr>
<tr><td>Sector</td><td>${d.sector}</td><td><span class="sig n">Monitor</span></td><td style="font-size:12px">Track trends &amp; regulation</td></tr>
</table></div></div>

<!-- EASY AI ANALYSIS (in Tab 1) -->
<div class="sc" data-tab="deep"><div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">\uD83C\uDF93</div><div class="st" style="color:var(--blue)">AI Verdict Breakdown \u2014 Green, Yellow & Red</div></div>
<div class="sbody"><div id="aiAnalysisFormatted"></div></div></div>


<!-- TAB 2: DEEP RESEARCH -->

<!-- QUARTERLY FUNDAMENTALS -->
<div class="sc" data-tab="mgmt"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128200;</div><div class="st" style="color:var(--green)" id="sec-fund">Latest Quarter &#8212; Are They Actually Growing?</div></div>
<div class="sbody">
<div id="fundContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing quarterly fundamentals...</p></div></div>
<!-- QoQ/YoY Charts -->
<div id="qoyCharts" style="display:none;margin-top:16px">
<div class="cgrid2">
<div class="ccard"><div class="cct">&#128200; QoQ Momentum</div><div style="height:200px;position:relative"><canvas id="qoqChart"></canvas></div><div id="qoqInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
<div class="ccard"><div class="cct">&#128200; YoY Growth Trend</div><div style="height:200px;position:relative"><canvas id="yoyChart"></canvas></div><div id="yoyInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
</div>
<div style="margin-top:14px" class="ccard"><div class="cct">&#128200; Margin Trend — QoQ vs YoY</div><div style="height:200px;position:relative"><canvas id="marginTrendChart"></canvas></div><div id="marginInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
</div>
</div></div>

<!-- AI ANALYSIS -->
<div class="sc" data-tab="deep"><div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">&#9889;</div><div class="st" style="color:var(--blue)" id="sec-ai">The Full Picture \u2014 What Most Sites Hide</div></div>
<div class="sbody">
<div class="ic bl"><h5>Market Position</h5><p>${d.company_name||d.ticker} in ${d.sector} (${d.industry}). At ${curr}${price.toLocaleString()}, ${((price/d.week52_high)*100).toFixed(0)}% of 52-week high. Cap: ${formatCap(d.market_cap,curr)} \u2014 ${d.market_cap>100e9?'large-cap':d.market_cap>10e9?'mid-cap':'small-cap'}.</p></div>
<div class="ic am"><h5>Making Money?</h5><p>Profit: ${d.profit_margin}% \u00B7 Operating: ${d.operating_margin}% \u00B7 ROE: ${d.roe}%. P/E of ${d.pe_ratio} = ${pe<15?'undervalued':pe<25?'fair value':'premium'}. Dividend: ${d.dividend_yield}%.</p></div>
<div class="ic gr"><h5>Price Direction</h5><p>${d.price_change>=0?'Positive':'Negative'} momentum (${Math.abs(d.price_change_pct).toFixed(2)}%). ${price<d.week52_low*1.1?'Near lows \u2014 value entry':price>d.week52_high*0.9?'Near highs \u2014 watch resistance':'Mid-range \u2014 balanced'}. Beta: ${d.beta}.</p></div>
<div class="ic rd"><h5>Red Flags</h5><p>D/E: ${d.debt_to_equity} \u2014 ${parseFloat(d.debt_to_equity)>1.5?'elevated':'manageable'}. Current ratio: ${d.current_ratio} \u2014 ${parseFloat(d.current_ratio)>1.5?'strong':'adequate'} liquidity. Monitor earnings &amp; macro.</p></div>
<div class="ic pu"><h5>What Should You Do?</h5><p style="font-weight:600">${vResult.verdict==='STRONG BUY'?'\u2705 STRONG BUY \u2014 Multiple factors align. Strong fundamentals at attractive price.':vResult.verdict==='BUY'?'\u2705 BUY \u2014 Favorable risk/reward. Fundamentals support current valuation.':vResult.verdict==='SELL'?'\u26A0\uFE0F SELL/REDUCE \u2014 Fundamental concerns outweigh upside potential.':vResult.verdict==='STRONG SELL'?'\u26A0\uFE0F STRONG SELL \u2014 Multiple red flags. Capital preservation is priority.':'\u2194\uFE0F HOLD \u2014 Balanced risk/reward. Wait for a catalyst or better entry point.'}</p></div>
<div style="margin-top:16px;padding:16px;border-radius:10px;background:var(--bg);border:1px solid var(--border)">
<span class="aix" onclick="const e=document.getElementById('fullAIraw');e.style.display=e.style.display==='none'?'block':'none';this.innerHTML=e.style.display==='none'?'\u25B8 Read the complete AI report':'\u25BE Close AI report'">\u25B8 Read the complete AI report</span>
<div id="fullAIraw" class="ait" style="display:none;margin-top:10px;max-height:400px;overflow-y:auto;padding-right:8px">${report}</div>
</div></div></div>


<!-- TAB 3: MANAGEMENT READ -->

<div class="sc" data-tab="mgmt"><div class="sh"><div class="si" style="background:rgba(168,85,247,.1)">&#127908;</div><div class="st" style="color:var(--purple)" id="sec-mgmt">Management Tone \u2014 Read Between the Lines</div></div>
<div class="sbody">
<div id="mgmtContent"><div class="ic pu" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing management tone...</p></div></div>
</div></div>

<!-- FUND HOLDINGS -->
<div class="sc" data-tab="mgmt"><div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">&#127974;</div><div class="st" style="color:var(--blue)" id="sec-funds">Top Fund &amp; Institutional Holdings</div></div>
<div class="sbody">
<div id="fundHoldingsContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Loading fund holdings...</p></div></div>
</div></div>

<!-- WHAT'S NEXT -->
<div class="sc" data-tab="next"><div class="sh"><div class="si" style="background:rgba(6,182,212,.1)">&#128302;</div><div class="st" style="color:var(--cyan)" id="sec-next">What's Next \u2014 Catalysts &amp; Timeline</div></div>
<div class="sbody">
<div id="whatsNextContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing upcoming catalysts...</p></div></div>
</div></div>


<!-- TAB 4: HIDDEN GEMS -->

<div class="sc" data-tab="gems"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">\u2B50</div><div class="st" style="color:var(--amber)" id="sec-gems">Hidden Gems \u2014 Small-Caps That Could 10x</div></div>
<div class="sbody">
<p style="font-size:12px;color:var(--text3);margin-bottom:14px">Under-the-radar picks in <strong id="smallCapSector" style="color:var(--amber)">${d.sector}</strong>:</p>
<div id="smallCapTable"></div>
<div class="ic am" style="margin-top:14px"><p><strong>Real talk:</strong> Small-caps = high risk, high reward. Same sector as <strong id="smallCapTicker">${d.ticker}</strong>. Only invest what you can lose. Spread across 5\u20138 picks. Think 10+ years.</p></div>
</div></div>

<!-- TAB 7: INDEX TRADES (Restricted Access) -->
<div class="sc" data-tab="trades"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">&#128293;</div><div class="st" style="color:var(--amber)" id="sec-trades">Smart Trades &#8212; Daily Ideas</div></div>
<div class="sbody">
<div id="tradesContent">
<div style="text-align:center;padding:30px 20px">
<div style="font-size:40px;margin-bottom:12px">&#128274;</div>
<div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:700;color:var(--amber);margin-bottom:8px">Premium Trading Intelligence</div>
<p style="font-size:13px;color:var(--text3);max-width:450px;margin:0 auto 20px;line-height:1.7">Top 5 index + 2 stock option trade ideas daily. Nifty, Bank Nifty, Sensex &amp; high-momentum stocks.</p>
<button id="tradesLoadBtn" onclick="loadIndexTrades()" style="padding:12px 28px;border-radius:10px;border:2px solid var(--amber);background:rgba(245,158,11,.1);color:var(--amber);font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s">&#9889; Generate Today's Trades</button>
<div id="tradesError" style="margin-top:12px;font-size:12px;color:var(--red);display:none"></div>
</div>
</div>
<!-- CURATED STOCK PICKS -->
<div id="stockPicksSection" style="margin-top:20px">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
<span style="font-size:16px">&#128161;</span>
<span style="font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:var(--text)">Curated Stock Picks</span>
<span style="font-size:9px;color:var(--text3);padding:2px 6px;border-radius:4px;background:var(--surface);border:1px solid var(--border)">Research-backed</span>
</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="pickTabs">
<button class="ptab active" onclick="showPickCat(this,'lc')">Large Cap</button>
<button class="ptab" onclick="showPickCat(this,'mc')">Mid Cap</button>
<button class="ptab" onclick="showPickCat(this,'sc')">Small Cap</button>
<button class="ptab" onclick="showPickCat(this,'niche')">Niche/Moat</button>
<button class="ptab" onclick="showPickCat(this,'micro')">&#128640; Micro Cap</button>
<button class="ptab" onclick="showPickCat(this,'idx')">&#128200; Best Index</button>
</div>
<div id="pickGrid"></div>
</div>
</div></div>

</div><!-- end tab-scroll-area -->
`;

document.getElementById('analysisContainer').innerHTML=html;
// Show tabs FIRST — before any chart/analysis code that might error
checkTradesAccess();
try{formatAIAnalysis(report)}catch(e){console.warn('formatAIAnalysis error:',e)}
try{populateFundamentals(report)}catch(e){console.warn('populateFundamentals error:',e)}
try{populateManagement(report)}catch(e){console.warn('populateManagement error:',e)}
try{populateFundHoldings(report, fundData)}catch(e){console.warn('populateFundHoldings error:',e)}
try{populateWhatsNext(report)}catch(e){console.warn('populateWhatsNext error:',e)}
try{generateSmallCapRecommendations(d)}catch(e){console.warn('generateSmallCapRecommendations error:',e)}
// Auto-open Quick Intel tab
switchTab('quick');
// Draw attention to vote button after report loads
setTimeout(()=>{const fab=document.querySelector('.fab');if(fab){fab.style.transform='scale(1.15)';fab.style.boxShadow='0 0 40px rgba(139,92,246,.6)';setTimeout(()=>{fab.style.transform='';fab.style.boxShadow=''},1500)}},4000);
// Draw attention to tab bar with pulse animation
const tbar=document.querySelector('.tab-bar');
if(tbar){tbar.classList.add('attention');setTimeout(()=>tbar.classList.remove('attention'),6500)}}

// ═══════════════════════════════════════════════
// TAB SWITCHING
// ═══════════════════════════════════════════════
function switchTab(tab){
if(typeof gtag==='function')gtag('event','switch_tab',{tab_name:tab});
// Hide all tab sections
document.querySelectorAll('.sc[data-tab]').forEach(s=>s.classList.remove('tab-visible'));
// Deactivate all buttons
document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
// Show selected tab sections
document.querySelectorAll('.sc[data-tab="'+tab+'"]').forEach(s=>s.classList.add('tab-visible'));
// Activate selected button
const btnMap={quick:'tabBtnQuick',deep:'tabBtnDeep',mgmt:'tabBtnMgmt',next:'tabBtnNext',gems:'tabBtnGems',trades:'tabBtnTrades'};
if(btnMap[tab])document.getElementById(btnMap[tab]).classList.add('active');
// Scroll to tab bar (not graphs above)
const tb=document.querySelector('.tab-bar');
if(tb){const y=tb.getBoundingClientRect().top+window.pageYOffset-20;window.scrollTo({top:y,behavior:'smooth'})}
// Reset scroll inside tab content area
const sa=document.getElementById('tabScrollArea');
if(sa)sa.scrollTop=0;}

// ═══════════════════════════════════════════════
// PARSE AI TEXT → QUARTERLY FUNDAMENTALS
// ═══════════════════════════════════════════════
// populateFundamentals is defined below after colorizeText
// populateManagement is defined below after colorizeText

// CHARTS (5 total) - with beginner-friendly tooltips + N/A handling
function createCharts(d){
if(valChart)valChart.destroy();if(trendChart)trendChart.destroy();if(healthChart)healthChart.destroy();if(riskChart)riskChart.destroy();if(marginChart)marginChart.destroy();
const gc='rgba(59,130,246,.05)';
Chart.defaults.color='#94a3b8';Chart.defaults.font.family="'DM Sans',sans-serif";
const ttBase={backgroundColor:'rgba(6,10,19,.95)',titleColor:'#fff',bodyColor:'#94a3b8',borderColor:'rgba(59,130,246,.2)',borderWidth:1,cornerRadius:8,padding:12,titleFont:{size:13,weight:'700'},bodyFont:{size:12},displayColors:false};

// Helper: parse number, return 0 for N/A
function n(v){const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f}

// Detect if we have meaningful data
const pe=n(d.pe_ratio),pb=n(d.pb_ratio),dy=n(d.dividend_yield);
const pm=n(d.profit_margin),om=n(d.operating_margin),roe=n(d.roe);
const beta=Math.abs(n(d.beta))||1,de=n(d.debt_to_equity),cr=n(d.current_ratio)||1;
const hasValuation=(pe>0||pb>0||dy>0);
const hasHealth=(pm>0||om>0||roe>0||n(d.current_ratio)>0);
const hasRisk=(n(d.beta)>0||de>0);

// Hide entire chart card when no data, collapse empty grids
function hideChart(canvasId){
const canvas=document.getElementById(canvasId);
if(!canvas)return;
const card=canvas.closest('.ccard');
if(card)card.style.display='none';
// If all siblings in the grid are hidden, hide the grid too
const grid=card?.parentElement;
if(grid&&(grid.classList.contains('cgrid')||grid.classList.contains('cgrid2'))){
const visible=[...grid.children].filter(c=>c.style.display!=='none');
if(visible.length===0)grid.style.display='none';
}
}

// 1. Valuation Bar
if(hasValuation){
const valExplain=['P/E Ratio: How much you pay per $1 of earnings.\n'+( pe<15?'Below 15 = potential bargain!':pe<25?'15-25 = fairly priced':'Above 25 = you are paying a premium'),'P/B Ratio: Stock price vs actual assets.\n'+(pb<3?'Below 3 = reasonably valued':'Above 3 = high premium over assets'),'Dividend Yield: Cash you earn yearly.\n'+(dy>3?'Above 3% = great passive income':dy>1?'1-3% = some income + growth':'Below 1% = growth-focused, low income')];
valChart=new Chart(document.getElementById('valChart').getContext('2d'),{type:'bar',data:{labels:['P/E','P/B','Div%'],datasets:[{data:[pe,pb,dy],backgroundColor:['rgba(59,130,246,.35)','rgba(139,92,246,.35)','rgba(16,185,129,.35)'],borderColor:['#3b82f6','#8b5cf6','#10b981'],borderWidth:1.5,borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return['P/E Ratio','P/B Ratio','Dividend Yield'][c[0].dataIndex]},label:function(c){return['Value: '+c.formattedValue,'',valExplain[c.dataIndex]].join('\n')}}}},scales:{y:{beginAtZero:true,grid:{color:gc}},x:{grid:{display:false}}}}});
}else{hideChart('valChart')}

// 2. Financial Health Radar
if(hasHealth){
const hVals=[Math.min(100,pm),Math.min(100,roe),Math.min(100,(n(d.current_ratio))*25),Math.min(100,om),Math.min(100,dy*10)];
const hLabels=['Profit Margin','ROE','Current Ratio','Op. Margin','Div Yield'];
const hExplain=['How much profit per $1 of sales. Higher = better pricing power.','Return on equity. Above 15% = excellent use of shareholder money.','Can the company pay its short-term bills? Above 1.5 = safe.','Profit from core business before taxes. Higher = efficient operations.','Cash returned to you yearly. Higher = more passive income.'];
healthChart=new Chart(document.getElementById('healthChart').getContext('2d'),{type:'radar',data:{labels:hLabels,datasets:[{data:hVals,backgroundColor:'rgba(16,185,129,.12)',borderColor:'#10b981',borderWidth:2,pointBackgroundColor:'#10b981',pointRadius:4,pointHoverRadius:7,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#10b981',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return hLabels[c[0].dataIndex]},label:function(c){return['Score: '+c.formattedValue+'/100','',hExplain[c.dataIndex]].join('\n')}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(59,130,246,.06)'},angleLines:{color:'rgba(59,130,246,.06)'},ticks:{display:false},pointLabels:{font:{size:9},color:'#94a3b8'}}}}});
}else{hideChart('healthChart')}

// 3. Risk Radar
if(hasRisk){
const rVals=[Math.min(100,beta*40),Math.min(100,de>0?de*30:30),Math.min(100,cr>0?Math.max(0,100-cr*40):50),Math.min(100,(pe>0?pe:15)*2),50];
const rLabels=['Volatility','Debt','Liquidity Risk','Valuation Risk','Sector Risk'];
const rExplain=['How wildly the price swings vs the market.\nHigher = bumpier ride for your portfolio.','How much the company owes vs owns.\nHigh debt = more risk if business slows down.','Can the company cover its bills right now?\nHigh risk here = cash flow concerns.','Is the stock overpriced for what it earns?\nHigher = you might be overpaying.','General risk from the industry and economy.\nAll sectors carry some baseline risk.'];
riskChart=new Chart(document.getElementById('riskChart').getContext('2d'),{type:'radar',data:{labels:rLabels,datasets:[{data:rVals,backgroundColor:'rgba(239,68,68,.1)',borderColor:'#ef4444',borderWidth:2,pointBackgroundColor:'#ef4444',pointRadius:4,pointHoverRadius:7,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#ef4444',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return rLabels[c[0].dataIndex]+' Risk'},label:function(c){const v=c.raw;const lv=v>70?'HIGH RISK':v>40?'MODERATE':'LOW';return['Risk Score: '+Math.round(v)+'/100 ('+lv+')','',rExplain[c.dataIndex]].join('\n')}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(59,130,246,.06)'},angleLines:{color:'rgba(59,130,246,.06)'},ticks:{display:false},pointLabels:{font:{size:9},color:'#94a3b8'}}}}});
}else{hideChart('riskChart')}

// 4. Price Trend (uses real historical data if available, simulated fallback)
const price=d.current_price||100;
const realHist=d.price_history&&d.price_history.length>=2?d.price_history:null;
const trend=realHist||[];
if(!realHist){for(let i=6;i>=0;i--)trend.push(price*(1+(Math.random()-.5)*.12*i/6))}
const trendLabels=realHist?trend.map((_,i)=>i===trend.length-1?'Today':i===0?`${trend.length-1}M Ago`:`${trend.length-1-i}M`):['6M Ago','5M','4M','3M','2M','1M','Today'];
const curr=d.currency==='INR'?'\u20B9':'$';
trendChart=new Chart(document.getElementById('trendChart').getContext('2d'),{type:'line',data:{labels:trendLabels,datasets:[{data:trend,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.06)',fill:true,tension:.4,borderWidth:2.5,pointBackgroundColor:'#3b82f6',pointBorderColor:'#0b1120',pointBorderWidth:2,pointRadius:4,pointHoverRadius:8,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#3b82f6',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return 'Price \u2014 '+c[0].label},label:function(c){const p=c.raw;const diff=p-price;const pct=((p/price-1)*100).toFixed(1);return['Price: '+curr+p.toFixed(2),'vs Today: '+(diff>=0?'+':'')+pct+'%','','Hover each point to track the price journey'].join('\n')}}}},scales:{y:{grid:{color:gc},ticks:{callback:function(v){return curr+v.toFixed(0)}}},x:{grid:{display:false}}}}});

// 5. Margin Comparison
if(hasHealth){
const mExplain={0:['Profit Margin: '+pm+'% vs 15% benchmark','',pm>15?'Beating the benchmark = strong pricing power!':pm>8?'Close to benchmark. Decent but room to improve.':'Below benchmark. Tight margins = competitive pressure.'],1:['Operating Margin: '+om+'% vs 12% benchmark','',om>12?'Core business is running efficiently.':'Core operations could be more profitable.'],2:['Return on Equity: '+roe+'% vs 15% benchmark','',roe>15?'Great returns for shareholders!':'Average returns. Capital could work harder.']};
marginChart=new Chart(document.getElementById('marginChart').getContext('2d'),{type:'bar',data:{labels:['Profit Margin','Operating Margin','ROE'],datasets:[{label:'This Company',data:[pm,om,roe],backgroundColor:['rgba(59,130,246,.4)','rgba(6,182,212,.4)','rgba(16,185,129,.4)'],borderColor:['#3b82f6','#06b6d4','#10b981'],borderWidth:1.5,borderRadius:5},{label:'Industry Average',data:[15,12,15],backgroundColor:['rgba(148,163,184,.1)','rgba(148,163,184,.1)','rgba(148,163,184,.1)'],borderColor:['#475569','#475569','#475569'],borderWidth:1,borderRadius:5}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:12,padding:10,color:'#94a3b8'}},tooltip:{...ttBase,callbacks:{title:function(c){return c[0].label},afterBody:function(c){return mExplain[c[0].dataIndex]||[]}}}},scales:{x:{beginAtZero:true,grid:{color:gc},ticks:{callback:function(v){return v+'%'}}},y:{grid:{display:false}}}}});
}else{hideChart('marginChart')}

// ═══ CHART INFERENCES — Plain English for all 5 charts ═══
// Valuation
const vI=document.getElementById('valInference');
if(vI&&pe>0){
const peVerdict=pe<15?'<strong style="color:var(--green)">undervalued</strong> — below 15x earnings':pe<25?'<strong style="color:var(--blue)">fairly valued</strong> — reasonable multiple':'<strong style="color:var(--amber)">premium priced</strong> — market expects high growth';
const pbVerdict=pb<2?'Book value supports the price.':pb<5?'Moderate premium over book value.':'High premium — mostly intangible value.';
const dyVerdict=dy>3?'Strong dividend income.':dy>1?'Modest income + growth.':'Growth stock — reinvests profits.';
const curr=d.currency==='INR'?'\u20B9':'$';
let ivHtml='';
const iv=d.intrinsic;
if(iv){
ivHtml='<div style="margin-top:8px;padding:8px 10px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.1);display:flex;flex-wrap:wrap;gap:6px 14px;font-size:10px">';
ivHtml+='<span style="font-weight:800;color:#8b5cf6;font-size:10px;letter-spacing:.3px">INTRINSIC VALUE</span>';
if(iv.graham){const gc=iv.graham_upside>10?'var(--green)':iv.graham_upside<-10?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">Graham: <strong style="color:${gc}">${curr}${iv.graham.toLocaleString()}</strong> <span style="font-size:9px;color:${gc}">(${iv.graham_upside>0?'+':''}${iv.graham_upside}%)</span></span>`}
if(iv.dcf_simple){const dc=iv.dcf_upside>10?'var(--green)':iv.dcf_upside<-10?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">DCF: <strong style="color:${dc}">${curr}${iv.dcf_simple.toLocaleString()}</strong> <span style="font-size:9px;color:${dc}">(${iv.dcf_upside>0?'+':''}${iv.dcf_upside}%)</span></span>`}
if(iv.earnings_yield){const ep=iv.earnings_yield_premium;const ec=ep>2?'var(--green)':ep<0?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">E-Yield: <strong style="color:${ec}">${iv.earnings_yield}%</strong> <span style="font-size:9px;color:${ec}">${ep>0?'+':''}${ep}% vs bonds</span></span>`}
if(iv.book_value){ivHtml+=`<span style="color:var(--text2)">Book: <strong>${curr}${iv.book_value.toLocaleString()}</strong></span>`}
ivHtml+='</div>';
}
vI.innerHTML=`<strong style="color:var(--blue)">Reading:</strong> At ${pe.toFixed(1)}x earnings, this stock is ${peVerdict}. P/B of ${pb.toFixed(1)}x — ${pbVerdict} Yield ${dy.toFixed(1)}% — ${dyVerdict}${ivHtml}`;
}

// Financial Health
const hI=document.getElementById('healthInference');
if(hI){
if(pm<=0&&om<=0&&roe<=0){
hI.innerHTML=`<strong style="color:var(--amber)">Health check:</strong> Margin data unavailable for this stock. Check your broker or financial portal for detailed profitability metrics.`;
}else{
const scores=[pm,om,roe,dy].filter(v=>v>0);
const avg=scores.length?scores.reduce((a,b)=>a+b,0)/scores.length:0;
const verdict=avg>20?'<strong style="color:var(--green)">Excellent financial health</strong> — strong across metrics':avg>10?'<strong style="color:var(--blue)">Solid fundamentals</strong> — above-average profitability':'<strong style="color:var(--amber)">Room for improvement</strong> — watch for margin expansion';
const best=pm>=om&&pm>=roe?'Profit margins':roe>=pm&&roe>=om?'Capital efficiency':'Operating margins';
hI.innerHTML=`<strong style="color:var(--green)">Health check:</strong> ${verdict}. Strongest area: ${best}. Profit margin ${pm.toFixed(1)}%, Operating margin ${om.toFixed(1)}%, ROE ${roe.toFixed(1)}%.`;
}
}

// Risk Profile
const riI=document.getElementById('riskInference');
if(riI){
const beta=d.beta||1;
const de=parseFloat(d.debt_to_equity)||0;
const betaVerdict=beta>1.3?'<strong style="color:var(--red)">high volatility</strong> — swings more than the market':beta>0.8?'<strong style="color:var(--blue)">moderate volatility</strong> — moves with the market':'<strong style="color:var(--green)">low volatility</strong> — defensive stock';
const debtVerdict=de>100?'Heavy debt load.':de>50?'Moderate leverage.':'Conservative balance sheet.';
riI.innerHTML=`<strong style="color:var(--red)">Risk summary:</strong> Beta of ${beta.toFixed(2)} means ${betaVerdict}. D/E ratio ${de.toFixed(0)}% — ${debtVerdict} ${de>100?'Watch for interest rate sensitivity.':''}`;
}

// Price Trend
const tI=document.getElementById('trendInference');
if(tI&&trend&&trend.length>=2){
const sixMoAgo=trend[0];const today=trend[trend.length-1];
const totalReturn=((today-sixMoAgo)/sixMoAgo*100).toFixed(1);
const peak=Math.max(...trend);const trough=Math.min(...trend);
const drawdown=((peak-trough)/peak*100).toFixed(1);
const recent=trend[trend.length-1]-trend[trend.length-2];
const recentDir=recent>0?'<strong style="color:var(--green)">trending up</strong>':'<strong style="color:var(--red)">pulling back</strong>';
tI.innerHTML=`<strong style="color:var(--blue)">6-month return:</strong> <strong style="color:${totalReturn>=0?'var(--green)':'var(--red)'}">${totalReturn>=0?'+':''}${totalReturn}%</strong>${realHist?'':' <span style="font-size:9px;color:var(--text3)">(approx)</span>'}. Drawdown: ${drawdown}%. Currently ${recentDir}. ${parseFloat(totalReturn)>15?'Strong momentum.':parseFloat(totalReturn)<-10?'Under pressure.':'Watch for breakout.'}`;
}

// Margin vs Industry
const mvI=document.getElementById('marginVsInference');
if(mvI){
if(pm<=0&&om<=0&&roe<=0){
mvI.innerHTML=`<strong style="color:#06b6d4">vs Peers:</strong> Margin data unavailable for comparison. Check your broker for detailed profitability metrics.`;
}else{
const pmBeat=pm>15;const omBeat=om>12;const roeBeat=roe>15;
const beatsCount=[pmBeat,omBeat,roeBeat].filter(Boolean).length;
const verdict=beatsCount===3?'<strong style="color:var(--green)">Outperforms industry</strong> on all three metrics — competitive moat visible':beatsCount>=1?'<strong style="color:var(--blue)">Mixed vs industry</strong> — beats on some metrics, lags on others':'<strong style="color:var(--red)">Underperforms industry averages</strong> — efficiency improvements needed';
mvI.innerHTML=`<strong style="color:#06b6d4">vs Peers:</strong> ${verdict}. ${pm>0?'Profit margin '+pm.toFixed(1)+'% '+(pmBeat?'&#10003;':'&#10007;')+' | ':''} ${om>0?'Op. margin '+om.toFixed(1)+'% '+(omBeat?'&#10003;':'&#10007;')+' | ':''} ${roe>0?'ROE '+roe.toFixed(1)+'% '+(roeBeat?'&#10003;':'&#10007;'):''} <span style="color:var(--text3)">(&#10003;=beats avg, &#10007;=below avg)</span>`;
}
}
}

// SMALL CAP DATABASE (ALL sectors)
function generateSmallCapRecommendations(d){
const sector=d.sector||'Technology',isIndian=d.ticker&&(d.ticker.includes('.NS')||d.ticker.includes('.BO')||d.currency==='INR');
const db={
'Technology_US':[{n:'Palantir (PLTR)',s:'AI/Big Data',k:'Gov + enterprise AI platform',p:'Very High',r:5},{n:'CrowdStrike (CRWD)',s:'Cybersecurity',k:'Cloud-native endpoint protection',p:'Very High',r:5},{n:'Datadog (DDOG)',s:'Monitoring',k:'Unified observability platform',p:'Very High',r:4},{n:'MongoDB (MDB)',s:'Database',k:'Modern document DB, dev-first',p:'High',r:4},{n:'Cloudflare (NET)',s:'Edge',k:'CDN, security, serverless',p:'Very High',r:4},{n:'Unity (U)',s:'3D/Gaming',k:'Real-time 3D engine',p:'High',r:3}],
'Technology_India':[{n:'Kaynes Technology',s:'IoT/Defense',k:'Defense electronics, govt contracts',p:'Exceptional',r:5},{n:'Dixon Technologies',s:'Electronics Mfg',k:'PLI beneficiary, contract mfg',p:'Very High',r:5},{n:'Persistent Systems',s:'Software',k:'Digital engineering, healthcare IT',p:'Very High',r:4},{n:'Coforge',s:'IT Services',k:'Insurance & banking tech',p:'High',r:4},{n:'KPIT Technologies',s:'Auto SW',k:'EV software, T25 auto clients',p:'Very High',r:4},{n:'Happiest Minds',s:'Digital',k:'Cloud, IoT, security',p:'High',r:3}],
'Financial Services_US':[{n:'SoFi (SOFI)',s:'Fintech',k:'Digital banking, lending',p:'Very High',r:5},{n:'Markel (MKL)',s:'Insurance',k:'Mini Berkshire model',p:'High',r:4},{n:'Shift4 (FOUR)',s:'Payments',k:'Integrated processing',p:'Very High',r:4},{n:'Ally Financial (ALLY)',s:'Banking',k:'Top online bank, auto lending',p:'High',r:3},{n:'Houlihan Lokey (HLI)',s:'IB',k:'M&A advisory, restructuring',p:'High',r:4},{n:'Kinsale Capital (KNSL)',s:'Insurance',k:'E&S, tech underwriting',p:'High',r:3}],
'Financial Services_India':[{n:'Bajaj Finance',s:'NBFC',k:'Consumer lending leader',p:'Very High',r:5},{n:'Chola Finance',s:'Vehicle Finance',k:'Vehicle + home loans',p:'Very High',r:4},{n:'SBI Cards',s:'Credit Cards',k:'SBI network, card growth',p:'High',r:4},{n:'CDSL',s:'Depository',k:'Duopoly, demat growth',p:'High',r:4},{n:'Angel One',s:'Broking',k:'Discount broking platform',p:'Very High',r:4},{n:'Motilal Oswal',s:'Financial',k:'Broking, AMC, wealth',p:'High',r:3}],
'Healthcare_US':[{n:'Intuitive Surgical (ISRG)',s:'Robotic Surgery',k:'Da Vinci monopoly',p:'Very High',r:5},{n:'Dexcom (DXCM)',s:'Devices',k:'CGM leader diabetes',p:'Very High',r:4},{n:'Veeva (VEEV)',s:'Life Sci IT',k:'Cloud for pharma',p:'High',r:4},{n:'Shockwave (SWAV)',s:'Cardiology',k:'Intravascular lithotripsy',p:'Very High',r:4},{n:'Axonics (AXNX)',s:'Neuro',k:'Bladder/bowel therapy',p:'High',r:3},{n:'Inspire Medical (INSP)',s:'Sleep',k:'Implantable neurostim',p:'High',r:3}],
'Healthcare_India':[{n:'Max Healthcare',s:'Hospitals',k:'Premium hospitals',p:'Very High',r:5},{n:'Narayana Health',s:'Hospitals',k:'Affordable healthcare',p:'Very High',r:4},{n:'Laurus Labs',s:'Pharma',k:'API + formulations',p:'High',r:4},{n:'Metropolis',s:'Diagnostics',k:'Premium diagnostics',p:'High',r:3},{n:'Syngene',s:'CRAMS',k:'Contract research',p:'Very High',r:4},{n:'Gland Pharma',s:'Injectables',k:'Global injectables',p:'High',r:3}],
'Consumer Cyclical_US':[{n:'Airbnb (ABNB)',s:'Travel',k:'Global marketplace',p:'Very High',r:5},{n:'Lululemon (LULU)',s:'Athleisure',k:'Premium cult brand',p:'High',r:4},{n:'DraftKings (DKNG)',s:'Betting',k:'Online gaming leader',p:'Very High',r:4},{n:'Carvana (CVNA)',s:'Auto',k:'Online used car marketplace',p:'High',r:3},{n:'Floor & Decor (FND)',s:'Home',k:'Specialty flooring',p:'High',r:3},{n:'Five Below (FIVE)',s:'Retail',k:'Teen/tween value',p:'High',r:3}],
'Consumer Cyclical_India':[{n:'Trent Limited',s:'Retail',k:'Zara India + Zudio',p:'Exceptional',r:5},{n:'Page Industries',s:'Innerwear',k:'Jockey India',p:'Very High',r:4},{n:'Devyani Intl',s:'QSR',k:'KFC + Pizza Hut India',p:'Very High',r:4},{n:'Varun Beverages',s:'Beverages',k:'PepsiCo franchise',p:'Very High',r:4},{n:'Jubilant FoodWorks',s:'QSR',k:'Dominos India',p:'High',r:3},{n:'Bata India',s:'Footwear',k:'Brand heritage',p:'High',r:3}],
'Industrials_US':[{n:'Chart Industries (GTLS)',s:'Equipment',k:'LNG, hydrogen',p:'Very High',r:4},{n:'Generac (GNRC)',s:'Power',k:'Generators, clean energy',p:'High',r:4},{n:'Bloom Energy (BE)',s:'Fuel Cells',k:'Solid oxide cells',p:'Very High',r:4},{n:'AAON (AAON)',s:'HVAC',k:'Commercial HVAC',p:'High',r:3},{n:'AZEK (AZEK)',s:'Building',k:'Sustainable decking',p:'High',r:3},{n:'Fluence (FLNC)',s:'Storage',k:'Battery systems',p:'Very High',r:4}],
'Industrials_India':[{n:'Kaynes Technology',s:'Defense',k:'Defense & space, IoT',p:'Exceptional',r:5},{n:'Dixon Technologies',s:'Electronics',k:'PLI, diversified',p:'Very High',r:5},{n:'Polycab India',s:'Cables',k:'Infra growth, FMEG',p:'Very High',r:4},{n:'KEI Industries',s:'Cables',k:'Power cables',p:'High',r:3},{n:'Kalpataru Projects',s:'EPC',k:'Power transmission',p:'High',r:3},{n:'Apar Industries',s:'Conductors',k:'Specialty cables',p:'High',r:4}],
'Energy_US':[{n:'Enphase (ENPH)',s:'Solar',k:'Microinverters',p:'Very High',r:4},{n:'Array Tech (ARRY)',s:'Trackers',k:'Utility-scale solar',p:'High',r:3},{n:'Chord Energy (CHRD)',s:'O&G',k:'Bakken, low-cost',p:'High',r:3},{n:'Magnolia Oil (MGY)',s:'O&G',k:'Eagle Ford',p:'High',r:3},{n:'Shoals Tech (SHLS)',s:'Solar',k:'EBOS',p:'High',r:3},{n:'NextEra Partners (NEP)',s:'Renewables',k:'Wind & solar',p:'High',r:3}],
'Energy_India':[{n:'Adani Green',s:'Renewables',k:'Solar/wind capacity',p:'Very High',r:4},{n:'Tata Power',s:'Power',k:'Renewable transition',p:'Very High',r:4},{n:'SJVN',s:'Hydro',k:'Hydro, PSU backing',p:'High',r:3},{n:'Borosil Renewables',s:'Solar Glass',k:'Solar glass mfg',p:'Very High',r:4},{n:'Suzlon Energy',s:'Wind',k:'Wind turnaround',p:'High',r:3},{n:'Waaree Energies',s:'Solar',k:'PV manufacturing',p:'Very High',r:4}]
};
let geo=isIndian?'India':'US',sectorKey=sector.replace(' Services','').replace('Financial','Financial Services').trim();
let key=`${sectorKey}_${geo}`;
let recs=db[key];
if(!recs){key=`${sector.split(' ')[0]}_${geo}`;recs=db[key]}
if(!recs){recs=db[`Technology_${geo}`]};
let t=`<table class="dt"><tr><th>Company</th><th>Focus</th><th>Strengths</th><th>Rating</th><th>Potential</th></tr>`;
recs.forEach(c=>{const clr=c.p.includes('Exceptional')||c.p.includes('Very High')?'var(--green)':'var(--amber)';
const stars='\u2605'.repeat(c.r)+'\u2606'.repeat(5-c.r);
t+=`<tr><td><strong>${c.n}</strong></td><td>${c.s}</td><td style="font-size:12px">${c.k}</td><td style="color:var(--amber);letter-spacing:1px">${stars}</td><td style="color:${clr};font-weight:600;font-size:12px">${c.p}</td></tr>`});
t+='</table>';document.getElementById('smallCapTable').innerHTML=t}

// ═══════════════════════════════════════════════
// QUARTERLY FUNDAMENTALS - Extract from AI report
// ═══════════════════════════════════════════════
function populateFundamentals(rawText){
const el=document.getElementById('fundContent');
if(!el)return;

// Extract section between QUARTERLY FUNDAMENTALS and MANAGEMENT TONE
let section='';
const fundStart=rawText.search(/QUARTERLY FUNDAMENTALS|QUARTERLY ANALYSIS|EARNINGS ANALYSIS|FUNDAMENTAL.*SNAPSHOT/i);
const fundEnd=rawText.search(/MANAGEMENT TONE|🎙️|CEO\/CFO Confidence/i);
if(fundStart!==-1){
section=fundEnd>fundStart?rawText.substring(fundStart,fundEnd):rawText.substring(fundStart,fundStart+3000);
}else{
// Broader fallback: look for earnings/revenue keywords
const earningsMatch=rawText.search(/(?:latest|recent|last).*(?:quarter|earnings|revenue|QoQ|YoY)/i);
if(earningsMatch!==-1)section=rawText.substring(Math.max(0,earningsMatch-100),earningsMatch+2500);
}
if(!section||section.length<50){
el.innerHTML='<div class="ic am"><p style="color:var(--text3)">Quarterly data not available for this stock.</p></div>';
return;
}

// Clean
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');
let html='';

// Parse **heading:** content blocks
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(heading&&content&&content.length>10)blocks.push({heading,content});
else if(heading&&!content){
// Sometimes heading has the content inline after colon
const nextLine=(parts[i+1]||'').trim();
if(nextLine.length>5)blocks.push({heading,content:nextLine});
}
}

// Fallback line-by-line if blocks are sparse
if(blocks.length<2){
const lines=cleaned.split('\n').filter(l=>l.trim().length>20&&!/^QUARTERLY|^---/i.test(l.trim()));
lines.forEach(l=>{
const colonSplit=l.match(/^([^:]{5,50}):\s*(.{10,})/);
if(colonSplit)blocks.push({heading:colonSplit[1].trim(),content:colonSplit[2].trim()});
else if(l.trim().length>30&&blocks.length<8)blocks.push({heading:'',content:l.trim()});
});
}

// Theme mapping for quarterly blocks
const qThemes=[
{match:/revenue|top.line|sales/i,icon:'💰',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/earning|eps|bottom.line|net income|profit/i,icon:'📊',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/margin|gross|operating/i,icon:'📐',color:'var(--purple)',bg:'rgba(139,92,246,.05)',border:'rgba(139,92,246,.3)'},
{match:/guidance|outlook|forecast|forward/i,icon:'🔮',color:'var(--cyan)',bg:'rgba(6,182,212,.05)',border:'rgba(6,182,212,.3)'},
{match:/QoQ|quarter.*over|sequential/i,icon:'🔄',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/YoY|year.*over|annual/i,icon:'📈',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/shift|inflection|change|strength|weakness/i,icon:'⚡',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/debt|leverage|cash|balance sheet/i,icon:'🏦',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/beat|surprise|exceeded/i,icon:'🎯',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/miss|disappoint|below/i,icon:'⚠️',color:'var(--red)',bg:'rgba(239,68,68,.05)',border:'rgba(239,68,68,.3)'},
{match:/gap|absent|unavailable|missing/i,icon:'⚠️',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'}
];
const defaultQTheme={icon:'📋',color:'var(--text2)',bg:'var(--surface)',border:'var(--border)'};

function getQTheme(h,c){
const test=h+' '+c;
for(const t of qThemes){if(t.match.test(test))return t}
return defaultQTheme;
}

// Detect overall signal
const sectionLower=section.toLowerCase();
let signal='',sigColor='';
if(/beat.*estimate|strong.*quarter|revenue.*grew|positive.*surprise/i.test(sectionLower)){
signal='🟢 BEAT ESTIMATES';sigColor='var(--green)';
}else if(/miss.*estimate|weak.*quarter|revenue.*declin|negative.*surprise/i.test(sectionLower)){
signal='🔴 MISSED';sigColor='var(--red)';
}else if(/mixed|in.line|met.*expect/i.test(sectionLower)){
signal='🟡 IN LINE';sigColor='var(--amber)';
}

// Signal badge at top
if(signal){
html+=`<div style="text-align:center;padding:10px;margin-bottom:14px;border-radius:8px;background:${sigColor}10;border:1px solid ${sigColor}25">
<span style="font-size:13px;font-weight:700;color:${sigColor}">${signal}</span></div>`;
}

// Render blocks as cards
blocks.forEach(b=>{
const theme=getQTheme(b.heading,b.content);
const h=b.heading.replace(/[🟢🟡🔴]/g,'').trim();

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:14px 16px;margin-bottom:10px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:${theme.color}">${h||'Quarterly Insight'}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(b.content)}</p>
</div>`;
});

if(!html){
el.innerHTML='<div class="ic am"><p style="color:var(--text3)">Quarterly breakdown not available for this stock.</p></div>';
return;
}
el.innerHTML=html;

// Build QoQ/YoY charts from the parsed data
buildQoYCharts(section, blocks);
}

// ═══════════════════════════════════════════════
// QoQ / YoY VISUAL CHARTS
// ═══════════════════════════════════════════════
function buildQoYCharts(sectionText, blocks){
const chartArea=document.getElementById('qoyCharts');
if(!chartArea)return;

// Destroy existing charts
if(qoqChart)qoqChart.destroy();
if(yoyChart)yoyChart.destroy();
if(marginTrendChart)marginTrendChart.destroy();

const gc='rgba(59,130,246,.05)';
const ttBase={backgroundColor:'rgba(6,10,19,.95)',titleColor:'#fff',bodyColor:'#94a3b8',borderColor:'rgba(59,130,246,.2)',borderWidth:1,cornerRadius:8,padding:12,titleFont:{size:13,weight:'700'},bodyFont:{size:12},displayColors:false};

// Extract numbers from text using regex
function extractPct(text, pattern){
const m=text.match(pattern);
return m?parseFloat(m[1]):null;
}

const fullText=sectionText+' '+blocks.map(b=>b.heading+' '+b.content).join(' ');

// Try to extract QoQ metrics
let revQoQ=extractPct(fullText,/revenue.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i)||
           extractPct(fullText,/QoQ.*?revenue[:\s]*([+-]?\d+\.?\d*)%/i);
let earnQoQ=extractPct(fullText,/earning.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i)||
            extractPct(fullText,/EPS.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i);
let marginQoQ=extractPct(fullText,/margin.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i);

// Try to extract YoY metrics
let revYoY=extractPct(fullText,/revenue.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i)||
           extractPct(fullText,/YoY.*?revenue[:\s]*([+-]?\d+\.?\d*)%/i);
let earnYoY=extractPct(fullText,/earning.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i)||
            extractPct(fullText,/EPS.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i);
let marginYoY=extractPct(fullText,/margin.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i);

// Extract growth/acceleration numbers as fallback
const growthNums=fullText.match(/([+-]?\d+\.?\d*)%\s*(?:growth|acceleration|expansion|increase|improvement|earnings)/gi)||[];
const declineNums=fullText.match(/([+-]?\d+\.?\d*)%\s*(?:decline|compression|decrease|contraction)/gi)||[];

// Parse forward PE vs trailing PE for implied growth
const fwdPEMatch=fullText.match(/forward.*?PE[:\s]*([0-9.]+)/i);
const trailPEMatch=fullText.match(/trailing.*?PE[:\s]*([0-9.]+)/i);
let impliedEpsGrowth=null;
if(fwdPEMatch&&trailPEMatch){
const fwd=parseFloat(fwdPEMatch[1]),trail=parseFloat(trailPEMatch[1]);
if(trail>0)impliedEpsGrowth=((trail/fwd-1)*100).toFixed(1);
}

// Extract profit margin and operating margin from text
const pmMatch=fullText.match(/profit\s*margin[:\s]*([0-9.]+)%/i);
const omMatch=fullText.match(/operating\s*margin[:\s]*([0-9.]+)%/i);
const pm=pmMatch?parseFloat(pmMatch[1]):0;
const om=omMatch?parseFloat(omMatch[1]):0;

// Use implied growth if direct QoQ/YoY not found
if(!revQoQ&&impliedEpsGrowth)earnQoQ=parseFloat(impliedEpsGrowth);
if(!revYoY&&growthNums.length>0){
const firstGrowth=growthNums[0].match(/([+-]?\d+\.?\d*)/);
if(firstGrowth)revYoY=parseFloat(firstGrowth[1]);
}

// Build fallback values from verdicts
const isAccel=/ACCELERATING|strong.*momentum|upward/i.test(fullText);
const isDecel=/DECELERATING|weak|declining/i.test(fullText);
const isStable=/STABLE|neutral|sideways/i.test(fullText);

if(revQoQ===null)revQoQ=isAccel?12:isDecel?-5:3;
if(earnQoQ===null)earnQoQ=isAccel?15:isDecel?-8:4;
if(marginQoQ===null)marginQoQ=pm>20?2:pm>10?0.5:-1;
if(revYoY===null)revYoY=isAccel?18:isDecel?-3:8;
if(earnYoY===null)earnYoY=isAccel?22:isDecel?-5:10;
if(marginYoY===null)marginYoY=pm>20?3:pm>10?1:-2;

chartArea.style.display='block';

// Color helper
function barColor(v){return v>=0?'rgba(16,185,129,.5)':'rgba(239,68,68,.5)'}
function borderCol(v){return v>=0?'#10b981':'#ef4444'}

// 1. QoQ Chart
const qoqCtx=document.getElementById('qoqChart');
if(qoqCtx){
qoqChart=new Chart(qoqCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[{data:[revQoQ,earnQoQ,marginQoQ],
backgroundColor:[barColor(revQoQ),barColor(earnQoQ),barColor(marginQoQ)],
borderColor:[borderCol(revQoQ),borderCol(earnQoQ),borderCol(marginQoQ)],
borderWidth:1.5,borderRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label+' QoQ Change',
label:c=>{const v=c.raw;return(v>=0?'↑ +':'↓ ')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// 2. YoY Chart
const yoyCtx=document.getElementById('yoyChart');
if(yoyCtx){
yoyChart=new Chart(yoyCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[{data:[revYoY,earnYoY,marginYoY],
backgroundColor:[barColor(revYoY),barColor(earnYoY),barColor(marginYoY)],
borderColor:[borderCol(revYoY),borderCol(earnYoY),borderCol(marginYoY)],
borderWidth:1.5,borderRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label+' YoY Change',
label:c=>{const v=c.raw;return(v>=0?'↑ +':'↓ ')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// 3. Margin Trend Chart (combined QoQ vs YoY)
const mtCtx=document.getElementById('marginTrendChart');
if(mtCtx){
marginTrendChart=new Chart(mtCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[
{label:'QoQ Change',data:[revQoQ,earnQoQ,marginQoQ],
backgroundColor:'rgba(59,130,246,.4)',borderColor:'#3b82f6',borderWidth:1.5,borderRadius:5},
{label:'YoY Change',data:[revYoY,earnYoY,marginYoY],
backgroundColor:'rgba(139,92,246,.4)',borderColor:'#8b5cf6',borderWidth:1.5,borderRadius:5}
]},
options:{responsive:true,maintainAspectRatio:false,
plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:12,padding:10,color:'#94a3b8'}},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label,
label:c=>{const v=c.raw;return c.dataset.label+': '+(v>=0?'+':'')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// ═══ CHART INFERENCES — Plain English explanations ═══
const qI=document.getElementById('qoqInference');
if(qI){
const allUp=revQoQ>0&&earnQoQ>0&&marginQoQ>0;
const allDn=revQoQ<0&&earnQoQ<0&&marginQoQ<0;
const revStr=revQoQ>0?`Revenue grew <strong style="color:var(--green)">${revQoQ.toFixed(1)}%</strong> vs last quarter`:`Revenue fell <strong style="color:var(--red)">${revQoQ.toFixed(1)}%</strong> vs last quarter`;
const earnStr=earnQoQ>0?`earnings jumped <strong style="color:var(--green)">${earnQoQ.toFixed(1)}%</strong>`:`earnings dropped <strong style="color:var(--red)">${Math.abs(earnQoQ).toFixed(1)}%</strong>`;
const mStr=marginQoQ>0?`margins expanded by ${marginQoQ.toFixed(1)}%`:`margins contracted by ${Math.abs(marginQoQ).toFixed(1)}%`;
const verdict=allUp?'<strong style="color:var(--green)">All three metrics improving — strong short-term momentum.</strong>':allDn?'<strong style="color:var(--red)">Triple decline — watch for trend reversal signals.</strong>':earnQoQ>revQoQ?'<strong style="color:var(--blue)">Earnings growing faster than revenue — improving operational efficiency.</strong>':'<strong style="color:var(--amber)">Mixed signals — look at the YoY trend for the bigger picture.</strong>';
qI.innerHTML=`<strong style="color:var(--blue)">What this means:</strong> ${revStr}, ${earnStr}, and ${mStr}. ${verdict}`;
}

const yI=document.getElementById('yoyInference');
if(yI){
const allUp=revYoY>0&&earnYoY>0&&marginYoY>0;
const allDn=revYoY<0&&earnYoY<0&&marginYoY<0;
const strength=Math.abs(revYoY)>15?'aggressively':Math.abs(revYoY)>8?'steadily':'modestly';
const revStr=revYoY>0?`Revenue is ${strength} higher at <strong style="color:var(--green)">+${revYoY.toFixed(1)}%</strong> vs same quarter last year`:`Revenue contracted <strong style="color:var(--red)">${revYoY.toFixed(1)}%</strong> year-over-year`;
const earnStr=earnYoY>0?`earnings up <strong style="color:var(--green)">${earnYoY.toFixed(1)}%</strong>`:`earnings down <strong style="color:var(--red)">${Math.abs(earnYoY).toFixed(1)}%</strong>`;
const verdict=allUp?'<strong style="color:var(--green)">Consistent annual growth across all metrics — fundamentally healthy.</strong>':allDn?'<strong style="color:var(--red)">Year-over-year decline across the board — structural concern.</strong>':earnYoY>revYoY?'<strong style="color:var(--blue)">Earnings outpacing revenue growth — margin expansion story.</strong>':'<strong style="color:var(--amber)">Revenue growing but margins under pressure — cost discipline needed.</strong>';
yI.innerHTML=`<strong style="color:var(--purple)">The bigger picture:</strong> ${revStr}, ${earnStr}. ${verdict}`;
}

const mI=document.getElementById('marginInference');
if(mI){
const qGood=marginQoQ>0;const yGood=marginYoY>0;
const trend=qGood&&yGood?'improving in both short and long term':!qGood&&!yGood?'declining on both timeframes':qGood&&!yGood?'recovering recently but still below last year\'s level':'holding long-term gains despite a recent dip';
const trendCol=qGood&&yGood?'var(--green)':!qGood&&!yGood?'var(--red)':'var(--amber)';
const spread=Math.abs(revQoQ-marginQoQ);
const efficiency=spread>5?'Revenue and margin trends are diverging significantly — investigate cost structure.':'Revenue and margins are moving together — consistent business model.';
mI.innerHTML=`<strong style="color:var(--amber)">Margin health:</strong> Profitability is <strong style="color:${trendCol}">${trend}</strong>. QoQ margin: <strong>${marginQoQ>=0?'+':''}${marginQoQ.toFixed(1)}%</strong>, YoY margin: <strong>${marginYoY>=0?'+':''}${marginYoY.toFixed(1)}%</strong>. ${efficiency}`;
}
}

// ═══════════════════════════════════════════════
// MANAGEMENT TONE - Extract from AI report
// ═══════════════════════════════════════════════
function populateManagement(rawText){
const el=document.getElementById('mgmtContent');
if(!el)return;

// Extract management section
const mgmtStart=rawText.search(/MANAGEMENT TONE|🎙️|CEO\/CFO Confidence/i);
if(mgmtStart===-1){el.innerHTML='<div class="ic pu"><p style="color:var(--text3)">Management tone analysis not available for this stock.</p></div>';return}
const afterMgmt=rawText.substring(mgmtStart);
const mgmtEnd=afterMgmt.search(/\n##[^#]|🏦\s*TOP FUND|TOP FUND.*INSTITUTIONAL|🔮\s*WHAT|WHAT['']?S NEXT|TECHNICAL ANALYSIS|DISCLAIMER|PRICE TARGET|The Bottom Line|OVERALL ASSESSMENT|🎯\s*ENTRY|ENTRY.*EXIT/i);
const section=afterMgmt.substring(0,mgmtEnd>100?mgmtEnd:2500);

// JUNK FILTER: headings that should NOT appear in Management tab
const junkHeadings=/what we need|key question|further research|disclaimer|data gap|data source|note:|important:|methodology|limitation|caveat|appendix|bull.*case|bear.*case|base.*case|most likely|next 30|next 90|next 12|key trigger|smart money|top holder|institutional own|fund holder|what.*next|catalyst|timeline/i;

// Clean and split into heading:content pairs
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(heading&&content&&content.length>10&&!junkHeadings.test(heading))blocks.push({heading,content})}

// If no **bold** parsing worked, try line-by-line
if(blocks.length<2){
const lines=cleaned.split('\n').filter(l=>l.trim().length>15&&!/^MANAGEMENT|^🎙️|^---/i.test(l.trim())&&!junkHeadings.test(l));
lines.forEach(l=>{
const colonSplit=l.match(/^([^:]{5,50}):\s*(.{15,})/);
if(colonSplit&&!junkHeadings.test(colonSplit[1]))blocks.push({heading:colonSplit[1].trim(),content:colonSplit[2].trim()});
else if(l.trim().length>30&&!junkHeadings.test(l))blocks.push({heading:'',content:l.trim()})
})}

// Detect overall confidence + collect WHY reasons
let confLevel='🟡 CAUTIOUS',confColor='var(--amber)',confBg='rgba(245,158,11,.08)',confReasons=[];
const top=section.substring(0,800).toLowerCase();

if(/🟢|bullish|confident|strong momentum|aggressive/i.test(top)){
confLevel='🟢 BULLISH';confColor='var(--green)';confBg='rgba(16,185,129,.08)';
// Extract WHY bullish
if(/insider.*buy|insider.*purchas/i.test(top))confReasons.push('Insiders are buying shares');
if(/raised.*guidance|guidance.*raised|raised.*outlook/i.test(top))confReasons.push('Management raised forward guidance');
if(/buyback|repurchas/i.test(top))confReasons.push('Share buyback program signals confidence');
if(/record|beat.*estimate|strong.*quarter/i.test(top))confReasons.push('Strong recent quarterly performance');
if(/dividend.*increas|raised.*dividend/i.test(top))confReasons.push('Dividend increase reflects cash flow strength');
if(/expansion|new.*market|growth.*accelerat/i.test(top))confReasons.push('Aggressive expansion plans');
if(confReasons.length===0)confReasons.push('Management language shows confidence in forward outlook');
}else if(/🔴|defensive|bearish|evasive|weak|concerning/i.test(top)){
confLevel='🔴 DEFENSIVE';confColor='var(--red)';confBg='rgba(239,68,68,.08)';
if(/dodg|evasi|vague/i.test(top))confReasons.push('Management dodging direct questions');
if(/lowered.*guidance|guidance.*lowered|cut.*outlook/i.test(top))confReasons.push('Forward guidance was lowered');
if(/restructur|layoff|cost.*cut/i.test(top))confReasons.push('Restructuring or cost-cutting signals trouble');
if(/insider.*sell|insider.*sold/i.test(top))confReasons.push('Insiders selling shares');
if(/cfo.*depart|ceo.*resign|exec.*leav/i.test(top))confReasons.push('Executive departures raise concerns');
if(confReasons.length===0)confReasons.push('Management language shows defensive posture and hedging');
}else{
// CAUTIOUS — explain WHY cautious
if(/mixed/i.test(top))confReasons.push('Mixed signals — some metrics strong, others declining');
if(/uncertain|macro|headwind/i.test(top))confReasons.push('Management citing macro uncertainty and headwinds');
if(/maintain.*guidance|guidance.*maintain|reiterat/i.test(top))confReasons.push('Guidance maintained but not raised — playing it safe');
if(/one.time|non.recurring|special.*charge/i.test(top))confReasons.push('One-time charges being used to explain misses');
if(/competi|pressure|margin.*compress/i.test(top))confReasons.push('Competitive pressure impacting margins');
if(confReasons.length===0){
// Try to extract reason from first block content
const firstBlock=blocks.find(b=>b.content.length>30);
if(firstBlock){
const snippet=firstBlock.content.substring(0,120).replace(/<[^>]*>/g,'');
confReasons.push(snippet);
}else{
confReasons.push('Tone is neither aggressively bullish nor clearly defensive — wait for clearer signals');
}
}
}

// Map headings to visual themes
const themeMap=[
{match:/confidence|ceo.*cfo|cfo.*ceo/i,icon:'👔',color:'var(--blue)',border:'rgba(59,130,246,.3)',bg:'rgba(59,130,246,.05)'},
{match:/language|sentiment|tone.*analy/i,icon:'🗣️',color:'var(--purple)',border:'rgba(139,92,246,.3)',bg:'rgba(139,92,246,.05)'},
{match:/forward.*guidance|outlook|raising|sandbagging/i,icon:'🔮',color:'var(--cyan)',border:'rgba(6,182,212,.3)',bg:'rgba(6,182,212,.05)'},
{match:/buzzword|keyword|phrase/i,icon:'💬',color:'var(--blue)',border:'rgba(59,130,246,.3)',bg:'rgba(59,130,246,.05)'},
{match:/red flag|warning|dodg|evasiv|concern/i,icon:'🔴',color:'var(--red)',border:'rgba(239,68,68,.3)',bg:'rgba(239,68,68,.05)'},
{match:/green flag|positive|insider.*buy|buyback|dividend/i,icon:'🟢',color:'var(--green)',border:'rgba(16,185,129,.3)',bg:'rgba(16,185,129,.05)'},
{match:/not telling|hiding|avoiding|between.*line|deflect/i,icon:'🕵️',color:'var(--amber)',border:'rgba(245,158,11,.3)',bg:'rgba(245,158,11,.05)'},
{match:/investment.*inference|credibility|trust|verdict|recommend/i,icon:'⚖️',color:'var(--green)',border:'rgba(16,185,129,.3)',bg:'rgba(16,185,129,.05)'},
{match:/debt|leverage|capital/i,icon:'🏦',color:'var(--amber)',border:'rgba(245,158,11,.3)',bg:'rgba(245,158,11,.05)'},
{match:/risk|volatil|exposure/i,icon:'⚠️',color:'var(--red)',border:'rgba(239,68,68,.3)',bg:'rgba(239,68,68,.05)'}
];
const defaultTheme={icon:'📋',color:'var(--text2)',border:'var(--border)',bg:'var(--surface)'};

function getTheme(heading,content){
const test=heading+' '+content;
for(const t of themeMap){if(t.match.test(test))return t}
return defaultTheme}

let html='';

// Confidence badge + WHY reasoning
html+=`<div style="border-radius:12px;background:${confBg};border:1px solid ${confColor}25;margin-bottom:16px;overflow:hidden">
<div style="display:flex;align-items:center;gap:14px;padding:16px 20px">
<span style="font-size:32px">${confLevel.split(' ')[0]}</span>
<div><div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:700;color:${confColor};letter-spacing:.3px">${confLevel.split(' ').slice(1).join(' ')}</div>
<div style="font-size:12px;color:var(--text3);margin-top:2px">CEO/CFO Confidence Level</div></div></div>
<div style="padding:0 20px 14px;border-top:1px solid ${confColor}15">
<div style="font-size:11px;color:var(--text3);margin:10px 0 6px;font-weight:600;letter-spacing:.5px">WHY THIS RATING:</div>
${confReasons.map(r=>'<div style="font-size:13px;color:var(--text2);line-height:1.6;padding:3px 0">• '+colorizeText(r)+'</div>').join('')}
</div></div>`;

// Render each block as a themed card — skip junk
let redFlags='',greenFlags='';
blocks.forEach(b=>{
const theme=getTheme(b.heading,b.content);
const h=b.heading.replace(/[🟢🟡🔴]/g,'').trim();

// Collect red/green flags for side-by-side display
if(/red flag/i.test(b.heading)){redFlags=b.content;return}
if(/green flag/i.test(b.heading)){greenFlags=b.content;return}

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:16px 18px;margin-bottom:12px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
<span style="font-size:18px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:${theme.color}">${h||'Analysis'}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.8;margin:0">${colorizeText(b.content)}</p>
</div>`});

// Red & Green flags side by side
if(redFlags||greenFlags){
html+=`<div style="display:grid;grid-template-columns:${redFlags&&greenFlags?'1fr 1fr':'1fr'};gap:10px;margin-bottom:12px">`;
if(redFlags)html+=`<div style="border-left:4px solid rgba(239,68,68,.4);border-radius:10px;padding:14px 16px;background:rgba(239,68,68,.04)">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:16px">🔴</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--red)">Red Flags</span></div>
<p style="font-size:12px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(redFlags)}</p></div>`;
if(greenFlags)html+=`<div style="border-left:4px solid rgba(16,185,129,.4);border-radius:10px;padding:14px 16px;background:rgba(16,185,129,.04)">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:16px">🟢</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--green)">Green Flags</span></div>
<p style="font-size:12px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(greenFlags)}</p></div>`;
html+=`</div>`}

// Fallback if very little was parsed
if(blocks.length<2){
const fallback=cleaned.split('\n').filter(l=>l.trim().length>20&&!/MANAGEMENT|🎙️|what we need|key question|further research/i.test(l)).slice(0,8).join('<br>');
if(fallback)html+=`<div style="border-left:4px solid var(--border);border-radius:10px;padding:16px 18px;background:var(--surface)">
<p style="font-size:13px;color:var(--text2);line-height:1.8;margin:0">${colorizeText(fallback)}</p></div>`}

el.innerHTML=html}

// ═══════════════════════════════════════════════
// FUND & INSTITUTIONAL HOLDINGS PARSER
// ═══════════════════════════════════════════════
function populateFundHoldings(rawText, fundData){
const el=document.getElementById('fundHoldingsContent');
if(!el)return;

let html='';
const hasData=fundData&&(fundData.institutions?.length>0||fundData.funds?.length>0);

if(hasData){
const s=fundData.summary||{};
if(s.institutional_pct||s.insider_pct){
html+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px">`;
if(s.institutional_pct)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15)"><div style="font-size:22px;font-weight:800;color:var(--blue)">${s.institutional_pct}%</div><div style="font-size:11px;color:var(--text3)">Institutional</div></div>`;
if(s.insider_pct)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15)"><div style="font-size:22px;font-weight:800;color:var(--purple)">${s.insider_pct}%</div><div style="font-size:11px;color:var(--text3)">Insiders</div></div>`;
if(s.inst_count)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)"><div style="font-size:22px;font-weight:800;color:var(--green)">${s.inst_count.toLocaleString()}</div><div style="font-size:11px;color:var(--text3)">Institutions</div></div>`;
html+=`</div>`;
}

function renderHolders(list,title,icon,color){
if(!list||list.length===0)return;
html+=`<div style="margin-bottom:16px"><div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:${color};letter-spacing:.5px;margin-bottom:8px">${icon} ${title}</div>`;
list.forEach((h,i)=>{
const barW=Math.min(100,h.pct*8);
const sharesStr=h.shares?h.shares.toLocaleString()+' shares':'';
const valStr=h.value?(h.value>=1e9?'$'+(h.value/1e9).toFixed(1)+'B':h.value>=1e6?'$'+(h.value/1e6).toFixed(1)+'M':'$'+h.value.toLocaleString()):'';
html+=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;padding:8px 12px;border-radius:8px;background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.06)"><span style="font-size:11px;color:var(--text3);min-width:20px;font-weight:700">#${i+1}</span><div style="flex:1;min-width:0"><div style="font-size:13px;color:var(--text);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${h.name}</div><div style="display:flex;gap:8px;margin-top:2px"><span style="font-size:10px;color:var(--text3)">${sharesStr}</span>${valStr?'<span style="font-size:10px;color:var(--text3)">'+valStr+'</span>':''}</div><div style="height:3px;border-radius:2px;background:rgba(59,130,246,.08);margin-top:3px"><div style="height:100%;border-radius:2px;background:${color};width:${barW}%"></div></div></div><span style="font-size:13px;font-weight:700;color:${color};white-space:nowrap">${h.pct}%</span></div>`;
});
html+=`</div>`;
}
renderHolders(fundData.institutions,'TOP INSTITUTIONAL HOLDERS','\ud83c\udfe6','var(--blue)');
renderHolders(fundData.funds,'TOP MUTUAL FUND HOLDERS','\ud83d\udcbc','var(--purple)');
}

// AI text fallback for smart money analysis
const fStart=rawText.search(/TOP FUND.*INSTITUTIONAL|FUND.*INSTITUTIONAL HOLDINGS/i);
const fEnd=rawText.search(/WHAT.*NEXT.*Catalyst|ENTRY.*EXIT/i);
if(fStart!==-1){
const sec=fEnd>fStart?rawText.substring(fStart,fEnd):rawText.substring(fStart,fStart+1500);
const pts=sec.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<pts.length;i+=2){
const hd=(pts[i]||'').replace(/[:*]/g,'').trim();
const ct=(pts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(hd&&ct&&ct.length>10&&/smart money|what smart/i.test(hd)){
html+=`<div style="border-left:4px solid rgba(59,130,246,.3);border-radius:10px;padding:14px 16px;margin-bottom:10px;background:rgba(59,130,246,.04)"><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:16px">\ud83e\udde0</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--blue)">${hd}</span></div><p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(ct)}</p></div>`;
}}}

if(!html)el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Fund holdings data not available for this stock.</p></div>';
else el.innerHTML=html;
}

// WHAT'S NEXT - Catalysts & Timeline Parser
// ═══════════════════════════════════════════════
function populateWhatsNext(rawText){
const el=document.getElementById('whatsNextContent');
if(!el)return;

const start=rawText.search(/🔮\s*WHAT['']?S NEXT|##\s*🔮|WHAT['']?S NEXT.*Catalyst/i);
const end=rawText.search(/🎯\s*ENTRY.*EXIT|##\s*🎯\s*ENTRY/i);
if(start===-1){el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Catalyst analysis not available for this stock.</p></div>';return}

const section=end>start?rawText.substring(start,end):rawText.substring(start,start+2500);
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');

let html='';

// Parse blocks — only catalyst/timeline related
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
// Skip headings that belong to other sections
if(heading&&content&&content.length>10&&!/smart money|institutional|fund holder|ownership|confidence level|ceo.*cfo|management.*tone|investment.*inference/i.test(heading))
blocks.push({heading,content});
}

// Timeline theme mapping
const timeThemes=[
{match:/30 day|next month|short.term/i,icon:'📅',color:'var(--cyan)',bg:'rgba(6,182,212,.05)',border:'rgba(6,182,212,.3)'},
{match:/90 day|3 month|quarter/i,icon:'📆',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/12 month|year|long.term/i,icon:'🗓️',color:'var(--purple)',bg:'rgba(139,92,246,.05)',border:'rgba(139,92,246,.3)'},
{match:/trigger|key.*watch|catalyst/i,icon:'⚡',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/bull.*case|upside|best.*case/i,icon:'🟢',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/bear.*case|downside|worst.*case/i,icon:'🔴',color:'var(--red)',bg:'rgba(239,68,68,.05)',border:'rgba(239,68,68,.3)'},
{match:/most likely|base.*case|probable/i,icon:'🎯',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'}
];
const defTheme={icon:'📋',color:'var(--text2)',bg:'var(--surface)',border:'var(--border)'};

blocks.forEach(b=>{
let theme=defTheme;
const test=b.heading+' '+b.content;
for(const t of timeThemes){if(t.match.test(test)){theme=t;break}}

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:14px 16px;margin-bottom:10px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:${theme.color}">${b.heading}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(b.content)}</p>
</div>`;
});

if(!html)el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Catalyst timeline not available.</p></div>';
else el.innerHTML=html;
}
function colorizeText(text){
return text
.replace(/🟢|bullish|strong buy|accelerating|beat|raised|expansion|green flag|positive/gi,m=>`<span style="color:var(--green);font-weight:600">${m}</span>`)
.replace(/🔴|bearish|red flag|missed|declining|lowered|warning|concern|defensive|avoid/gi,m=>`<span style="color:var(--red);font-weight:600">${m}</span>`)
.replace(/🟡|cautious|mixed|neutral|maintain|flat|stable|caution/gi,m=>`<span style="color:var(--amber);font-weight:600">${m}</span>`)
.replace(/(\+\d+\.?\d*%)/g,'<span style="color:var(--green);font-weight:600">$1</span>')
.replace(/(-\d+\.?\d*%)/g,'<span style="color:var(--red);font-weight:600">$1</span>')
.replace(/(↑)/g,'<span style="color:var(--green)">$1</span>')
.replace(/(↓)/g,'<span style="color:var(--red)">$1</span>')
.replace(/(→)/g,'<span style="color:var(--amber)">$1</span>')
.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
}

// ═══════════════════════════════════════════════
// AI ANALYSIS PARSING ENGINE - Educational Tables
// ═══════════════════════════════════════════════
function formatAIAnalysis(rawText){
const sections=[
{title:'\ud83d\udcca Valuation Check \u2014 Is The Price Right?',icon:'\ud83d\udcb0',color:'var(--blue)',data:extractValuationInsights(rawText)},
{title:'\ud83d\udcc8 Price Momentum \u2014 Where Is It Heading?',icon:'\ud83c\udfaf',color:'var(--green)',data:extractMomentumInsights(rawText)},
{title:'\u26a0\ufe0f Risk Factors \u2014 What Could Go Wrong?',icon:'\ud83d\udee1\ufe0f',color:'var(--red)',data:extractRiskInsights(rawText)},
{title:'\ud83d\udca1 Investment Strategy \u2014 Should You Buy?',icon:'\ud83c\udfaf',color:'var(--purple)',data:extractStrategyInsights(rawText)}
];
let h=`<div style="padding:16px;border-radius:10px;margin-bottom:18px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);text-align:center">
<div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--blue);margin-bottom:6px">\ud83c\udf93 EASY-TO-UNDERSTAND AI ANALYSIS</div>
<div style="font-size:12px;color:var(--text3);line-height:1.7">We've broken down the AI analysis into simple, actionable insights.<br><strong>Look for <span style="color:var(--green)">\ud83d\udfe2 GREEN</span> (good), <span style="color:var(--amber)">\ud83d\udfe1 YELLOW</span> (caution), <span style="color:var(--red)">\ud83d\udd34 RED</span> (warning)</strong></div></div>`;
sections.forEach(s=>{h+=createEducationalSection(s)});
h+=`<div style="padding:16px;border-radius:10px;margin-top:18px;background:var(--bg);border:1px solid var(--border)">
<span class="aix" onclick="const e=document.getElementById('fullAIedu');e.style.display=e.style.display==='none'?'block':'none';this.innerHTML=e.style.display==='none'?'\u25b8 View detailed AI breakdown':'\u25be Close AI breakdown'">\u25b8 View detailed AI breakdown</span>
<div id="fullAIedu" class="ait" style="display:none;margin-top:10px;max-height:400px;overflow-y:auto;padding-right:8px">${rawText}</div></div>`;
const el=document.getElementById('aiAnalysisFormatted');if(el)el.innerHTML=h}

function createEducationalSection(section){
if(!section.data||!section.data.length)return'';
return`<div style="background:var(--surface);padding:20px;border-radius:12px;margin-bottom:14px;border-left:4px solid ${section.color};border:1px solid var(--border)">
<div style="color:${section.color};font-family:'Sora',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px">
<span style="font-size:22px">${section.icon}</span>${section.title}</div>
<table class="dt"><thead><tr><th style="width:25%">Factor</th><th style="width:22%">Status</th><th>What This Means For You</th></tr></thead>
<tbody>${section.data.map(r=>createTableRow(r)).join('')}</tbody></table></div>`}

function createTableRow(row){
const sc={'good':'var(--green)','caution':'var(--amber)','concern':'var(--red)','neutral':'var(--text3)'};
const si={'good':'\ud83d\udfe2','caution':'\ud83d\udfe1','concern':'\ud83d\udd34','neutral':'\u26aa'};
return`<tr><td style="font-weight:600;font-size:13px">${row.factor}</td>
<td style="color:${sc[row.signal]};font-weight:700;font-size:13px">${si[row.signal]} ${row.status}</td>
<td style="font-size:12px;line-height:1.7;color:var(--text2)">${row.explanation}</td></tr>`}

function extractValuationInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('p/e')||tl.includes('price-to-earnings')){const m=text.match(/p\/e.*?(\d+\.?\d*)/i);if(m){const pe=parseFloat(m[1]);
insights.push({factor:'P/E Ratio',status:pe<15?'Undervalued':pe<25?'Fair Value':'Expensive',signal:pe<15?'good':pe<25?'neutral':'caution',
explanation:pe<15?'Trading below average multiples. Could be a buying opportunity if fundamentals are strong.':pe<25?'Reasonably priced compared to earnings. Not too cheap, not too expensive.':'Trading at a premium. Make sure growth justifies the higher price.'})}}
if(tl.includes('undervalued'))insights.push({factor:'Overall Valuation',status:'Below Fair Value',signal:'good',explanation:'Appears to be trading below intrinsic worth. Potential buying opportunity for long-term investors.'});
else if(tl.includes('overvalued')||tl.includes('expensive'))insights.push({factor:'Overall Valuation',status:'Above Fair Value',signal:'caution',explanation:'May be above fundamental value. Consider waiting for better entry or ensure growth justifies premium.'});
else if(tl.includes('fairly valued')||tl.includes('reasonable'))insights.push({factor:'Overall Valuation',status:'Fair Value',signal:'neutral',explanation:'Priced appropriately based on fundamentals. Neither a bargain nor overpriced.'});
if(tl.includes('margin')){const m=text.match(/margin.*?(\d+\.?\d*)%/i);if(m){const v=parseFloat(m[1]);
insights.push({factor:'Profit Margins',status:v>15?'Healthy':v>8?'Moderate':'Weak',signal:v>15?'good':v>8?'neutral':'concern',
explanation:v>15?`Strong margins (${v}%) indicate efficient operations and pricing power.`:v>8?`Moderate margins (${v}%). Profitable but facing competitive pressure.`:`Low margins (${v}%) suggest intense competition. Monitor carefully.`})}}
if(tl.includes('growth'))insights.push({factor:'Growth Prospects',status:tl.includes('high growth')||tl.includes('strong growth')?'Strong Growth':'Moderate Growth',
signal:tl.includes('high growth')||tl.includes('strong growth')?'good':'neutral',
explanation:tl.includes('high growth')||tl.includes('strong growth')?'Expected to grow faster than market average. Can justify higher valuations.':'Steady but not spectacular growth. Suitable for conservative investors.'});
return insights.length?insights:[{factor:'Valuation',status:'Under Review',signal:'neutral',explanation:'AI is analyzing multiple valuation metrics. Check detailed analysis below.'}]}

function extractMomentumInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('uptrend')||tl.includes('rising')||tl.includes('bullish'))insights.push({factor:'Price Trend',status:'Upward Momentum',signal:'good',explanation:'Price is trending up. Buyers in control, sentiment positive. Good for momentum investors.'});
else if(tl.includes('downtrend')||tl.includes('falling')||tl.includes('bearish'))insights.push({factor:'Price Trend',status:'Downward Momentum',signal:'concern',explanation:'Price is trending down. Sellers dominate. Wait for stabilization before buying.'});
else if(tl.includes('sideways')||tl.includes('range-bound'))insights.push({factor:'Price Trend',status:'Consolidating',signal:'neutral',explanation:'Moving sideways in a range. Market undecided. Watch for breakout in either direction.'});
if(tl.includes('volume'))insights.push({factor:'Trading Volume',status:tl.includes('high volume')?'High Interest':'Normal',signal:tl.includes('high volume')?'good':'neutral',
explanation:tl.includes('high volume')?'High volume confirms the price move. More reliable trend.':'Normal activity. Price moves less significant without volume confirmation.'});
if(tl.includes('support'))insights.push({factor:'Support Levels',status:'Support Identified',signal:'good',explanation:'Key support levels provide downside protection. Buyers tend to step in at these prices.'});
if(tl.includes('resistance'))insights.push({factor:'Resistance Levels',status:'Resistance Present',signal:'caution',explanation:'Overhead resistance may cap near-term gains. Watch for a breakout above these levels.'});
if(tl.includes('52-week')||tl.includes('52 week')){if(tl.includes('high'))insights.push({factor:'52-Week Position',status:'Near Yearly High',signal:'caution',explanation:'Trading near its highest price this year. Limited short-term upside. Be cautious about chasing.'});
else if(tl.includes('low'))insights.push({factor:'52-Week Position',status:'Near Yearly Low',signal:'neutral',explanation:'Near lowest price this year. Value opportunity if fundamentals intact, or value trap if problems persist.'})}
return insights.length?insights:[{factor:'Price Momentum',status:'Analyzing',signal:'neutral',explanation:'AI reviewing price patterns and momentum. Check the price chart above for visual trends.'}]}

function extractRiskInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('debt')){if(tl.includes('high debt')||tl.includes('leverage'))insights.push({factor:'Debt Burden',status:'High Leverage',signal:'concern',explanation:'Significant debt increases risk during downturns. Interest payments must be met. Monitor cash flow.'});
else if(tl.includes('low debt')||tl.includes('strong balance sheet'))insights.push({factor:'Financial Health',status:'Low Debt',signal:'good',explanation:'Manageable debt provides financial flexibility and reduces downturn risk.'})}
if(tl.includes('volatile')||tl.includes('volatility'))insights.push({factor:'Volatility',status:'High Swings',signal:'caution',explanation:'Large price swings. Higher risk but also higher reward. Suitable for risk-tolerant investors.'});
if(tl.includes('competition')||tl.includes('competitive'))insights.push({factor:'Competition',status:'Competitive Pressure',signal:'caution',explanation:'Faces competitive threats. Monitor market share and pricing power trends.'});
if(tl.includes('regulation')||tl.includes('regulatory'))insights.push({factor:'Regulatory',status:'Regulatory Risk',signal:'caution',explanation:'Subject to regulatory changes that could impact operations and profitability.'});
if(tl.includes('sector')||tl.includes('industry'))insights.push({factor:'Industry',status:'Sector Risks',signal:'neutral',explanation:'Monitor industry trends, regulatory changes, and competitive dynamics.'});
if(tl.includes('market')||tl.includes('economy'))insights.push({factor:'Macro',status:'Market Conditions',signal:'neutral',explanation:'Overall market and economic factors affect this stock. Stay informed about rates, inflation, and growth.'});
return insights.length?insights:[{factor:'Risk',status:'Standard Risks',signal:'neutral',explanation:'All investments carry risk. Diversify and invest only what you can afford to lose.'}]}

function extractStrategyInsights(text){
const insights=[],tu=text.toUpperCase(),tl=text.toLowerCase();
if(tu.includes('BUY')&&!tu.includes("DON'T BUY"))insights.push({factor:'Recommendation',status:'BUY',signal:'good',explanation:'Appears to be a good opportunity at current levels. Consider building position gradually.'});
else if(tu.includes('SELL')||tu.includes('AVOID'))insights.push({factor:'Recommendation',status:'SELL / AVOID',signal:'concern',explanation:'Risk factors outweigh potential rewards at current prices. Consider exiting or avoiding.'});
else if(tu.includes('HOLD'))insights.push({factor:'Recommendation',status:'HOLD',signal:'neutral',explanation:'If you own it, hold. If looking to buy, wait for better entry or more positive catalysts.'});
if(tl.includes('long-term')||tl.includes('long term'))insights.push({factor:'Horizon',status:'Long-Term Hold',signal:'good',explanation:'Suitable for 3-5+ year horizon. Expect and tolerate short-term volatility.'});
else if(tl.includes('short-term')||tl.includes('trading'))insights.push({factor:'Horizon',status:'Short-Term Trade',signal:'caution',explanation:'Better for active traders. Requires close monitoring and quick decisions.'});
insights.push({factor:'Position Sizing',status:'Diversify',signal:'neutral',explanation:"Should represent no more than 5-10% of total portfolio. Spread risk across multiple investments."});
if(tl.includes('dip')||tl.includes('pullback'))insights.push({factor:'Entry',status:'Buy on Dips',signal:'good',explanation:'Build position on pullbacks for better average entry price.'});
return insights}

function formatCap(c,sym){const s=sym||'$';if(!c)return'N/A';if(c>=1e12)return s+(c/1e12).toFixed(2)+'T';if(c>=1e9)return s+(c/1e9).toFixed(2)+'B';if(c>=1e6)return s+(c/1e6).toFixed(2)+'M';return s+c.toLocaleString()}

// ==========================================
// FEATURE VOTING SYSTEM
// ==========================================
const featureKeys=['pdf','cmp','share','tech','peer','earn','insider','theme'];
const featureNames=['PDF Export','Compare Stocks','Share (WhatsApp/Email)','Technical Indicators','Peer Comparison','Earnings Countdown','Insider Activity','Dark/Light Theme'];
const votes={};
featureKeys.forEach(k=>{votes[k]={up:0,dn:0}});
let voteChart=null;
let userVotes={};

// ═══════════════════════════════════════════════
// CURATED STOCK PICKS — Research-backed lists
// ═══════════════════════════════════════════════
const STOCK_PICKS={
lc:{title:'Top 5 Undervalued Large Caps',
india:[
{n:'ITC',t:'ITC.NS',why:'P/E ~25x vs sector 35x, FMCG + hotel demerger catalyst, 3.5% div yield',edge:'Conglomerate discount unwinding',cat:'Undervalued'},
{n:'SBI',t:'SBI.NS',why:'P/B 1.6x (PSU banks at 2.5x), highest NIM, ₹5L Cr book, NPA at 10yr low',edge:'Largest loan book + digital push',cat:'Deep Value'},
{n:'NTPC',t:'NTPC.NS',why:'P/E ~15x, green energy pivot, 2.8% yield, govt capex beneficiary',edge:'Renewable + thermal dual play',cat:'Undervalued'},
{n:'Coal India',t:'COALINDIA.NS',why:'P/E ~7x, 6%+ div yield, cash rich, volume growth returning',edge:'Cash cow with massive dividends',cat:'Deep Value'},
{n:'L&T',t:'LT.NS',why:'Orderbook ₹4.5L Cr at 3.2x book, infra capex cycle peak, strong execution',edge:'India infra backbone',cat:'Quality Value'}
],
usa:[
{n:'Alphabet',t:'GOOGL',why:'P/E ~22x vs FAANG avg 30x, $100B+ cash, AI leader, cloud growing 28%',edge:'AI + search monopoly underpriced',cat:'Undervalued'},
{n:'Berkshire',t:'BRK-B',why:'P/B 1.5x, $300B+ cash pile, insurance float machine, Buffett premium',edge:'Largest cash hoard in history',cat:'Deep Value'},
{n:'Meta',t:'META',why:'P/E ~23x, 36% margins, 3.7B users, Reels monetization ramping, AI ads',edge:'Ad tech monopoly + AI efficiency',cat:'Quality Value'},
{n:'Merck',t:'MRK',why:'P/E ~14x, Keytruda franchise $25B+, strong pipeline, 2.5% yield',edge:'Pharma cash machine underpriced',cat:'Deep Value'},
{n:'JPMorgan',t:'JPM',why:'P/B 2x, ROE 17%, fortress balance sheet, best-in-class banking',edge:'Too big to fail, too cheap to ignore',cat:'Undervalued'}
]},
mc:{title:'Top 5 Undervalued Mid Caps',
india:[
{n:'Indian Hotels',t:'INDHOTEL.NS',why:'Brand portfolio (Taj,Vivanta,Ginger), asset-light expansion, tourism boom',edge:'Pricing power + brand moat',cat:'Quality'},
{n:'Persistent Sys',t:'PERSISTENT.NS',why:'30%+ rev growth, healthcare IT, partnerships with Salesforce/AWS',edge:'Niche digital engineering',cat:'Growth'},
{n:'Tube Investments',t:'TIINDIA.NS',why:'CG group pedigree, EV components, industrial diversification',edge:'Multi-segment industrial play',cat:'Quality'},
{n:'Coforge',t:'COFORGE.NS',why:'Insurance tech niche, Cigniti acquisition, 20%+ growth trajectory',edge:'Deep domain in BFSI/travel',cat:'Growth'},
{n:'Supreme Ind',t:'SUPREMEIND.NS',why:'Plastic pipes leader, real estate + infra demand, margin expansion',edge:'Market share gains in pipes',cat:'Value'}
],
usa:[
{n:'CrowdStrike',t:'CRWD',why:'Cybersecurity platform leader, 35%+ ARR growth, module adoption rising',edge:'Security platform consolidation winner',cat:'Growth'},
{n:'Datadog',t:'DDOG',why:'Observability platform, net retention 115%+, multi-product expansion',edge:'DevOps monitoring standard',cat:'Quality'},
{n:'Fair Isaac',t:'FICO',why:'FICO score monopoly, 85% of US lending decisions, pricing power',edge:'Irreplaceable credit scoring moat',cat:'Monopoly'},
{n:'IDEXX Labs',t:'IDXX',why:'Pet diagnostics monopoly, recurring revenue, companion animal TAM growing',edge:'Pet healthcare monopoly',cat:'Quality'},
{n:'Cadence Design',t:'CDNS',why:'EDA duopoly, chip complexity rising, AI accelerator design tools',edge:'Chip design infrastructure',cat:'Monopoly'}
]},
sc:{title:'Top 5 Undervalued Small Caps',
india:[
{n:'Kaynes Tech',t:'KAYNES.NS',why:'Defense electronics, IoT sensors, govt contracts ₹2000Cr+, 40% margins',edge:'Defense + space + EV electronics',cat:'High Growth'},
{n:'KPIT Tech',t:'KPITTECH.NS',why:'EV software for top 25 OEMs globally, 30%+ growth, sticky contracts',edge:'Only pure-play auto software in India',cat:'Niche Moat'},
{n:'Apar Industries',t:'APARINDS.NS',why:'Specialty conductors, transformer oil, export growth, power infra boom',edge:'Power transmission beneficiary',cat:'Value'},
{n:'CMS Info Systems',t:'CMSINFO.NS',why:'Cash mgmt duopoly, ATM managed services, 25%+ ROE, asset-light',edge:'Cash logistics monopoly',cat:'Quality'},
{n:'Tata Elxsi',t:'TATAELXSI.NS',why:'Design + embedded systems for auto/media, Tata group synergies',edge:'Embedded systems niche',cat:'Niche Moat'}
],
usa:[
{n:'Monday.com',t:'MNDY',why:'Work OS platform, 110%+ net retention, crossing profitability, SMB+enterprise',edge:'Workflow platform with viral growth',cat:'Growth'},
{n:'Axon Enterprise',t:'AXON',why:'TASER + body cameras + cloud evidence.com, govt contracts sticky',edge:'Law enforcement tech monopoly',cat:'Monopoly'},
{n:'Samsara',t:'IOT',why:'IoT fleet management, 40%+ growth, expanding to connected ops',edge:'Physical operations intelligence',cat:'High Growth'},
{n:'Clearwater Analytics',t:'CWAN',why:'Investment accounting SaaS, 99%+ retention, $7T+ assets managed',edge:'Financial data infrastructure',cat:'Niche Moat'},
{n:'Wingstop',t:'WING',why:'Asset-light franchise, same-store sales growth, digital 65%+ orders',edge:'Fastest growing restaurant chain',cat:'Quality'}
]},
niche:{title:'Top 5 Niche/Deep Moat Companies',
india:[
{n:'CDSL',t:'CDSL.NS',why:'1 of 2 depositories in India, every demat account = revenue, zero competition entry',edge:'Regulated duopoly, 70%+ margins',cat:'Monopoly'},
{n:'IEX',t:'IEX.NS',why:'95% market share in power exchange, regulatory moat, volume-linked revenue',edge:'Power exchange monopoly',cat:'Monopoly'},
{n:'CAMS',t:'CAMS.NS',why:'70% MF RTA market share, every SIP = revenue, regulation barrier',edge:'Mutual fund infrastructure backbone',cat:'Duopoly'},
{n:'Alkyl Amines',t:'ALKYLAMINE.NS',why:'Global leader in amines, pharma/agro raw material, pricing power',edge:'Specialty chemicals niche leader',cat:'Niche'},
{n:'Aavas Financiers',t:'AAVAS.NS',why:'Rural affordable housing, self-employed customer niche, 14%+ ROE',edge:'Underserved market specialist',cat:'Niche'}
],
usa:[
{n:'ASML',t:'ASML',why:'Only EUV lithography maker on earth, every advanced chip needs ASML',edge:'Absolute monopoly in EUV',cat:'Monopoly'},
{n:'Verisign',t:'VRSN',why:'.com/.net registry monopoly, ICANN contract, 87%+ margins',edge:'Internet domain infrastructure',cat:'Monopoly'},
{n:'S&P Global',t:'SPGI',why:'Credit ratings oligopoly, data analytics, IHS Markit merger synergies',edge:'Financial data indispensable',cat:'Oligopoly'},
{n:'Moody\'s',t:'MCO',why:'Credit ratings duopoly with S&P, recurring revenue, debt issuance growth',edge:'Regulatory-mandated ratings moat',cat:'Duopoly'},
{n:'TransDigm',t:'TDG',why:'Sole-source aerospace parts, 45%+ margins, aftermarket pricing power',edge:'Proprietary aerospace components',cat:'Monopoly'}
]},
micro:{title:'Top 5 Multibagger Potential — Micro Caps',
india:[
{n:'Netweb Technologies',t:'NETWEB.NS',why:'AI server manufacturing, NVIDIA partnership, Make in India for HPC',edge:'Only listed AI hardware maker in India',cat:'AI/HPC'},
{n:'Zaggle Prepaid',t:'ZAGGLE.NS',why:'SaaS spend management, 2M+ users, embedded fintech, 70%+ growth',edge:'Corporate expense management SaaS',cat:'Fintech'},
{n:'Avalon Technologies',t:'AVALON.NS',why:'EMS for defense/aerospace/medical, US client base, PLI beneficiary',edge:'High-value electronics manufacturing',cat:'Defense'},
{n:'Syrma SGS Tech',t:'SYRMA.NS',why:'IoT + RFID + EMS, Samsung/Visteon client base, order book ₹2000Cr',edge:'Smart manufacturing for global OEMs',cat:'IoT/EMS'},
{n:'Bondada Engineering',t:'BONDADA.NS',why:'5G tower infra, solar EPC, telecom rollout contracts, 100%+ growth',edge:'5G infrastructure rollout play',cat:'5G/Solar'}
],
usa:[
{n:'Indie Semiconductor',t:'INDI',why:'Auto semiconductors, ADAS sensors, EV power mgmt, 50+ design wins',edge:'Next-gen auto chip pure play',cat:'EV/ADAS'},
{n:'Credo Technology',t:'CRDO',why:'High-speed connectivity for AI data centers, 100G/200G/400G solutions',edge:'AI datacenter interconnects',cat:'AI Infra'},
{n:'Astera Labs',t:'ALAB',why:'Semiconductor connectivity for AI/cloud, PCIe/CXL retimers, GPU-to-GPU fabric',edge:'AI infrastructure fabric',cat:'AI Infra'},
{n:'Archer Aviation',t:'ACHR',why:'eVTOL air taxi, FAA certification path, United Airlines partnership',edge:'Urban air mobility first mover',cat:'Futuristic'},
{n:'Nano-X Imaging',t:'NNOX',why:'Disruptive digital X-ray, cold-cathode tech, $2 per scan model, FDA cleared',edge:'Democratizing medical imaging globally',cat:'MedTech'}
]},
idx:{title:'Best Index — 30%+ CAGR Potential',
india:[
{n:'Nifty Microcap 250',t:'INDEX',why:'Micro-cap broad basket, early-stage growth capture, 35%+ 5yr CAGR',edge:'Widest small-company exposure',cat:'37% CAGR*'},
{n:'Nifty Smallcap 250',t:'INDEX',why:'Small-cap diversified, infra/consumption themes, 32%+ 5yr CAGR',edge:'Small-cap without single-stock risk',cat:'33% CAGR*'},
{n:'BSE SME IPO Index',t:'INDEX',why:'Captures SME listing gains, high-growth new listings, 40%+ returns',edge:'IPO + early-stage premium',cat:'40%+ CAGR*'},
{n:'Nifty India Defence',t:'INDEX',why:'Defence capex theme, 5yr CAGR 38%+, govt spending visibility',edge:'Multi-year defence order visibility',cat:'38% CAGR*'},
{n:'Nifty Infra Index',t:'INDEX',why:'Roads, railways, power, water — PM Gati Shakti beneficiary',edge:'₹10L Cr+ govt infra pipeline',cat:'31% CAGR*'}
],
usa:[
{n:'NASDAQ-100',t:'QQQ',why:'Top 100 non-financial, tech-heavy, AI/cloud/SaaS concentration',edge:'Big tech + AI mega trends',cat:'19% CAGR'},
{n:'S&P 500 Info Tech',t:'XLK',why:'Pure technology sector, AAPL+MSFT+NVDA heavy, secular growth',edge:'Tech dominance compounding',cat:'22% CAGR'},
{n:'VanEck Semiconductor',t:'SMH',why:'NVDA, AVGO, AMD, ASML — AI chip demand supercycle',edge:'AI hardware supercycle play',cat:'30%+ CAGR*'},
{n:'ARK Innovation',t:'ARKK',why:'Disruptive tech — AI, genomics, fintech, autonomous vehicles',edge:'High risk, high reward innovation',cat:'Volatile'},
{n:'Global X AI & Tech',t:'AIQ',why:'Broad AI exposure — chips, software, robotics, autonomous',edge:'Diversified AI theme ETF',cat:'28%+ CAGR*'}
]}
};

let _pickGeo='india';
function showPickCat(btn,cat){
document.querySelectorAll('.ptab').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text2)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--blue)';btn.style.color='#fff';btn.style.borderColor='var(--blue)';
renderPicks(cat);
}
function togglePickGeo(btn,geo){
_pickGeo=geo;
document.querySelectorAll('.pick-geo button').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text3)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--amber)';btn.style.color='#000';btn.style.borderColor='var(--amber)';
const activeCat=document.querySelector('.ptab.active');
const cat=activeCat?activeCat.getAttribute('onclick').match(/'(\w+)'/)[1]:'lc';
renderPicks(cat);
}
function renderPicks(cat){
const el=document.getElementById('pickGrid');
if(!el)return;
const data=STOCK_PICKS[cat];
if(!data){el.innerHTML='';return}
const list=_pickGeo==='india'?data.india:data.usa;
const isIdx=cat==='idx';
let h=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text)">${data.title}</div>
<div class="pick-geo">
<button class="${_pickGeo==='india'?'active':''}" onclick="togglePickGeo(this,'india')" style="${_pickGeo==='india'?'background:var(--amber);color:#000;border-color:var(--amber)':''}">&#127470;&#127475; India</button>
<button class="${_pickGeo==='usa'?'active':''}" onclick="togglePickGeo(this,'usa')" style="${_pickGeo==='usa'?'background:var(--amber);color:#000;border-color:var(--amber)':''}">&#127482;&#127480; USA</button>
</div></div>`;
h+=`<table class="pick-tbl"><tr><th>#</th><th>Company</th><th>Why Undervalued</th><th>Edge</th><th>${isIdx?'Returns':'Type'}</th></tr>`;
list.forEach((s,i)=>{
const catCls=s.cat.includes('Monopoly')||s.cat.includes('Duopoly')?'b':s.cat.includes('Deep')||s.cat.includes('Value')?'g':'b';
h+=`<tr>
<td style="color:var(--text3);font-weight:700">${i+1}</td>
<td><div class="cname">${s.n}</div><div class="csub">${s.t}</div></td>
<td style="font-size:10px;line-height:1.5">${s.why}</td>
<td style="font-size:10px;font-weight:600;color:var(--amber)">${s.edge}</td>
<td><span class="flag ${catCls}">${s.cat}</span></td>
</tr>`;
});
h+=`</table>`;
if(cat==='idx')h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">* CAGR figures are approximate based on last 3-5 year trailing returns. Past performance does not guarantee future results.</div>`;
if(cat==='micro')h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">&#9888; Micro caps are extremely high risk. Position size should be &lt;2% of portfolio. Many will fail — diversification is essential.</div>`;
el.innerHTML=h;
}

// ═══════════════════════════════════════════════
// INDEX TRADES — AI-Powered Daily Ideas
// ═══════════════════════════════════════════════
async function loadIndexTrades(forceRefresh){
const el=document.getElementById('tradesContent');
const errEl=document.getElementById('tradesError');
const btn=document.getElementById('tradesLoadBtn');
// Get current email from the input
const emailInput=document.getElementById('email');
const email=emailInput?(emailInput.dataset.real||emailInput.value).trim():'';
if(!email){errEl.textContent='Please enter your email in the search bar above first.';errEl.style.display='block';return}
// Access check
btn.disabled=true;btn.textContent=forceRefresh?'⏳ Refreshing with live data...':'⏳ Analyzing markets...';errEl.style.display='none';
try{
const r=await fetch('/api/index-trades',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,force_refresh:!!forceRefresh})});
const data=await r.json();
if(!data.success){errEl.textContent=data.error||'Service busy. Please try again in a moment.';errEl.style.display='block';btn.disabled=false;btn.textContent='⚡ Generate Today\'s Trades';return}

// Render the trades
let html='';

// Market assessment — compact pill design
const ma=data.market_assessment||{};
if(ma.bias){
const biasCol=ma.bias.includes('BULL')?'var(--green)':ma.bias.includes('BEAR')?'var(--red)':'var(--amber)';
const biasBg=ma.bias.includes('BULL')?'rgba(16,185,129,.1)':ma.bias.includes('BEAR')?'rgba(239,68,68,.1)':'rgba(245,158,11,.08)';
const biasIcon=ma.bias.includes('BULL')?'&#128200;':ma.bias.includes('BEAR')?'&#128201;':'&#128260;';
const regimeCol=ma.regime==='TRENDING'?'var(--green)':ma.regime==='RANGE-BOUND'?'var(--amber)':'var(--blue)';
const edgeCol=ma.edge_clarity==='CLEAR'?'var(--green)':ma.edge_clarity==='MODERATE'?'var(--amber)':'var(--red)';
html+=`<div style="margin-bottom:14px;padding:14px 16px;border-radius:10px;background:${biasBg};border:1px solid ${biasCol}25">
<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:${ma.vix_signal||ma.global_impact?'10px':'0'}">
<div style="display:flex;align-items:center;gap:6px">
<span style="font-size:18px">${biasIcon}</span>
<span style="font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:${biasCol}">${ma.bias}</span>
</div>
<span style="font-size:10px;font-weight:700;color:${regimeCol};background:${regimeCol}12;border:1px solid ${regimeCol}25;padding:3px 10px;border-radius:10px">${ma.regime||'-'}</span>
<span style="font-size:10px;font-weight:700;color:${edgeCol};background:${edgeCol}12;border:1px solid ${edgeCol}25;padding:3px 10px;border-radius:10px">Edge: ${ma.edge_clarity||'-'}</span>
</div>
${ma.vix_signal||ma.global_impact?`<div style="font-size:11px;color:var(--text3);line-height:1.6">${ma.vix_signal?'<span style="color:var(--amber);font-weight:600">VIX</span> '+ma.vix_signal+(ma.global_impact?' · ':''):''}${ma.global_impact?'<span style="color:var(--blue);font-weight:600">Global</span> '+ma.global_impact:''}</div>`:''}
</div>`;
}

// Event alert now handled by fetchMarketPulse() on Analyze click — not here

// ═══ GAMMA BLAST PROBABILITY ═══
const gb=data.gamma_blast||{};
if(gb.probability){
const gbProb=parseInt(gb.probability)||0;
const gbCol=gbProb>=60?'var(--red)':gbProb>=40?'var(--amber)':gbProb>=20?'var(--blue)':'var(--text3)';
const gbBg=gbProb>=60?'rgba(239,68,68,.08)':gbProb>=40?'rgba(245,158,11,.06)':'rgba(59,130,246,.04)';
const gbW=Math.min(gbProb,100);
const dirIcon=gb.direction==='UP'?'&#128640;':gb.direction==='DOWN'?'&#128546;':'&#128260;';
const srcCol=gb.source==='BOTH'?'var(--red)':gb.source==='EVENT'?'var(--amber)':'var(--blue)';
const srcLabel=gb.source==='BOTH'?'&#9889; EXPIRY + EVENT':gb.source==='EVENT'?'&#127758; EVENT-DRIVEN':'&#128197; EXPIRY-DRIVEN';
html+=`<div style="margin-bottom:14px;padding:14px 16px;border-radius:10px;background:${gbBg};border:1px solid ${gbCol}30">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:20px;${gbProb>=50?'animation:pulse 1.5s infinite':''}">${dirIcon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:800;color:${gbCol}">GAMMA BLAST: ${gb.probability}</span>
<span style="font-size:10px;font-weight:800;color:#fff;background:${gbCol};padding:2px 8px;border-radius:4px">${gb.direction||'-'}</span>
<span style="font-size:10px;font-weight:700;color:${srcCol};background:${srcCol}12;border:1px solid ${srcCol}30;padding:2px 8px;border-radius:4px">${srcLabel}</span>
${gb.index?`<span style="font-size:10px;font-weight:700;color:var(--text3);background:rgba(255,255,255,.06);padding:2px 8px;border-radius:4px">${gb.index}</span>`:''}
</div>
<span style="font-size:11px;color:var(--text3);font-weight:600">${gb.timing||''}</span>
</div>
<div style="width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,.08);overflow:hidden;margin-bottom:10px">
<div style="width:${gbW}%;height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red));transition:width 1s"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
<div style="font-size:11px;color:var(--text3)"><strong style="color:var(--amber)">Trigger Zone:</strong> ${gb.trigger_zone||'-'}</div>
<div style="font-size:11px;color:var(--text3)"><strong style="color:var(--amber)">Expected Move:</strong> ${gb.expected_move||'-'}</div>
</div>
${gb.best_play?`<div style="padding:8px 12px;border-radius:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);font-size:12px;margin-bottom:8px"><strong style="color:var(--green)">&#127919; Best Play:</strong> <span style="color:var(--text)">${gb.best_play}</span></div>`:''}
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
${gb.expiry_factors&&!gb.expiry_factors.includes('N/A')?`<div style="padding:8px 10px;border-radius:6px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1);font-size:11px;color:var(--text3);line-height:1.5"><strong style="color:var(--blue)">&#128197; Expiry Factors:</strong><br>${gb.expiry_factors}</div>`:`<div style="padding:8px 10px;border-radius:6px;background:rgba(255,255,255,.02);font-size:11px;color:var(--text3)">&#128197; Expiry: Not expiry day</div>`}
${gb.event_factors&&!gb.event_factors.includes('No major')?`<div style="padding:8px 10px;border-radius:6px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.1);font-size:11px;color:var(--text3);line-height:1.5"><strong style="color:var(--amber)">&#127758; Event Factors:</strong><br>${gb.event_factors}</div>`:`<div style="padding:8px 10px;border-radius:6px;background:rgba(255,255,255,.02);font-size:11px;color:var(--text3)">&#127758; Events: No major event today</div>`}
</div>
</div>`;
}

// Market pulse header
html+=`<div style="border-radius:12px;background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(239,68,68,.05));border:1px solid rgba(245,158,11,.2);padding:16px 20px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">&#128200;</span>
<div><div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--amber)">Market Pulse — ${new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
<div style="font-size:11px;color:var(--text3);display:flex;align-items:center;gap:8px">Generated at ${data.generated_at?new Date(data.generated_at).toLocaleTimeString('en-IN'):new Date().toLocaleTimeString('en-IN')} IST <button onclick="loadIndexTrades(true)" style="font-size:10px;color:var(--blue);background:none;border:1px solid var(--blue);border-radius:6px;padding:2px 8px;cursor:pointer" title="Force fresh analysis with latest market data">&#8635; Refresh</button></div></div></div>
${data.market_context?'<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">'+data.market_context+'</p>':''}
</div>`;

// Expiry status badge
if(data.is_expiry_day){
html+=`<div style="padding:12px 16px;border-radius:8px;background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(245,158,11,.08));border:1px solid rgba(239,68,68,.3);margin-bottom:14px;display:flex;align-items:center;gap:10px">
<span style="font-size:22px;animation:pulse 1.5s infinite">&#128308;</span>
<div><div style="font-size:12px;font-weight:800;color:var(--red);letter-spacing:.5px">EXPIRY DAY — ${data.expiry_today}</div>
<div style="font-size:11px;color:var(--text3)">Theta decay accelerates after 1 PM · Gamma spikes in last 90 min · Hero Zero window: 1:30-2:30 PM IST</div></div></div>`;
}else{
html+=`<div style="padding:10px 16px;border-radius:8px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);margin-bottom:14px;display:flex;align-items:center;gap:10px">
<span style="font-size:18px">&#128197;</span>
<div style="font-size:12px;color:var(--text3)"><strong style="color:var(--blue)">${data.day_name||'Today'}</strong> — No expiry today. Next: <strong>Nifty</strong> expires Tuesday (NSE) · <strong>Sensex</strong> expires Thursday (BSE). Positional trades recommended.</div></div>`;
}

// Index snapshot
if(data.indices&&data.indices.length>0){
html+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:16px">`;
data.indices.forEach(idx=>{
const up=idx.change>=0;
const col=up?'var(--green)':'var(--red)';
html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(${up?'16,185,129':'239,68,68'},.06);border:1px solid rgba(${up?'16,185,129':'239,68,68'},.15)">
<div style="font-size:11px;color:var(--text3);font-weight:600;letter-spacing:.5px">${idx.name}</div>
<div style="font-size:18px;font-weight:800;color:${col}">${idx.price?idx.price.toLocaleString('en-IN'):'-'}</div>
<div style="font-size:12px;color:${col}">${up?'▲':'▼'} ${Math.abs(idx.change||0).toFixed(2)} (${(idx.change_pct||0).toFixed(2)}%)</div>
</div>`;
});
html+=`</div>`;
}

// Trades table — ranked by probability, with time planner and gut picks
// Collect ALL trades for time-ordered planner
const allTrades=[];

if(data.trades&&data.trades.length>0){
const sorted=[...data.trades].sort((a,b)=>(parseInt(b.probability)||80)-(parseInt(a.probability)||80));
html+=`<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--amber);margin-bottom:10px;letter-spacing:.3px">&#127919; INDEX TRADES — Ranked by Probability</div>`;
sorted.forEach((t,i)=>{
const up=(t.direction||'').toUpperCase().includes('BULL');
const col=up?'var(--green)':'var(--red)';
const bg=up?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)';
const bdr=up?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)';
const prob=parseInt(t.probability)||80;
const pCol=prob>=90?'var(--green)':prob>=85?'#22d3ee':'var(--amber)';
allTrades.push({...t,_type:'INDEX',_rank:t.rank||i+1,_prob:prob,_inst:t.index+' '+(t.bias||t.direction||'')});
html+=`<div style="border-left:4px solid ${bdr};border-radius:10px;padding:16px;margin-bottom:12px;background:${bg};border:1px solid ${bdr}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;background:${col};color:#fff;padding:2px 8px;border-radius:4px;font-weight:800">#${t.rank||i+1}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.index||'-'}</span>
<span style="font-size:12px;font-weight:700;color:${col};background:${bg};border:1px solid ${bdr};padding:2px 8px;border-radius:4px">${(t.direction||'').toUpperCase()}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
${t.probability?`<span style="font-size:11px;font-weight:800;color:#fff;background:${pCol};padding:2px 8px;border-radius:4px">${t.probability}</span>`:''}
</div>
</div>
${t.factors_aligned?`<div style="font-size:11px;color:var(--text3);margin-bottom:8px;padding:4px 8px;border-radius:4px;background:rgba(255,255,255,.03)">&#9989; <strong style="color:var(--green)">Factors:</strong> ${t.factors_aligned}</div>`:''}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(255,255,255,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">ENTRY LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${t.entry_level||t.entry||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TARGET ${t.move_pct?'<span style="color:var(--green);font-weight:800">('+t.move_pct+')</span>':''}</div><div style="font-size:14px;font-weight:700;color:var(--green)">${t.target_level||t.target||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">STOP LOSS</div><div style="font-size:14px;font-weight:700;color:var(--red)">${t.stop_level||t.stop_loss||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(255,255,255,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">MOVE</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${t.move_points||t.risk_reward||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(255,255,255,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">R:R</div><div style="font-size:14px;font-weight:700;color:var(--amber)">${t.risk_reward||'-'}</div></div>
</div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:.8px">&#9654; WHEN TO ENTER</span><br><span style="font-size:14px;font-weight:800;color:#fff">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.8px">&#9200; BEST TIME</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
${t.key_levels?`<div style="margin-bottom:8px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.12);font-size:11px"><strong style="color:var(--purple)">&#128200; Key Levels:</strong> <span style="color:var(--text2)">${t.key_levels}</span></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; KILL IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// Stock trades
if(data.stock_trades&&data.stock_trades.length>0){
const sorted=[...data.stock_trades].sort((a,b)=>(parseInt(b.probability)||80)-(parseInt(a.probability)||80));
html+=`<div style="margin-top:20px;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--purple);margin-bottom:10px">&#128640; STOCK PICKS — Ranked by Probability</div>`;
sorted.forEach((t,i)=>{
const up=(t.direction||'').toUpperCase().includes('BULL');
const col=up?'var(--green)':'var(--red)';
const bg=up?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)';
const bdr=up?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)';
const prob=parseInt(t.probability)||80;
const pCol=prob>=90?'var(--green)':prob>=85?'#22d3ee':'var(--amber)';
allTrades.push({...t,_type:'STOCK',_rank:t.rank||'S'+(i+1),_prob:prob,_inst:(t.stock||'')+(t.bias?' '+t.bias:'')});
html+=`<div style="border-left:4px solid rgba(139,92,246,.3);border-radius:10px;padding:16px;margin-bottom:12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15)">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;background:var(--purple);color:#fff;padding:2px 8px;border-radius:4px;font-weight:800">${t.rank||'S'+(i+1)}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.stock||'-'}</span>
<span style="font-size:12px;font-weight:700;color:${col};background:${bg};border:1px solid ${bdr};padding:2px 8px;border-radius:4px">${(t.direction||'').toUpperCase()}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
${t.probability?`<span style="font-size:11px;font-weight:800;color:#fff;background:${pCol};padding:2px 8px;border-radius:4px">${t.probability}</span>`:''}
</div>
</div>
${t.factors_aligned?`<div style="font-size:11px;color:var(--text3);margin-bottom:8px;padding:4px 8px;border-radius:4px;background:rgba(255,255,255,.03)">&#9989; <strong style="color:var(--green)">Factors:</strong> ${t.factors_aligned}</div>`:''}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(255,255,255,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">ENTRY LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">₹${t.entry_level||t.entry||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TARGET ${t.move_pct?'<span style="color:var(--green);font-weight:800">('+t.move_pct+')</span>':''}</div><div style="font-size:14px;font-weight:700;color:var(--green)">₹${t.target_level||t.target||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">STOP LOSS</div><div style="font-size:14px;font-weight:700;color:var(--red)">₹${t.stop_level||t.stop_loss||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(255,255,255,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">R:R</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${t.risk_reward||'-'}</div></div>
</div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--purple);letter-spacing:.8px">&#9654; WHEN TO ENTER</span><br><span style="font-size:14px;font-weight:800;color:#fff">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.8px">&#9200; BEST TIME</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
${t.key_levels?`<div style="margin-bottom:8px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.12);font-size:11px"><strong style="color:var(--purple)">&#128200; Key Levels:</strong> <span style="color:var(--text2)">${t.key_levels}</span></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; KILL IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// VIX indicator
if(data.vix){
const vix=data.vix;
const vC=vix.price>18?'var(--red)':vix.price>14?'var(--amber)':'var(--green)';
const vBg=vix.price>18?'rgba(239,68,68,.08)':vix.price>14?'rgba(245,158,11,.08)':'rgba(16,185,129,.08)';
const vAdv=vix.price>20?'HIGH FEAR — Reduce sizes to 50%.':vix.price>16?'ELEVATED — Standard sizing. Stay alert.':'LOW — Full sizing. Trends likely.';
const vP=Math.min(((vix.price-8)/(30-8))*100,100);
html+=`<div style="margin-top:16px;padding:14px;border-radius:10px;background:${vBg};border:1px solid ${vC}30">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px">
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:${vC}">INDIA VIX: ${vix.price} ${vix.change>=0?'▲':'▼'} ${Math.abs(vix.change||0).toFixed(2)} (${(vix.change_pct||0).toFixed(2)}%)</span>
<span style="font-size:11px;color:var(--text3)">${vAdv}</span></div>
<div style="width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,.1);overflow:hidden"><div style="width:${vP}%;height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red))"></div></div>
<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:4px"><span>8 (Calm)</span><span>15</span><span>20</span><span>30+ (Panic)</span></div></div>`;
}

// Hero Zero
if(data.hero_zero&&data.hero_zero.length>0){
html+=`<div style="margin-top:20px;margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--red);letter-spacing:.3px;margin-bottom:4px">&#128165; HERO ZERO — Expiry Day Lottery</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:12px">Deep OTM, ₹2-15 premium. All-or-nothing for 3x-10x. Max 1-2% capital. Today's expiry ONLY.</div></div>`;
data.hero_zero.forEach((t,i)=>{
allTrades.push({...t,_type:'HERO ZERO',_rank:'H'+(i+1),_prob:0,_inst:(t.index||'')+' '+(t.bias||'Deep OTM')});
html+=`<div style="border-left:4px solid rgba(239,68,68,.5);border-radius:10px;padding:16px;margin-bottom:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.2)">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;background:var(--red);color:#fff;padding:2px 8px;border-radius:4px;font-weight:800;animation:pulse 2s infinite">&#128165;H${i+1}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.index||'-'} ${t.direction||''}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
<span style="font-size:10px;font-weight:800;color:var(--red);background:rgba(239,68,68,.15);padding:2px 8px;border-radius:4px">SPECULATIVE</span></div></div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(255,255,255,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TRIGGER LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${t.trigger_level||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">EXPECTED MOVE</div><div style="font-size:14px;font-weight:700;color:var(--green)">${t.target_move||'3x-10x'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">RISK</div><div style="font-size:14px;font-weight:700;color:var(--red)">Full premium loss</div></div></div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:.8px">&#9654; TRIGGER CONDITION</span><br><span style="font-size:14px;font-weight:800;color:#fff">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--red);letter-spacing:.8px">&#9200; TIMING IS EVERYTHING</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; ZERO IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// ═══ TIME-ORDERED DAY PLANNER ═══
if(allTrades.length>0){
const timeSorted=[...allTrades].sort((a,b)=>{
const ta=parseInt(a.time_sort)||9999;
const tb=parseInt(b.time_sort)||9999;
return ta-tb;
});
html+=`<div style="margin-top:24px;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.04));border:1px solid rgba(59,130,246,.15)">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--blue);margin-bottom:4px">&#128197; YOUR TRADING DAY PLAN (IST)</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:12px">All trades sorted by execution time — follow this order through the day</div>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<thead><tr style="border-bottom:2px solid rgba(59,130,246,.2)">
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TIME</th>
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">RANK</th>
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">INSTRUMENT</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">DIR</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">ENTRY</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TRIGGER</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TARGET</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">SL</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">PROB</th>
</tr></thead><tbody>`;
timeSorted.forEach((t,i)=>{
const dir=(t.direction||'').toUpperCase();
const dCol=dir.includes('BULL')?'var(--green)':'var(--red)';
const tBg=i%2===0?'rgba(255,255,255,.01)':'rgba(255,255,255,.03)';
const typeCol=t._type==='INDEX'?'var(--amber)':t._type==='STOCK'?'var(--purple)':'var(--red)';
const ts=t.time_sort||'--';
const timeStr=ts.length===4?ts.substring(0,2)+':'+ts.substring(2):ts;
html+=`<tr style="background:${tBg};border-bottom:1px solid rgba(255,255,255,.04)">
<td style="padding:8px 6px;font-weight:700;color:var(--amber)">${timeStr}</td>
<td style="padding:8px 6px"><span style="font-size:10px;background:${typeCol};color:#fff;padding:1px 6px;border-radius:3px;font-weight:800">${t._rank}</span></td>
<td style="padding:8px 6px;font-weight:600;color:var(--text)">${t._inst||'-'}</td>
<td style="padding:8px 6px;text-align:center;font-weight:700;color:${dCol}">${dir}</td>
<td style="padding:8px 6px;text-align:right;color:var(--blue)">${t.entry_level||t.entry||'-'}</td>
<td style="padding:8px 6px;text-align:center;font-size:11px;color:var(--text2)">${t.entry_condition||'-'}</td>
<td style="padding:8px 6px;text-align:right;color:var(--green)">${t.move_pct||t.target_pct||'-'}</td>
<td style="padding:8px 6px;text-align:right;color:var(--red)">${t.stop_level||t.stop_loss||'-'}</td>
<td style="padding:8px 6px;text-align:center"><span style="font-weight:800;color:${parseInt(t.probability)>=85?'var(--green)':'var(--amber)'}">${t.probability||'-'}</span></td>
</tr>`;
});
html+=`</tbody></table></div></div>`;
}

// ═══ GUT PICKS — TOP 2 HIGHEST CONVICTION ═══
if(data.gut_picks&&data.gut_picks.length>0){
html+=`<div style="margin-top:24px;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(245,158,11,.06));border:2px solid rgba(16,185,129,.25)">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
<span style="font-size:24px">&#129504;</span>
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--green);letter-spacing:.3px">TOP GUT PICKS — Highest Conviction Trades</div>
</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:14px">If you could only take 2 trades today, take THESE. Maximum data confluence.</div>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<thead><tr style="border-bottom:2px solid rgba(16,185,129,.3)">
<th style="padding:8px 6px;text-align:left;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">PICK</th>
<th style="padding:8px 6px;text-align:left;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">INSTRUMENT</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">DIR</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">ENTRY</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TRIGGER</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TIME</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TARGET</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">SL</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">PROB</th>
</tr></thead><tbody>`;
data.gut_picks.forEach((g,i)=>{
const dir=(g.direction||'').toUpperCase();
const dCol=dir.includes('BULL')?'var(--green)':'var(--red)';
html+=`<tr style="background:rgba(16,185,129,.04);border-bottom:1px solid rgba(16,185,129,.1)">
<td style="padding:10px 6px"><span style="font-size:11px;background:var(--green);color:#000;padding:2px 8px;border-radius:4px;font-weight:900">&#127942; #${i+1}</span></td>
<td style="padding:10px 6px;font-weight:700;color:var(--text)">${g.index_or_stock||g.instrument||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-weight:700;color:${dCol}">${dir}</td>
<td style="padding:10px 6px;text-align:right;color:var(--blue);font-weight:700">${g.entry_level||g.entry||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-size:11px;font-weight:700;color:var(--text)">${g.entry_condition||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-weight:700;color:var(--amber)">${g.timing||'-'}</td>
<td style="padding:10px 6px;text-align:right;font-weight:800;color:var(--green)">${g.target_level||g.move_pct||'-'}</td>
<td style="padding:10px 6px;text-align:right;font-weight:700;color:var(--red)">${g.stop_level||g.stop_loss||'-'}</td>
<td style="padding:10px 6px;text-align:center"><span style="font-weight:900;color:var(--green);font-size:13px">${g.probability||'-'}</span></td>
</tr>
<tr style="background:rgba(16,185,129,.02)">
<td colspan="9" style="padding:6px 6px 10px 40px;font-size:11px;color:var(--text2);line-height:1.5">&#128161; <strong style="color:var(--amber)">Why this one:</strong> ${g.why_this_one||'-'}</td>
</tr>`;
});
html+=`</tbody></table></div></div>`;
}

// Skipped trades honesty note
if(data.skipped_trades&&!data.skipped_trades.includes('All')){
html+=`<div style="margin-top:12px;padding:12px 16px;border-radius:8px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);display:flex;align-items:flex-start;gap:10px">
<span style="font-size:18px">&#9888;&#65039;</span>
<div><div style="font-size:11px;font-weight:800;color:var(--amber);letter-spacing:.5px;margin-bottom:4px">HONEST NOTE</div>
<div style="font-size:12px;color:var(--text2);line-height:1.6">${data.skipped_trades}</div></div></div>`;
}

el.innerHTML=html;
}catch(e){
errEl.textContent='Service busy. Please try again in a moment.';errEl.style.display='block';
btn.disabled=false;btn.textContent='⚡ Generate Today\'s Trades';
}}

function vote(feature,dir,btn){
if(typeof gtag==='function')gtag('event','feature_vote',{feature_name:feature,vote_direction:dir>0?'up':'down'});
// Prevent double-voting same direction on same feature
const voteKey=feature+(dir>0?'up':'dn');
const oppKey=feature+(dir>0?'dn':'up');
if(userVotes[voteKey])return;

// If they voted opposite before, undo it
if(userVotes[oppKey]){
const oppDir=dir>0?-1:1;
votes[feature][oppDir>0?'up':'dn']--;
const oppBtn=btn.parentElement.querySelector(dir>0?'.dn':'.up');
oppBtn.classList.remove('voted');
delete userVotes[oppKey];
}

// Record vote
if(dir>0)votes[feature].up++;
else votes[feature].dn++;
userVotes[voteKey]=true;
btn.classList.add('voted');

// Update counters
document.getElementById(feature+'-up').textContent=votes[feature].up;
document.getElementById(feature+'-dn').textContent=votes[feature].dn;

// Update bar
const total=votes[feature].up+votes[feature].dn;
const pct=total>0?Math.round((votes[feature].up/total)*100):0;
document.getElementById(feature+'-bar').style.width=pct+'%';

// Update chart
updateVoteChart();

// Send to backend
fetch('/api/vote',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({feature:feature,direction:dir})}).catch(()=>{});
}

function updateVoteChart(){
if(!voteChart)return;
voteChart.data.datasets[0].data=featureKeys.map(k=>votes[k].up);
voteChart.data.datasets[1].data=featureKeys.map(k=>-votes[k].dn);
voteChart.update('none');
}

function initVoteChart(){
const ctx=document.getElementById('voteChart');
if(!ctx)return;
voteChart=new Chart(ctx,{
type:'bar',
data:{
labels:featureNames,
datasets:[
{label:'Want It',data:featureKeys.map(k=>votes[k].up),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4,barPercentage:.6},
{label:'Not Needed',data:featureKeys.map(k=>-votes[k].dn),backgroundColor:'rgba(239,68,68,0.5)',borderRadius:4,barPercentage:.6}
]
},
options:{
indexAxis:'y',
responsive:true,
maintainAspectRatio:false,
scales:{
x:{stacked:true,grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#64748b',font:{size:10},callback:v=>Math.abs(v)},border:{display:false}},
y:{stacked:true,grid:{display:false},ticks:{color:'#e2e8f0',font:{family:"'DM Sans',sans-serif",size:11,weight:'600'}},border:{display:false}}
},
plugins:{
legend:{labels:{color:'#94a3b8',font:{size:10},usePointStyle:true,pointStyle:'rectRounded'}},
tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+Math.abs(ctx.raw)}}
}
}
});
}

function loadVotes(){
fetch('/api/votes').then(r=>r.json()).then(data=>{
if(data&&data.votes){
featureKeys.forEach(k=>{
if(data.votes[k]){
votes[k].up=data.votes[k].up||0;
votes[k].dn=data.votes[k].dn||0;
document.getElementById(k+'-up').textContent=votes[k].up;
document.getElementById(k+'-dn').textContent=votes[k].dn;
const total=votes[k].up+votes[k].dn;
const pct=total>0?Math.round((votes[k].up/total)*100):0;
document.getElementById(k+'-bar').style.width=pct+'%';
}
});
updateVoteChart();
}
}).catch(()=>{});
}

function sendVoteResults(){
let body='CELESYS AI - Feature Vote Results\n\n';
const sorted=featureKeys.map((k,i)=>({key:k,name:featureNames[i],up:votes[k].up,dn:votes[k].dn,net:votes[k].up-votes[k].dn})).sort((a,b)=>b.net-a.net);
sorted.forEach((f,i)=>{
body+=(i+1)+'. '+f.name+' | Upvotes: '+f.up+' | Downvotes: '+f.dn+' | Net: '+f.net+'\n';
});
body+='\nTotal votes cast: '+featureKeys.reduce((s,k)=>s+votes[k].up+votes[k].dn,0);
body+='\nTimestamp: '+new Date().toISOString();
const mailto='mailto:contact@celesys.ai?subject='+encodeURIComponent('Feature Vote Results - '+new Date().toLocaleDateString())+'&body='+encodeURIComponent(body);
window.open(mailto);
}

// Initialize vote chart on page load
async function loadGlobalTicker(){
try{
const r=await fetch('/api/global-ticker');
const d=await r.json();
if(!d.success||!d.indices||!d.indices.length)return;
const track=document.getElementById('tickerTrack');
if(!track)return;
let items='';
d.indices.forEach(idx=>{
const up=idx.change_pct>0;
const flat=idx.change_pct===0;
const cls=flat?'fl':up?'up':'dn';
const arrow=flat?'':up?'▲':'▼';
const fmt=idx.name==='GSR'?idx.price:idx.price>=1000?idx.price.toLocaleString('en-IN'):idx.price;
items+=`<div class="ti"><span style="font-size:12px">${idx.flag}</span><span class="tn">${idx.name}</span><span class="tp" style="color:var(--text)">${fmt}</span><span class="tc ${cls}">${arrow}${Math.abs(idx.change_pct).toFixed(2)}%</span></div>`;
});
// Duplicate for seamless infinite scroll
track.innerHTML=items+items;
}catch(e){console.log('Ticker load failed:',e)}
}

document.addEventListener('DOMContentLoaded',()=>{loadGlobalTicker();initVoteChart();loadVotes();
fetch('/api/stats').then(r=>r.json()).then(d=>{
if(d.total_reports){document.getElementById('navRC').textContent=d.total_reports;document.getElementById('globalRC').textContent=d.total_reports.toLocaleString();const hb=document.getElementById('reportBadgeCount');if(hb)hb.textContent=d.total_reports.toLocaleString()}
}).catch(()=>{})});

// Back-to-top button visibility + sticky tagline
window.addEventListener('scroll',()=>{
const btt=document.getElementById('bttBtn');
if(btt){if(window.scrollY>600)btt.classList.add('show');else btt.classList.remove('show')}
},{ passive: true });
// Sticky tagline — appears when hero scrolls out of view
const heroEl=document.querySelector('.hero');
const sTag=document.getElementById('stickyTag');
if(heroEl&&sTag){
const obs=new IntersectionObserver(([e])=>{
if(e.isIntersecting)sTag.classList.remove('vis');
else sTag.classList.add('vis');
},{threshold:0.1});
obs.observe(heroEl);
}
</script>

<!-- FLOATING FEEDBACK BUTTON -->
<button class="fab" onclick="document.getElementById('fpanel').classList.add('open');document.getElementById('fpbk').classList.add('open')">
<div class="pulse"></div> &#128227; Shape Our Roadmap! <span style="background:#ef4444;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;font-weight:800;animation:notifPop 2s ease-in-out infinite">NEW</span>
</button>

<!-- BACKDROP -->
<div class="fpbk" id="fpbk" onclick="document.getElementById('fpanel').classList.remove('open');this.classList.remove('open')"></div>

<!-- SLIDE PANEL -->
<div class="fpanel" id="fpanel">
<div class="fphdr">
<h3>&#128640; What Should We Build Next?</h3>
<button class="fpclose" onclick="document.getElementById('fpanel').classList.remove('open');document.getElementById('fpbk').classList.remove('open')">&times;</button>
</div>
<div class="fpbody">
<p class="sub">You just got a free analysis worth $50+. Now imagine what happens when we add <em>these</em>. Your vote decides what ships first.</p>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128196;</div><div class="pfinfo"><div class="pfname">PDF Export <span class="ftag hot">Most Wanted</span></div><div class="pfdesc">Download your full report as a branded PDF. Save it, print it, share it.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('pdf',1,this)">&#9650; Want it <span class="cnt" id="pdf-up">0</span></button><button class="pvbtn dn" onclick="vote('pdf',-1,this)">&#9660; Skip <span class="cnt" id="pdf-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="pdf-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#9878;&#65039;</div><div class="pfinfo"><div class="pfname">Compare 2 Stocks <span class="ftag hot">Most Wanted</span></div><div class="pfdesc">Side-by-side showdown. Which stock wins on every single metric?</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('cmp',1,this)">&#9650; Want it <span class="cnt" id="cmp-up">0</span></button><button class="pvbtn dn" onclick="vote('cmp',-1,this)">&#9660; Skip <span class="cnt" id="cmp-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="cmp-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128172;</div><div class="pfinfo"><div class="pfname">WhatsApp &amp; Email Share <span class="ftag new">New</span></div><div class="pfdesc">One tap to share your analysis with friends, family, or your broker.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('share',1,this)">&#9650; Want it <span class="cnt" id="share-up">0</span></button><button class="pvbtn dn" onclick="vote('share',-1,this)">&#9660; Skip <span class="cnt" id="share-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="share-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128200;</div><div class="pfinfo"><div class="pfname">Technical Indicators <span class="ftag pro">Pro</span></div><div class="pfdesc">RSI, MACD, Moving Averages &mdash; the tools serious traders use daily.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('tech',1,this)">&#9650; Want it <span class="cnt" id="tech-up">0</span></button><button class="pvbtn dn" onclick="vote('tech',-1,this)">&#9660; Skip <span class="cnt" id="tech-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="tech-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#127919;</div><div class="pfinfo"><div class="pfname">Peer Comparison <span class="ftag new">New</span></div><div class="pfdesc">Auto-compare vs top 3 competitors in the same sector. Who really wins?</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('peer',1,this)">&#9650; Want it <span class="cnt" id="peer-up">0</span></button><button class="pvbtn dn" onclick="vote('peer',-1,this)">&#9660; Skip <span class="cnt" id="peer-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="peer-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128197;</div><div class="pfinfo"><div class="pfname">Earnings Countdown <span class="ftag pro">Pro</span></div><div class="pfdesc">Next earnings date + analyst expectations. Never get blindsided again.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('earn',1,this)">&#9650; Want it <span class="cnt" id="earn-up">0</span></button><button class="pvbtn dn" onclick="vote('earn',-1,this)">&#9660; Skip <span class="cnt" id="earn-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="earn-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128100;</div><div class="pfinfo"><div class="pfname">Insider Activity <span class="ftag hot">Most Wanted</span></div><div class="pfdesc">Are executives buying or selling their own stock? Follow the smart money.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('insider',1,this)">&#9650; Want it <span class="cnt" id="insider-up">0</span></button><button class="pvbtn dn" onclick="vote('insider',-1,this)">&#9660; Skip <span class="cnt" id="insider-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="insider-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#127763;</div><div class="pfinfo"><div class="pfname">Dark / Light Theme <span class="ftag new">New</span></div><div class="pfdesc">Switch between dark terminal mode and clean light mode instantly.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('theme',1,this)">&#9650; Want it <span class="cnt" id="theme-up">0</span></button><button class="pvbtn dn" onclick="vote('theme',-1,this)">&#9660; Skip <span class="cnt" id="theme-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="theme-bar" style="width:0%"></div></div></div>

<!-- LIVE VOTE CHART -->
<div class="vgp">
<h4>&#128202; Live Community Votes</h4>
<div class="vsub">Real-time ranking &mdash; updated as you vote</div>
<div class="cc"><canvas id="voteChart"></canvas></div></div>

</div><!-- end fpbody -->
</div><!-- end fpanel -->

<!-- STICKY EDUCATION DISCLAIMER BAR — visible site-wide -->
<div class="edu-bar">
<div class="edu-title">&#9888; READ THIS BEFORE YOU TRADE</div>
<div class="edu-lines">
<div class="edu-line"><strong>NOT FINANCIAL ADVICE:</strong> This tool is <b style="color:var(--amber)">for education only</b>. Not a replacement for licensed financial advisors. <b style="color:var(--amber)">Consult your financial advisor</b> before making any decisions. Never invest money you cannot afford to lose.</div>
<div class="edu-line"><strong>DATA MAY BE DELAYED:</strong> Market data from third-party providers may be delayed or incomplete. Always cross-check with your broker.</div>
<div class="edu-line"><strong>YOU CAN LOSE MONEY:</strong> All investments carry real risk. Past performance never guarantees future results. No affiliation with any brokerage.</div>
</div>
</div>

</body>
</html>
