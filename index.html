<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Analytics 4 — Replace G-WW55EQ7ZB8 with your Measurement ID -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WW55EQ7ZB8"></script>
<script>
window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-WW55EQ7ZB8');
</script>

<!-- Google AdSense — Replace ca-pub-2084524493538975 with your publisher ID after approval -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2084524493538975" crossorigin="anonymous"></script>
<title>Celesys AI — Free Real-Time Stock Analysis in 60 Seconds | AI Stock Research</title>
<meta name="description" content="Celesys AI delivers free, institutional-grade stock analysis in 60 seconds. Get real-time valuation metrics, intrinsic value (Graham Number, DCF), 20-factor buy/sell verdicts, quarterly earnings trends, management tone analysis, and curated small-cap picks for US (NYSE, NASDAQ) and Indian (NSE, BSE) markets.">
<meta name="keywords" content="stock analysis, AI stock research, free stock analysis, real-time stock data, stock valuation, intrinsic value calculator, Graham Number, DCF model, entry exit strategy, stop loss calculator, PE ratio checker, PB ratio, stock risk assessment, small cap stocks, micro cap multibagger, Indian stocks NSE BSE, US stocks NYSE NASDAQ, investment research, stock screener, AI investment tool, portfolio analysis, stock recommendation, market intelligence, Nifty 50 analysis, Bank Nifty options, option chain analysis, management tone analysis, earnings analysis QoQ YoY, celesys, celesys ai">
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<meta name="author" content="Celesys AI">
<meta name="application-name" content="Celesys AI">
<meta name="rating" content="general">
<meta name="category" content="Finance, Stock Analysis, Investment Research">
<meta name="topic" content="AI-powered stock analysis platform for retail investors">
<meta name="google-site-verification" content="googleb6e1e80f88761fcc">
<meta name="google-adsense-account" content="ca-pub-2084524493538975">
<link rel="canonical" href="https://celesys.ai">

<!-- Open Graph / Social Sharing -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://celesys.ai">
<meta property="og:title" content="Celesys AI — Free AI Stock Analysis in 60 Seconds">
<meta property="og:description" content="Get professional-grade stock analysis in 60 seconds. Real-time data, AI valuation, exact buy/sell prices, risk scoring, and hidden small-cap picks. Completely free.">
<meta property="og:site_name" content="Celesys AI">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://celesys.ai/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Celesys AI — Free AI Stock Analysis in 60 Seconds">
<meta name="twitter:description" content="Stop guessing. Get AI-powered stock analysis with real-time data, exact entry/exit prices, and risk scoring — free, in 60 seconds.">
<meta name="twitter:image" content="https://celesys.ai/og-image.png">
<meta name="twitter:site" content="@celesysai">

<!-- Additional SEO -->
<meta name="theme-color" content="#f8f9fa">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Celesys AI">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">

<!-- Preconnect for performance (helps Core Web Vitals / SEO ranking) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- JSON-LD Structured Data (rich results in Google) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Celesys AI",
  "alternateName": ["Celesys AI Stock Analyzer", "Celesys Stock Research Platform"],
  "url": "https://celesys.ai",
  "description": "Celesys AI is a free, AI-powered stock analysis platform that delivers institutional-grade research reports in 60 seconds. It provides real-time valuation metrics, intrinsic value calculations (Graham Number, DCF), buy/sell price targets, 20-factor risk scoring, quarterly earnings analysis with QoQ/YoY trends, management tone assessment, and curated small-cap stock picks for US (NYSE, NASDAQ) and Indian (NSE, BSE) markets.",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "Web",
  "browserRequirements": "Requires JavaScript. Works on all modern browsers.",
  "softwareVersion": "2.0",
  "datePublished": "2025-01-01",
  "dateModified": "2026-02-19",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "description": "5 free deep-dive stock analysis reports per hour. No signup, no credit card required.",
    "availability": "https://schema.org/InStock"
  },
  "featureList": [
    "Real-time stock price data from Yahoo Finance and Google Finance",
    "AI-powered buy/sell price targets with entry and exit levels",
    "20-factor deterministic stock verdict engine (P/E, profitability, financial health, 52-week position, P/B, dividend, beta, operating efficiency)",
    "Intrinsic value calculations: Graham Number, DCF growth model, Peter Lynch fair value, earnings yield vs bond comparison",
    "Quarterly earnings analysis with QoQ and YoY growth trends",
    "Management tone and CEO/CFO confidence assessment",
    "Hidden small-cap and micro-cap stock recommendations",
    "NSE option chain analysis with PCR, max pain, and OI walls",
    "Smart Trades: daily AI-generated index and stock trade ideas",
    "Curated stock picks: large-cap, mid-cap, small-cap, niche moat, micro-cap multibaggers, best performing indices",
    "Financial health radar: profit margin, ROE, current ratio, operating margin, dividend yield",
    "Risk profile scoring: volatility, debt, liquidity, valuation, sector risk",
    "Valuation metrics charting: P/E, P/B, dividend yield with interactive tooltips",
    "6-month historical price trend with real monthly close data",
    "Margin vs industry comparison benchmarking",
    "US stocks (NYSE, NASDAQ) and Indian stocks (NSE, BSE) coverage",
    "Global market indices ticker: S&P 500, NASDAQ, Dow Jones, Nifty 50, Sensex, FTSE 100, DAX, Nikkei 225"
  ],
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "ratingCount": "1250",
    "bestRating": "5",
    "worstRating": "1"
  },
  "screenshot": "https://celesys.ai/og-image.png",
  "creator": {
    "@type": "Organization",
    "name": "Celesys AI",
    "url": "https://celesys.ai",
    "email": "contact@celesys.ai",
    "foundingDate": "2025",
    "description": "Celesys AI builds free, AI-powered financial research tools that democratize access to institutional-grade stock analysis for retail investors worldwide."
  },
  "audience": {
    "@type": "Audience",
    "audienceType": "Retail investors, stock traders, financial analysts, portfolio managers"
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is Celesys AI and how does it work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI is a free AI-powered stock analysis platform. Enter any US or Indian stock ticker and receive a comprehensive research report in 60 seconds — including real-time valuation metrics, intrinsic value estimates using Graham Number and DCF models, buy/sell price targets, 20-factor risk scoring, quarterly earnings trends, management tone analysis, and curated small-cap recommendations. No signup required."
      }
    },
    {
      "@type": "Question",
      "name": "Is Celesys AI free to use?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, Celesys AI is completely free. You get 5 deep-dive stock analysis reports per email per hour with no credit card, no subscription, and no hidden fees. The platform is funded as an educational research tool to democratize access to institutional-quality financial analysis."
      }
    },
    {
      "@type": "Question",
      "name": "Which stock markets and tickers does Celesys AI support?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI supports 100+ pre-loaded US stocks from NYSE and NASDAQ (like AAPL, TSLA, NVDA, GOOGL, META) and Indian NSE/BSE stocks (like RELIANCE.NS, TCS.NS, HDFCBANK.NS, INFY.NS). You can also enter any valid Yahoo Finance ticker symbol for global market coverage including European, Asian, and emerging market equities."
      }
    },
    {
      "@type": "Question",
      "name": "How does the 20-factor stock verdict engine work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The Celesys AI verdict engine scores stocks across 20 quantitative factors: P/E valuation, forward P/E discount, profitability (margins and ROE), financial health (debt-to-equity, current and quick ratio), cash vs debt position, 52-week price position, price-to-book value, dividend yield and sustainability, beta/volatility risk, operating efficiency, earnings velocity (EPS + revenue CAGR), relative valuation vs sector P/E, technical momentum (SMA 20/50/200 crossovers), PEG ratio, cash flow quality (FCF margin), EV/EBITDA enterprise valuation, gross margin power, EBITDA margin quality, short interest signal, and multi-factor quality combos. The combined score produces a deterministic verdict — Strong Buy, Buy, Accumulate, Hold, Sell, or Strong Sell — that remains consistent regardless of daily price noise."
      }
    },
    {
      "@type": "Question",
      "name": "How does Celesys AI calculate intrinsic value?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Celesys AI computes intrinsic value using four established models: the Graham Number (square root of 22.5 × EPS × book value per share), the Benjamin Graham DCF growth formula (EPS × (8.5 + 2g)), the Peter Lynch fair value (EPS × growth rate for PEG ratio of 1), and earnings yield comparison versus 10-year treasury bond rates. These help investors assess whether a stock is trading above or below its fundamental worth."
      }
    },
    {
      "@type": "Question",
      "name": "What is the management tone analysis in Celesys AI?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The management tone analysis uses real earnings data, analyst ratings, insider trading activity, institutional ownership patterns, and forward guidance to assess whether a company's leadership is bullish, cautious, or defensive. It helps investors read between the lines of earnings calls and corporate communications to gauge management confidence and credibility."
      }
    },
    {
      "@type": "Question",
      "name": "What are Smart Trades and curated stock picks?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Smart Trades provides daily AI-generated trade ideas for Nifty 50, Bank Nifty, Sensex, and high-momentum stocks using a 10-factor scoring engine with live NSE option chain data. Curated Stock Picks lists the top 5 undervalued companies across six categories: large-cap, mid-cap, small-cap, niche/deep moat companies, micro-cap multibagger candidates, and best-performing stock market indices — for both India and USA markets."
      }
    },
    {
      "@type": "Question",
      "name": "Is Celesys AI a replacement for a financial advisor?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "No. Celesys AI is an educational research tool, not a licensed financial advisor. All analysis, buy/sell targets, risk scores, and recommendations are AI-generated for educational purposes only. Always consult a certified financial advisor before making investment decisions. Market data may be delayed or incomplete — cross-check with your broker."
      }
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://celesys.ai"},
    {"@type": "ListItem", "position": 2, "name": "About", "item": "https://celesys.ai/about"},
    {"@type": "ListItem", "position": 3, "name": "FAQ", "item": "https://celesys.ai/faq"},
    {"@type": "ListItem", "position": 4, "name": "Privacy Policy", "item": "https://celesys.ai/privacy"},
    {"@type": "ListItem", "position": 5, "name": "Terms of Service", "item": "https://celesys.ai/terms"},
    {"@type": "ListItem", "position": 6, "name": "Disclaimer", "item": "https://celesys.ai/disclaimer"}
  ]
}
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Sora:wght@600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#f8f9fa;--bg2:#ffffff;--bg3:#f0f2f5;--surface:#ffffff;--glass:rgba(255,255,255,0.95);--border:rgba(0,47,108,0.1);--border2:rgba(0,47,108,0.2);--blue:#002f6c;--blue2:#004a99;--cyan:#0a6ebd;--teal:#0d9488;--green:#14a23a;--green2:#0d8a2e;--amber:#d48a00;--red:#d0021b;--purple:#6b21a8;--text:#171717;--text2:#555555;--text3:#888888;--mono:'IBM Plex Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:clip;padding-bottom:90px}

/* Grid background */
.gridbg{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(59,130,246,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,0.025) 1px,transparent 1px);background-size:48px 48px}
.gridbg::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 900px 500px at 50% 0%,rgba(59,130,246,0.06),transparent 70%)}

/* NAV */
nav{position:sticky;top:30px;z-index:99;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);background:rgba(255,255,255,0.98);border-bottom:1px solid rgba(0,47,108,.08);height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.nbrand{display:flex;align-items:center;gap:11px}
.nlogo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#002f6c,#0a6ebd);display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:#fff;box-shadow:0 2px 8px rgba(0,47,108,.12)}
.nname{font-family:'Sora',sans-serif;font-size:15px;font-weight:700;letter-spacing:.3px;color:var(--text)}.nname span{color:var(--blue)}.ntag{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-weight:600;margin-top:-2px;display:block}
.ncenter{display:flex;gap:6px;align-items:center}
.npill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:500;background:rgba(59,130,246,.06);border:1px solid var(--border);color:var(--text3)}
.npill .v{color:var(--blue);font-family:var(--mono);font-weight:600}
.nright{display:flex;align-items:center;gap:6px}
.nlive{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:600;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:var(--green)}
.ldot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pdot 2s infinite}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* HERO */
.hero{position:relative;z-index:1;padding:28px 28px 16px;text-align:center}
.sticky-tagline{position:fixed;top:90px;left:0;width:100%;z-index:98;text-align:center;padding:6px 0;background:rgba(255,255,255,.98);border-bottom:1px solid rgba(0,47,108,.08);transform:translateY(-100%);opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.sticky-tagline.vis{transform:translateY(0);opacity:1;pointer-events:auto}
.sticky-tagline span{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;background:linear-gradient(135deg,#555,#002f6c,#6b21a8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.3px}
.hero-eye{display:inline-flex;align-items:center;gap:6px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);padding:7px 18px;border-radius:100px;font-size:12px;font-weight:600;color:var(--blue);margin-bottom:24px;letter-spacing:.3px}
.hero h1{font-family:'Sora',sans-serif;font-size:clamp(28px,4.5vw,48px);font-weight:800;line-height:1.15;margin-bottom:10px;background:linear-gradient(135deg,#171717 0%,#002f6c 50%,#0a6ebd 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-size:15px;color:var(--text2);max-width:560px;margin:0 auto 16px;line-height:1.7}
.qpick{padding:4px 10px;border-radius:6px;border:1px solid #e0e4ea;background:#ffffff;color:var(--text2);font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;white-space:nowrap}
.qpick:hover{background:var(--blue);color:#fff;border-color:var(--blue);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,47,108,.15)}
.feat-card{background:#ffffff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;text-align:center;transition:all .2s}
.feat-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-2px)}
@media(max-width:600px){.feat-card{padding:8px}.hero .icard{padding:14px}.hero-sub{font-size:13px}}
.hbadges{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.hb{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:8px;font-size:11px;font-weight:600;letter-spacing:.2px;border:1px solid #d1d5db;background:#ffffff;color:var(--text2)}

/* INPUT */
.isection{position:relative;z-index:1;max-width:720px;margin:0 auto;padding:0 20px 24px}
.icard{background:#ffffff;border:1px solid rgba(0,47,108,.1);border-radius:16px;padding:28px;box-shadow:0 2px 12px rgba(0,0,0,.06);position:relative;overflow:hidden}
.icard::before{content:'';position:absolute;top:-1px;left:50%;transform:translateX(-50%);width:100px;height:2px;background:linear-gradient(90deg,transparent,var(--blue),transparent);border-radius:2px}
.ilabel{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px}
.irow{display:grid;grid-template-columns:1fr 1fr 110px;gap:10px}
.iwrap{position:relative}
.ipt{width:100%;padding:12px 14px;background:#ffffff;border:1.5px solid #d1d5db;border-radius:10px;font-size:14px;color:var(--text);font-family:'DM Sans',sans-serif;transition:all .3s;outline:none}
.ipt::placeholder{color:var(--text3)}.ipt:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,120,212,.08)}
.ac{position:absolute;top:100%;left:0;right:0;background:#ffffff;border:1.5px solid #d1d5db;border-top:none;border-radius:0 0 10px 10px;max-height:280px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.ac.show{display:block}
.aci{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:all .2s;display:flex;align-items:center;gap:8px}
.aci:hover{background:rgba(59,130,246,.05);padding-left:18px}
.act{font-family:var(--mono);font-weight:600;color:var(--blue);font-size:13px;min-width:75px}.acn{color:var(--text2);font-size:12px}
.btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .3s;background:linear-gradient(135deg,#002f6c,#0a6ebd);color:#fff;letter-spacing:.2px}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.25)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.ld{background:var(--bg3);color:var(--blue);border:1.5px solid var(--border2)}
.hlp{margin-top:14px;font-size:11px;color:var(--text3);line-height:1.7}.hlp a{color:var(--blue);text-decoration:none}.hlp strong{color:var(--text2)}

/* STATUS */
.sbar{margin-top:14px;padding:12px 16px;border-radius:10px;display:none;font-size:13px;font-weight:500;border:1px solid;align-items:center;gap:8px}
.sbar.show{display:flex;animation:sld .3s ease}.sbar.info{background:rgba(59,130,246,.06);border-color:rgba(0,120,212,.25);color:var(--blue)}
.sbar.success{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.2);color:var(--green)}.sbar.error{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.2);color:var(--red)}
@keyframes sld{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

/* LOADING */
.lsteps{margin-top:14px;display:none}.lsteps.show{display:block}
.ls{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:12px;color:var(--text3);opacity:0;transform:translateX(-8px);transition:all .4s}
.ls.on{opacity:1;transform:translateX(0);color:var(--blue)}.ls.ok{opacity:1;transform:translateX(0);color:var(--green)}
.lsi{width:22px;height:22px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;font-family:var(--mono);transition:all .3s}
.ls.on .lsi{border-color:var(--blue);color:var(--blue);animation:pdot 1.5s infinite}.ls.ok .lsi{border-color:var(--green);background:var(--green);color:var(--bg)}

/* RATE LIMIT */
.rlbox{margin-top:14px;display:none;padding:20px;border-radius:12px;text-align:center;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.2)}
.rlbox .rlcd{font-family:var(--mono);font-size:38px;font-weight:700;color:var(--amber);margin:8px 0;letter-spacing:3px}
.rlbox .rlmsg{font-size:12px;color:var(--text3)}
.rlbox .rlbar{width:100%;height:3px;background:rgba(245,158,11,.1);border-radius:2px;margin-top:12px;overflow:hidden}
.rlbox .rlbf{height:100%;background:linear-gradient(90deg,var(--amber),var(--green));border-radius:2px;transition:width 1s linear}

/* REPORT */
.rpt{position:relative;max-width:1080px;margin:0 auto;padding:0 20px 64px;display:none}
.rpt.show{display:block;animation:fu .6s ease}
@keyframes fu{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

.rphero{text-align:center;margin-bottom:12px;padding:20px 24px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(135deg,rgba(0,47,108,.02),rgba(0,47,108,.01));position:relative;overflow:hidden}
.rphero::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(59,130,246,.02),transparent,rgba(6,182,212,.02),transparent);animation:spin 25s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.rphero>*{position:relative;z-index:1}
.rptk{display:inline-block;font-family:var(--mono);font-size:13px;font-weight:600;color:var(--blue);background:rgba(0,120,212,.12);padding:5px 16px;border-radius:6px;border:1px solid rgba(0,120,212,.25);margin-bottom:12px;letter-spacing:.8px}
.rpco{font-family:'Sora',sans-serif;font-size:clamp(20px,3vw,28px);font-weight:800;margin-bottom:4px}
.rplv{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--green);font-weight:500}

/* METRICS */
.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
.mcard{background:#ffffff;border:1px solid rgba(0,47,108,.08);border-radius:10px;padding:14px 12px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,.03);transition:all .3s;position:relative;overflow:hidden}
.mcard:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,120,212,.06)}
.mcard::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--cyan));opacity:0;transition:opacity .3s}.mcard:hover::after{opacity:1}
.ml{font-size:9px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:600;margin-bottom:4px}
.mv{font-family:var(--mono);font-size:20px;font-weight:700;color:var(--text);margin-bottom:2px}
.ms{font-size:12px;font-weight:600}.ms.up{color:var(--green)}.ms.dn{color:var(--red)}.ms.nu{color:var(--text3)}

/* CHARTS */
.cgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:24px}
.cgrid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-bottom:24px}
.ccard{background:#ffffff;border:1px solid rgba(0,47,108,.08);border-radius:14px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.cct{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:14px;display:flex;align-items:center;gap:6px}
.cc{height:180px}
.cc2{height:200px}

/* STICKY INPUT */
.isection{position:relative;z-index:1}

/* SECTIONS - Always open, no accordion */
.sc{background:#ffffff;border:1px solid rgba(0,47,108,.08);border-radius:8px;padding:0;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.03);overflow:visible;scroll-margin-top:140px}
.sc:hover{border-color:var(--border2)}
.sh{display:flex;align-items:center;gap:8px;padding:12px 18px 0}
.si{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.st{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;letter-spacing:-.2px;flex:1;scroll-margin-top:150px}
.sbody{padding:12px 18px 16px;overflow:visible}
.tab-bar{display:flex;gap:3px;margin-bottom:0;background:linear-gradient(135deg,#f0f4f8 0%,#e8eef5 100%);border:none;border-bottom:2px solid #c8d3e0;border-radius:0;padding:6px 6px 0;position:sticky;top:90px;z-index:97;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;box-shadow:0 4px 20px rgba(0,20,60,.1)}
.tab-bar::-webkit-scrollbar{display:none}
.tab-bar.attention{animation:tabPulse 2s ease 3;border-color:rgba(59,130,246,.5);box-shadow:0 0 20px rgba(59,130,246,.15)}
@keyframes tabPulse{0%,100%{border-color:rgba(0,120,212,.25);box-shadow:0 0 10px rgba(59,130,246,.05)}50%{border-color:rgba(59,130,246,.6);box-shadow:0 0 25px rgba(0,120,212,.25)}}
.tab-scroll-area{overflow-y:visible;border:none;border-radius:0;padding:18px 0;background:transparent;scrollbar-width:thin;scrollbar-color:rgba(0,47,108,.15) transparent}
.tab-scroll-area::-webkit-scrollbar{width:6px}.tab-scroll-area::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px}.tab-scroll-area::-webkit-scrollbar-track{background:transparent}
.tab-btn{flex:none;padding:10px 18px;border:none;border-radius:10px 10px 0 0;cursor:pointer;font-family:'Sora',sans-serif;font-size:12px;font-weight:700;transition:all .25s;background:transparent;color:#7b8da0;letter-spacing:.3px;display:flex;align-items:center;justify-content:center;gap:6px;border-bottom:3px solid transparent;white-space:nowrap;position:relative}
.tab-btn .tab-icon{font-size:15px;display:inline-flex;width:26px;height:26px;align-items:center;justify-content:center;border-radius:8px;transition:all .25s}
/* Inactive state — subtle colored tint so each tab is distinguishable */
.tab-btn[data-color="green"]{color:#2d8a4e;background:rgba(20,162,58,.06)}.tab-btn[data-color="green"] .tab-icon{background:rgba(20,162,58,.1);color:#14a23a}
.tab-btn[data-color="navy"]{color:#3d6099;background:rgba(0,47,108,.05)}.tab-btn[data-color="navy"] .tab-icon{background:rgba(0,47,108,.08);color:#1a5fb4}
.tab-btn[data-color="purple"]{color:#8b5cb6;background:rgba(139,92,246,.05)}.tab-btn[data-color="purple"] .tab-icon{background:rgba(139,92,246,.1);color:#7c3aed}
.tab-btn[data-color="cyan"]{color:#1882c7;background:rgba(6,182,212,.05)}.tab-btn[data-color="cyan"] .tab-icon{background:rgba(6,182,212,.1);color:#0891b2}
.tab-btn[data-color="amber"]{color:#b45309;background:rgba(245,158,11,.06)}.tab-btn[data-color="amber"] .tab-icon{background:rgba(245,158,11,.12);color:#d97706}
.tab-btn[data-color="teal"]{color:#0d7d72;background:rgba(13,148,136,.05)}.tab-btn[data-color="teal"] .tab-icon{background:rgba(13,148,136,.1);color:#0d9488}
.tab-btn[data-color="blue"]{color:#2563eb;background:rgba(37,99,235,.05)}.tab-btn[data-color="blue"] .tab-icon{background:rgba(37,99,235,.1);color:#2563eb}
.tab-btn[data-color="red"]{color:#c0392b;background:rgba(239,68,68,.06)}.tab-btn[data-color="red"] .tab-icon{background:rgba(239,68,68,.1);color:#dc2626}
.tab-btn:hover:not(.active){transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.tab-btn.active{font-weight:800;box-shadow:0 -2px 12px rgba(0,0,0,.08);border-bottom:3px solid transparent;transform:translateY(-2px)}
.tab-btn[data-color="green"].active{color:#fff;border-bottom-color:#14a23a;background:linear-gradient(135deg,#14a23a,#0d8a32)}
.tab-btn[data-color="green"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="blue"].active{color:#fff;border-bottom-color:#2563eb;background:linear-gradient(135deg,#2563eb,#1d4ed8)}
.tab-btn[data-color="blue"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="navy"].active{color:#fff;border-bottom-color:#1a5fb4;background:linear-gradient(135deg,#1a5fb4,#0f3d7a)}
.tab-btn[data-color="navy"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="purple"].active{color:#fff;border-bottom-color:#7c3aed;background:linear-gradient(135deg,#7c3aed,#6d28d9)}
.tab-btn[data-color="purple"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="cyan"].active{color:#fff;border-bottom-color:#0891b2;background:linear-gradient(135deg,#0891b2,#0e7490)}
.tab-btn[data-color="cyan"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="amber"].active{color:#fff;border-bottom-color:#d97706;background:linear-gradient(135deg,#d97706,#b45309)}
.tab-btn[data-color="amber"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="red"].active{color:#fff;border-bottom-color:#dc2626;background:linear-gradient(135deg,#dc2626,#b91c1c)}
.tab-btn[data-color="red"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn[data-color="teal"].active{color:#fff;border-bottom-color:#0d9488;background:linear-gradient(135deg,#0d9488,#0f766e)}
.tab-btn[data-color="teal"].active .tab-icon{background:rgba(255,255,255,.25);color:#fff}
.tab-btn::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:#ffffff;color:var(--text2);font-size:11px;font-weight:400;padding:8px 14px;border-radius:8px;border:1px solid #e5e7eb;white-space:nowrap;max-width:280px;white-space:normal;text-align:center;line-height:1.5;opacity:0;pointer-events:none;transition:opacity .2s;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,.1)}
.tab-btn:hover::after{opacity:1}
.sc[data-tab]{display:none}
.go-deeper-btn{display:block;width:100%;margin:18px 0;padding:16px;border:2px dashed rgba(139,92,246,.4);border-radius:12px;background:rgba(139,92,246,.06);color:var(--purple);font-family:'Sora',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .3s;text-align:center}
.go-deeper-btn:hover{background:rgba(139,92,246,.12);border-color:var(--purple);transform:translateY(-1px)}

/* Verdict */
.vpill{display:inline-flex;padding:8px 24px;border-radius:100px;font-family:'Sora',sans-serif;font-size:15px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;animation:vg 2s ease-in-out infinite alternate}
.vpill.buy{background:rgba(16,185,129,.12);color:var(--green);border:2px solid var(--green)}
.vpill.hold{background:rgba(245,158,11,.12);color:var(--amber);border:2px solid var(--amber)}
.vpill.sell{background:rgba(239,68,68,.12);color:var(--red);border:2px solid var(--red)}
@keyframes vg{0%{box-shadow:0 0 16px rgba(59,130,246,.05)}100%{box-shadow:0 0 32px rgba(59,130,246,.12)}}

/* Tables */
.dt{width:100%;border-collapse:collapse}
.dt th{padding:12px 14px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:600;border-bottom:1px solid #e5e7eb;background:#f8f9fa}
.dt td{padding:12px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;color:var(--text2);transition:background .2s}
.dt tr:hover td{background:#f8f9fa}.dt tr:last-child td{border-bottom:none}

/* Decision list */
.dl{list-style:none;padding:0}.dl li{padding:12px 0 12px 32px;position:relative;font-size:13px;color:var(--text2);line-height:1.7;border-bottom:1px solid var(--border)}
.dl li:last-child{border-bottom:none}.dl li::before{content:'';position:absolute;left:0;top:16px;width:18px;height:18px;border-radius:50%;background:rgba(0,120,212,.12);border:1.5px solid var(--blue)}
.dl li strong{color:var(--text)}

/* Price tags */
.ptag{display:inline-block;padding:5px 12px;border-radius:6px;font-family:var(--mono);font-size:13px;font-weight:600}
.ptag.buy{background:rgba(16,185,129,.08);color:var(--green);border:1px solid rgba(16,185,129,.2)}
.ptag.cur{background:rgba(0,120,212,.08);color:var(--blue);border:1px solid rgba(0,120,212,.25)}
.ptag.pro{background:rgba(245,158,11,.08);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.ptag.stp{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2)}

/* Signals */
.sig{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:5px;font-size:11px;font-weight:700}
.sig.g{background:rgba(16,185,129,.1);color:var(--green)}.sig.c{background:rgba(245,158,11,.1);color:var(--amber)}
.sig.r{background:rgba(239,68,68,.1);color:var(--red)}.sig.n{background:rgba(148,163,184,.08);color:var(--text3)}

/* Info cards */
.ic{padding:18px;border-radius:10px;margin-bottom:12px;border-left:3px solid}
.ic h5{font-size:14px;font-weight:700;margin-bottom:6px}.ic p{font-size:13px;line-height:1.8;color:var(--text2)}
.ic.bl{background:rgba(59,130,246,.03);border-color:var(--blue)}.ic.bl h5{color:var(--blue)}
.ic.am{background:rgba(245,158,11,.03);border-color:var(--amber)}.ic.am h5{color:var(--amber)}
.ic.gr{background:rgba(16,185,129,.03);border-color:var(--green)}.ic.gr h5{color:var(--green)}
.ic.rd{background:rgba(239,68,68,.03);border-color:var(--red)}.ic.rd h5{color:var(--red)}
.ic.pu{background:rgba(139,92,246,.03);border-color:var(--purple)}.ic.pu h5{color:var(--purple)}

.aix{display:inline-flex;align-items:center;gap:5px;cursor:pointer;color:var(--blue);font-size:12px;font-weight:600;padding:6px 0;transition:color .2s}.aix:hover{color:var(--blue2)}
.ait{line-height:1.9;color:var(--text2);font-size:13px;white-space:pre-wrap}
.ait::-webkit-scrollbar{width:5px}.ait::-webkit-scrollbar-track{background:var(--bg);border-radius:3px}.ait::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px}.ait::-webkit-scrollbar-thumb:hover{background:rgba(59,130,246,.4)}

/* 52-week position bar */
.w52bar{position:relative;height:6px;background:#e5e7eb;border-radius:3px;margin:8px 0 4px;overflow:visible}
.w52fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--red),var(--amber),var(--green))}
.w52dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:var(--blue);border:2px solid #fff;box-shadow:0 0 8px rgba(59,130,246,.4);z-index:2}
.w52labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--text3)}
.dec-input{background:#ffffff;border:1px solid #d1d5db;border-radius:8px;padding:8px 12px;color:var(--text);font-family:var(--mono);font-size:14px;font-weight:700;width:130px;text-align:right;outline:none;transition:border .2s}
.dec-input:focus{border-color:var(--blue)}
.dec-badge{display:inline-flex;align-items:center;gap:4px;padding:6px 14px;border-radius:8px;font-family:'Sora',sans-serif;font-size:13px;font-weight:800;letter-spacing:.5px}
.dec-meter{height:6px;border-radius:3px;background:#e5e7eb;overflow:hidden;margin:4px 0}
.dec-meter-fill{height:100%;border-radius:3px;transition:width .8s ease}

/* Score bar */
.scorebar{height:6px;background:rgba(148,163,184,.1);border-radius:3px;overflow:hidden;margin:6px 0}
.scorefill{height:100%;border-radius:3px;transition:width .8s ease}

/* Footer */
footer{position:relative;z-index:1;margin-top:32px;background:#002f6c;border-top:1px solid rgba(0,47,108,.06)}
.ftop{max-width:1080px;margin:0 auto;padding:48px 28px 32px;display:grid;grid-template-columns:1.4fr 1fr 1fr;gap:40px}
.ftop h5{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:#fff;margin-bottom:14px}
.ftop p{font-size:12px;color:var(--text3);line-height:1.8;margin-bottom:8px}
.fbrand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.fblogo{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,#ffffff,#e0e7f0);display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:#002f6c}
.fbname{font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:#fff}.fbname span{color:var(--blue)}
.ffeature{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text3);padding:5px 0}
.ffeature::before{content:'\2713';color:var(--green);font-weight:700;font-size:10px}
.fdisc{max-width:1080px;margin:0 auto;padding:0 28px 32px}
.fdbox{padding:24px;border-radius:12px;background:rgba(239,68,68,.05);border:1.5px solid rgba(239,68,68,.2);position:relative;overflow:hidden}
.fdbox::before{content:'\26A0';position:absolute;top:12px;right:16px;font-size:44px;opacity:.06}
.fdbox h4{color:var(--red);font-size:13px;font-weight:800;margin-bottom:12px;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:6px}
.fdbox p{color:var(--text2);font-size:12px;line-height:1.8;margin-bottom:8px;padding-left:14px;border-left:2px solid rgba(239,68,68,.15)}
.fdbox p strong{color:var(--red);font-weight:700}
.fdbox p:last-child{margin-bottom:0}
.fbot{max-width:1080px;margin:0 auto;padding:24px 28px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.fcopy{font-size:11px;color:var(--text3)}.fcopy strong{color:var(--text2)}
.flinks{display:flex;gap:16px}.flinks a{font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s}.flinks a:hover{color:var(--blue)}

@media(max-width:768px){.irow{grid-template-columns:1fr}.mgrid{grid-template-columns:1fr 1fr}.cgrid,.cgrid2{grid-template-columns:1fr}.hero{padding:20px 16px 12px}.hero h1{font-size:26px}.ncenter,.nright{display:none}.sc{padding:0}.ftop{grid-template-columns:1fr;gap:24px}.fbot{flex-direction:column;text-align:center}.tab-btn{font-size:10px;padding:10px 12px;gap:3px}.tab-btn .tab-icon{width:20px;height:20px;font-size:12px;border-radius:4px}.tab-bar{position:sticky;top:60px;padding:2px 2px 0}.sub-nav{top:105px}.tab-scroll-area{padding:10px}.fab{bottom:96px;right:16px;padding:8px 16px;font-size:12px}.edu-bar{padding:10px 12px}.edu-bar .edu-lines{gap:3px 12px}.edu-bar .edu-line{font-size:9px}.feat-card{padding:8px}.icard{padding:16px;border-radius:12px}#convGrid{grid-template-columns:1fr !important}}
@media(max-width:480px){.mgrid{grid-template-columns:1fr}.hbadges{flex-direction:column;align-items:center}}

/* FLOATING FEEDBACK PANEL */
.fab{position:fixed;bottom:100px;right:24px;z-index:200;display:flex;align-items:center;gap:6px;padding:10px 20px;border-radius:100px;font-size:13px;font-weight:700;color:#fff;background:linear-gradient(135deg,#002f6c,#6b21a8);cursor:pointer;box-shadow:0 4px 16px rgba(0,47,108,.2);transition:all .3s;border:none;font-family:'DM Sans',sans-serif;letter-spacing:.2px;animation:fabBounce 3s ease-in-out infinite}
.edu-bar{position:fixed;bottom:0;left:0;width:100%;z-index:199;padding:14px 24px;background:rgba(255,255,255,0.98);border-top:1px solid rgba(208,2,27,.15);backdrop-filter:blur(12px)}
.edu-bar .edu-title{font-family:'Sora',sans-serif;font-size:12px;font-weight:800;color:var(--red);letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.edu-bar .edu-lines{display:flex;flex-wrap:wrap;gap:4px 20px}
.edu-bar .edu-line{font-size:10px;color:var(--text3);line-height:1.5;padding-left:10px;border-left:2px solid rgba(239,68,68,.3)}
.edu-bar .edu-line strong{color:var(--red);font-weight:700;font-size:10px;letter-spacing:.3px}
.fab:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 8px 30px rgba(59,130,246,.4);animation:none}
.fab .pulse{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pdot 2s infinite}
@keyframes fabBounce{0%,100%{transform:translateY(0);box-shadow:0 4px 20px rgba(59,130,246,.3)}25%{transform:translateY(-8px);box-shadow:0 12px 30px rgba(139,92,246,.4)}50%{transform:translateY(0);box-shadow:0 4px 20px rgba(59,130,246,.3)}75%{transform:translateY(-4px);box-shadow:0 8px 25px rgba(139,92,246,.35)}}
@keyframes notifPop{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}

/* Slide panel */
.fpanel{position:fixed;top:0;right:-480px;width:460px;max-width:92vw;height:100vh;z-index:300;background:#f0f2f5;border-left:1px solid var(--border2);overflow-y:auto;transition:right .4s cubic-bezier(.16,1,.3,1);box-shadow:-8px 0 40px rgba(0,0,0,.5)}
.fpanel.open{right:0}
.fpanel::-webkit-scrollbar{width:5px}.fpanel::-webkit-scrollbar-thumb{background:rgba(0,120,212,.25);border-radius:3px}
.fphdr{position:sticky;top:0;z-index:1;padding:20px 24px;background:rgba(255,255,255,.98);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.fphdr h3{font-family:'Sora',sans-serif;font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--amber),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.fpclose{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.fpclose:hover{background:rgba(239,68,68,.1);color:var(--red);border-color:rgba(239,68,68,.2)}
.fpbody{padding:20px 24px 32px}
.fpbody .sub{font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:24px}

/* Feature cards (panel version) */
.pfcard{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;transition:all .3s}
.pfcard:hover{border-color:var(--border2)}
.pfcard .pfrow{display:flex;align-items:flex-start;gap:12px}
.pfcard .pficon{font-size:24px;flex-shrink:0;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(59,130,246,.05)}
.pfcard .pfinfo{flex:1;min-width:0}
.pfcard .pfname{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;display:flex;align-items:center;gap:6px}
.pfcard .pfdesc{font-size:11px;color:var(--text3);line-height:1.6}
.pfcard .ftag{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;padding:2px 7px;border-radius:100px}
.ftag.hot{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.15)}
.ftag.new{background:rgba(16,185,129,.1);color:var(--green);border:1px solid rgba(16,185,129,.15)}
.ftag.pro{background:rgba(139,92,246,.1);color:var(--purple);border:1px solid rgba(139,92,246,.15)}

/* Vote buttons */
.pvbtns{display:flex;gap:6px;margin-top:10px}
.pvbtn{display:flex;align-items:center;gap:4px;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text3);font-family:'DM Sans',sans-serif}
.pvbtn:hover{transform:scale(1.05)}
.pvbtn.up:hover,.pvbtn.up.voted{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3);color:var(--green)}
.pvbtn.dn:hover,.pvbtn.dn.voted{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:var(--red)}
.pvbtn .cnt{font-family:var(--mono);font-size:10px}
.pvbar{margin-top:6px;height:3px;border-radius:2px;background:rgba(148,163,184,.08);overflow:hidden}
.pvbar .vfill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--blue));transition:width .5s ease}

/* Vote chart in panel */
.vgp{margin-top:20px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px}
.vgp h4{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;text-align:center}
.vgp .vsub{font-size:10px;color:var(--text3);text-align:center;margin-bottom:12px}
.vgp .cc{height:200px}

.sendbox{text-align:center;margin-top:16px}
.sendbtn{display:inline-flex;align-items:center;gap:6px;padding:9px 20px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1.5px solid rgba(59,130,246,.3);background:rgba(59,130,246,.06);color:var(--blue);transition:all .3s;font-family:'DM Sans',sans-serif;width:100%}
.sendbtn:hover{background:rgba(59,130,246,.12)}

/* Backdrop */
.fpbk{position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .3s}
.fpbk.open{opacity:1;pointer-events:auto}

@media(max-width:768px){.fab{bottom:96px;right:16px;padding:8px 16px;font-size:12px}}

/* Allow users to copy prices, data, and analysis text */
.hbadges,.tab-bar,.fab,.nav,.sh{-webkit-user-select:none;-moz-user-select:none;user-select:none}

/* Back to top button */
.btt{position:fixed;bottom:100px;left:24px;z-index:200;padding:8px 16px;border-radius:100px;font-size:12px;font-weight:700;color:var(--text3);background:var(--surface);border:1px solid var(--border);cursor:pointer;opacity:0;transform:translateY(20px);transition:all .3s;font-family:'DM Sans',sans-serif}
.btt.show{opacity:1;transform:translateY(0)}
.btt:hover{color:var(--blue);border-color:var(--blue);background:rgba(59,130,246,.06)}

/* Scroll down hint between charts and tabs */
.sub-nav{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;padding:10px 14px;position:sticky;top:140px;z-index:96;background:rgba(255,255,255,.97);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,47,108,.08);margin-left:-18px;margin-right:-18px}
.sub-nav a{font-size:11px;font-weight:700;padding:6px 14px;border-radius:100px;text-decoration:none;transition:all .25s;cursor:pointer;white-space:nowrap;letter-spacing:.2px}
/* Summary sub-tab colors */
.sub-nav[data-tab="quick"] a:nth-child(1){color:#14a23a;background:rgba(20,162,58,.08);border:1.5px solid rgba(20,162,58,.2)}
.sub-nav[data-tab="quick"] a:nth-child(2){color:#2563eb;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.2)}
.sub-nav[data-tab="quick"] a:nth-child(3){color:#7c3aed;background:rgba(124,58,237,.08);border:1.5px solid rgba(124,58,237,.2)}
.sub-nav[data-tab="quick"] a:nth-child(4){color:#0891b2;background:rgba(8,145,178,.08);border:1.5px solid rgba(8,145,178,.2)}
.sub-nav[data-tab="quick"] a:nth-child(5){color:#dc2626;background:rgba(220,38,38,.08);border:1.5px solid rgba(220,38,38,.2)}
.sub-nav[data-tab="quick"] a:nth-child(6){color:#0d9488;background:rgba(13,148,136,.08);border:1.5px solid rgba(13,148,136,.2)}
.sub-nav[data-tab="quick"] a:nth-child(7){color:#d97706;background:rgba(217,119,6,.08);border:1.5px solid rgba(217,119,6,.2)}
/* Deep Dive sub-tab colors */
.sub-nav[data-tab="deep"] a:nth-child(1){color:#1a5fb4;background:rgba(26,95,180,.08);border:1.5px solid rgba(26,95,180,.2)}
.sub-nav[data-tab="deep"] a:nth-child(2){color:#7c3aed;background:rgba(124,58,237,.08);border:1.5px solid rgba(124,58,237,.2)}
/* Earnings sub-tab colors */
.sub-nav[data-tab="mgmt"] a:nth-child(1){color:#14a23a;background:rgba(20,162,58,.08);border:1.5px solid rgba(20,162,58,.2)}
.sub-nav[data-tab="mgmt"] a:nth-child(2){color:#7c3aed;background:rgba(124,58,237,.08);border:1.5px solid rgba(124,58,237,.2)}
.sub-nav[data-tab="mgmt"] a:nth-child(3){color:#2563eb;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.2)}
/* Picks sub-tab colors */
.sub-nav[data-tab="picks"] a:nth-child(1){color:#0d9488;background:rgba(13,148,136,.08);border:1.5px solid rgba(13,148,136,.2)}
.sub-nav[data-tab="picks"] a:nth-child(2){color:#d97706;background:rgba(217,119,6,.08);border:1.5px solid rgba(217,119,6,.2)}
.sub-nav[data-tab="picks"] a:nth-child(3){color:#2563eb;background:rgba(37,99,235,.08);border:1.5px solid rgba(37,99,235,.2)}
/* Hover — intensify */
.sub-nav a:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.1);filter:brightness(1.05)}
.sub-nav[data-tab]{display:none}
@keyframes scrollBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
@keyframes eventSlide{from{opacity:0;transform:translateY(-20px);max-height:0}to{opacity:1;transform:translateY(0);max-height:300px}}
@keyframes eventGlow{0%,100%{box-shadow:0 0 15px rgba(245,158,11,.15),inset 0 0 15px rgba(245,158,11,.03)}50%{box-shadow:0 0 30px rgba(245,158,11,.25),inset 0 0 20px rgba(245,158,11,.05)}}
@keyframes eventGlowHigh{0%,100%{box-shadow:0 0 15px rgba(239,68,68,.2),inset 0 0 15px rgba(239,68,68,.03)}50%{box-shadow:0 0 35px rgba(239,68,68,.35),inset 0 0 20px rgba(239,68,68,.06)}}
@keyframes borderShimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.global-ticker{width:100%;overflow:hidden;background:#002f6c;border-bottom:none;padding:8px 0;position:fixed;top:0;left:0;z-index:100}
.global-ticker .ticker-track{display:flex;gap:0;animation:tickerScroll 40s linear infinite;width:max-content}
.global-ticker .ticker-track:hover{animation-play-state:paused}
.global-ticker .ti{display:flex;align-items:center;gap:6px;font-size:12px;white-space:nowrap;padding:0 16px;border-right:1px solid rgba(255,255,255,.12)}
.global-ticker .ti .tn{color:rgba(255,255,255,.65);font-weight:700;font-size:11px;letter-spacing:.3px}
.global-ticker .ti .tp{font-family:var(--mono);font-weight:800;font-size:13px;color:#ffffff}
.global-ticker .ti .tc{font-size:11px;font-weight:700}
.global-ticker .tc.up{color:#4ade80}.global-ticker .tc.dn{color:#ff6b6b}.global-ticker .tc.fl{color:rgba(255,255,255,.5)}
.cinf{margin-top:8px;padding:8px 10px;border-radius:6px;border:1px solid;font-size:11px;color:var(--text2);line-height:1.6}
.cinf:empty{display:none}
.ptab{font-size:10px;padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;font-weight:600;transition:all .2s;font-family:'DM Sans',sans-serif}
.ptab.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.ptab:hover:not(.active){background:rgba(0,120,212,.12);border-color:var(--blue)}
.pick-tbl{width:100%;border-collapse:collapse;font-size:11px}
.pick-tbl th{text-align:left;padding:6px 8px;font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.5px;border-bottom:1px solid var(--border);text-transform:uppercase}
.pick-tbl td{padding:6px 8px;border-bottom:1px solid rgba(0,47,108,.03);color:var(--text2);vertical-align:top}
.pick-tbl tr:hover td{background:rgba(59,130,246,.03)}
.pick-tbl .cname{font-weight:700;color:var(--text);font-size:12px}
.pick-tbl .csub{font-size:9px;color:var(--text3)}
.pick-tbl .flag{font-size:10px;padding:1px 6px;border-radius:4px;font-weight:700;white-space:nowrap}
.pick-tbl .flag.g{background:rgba(16,185,129,.1);color:var(--green)}
.pick-tbl .flag.r{background:rgba(239,68,68,.1);color:var(--red)}
.pick-tbl .flag.b{background:rgba(0,120,212,.12);color:var(--blue)}
.pick-geo{display:flex;gap:6px;margin-bottom:8px}
.pick-geo button{font-size:9px;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface);color:var(--text3);cursor:pointer;font-weight:700;font-family:'DM Sans',sans-serif}
.pick-geo button.active{background:var(--amber);color:#000;border-color:var(--amber)}
.event-alert-global{animation:eventSlide .5s ease-out;overflow:hidden;margin-bottom:0;border-radius:12px;position:relative}
.evt-bar{display:flex;flex-direction:column;gap:6px;padding:8px 14px;border-radius:10px;background:linear-gradient(135deg,rgba(245,158,11,.04),rgba(239,68,68,.03));border:1px solid rgba(245,158,11,.12);overflow:hidden;position:relative}
.evt-row{display:flex;align-items:center;gap:8px;width:100%}
.evt-label{font-family:'Sora',sans-serif;font-size:9px;font-weight:800;color:var(--amber);letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.evt-scroll-wrap{overflow:hidden;flex:1;min-width:0;mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent);-webkit-mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent)}
.evt-scroll{display:flex;gap:8px;animation:evtScrollLive 35s linear infinite;width:max-content;padding:2px 0}
.evt-scroll:hover{animation-play-state:paused}
@keyframes evtScrollLive{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.evt-chip{position:relative;flex-shrink:0;display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;cursor:default;transition:all .2s;font-size:10px;font-weight:600;white-space:nowrap;border:1px solid rgba(0,47,108,.06)}
.evt-chip:hover{transform:translateY(-1px);z-index:10}
.evt-sev{font-size:7px;font-weight:900;color:#fff;padding:1px 4px;border-radius:3px;flex-shrink:0}
.evt-arrow{font-size:8px}
.evt-upcoming-wrap{overflow:hidden;flex:1;min-width:0;mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent);-webkit-mask-image:linear-gradient(90deg,transparent,#000 3%,#000 97%,transparent)}
.evt-upcoming{display:flex;gap:8px;animation:evtScroll 30s linear infinite;width:max-content;padding:2px 0}
.evt-upcoming:hover{animation-play-state:paused}
@keyframes evtScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.evt-upcoming .evt-up{font-size:9px;padding:3px 8px;border-radius:6px;background:rgba(59,130,246,.06);border:1px solid rgba(0,120,212,.12);color:var(--text2);white-space:nowrap;flex-shrink:0}
.event-alert-global::before{content:'';position:absolute;inset:-2px;border-radius:14px;background:linear-gradient(90deg,transparent,rgba(245,158,11,.4),transparent,rgba(239,68,68,.3),transparent);background-size:300% 100%;animation:borderShimmer 4s linear infinite;z-index:-1}
.event-alert-global.high::before{background:linear-gradient(90deg,transparent,rgba(239,68,68,.5),transparent,rgba(245,158,11,.4),transparent);background-size:300% 100%}
.event-dismiss{position:absolute;top:8px;right:10px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:4px;transition:all .2s}
.event-dismiss:hover{color:var(--text);background:rgba(255,255,255,.1)}
.ipt,input,textarea{-webkit-user-select:text;-moz-user-select:text;user-select:text}

/* ═══ ANTI-SCREENSHOT & ANTI-SHARING PROTECTIONS ═══ */
/* ALL report content cannot be selected, copied, or printed */
.rpt, .rpt *, .sc, .sc *, [data-tab], [data-tab] *, #decisionTool, #decisionResult {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  user-select: none !important;
  -webkit-touch-callout: none !important;
  -webkit-user-drag: none !important;
}
/* Allow typing in inputs only */
#buyPriceInput, .ipt, input, textarea { -webkit-user-select: text !important; -moz-user-select: text !important; user-select: text !important; }
/* Hide ALL report content when printing */
@media print {
  .rpt, #report, .tab-bar, .global-ticker, .site-watermark, .fab, .fpanel {
    display: none !important;
    visibility: hidden !important;
  }
  body::before {
    content: "This report is confidential. Content cannot be printed. — celesys.ai";
    display: block;
    text-align: center;
    font-size: 24px;
    padding: 60px;
    color: #666;
  }
}
/* Global site watermark */
.site-watermark{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;overflow:hidden;opacity:.06}
.site-watermark span{position:absolute;font-size:12px;font-weight:800;color:#002f6c;transform:rotate(-35deg);white-space:nowrap;letter-spacing:2px;font-family:'Sora',sans-serif;user-select:none;-webkit-user-select:none}
/* Watermark overlay for trades */
.trades-watermark {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 10;
  overflow: hidden;
  opacity: 0.04;
}
.trades-watermark-text {
  position: absolute;
  font-size: 14px;
  font-weight: 800;
  color: #002f6c;
  transform: rotate(-35deg);
  white-space: nowrap;
  letter-spacing: 2px;
  font-family: 'Sora', sans-serif;
}
/* Blur ALL report content when page is not visible (anti-screenshot) */
.trades-blurred .rpt .sbody, .trades-blurred .rpt .mgrid, .trades-blurred .rpt .tab-bar, .trades-blurred #decisionResult {
  filter: blur(20px) !important;
  transition: filter 0.1s;
}
.trades-blurred .rpt .sbody::after, .trades-blurred .rpt .mgrid::after, .trades-blurred #decisionResult::after {
  content: "Content hidden for security";
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 16px;
  font-weight: 700;
  color: var(--amber);
  z-index: 100;
}
</style>
</head>
<body>
<!-- Global Watermark -->
<div class="site-watermark" id="siteWatermark"></div>
<script>
(function(){const w=document.getElementById('siteWatermark');if(!w)return;let h='';for(let row=0;row<40;row++){for(let col=0;col<10;col++){const t=row*100+Math.random()*40;const l=col*200+Math.random()*60;h+=`<span style="top:${t}px;left:${l}px">CELESYS.AI • CONFIDENTIAL</span>`;}}w.innerHTML=h;})();
</script>
<!-- Global Indices Ticker — loads on page visit -->
<div class="global-ticker" id="globalTicker">
<div class="ticker-track" id="tickerTrack">
<span style="font-size:10px;color:var(--text3);padding:0 8px">Loading global markets...</span>
</div>
</div>
<div class="gridbg"></div>

<nav>
<div class="nbrand">
<div class="nlogo">S</div>
<div><div class="nname">CELESYS <span>AI</span></div><div class="ntag">Research Platform</div></div>
</div>
<div class="ncenter">
<div class="npill">Reports: <span class="v" id="navRC">0</span></div>
<div class="npill">Quota: <span class="v" id="navQ">5/hr</span></div>
</div>
<div class="nright">
<div class="nlive"><div class="ldot"></div> Live Market Data</div>

</div>
</nav>
<div class="sticky-tagline" id="stickyTag"><span>Stock Intelligence, Instantly</span><span id="stickyCompany" style="display:none;margin-left:12px;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;color:var(--text2);-webkit-text-fill-color:var(--text2);padding-left:12px;border-left:1px solid rgba(0,47,108,.1)"></span></div>

<section class="hero">
<h1>Stock Intelligence, Instantly.</h1>
<p class="hero-sub" style="font-size:15px;line-height:1.6;max-width:560px;margin-bottom:20px">Free institutional-grade analysis with buy/sell levels, risk scoring &amp; AI verdicts. <span style="font-size:12px;color:var(--red);font-weight:600">For educational purposes only.</span></p>

<!-- GLOBAL EVENTS & UPCOMING — visible on page load -->
<div id="eventAlertArea" style="display:none;margin:0 auto 12px;max-width:680px;width:100%;text-align:left"></div>

<!-- SEARCH CARD — The centerpiece -->
<div class="icard" style="max-width:680px;margin:0 auto 18px;text-align:left">
<div class="irow">
<input class="ipt" type="email" id="email" aria-label="Your email address" placeholder="your@email.com" autocomplete="off" data-lpignore="true" onfocus="if(this.dataset.real){this.type='email';this.value=this.dataset.real}" onblur="if(this.value.includes('@')){this.dataset.real=this.value;const p=this.value.split('@');this.value=p[0][0]+'***@'+p[1];this.type='text'}">
<div class="iwrap"><input class="ipt" type="text" id="ticker" aria-label="Stock ticker or company name" placeholder="Search any stock... AAPL, RELIANCE.NS" autocomplete="off"><div class="ac" id="autocomplete"></div></div>
<button class="btn" id="btn" aria-label="Analyze stock" onclick="analyze()">Analyze &#8594;</button>
</div>

<div style="margin-top:10px;font-size:10px;color:var(--text3);display:flex;align-items:center;gap:10px;flex-wrap:wrap">
<span>&#128293; <strong style="color:var(--text2)">5 free reports</strong>/email/hour</span>
<span>&middot;</span>
<span>&#128270; <a href="https://finance.yahoo.com/lookup" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none">Can't find ticker? Search Yahoo Finance</a></span>
</div>

<div class="sbar" id="status"></div>
<div class="lsteps" id="lsteps">
<div class="ls" id="s1"><div class="lsi">1</div> Pulling live market data &amp; financials...</div>
<div class="ls" id="s2"><div class="lsi">2</div> AI crunching valuation &amp; fundamentals...</div>
<div class="ls" id="s3"><div class="lsi">3</div> Computing entry, exit &amp; stop-loss prices...</div>
<div class="ls" id="s4"><div class="lsi">4</div> Scoring risk &amp; finding hidden gem small-caps...</div>
</div>
<div class="rlbox" id="rateLimitBox">
<div style="font-size:13px;font-weight:600;color:var(--amber)">Report limit reached</div>
<div class="rlcd" id="rlCountdown">--:--</div>
<div class="rlmsg" id="rlComeback"></div>
<div class="rlbar"><div class="rlbf" id="rlProgress" style="width:0%"></div></div>
</div>
</div>

<!-- WHAT YOU GET — Feature highlights -->
<div style="max-width:680px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
<div class="feat-card" style="border-top:3px solid var(--green)">
<div style="font-size:20px;margin-bottom:6px">&#9889;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">AI Verdict</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Buy/Hold/Sell with 20-factor deep analysis</div>
</div>
<div class="feat-card" style="border-top:3px solid var(--blue)">
<div style="font-size:20px;margin-bottom:6px">&#128200;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">Charts &amp; Technicals</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Valuation, trend, risk, margin charts</div>
</div>
<div class="feat-card" style="border-top:3px solid var(--purple)">
<div style="font-size:20px;margin-bottom:6px">&#127919;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">Entry &amp; Exit</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Exact buy, sell &amp; stop-loss prices</div>
</div>
<div class="feat-card" style="border-top:3px solid var(--red)">
<div style="font-size:20px;margin-bottom:6px">&#9888;&#65039;</div>
<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px">Risk Profiling</div>
<div style="font-size:9px;color:var(--text3);line-height:1.4">Beta, volatility, downside risks</div>
</div>
</div>

<div style="text-align:center;margin-top:6px;font-size:10px;color:var(--text3)">
<span id="globalRC" style="display:none">0</span>
</div>
</section>


<section class="rpt" id="report">
<noscript>
<div style="max-width:720px;margin:0 auto;padding:40px 20px;text-align:center">
<h2 style="font-family:'Sora',sans-serif;font-size:22px;color:#1a1a2e;margin-bottom:16px">Celesys AI — Free AI Stock Analysis</h2>
<p style="font-size:14px;color:#555;line-height:1.8;margin-bottom:16px">Celesys AI provides free, institutional-grade stock analysis for US (NYSE, NASDAQ) and Indian (NSE, BSE) markets. Get real-time valuation metrics, intrinsic value estimates (Graham Number, DCF model), 20-factor buy/sell verdicts, quarterly earnings analysis, management tone assessment, entry/exit price levels, risk scoring, and curated small-cap stock picks.</p>
<p style="font-size:14px;color:#555;line-height:1.8;margin-bottom:16px">Analyze stocks like Apple (AAPL), Microsoft (MSFT), NVIDIA (NVDA), Tesla (TSLA), Reliance Industries (RELIANCE.NS), HDFC Bank (HDFCBANK.NS), TCS (TCS.NS), Infosys (INFY), and 10,000+ more tickers. No signup required.</p>
<p style="font-size:13px;color:#888;margin-bottom:24px">This application requires JavaScript to run. Please enable JavaScript in your browser to use Celesys AI.</p>
<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:12px;font-size:13px">
<a href="/about" style="color:#3b82f6">About</a>
<a href="/faq" style="color:#3b82f6">FAQ</a>
<a href="/disclaimer" style="color:#3b82f6">Disclaimer</a>
<a href="/privacy" style="color:#3b82f6">Privacy</a>
<a href="/terms" style="color:#3b82f6">Terms</a>
<a href="/contact" style="color:#3b82f6">Contact</a>
</div>
</div>
</noscript>
<div class="rphero">
<div class="rptk" id="tickerTag"></div>
<div class="rpco" id="companyName"></div>
<div class="rplv" id="timestamp"><div class="ldot"></div></div>
</div>
<div class="mgrid" id="metrics"></div>

<!-- Hidden 52W section for JS compatibility -->
<div id="w52section" style="display:none"></div>

<!-- STATIC TAB BAR — always visible right after metrics -->
<div class="tab-bar" id="mainTabBar" style="display:none">
<button class="tab-btn active" onclick="switchTab('quick')" id="tabBtnQuick" data-color="green" data-tip="Verdict, charts, valuation, buy/sell levels, risk"><span class="tab-icon">&#9889;</span> Summary</button>
<button class="tab-btn" onclick="switchTab('deep')" id="tabBtnDeep" data-color="navy" data-tip="AI color-coded verdict breakdown, full deep-dive"><span class="tab-icon">&#128270;</span> Deep Dive</button>
<button class="tab-btn" onclick="switchTab('mgmt')" id="tabBtnMgmt" data-color="purple" data-tip="Quarterly earnings, management tone, fund holdings"><span class="tab-icon">&#128200;</span> Earnings</button>
<button class="tab-btn" onclick="switchTab('next')" id="tabBtnNext" data-color="cyan" data-tip="Upcoming catalysts, bull/bear/base scenarios"><span class="tab-icon">&#128302;</span> Forecast</button>
<button class="tab-btn" onclick="switchTab('gems')" id="tabBtnGems" data-color="amber" data-tip="Sector-specific small-cap picks" style="display:none"><span class="tab-icon">&#11088;</span> Gems</button>
<button class="tab-btn" onclick="switchTab('picks')" id="tabBtnPicks" data-color="teal" data-tip="Top 5 Buy, Sell, Accumulate stocks by conviction" style="display:none"><span class="tab-icon">&#127942;</span> Picks</button>
<button class="tab-btn" onclick="switchTab('funds')" id="tabBtnFunds" data-color="blue" data-tip="Top ETFs & mutual funds with 25%+ CAGR" style="display:none"><span class="tab-icon">&#128176;</span> ETF</button>
<button class="tab-btn" onclick="switchTab('trades')" id="tabBtnTrades" data-color="red" data-tip="Daily AI trade ideas for indices & stocks" style="display:none"><span class="tab-icon">&#128293;</span> Trades</button>
</div>

<!-- TAB CONTENT AREA -->
<div id="tabContentArea" style="min-height:60vh">

<!-- JS-GENERATED CONTENT GOES HERE -->
<div id="analysisContainer"></div>
</div>

<!-- POST-REPORT DISCLAIMER -->
<div style="margin-top:16px;padding:12px 18px;border-radius:10px;background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.15);display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2)">
<span style="font-size:16px">&#9888;</span>
<span><strong style="color:var(--red)">Reminder:</strong> Past performance does not guarantee future results. You can lose money investing. Always do your own research.</span>
</div>
</section>


<!-- SEO CONTENT — Substantial static HTML for Google crawling -->
<article style="max-width:720px;margin:0 auto;padding:24px 20px 8px;font-size:12px;color:var(--text3);line-height:1.7" aria-label="About Celesys AI Stock Analysis Platform">

<h2 style="font-family:'Sora',sans-serif;font-size:16px;color:var(--text);margin-bottom:12px">Free AI-Powered Stock Analysis for Every Investor</h2>
<p>Celesys AI is a free stock research platform that generates institutional-grade analysis reports in under 60 seconds. Whether you invest in US markets (NYSE, NASDAQ, S&amp;P 500) or Indian markets (NSE, BSE, Nifty 50, Sensex), Celesys delivers the same depth of research that hedge funds pay thousands for — completely free, no signup required.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">How It Works</h3>
<p>Enter any stock ticker — like AAPL, MSFT, RELIANCE.NS, or HDFCBANK.NS — and Celesys AI pulls live market data from multiple sources including Yahoo Finance, Google Finance, and NSE India. The platform then runs a 20-factor quantitative scoring model that evaluates the stock across valuation (P/E ratio, P/B ratio, PEG ratio, EV/EBITDA), profitability (profit margin, ROE, operating margin, gross margin, EBITDA margin), financial health (debt-to-equity, current ratio, free cash flow, cash vs debt), and momentum (52-week position, SMA/EMA crossovers, earnings velocity, short interest). The result is a deterministic buy/sell verdict — Strong Buy, Buy, Hold, Sell, or Strong Sell — with a conviction score and full explanation.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">What You Get in Every Report</h3>
<p>Each Celesys AI report includes: real-time stock price and live market indicators, intrinsic value calculations using the Benjamin Graham Number, Discounted Cash Flow (DCF) growth model, Peter Lynch fair value (PEG-based), and earnings yield vs 10-year Treasury bond comparison. You also receive AI-generated entry and exit price levels with specific buy zones, accumulate levels, profit targets, and stop-loss prices — all computed from EMA crossovers, Fibonacci retracements, and 52-week range analysis. The risk assessment covers debt risk, liquidity risk, volatility (beta), sector risk, and 52-week positioning. Visual charts show valuation comparison, financial health radar, risk profile, 6-month price trend, and margin vs industry benchmarks.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Deep AI Analysis &amp; Earnings Intelligence</h3>
<p>Beyond numbers, Celesys AI generates a comprehensive written research report powered by advanced AI. This includes an investment thesis, quarterly fundamentals analysis with quarter-over-quarter (QoQ) and year-over-year (YoY) growth trends, management tone assessment with CEO/CFO confidence scoring, institutional and mutual fund holdings analysis, upcoming catalysts and timeline forecasts, and bull/bear/base case price predictions for the next 12 months. Every section ends with a plain-English inference explaining what the data means for a regular investor — no jargon, no confusion.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Markets &amp; Stocks Covered</h3>
<p>Celesys AI covers over 10,000 stocks across major global exchanges. US stocks include Apple (AAPL), Microsoft (MSFT), NVIDIA (NVDA), Alphabet/Google (GOOGL), Amazon (AMZN), Tesla (TSLA), Meta (META), JPMorgan (JPM), and all NYSE/NASDAQ-listed equities. Indian stocks include Reliance Industries (RELIANCE.NS), TCS (TCS.NS), HDFC Bank (HDFCBANK.NS), Infosys (INFY), ICICI Bank (ICICIBANK.NS), SBI (SBIN.NS), Bharti Airtel (BHARTIARTL.NS), ITC (ITC.NS), and all NSE/BSE-listed companies. The platform also tracks global market indices live: S&amp;P 500, NASDAQ Composite, Dow Jones, Nifty 50, Sensex, FTSE 100, DAX, Nikkei 225, and Hang Seng.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Additional Features</h3>
<p>Celesys AI offers curated small-cap stock picks with 10x growth potential ratings, daily AI-generated trade ideas for indices and stocks using option chain analysis (PCR, Max Pain, OI walls), FII/DII institutional flow tracking for Indian markets, a comprehensive geopolitical and economic event calendar covering Fed decisions, RBI policy, US CPI data, trade wars, and global macro events, and a position analyzer tool that calculates optimal position sizes based on your risk tolerance. The platform also provides top-performing ETF and mutual fund recommendations with historical CAGR analysis.</p>

<h3 style="font-family:'Sora',sans-serif;font-size:13px;color:var(--text2);margin:16px 0 8px">Why Celesys AI?</h3>
<p>Traditional stock research tools are either too expensive (Bloomberg Terminal costs $25,000/year), too complex (requires CFA-level knowledge), or too shallow (basic screeners with no analysis). Celesys AI bridges this gap by providing professional-grade research in simple, plain-English language that any investor can understand — whether you are a first-time investor learning about P/E ratios or an experienced trader looking for technical entry levels. The platform is completely free, requires no account creation, and delivers results in under 60 seconds.</p>

<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:12px;font-size:11px">
<span style="font-weight:600;color:var(--text2)">Learn more:</span>
<a href="/about" style="color:var(--blue);text-decoration:none">About Celesys AI</a>
<a href="/faq" style="color:var(--blue);text-decoration:none">Frequently Asked Questions</a>
<a href="/disclaimer" style="color:var(--blue);text-decoration:none">Investment Disclaimer</a>
<a href="/privacy" style="color:var(--blue);text-decoration:none">Privacy Policy</a>
<a href="/terms" style="color:var(--blue);text-decoration:none">Terms of Service</a>
<a href="/contact" style="color:var(--blue);text-decoration:none">Contact Us</a>
</div>
</article>

<footer>
<div style="max-width:1080px;margin:0 auto;padding:24px 28px 16px">
<!-- Brand + Links row -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
<div style="display:flex;align-items:center;gap:10px">
<div class="fblogo">S</div>
<div><div class="fbname">CELESYS <span>AI</span></div><div style="font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase">Research Platform</div></div>
</div>
<div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center">
<a href="/about" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">About</a>
<a href="/faq" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">FAQ</a>
<a href="/privacy" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Privacy</a>
<a href="/terms" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Terms</a>
<a href="/disclaimer" style="font-size:11px;color:var(--text3);text-decoration:none;transition:color .2s">Disclaimer</a>
<a href="mailto:contact@celesys.ai" style="font-size:11px;color:var(--blue);text-decoration:none">&#9993; contact@celesys.ai</a>
</div>
</div>
<!-- Copyright -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding-top:12px">
<div style="font-size:10px;color:var(--text3)">&copy; 2026 Celesys AI &middot; All rights reserved</div>
<div style="font-size:10px;color:var(--text3)">Real-time data &middot; AI-powered analysis &middot; Not financial advice</div>
</div>
</div>
</footer>

<!-- BACK TO TOP -->
<button class="btt" id="bttBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Back to top">&#8593; Top</button>

<script>

const stocks=[
{t:'AAPL',n:'Apple Inc.'},{t:'MSFT',n:'Microsoft Corporation'},{t:'GOOGL',r:'Strong Buy',n:'Alphabet Inc. (Google)',bp:'$165-175',d:'ACCUMULATE · Hold 12mo · Add below $175. AI search moat intact. Cloud growing 28%. 82% prob of $220+ in 12mo.'},{t:'AMZN',n:'Amazon.com Inc.'},
{t:'NVDA',n:'NVIDIA Corporation'},{t:'META',r:'Strong Buy',n:'Meta Platforms (Facebook)',bp:'$560-580',d:'WAIT · Buy at $570 · Trading at fair value. Wait for 8-10% pullback. 78% prob of $750+ in 12mo.'},{t:'TSLA',n:'Tesla Inc.'},{t:'BRK.B',n:'Berkshire Hathaway'},
{t:'LLY',n:'Eli Lilly and Company'},{t:'AVGO',n:'Broadcom Inc.'},{t:'JPM',r:'Strong Buy',n:'JPMorgan Chase & Co.',bp:'$230-245',d:'BUY ON DIP · Hold 12mo · Wait for rate cut fear selloff to ₹230-245. 77% prob of $300+ in 12mo.'},{t:'V',n:'Visa Inc.'},
{t:'UNH',n:'UnitedHealth Group'},{t:'XOM',n:'Exxon Mobil'},{t:'WMT',n:'Walmart Inc.'},{t:'MA',n:'Mastercard Inc.'},
{t:'PG',n:'Procter & Gamble'},{t:'JNJ',n:'Johnson & Johnson'},{t:'HD',n:'Home Depot'},{t:'ORCL',n:'Oracle Corporation'},
{t:'COST',n:'Costco Wholesale'},{t:'NFLX',n:'Netflix Inc.'},{t:'BAC',n:'Bank of America'},{t:'CRM',n:'Salesforce Inc.'},
{t:'ABBV',n:'AbbVie Inc.'},{t:'CVX',n:'Chevron Corporation'},{t:'AMD',n:'Advanced Micro Devices'},{t:'KO',n:'Coca-Cola Company'},
{t:'PEP',n:'PepsiCo Inc.'},{t:'MRK',r:'★ Aggressive Buy',n:'Merck & Co.',bp:'$95-100',d:'BUY NOW · Hold 12-18mo · P/E 14x is deeply cheap for Keytruda franchise. 80% prob of $130+ in 12mo.'},{t:'ADBE',n:'Adobe Inc.'},{t:'TMO',n:'Thermo Fisher Scientific'},
{t:'CSCO',n:'Cisco Systems'},{t:'ACN',n:'Accenture'},{t:'MCD',n:"McDonald's Corporation"},{t:'LIN',n:'Linde plc'},
{t:'ABT',n:'Abbott Laboratories'},{t:'WFC',n:'Wells Fargo'},{t:'TXN',n:'Texas Instruments'},{t:'INTC',n:'Intel Corporation'},
{t:'DIS',n:'Walt Disney Company'},{t:'PM',n:'Philip Morris'},{t:'CMCSA',n:'Comcast Corporation'},{t:'NKE',n:'Nike Inc.'},
{t:'QCOM',n:'Qualcomm Inc.'},{t:'GE',n:'General Electric'},{t:'INTU',n:'Intuit Inc.'},{t:'VZ',n:'Verizon Communications'},
{t:'AMAT',n:'Applied Materials'},{t:'CAT',n:'Caterpillar Inc.'},
{t:'RELIANCE.NS',n:'Reliance Industries'},{t:'TCS.NS',n:'Tata Consultancy Services'},{t:'HDFCBANK.NS',n:'HDFC Bank'},
{t:'INFY',n:'Infosys Limited'},{t:'HINDUNILVR.NS',n:'Hindustan Unilever'},{t:'ICICIBANK.NS',n:'ICICI Bank'},
{t:'SBIN.NS',n:'State Bank of India'},{t:'BHARTIARTL.NS',n:'Bharti Airtel'},{t:'ITC.NS',r:'★ Aggressive Buy',n:'ITC Limited',bp:'₹400-415',d:'BUY NOW · Hold 12-18mo · FMCG demerger + hotel listing catalyst by Q3 2026. 85% prob of ₹500+ in 12mo.'},
{t:'KOTAKBANK.NS',n:'Kotak Mahindra Bank'},{t:'LT.NS',r:'Strong Buy',n:'Larsen & Toubro',bp:'₹3,200-3,300',d:'WAIT · Buy at ₹3,200 · Order book strong but priced in. Wait for 5-8% correction. 75% prob of ₹4,000 in 12mo.'},{t:'AXISBANK.NS',n:'Axis Bank'},
{t:'BAJFINANCE.NS',n:'Bajaj Finance'},{t:'ASIANPAINT.NS',n:'Asian Paints'},{t:'MARUTI.NS',n:'Maruti Suzuki'},
{t:'TITAN.NS',n:'Titan Company'},{t:'SUNPHARMA.NS',n:'Sun Pharmaceutical'},{t:'ULTRACEMCO.NS',n:'UltraTech Cement'},
{t:'NESTLEIND.NS',n:'Nestlé India'},{t:'ONGC.NS',n:'Oil & Natural Gas Corp'},{t:'NTPC.NS',r:'Strong Buy',n:'NTPC Limited',bp:'₹310-325',d:'ACCUMULATE · Hold 6-12mo · Add on dips to ₹310-325. Green energy re-rating in progress. 78% prob of ₹400+ in 9mo.'},
{t:'TATAMOTORS.NS',n:'Tata Motors'},{t:'POWERGRID.NS',n:'Power Grid Corporation'},{t:'TATASTEEL.NS',n:'Tata Steel'},
{t:'M&M.NS',n:'Mahindra & Mahindra'},{t:'JSWSTEEL.NS',n:'JSW Steel'},{t:'ADANIENT.NS',n:'Adani Enterprises'},
{t:'WIPRO.NS',n:'Wipro Limited'},{t:'COALINDIA.NS',r:'★ Aggressive Buy',n:'Coal India',bp:'₹360-380',d:'BUY NOW · Hold 6mo · Dividend alone gives 6%+ yield. Cash cow. 82% prob of ₹450+ in 6mo on div reinvestment.'},{t:'HCLTECH.NS',n:'HCL Technologies'},
{t:'BAJAJFINSV.NS',n:'Bajaj Finserv'},{t:'DIVISLAB.NS',n:"Divi's Laboratories"},{t:'GRASIM.NS',n:'Grasim Industries'},
{t:'TECHM.NS',n:'Tech Mahindra'},{t:'BRITANNIA.NS',n:'Britannia Industries'},{t:'EICHERMOT.NS',n:'Eicher Motors'},
{t:'APOLLOHOSP.NS',n:'Apollo Hospitals'},{t:'INDUSINDBK.NS',n:'IndusInd Bank'},{t:'TRENT.NS',n:'Trent Limited'},
{t:'ADANIPORTS.NS',n:'Adani Ports'},{t:'HINDALCO.NS',n:'Hindalco Industries'},{t:'DRREDDY.NS',n:"Dr. Reddy's Labs"},
{t:'CIPLA.NS',n:'Cipla Limited'},{t:'HEROMOTOCO.NS',n:'Hero MotoCorp'},{t:'SHREECEM.NS',n:'Shree Cement'},
{t:'BAJAJ-AUTO.NS',n:'Bajaj Auto'},{t:'BPCL.NS',n:'Bharat Petroleum'},{t:'SIEMENS.NS',n:'Siemens India'},
{t:'KPIT.NS',n:'KPIT Technologies'},{t:'DIXON.NS',n:'Dixon Technologies'}
];
let valChart,trendChart,healthChart,riskChart,marginChart,qoqChart,yoyChart,marginTrendChart,countdownInterval=null;
const TI=document.getElementById('ticker'),AC=document.getElementById('autocomplete');
TI.addEventListener('input',function(){const v=this.value.trim().toUpperCase();AC.innerHTML='';if(!v){AC.classList.remove('show');return}
const m=stocks.filter(s=>s.t.includes(v)||s.n.toUpperCase().includes(v)).slice(0,10);if(!m.length){AC.classList.remove('show');return}
m.forEach(s=>{const d=document.createElement('div');d.className='aci';d.innerHTML=`<span class="act">${s.t}</span><span class="acn">${s.n}</span>`;d.onclick=()=>{TI.value=s.t;AC.classList.remove('show')};AC.appendChild(d)});AC.classList.add('show')});
document.addEventListener('click',e=>{if(e.target!==TI)AC.classList.remove('show')});
document.getElementById('email').addEventListener('keypress',e=>{if(e.key==='Enter')TI.focus()});
// Smart Trades tab: only visible for authorized email
const TRADES_EMAILS=['vijy.dhulipala@gmail.com'];
const PICKS_EMAILS=['vijy.dhulipala@gmail.com'];
let _pulseData=null;
let _pulseFetching=false,_pulseLoaded=false;
async function fetchMarketPulse(){
if(_pulseFetching)return;
_pulseFetching=true;
try{
const r=await fetch('/api/market-pulse');
const d=await r.json();
if(!d.success){console.log('Market pulse: no success');return}
_pulseData=d;_pulseLoaded=true;
console.log('Market pulse loaded:',d.events?.length||0,'events,',d.upcoming?.length||0,'upcoming');
renderMarketEvents();
try{renderFiiDii()}catch(e){console.warn('FiiDii render error:',e)}
}catch(e){console.log('Market pulse fetch error:',e)}
finally{_pulseFetching=false}
}
function renderMarketEvents(){
const div=document.getElementById('eventAlertArea');
if(!div||!_pulseData)return;
const d=_pulseData;
let hasContent=false;
let h='<div class="evt-bar">';
if(d.events&&d.events.length>0){
hasContent=true;
let liveChips='';
d.events.forEach((evt,idx)=>{
const isH=evt.severity==='HIGH';
const isM=evt.severity==='MEDIUM';
const sC=isH?'#ef4444':isM?'#f59e0b':'#3b82f6';
const iC=evt.impact==='BULLISH'?'#10b981':evt.impact==='BEARISH'?'#ef4444':'#f59e0b';
const iA=evt.impact==='BULLISH'?'&#9650;':evt.impact==='BEARISH'?'&#9660;':'&#8212;';
const bg=isH?'rgba(239,68,68,.08)':isM?'rgba(245,158,11,.06)':'rgba(59,130,246,.06)';
liveChips+=`<div class="evt-chip" style="background:${bg};border-color:${sC}22;color:${sC}" onmouseenter="showEvtTip(this,${idx})" onmouseleave="hideEvtTip()">
<span class="evt-sev" style="background:${sC}">${evt.severity.charAt(0)}</span>
${evt.headline}
<span class="evt-arrow" style="color:${iC}">${iA}</span>
</div>`;
});
// Duplicate for seamless loop
h+=`<div class="evt-row"><span style="font-size:12px;flex-shrink:0">&#128293;</span><span class="evt-label">LIVE</span><div class="evt-scroll-wrap"><div class="evt-scroll">${liveChips}${liveChips}</div></div></div>`;
}
if(d.upcoming&&d.upcoming.length>0){
hasContent=true;
h+=`<div class="evt-row"><span style="font-size:11px;flex-shrink:0">&#128197;</span><span class="evt-label">NEXT</span>`;
let upItems='';
d.upcoming.forEach(u=>{
const uC=u.impact==='HIGH'?'var(--red)':'var(--amber)';
upItems+=`<span class="evt-up"><strong style="color:${uC}">${u.event}</strong> ${u.date} <span style="color:var(--text3)">(${u.days}d)</span></span>`;
});
// Duplicate for seamless loop
h+=`<div class="evt-upcoming-wrap"><div class="evt-upcoming">${upItems}${upItems}</div></div></div>`;
}
h+=`</div>`;
// Shared tooltip div
h+=`<div id="evtTipBox" style="display:none;position:fixed;width:300px;padding:10px 12px;border-radius:8px;background:#ffffff;border:1px solid rgba(0,47,108,.15);box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:9999;font-size:10px;color:#555555;line-height:1.5;pointer-events:none"></div>`;
if(hasContent){div.innerHTML=h;div.style.display='block'}
}

function renderFiiDii(){
const body=document.getElementById('fiiDiiBody');
const card=document.getElementById('fiiDiiCard');
if(!body||!card||!_pulseData||!_pulseData.fii_dii)return;
const fd=_pulseData.fii_dii;
if(!fd.fii&&!fd.dii)return;
// Only show for Indian stocks
const ticker=(window._stockData?.ticker||'').toUpperCase();
if(!ticker.includes('.NS')&&!ticker.includes('.BO'))return;
const fii=fd.fii||{};const dii=fd.dii||{};
const fNet=fii.net||0;const dNet=dii.net||0;const combined=fNet+dNet;
const fC=fNet>=0?'var(--green)':'var(--red)';
const dC=dNet>=0?'var(--green)':'var(--red)';
const cC=combined>=0?'var(--green)':'var(--red)';
const fSign=fNet>=0?'+':'';const dSign=dNet>=0?'+':'';const cSign=combined>=0?'+':'';
const fBg=fNet>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)';
const dBg=dNet>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)';
const cBg=combined>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)';
let verdict='';
if(fNet>2000&&dNet>0)verdict='<strong style="color:var(--green)">Both FII + DII buying</strong> — strong market support. Rally likely to sustain.';
else if(fNet<-2000&&dNet>2000)verdict='<strong style="color:var(--amber)">FII selling but DII absorbing</strong> — domestic funds providing floor. Markets may hold range.';
else if(fNet<-2000&&dNet<0)verdict='<strong style="color:var(--red)">Both FII + DII selling</strong> — no institutional support. Expect weakness.';
else if(fNet>1000)verdict='<strong style="color:var(--green)">FII money flowing in</strong> — positive for large-cap and banking stocks.';
else if(fNet<-1000)verdict='<strong style="color:var(--red)">FII pulling out</strong> — caution on market direction. IT exporters may benefit from weaker rupee.';
else verdict='<strong style="color:var(--text)">Normal institutional activity</strong> — no strong directional signal today.';
body.innerHTML=`
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px">
<div style="padding:12px;border-radius:10px;background:${fBg};border:1px solid ${fC}22;text-align:center">
<div style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:4px">FII / Foreign</div>
<div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${fC}">${fSign}₹${Math.abs(fNet).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text3);margin-top:2px">${fNet>=0?'Net Buyers ↑':'Net Sellers ↓'}</div>
<div style="margin-top:6px;font-size:9px;color:var(--text2)">Buy: ₹${(fii.buy||0).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text2)">Sell: ₹${(fii.sell||0).toLocaleString('en-IN')}Cr</div>
</div>
<div style="padding:12px;border-radius:10px;background:${dBg};border:1px solid ${dC}22;text-align:center">
<div style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:4px">DII / Domestic</div>
<div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${dC}">${dSign}₹${Math.abs(dNet).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text3);margin-top:2px">${dNet>=0?'Net Buyers ↑':'Net Sellers ↓'}</div>
<div style="margin-top:6px;font-size:9px;color:var(--text2)">Buy: ₹${(dii.buy||0).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text2)">Sell: ₹${(dii.sell||0).toLocaleString('en-IN')}Cr</div>
</div>
<div style="padding:12px;border-radius:10px;background:${cBg};border:1px solid ${cC}22;text-align:center">
<div style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:4px">Combined Flow</div>
<div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${cC}">${cSign}₹${Math.abs(combined).toLocaleString('en-IN')}Cr</div>
<div style="font-size:9px;color:var(--text3);margin-top:2px">${combined>=0?'Net Inflow ↑':'Net Outflow ↓'}</div>
<div style="margin-top:6px;font-size:9px;color:var(--text2)">${fii.date||'Today'}</div>
</div>
</div>
<div style="padding:10px 14px;border-radius:8px;background:rgba(37,99,235,.04);border:1px solid rgba(37,99,235,.1);font-size:11px;color:var(--text2);line-height:1.7">
<span style="font-size:13px">&#128161;</span> ${verdict}
</div>
<div style="margin-top:8px;font-size:9px;color:var(--text3);text-align:center">FII = Foreign Institutional Investors (global funds) &nbsp;·&nbsp; DII = Domestic Institutional Investors (mutual funds, insurance, pension)</div>
`;
card.style.display='block';
}
function showEvtTip(el,idx){
const tip=document.getElementById('evtTipBox');
if(!tip||!_pulseData||!_pulseData.events[idx])return;
const evt=_pulseData.events[idx];
const rect=el.getBoundingClientRect();
const sC=evt.severity==='HIGH'?'#ef4444':evt.severity==='MEDIUM'?'#f59e0b':'#3b82f6';
const iC=evt.impact==='BULLISH'?'#10b981':evt.impact==='BEARISH'?'#ef4444':'#f59e0b';
tip.innerHTML=`<div style="font-weight:700;color:${sC};margin-bottom:4px;font-size:11px">${evt.headline}</div>
<div style="margin-bottom:6px">${evt.detail}</div>
${evt.action?'<div style="padding:4px 8px;border-radius:4px;background:rgba(0,47,108,.04);border-left:2px solid '+sC+';font-weight:600;font-size:9px">&#9654; '+evt.action+'</div>':''}
<div style="margin-top:4px;display:flex;gap:6px">
<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:${sC}18;color:${sC};font-weight:700">${evt.severity}</span>
<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:${iC}18;color:${iC};font-weight:700">${evt.impact}</span>
</div>`;
tip.style.left=Math.min(rect.left,window.innerWidth-320)+'px';
tip.style.top=(rect.bottom+8)+'px';
tip.style.display='block';
}
function hideEvtTip(){const t=document.getElementById('evtTipBox');if(t)t.style.display='none'}

function checkTradesAccess(){
try{
const el=document.getElementById('email');
if(!el)return;
const email=(el.dataset.real||el.value).trim().toLowerCase();
const showTrades=TRADES_EMAILS.includes(email);
const showPicks=PICKS_EMAILS.includes(email);
const tBtn=document.getElementById('tabBtnTrades');
const gBtn=document.getElementById('tabBtnGems');
const pBtn=document.getElementById('tabBtnPicks');
const fBtn=document.getElementById('tabBtnFunds');
if(tBtn)tBtn.style.display=showTrades?'':'none';
if(gBtn)gBtn.style.display=showTrades?'':'none';
if(pBtn)pBtn.style.display=showPicks?'':'none';
if(fBtn)fBtn.style.display=showPicks?'':'none';
document.querySelectorAll('.sc[data-tab="trades"]').forEach(s=>s.style.display=showTrades?'':'none');
document.querySelectorAll('.sc[data-tab="gems"]').forEach(s=>s.style.display=showTrades?'':'none');
document.querySelectorAll('.sc[data-tab="picks"]').forEach(s=>s.style.display=showPicks?'':'none');
document.querySelectorAll('.sc[data-tab="funds"]').forEach(s=>s.style.display=showPicks?'':'none');
document.querySelectorAll('.sub-nav[data-tab="picks"]').forEach(s=>s.style.display=showPicks?'':'none');
if(showTrades){initTradesProtection(email)}
if(showPicks){try{renderPicks('lc')}catch(e){}try{renderFunds('etf_in')}catch(e){}}
console.log('checkTradesAccess:',email,'→ trades:',showTrades?'GRANTED':'DENIED','picks:',showPicks?'GRANTED':'DENIED');
}catch(e){console.warn('checkTradesAccess error:',e)}
}
document.getElementById('email').addEventListener('blur',checkTradesAccess);

// ═══════════════════════════════════════════════
// ANTI-SCREENSHOT & ANTI-SHARING PROTECTION
// ═══════════════════════════════════════════════
function initTradesProtection(email){
const tradesTab=document.querySelector('[data-tab="trades"]');
if(!tradesTab||tradesTab.dataset.protected)return;
tradesTab.dataset.protected='true';
tradesTab.style.position='relative';

// 1. Dynamic watermark grid with user's email
const wm=document.createElement('div');
wm.className='trades-watermark';
let wmHtml='';
for(let row=0;row<20;row++){
for(let col=0;col<6;col++){
const top=row*120+Math.random()*40;
const left=col*280+Math.random()*60-40;
wmHtml+=`<span class="trades-watermark-text" style="top:${top}px;left:${left}px">contact@celesys.ai • CELESYS.AI • CONFIDENTIAL</span>`;
}}
wm.innerHTML=wmHtml;
tradesTab.appendChild(wm);

// 2. Block right-click on trades section
tradesTab.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();return false});

// 3. Block drag/drop (prevents dragging content out)
tradesTab.addEventListener('dragstart',e=>{e.preventDefault()});

// 4. Block copy/cut
tradesTab.addEventListener('copy',e=>{e.preventDefault();e.clipboardData&&e.clipboardData.setData('text/plain','Smart Trades content is protected.')});
tradesTab.addEventListener('cut',e=>{e.preventDefault()});
}

// 5. Block keyboard shortcuts GLOBALLY on any report content
document.addEventListener('keydown',function(e){
const reportVisible=document.querySelector('.rpt.show');
if(!reportVisible)return;
if(e.key==='PrintScreen'){e.preventDefault();return false}
if(e.ctrlKey&&e.key==='p'){e.preventDefault();return false}
if(e.ctrlKey&&e.key==='s'){e.preventDefault();return false}
if(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='i'||e.key==='J'||e.key==='j')){e.preventDefault();return false}
if(e.ctrlKey&&(e.key==='u'||e.key==='U')){e.preventDefault();return false}
if(e.key==='F12'){e.preventDefault();return false}
if(e.ctrlKey&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();return false}
if(e.ctrlKey&&(e.key==='c'||e.key==='C')){e.preventDefault();return false}
if(e.ctrlKey&&(e.key==='a'||e.key==='A')){e.preventDefault();return false}
if(e.metaKey&&e.shiftKey&&(e.key==='S'||e.key==='s')){e.preventDefault();return false}
});

// 5b. Block right-click GLOBALLY on entire page
document.addEventListener('contextmenu',function(e){
// Allow right-click only on inputs
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
e.preventDefault();return false;
});

// 5c. Block drag on all content
document.addEventListener('dragstart',function(e){
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
e.preventDefault();return false;
});

// 5d. Block copy/paste globally (except inputs)
document.addEventListener('copy',function(e){
if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
e.preventDefault();
if(e.clipboardData)e.clipboardData.setData('text/plain','Content is protected — celesys.ai');
return false;
});
document.addEventListener('cut',function(e){e.preventDefault();return false});

// 6. Blur content when page loses visibility (anti-screenshot)
document.addEventListener('visibilitychange',function(){
if(document.hidden){
document.body.classList.add('trades-blurred');
}else{
setTimeout(()=>document.body.classList.remove('trades-blurred'),1200);
}
});

// 7. Blur on window blur (when focus moves away from browser)
window.addEventListener('blur',function(){
document.body.classList.add('trades-blurred');
});
window.addEventListener('focus',function(){
setTimeout(()=>document.body.classList.remove('trades-blurred'),800);
});

// 8. Detect screen recording/capture API
if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){
const origGetDisplay=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices);
navigator.mediaDevices.getDisplayMedia=function(){
alert('Screen recording is not permitted on Celesys AI reports.');
return Promise.reject(new Error('Screen capture blocked'));
};
}

// 9. DevTools detection — blur report if DevTools open
(function(){
const dt=new Image();
let devOpen=false;
Object.defineProperty(dt,'id',{get:function(){
devOpen=true;document.body.classList.add('trades-blurred');
const overlay=document.getElementById('devtoolsOverlay');
if(!overlay){const ov=document.createElement('div');ov.id='devtoolsOverlay';
ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.92);z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-family:Sora,sans-serif';
ov.innerHTML='<div style="font-size:48px;margin-bottom:20px">&#128274;</div><div style="font-size:20px;font-weight:800;margin-bottom:8px">Developer Tools Detected</div><div style="font-size:14px;color:#aaa">Please close DevTools to continue using Celesys AI.</div>';
document.body.appendChild(ov);}
}});
setInterval(function(){devOpen=false;console.log(dt);
if(!devOpen){const ov=document.getElementById('devtoolsOverlay');if(ov)ov.remove();document.body.classList.remove('trades-blurred')}},2000)
})();

// 10. Dynamic watermark with user email embedded
function refreshWatermark(){
const em=document.getElementById('email')?.value||'';
const wm=document.getElementById('siteWatermark');if(!wm)return;
const ts=new Date().toLocaleString('en-IN',{timeZone:'Asia/Kolkata'});
const label=em?em.replace(/(.{3}).+(@.+)/,'$1***$2'):'CELESYS.AI';
wm.innerHTML='';
for(let i=0;i<300;i++){
const s=document.createElement('span');
s.textContent=i%4===0?'CELESYS.AI':i%4===1?label:i%4===2?ts.split(',')[0]:'CONFIDENTIAL';
s.style.left=(Math.random()*130-15)+'%';
s.style.top=(Math.random()*130-15)+'%';
s.style.fontSize=(10+Math.random()*5)+'px';
s.style.opacity=0.04+Math.random()*0.03;
wm.appendChild(s);}
}

// 9. Periodic check — if dev tools are open (detected by debugger timing)
(function detectDevTools(){
const el=new Image();
let open=false;
Object.defineProperty(el,'id',{get:function(){open=true}});
setInterval(()=>{
open=false;
console.log(el);
if(open){
document.body.classList.add('trades-blurred');
}
},3000);
})();
TI.addEventListener('keypress',e=>{if(e.key==='Enter')analyze()});

function showStatus(m,t){const s=document.getElementById('status');s.innerHTML=m;s.className='sbar show '+t}
function showLS(){const b=document.getElementById('lsteps');b.classList.add('show');['s1','s2','s3','s4'].forEach(s=>{document.getElementById(s).className='ls'});
let i=0;const ids=['s1','s2','s3','s4'];b._iv=setInterval(()=>{if(i>0)document.getElementById(ids[i-1]).classList.replace('on','ok');if(i<ids.length){document.getElementById(ids[i]).classList.add('on');i++}else clearInterval(b._iv)},7000);document.getElementById(ids[0]).classList.add('on')}
function hideLS(){const b=document.getElementById('lsteps');if(b._iv)clearInterval(b._iv);b.classList.remove('show')}
function hideRL(){document.getElementById('rateLimitBox').style.display='none';if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null}}
function showRL(data){const box=document.getElementById('rateLimitBox'),cd=document.getElementById('rlCountdown'),cb=document.getElementById('rlComeback'),pr=document.getElementById('rlProgress');
let ts=data.retry_after_seconds||(data.retry_after_minutes||5)*60;const tt=new Date(Date.now()+ts*1000);
cb.textContent='Come back at '+tt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+' · '+(data.requests_limit||5)+' fresh reports';box.style.display='block';
if(countdownInterval)clearInterval(countdownInterval);const ss=ts;
function tick(){const r=Math.max(0,Math.floor((tt-Date.now())/1000)),mn=Math.floor(r/60),sc=r%60;
cd.textContent=String(mn).padStart(2,'0')+':'+String(sc).padStart(2,'0');pr.style.width=Math.min(100,((ss-r)/ss)*100)+'%';
if(r<=0){clearInterval(countdownInterval);countdownInterval=null;cd.textContent='00:00';cd.style.color='var(--green)';
cb.textContent='✓ Quota refreshed — generate reports again';pr.style.width='100%';box.style.borderColor='rgba(16,185,129,.3)';box.style.background='rgba(16,185,129,.04)'}}
tick();countdownInterval=setInterval(tick,1000)}

// ═══ PEER COMPARISON RENDERER ═══
function renderPeers(d, curr){
const el=document.getElementById('peerSection');
if(!el)return;
const peers=d.peers||[];
const myPE=(d.pe_ratio&&d.pe_ratio!=='N/A')?parseFloat(d.pe_ratio):0;
const peerAvgPE=d.peer_avg_pe&&d.peer_avg_pe!=='N/A'?parseFloat(d.peer_avg_pe):0;
const sectorPE=d.sector_avg_pe||20;

if(!peers.length){el.innerHTML='<p style="font-size:12px;color:var(--text3)">Peer data not available for this stock.</p>';return}

// PE context verdict
let peVerdict='';
if(myPE>0&&peerAvgPE>0){
  const ratio=myPE/peerAvgPE;
  const disc=Math.abs(((peerAvgPE-myPE)/peerAvgPE)*100).toFixed(0);
  if(ratio<0.7) peVerdict=`<span class="sig g">● ${disc}% cheaper than peers</span> — Potential value opportunity vs industry competitors.`;
  else if(ratio<0.9) peVerdict=`<span class="sig g">● ${disc}% below peer avg</span> — Slight discount to peers. Check if deserved.`;
  else if(ratio<1.1) peVerdict=`<span class="sig n">● In line with peers</span> — Trading at fair value relative to competitors.`;
  else if(ratio<1.4) peVerdict=`<span class="sig c">● ${disc}% premium</span> — Market prices in growth premium vs peers.`;
  else peVerdict=`<span class="sig c">● ${disc}% more expensive</span> — Significant premium. Must justify with superior growth.`;
}

const mcF=(c,s)=>{s=s||'$';if(!c||isNaN(c))return'N/A';c=parseFloat(c);if(c>=1e12)return s+(c/1e12).toFixed(1)+'T';if(c>=1e9)return s+(c/1e9).toFixed(1)+'B';if(c>=1e7)return s+(c/1e7).toFixed(1)+'Cr';return s+(c/1e6).toFixed(1)+'M'};

let rows=peers.map(p=>{
  const peClass=p.pe==='N/A'?'':p.pe<myPE?'style="color:var(--green)"':p.pe>myPE?'style="color:var(--red)"':'';
  return `<tr>
    <td><strong style="cursor:pointer;color:var(--blue)" onclick="quickAnalyze('${p.ticker}')">${p.ticker}</strong><br><span style="font-size:10px;color:var(--text3)">${p.name}</span></td>
    <td style="font-family:var(--mono);font-weight:600" ${peClass}>${p.pe!=='N/A'?p.pe+'x':'N/A'}</td>
    <td style="font-family:var(--mono)">${mcF(p.market_cap,curr)}</td>
    <td style="font-family:var(--mono);color:${p.profit_margin>=0?'var(--green)':'var(--red)'}">${p.profit_margin}%</td>
    <td style="font-family:var(--mono);color:${p.revenue_growth>=0?'var(--green)':'var(--red)'}">${p.revenue_growth>0?'+':''}${p.revenue_growth}%</td>
    <td style="font-family:var(--mono)">${p.roe}%</td>
  </tr>`}).join('');

el.innerHTML=`
<p style="font-size:12px;color:var(--text3);margin-bottom:10px">How <strong style="color:var(--text)">${d.ticker}</strong> stacks up against ${peers.length} industry competitors in <strong style="color:var(--text)">${d.industry||d.sector||'same sector'}</strong>:</p>
${peVerdict?`<div style="padding:10px 14px;border-radius:8px;background:rgba(20,184,166,.05);border:1px solid rgba(20,184,166,.15);margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.7">
<span style="font-size:13px">📊</span> <strong>${d.ticker} P/E: ${myPE>0?myPE.toFixed(1)+'x':'N/A'}</strong> vs <strong>Peer Avg: ${peerAvgPE>0?peerAvgPE.toFixed(1)+'x':'N/A'}</strong> vs <strong>Sector: ${sectorPE}x</strong><br>${peVerdict}
</div>`:''}
<div style="overflow-x:auto">
<table class="dt"><tr><th>Company</th><th>P/E</th><th>Mkt Cap</th><th>Margin</th><th>Rev Growth</th><th>ROE</th></tr>
<tr style="background:rgba(20,184,166,.06);font-weight:600">
  <td><strong>${d.ticker}</strong><br><span style="font-size:10px;color:var(--text3)">${(d.company_name||d.ticker).substring(0,30)}</span></td>
  <td style="font-family:var(--mono);font-weight:700;color:var(--teal)">${myPE>0?myPE.toFixed(1)+'x':'N/A'}</td>
  <td style="font-family:var(--mono)">${mcF(d.market_cap,curr)}</td>
  <td style="font-family:var(--mono)">${parseFloat(d.profit_margin||0).toFixed(1)}%</td>
  <td style="font-family:var(--mono)">${d.earnings_growth!=='N/A'?(d.earnings_growth>0?'+':'')+d.earnings_growth+'%':'N/A'}</td>
  <td style="font-family:var(--mono)">${parseFloat(d.roe||0).toFixed(1)}%</td>
</tr>
${rows}
</table></div>
<div class="ic bl" style="margin-top:10px"><p><strong>&#128161; How to read this:</strong> Green P/E = cheaper than ${d.ticker}. Red = more expensive. Compare margins and growth to see if premium is justified. Click any ticker to analyze it.</p></div>`;
}

// ═══ UPCOMING EVENTS / CATALYSTS RENDERER ═══
function renderUpcomingEvents(d){
const el=document.getElementById('sectorEventsContent');
if(!el)return;
const sector=d.sector||'';
const isIndian=d.ticker&&(d.ticker.includes('.NS')||d.ticker.includes('.BO'));

// Build sector-specific + company-specific upcoming events
const now=new Date();
const events=[];

// Company-specific events
const qMonths=[1,4,7,10]; // Typical earnings months
let nextQ=null;
for(let i=0;i<8;i++){
  const m=new Date(now.getFullYear(),now.getMonth()+i,1);
  if(qMonths.includes(m.getMonth()+1)&&m>now){nextQ=m;break}
}
if(nextQ){
  const qName=['','Q3','Q3','Q3','Q4','Q4','Q4','Q1','Q1','Q1','Q2','Q2','Q2'][nextQ.getMonth()+1]||'Q?';
  events.push({date:nextQ.toLocaleDateString('en-US',{month:'short',year:'numeric'}),title:`${d.ticker} ${qName} Earnings Release`,type:'company',impact:'high',desc:'Quarterly results reveal revenue/profit trends. Major price catalyst.'});
}

// Dividend dates
if(d.dividend_yield&&parseFloat(d.dividend_yield)>0){
  events.push({date:'Upcoming',title:`${d.ticker} Dividend Ex-Date`,type:'company',impact:'medium',desc:`Current yield: ${d.dividend_yield}%. Watch for ex-dividend date announcement.`});
}

// AGM
events.push({date:'Upcoming',title:`${d.ticker} Annual General Meeting`,type:'company',impact:'medium',desc:'Management guidance, strategic outlook, and shareholder resolutions.'});

// Sector-specific events
const sectorEvents={
  'Technology':[
    {date:'Quarterly',title:'Big Tech Earnings Season',impact:'high',desc:'FAANG+ results set tone for entire tech sector. Watch AI/cloud growth.'},
    {date:'Ongoing',title:'AI Infrastructure Spending',impact:'high',desc:'Enterprise AI adoption and GPU demand driving sector valuations.'},
    {date:'Quarterly',title:'Semiconductor Cycle Updates',impact:'medium',desc:'Chip demand and inventory levels signal sector direction.'}
  ],
  'Financial Services':[
    {date:'Every 6 weeks',title:'Fed Interest Rate Decision',impact:'high',desc:'Rate changes directly affect bank margins, lending, and valuations.'},
    {date:'Quarterly',title:'Bank Stress Test Results',impact:'high',desc:'Capital adequacy determines dividend capacity and buybacks.'},
    {date:'Monthly',title:'Credit & Loan Growth Data',impact:'medium',desc:'Loan demand signals economic health and bank revenue outlook.'}
  ],
  'Healthcare':[
    {date:'Ongoing',title:'FDA Drug Approvals Pipeline',impact:'high',desc:'New approvals can create 20-50% moves in pharma/biotech stocks.'},
    {date:'Annual',title:'Healthcare Policy Changes',impact:'high',desc:'Drug pricing legislation and insurance coverage changes.'},
    {date:'Quarterly',title:'Clinical Trial Results',impact:'high',desc:'Phase 3 readouts are binary events — prepare for volatility.'}
  ],
  'Energy':[
    {date:'Biweekly',title:'OPEC+ Production Decision',impact:'high',desc:'Supply cuts/increases directly move oil prices and energy stocks.'},
    {date:'Weekly',title:'US Crude Inventory Report',impact:'medium',desc:'EIA data shows supply/demand balance. Moves oil intraday.'},
    {date:'Ongoing',title:'Clean Energy Transition Policy',impact:'medium',desc:'Government subsidies and mandates shifting capital to renewables.'}
  ],
  'Consumer Cyclical':[
    {date:'Monthly',title:'Retail Sales Data',impact:'high',desc:'Consumer spending strength drives revenue for cyclical names.'},
    {date:'Quarterly',title:'Consumer Confidence Index',impact:'medium',desc:'Sentiment leading indicator for discretionary spending.'},
    {date:'Nov-Dec',title:'Holiday Season Sales',impact:'high',desc:'Q4 makes or breaks the year for retail and e-commerce.'}
  ],
  'Consumer Defensive':[
    {date:'Monthly',title:'CPI / Inflation Data',impact:'high',desc:'Input costs and pricing power affected by inflation trends.'},
    {date:'Quarterly',title:'Volume vs Price Growth',impact:'medium',desc:'Are consumers trading down? Volume trends signal brand strength.'}
  ],
  'Industrials':[
    {date:'Monthly',title:'PMI Manufacturing Index',impact:'high',desc:'Above 50 = expansion. Key leading indicator for industrial demand.'},
    {date:'Ongoing',title:'Infrastructure Spending Bills',impact:'high',desc:'Government capex programs directly boost industrial orders.'},
    {date:'Quarterly',title:'Order Backlog Updates',impact:'medium',desc:'Forward visibility on revenue. Growing backlog = bullish signal.'}
  ],
  'Basic Materials':[
    {date:'Monthly',title:'China PMI & Demand Data',impact:'high',desc:'China consumes 50%+ of global commodities. Their growth = your price.'},
    {date:'Weekly',title:'Commodity Price Movements',impact:'high',desc:'Gold, copper, steel prices directly impact revenue and margins.'}
  ],
  'Real Estate':[
    {date:'Every 6 weeks',title:'Fed Rate Decision',impact:'high',desc:'Interest rates are the single biggest driver of REIT valuations.'},
    {date:'Monthly',title:'Housing Starts & Permits',impact:'medium',desc:'Construction activity signals demand pipeline.'},
    {date:'Quarterly',title:'Occupancy & Rent Growth',impact:'medium',desc:'REIT fundamentals depend on rental income trends.'}
  ],
  'Communication Services':[
    {date:'Quarterly',title:'Digital Ad Spending Reports',impact:'high',desc:'Ad revenue growth drives META, GOOGL and media stocks.'},
    {date:'Ongoing',title:'Streaming Subscriber Counts',impact:'high',desc:'User growth and ARPU determine streaming platform valuations.'}
  ],
  'Utilities':[
    {date:'Every 6 weeks',title:'Fed Interest Rate Decision',impact:'high',desc:'Utilities compete with bonds for yield-seeking investors.'},
    {date:'Ongoing',title:'Renewable Energy Mandates',impact:'medium',desc:'State/federal clean energy targets drive capex and growth.'}
  ]
};

// India-specific sector events
if(isIndian){
  events.push({date:'Bi-monthly',title:'RBI Monetary Policy',type:'macro',impact:'high',desc:'Repo rate decisions affect banking, real estate, and overall market sentiment.'});
  events.push({date:'Monthly',title:'FII/DII Flow Data',type:'macro',impact:'high',desc:'Foreign fund flows are the biggest driver of Indian market direction.'});
  events.push({date:'Feb',title:'Union Budget',type:'macro',impact:'high',desc:'Tax changes, sector allocations, and fiscal policy reshape markets annually.'});
  events.push({date:'Monthly',title:'GST Collection Data',type:'macro',impact:'medium',desc:'GST revenue growth signals economic activity and consumer demand.'});
}else{
  events.push({date:'Every 6 weeks',title:'FOMC Rate Decision',type:'macro',impact:'high',desc:'Federal Reserve policy is the most important macro driver for US equities.'});
  events.push({date:'Monthly',title:'CPI Inflation Report',type:'macro',impact:'high',desc:'Inflation data shapes Fed policy expectations and market direction.'});
  events.push({date:'Monthly',title:'Jobs Report (NFP)',type:'macro',impact:'high',desc:'Employment strength signals economic health. Surprise = volatility.'});
  events.push({date:'Quarterly',title:'GDP Growth Data',type:'macro',impact:'medium',desc:'Economic growth rate confirms or challenges market valuations.'});
}

// Add sector-specific events
const secEvents=sectorEvents[sector]||[];
secEvents.forEach(e=>events.push({...e,type:'sector'}));

// Sort: high impact first
events.sort((a,b)=>{const w={high:0,medium:1,low:2};return (w[a.impact]||1)-(w[b.impact]||1)});

const impactBadge=(imp)=>imp==='high'?'<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(239,68,68,.1);color:var(--red)">HIGH IMPACT</span>':imp==='medium'?'<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(245,158,11,.1);color:var(--amber)">MEDIUM</span>':'<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(107,114,128,.1);color:var(--text3)">LOW</span>';

const typeBadge=(t)=>t==='company'?'🏢 Company':t==='sector'?'🏭 Sector':'🌍 Macro';

let html=`<div style="margin-top:4px;padding:14px 16px;border-radius:10px;background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.12)">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
<span style="font-size:16px">📅</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:800;color:var(--cyan)">UPCOMING EVENTS — ${d.ticker} & ${sector||'Market'}</span>
</div>
<p style="font-size:11px;color:var(--text3);margin-bottom:14px;line-height:1.5">Key events that could move ${d.ticker}'s price in the next 3-6 months. High impact events deserve close attention.</p>
<div style="display:flex;flex-direction:column;gap:8px">`;

events.forEach(e=>{
html+=`<div style="padding:10px 14px;border-radius:8px;background:var(--card);border:1px solid var(--border);display:flex;gap:12px;align-items:flex-start">
<div style="min-width:60px;font-family:var(--mono);font-size:10px;color:var(--text3);font-weight:600;padding-top:2px">${e.date}</div>
<div style="flex:1">
<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px">
<span style="font-size:12px;font-weight:700;color:var(--text)">${e.title}</span>
${impactBadge(e.impact)}
<span style="font-size:9px;color:var(--text3)">${typeBadge(e.type)}</span>
</div>
<div style="font-size:11px;color:var(--text2);line-height:1.6">${e.desc}</div>
</div>
</div>`;
});

html+=`</div>
<div style="margin-top:10px;font-size:10px;color:var(--text3);text-align:center">Events are indicative. Check company IR page and economic calendar for exact dates.</div>
</div>`;

el.innerHTML=html;
}

function quickAnalyze(ticker){
const tickerEl=document.getElementById('ticker');
const emailEl=document.getElementById('email');
if(tickerEl)tickerEl.value=ticker;
// Check if email is filled
const em=(emailEl&&(emailEl.dataset.real||emailEl.value))||'';
if(!em||!em.includes('@')){
emailEl.focus();
emailEl.style.borderColor='var(--amber)';
emailEl.style.boxShadow='0 0 0 3px rgba(212,138,0,.15)';
setTimeout(()=>{emailEl.style.borderColor='';emailEl.style.boxShadow=''},2000);
return;
}
analyze();
}

async function analyze(){const emailEl=document.getElementById('email');const email=(emailEl.dataset.real||emailEl.value).trim(),ticker=TI.value.trim().toUpperCase(),btn=document.getElementById('btn'),rpt=document.getElementById('report');
AC.classList.remove('show');if(!email||!ticker){showStatus('Enter both email and ticker','error');return}
if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){showStatus('Enter a valid email','error');return}
try{const rl=await fetch('/api/check-rate-limit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});const rld=await rl.json();
if(!rld.allowed){showStatus(rld.reason,'error');showRL(rld);return}else hideRL()}catch(e){}
btn.disabled=true;btn.textContent='Analyzing...';btn.classList.add('ld');rpt.classList.remove('show');hideRL();
showStatus('Crunching the numbers on '+ticker+'...','info');showLS();
fetchMarketPulse();

// ═══ AUTO-RETRY: Try up to 2 times ═══
let lastErr='';
for(let attempt=1;attempt<=2;attempt++){
try{
if(attempt===2){showStatus('⏳ Retrying analysis (attempt 2/2)...','info')}
const res=await fetch('/api/generate-report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_name:ticker,email})});
if(res.status===429){const r=await res.json().catch(()=>({}));showStatus(r.reason||r.detail||'Too many requests','error');if(r.retry_after_seconds||r.retry_after_minutes)showRL(r);return}
if(res.status===503||res.status===504){
  lastErr=(await res.json().catch(()=>({}))).detail||'Service busy';
  if(attempt<2){console.log('Attempt '+attempt+' got '+res.status+', retrying in 3s...');await new Promise(r=>setTimeout(r,3000));continue}
  showStatus(lastErr+' — Please try again.','error');return}
if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.detail||e.message||'Analysis failed')}
const data=await res.json();if(!data.success||!data.live_data)throw new Error('No data for this ticker');
let q='';if(data.rate_limit){const r=data.rate_limit.remaining;document.getElementById('navQ').textContent=r+'/hr';
q=r===0?' · Last free report this hour':' · '+r+' remaining'}
if(data.report_number)document.getElementById('navRC').textContent=data.report_number;
if(data.report_number){document.getElementById('globalRC').textContent=data.report_number.toLocaleString();const hb=document.getElementById('reportBadgeCount');if(hb)hb.textContent=data.report_number.toLocaleString()}
const modelNote=data.ai_model==='template'?' (data-only mode)':data.ai_model==='haiku'?' (fast mode)':'';
showStatus('✓ Your report is ready'+modelNote+'. Scroll down — this is the good stuff.'+q,'success');displayReport(data);TI.value='';
if(typeof gtag==='function')gtag('event','generate_report',{ticker:data.live_data?.ticker||'',company:data.company_name||'',ai_model:data.ai_model||''});
break; // Success — exit retry loop
}catch(e){
  lastErr=e.message;
  if(lastErr==='Failed to fetch'&&attempt<2){console.log('Network error, retrying in 3s...');await new Promise(r=>setTimeout(r,3000));continue}
  let m=lastErr;if(m==='Failed to fetch')m='Cannot connect to server.';
  else if(m.toLowerCase().includes('rate limit')||m.toLowerCase().includes('too many')||m.toLowerCase().includes('temporarily')||m.toLowerCase().includes('all data sources'))m='All data sources busy. Try again in 30 seconds.';
  showStatus(m,'error');break}
}// end retry loop
btn.disabled=false;btn.textContent='Analyze →';btn.classList.remove('ld');hideLS()}

function displayReport(data){const d=data.live_data,curr=d.currency==='INR'?'₹':'$',price=d.current_price;
document.getElementById('tickerTag').textContent=d.ticker;document.getElementById('companyName').textContent=d.company_name||d.ticker;
const scEl=document.getElementById('stickyCompany');if(scEl){scEl.textContent=(d.company_name||d.ticker)+' · '+curr+price.toLocaleString();scEl.style.display='inline'}
const srcLabel=d.data_source==='yahoo_chart_only'?' (chart)':d.data_source==='yahoo_scrape'?' (alt)':d.data_source==='stale_cache'?' (cached)':'';
document.getElementById('timestamp').innerHTML='<div class="ldot"></div> LIVE'+srcLabel+' · '+d.data_timestamp;

// 8 METRICS (expanded from 4) - skip cards with N/A data entirely
const peDisplay=d.pe_ratio&&d.pe_ratio!=='N/A'&&d.pe_ratio!==0?d.pe_ratio:null;
const mcapRaw=d.market_cap&&d.market_cap>1e6?d.market_cap:0;
const mcapDisplay=mcapRaw>0?formatCap(mcapRaw,curr):null;
const w52valid=d.week52_low&&d.week52_high&&d.week52_low!=='N/A'&&d.week52_high!=='N/A'&&parseFloat(d.week52_high)>0;
document.getElementById('metrics').innerHTML=`
<div class="mcard"><div class="ml">Price</div><div class="mv">${curr}${price.toLocaleString()}</div><div class="ms ${d.price_change>=0?'up':'dn'}">${d.price_change>=0?'▲':'▼'} ${Math.abs(d.price_change).toFixed(2)} (${d.price_change_pct.toFixed(2)}%)</div></div>
${peDisplay?`<div class="mcard"><div class="ml">P/E Ratio</div><div class="mv">${peDisplay}</div><div class="ms nu">TTM</div></div>`:''}
${mcapDisplay?`<div class="mcard"><div class="ml">Market Cap</div><div class="mv">${mcapDisplay}</div><div class="ms nu">${d.currency}</div></div>`:''}
${w52valid?`<div class="mcard"><div class="ml">52W Range</div><div class="mv" style="font-size:16px">${curr}${d.week52_low}—${curr}${d.week52_high}</div><div class="ms nu">Low / High</div></div>`:''}`;

// 52-WEEK POSITION BAR — only show if valid data
if(w52valid){
const w52pct=Math.min(100,Math.max(0,((price-d.week52_low)/(d.week52_high-d.week52_low))*100));
document.getElementById('w52section').innerHTML=`
<div class="sh" style="margin-bottom:2px"><div class="si" style="background:rgba(0,120,212,.12)">&#9678;</div><div class="st" style="color:var(--blue)">52-Week Price Map</div></div>
<div style="padding:8px 16px 10px">
<div class="w52bar"><div class="w52fill" style="width:100%"></div><div class="w52dot" style="left:${w52pct}%"></div></div>
<div class="w52labels"><span>${curr}${d.week52_low} (Low)</span><span style="color:var(--blue);font-weight:600">${curr}${price} &middot; ${w52pct.toFixed(0)}%</span><span>${curr}${d.week52_high} (High)</span></div>
<div style="font-size:11px;color:var(--text2);margin-top:6px">${w52pct<25?'<strong style="color:var(--green)">● Bargain zone</strong> — near yearly low. Check fundamentals for entry.':w52pct>75?'<strong style="color:var(--amber)">● Hot streak</strong> — near yearly peak. Watch for resistance.':'<strong style="color:var(--blue)">● Neutral zone</strong> — mid-range. Fundamentals decide next move.'}</div>
</div>`;
}
try{createAnalysisSections(data.report,d,data.fund_holdings||{institutions:[],funds:[],summary:{}});}catch(e){console.error('CRITICAL: createAnalysisSections failed:',e);document.getElementById('analysisContainer').innerHTML='<div style="padding:40px;text-align:center;color:var(--red)"><h3>Report Rendering Error</h3><p>'+e.message+'</p><p style="font-size:11px;color:var(--text3)">Please try again or contact support.</p></div>';document.getElementById('mainTabBar').style.display='flex';switchTab('quick');}
// Charts + DecisionTool MUST run AFTER template is in DOM (canvases live inside template)
try{createCharts(d)}catch(e){console.warn('createCharts error:',e)}
window._stockData=d;window._stockCurr=curr;
// Position Analyzer disabled for SEBI compliance
document.getElementById('report').classList.add('show');
// Hide sticky tagline — tab bar replaces it
const _sTag=document.getElementById('stickyTag');if(_sTag)_sTag.style.display='none';
renderMarketEvents();
try{renderFiiDii()}catch(e){console.warn('FiiDii render error:',e)}
try{renderPeers(d,curr)}catch(e){console.warn('renderPeers error:',e)}
try{renderUpcomingEvents(d)}catch(e){console.warn('renderUpcomingEvents error:',e)}
// Scroll to metrics (above tab bar) so tab bar sticks naturally at 90px
setTimeout(()=>{const m=document.getElementById('metrics');if(m)m.scrollIntoView({behavior:'smooth',block:'start'})},200);
setTimeout(animSections,400)}

function animSections(){
// Sections are now visible immediately via inline styles from switchTab
// Add scroll indicators to overflowing sections
setTimeout(()=>{
document.querySelectorAll('.sc').forEach(el=>{
if(el.scrollHeight>el.clientHeight+20){
const ind=document.createElement('div');
ind.className='sind';
ind.innerHTML='↓ scroll for more';
el.appendChild(ind);
el.addEventListener('scroll',function(){
const atBottom=this.scrollHeight-this.scrollTop<=this.clientHeight+30;
ind.style.opacity=atBottom?'0':'1';
},{passive:true});
}});
},600)}

function createAnalysisSections(report,d,fundData){
console.log('createAnalysisSections START — d.ticker:',d?.ticker,'d.pe_ratio:',d?.pe_ratio);
// Safety defaults for all data fields
report=report||'Analysis not available.';
d=d||{};
fundData=fundData||{institutions:[],funds:[],summary:{}};
d.currency=d.currency||'USD';d.current_price=d.current_price||0;d.pe_ratio=d.pe_ratio||'N/A';
d.pb_ratio=d.pb_ratio||'N/A';d.profit_margin=d.profit_margin||'0';d.operating_margin=d.operating_margin||'0';
d.roe=d.roe||'0';d.dividend_yield=d.dividend_yield||'0';d.debt_to_equity=d.debt_to_equity||'0';
d.current_ratio=d.current_ratio||'0';d.beta=d.beta||'1';d.market_cap=d.market_cap||0;
d.week52_high=d.week52_high||d.current_price||1;d.week52_low=d.week52_low||d.current_price||0;
d.sector=d.sector||'Unknown';d.ticker=d.ticker||'';d.gross_margins=d.gross_margins||'0';
d.forward_pe=d.forward_pe||'N/A';d.peg_ratio=d.peg_ratio||'N/A';
d.sma_20=d.sma_20||0;d.sma_50=d.sma_50||0;d.sma_200=d.sma_200||0;
d.ema_9=d.ema_9||0;d.ema_21=d.ema_21||0;d.ema_50=d.ema_50||0;
d.ema_signals=d.ema_signals||[];
d.quick_ratio=d.quick_ratio||'0';d.ebitda_margins=d.ebitda_margins||'0';
// Sanitize report for safe HTML insertion
const safeReport=String(report).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/`/g,'&#96;');
const curr=d.currency==='INR'?'₹':'$',price=d.current_price,pe=parseFloat(d.pe_ratio)||0;
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A'||v===null||v===undefined)?0:f};
// ═══ DETERMINISTIC STOCK VERDICT ENGINE (20 factors — comprehensive multi-factor) ═══
// F1-F8: Original (Valuation, Profitability, Balance Sheet, 52W, P/B, Dividend, Beta, OpEff)
// F9: Earnings Velocity (EPS + Revenue CAGR)  F10: Relative Valuation (vs Sector PE)
// F11: Technical Momentum (SMA20/50/200)  F12: PEG Ratio  F13: Cash Flow  F14: Quarterly Momentum
function computeVerdict(d){
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A'||v===null||v===undefined)?0:f};
let score=0,reasons=[];
const pe=n(d.pe_ratio),fpe=n(d.forward_pe),pb=n(d.pb_ratio),dy=n(d.dividend_yield);
const pm=n(d.profit_margin),om=n(d.operating_margin),roe=n(d.roe),gm=n(d.gross_margins);
const de=n(d.debt_to_equity),cr=n(d.current_ratio),beta=n(d.beta),qr=n(d.quick_ratio);
const price=d.current_price,hi=d.week52_high,lo=d.week52_low;
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;
const sma20=n(d.sma_20),sma50=n(d.sma_50),sma200=n(d.sma_200);
const epsGrowth=n(d.eps_growth_pct),revGrowth=n(d.revenue_growth),earningsGrowth=n(d.earnings_growth);
const sectorPE=n(d.sector_avg_pe)||20;
const peg=n(d.peg_ratio),evEbitda=n(d.enterprise_to_ebitda);
const fcf=n(d.free_cash_flow),ocf=n(d.operating_cash_flow);
const totalCash=n(d.total_cash),totalDebt=n(d.total_debt),totalRev=n(d.total_revenue);
const eqg=n(d.earnings_quarterly_growth),ebitdaM=n(d.ebitda_margins);
const mcap=n(d.market_cap);

// F1: VALUATION — P/E (±20)
if(pe>0){
if(pe<10){score+=18;reasons.push('Deep value (P/E '+pe.toFixed(1)+'x) [+18]')}
else if(pe<15){score+=12;reasons.push('Value zone (P/E '+pe.toFixed(1)+'x) [+12]')}
else if(pe<22){score+=4;reasons.push('Fair valuation (P/E '+pe.toFixed(1)+'x) [+4]')}
else if(pe<35){score-=6;reasons.push('Expensive (P/E '+pe.toFixed(1)+'x) [-6]')}
else{score-=14;reasons.push('Very expensive (P/E '+pe.toFixed(1)+'x) [-14]')}}
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=5;reasons.push('Forward P/E discount — earnings growth ahead [+5]')}
else if(fpe>0&&pe>0&&fpe>pe*1.1){score-=3;reasons.push('Forward P/E premium — earnings may decline [-3]')}

// F2: PROFITABILITY — margins + ROE (±15)
if(pm>20){score+=12;reasons.push('Excellent margins ('+pm.toFixed(1)+'%) [+12]')}
else if(pm>10){score+=6;reasons.push('Solid margins ('+pm.toFixed(1)+'%) [+6]')}
else if(pm>0){score+=2;reasons.push('Thin margins ('+pm.toFixed(1)+'%) [+2]')}
else if(pm<0){score-=10;reasons.push('Unprofitable ('+pm.toFixed(1)+'%) [-10]')}
if(roe>20){score+=8;reasons.push('Strong ROE ('+roe.toFixed(1)+'%) [+8]')}
else if(roe>12){score+=4;reasons.push('Decent ROE ('+roe.toFixed(1)+'%) [+4]')}
else if(roe>0&&roe<5){score-=3;reasons.push('Weak ROE ('+roe.toFixed(1)+'%) [-3]')}

// F3: BALANCE SHEET + CASH POSITION (±16)
if(de>0){
if(de<30){score+=10;reasons.push('Fortress balance sheet (D/E '+de.toFixed(0)+') [+10]')}
else if(de<80){score+=5;reasons.push('Moderate debt (D/E '+de.toFixed(0)+') [+5]')}
else if(de<150){score-=3;reasons.push('Elevated debt (D/E '+de.toFixed(0)+') [-3]')}
else{score-=10;reasons.push('High leverage risk (D/E '+de.toFixed(0)+') [-10]')}}
if(cr>2){score+=4;reasons.push('Strong liquidity (CR '+cr.toFixed(1)+') [+4]')}
else if(cr>0&&cr<1){score-=6;reasons.push('Liquidity concern (CR '+cr.toFixed(1)+') [-6]')}
if(totalCash>0&&totalDebt>0){const cdr=totalCash/totalDebt;
if(cdr>1){score+=4;reasons.push('Net cash — cash exceeds debt by '+Math.round((cdr-1)*100)+'% [+4]')}
else if(cdr>0.5){score+=2;reasons.push('Adequate cash — '+Math.round(cdr*100)+'% of debt covered [+2]')}
else if(cdr<0.15){score-=4;reasons.push('Cash crunch — only '+Math.round(cdr*100)+'% of debt covered [-4]')}}
else if(totalCash>0&&totalDebt===0){score+=3;reasons.push('Debt-free with cash on books [+3]')}

// F4: 52-WEEK POSITION (±10)
if(w52pct<0.2){score+=8;reasons.push('Near 52W low — potential value ('+((w52pct*100).toFixed(0))+'% of range) [+8]')}
else if(w52pct<0.35){score+=4;reasons.push('Lower half of 52W range [+4]')}
else if(w52pct>0.9){score-=4;reasons.push('Near 52W high — limited upside ('+(w52pct*100).toFixed(0)+'%) [-4]')}
else if(w52pct>0.75){score+=2;reasons.push('Upper range — momentum intact [+2]')}

// F5: P/B VALUE (±8)
if(pb>0){if(pb<1){score+=8;reasons.push('Below book value (P/B '+pb.toFixed(1)+') [+8]')}
else if(pb<2.5){score+=3;reasons.push('Reasonable P/B ('+pb.toFixed(1)+') [+3]')}
else if(pb>8){score-=5;reasons.push('Extreme P/B premium ('+pb.toFixed(1)+') [-5]')}}

// F6: DIVIDEND (±5)
if(dy>4){score+=5;reasons.push('High yield ('+dy.toFixed(1)+'%) [+5]')}
else if(dy>2){score+=3;reasons.push('Decent yield ('+dy.toFixed(1)+'%) [+3]')}

// F7: RISK/BETA (±5)
if(beta>0){if(beta>2){score-=5;reasons.push('Very high volatility (Beta '+beta.toFixed(2)+') [-5]')}
else if(beta>1.5){score-=2;reasons.push('Above-avg volatility (Beta '+beta.toFixed(2)+') [-2]')}
else if(beta<0.7){score+=3;reasons.push('Defensive (Beta '+beta.toFixed(2)+') [+3]')}}

// F8: OPERATING EFFICIENCY (±5)
if(om>20){score+=5;reasons.push('High operating efficiency ('+om.toFixed(1)+'%) [+5]')}
else if(om>0&&om<5){score-=3;reasons.push('Weak operating margins ('+om.toFixed(1)+'%) [-3]')}

// F9: EARNINGS VELOCITY / CAGR (±12) *** NEW ***
const bestEG=epsGrowth||earningsGrowth;
const combG=bestEG&&revGrowth?(bestEG*0.6+revGrowth*0.4):(bestEG||revGrowth);
if(combG>30){score+=10;reasons.push('Exceptional earnings velocity — '+combG.toFixed(0)+'% combined growth [+10]')}
else if(combG>15){score+=6;reasons.push('Strong growth trajectory — '+combG.toFixed(0)+'% [+6]')}
else if(combG>5){score+=2;reasons.push('Moderate growth — '+combG.toFixed(0)+'% [+2]')}
else if(combG<=-10){score-=6;reasons.push('Earnings contracting '+combG.toFixed(0)+'% [-6]')}
else if(combG<0){score-=2;reasons.push('Mild decline '+combG.toFixed(0)+'% [-2]')}
if(revGrowth>20&&!combG){score+=5;reasons.push('Revenue surging '+revGrowth.toFixed(0)+'% [+5]')}

// F10: RELATIVE VALUATION vs SECTOR (±8) *** NEW ***
if(pe>0&&sectorPE>0){const peR=pe/sectorPE;const disc=((sectorPE-pe)/sectorPE*100).toFixed(0);
if(peR<0.6){score+=8;reasons.push('P/E '+Math.abs(disc)+'% below sector avg ('+sectorPE+'x) — deep discount [+8]')}
else if(peR<0.85){score+=4;reasons.push('P/E '+Math.abs(disc)+'% below sector — undervalued vs peers [+4]')}
else if(peR>1.5){score-=5;reasons.push('P/E '+Math.abs(disc)+'% above sector — expensive vs peers [-5]')}
else if(peR>1.2){score-=2;reasons.push('P/E premium over sector avg [-2]')}}

// F11: TECHNICAL MOMENTUM — SMA + EMA crossovers (±10)
let tS=0;const tD=[];
if(sma20>0){if(price>sma20){tS+=1;tD.push('Above SMA20')}else{tS-=1;tD.push('Below SMA20')}}
if(sma200>0){if(price>sma200){tS+=2;tD.push('Above SMA200 uptrend')}else{tS-=2;tD.push('Below SMA200 downtrend')}}
if(sma20>0&&sma200>0){if(sma20>sma200){tS+=2;tD.push('Golden Cross')}
else if(sma20<sma200*0.95){tS-=2;tD.push('Death Cross')}}
if(sma50>0&&sma200>0&&price>sma50&&price>sma200){tS+=1;tD.push('All MAs bullish')}
// EMA signals
const ema9=n(d.ema_9),ema21=n(d.ema_21),ema50=n(d.ema_50);
if(ema9>0&&ema21>0){if(ema9>ema21){tS+=1;tD.push('EMA9>21 bullish')}else{tS-=1;tD.push('EMA9<21 bearish')}}
if(ema21>0&&ema50>0){if(ema21>ema50){tS+=1;tD.push('EMA21>50 trend up')}else{tS-=1;tD.push('EMA21<50 trend down')}}
if(ema9>0&&price>ema9){tD.push('Above EMA9')}
tS=Math.max(-6,Math.min(6,tS));score+=tS;
if(tD.length){reasons.push('Technical: '+tD.join(', ')+' ['+(tS>=0?'+':'')+tS+']')}

// F12: PEG RATIO — Growth at Reasonable Price (±6) *** NEW ***
if(peg>0){if(peg<0.8){score+=6;reasons.push('PEG bargain ('+peg.toFixed(1)+') — growth underpriced [+6]')}
else if(peg<1.2){score+=3;reasons.push('PEG fair ('+peg.toFixed(1)+') [+3]')}
else if(peg>2.5){score-=4;reasons.push('PEG stretched ('+peg.toFixed(1)+') — overpaying for growth [-4]')}
else if(peg>1.8){score-=1;reasons.push('PEG slightly high ('+peg.toFixed(1)+') [-1]')}}

// F13: CASH FLOW HEALTH (±8) *** NEW ***
if(fcf>0&&totalRev>0){const fcfM=(fcf/totalRev)*100;
if(fcfM>15){score+=6;reasons.push('Excellent FCF margin '+fcfM.toFixed(1)+'% [+6]')}
else if(fcfM>5){score+=3;reasons.push('Healthy FCF '+fcfM.toFixed(1)+'% of revenue [+3]')}}
else if(fcf<0&&ocf>0){score-=2;reasons.push('Negative FCF despite positive OCF — heavy capex [-2]')}
else if(fcf<0&&ocf<=0){score-=6;reasons.push('Negative cash flows — burning cash [-6]')}
if(ocf>0&&totalDebt>0){const dc=ocf/totalDebt;
if(dc>0.5){score+=2;reasons.push('OCF covers '+Math.round(dc*100)+'% of debt [+2]')}
else if(dc<0.1){score-=2;reasons.push('Cash barely covers debt [-2]')}}

// F14: QUARTERLY EARNINGS MOMENTUM (±6)
if(eqg>0){if(eqg>25){score+=6;reasons.push('Quarterly earnings surging +'+eqg.toFixed(0)+'% YoY [+6]')}
else if(eqg>10){score+=3;reasons.push('Solid quarterly growth +'+eqg.toFixed(0)+'% [+3]')}
else{score+=1;reasons.push('Mild quarterly growth +'+eqg.toFixed(0)+'% [+1]')}}
else if(eqg<0){if(eqg<-20){score-=5;reasons.push('Quarterly earnings plunging '+eqg.toFixed(0)+'% [-5]')}
else if(eqg<-5){score-=2;reasons.push('Quarterly decline '+eqg.toFixed(0)+'% [-2]')}}

// F15: EV/EBITDA — Enterprise valuation (±8)
if(evEbitda>0){if(evEbitda<6){score+=7;reasons.push('Cheap EV/EBITDA ('+evEbitda.toFixed(1)+'x) — takeover value [+7]')}
else if(evEbitda<10){score+=4;reasons.push('Reasonable EV/EBITDA ('+evEbitda.toFixed(1)+'x) [+4]')}
else if(evEbitda<16){score+=1;reasons.push('Fair EV/EBITDA ('+evEbitda.toFixed(1)+'x) [+1]')}
else if(evEbitda>25){score-=5;reasons.push('Very expensive EV/EBITDA ('+evEbitda.toFixed(1)+'x) [-5]')}
else if(evEbitda>18){score-=2;reasons.push('Elevated EV/EBITDA ('+evEbitda.toFixed(1)+'x) [-2]')}}

// F16: GROSS MARGIN POWER — Pricing power & moat (±7)
if(gm>0){if(gm>60){score+=6;reasons.push('Elite gross margins ('+gm.toFixed(0)+'%) — strong moat & pricing power [+6]')}
else if(gm>40){score+=3;reasons.push('Healthy gross margins ('+gm.toFixed(0)+'%) [+3]')}
else if(gm<20){score-=4;reasons.push('Low gross margins ('+gm.toFixed(0)+'%) — weak moat [-4]')}}

// F17: EBITDA MARGIN QUALITY (±5)
if(ebitdaM>0){if(ebitdaM>30){score+=4;reasons.push('Strong EBITDA margins ('+ebitdaM.toFixed(0)+'%) — operational excellence [+4]')}
else if(ebitdaM>15){score+=2;reasons.push('Healthy EBITDA margins ('+ebitdaM.toFixed(0)+'%) [+2]')}
else if(ebitdaM<5&&ebitdaM>0){score-=3;reasons.push('Thin EBITDA margins ('+ebitdaM.toFixed(0)+'%) [-3]')}}

// F18: SHORT INTEREST SIGNAL (±5)
const shortR=n(d.short_ratio);
if(shortR>0){if(shortR>10){score-=4;reasons.push('Very high short interest ('+shortR.toFixed(1)+' days) — bearish [-4]')}
else if(shortR>5){score-=2;reasons.push('Elevated short interest ('+shortR.toFixed(1)+' days) [-2]')}
else if(shortR<1.5){score+=2;reasons.push('Low short interest ('+shortR.toFixed(1)+' days) — bullish sentiment [+2]')}}

// F19: DIVIDEND SUSTAINABILITY (±5)
const payoutR=n(d.payout_ratio);
if(dy>0&&payoutR>0){if(payoutR<40&&dy>2){score+=4;reasons.push('Sustainable dividend — payout '+payoutR.toFixed(0)+'% with '+dy.toFixed(1)+'% yield [+4]')}
else if(payoutR>90){score-=3;reasons.push('Unsustainable payout ('+payoutR.toFixed(0)+'%) — dividend risk [-3]')}
else if(payoutR>70){score-=1;reasons.push('High payout ratio ('+payoutR.toFixed(0)+'%) [-1]')}}

// F20: QUALITY COMBOS — Multi-factor convergence (±8)
if(combG&&combG>15&&pm>15){score+=3;reasons.push('Growth + profitability combo — rare quality [+3]')}
if(combG&&combG<0&&pm<5){score-=3;reasons.push('Declining growth + weak margins — avoid [-3]')}
if(pb>0&&pb<1.5&&pe>0&&pe<sectorPE&&fcf>0){score+=3;reasons.push('P/B + P/E below sector with positive FCF — deep value [+3]')}
if(gm>50&&roe>20&&de<50){score+=3;reasons.push('High margins + high ROE + low debt — compounding machine [+3]')}
// VALUE TRAP detection: cheap valuation + deteriorating fundamentals
if(pe>0&&pe<15&&combG&&combG<-5&&pm<8){score-=6;reasons.push('VALUE TRAP: cheap P/E but shrinking earnings + thin margins [-6]')}
// GROWTH TRAP detection: expensive + growth decelerating
if(pe>30&&combG&&combG<5&&fpe>0&&fpe>pe*0.9){score-=5;reasons.push('GROWTH TRAP: premium valuation but growth stalling [-5]')}
// TRIPLE STRENGTH: valuation + profitability + momentum all positive
if(pe>0&&pe<20&&pm>15&&roe>15&&price>sma50&&price>sma200){score+=4;reasons.push('Triple Strength: fair value + profitable + above key SMAs [+4]')}
// TRIPLE WEAKNESS: expensive + unprofitable + below key levels
if(pe>35&&pm<5&&price<sma200){score-=4;reasons.push('Triple Weakness: overvalued + weak margins + below SMA 200 [-4]')}

// ═══ VERDICT — 20-factor scoring with QUALITY GATES ═══
const totalFactors=reasons.length;
const bullish=reasons.filter(r=>r.includes('[+')).length;
const bearish=reasons.filter(r=>r.includes('[-')).length;
const netRatio=totalFactors>0?(bullish-bearish)/totalFactors:0;
let verdict,vc,conviction,emoji;
// Quality gates: score threshold PLUS minimum factor count AND net ratio
// This prevents inflated verdicts from a few extreme factors
if(score>=55&&bullish>=8&&netRatio>0.4){verdict='STRONG BUY';vc='buy';conviction='Very High';emoji='\uD83D\uDFE2'}
else if(score>=35&&bullish>=6&&netRatio>0.25){verdict='BUY';vc='buy';conviction='High';emoji='\uD83D\uDFE2'}
else if(score>=18&&bullish>=4){verdict='ACCUMULATE';vc='buy';conviction='Medium';emoji='\uD83D\uDFE2'}
else if(score>=-18){verdict='HOLD';vc='hold';conviction=Math.abs(score)<8?'Low':'Medium';emoji='\uD83D\uDFE1'}
else if(score>=-35){verdict='SELL';vc='sell';conviction='Medium';emoji='\uD83D\uDD34'}
else if(bearish>=5){verdict='STRONG SELL';vc='sell';conviction='Very High';emoji='\uD83D\uDD34'}
else{verdict='SELL';vc='sell';conviction='High';emoji='\uD83D\uDD34'}

return {verdict,vc,score,conviction,emoji,reasons,totalFactors,bullish,bearish,
  explain:verdict==='STRONG BUY'?'This stock checks almost every box — priced well, growing, profitable, and trending up. '+bullish+' out of '+totalFactors+' factors are positive. This kind of alignment is rare. For educational analysis only.'
  :verdict==='BUY'?'Company fundamentals are strong — '+bullish+' positive factors outweigh '+bearish+' concerns. Valuation and growth metrics look favorable. For educational analysis only.'
  :verdict==='ACCUMULATE'?'More positive factors ('+bullish+') than negative ('+bearish+'). A mixed but leaning-positive setup that warrants closer study. For educational analysis only.'
  :verdict==='SELL'?'Warning signs detected — '+bearish+' concerns flagged. The stock may be overvalued, margins weakening, or price trend declining. Study the risk factors carefully.'
  :verdict==='STRONG SELL'?'Multiple serious red flags across '+bearish+' areas — overvaluation, weak finances, or falling momentum. High risk detected across our 20-factor model.'
  :'Balanced signals — '+bullish+' positive vs '+bearish+' negative. No clear directional edge in either direction right now. For educational analysis only.'}
}

let vResult;
try{vResult=computeVerdict(d)}catch(e){console.error('computeVerdict error:',e);vResult={score:0,verdict:'HOLD',vc:'hold',conviction:'Low',emoji:'⚠️',explain:'Analysis unavailable',reasons:[],bullish:0,bearish:0,totalFactors:20}}
const verdict=vResult.verdict,vc=vResult.vc;
console.log('Verdict computed:',verdict,'score:',vResult.score);

let html;
try{
console.log('Building template literal...');
html=`
<div class="tab-scroll-area" id="tabScrollArea">
<!-- TAB 1: QUICK INTEL -->
<div class="sub-nav" data-tab="quick">
<a onclick="scrollToSec('sec-verdict')">&#9678; Buy or Sell?</a>
<a onclick="scrollToSec('sec-5things')">&#128200; Key Numbers</a>
<a onclick="scrollToSec('sec-valuation')">&#128176; Overpriced?</a>
<a onclick="scrollToSec('sec-peers')">⚔ Peers</a>
<a onclick="scrollToSec('sec-entry')">&#127919; When to Buy/Sell</a>
<a onclick="scrollToSec('sec-risk')">&#9888; Risks</a>
<a onclick="scrollToSec('sec-charts')">&#128202; Charts</a>

</div>

<!-- VERDICT (always open) -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--green)"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#9678;</div><div class="st" style="color:var(--green)" id="sec-verdict">Verdict</div></div>
<div class="sbody" style="text-align:left">
<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
<div style="flex-shrink:0;text-align:center">
<div class="vpill ${vc}" style="padding:8px 24px;font-size:16px">${verdict}</div>
<div style="margin-top:6px;font-size:10px;color:var(--text3)">Score: <strong style="color:var(--text)">${vResult.score>0?'+':''}${vResult.score}</strong> · Confidence: <strong>${vResult.conviction}</strong> · <span style="color:var(--green)">${vResult.bullish||0} positive</span> / <span style="color:var(--red)">${vResult.bearish||0} negative</span> signals</div>
</div>
<div style="flex:1;min-width:200px">
<p style="font-size:12px;color:var(--text2);margin-bottom:8px">${vResult.explain}</p>
<div style="display:flex;flex-wrap:wrap;gap:4px">
${vResult.reasons.map(r=>{const isPos=r.includes('[+');return '<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:'+(isPos?'rgba(16,185,129,.08)':'rgba(239,68,68,.08)')+';color:'+(isPos?'var(--green)':'var(--red)')+';white-space:nowrap">'+r+'</span>'}).join('')}
</div>
</div>
</div>
</div></div>

<!-- FII/DII FLOW — Indian markets only -->
<div class="sc" data-tab="quick" data-conditional="1" style="border-left:3px solid var(--blue);display:none" id="fiiDiiCard">
<div class="sh"><div class="si" style="background:rgba(37,99,235,.1)">&#127963;</div><div class="st" style="color:var(--blue)" id="sec-fiidii">Who's Buying &amp; Selling Indian Markets Today?</div></div>
<div class="sbody" id="fiiDiiBody"></div>
</div>

<!-- DECISION POINTS -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--amber)"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">&#9651;</div><div class="st" style="color:var(--amber)" id="sec-5things">Key Numbers at a Glance</div></div>
<div class="sbody">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-bottom:12px">
${(d.pe_ratio&&d.pe_ratio!=='N/A'&&pe>0)?`<div style="padding:10px;border-radius:8px;text-align:center;background:${pe<18?'rgba(16,185,129,.06)':pe<28?'rgba(245,158,11,.06)':'rgba(239,68,68,.06)'};border:1px solid ${pe<18?'rgba(16,185,129,.15)':pe<28?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)'}">
<div style="font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700">Valuation</div>
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${pe<18?'var(--green)':pe<28?'var(--amber)':'var(--red)'}">${d.pe_ratio}x</div>
<div style="font-size:9px;color:var(--text3)">${pe<18?'✅ Cheap':pe<28?'⚠️ Fair':'🚨 Expensive'}</div>
</div>`:''}
${(d.profit_margin&&d.profit_margin!=='N/A'&&parseFloat(d.profit_margin)!==0)?`<div style="padding:10px;border-radius:8px;text-align:center;background:${parseFloat(d.profit_margin)>15?'rgba(16,185,129,.06)':parseFloat(d.profit_margin)>8?'rgba(245,158,11,.06)':'rgba(239,68,68,.06)'};border:1px solid ${parseFloat(d.profit_margin)>15?'rgba(16,185,129,.15)':parseFloat(d.profit_margin)>8?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)'}">
<div style="font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700">Profitability</div>
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${parseFloat(d.profit_margin)>15?'var(--green)':parseFloat(d.profit_margin)>8?'var(--amber)':'var(--red)'}">${d.profit_margin}%</div>
<div style="font-size:9px;color:var(--text3)">${parseFloat(d.profit_margin)>15?'✅ Strong moat':parseFloat(d.profit_margin)>8?'⚠️ Moderate':'❌ Thin'}</div>
</div>`:''}
${(d.debt_to_equity&&d.debt_to_equity!=='N/A'&&parseFloat(d.debt_to_equity)>0)?`<div style="padding:10px;border-radius:8px;text-align:center;background:${parseFloat(d.debt_to_equity)<0.5?'rgba(16,185,129,.06)':parseFloat(d.debt_to_equity)<1.5?'rgba(245,158,11,.06)':'rgba(239,68,68,.06)'};border:1px solid ${parseFloat(d.debt_to_equity)<0.5?'rgba(16,185,129,.15)':parseFloat(d.debt_to_equity)<1.5?'rgba(245,158,11,.15)':'rgba(239,68,68,.15)'}">
<div style="font-size:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700">Debt Risk</div>
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${parseFloat(d.debt_to_equity)<0.5?'var(--green)':parseFloat(d.debt_to_equity)<1.5?'var(--amber)':'var(--red)'}">${d.debt_to_equity}x</div>
<div style="font-size:9px;color:var(--text3)">${parseFloat(d.debt_to_equity)<0.5?'✅ Conservative':parseFloat(d.debt_to_equity)<1.5?'⚠️ Moderate':'🚨 High leverage'}</div>
</div>`:''}
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
${(d.market_cap&&d.market_cap!=='N/A'&&parseFloat(d.market_cap)>0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">MARKET CAP</div>
<div style="font-size:13px;font-weight:700;color:var(--text)">${formatCap(d.market_cap,curr)} <span style="font-size:10px;color:var(--text3)">${capCategory(d.market_cap,curr)}</span></div>
</div>`:''}
${(d.week52_high&&d.week52_high!=='N/A'&&parseFloat(d.week52_high)>0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">52-WEEK POSITION</div>
<div style="font-size:13px;font-weight:700;color:var(--text)">${((price/d.week52_high)*100).toFixed(0)}% of high ${(d.beta&&d.beta!=='N/A'&&parseFloat(d.beta)>0)?'<span style="font-size:10px;color:var(--text3)">'+(parseFloat(d.beta)>1.3?'High volatility':parseFloat(d.beta)<0.7?'Low volatility':'Avg volatility')+'</span>':''}</div>
</div>`:''}
${(d.roe&&d.roe!=='N/A'&&parseFloat(d.roe)!==0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">ROE (Return on Equity)</div>
<div style="font-size:13px;font-weight:700;color:${parseFloat(d.roe)>15?'var(--green)':'var(--text)'}">${d.roe}% <span style="font-size:10px;color:var(--text3)">${parseFloat(d.roe)>15?'Capital efficient':'Average'}</span></div>
</div>`:''}
${(d.dividend_yield&&d.dividend_yield!=='N/A'&&parseFloat(d.dividend_yield)>0)?`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,120,212,.03);border:1px solid rgba(0,120,212,.1)">
<div style="font-size:9px;color:var(--text3);margin-bottom:2px">DIVIDEND INCOME</div>
<div style="font-size:13px;font-weight:700;color:${parseFloat(d.dividend_yield)>2?'var(--green)':'var(--text)'}">${d.dividend_yield}% <span style="font-size:10px;color:var(--text3)">${parseFloat(d.dividend_yield)>3?'High income':parseFloat(d.dividend_yield)>1?'Some income':'Growth focus'}</span></div>
</div>`:''}
</div>
<div style="margin-top:12px;padding:12px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(245,158,11,.05),rgba(59,130,246,.03));border:1px solid rgba(245,158,11,.12)">
<div style="font-size:12px;font-weight:700;color:var(--amber);margin-bottom:6px">💡 What do these numbers tell you?</div>
<div style="font-size:11px;color:var(--text2);line-height:1.8">
${pe<18&&parseFloat(d.profit_margin)>15?'<strong style="color:var(--green)">Great combo</strong> — stock is cheap AND the company makes good money. This is the sweet spot investors look for.'
:pe>28&&parseFloat(d.profit_margin)<8?'<strong style="color:var(--red)">Warning</strong> — you\'re paying a premium price for a company with thin profits. The stock needs strong growth to justify this.'
:pe<18?'Stock appears <strong style="color:var(--green)">underpriced</strong> relative to its earnings — could be a bargain if the business is solid.'
:pe>28?'Stock is <strong style="color:var(--amber)">priced for perfection</strong> — any earnings miss could cause a sharp drop.'
:'Valuation is <strong>in the fair range</strong> — neither a screaming buy nor overpriced.'}
${parseFloat(d.debt_to_equity)>1.5?' High debt levels mean the company is borrowing heavily — risky if interest rates rise or business slows.':''}
${d.market_cap>100e9?' As a large-cap stock, it\'s relatively stable but may grow slower than smaller companies.':d.market_cap<10e9?' As a smaller company, expect bigger price swings — higher reward potential but higher risk.':''}
</div>
</div>
</div></div>

<!-- VALUATION TABLE -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--blue)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">&#9678;</div><div class="st" style="color:var(--blue)" id="sec-valuation">Is This Stock Overpriced?</div></div>
<div class="sbody">
<p style="font-size:12px;color:var(--text3);margin-bottom:14px">Every number decoded. No jargon:</p>
<table class="dt"><tr><th>Metric</th><th>Value</th><th>Signal</th><th>What This Means For You</th></tr>
${(d.pe_ratio&&d.pe_ratio!=='N/A'&&pe>0)?`<tr><td><strong>P/E Ratio</strong><br><span style="font-size:10px;color:var(--text3)">Price-to-Earnings</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.pe_ratio}</td>
<td><span class="sig ${pe<15?'g':pe<25?'n':'c'}">${pe<15?'● Undervalued':pe<25?'● Fair':'● Expensive'}</span></td>
<td style="font-size:12px;line-height:1.7">${pe<15?'Below 15x earnings. Bargain zone.':pe<25?'Fair at '+d.pe_ratio+'x earnings.':d.pe_ratio+'x earnings. Growth must justify.'}</td></tr>`:''}
${(d.pb_ratio&&d.pb_ratio!=='N/A'&&parseFloat(d.pb_ratio)>0)?`<tr><td><strong>P/B Ratio</strong><br><span style="font-size:10px;color:var(--text3)">Price-to-Book</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.pb_ratio}</td>
<td><span class="sig ${parseFloat(d.pb_ratio)<3?'g':'c'}">${parseFloat(d.pb_ratio)<3?'● Reasonable':'● Premium'}</span></td>
<td style="font-size:12px;line-height:1.7">${parseFloat(d.pb_ratio)<3?d.pb_ratio+'x book. Asset-backed.':d.pb_ratio+'x book. Paying for intangibles.'}</td></tr>`:''}
${(d.profit_margin&&d.profit_margin!=='N/A'&&parseFloat(d.profit_margin)!==0)?`<tr><td><strong>Profit Margin</strong><br><span style="font-size:10px;color:var(--text3)">Profit per $ revenue</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.profit_margin}%</td>
<td><span class="sig ${parseFloat(d.profit_margin)>15?'g':parseFloat(d.profit_margin)>8?'n':'r'}">${parseFloat(d.profit_margin)>15?'● Excellent':parseFloat(d.profit_margin)>8?'● Moderate':'● Thin'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.profit_margin}% net margin. ${parseFloat(d.profit_margin)>15?'Strong moat.':parseFloat(d.profit_margin)>8?'Decent.':'Tight.'}</td></tr>`:''}
${(d.operating_margin&&d.operating_margin!=='N/A'&&parseFloat(d.operating_margin)!==0)?`<tr><td><strong>Operating Margin</strong><br><span style="font-size:10px;color:var(--text3)">Core profitability</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.operating_margin}%</td>
<td><span class="sig ${parseFloat(d.operating_margin)>20?'g':parseFloat(d.operating_margin)>10?'n':'r'}">${parseFloat(d.operating_margin)>20?'● Strong':parseFloat(d.operating_margin)>10?'● OK':'● Weak'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.operating_margin}% ops margin. ${parseFloat(d.operating_margin)>20?'Efficient.':'Room to improve.'}</td></tr>`:''}
${(d.roe&&d.roe!=='N/A'&&parseFloat(d.roe)!==0)?`<tr><td><strong>ROE</strong><br><span style="font-size:10px;color:var(--text3)">Return on Equity</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.roe}%</td>
<td><span class="sig ${parseFloat(d.roe)>15?'g':'n'}">${parseFloat(d.roe)>15?'● High':'● Moderate'}</span></td>
<td style="font-size:12px;line-height:1.7">${d.roe}% return on equity. ${parseFloat(d.roe)>15?'Capital-efficient.':'Average.'}</td></tr>`:''}
${(d.dividend_yield&&d.dividend_yield!=='N/A'&&parseFloat(d.dividend_yield)>=0)?`<tr><td><strong>Dividend Yield</strong><br><span style="font-size:10px;color:var(--text3)">Annual income</span></td><td style="font-family:var(--mono);font-weight:700;font-size:16px">${d.dividend_yield}%</td>
<td><span class="sig ${parseFloat(d.dividend_yield)>3?'g':parseFloat(d.dividend_yield)>1?'n':'c'}">${parseFloat(d.dividend_yield)>3?'● High Income':parseFloat(d.dividend_yield)>1?'● Some Income':'● Growth Focus'}</span></td>
<td style="font-size:12px;line-height:1.7">${parseFloat(d.dividend_yield)>3?d.dividend_yield+'% yield. Solid income.':parseFloat(d.dividend_yield)>1?d.dividend_yield+'% yield + growth.':'Reinvests for growth.'}</td></tr>`:''}
</table>
<div style="margin-top:14px;padding:14px;border-radius:10px;background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.03));border:1px solid rgba(0,120,212,.12)">
<div style="font-size:12px;font-weight:700;color:var(--blue);margin-bottom:6px">💡 Valuation Summary</div>
<div style="font-size:11px;color:var(--text2);line-height:1.8">
${pe>0&&pe<15?'<strong style="color:var(--green)">Stock looks undervalued.</strong> You\'re paying less per rupee of earnings than most companies. If fundamentals are solid, this could be a steal.'
:pe>=15&&pe<25?'<strong style="color:var(--blue)">Fairly valued.</strong> The market is pricing this stock reasonably. Not a bargain, but not overpriced either. Good entry if you believe in the company\'s growth story.'
:pe>=25&&pe<40?'<strong style="color:var(--amber)">Premium pricing.</strong> The market expects strong growth from this company. If earnings disappoint even slightly, the stock could drop fast.'
:pe>=40?'<strong style="color:var(--red)">Very expensive.</strong> You\'re paying a steep price for future growth that hasn\'t been proven yet. High risk of correction.'
:'Check the P/E ratio to understand valuation.'}
${parseFloat(d.profit_margin)>15&&pe<25?' High profitability at a fair price — the best combination.':''}
${parseFloat(d.roe)>20?' Strong returns on equity suggest efficient management.':''}
${parseFloat(d.pb_ratio)>0&&parseFloat(d.pb_ratio)<1?' Trading below book value — either a bargain or the market sees problems ahead.':''}
${parseFloat(d.dividend_yield)>3?' Generous dividend — good for income-seeking investors.':''}
</div>
</div>
</div></div>

<!-- PEER / COMPETITOR COMPARISON -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--teal)"><div class="sh"><div class="si" style="background:rgba(20,184,166,.1)">⚔</div><div class="st" style="color:var(--teal)" id="sec-peers">Peer Comparison</div></div>
<div class="sbody" id="peerSection">
<p style="font-size:12px;color:var(--text3);margin-bottom:10px">Loading peer data...</p>
</div>
</div>

<!-- ENTRY & EXIT — Multi-Factor Technical -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(139,92,246,.1)">⬡</div><div class="st" style="color:var(--purple)" id="sec-entry">Entry &amp; Exit Levels</div></div>
<div class="sbody">
<div style="font-size:10px;color:var(--text3);margin-bottom:10px">Levels computed from multiple technical factors including trend, momentum, volatility, and price history. Updated with live data.</div>
<table class="dt"><tr><th>Action</th><th>Price</th><th>Why This Level</th><th>What To Do</th></tr>
<tr><td style="font-weight:700;color:var(--green)">● Buy Zone</td><td><span class="ptag buy">${curr}${(()=>{const e50=n(d.ema_50),s200=n(d.sma_200),fib=d.week52_low+(d.week52_high-d.week52_low)*0.382;const best=e50?Math.min(e50,fib,price*0.93):Math.min(fib,price*0.93);return best.toFixed(2)})()}</span></td><td style="font-size:11px">Strong support zone</td><td style="font-size:12px">${vResult.verdict.includes('BUY')?'Accumulate aggressively at this level':'Start building position here'}</td></tr>
<tr><td style="font-weight:700;color:var(--cyan)">● Accumulate</td><td><span class="ptag buy">${curr}${(()=>{const e21=n(d.ema_21),s50=n(d.sma_50),fib=d.week52_low+(d.week52_high-d.week52_low)*0.5;const best=e21?Math.min(e21,price*0.96):Math.min(fib,price*0.96);return best.toFixed(2)})()}</span></td><td style="font-size:11px">Key demand area</td><td style="font-size:12px">Add on dips to this level</td></tr>
<tr><td style="font-weight:700">● Current</td><td><span class="ptag cur">${curr}${price.toLocaleString()}</span></td><td style="font-size:11px">Live price</td><td style="font-size:12px">${vResult.verdict}</td></tr>
<tr><td style="font-weight:700;color:var(--amber)">● Target 1</td><td><span class="ptag pro">${curr}${(()=>{const e9=n(d.ema_9),fib=d.week52_low+(d.week52_high-d.week52_low)*0.786;const up=n(d.beta)>1.3?price*1.12:price*1.08;const best=e9&&e9>price?Math.max(e9,up):Math.min(fib,up);return Math.max(best,price*1.05).toFixed(2)})()}</span></td><td style="font-size:11px">Near-term resistance</td><td style="font-size:12px">Book 30–50% of position</td></tr>
<tr><td style="font-weight:700;color:var(--amber)">● Target 2</td><td><span class="ptag pro">${curr}${(()=>{const ext=d.week52_low+(d.week52_high-d.week52_low)*1.272;const alt=Math.max(d.week52_high*0.97,price*1.18);return Math.min(ext,alt).toFixed(2)})()}</span></td><td style="font-size:11px">Potential breakout level</td><td style="font-size:12px">Exit remaining profits</td></tr>
<tr><td style="font-weight:700;color:var(--red)">● Stop Loss</td><td><span class="ptag stp">${curr}${(()=>{const e50=n(d.ema_50),s200=n(d.sma_200),fib=d.week52_low+(d.week52_high-d.week52_low)*0.236;const anchor=e50||s200||price;const best=Math.min(anchor*0.95,fib,price*0.88);return Math.max(best,d.week52_low*1.02).toFixed(2)})()}</span></td><td style="font-size:11px">Below key floor</td><td style="font-size:12px">Strict exit — protect capital</td></tr>
</table>
<div style="margin-top:12px;padding:10px 14px;border-radius:8px;background:linear-gradient(135deg,rgba(139,92,246,.04),rgba(59,130,246,.04));border:1px solid rgba(139,92,246,.1)">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:14px">&#128161;</span>
<span style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--purple)">How to read these levels</span>
</div>
<div style="font-size:11px;color:var(--text2);line-height:1.7">
<strong style="color:var(--green)">Buy Zone</strong> = best price to enter a fresh position. <strong style="color:var(--cyan)">Accumulate</strong> = add more if you already hold.
<strong style="color:var(--amber)">Targets</strong> = where to book profits in stages. <strong style="color:var(--red)">Stop Loss</strong> = exit if price falls here to limit damage.
${n(d.beta)>1.3?' This stock has higher-than-average volatility — use wider stops and smaller position sizes.':n(d.beta)<0.7?' This stock is relatively stable — levels are tighter than usual.':''}
</div>
</div>
</div></div>

<!-- RISK ASSESSMENT -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--red)"><div class="sh"><div class="si" style="background:rgba(239,68,68,.1)">&#9888;</div><div class="st" style="color:var(--red)" id="sec-risk">What Could Go Wrong?</div></div>
<div class="sbody">
<table class="dt"><tr><th>Factor</th><th>Metric</th><th>Signal</th><th>Assessment</th></tr>
${(()=>{let rows='';
const de=parseFloat(d.debt_to_equity)||0,cr=parseFloat(d.current_ratio)||0,bt=parseFloat(d.beta)||1;
if(de>0)rows+=`<tr><td>Debt Level</td><td style="font-family:var(--mono);font-weight:600">${d.debt_to_equity}</td><td><span class="sig ${de>1.5?'r':de>0.8?'c':'g'}">${de>1.5?'High':de>0.8?'Moderate':'Low'}</span></td><td style="font-size:12px">${de>1.5?'High leverage \u2014 watch carefully':de>0.8?'Moderate \u2014 manageable':'Conservative \u2014 low risk'}</td></tr>`;
if(cr>0)rows+=`<tr><td>Liquidity</td><td style="font-family:var(--mono);font-weight:600">${d.current_ratio}</td><td><span class="sig ${cr>1.5?'g':cr>1?'c':'r'}">${cr>1.5?'Strong':cr>1?'Adequate':'Weak'}</span></td><td style="font-size:12px">${cr>1.5?'Can meet obligations easily':cr>1?'Tight but OK':'Liquidity concerns'}</td></tr>`;
rows+=`<tr><td>Volatility</td><td style="font-family:var(--mono);font-weight:600">${bt.toFixed(2)}</td><td><span class="sig ${bt>1.5?'r':bt<0.8?'g':'n'}">${bt>1.5?'High':bt<0.8?'Low':'Average'}</span></td><td style="font-size:12px">${bt>1.5?'Expect bigger price swings':bt<0.8?'Less volatile \u2014 defensive':'Average volatility'}</td></tr>`;
if(d.sector&&d.sector!=='N/A'&&d.sector!=='Unknown')rows+=`<tr><td>Sector</td><td>${d.sector}</td><td><span class="sig n">Monitor</span></td><td style="font-size:12px">Track trends &amp; regulation</td></tr>`;
const w52pct=d.week52_high>0?((price/d.week52_high)*100).toFixed(0):0;
if(Number(w52pct)>90)rows+=`<tr><td>52W Position</td><td style="font-family:var(--mono);font-weight:600">${w52pct}% of high</td><td><span class="sig r">Stretched</span></td><td style="font-size:12px">Near 52-week high \u2014 pullback risk</td></tr>`;
else if(Number(w52pct)<40)rows+=`<tr><td>52W Position</td><td style="font-family:var(--mono);font-weight:600">${w52pct}% of high</td><td><span class="sig c">Beaten down</span></td><td style="font-size:12px">Far from highs \u2014 could be value or value trap</td></tr>`;
return rows;})()}
</table>
<div style="margin-top:12px;padding:12px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(239,68,68,.05),rgba(245,158,11,.03));border:1px solid rgba(239,68,68,.1)">
<div style="font-size:12px;font-weight:700;color:var(--red);margin-bottom:6px">&#9888;&#65039; Risk Summary</div>
<div style="font-size:11px;color:var(--text2);line-height:1.8">
${(()=>{const de=parseFloat(d.debt_to_equity)||0,cr=parseFloat(d.current_ratio)||0,bt=parseFloat(d.beta)||1;
if(de>1.5&&cr>0&&cr<1)return '<strong style="color:var(--red)">High risk</strong> \u2014 heavy debt AND weak cash. One bad quarter could create serious trouble.';
if(de>1.5)return '<strong style="color:var(--amber)">Elevated debt</strong> \u2014 if interest rates rise or business slows, this stock will feel the pain first.';
if(cr>0&&cr<1)return '<strong style="color:var(--amber)">Cash is tight</strong> \u2014 the company may struggle to pay short-term bills. Watch quarterly results closely.';
return '<strong style="color:var(--green)">Manageable risk</strong> \u2014 reasonable debt and enough cash to operate. No immediate red flags.';})()}
${(()=>{const bt=parseFloat(d.beta)||1;return bt>1.5?' Expect <strong>bigger daily swings</strong> than the overall market.':'';})()}
</div>
</div>
</div></div>

<!-- CHARTS (Summary — hidden until sub-tab click) -->
<div class="sc" data-tab="quick" style="border-left:3px solid var(--cyan)" id="chartsCard">
<div class="sh"><div class="si" style="background:rgba(0,120,212,.08)">&#128202;</div><div class="st" style="color:var(--cyan)" id="sec-charts">Visual Charts &amp; Trends</div></div>
<div class="sbody" id="chartsInner">
<div class="cgrid">
<div class="ccard"><div class="cct">How is this stock valued?</div><div class="cc"><canvas id="valChart"></canvas></div><div id="valInference" class="cinf" style="background:rgba(59,130,246,.04);border-color:rgba(0,120,212,.12)"></div></div>
<div class="ccard"><div class="cct">Is the company financially healthy?</div><div class="cc"><canvas id="healthChart"></canvas></div><div id="healthInference" class="cinf" style="background:rgba(16,185,129,.04);border-color:rgba(16,185,129,.1)"></div></div>
<div class="ccard"><div class="cct">How risky is this stock?</div><div class="cc"><canvas id="riskChart"></canvas></div><div id="riskInference" class="cinf" style="background:rgba(239,68,68,.04);border-color:rgba(239,68,68,.1)"></div></div>
</div>
<div class="cgrid2">
<div class="ccard"><div class="cct">Price trend over 6 months</div><div class="cc2"><canvas id="trendChart"></canvas></div><div id="trendInference" class="cinf" style="background:rgba(59,130,246,.04);border-color:rgba(0,120,212,.12)"></div></div>
<div class="ccard"><div class="cct">How do margins compare to the industry?</div><div class="cc2"><canvas id="marginChart"></canvas></div><div id="marginVsInference" class="cinf" style="background:rgba(6,182,212,.04);border-color:rgba(6,182,212,.1)"></div></div>
</div>
</div></div>

<!-- POSITION ANALYZER — removed for SEBI compliance -->

<!-- ═══ TAB: DEEP DIVE ═══ -->
<div class="sub-nav" data-tab="deep">
<a onclick="scrollToSec('sec-verdictai')">&#127891; Why This Verdict?</a>
<a onclick="scrollToSec('sec-ai')">&#128196; Full AI Report</a>
</div>

<div class="sc" data-tab="deep" style="border-left:3px solid var(--blue)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">🎓</div><div class="st" style="color:var(--blue)" id="sec-verdictai">AI Verdict Breakdown — Green, Yellow & Red</div></div>
<div class="sbody"><div id="aiAnalysisFormatted"></div></div></div>

<!-- Full AI Report -->
<div class="sc" data-tab="deep" style="border-left:3px solid var(--blue)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">&#9889;</div><div class="st" style="color:var(--blue)" id="sec-ai">AI Analyst Report — Full Depth</div></div>
<div class="sbody">
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">
<div style="padding:10px;border-radius:8px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);text-align:center">
<div style="font-size:18px">${vResult.emoji}</div>
<div style="font-size:12px;font-weight:800;color:${vc==='buy'?'var(--green)':vc==='sell'?'var(--red)':'var(--amber)'}">${verdict}</div>
<div style="font-size:9px;color:var(--text3)">${vResult.conviction} Confidence</div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(0,120,212,.04);border:1px solid rgba(0,120,212,.12);text-align:center">
<div style="font-family:var(--mono);font-size:18px;font-weight:800;color:var(--text)">${vResult.score>0?'+':''}${vResult.score}</div>
<div style="font-size:9px;color:var(--text3)">Overall Score</div>
<div style="font-size:9px;color:var(--green)">${vResult.bullish||0} positive / <span style="color:var(--red)">${vResult.bearish||0} negative</span></div>
</div>
<div style="padding:10px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.12);text-align:center">
<div style="font-size:14px;font-weight:800;color:var(--text)">${d.sector}</div>
<div style="font-size:9px;color:var(--text3)">${d.market_cap&&d.market_cap>0?formatCap(d.market_cap,curr)+' cap':d.sector}</div>
<div style="font-size:9px;color:var(--text3)">${(d.beta&&d.beta!=='N/A'&&n(d.beta)!==1)?n(d.beta)>1.3?'High volatility':'Low volatility':''}</div>
</div>
</div>
<div style="padding:16px;border-radius:10px;background:var(--bg);border:1px solid var(--border)">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:8px">&#128196; Complete AI-Generated Research Report</div>
<div id="fullAIraw" class="ait" style="max-height:500px;overflow-y:auto;padding-right:8px;font-size:12px;line-height:1.8">${safeReport}</div>
</div></div></div>




<!-- ═══ TAB: EARNINGS ═══ -->
<div class="sub-nav" data-tab="mgmt">
<a onclick="scrollToSec('sec-fund')">&#128200; Latest Earnings</a>
<a onclick="scrollToSec('sec-mgmt')">&#127908; What Management Says</a>
<a onclick="scrollToSec('sec-funds')">&#127974; Who's Investing?</a>
</div>

<div class="sc" data-tab="mgmt" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128200;</div><div class="st" style="color:var(--green)" id="sec-fund">Latest Quarter &#8212; Are They Actually Growing?</div></div>
<div class="sbody">
<div id="fundContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing quarterly fundamentals...</p></div></div>
<!-- QoQ/YoY Charts -->
<div id="qoyCharts" style="display:none;margin-top:16px">
<div class="cgrid2">
<div class="ccard"><div class="cct">&#128200; QoQ Momentum</div><div style="height:200px;position:relative"><canvas id="qoqChart"></canvas></div><div id="qoqInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(59,130,246,.04);border:1px solid rgba(0,120,212,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
<div class="ccard"><div class="cct">&#128200; YoY Growth Trend</div><div style="height:200px;position:relative"><canvas id="yoyChart"></canvas></div><div id="yoyInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
</div>
<div style="margin-top:14px" class="ccard"><div class="cct">&#128200; Margin Trend — QoQ vs YoY</div><div style="height:200px;position:relative"><canvas id="marginTrendChart"></canvas></div><div id="marginInference" style="margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.08);font-size:11px;color:var(--text2);line-height:1.6"></div></div>
</div>
</div></div>


<!-- Management Tone -->
<div class="sc" data-tab="mgmt" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(168,85,247,.1)">&#127908;</div><div class="st" style="color:var(--purple)" id="sec-mgmt">Management Tone — Read Between the Lines</div></div>
<div class="sbody">
<div id="mgmtContent"><div class="ic pu" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing management tone...</p></div></div>
</div></div>

<!-- FUND HOLDINGS -->
<div class="sc" data-tab="mgmt" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(0,120,212,.12)">&#127974;</div><div class="st" style="color:var(--blue)" id="sec-funds">Top Fund &amp; Institutional Holdings</div></div>
<div class="sbody">
<div id="fundHoldingsContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Loading fund holdings...</p></div></div>
</div></div>

<!-- ═══ TAB: FORECAST ═══ -->
<div class="sc" data-tab="next" style="border-left:3px solid var(--cyan)"><div class="sh"><div class="si" style="background:rgba(6,182,212,.1)">&#128302;</div><div class="st" style="color:var(--cyan)" id="sec-next">What's Next — Catalysts &amp; Timeline</div></div>
<div class="sbody">
<div id="whatsNextContent"><div class="ic bl" style="text-align:center"><p style="color:var(--text3)">&#9203; Analyzing upcoming catalysts...</p></div></div>
<div id="sectorEventsContent" style="margin-top:16px"></div>
</div></div>


<!-- ═══ TAB: GEMS ═══ -->

<div class="sc" data-tab="gems" style="border-left:3px solid var(--amber)"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">⭐</div><div class="st" style="color:var(--amber)" id="sec-gems">Sector Gems — 10x Small-Caps in <span id="gemsSectorName"></span></div></div>
<div class="sbody">
<div style="padding:10px 14px;border-radius:8px;background:linear-gradient(135deg,rgba(245,158,11,.06),rgba(212,138,0,.03));border:1px solid rgba(245,158,11,.15);margin-bottom:14px">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">&#128161;</span>
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:800;color:var(--amber)">WHY THESE PICKS?</span>
</div>
<p style="font-size:11px;color:var(--text2);line-height:1.6;margin:0">You searched <strong id="gemsTickerRef" style="color:var(--amber)"></strong>. These are under-the-radar small-caps in the <strong id="smallCapSector" style="color:var(--amber)">${d.sector}</strong> sector that share similar tailwinds but with 10-50x growth potential. We match by sector, geography, and growth thesis.</p>
</div>
<div id="smallCapTable"></div>
<div class="ic am" style="margin-top:14px"><p><strong>⚠️ Real talk:</strong> Small-caps = high risk, high reward. Same sector as <strong id="smallCapTicker">${d.ticker}</strong>. Only invest what you can lose. Spread across 5–8 picks. Think 10+ years. These are NOT recommendations — do your own research.</p></div>
</div></div>

<!-- ═══ TAB: PICKS ═══ -->
<!-- SUB-NAV for Picks tab -->
<div class="sub-nav" data-tab="picks">
<a onclick="scrollToSec('sec-conviction')">&#127942; Top Picks</a>
<a onclick="scrollToSec('sec-stockpicks')">&#128161; Stock Ideas</a>
<a onclick="scrollToSec('sec-portfolio')">&#129504; My Portfolio</a>
</div>

<!-- PICKS: Portfolio Decision Engine — toggle panel -->
<!-- PICKS SUB-TAB 2: Conviction Leaderboard -->
<div class="sc" data-tab="picks" style="border-left:3px solid var(--teal,#0d9488)"><div class="sh"><div class="si" style="background:rgba(13,148,136,.1)">&#127942;</div><div class="st" style="color:#0d9488" id="sec-conviction">Conviction Leaderboard — Top 5 by Country</div></div>
<div class="sbody">
<div id="convictionLeaderboard">
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="convGeoTabs">
<button class="ptab active" onclick="showConvGeo(this,'india')" style="background:var(--amber);color:#000;border-color:var(--amber)">&#127470;&#127475; India</button>
<button class="ptab" onclick="showConvGeo(this,'usa')">&#127482;&#127480; USA</button>
</div>
<div id="convGrid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px"></div>
</div>
</div></div>

<!-- PICKS SUB-TAB 3: Curated Stock Picks -->
<div class="sc" data-tab="picks" style="border-left:3px solid var(--purple)"><div class="sh"><div class="si" style="background:rgba(139,92,246,.1)">&#128161;</div><div class="st" style="color:var(--purple)" id="sec-stockpicks">Curated Stock Picks — Sector-Based</div></div>
<div class="sbody">
<div id="stockPicksSection">
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="pickTabs">
<button class="ptab active" onclick="showPickCat(this,'lc')">Large Cap</button>
<button class="ptab" onclick="showPickCat(this,'mc')">Mid Cap</button>
<button class="ptab" onclick="showPickCat(this,'sc')">Small Cap</button>
<button class="ptab" onclick="showPickCat(this,'niche')">Niche/Moat</button>
<button class="ptab" onclick="showPickCat(this,'micro')">&#128640; Micro Cap</button>
<button class="ptab" onclick="showPickCat(this,'penny')">&#128176; Penny Gems</button>
<button class="ptab" onclick="showPickCat(this,'idx')">&#128200; Best Index</button>
</div>
<div id="pickGrid"></div>
</div>
</div></div>

<div class="sc" data-tab="picks" style="border-left:3px solid var(--blue)" id="portfolioCard"><div class="sh"><div class="si" style="background:rgba(59,130,246,.1)">&#129504;</div><div class="st" style="color:var(--blue)" id="sec-portfolio">Portfolio Decision Engine</div></div>
<div class="sbody">
<div style="padding:14px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.04));border:1px solid rgba(0,120,212,.25);margin-bottom:18px">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
<span style="font-size:18px">&#129504;</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:800;color:var(--blue)">Portfolio Decision Engine</span>
<span style="font-size:9px;color:var(--text3);padding:2px 6px;border-radius:4px;background:var(--surface);border:1px solid var(--border)">Multi-Factor Algorithm</span>
</div>
<div style="font-size:10px;color:var(--text3);margin-bottom:12px">Enter your stock &amp; buy price — get a data-driven HOLD / SELL / ADD decision with probability across 3, 6, 12-month horizons.</div>
<div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">TICKER (e.g. RELIANCE.NS, AAPL)</label>
<input type="text" id="pdTicker" placeholder="RELIANCE.NS" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#f0f2f5;color:var(--text);font-family:var(--mono);font-size:13px;font-weight:700"></div>
<div style="flex:0.6;min-width:100px"><label style="font-size:9px;color:var(--text3);display:block;margin-bottom:3px">YOUR BUY PRICE</label>
<input type="number" id="pdBuyPrice" placeholder="1250" step="0.01" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#f0f2f5;color:var(--text);font-family:var(--mono);font-size:13px;font-weight:700"></div>
<button onclick="runPortfolioDecision()" id="pdBtn" style="padding:8px 20px;border-radius:8px;border:2px solid var(--blue);background:rgba(59,130,246,.12);color:var(--blue);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">&#9889; Analyze Decision</button>
</div>
<div id="pdResult" style="margin-top:12px"></div>
</div>
<div style="padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.1)">
<div style="font-family:'Sora',sans-serif;font-size:10px;font-weight:700;color:var(--purple);letter-spacing:.5px;margin-bottom:8px">RATING &amp; LABEL GUIDE</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;font-size:10px;line-height:1.6">
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(16,185,129,.15);color:#10b981;font-weight:800">&#9733; Aggressive Buy</span> Strong fundamentals + survives 30-40% correction</span>
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(16,185,129,.1);color:#10b981;font-weight:700">Strong Buy</span> Excellent business, limited correction downside</span>
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(0,120,212,.12);color:#3b82f6;font-weight:700">Buy</span> Good value but moderate correction sensitivity</span>
<span><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(245,158,11,.1);color:#f59e0b;font-weight:700">Accumulate</span> Build position gradually on dips</span>
</div>
</div>
</div></div>

<!-- ═══ TAB: ETF & FUNDS ═══ -->
<div class="sc" data-tab="funds" style="border-left:3px solid var(--green)"><div class="sh"><div class="si" style="background:rgba(16,185,129,.1)">&#128176;</div><div class="st" style="color:var(--green)" id="sec-etf">ETF &amp; Funds — 25%+ CAGR Compounders</div></div>
<div class="sbody">
<div style="padding:10px 14px;border-radius:8px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.1);margin-bottom:14px">
<div style="font-family:'Sora',sans-serif;font-size:10px;font-weight:700;color:var(--green);letter-spacing:.5px;margin-bottom:6px">SELECTION CRITERIA</div>
<div style="font-size:10px;color:var(--text2);line-height:1.6">Only funds with <strong style="color:var(--green)">25%+ CAGR</strong> over 5-year AND/OR 10-year periods. Correction resilience scored on max drawdown + recovery speed during COVID (Mar 2020), 2022 bear market, and Oct 2023 correction. <strong style="color:var(--amber)">SIP-friendly picks</strong> — designed for long-term wealth building, not trading.</div>
</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px" id="fundTabs">
<button class="ptab active" onclick="showFundCat(this,'etf_in')">&#127470;&#127475; India ETFs</button>
<button class="ptab" onclick="showFundCat(this,'mf_in')">&#127470;&#127475; India Mutual Funds</button>
<button class="ptab" onclick="showFundCat(this,'etf_us')">&#127482;&#127480; USA ETFs</button>
<button class="ptab" onclick="showFundCat(this,'mf_us')">&#127482;&#127480; USA Funds</button>
<button class="ptab" onclick="showFundCat(this,'compare')">&#128202; Comparison</button>
</div>
<div id="fundGrid"></div>
</div></div>

<!-- TAB 7: INDEX TRADES (Restricted Access) -->
<div class="sc" data-tab="trades" style="border-left:3px solid var(--red)"><div class="sh"><div class="si" style="background:rgba(245,158,11,.1)">&#128293;</div><div class="st" style="color:var(--amber)" id="sec-trades">Smart Trades &#8212; Daily Ideas</div></div>
<div class="sbody">
<div id="tradesContent">
<div style="text-align:center;padding:30px 20px">
<div style="font-size:40px;margin-bottom:12px">&#128274;</div>
<div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:700;color:var(--amber);margin-bottom:8px">Premium Trading Intelligence</div>
<p style="font-size:13px;color:var(--text3);max-width:450px;margin:0 auto 20px;line-height:1.7">Top 5 index + 2 stock option trade ideas daily. Nifty, Bank Nifty, Sensex &amp; high-momentum stocks.</p>
<button id="tradesLoadBtn" onclick="loadIndexTrades()" style="padding:12px 28px;border-radius:10px;border:2px solid var(--amber);background:rgba(245,158,11,.1);color:var(--amber);font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s">&#9889; Generate Today's Trades</button>
<button id="scorecardBtn" onclick="loadTradeScorecard()" style="padding:12px 20px;border-radius:10px;border:2px solid var(--cyan);background:rgba(6,182,212,.08);color:var(--cyan);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;cursor:pointer;margin-left:8px">&#128202; Trade Scorecard</button>
<div id="tradesError" style="margin-top:12px;font-size:12px;color:var(--red);display:none"></div>
<div id="scorecardArea" style="display:none;margin-top:16px"></div>
</div>
</div>
</div></div>

</div><!-- end tab-scroll-area -->
`;
}catch(te){console.error('Template error:',te);html='<div style="padding:40px;text-align:center;color:var(--red)"><h3>Rendering Error</h3><p>'+te.message+'</p></div>';}

console.log('Template built OK, length:',html?.length,'chars');
document.getElementById('analysisContainer').innerHTML=html;
console.log('innerHTML set OK, calling switchTab...');
// Show static tab bar
document.getElementById('mainTabBar').style.display='flex';
// Show tabs FIRST — before any chart/analysis code that might error
checkTradesAccess();
try{formatAIAnalysis(report)}catch(e){console.warn('formatAIAnalysis error:',e)}
try{populateFundamentals(report)}catch(e){console.warn('populateFundamentals error:',e)}
try{populateManagement(report)}catch(e){console.warn('populateManagement error:',e)}
try{populateFundHoldings(report, fundData)}catch(e){console.warn('populateFundHoldings error:',e)}
try{populateWhatsNext(report)}catch(e){console.warn('populateWhatsNext error:',e)}
try{generateSmallCapRecommendations(d)}catch(e){console.warn('generateSmallCapRecommendations error:',e)}
try{renderConviction()}catch(e){console.warn('renderConviction error:',e)}
// Auto-open Quick Intel tab
switchTab('quick');
// Refresh watermark with user email
try{refreshWatermark()}catch(e){}
// Draw attention to vote button after report loads
setTimeout(()=>{const fab=document.querySelector('.fab');if(fab){fab.style.transform='scale(1.15)';fab.style.boxShadow='0 0 40px rgba(139,92,246,.6)';setTimeout(()=>{fab.style.transform='';fab.style.boxShadow=''},1500)}},4000);
// Draw attention to tab bar with pulse animation
const tbar=document.querySelector('.tab-bar');
if(tbar){tbar.classList.add('attention');setTimeout(()=>tbar.classList.remove('attention'),6500)}}

// ═══════════════════════════════════════════════
// TAB SWITCHING
// ═══════════════════════════════════════════════
function toggleChartsSection(){
// Legacy function — charts are now in their own tab
window.dispatchEvent(new Event('resize'));
}

function switchTab(tab){
try{
if(typeof gtag==='function')gtag('event','switch_tab',{tab_name:tab});
if(tab==='quick')setTimeout(()=>window.dispatchEvent(new Event('resize')),200);

// 1) Hide ALL tab content and sub-navs
document.querySelectorAll('.sc[data-tab]').forEach(s=>{s.style.display='none'});
document.querySelectorAll('.sub-nav[data-tab]').forEach(s=>{s.style.display='none'});
document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));

// 2) Show matching tab content
document.querySelectorAll('.sc[data-tab="'+tab+'"]').forEach(s=>{
if(!s.dataset.conditional)s.style.display='block';
});
document.querySelectorAll('.sub-nav[data-tab="'+tab+'"]').forEach(s=>{s.style.display='flex'});

// 3) Activate button
const btnMap={quick:'tabBtnQuick',deep:'tabBtnDeep',mgmt:'tabBtnMgmt',next:'tabBtnNext',gems:'tabBtnGems',picks:'tabBtnPicks',funds:'tabBtnFunds',trades:'tabBtnTrades'};
if(btnMap[tab]){const btn=document.getElementById(btnMap[tab]);if(btn)btn.classList.add('active')}

// 4) Scroll to top of new tab content — scroll-margin-top:140px on .sc handles sticky offset
const firstSec=document.querySelector('.sc[data-tab="'+tab+'"]');
if(firstSec) firstSec.scrollIntoView({behavior:'instant',block:'start'});

console.log('switchTab:',tab,'→ done');
}catch(e){console.error('switchTab error:',e)}
}

// Scroll to section — uses CSS scroll-margin-top for sticky header offset
function scrollToSec(id){
const el=document.getElementById(id);if(!el)return;
el.scrollIntoView({behavior:'smooth',block:'start'});
}

// ═══════════════════════════════════════════════
// PARSE AI TEXT → QUARTERLY FUNDAMENTALS
// ═══════════════════════════════════════════════
// populateFundamentals is defined below after colorizeText
// populateManagement is defined below after colorizeText

// CHARTS (5 total) - with beginner-friendly tooltips + N/A handling
function createCharts(d){
if(valChart)valChart.destroy();if(trendChart)trendChart.destroy();if(healthChart)healthChart.destroy();if(riskChart)riskChart.destroy();if(marginChart)marginChart.destroy();
const gc='rgba(0,47,108,.06)';
Chart.defaults.color='#94a3b8';Chart.defaults.font.family="'DM Sans',sans-serif";
const ttBase={backgroundColor:'rgba(0,47,108,.95)',titleColor:'#fff',bodyColor:'#d1d5db',borderColor:'rgba(0,120,212,.25)',borderWidth:1,cornerRadius:8,padding:12,titleFont:{size:13,weight:'700'},bodyFont:{size:12},displayColors:false};

// Helper: parse number, return 0 for N/A
function n(v){const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f}

// Detect if we have meaningful data
const pe=n(d.pe_ratio),pb=n(d.pb_ratio),dy=n(d.dividend_yield);
const pm=n(d.profit_margin),om=n(d.operating_margin),roe=n(d.roe);
const beta=Math.abs(n(d.beta))||1,de=n(d.debt_to_equity),cr=n(d.current_ratio)||1;
const hasValuation=true; // Always show — will display 0 values with "Data unavailable" note
const hasHealth=(pm>0||om>0||roe>0||n(d.current_ratio)>0||dy>0);
const hasRisk=true; // Always show — beta defaults to 1, de defaults to moderate

// Hide entire chart card when no data, collapse empty grids
function hideChart(canvasId){
const canvas=document.getElementById(canvasId);
if(!canvas)return;
const card=canvas.closest('.ccard');
if(card)card.style.display='none';
// If all siblings in the grid are hidden, hide the grid too
const grid=card?.parentElement;
if(grid&&(grid.classList.contains('cgrid')||grid.classList.contains('cgrid2'))){
const visible=[...grid.children].filter(c=>c.style.display!=='none');
if(visible.length===0)grid.style.display='none';
}
}

// 1. Valuation Bar
if(hasValuation){
const valExplain=['P/E Ratio: How much you pay per $1 of earnings.\n'+( pe<15?'Below 15 = potential bargain!':pe<25?'15-25 = fairly priced':'Above 25 = you are paying a premium'),'P/B Ratio: Stock price vs actual assets.\n'+(pb<3?'Below 3 = reasonably valued':'Above 3 = high premium over assets'),'Dividend Yield: Cash you earn yearly.\n'+(dy>3?'Above 3% = great passive income':dy>1?'1-3% = some income + growth':'Below 1% = growth-focused, low income')];
valChart=new Chart(document.getElementById('valChart').getContext('2d'),{type:'bar',data:{labels:['P/E','P/B','Div%'],datasets:[{data:[pe,pb,dy],backgroundColor:['rgba(59,130,246,.35)','rgba(139,92,246,.35)','rgba(16,185,129,.35)'],borderColor:['#3b82f6','#8b5cf6','#10b981'],borderWidth:1.5,borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return['P/E Ratio','P/B Ratio','Dividend Yield'][c[0].dataIndex]},label:function(c){return['Value: '+c.formattedValue,'',valExplain[c.dataIndex]].join('\n')}}}},scales:{y:{beginAtZero:true,grid:{color:gc}},x:{grid:{display:false}}}}});
}else{hideChart('valChart')}

// 2. Financial Health Radar
if(hasHealth){
const hVals=[Math.min(100,pm),Math.min(100,roe),Math.min(100,(n(d.current_ratio))*25),Math.min(100,om),Math.min(100,dy*10)];
const hLabels=['Profit Margin','ROE','Current Ratio','Op. Margin','Div Yield'];
const hExplain=['How much profit per $1 of sales. Higher = better pricing power.','Return on equity. Above 15% = excellent use of shareholder money.','Can the company pay its short-term bills? Above 1.5 = safe.','Profit from core business before taxes. Higher = efficient operations.','Cash returned to you yearly. Higher = more passive income.'];
healthChart=new Chart(document.getElementById('healthChart').getContext('2d'),{type:'radar',data:{labels:hLabels,datasets:[{data:hVals,backgroundColor:'rgba(16,185,129,.12)',borderColor:'#10b981',borderWidth:2,pointBackgroundColor:'#10b981',pointRadius:4,pointHoverRadius:7,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#10b981',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return hLabels[c[0].dataIndex]},label:function(c){return['Score: '+c.formattedValue+'/100','',hExplain[c.dataIndex]].join('\n')}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(59,130,246,.06)'},angleLines:{color:'rgba(59,130,246,.06)'},ticks:{display:false},pointLabels:{font:{size:9},color:'#94a3b8'}}}}});
}else{hideChart('healthChart')}

// 3. Risk Radar
if(hasRisk){
const rVals=[Math.min(100,(beta||1)*40),Math.min(100,de>0?de*30:30),Math.min(100,cr>0?Math.max(0,100-cr*40):50),Math.min(100,(pe>0?pe:15)*2),50];
const rLabels=['Volatility','Debt','Liquidity Risk','Valuation Risk','Sector Risk'];
const rExplain=['How wildly the price swings vs the market.\nHigher = bumpier ride for your portfolio.','How much the company owes vs owns.\nHigh debt = more risk if business slows down.','Can the company cover its bills right now?\nHigh risk here = cash flow concerns.','Is the stock overpriced for what it earns?\nHigher = you might be overpaying.','General risk from the industry and economy.\nAll sectors carry some baseline risk.'];
riskChart=new Chart(document.getElementById('riskChart').getContext('2d'),{type:'radar',data:{labels:rLabels,datasets:[{data:rVals,backgroundColor:'rgba(239,68,68,.1)',borderColor:'#ef4444',borderWidth:2,pointBackgroundColor:'#ef4444',pointRadius:4,pointHoverRadius:7,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#ef4444',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return rLabels[c[0].dataIndex]+' Risk'},label:function(c){const v=c.raw;const lv=v>70?'HIGH RISK':v>40?'MODERATE':'LOW';return['Risk Score: '+Math.round(v)+'/100 ('+lv+')','',rExplain[c.dataIndex]].join('\n')}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(59,130,246,.06)'},angleLines:{color:'rgba(59,130,246,.06)'},ticks:{display:false},pointLabels:{font:{size:9},color:'#94a3b8'}}}}});
}else{hideChart('riskChart')}

// 4. Price Trend (uses real historical data if available, simulated fallback)
const price=d.current_price||100;
const realHist=d.price_history&&d.price_history.length>=2?d.price_history:null;
const trend=realHist||[];
if(!realHist){for(let i=6;i>=0;i--)trend.push(price*(1+(Math.random()-.5)*.12*i/6))}
const trendLabels=realHist?trend.map((_,i)=>i===trend.length-1?'Today':i===0?`${trend.length-1}M Ago`:`${trend.length-1-i}M`):['6M Ago','5M','4M','3M','2M','1M','Today'];
const curr=d.currency==='INR'?'₹':'$';
trendChart=new Chart(document.getElementById('trendChart').getContext('2d'),{type:'line',data:{labels:trendLabels,datasets:[{data:trend,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.06)',fill:true,tension:.4,borderWidth:2.5,pointBackgroundColor:'#3b82f6',pointBorderColor:'#ffffff',pointBorderWidth:2,pointRadius:4,pointHoverRadius:8,pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'#3b82f6',pointHoverBorderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{...ttBase,callbacks:{title:function(c){return 'Price — '+c[0].label},label:function(c){const p=c.raw;const diff=p-price;const pct=((p/price-1)*100).toFixed(1);return['Price: '+curr+p.toFixed(2),'vs Today: '+(diff>=0?'+':'')+pct+'%','','Hover each point to track the price journey'].join('\n')}}}},scales:{y:{grid:{color:gc},ticks:{callback:function(v){return curr+v.toFixed(0)}}},x:{grid:{display:false}}}}});

// 5. Margin Comparison
if(hasHealth){
const mExplain={0:['Profit Margin: '+pm+'% vs 15% benchmark','',pm>15?'Beating the benchmark = strong pricing power!':pm>8?'Close to benchmark. Decent but room to improve.':'Below benchmark. Tight margins = competitive pressure.'],1:['Operating Margin: '+om+'% vs 12% benchmark','',om>12?'Core business is running efficiently.':'Core operations could be more profitable.'],2:['Return on Equity: '+roe+'% vs 15% benchmark','',roe>15?'Great returns for shareholders!':'Average returns. Capital could work harder.']};
marginChart=new Chart(document.getElementById('marginChart').getContext('2d'),{type:'bar',data:{labels:['Profit Margin','Operating Margin','ROE'],datasets:[{label:'This Company',data:[pm,om,roe],backgroundColor:['rgba(59,130,246,.4)','rgba(6,182,212,.4)','rgba(16,185,129,.4)'],borderColor:['#3b82f6','#06b6d4','#10b981'],borderWidth:1.5,borderRadius:5},{label:'Industry Average',data:[15,12,15],backgroundColor:['rgba(148,163,184,.1)','rgba(148,163,184,.1)','rgba(148,163,184,.1)'],borderColor:['#475569','#475569','#475569'],borderWidth:1,borderRadius:5}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:12,padding:10,color:'#94a3b8'}},tooltip:{...ttBase,callbacks:{title:function(c){return c[0].label},afterBody:function(c){return mExplain[c[0].dataIndex]||[]}}}},scales:{x:{beginAtZero:true,grid:{color:gc},ticks:{callback:function(v){return v+'%'}}},y:{grid:{display:false}}}}});
}else{hideChart('marginChart')}

// ═══ CHART INFERENCES — Plain English for all 5 charts ═══
// Valuation
const vI=document.getElementById('valInference');
if(vI&&pe>0){
const peVerdict=pe<15?'<strong style="color:var(--green)">undervalued</strong> — below 15x earnings':pe<25?'<strong style="color:var(--blue)">fairly valued</strong> — reasonable multiple':'<strong style="color:var(--amber)">premium priced</strong> — market expects high growth';
const pbVerdict=pb<2?'Book value supports the price.':pb<5?'Moderate premium over book value.':'High premium — mostly intangible value.';
const dyVerdict=dy>3?'Strong dividend income.':dy>1?'Modest income + growth.':'Growth stock — reinvests profits.';
const curr=d.currency==='INR'?'₹':'$';
let ivHtml='';
const iv=d.intrinsic;
if(iv){
ivHtml='<div style="margin-top:8px;padding:8px 10px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.1);display:flex;flex-wrap:wrap;gap:6px 14px;font-size:10px">';
ivHtml+='<span style="font-weight:800;color:#8b5cf6;font-size:10px;letter-spacing:.3px">INTRINSIC VALUE</span>';
if(iv.graham){const gc=iv.graham_upside>10?'var(--green)':iv.graham_upside<-10?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">Graham: <strong style="color:${gc}">${curr}${iv.graham.toLocaleString()}</strong> <span style="font-size:9px;color:${gc}">(${iv.graham_upside>0?'+':''}${iv.graham_upside}%)</span></span>`}
if(iv.dcf_simple){const dc=iv.dcf_upside>10?'var(--green)':iv.dcf_upside<-10?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">DCF: <strong style="color:${dc}">${curr}${iv.dcf_simple.toLocaleString()}</strong> <span style="font-size:9px;color:${dc}">(${iv.dcf_upside>0?'+':''}${iv.dcf_upside}%)</span></span>`}
if(iv.earnings_yield){const ep=iv.earnings_yield_premium;const ec=ep>2?'var(--green)':ep<0?'var(--red)':'var(--text2)';ivHtml+=`<span style="color:var(--text2)">E-Yield: <strong style="color:${ec}">${iv.earnings_yield}%</strong> <span style="font-size:9px;color:${ec}">${ep>0?'+':''}${ep}% vs bonds</span></span>`}
if(iv.book_value){ivHtml+=`<span style="color:var(--text2)">Book: <strong>${curr}${iv.book_value.toLocaleString()}</strong></span>`}
ivHtml+='</div>';
}
vI.innerHTML=`<strong style="color:var(--blue)">Reading:</strong> At ${pe.toFixed(1)}x earnings, this stock is ${peVerdict}. P/B of ${pb.toFixed(1)}x — ${pbVerdict} Yield ${dy.toFixed(1)}% — ${dyVerdict}${ivHtml}`;
}

// Financial Health
const hI=document.getElementById('healthInference');
if(hI){
if(pm<=0&&om<=0&&roe<=0){
hI.innerHTML=`<strong style="color:var(--amber)">Health check:</strong> Margin data unavailable for this stock. Check your broker or financial portal for detailed profitability metrics.`;
}else{
const scores=[pm,om,roe,dy].filter(v=>v>0);
const avg=scores.length?scores.reduce((a,b)=>a+b,0)/scores.length:0;
const verdict=avg>20?'<strong style="color:var(--green)">Excellent financial health</strong> — strong across metrics':avg>10?'<strong style="color:var(--blue)">Solid fundamentals</strong> — above-average profitability':'<strong style="color:var(--amber)">Room for improvement</strong> — watch for margin expansion';
const best=pm>=om&&pm>=roe?'Profit margins':roe>=pm&&roe>=om?'Capital efficiency':'Operating margins';
hI.innerHTML=`<strong style="color:var(--green)">Health check:</strong> ${verdict}. Strongest area: ${best}. Profit margin ${pm.toFixed(1)}%, Operating margin ${om.toFixed(1)}%, ROE ${roe.toFixed(1)}%.`;
}
}

// Risk Profile
const riI=document.getElementById('riskInference');
if(riI){
const beta=d.beta||1;
const de=parseFloat(d.debt_to_equity)||0;
const betaVerdict=beta>1.3?'<strong style="color:var(--red)">high volatility</strong> — swings more than the market':beta>0.8?'<strong style="color:var(--blue)">moderate volatility</strong> — moves with the market':'<strong style="color:var(--green)">low volatility</strong> — defensive stock';
const debtVerdict=de>100?'Heavy debt load.':de>50?'Moderate leverage.':'Conservative balance sheet.';
riI.innerHTML=`<strong style="color:var(--red)">Risk summary:</strong> Beta of ${beta.toFixed(2)} means ${betaVerdict}. D/E ratio ${de.toFixed(0)}% — ${debtVerdict} ${de>100?'Watch for interest rate sensitivity.':''}`;
}

// Price Trend
const tI=document.getElementById('trendInference');
if(tI&&trend&&trend.length>=2){
const sixMoAgo=trend[0];const today=trend[trend.length-1];
const totalReturn=((today-sixMoAgo)/sixMoAgo*100).toFixed(1);
const peak=Math.max(...trend);const trough=Math.min(...trend);
const drawdown=((peak-trough)/peak*100).toFixed(1);
const recent=trend[trend.length-1]-trend[trend.length-2];
const recentDir=recent>0?'<strong style="color:var(--green)">trending up</strong>':'<strong style="color:var(--red)">pulling back</strong>';
tI.innerHTML=`<strong style="color:var(--blue)">6-month return:</strong> <strong style="color:${totalReturn>=0?'var(--green)':'var(--red)'}">${totalReturn>=0?'+':''}${totalReturn}%</strong>${realHist?'':' <span style="font-size:9px;color:var(--text3)">(approx)</span>'}. Drawdown: ${drawdown}%. Currently ${recentDir}. ${parseFloat(totalReturn)>15?'Strong momentum.':parseFloat(totalReturn)<-10?'Under pressure.':'Watch for breakout.'}`;
}

// Margin vs Industry
const mvI=document.getElementById('marginVsInference');
if(mvI){
if(pm<=0&&om<=0&&roe<=0){
mvI.innerHTML=`<strong style="color:#06b6d4">vs Peers:</strong> Margin data unavailable for comparison. Check your broker for detailed profitability metrics.`;
}else{
const pmBeat=pm>15;const omBeat=om>12;const roeBeat=roe>15;
const beatsCount=[pmBeat,omBeat,roeBeat].filter(Boolean).length;
const verdict=beatsCount===3?'<strong style="color:var(--green)">Outperforms industry</strong> on all three metrics — competitive moat visible':beatsCount>=1?'<strong style="color:var(--blue)">Mixed vs industry</strong> — beats on some metrics, lags on others':'<strong style="color:var(--red)">Underperforms industry averages</strong> — efficiency improvements needed';
mvI.innerHTML=`<strong style="color:#06b6d4">vs Peers:</strong> ${verdict}. ${pm>0?'Profit margin '+pm.toFixed(1)+'% '+(pmBeat?'&#10003;':'&#10007;')+' | ':''} ${om>0?'Op. margin '+om.toFixed(1)+'% '+(omBeat?'&#10003;':'&#10007;')+' | ':''} ${roe>0?'ROE '+roe.toFixed(1)+'% '+(roeBeat?'&#10003;':'&#10007;'):''} <span style="color:var(--text3)">(&#10003;=beats avg, &#10007;=below avg)</span>`;
}
}
}

// SMALL CAP DATABASE (ALL sectors)
function generateSmallCapRecommendations(d){
const sector=d.sector||'Technology',isIndian=d.ticker&&(d.ticker.includes('.NS')||d.ticker.includes('.BO')||d.currency==='INR');
// Populate dynamic header
const gSec=document.getElementById('gemsSectorName');if(gSec)gSec.textContent=sector;
const gTk=document.getElementById('gemsTickerRef');if(gTk)gTk.textContent=d.ticker||'';
const db={
'Technology_US':[{n:'Palantir (PLTR)',s:'AI/Big Data',k:'Gov + enterprise AI platform',p:'Very High',r:5},{n:'CrowdStrike (CRWD)',s:'Cybersecurity',k:'Cloud-native endpoint protection',p:'Very High',r:5},{n:'Datadog (DDOG)',s:'Monitoring',k:'Unified observability platform',p:'Very High',r:4},{n:'MongoDB (MDB)',s:'Database',k:'Modern document DB, dev-first',p:'High',r:4},{n:'Cloudflare (NET)',s:'Edge',k:'CDN, security, serverless',p:'Very High',r:4},{n:'Unity (U)',s:'3D/Gaming',k:'Real-time 3D engine',p:'High',r:3}],
'Technology_India':[{n:'Kaynes Technology',s:'IoT/Defense',k:'Defense electronics, govt contracts',p:'Exceptional',r:5},{n:'Dixon Technologies',s:'Electronics Mfg',k:'PLI beneficiary, contract mfg',p:'Very High',r:5},{n:'Persistent Systems',s:'Software',k:'Digital engineering, healthcare IT',p:'Very High',r:4},{n:'Coforge',s:'IT Services',k:'Insurance & banking tech',p:'High',r:4},{n:'KPIT Technologies',s:'Auto SW',k:'EV software, T25 auto clients',p:'Very High',r:4},{n:'Happiest Minds',s:'Digital',k:'Cloud, IoT, security',p:'High',r:3}],
'Financial Services_US':[{n:'SoFi (SOFI)',s:'Fintech',k:'Digital banking, lending',p:'Very High',r:5},{n:'Markel (MKL)',s:'Insurance',k:'Mini Berkshire model',p:'High',r:4},{n:'Shift4 (FOUR)',s:'Payments',k:'Integrated processing',p:'Very High',r:4},{n:'Ally Financial (ALLY)',s:'Banking',k:'Top online bank, auto lending',p:'High',r:3},{n:'Houlihan Lokey (HLI)',s:'IB',k:'M&A advisory, restructuring',p:'High',r:4},{n:'Kinsale Capital (KNSL)',s:'Insurance',k:'E&S, tech underwriting',p:'High',r:3}],
'Financial Services_India':[{n:'Bajaj Finance',s:'NBFC',k:'Consumer lending leader',p:'Very High',r:5},{n:'Chola Finance',s:'Vehicle Finance',k:'Vehicle + home loans',p:'Very High',r:4},{n:'SBI Cards',s:'Credit Cards',k:'SBI network, card growth',p:'High',r:4},{n:'CDSL',s:'Depository',k:'Duopoly, demat growth',p:'High',r:4},{n:'Angel One',s:'Broking',k:'Discount broking platform',p:'Very High',r:4},{n:'Motilal Oswal',s:'Financial',k:'Broking, AMC, wealth',p:'High',r:3}],
'Healthcare_US':[{n:'Intuitive Surgical (ISRG)',s:'Robotic Surgery',k:'Da Vinci monopoly',p:'Very High',r:5},{n:'Dexcom (DXCM)',s:'Devices',k:'CGM leader diabetes',p:'Very High',r:4},{n:'Veeva (VEEV)',s:'Life Sci IT',k:'Cloud for pharma',p:'High',r:4},{n:'Shockwave (SWAV)',s:'Cardiology',k:'Intravascular lithotripsy',p:'Very High',r:4},{n:'Axonics (AXNX)',s:'Neuro',k:'Bladder/bowel therapy',p:'High',r:3},{n:'Inspire Medical (INSP)',s:'Sleep',k:'Implantable neurostim',p:'High',r:3}],
'Healthcare_India':[{n:'Max Healthcare',s:'Hospitals',k:'Premium hospitals',p:'Very High',r:5},{n:'Narayana Health',s:'Hospitals',k:'Affordable healthcare',p:'Very High',r:4},{n:'Laurus Labs',s:'Pharma',k:'API + formulations',p:'High',r:4},{n:'Metropolis',s:'Diagnostics',k:'Premium diagnostics',p:'High',r:3},{n:'Syngene',s:'CRAMS',k:'Contract research',p:'Very High',r:4},{n:'Gland Pharma',s:'Injectables',k:'Global injectables',p:'High',r:3}],
'Consumer Cyclical_US':[{n:'Airbnb (ABNB)',s:'Travel',k:'Global marketplace',p:'Very High',r:5},{n:'Lululemon (LULU)',s:'Athleisure',k:'Premium cult brand',p:'High',r:4},{n:'DraftKings (DKNG)',s:'Betting',k:'Online gaming leader',p:'Very High',r:4},{n:'Carvana (CVNA)',s:'Auto',k:'Online used car marketplace',p:'High',r:3},{n:'Floor & Decor (FND)',s:'Home',k:'Specialty flooring',p:'High',r:3},{n:'Five Below (FIVE)',s:'Retail',k:'Teen/tween value',p:'High',r:3}],
'Consumer Cyclical_India':[{n:'Trent Limited',s:'Retail',k:'Zara India + Zudio',p:'Exceptional',r:5},{n:'Page Industries',s:'Innerwear',k:'Jockey India',p:'Very High',r:4},{n:'Devyani Intl',s:'QSR',k:'KFC + Pizza Hut India',p:'Very High',r:4},{n:'Varun Beverages',s:'Beverages',k:'PepsiCo franchise',p:'Very High',r:4},{n:'Jubilant FoodWorks',s:'QSR',k:'Dominos India',p:'High',r:3},{n:'Bata India',s:'Footwear',k:'Brand heritage',p:'High',r:3}],
'Industrials_US':[{n:'Chart Industries (GTLS)',s:'Equipment',k:'LNG, hydrogen',p:'Very High',r:4},{n:'Generac (GNRC)',s:'Power',k:'Generators, clean energy',p:'High',r:4},{n:'Bloom Energy (BE)',s:'Fuel Cells',k:'Solid oxide cells',p:'Very High',r:4},{n:'AAON (AAON)',s:'HVAC',k:'Commercial HVAC',p:'High',r:3},{n:'AZEK (AZEK)',s:'Building',k:'Sustainable decking',p:'High',r:3},{n:'Fluence (FLNC)',s:'Storage',k:'Battery systems',p:'Very High',r:4}],
'Industrials_India':[{n:'Kaynes Technology',s:'Defense',k:'Defense & space, IoT',p:'Exceptional',r:5},{n:'Dixon Technologies',s:'Electronics',k:'PLI, diversified',p:'Very High',r:5},{n:'Polycab India',s:'Cables',k:'Infra growth, FMEG',p:'Very High',r:4},{n:'KEI Industries',s:'Cables',k:'Power cables',p:'High',r:3},{n:'Kalpataru Projects',s:'EPC',k:'Power transmission',p:'High',r:3},{n:'Apar Industries',s:'Conductors',k:'Specialty cables',p:'High',r:4}],
'Energy_US':[{n:'Enphase (ENPH)',s:'Solar',k:'Microinverters',p:'Very High',r:4},{n:'Array Tech (ARRY)',s:'Trackers',k:'Utility-scale solar',p:'High',r:3},{n:'Chord Energy (CHRD)',s:'O&G',k:'Bakken, low-cost',p:'High',r:3},{n:'Magnolia Oil (MGY)',s:'O&G',k:'Eagle Ford',p:'High',r:3},{n:'Shoals Tech (SHLS)',s:'Solar',k:'EBOS',p:'High',r:3},{n:'NextEra Partners (NEP)',s:'Renewables',k:'Wind & solar',p:'High',r:3}],
'Energy_India':[{n:'Adani Green',s:'Renewables',k:'Solar/wind capacity',p:'Very High',r:4},{n:'Tata Power',s:'Power',k:'Renewable transition',p:'Very High',r:4},{n:'SJVN',s:'Hydro',k:'Hydro, PSU backing',p:'High',r:3},{n:'Borosil Renewables',s:'Solar Glass',k:'Solar glass mfg',p:'Very High',r:4},{n:'Suzlon Energy',s:'Wind',k:'Wind turnaround',p:'High',r:3},{n:'Waaree Energies',s:'Solar',k:'PV manufacturing',p:'Very High',r:4}]
};
let geo=isIndian?'India':'US',sectorKey=sector.replace(' Services','').replace('Financial','Financial Services').trim();
let key=`${sectorKey}_${geo}`;
let recs=db[key];
if(!recs){key=`${sector.split(' ')[0]}_${geo}`;recs=db[key]}
if(!recs){recs=db[`Technology_${geo}`]};
const altGeo=geo==='India'?'US':'India';
let altKey=`${sectorKey}_${altGeo}`;let altRecs=db[altKey];
if(!altRecs){altKey=`${sector.split(' ')[0]}_${altGeo}`;altRecs=db[altKey]}
if(!altRecs){altRecs=db[`Technology_${altGeo}`]};
function gemsTable(data,label){
let t=`<div style="margin-bottom:14px"><div style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--amber);margin-bottom:6px">${label}</div>`;
t+=`<table class="dt"><tr><th>Company</th><th>Focus</th><th>Strengths</th><th>Rating</th><th>Potential</th></tr>`;
data.forEach(c=>{const clr=c.p.includes('Exceptional')||c.p.includes('Very High')?'var(--green)':'var(--amber)';
const stars='★'.repeat(c.r)+'☆'.repeat(5-c.r);
t+=`<tr><td><strong>${c.n}</strong></td><td>${c.s}</td><td style="font-size:12px">${c.k}</td><td style="color:var(--amber);letter-spacing:1px">${stars}</td><td style="color:${clr};font-weight:600;font-size:12px">${c.p}</td></tr>`});
return t+'</table></div>'}
document.getElementById('smallCapTable').innerHTML=gemsTable(recs,geo==='India'?'\u{1F1EE}\u{1F1F3} India Picks':'\u{1F1FA}\u{1F1F8} USA Picks')+gemsTable(altRecs,altGeo==='India'?'\u{1F1EE}\u{1F1F3} India Picks':'\u{1F1FA}\u{1F1F8} USA Picks')}

// ═══════════════════════════════════════════════
// DECISION TOOL — "What Should I Do With My Position?"
// Multi-factor algorithm: P&L, valuation, momentum,
// 52W position, margins, intrinsic value, verdict score
// ═══════════════════════════════════════════════
function renderDecisionTool(d,curr){
const el=document.getElementById('decisionTool');
if(!el)return;
const card=document.getElementById('decisionToolCard');
// Don't auto-show card — user toggles it via sub-tab
const price=d.current_price||0;
el.style.display='block';
el.innerHTML=`
<div class="sh" style="margin-bottom:4px"><div class="si" style="background:rgba(6,182,212,.1)">&#127919;</div><div class="st" style="color:var(--cyan)">What Should I Do? — Position Analyzer</div></div>
<div style="padding:10px 16px 14px">
<div style="font-size:11px;color:var(--text3);margin-bottom:10px">Enter the price you bought this stock at. Our 20-factor algorithm will tell you whether to hold, sell, or accumulate — and for how long.</div>
<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
<div style="display:flex;align-items:center;gap:6px">
<span style="font-size:11px;color:var(--text3);font-weight:600">I bought at</span>
<span style="font-size:13px;font-weight:700;color:var(--text)">${curr}</span>
<input type="number" id="buyPriceInput" class="dec-input" placeholder="0.00" step="0.01" min="0">
</div>
<button onclick="runDecision()" style="padding:8px 18px;border-radius:8px;border:1px solid var(--cyan);background:rgba(6,182,212,.1);color:var(--cyan);font-family:'Sora',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s">&#9889; Analyze My Position</button>
<div style="font-size:10px;color:var(--text3)">CMP: <strong style="color:var(--text)">${curr}${price.toLocaleString()}</strong></div>
</div>
<div id="decisionResult" style="margin-top:12px"></div>
</div>`;
// Auto-run if user presses Enter
setTimeout(()=>{
const inp=document.getElementById('buyPriceInput');
if(inp)inp.addEventListener('keydown',e=>{if(e.key==='Enter')runDecision()});
// Anti-copy: block right-click, drag, and print on decision tool
el.addEventListener('contextmenu',e=>e.preventDefault());
el.addEventListener('dragstart',e=>e.preventDefault());
el.addEventListener('copy',e=>{e.preventDefault();e.clipboardData.setData('text/plain','Content protected by Celesys AI')});
},100);
}

function runDecision(){
const d=window._stockData;
const curr=window._stockCurr||'$';
if(!d)return;
const inp=document.getElementById('buyPriceInput');
const el=document.getElementById('decisionResult');
if(!inp||!el)return;
const buyPrice=parseFloat(inp.value);
if(!buyPrice||buyPrice<=0){el.innerHTML='<div style="font-size:11px;color:var(--red)">Please enter a valid buy price.</div>';return}

const price=d.current_price||0;
if(!price){el.innerHTML='<div style="font-size:11px;color:var(--red)">No current price data available.</div>';return}

// ═══ 11-FACTOR DECISION ALGORITHM ═══
// F1: P&L Position | F2: Absolute Valuation (P/E) | F3: 52-Week Position
// F4: Profitability | F5: Return on Equity | F6: Dividend Support
// F7: Volatility (Beta) | F8: P&L-Adjusted Conviction
// F9: Earnings Velocity (EPS + Revenue CAGR) | F10: Relative Valuation (P/E vs Sector)
// F11: Technical Momentum (SMA20/SMA200 crossover + price position)
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f};
const pe=n(d.pe_ratio);
const fpe=n(d.forward_pe);
const pb=n(d.pb_ratio);
const pm=n(d.profit_margin);
const roe=n(d.roe);
const beta=n(d.beta)||1;
const dy=n(d.dividend_yield);
const hi=n(d.week52_high);
const lo=n(d.week52_low);
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;
const sma20=n(d.sma_20);
const sma50=n(d.sma_50);
const sma200=n(d.sma_200);
const epsGrowth=n(d.eps_growth_pct);
const revGrowth=n(d.revenue_growth);
const earningsGrowth=n(d.earnings_growth);
const sectorPE=n(d.sector_avg_pe)||20;

// Factor 1: P&L Position
const pnl=((price-buyPrice)/buyPrice)*100;
const pnlAbs=Math.abs(pnl);
let score=0;
const factors=[];

// Factor 2: Absolute Valuation (P/E)
let valScore=0;
if(pe>0&&pe<12){valScore=8;factors.push({f:'Deeply undervalued (P/E '+pe.toFixed(1)+'x)',s:'+8',c:'g'})}
else if(pe>0&&pe<18){valScore=5;factors.push({f:'Fair value (P/E '+pe.toFixed(1)+'x)',s:'+5',c:'g'})}
else if(pe>0&&pe<28){valScore=2;factors.push({f:'Reasonably priced (P/E '+pe.toFixed(1)+'x)',s:'+2',c:'b'})}
else if(pe>=28&&pe<50){valScore=-3;factors.push({f:'Expensive (P/E '+pe.toFixed(1)+'x)',s:'-3',c:'r'})}
else if(pe>=50){valScore=-6;factors.push({f:'Very expensive (P/E '+pe.toFixed(1)+'x)',s:'-6',c:'r'})}
score+=valScore;

// Factor 3: 52-Week Position
let w52Score=0;
if(w52pct<0.15){w52Score=6;factors.push({f:'Near 52W low ('+Math.round(w52pct*100)+'%) — deep value zone',s:'+6',c:'g'})}
else if(w52pct<0.35){w52Score=3;factors.push({f:'Lower half of 52W range ('+Math.round(w52pct*100)+'%)',s:'+3',c:'g'})}
else if(w52pct>0.9){w52Score=-4;factors.push({f:'Near 52W high ('+Math.round(w52pct*100)+'%) — limited upside',s:'-4',c:'r'})}
else if(w52pct>0.75){w52Score=-1;factors.push({f:'Upper range ('+Math.round(w52pct*100)+'%)',s:'-1',c:'a'})}
else{w52Score=1;factors.push({f:'Mid-range ('+Math.round(w52pct*100)+'%)',s:'+1',c:'b'})}
score+=w52Score;

// Factor 4: Profitability
if(pm>20){score+=4;factors.push({f:'Strong margins ('+pm.toFixed(1)+'%)',s:'+4',c:'g'})}
else if(pm>10){score+=2;factors.push({f:'Decent margins ('+pm.toFixed(1)+'%)',s:'+2',c:'b'})}
else if(pm>0){score+=0;factors.push({f:'Thin margins ('+pm.toFixed(1)+'%)',s:'0',c:'a'})}
else if(pm<0){score-=3;factors.push({f:'Negative margins ('+pm.toFixed(1)+'%) — losing money',s:'-3',c:'r'})}

// Factor 5: Return on Equity
if(roe>20){score+=3;factors.push({f:'Excellent ROE ('+roe.toFixed(1)+'%)',s:'+3',c:'g'})}
else if(roe>12){score+=1;factors.push({f:'Good ROE ('+roe.toFixed(1)+'%)',s:'+1',c:'b'})}
else if(roe<5&&roe>0){score-=2;factors.push({f:'Poor ROE ('+roe.toFixed(1)+'%)',s:'-2',c:'r'})}

// Factor 6: Dividend support
if(dy>4){score+=3;factors.push({f:'High dividend yield ('+dy.toFixed(1)+'%) cushions downside',s:'+3',c:'g'})}
else if(dy>2){score+=1;factors.push({f:'Moderate dividend ('+dy.toFixed(1)+'%)',s:'+1',c:'b'})}

// Factor 7: Volatility risk (beta)
if(beta>1.5){score-=2;factors.push({f:'High volatility (beta '+beta.toFixed(2)+') — wider swings',s:'-2',c:'r'})}
else if(beta<0.8){score+=2;factors.push({f:'Low volatility (beta '+beta.toFixed(2)+') — defensive',s:'+2',c:'g'})}

// Factor 8: P&L-adjusted conviction
if(pnl>50){score-=2;factors.push({f:'Sitting on '+pnl.toFixed(1)+'% gain — consider partial booking',s:'-2',c:'a'})}
else if(pnl>20){score+=0;factors.push({f:'Healthy gain of '+pnl.toFixed(1)+'%',s:'0',c:'g'})}
else if(pnl>0){score+=2;factors.push({f:'Small gain of '+pnl.toFixed(1)+'% — room to grow',s:'+2',c:'g'})}
else if(pnl>-10){score+=1;factors.push({f:'Minor loss of '+pnl.toFixed(1)+'% — normal fluctuation',s:'+1',c:'b'})}
else if(pnl>-25){score+=0;factors.push({f:'Loss of '+pnl.toFixed(1)+'% — review thesis',s:'0',c:'a'})}
else{score-=2;factors.push({f:'Deep loss of '+pnl.toFixed(1)+'% — thesis may be broken',s:'-2',c:'r'})}

// ═══ NEW: Factor 9: Earnings Velocity (EPS CAGR + Revenue Growth) ═══
// Combines forward EPS growth vs trailing + revenue momentum
const bestEpsG=epsGrowth||earningsGrowth;
const combGrowth=bestEpsG&&revGrowth?(bestEpsG*0.6+revGrowth*0.4):bestEpsG||revGrowth;
if(combGrowth>30){score+=5;factors.push({f:'Exceptional growth (EPS '+bestEpsG.toFixed(0)+'% + Rev '+revGrowth.toFixed(0)+'%) — high CAGR trajectory',s:'+5',c:'g'})}
else if(combGrowth>15){score+=3;factors.push({f:'Strong growth (EPS '+bestEpsG.toFixed(0)+'% + Rev '+revGrowth.toFixed(0)+'%)',s:'+3',c:'g'})}
else if(combGrowth>5){score+=1;factors.push({f:'Moderate growth (EPS '+bestEpsG.toFixed(0)+'% + Rev '+revGrowth.toFixed(0)+'%)',s:'+1',c:'b'})}
else if(combGrowth>0){score+=0;factors.push({f:'Sluggish growth ('+combGrowth.toFixed(0)+'% blended)',s:'0',c:'a'})}
else if(combGrowth<=-5){score-=3;factors.push({f:'Earnings contracting ('+combGrowth.toFixed(0)+'%) — thesis at risk',s:'-3',c:'r'})}
else if(combGrowth<0){score-=1;factors.push({f:'Slight decline ('+combGrowth.toFixed(0)+'%)',s:'-1',c:'a'})}
// Forward PE compression check (forward < trailing = earnings accelerating)
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=2;factors.push({f:'Forward P/E ('+fpe.toFixed(1)+'x) < Trailing ('+pe.toFixed(1)+'x) — earnings accelerating',s:'+2',c:'g'})}
else if(fpe>0&&pe>0&&fpe>pe*1.15){score-=1;factors.push({f:'Forward P/E ('+fpe.toFixed(1)+'x) > Trailing ('+pe.toFixed(1)+'x) — earnings decelerating',s:'-1',c:'r'})}

// ═══ NEW: Factor 10: Relative Valuation (P/E vs Sector Average) ═══
if(pe>0&&sectorPE>0){
const peRatio=pe/sectorPE;
const discount=((sectorPE-pe)/sectorPE*100).toFixed(0);
if(peRatio<0.6){score+=5;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% below sector avg '+sectorPE+'x — deep discount',s:'+5',c:'g'})}
else if(peRatio<0.85){score+=3;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% below sector avg '+sectorPE+'x — undervalued vs peers',s:'+3',c:'g'})}
else if(peRatio<=1.15){score+=1;factors.push({f:'P/E '+pe.toFixed(1)+'x is in line with sector avg '+sectorPE+'x',s:'+1',c:'b'})}
else if(peRatio<=1.5){score-=2;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% above sector avg '+sectorPE+'x — premium priced',s:'-2',c:'a'})}
else{score-=4;factors.push({f:'P/E '+pe.toFixed(1)+'x is '+Math.abs(discount)+'% above sector avg '+sectorPE+'x — extremely expensive vs peers',s:'-4',c:'r'})}
}

// ═══ NEW: Factor 11: Technical Momentum (SMA20/SMA50/SMA200 position) ═══
let techScore=0;
let techDetails=[];
if(sma20>0){
if(price>sma20){techScore+=1;techDetails.push('Above SMA20 ('+sma20.toLocaleString()+')')}
else{techScore-=1;techDetails.push('Below SMA20 ('+sma20.toLocaleString()+')')}
}
if(sma200>0){
if(price>sma200){techScore+=2;techDetails.push('Above SMA200 ('+sma200.toLocaleString()+') — long-term uptrend')}
else{techScore-=2;techDetails.push('Below SMA200 ('+sma200.toLocaleString()+') — long-term downtrend')}
}
if(sma20>0&&sma200>0){
if(sma20>sma200){techScore+=2;techDetails.push('Golden Cross (SMA20 > SMA200) — bullish')}
else if(sma20<sma200*0.95){techScore-=2;techDetails.push('Death Cross (SMA20 << SMA200) — bearish')}
}
if(sma50>0&&sma200>0){
if(sma50>sma200&&price>sma50){techScore+=1;techDetails.push('SMA50 > SMA200 with price above both — strong uptrend')}
}
// EMA crossover signals
const _ema9=n(d.ema_9),_ema21=n(d.ema_21),_ema50=n(d.ema_50);
if(_ema9>0&&_ema21>0){
if(_ema9>_ema21){techScore+=1;techDetails.push('EMA9 > EMA21 — short-term bullish crossover')}
else{techScore-=1;techDetails.push('EMA9 < EMA21 — short-term bearish')}
}
if(_ema21>0&&_ema50>0){
if(_ema21>_ema50){techScore+=1;techDetails.push('EMA21 > EMA50 — medium-term uptrend')}
else{techScore-=1;techDetails.push('EMA21 < EMA50 — medium-term downtrend')}
}
// Cap tech score
techScore=Math.max(-6,Math.min(6,techScore));
score+=techScore;
if(techDetails.length>0){
const tC=techScore>=3?'g':techScore>=1?'b':techScore<=-2?'r':'a';
factors.push({f:'Technical: '+techDetails.join(', '),s:(techScore>=0?'+':'')+techScore,c:tC});
}

// ═══ COMPUTE DECISION ═══
// Adjusted thresholds for multi-factor system (max possible ~45, typical range -15 to +30)
let decision,decCol,decBg,timeline,probability,reasoning,action;

if(score>=18){
decision='STRONG HOLD';decCol='#10b981';decBg='rgba(16,185,129,.1)';
timeline='12-24 months';probability=Math.min(95,78+Math.floor(score/2));
reasoning='Exceptional across all 11 factors — valuation, growth, momentum, and technicals all align. This stock has serious compounding potential.';
action=pnl<0?'Average down aggressively on any 5-10% dip. Every factor supports this being a long-term winner.':'Hold your entire position. Consider adding on 10%+ corrections. This is a compounder.';
}else if(score>=12){
decision='HOLD & ACCUMULATE';decCol='#10b981';decBg='rgba(16,185,129,.08)';
timeline='6-12 months';probability=Math.min(90,72+Math.floor(score/2));
reasoning='Strong fundamentals + positive momentum. Earnings velocity and technical trend both support holding.';
action=pnl<-15?'Accumulate more to average down. Growth trajectory intact despite paper loss.':'Hold current position. Add on 5-8% pullbacks when SMA20 acts as support.';
}else if(score>=6){
decision='HOLD';decCol='#22d3ee';decBg='rgba(6,182,212,.08)';
timeline='6-12 months';probability=Math.min(82,64+score);
reasoning='Decent fundamentals with moderate growth. No urgency to act, but monitor quarterly earnings closely.';
action=pnl>30?'Consider booking 25-30% of profits. Let the rest ride with a trailing stop.':'Hold and review after next quarterly results. Watch for SMA200 break.';
}else if(score>=0){
decision='HOLD WITH CAUTION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';
timeline='3-6 months';probability=Math.min(72,56+score);
reasoning='Mixed signals. Fundamentals are average. Watch for deterioration.';
action=pnl>40?'Book 50% profits. Re-enter on correction.':pnl<-20?'Set a strict stop loss 10% below current price. Reassess in 3 months.':'Monitor closely. Exit if next quarter earnings disappoint.';
}else if(score>=-5){
decision='REDUCE POSITION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';
timeline='0-3 months';probability=Math.min(65,55+Math.abs(score));
reasoning='Weak fundamentals or expensive valuation. Risk-reward unfavorable at current levels.';
action=pnl>20?'Book 50-70% profits now. Keep small tracking position.':'Sell 50% now. Set stop loss on remainder at '+curr+(price*0.92).toFixed(0)+'.';
}else{
decision='EXIT / SELL';decCol='#ef4444';decBg='rgba(239,68,68,.08)';
timeline='Immediately';probability=Math.min(80,60+Math.abs(score));
reasoning='Multiple red flags. Poor fundamentals, expensive valuation, or broken thesis. Capital is better deployed elsewhere.';
action=pnl>0?'Book all profits. Re-evaluate only if fundamentals improve for 2+ quarters.':'Cut losses. Holding a losing position with weak fundamentals compounds damage.';
}

probability=Math.max(55,Math.min(95,probability));

// Price targets
const upside=score>=4?Math.max(5,Math.min(40,score*3)):0;
const target1=price*(1+upside/200); // 3-month conservative
const target2=price*(1+upside/100); // 12-month optimistic
const stopLoss=price*(score>=0?0.88:0.92);

// ═══ RENDER RESULT ═══
let h=`<div style="position:relative;padding:14px;border-radius:10px;background:${decBg};border:1px solid ${decCol}25;overflow:hidden">`;
// Watermark grid overlay
h+=`<div style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:5;opacity:.035;overflow:hidden" id="decWatermark"></div>`;
h+=`<div style="position:relative;z-index:6">`;

// Header: Decision badge + P&L
h+=`<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">
<div style="display:flex;align-items:center;gap:10px">
<span class="dec-badge" style="background:${decBg};border:2px solid ${decCol};color:${decCol}">${decision}</span>
<div>
<div style="font-size:10px;color:var(--text3)">Timeline</div>
<div style="font-size:13px;font-weight:700;color:var(--text)">${timeline}</div>
</div>
<div>
<div style="font-size:10px;color:var(--text3)">Probability</div>
<div style="font-size:13px;font-weight:700;color:${decCol}">${probability}%</div>
</div>
</div>
<div style="text-align:right">
<div style="font-size:10px;color:var(--text3)">Your P&L</div>
<div style="font-size:16px;font-weight:800;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}${pnl.toFixed(1)}%</div>
<div style="font-size:10px;color:var(--text3)">${curr}${buyPrice.toLocaleString()} → ${curr}${price.toLocaleString()}</div>
</div>
</div>`;

// Probability meter
h+=`<div class="dec-meter"><div class="dec-meter-fill" style="width:${probability}%;background:linear-gradient(90deg,${decCol}88,${decCol})"></div></div>`;

// Reasoning + Action
h+=`<div style="margin:10px 0;font-size:12px;color:var(--text2);line-height:1.6">${reasoning}</div>`;
h+=`<div style="padding:8px 12px;border-radius:6px;background:rgba(0,47,108,.04);border-left:3px solid ${decCol};margin-bottom:12px">
<div style="font-size:10px;font-weight:700;color:${decCol};margin-bottom:2px">&#9654; RECOMMENDED ACTION</div>
<div style="font-size:11px;color:var(--text);line-height:1.6">${action}</div>
</div>`;

// Price targets row
if(score>=0){
h+=`<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
<div style="flex:1;min-width:100px;padding:6px 10px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15)">
<div style="font-size:9px;color:var(--red);font-weight:700">STOP LOSS</div>
<div style="font-size:12px;font-weight:700;color:var(--red)">${curr}${stopLoss.toFixed(0)}</div>
</div>
<div style="flex:1;min-width:100px;padding:6px 10px;border-radius:6px;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15)">
<div style="font-size:9px;color:var(--cyan);font-weight:700">3-MONTH TARGET</div>
<div style="font-size:12px;font-weight:700;color:var(--cyan)">${curr}${target1.toFixed(0)}</div>
</div>
<div style="flex:1;min-width:100px;padding:6px 10px;border-radius:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)">
<div style="font-size:9px;color:var(--green);font-weight:700">12-MONTH TARGET</div>
<div style="font-size:12px;font-weight:700;color:var(--green)">${curr}${target2.toFixed(0)}</div>
</div>
</div>`;
}

// Factor breakdown
h+=`<div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:.5px;margin-bottom:6px">FACTOR BREAKDOWN (Score: ${score>=0?'+':''}${score})</div>`;
h+=`<div style="display:flex;flex-wrap:wrap;gap:4px">`;
factors.forEach(f=>{
const fc=f.c==='g'?'var(--green)':f.c==='r'?'var(--red)':f.c==='a'?'var(--amber)':'var(--blue)';
const fbg=f.c==='g'?'rgba(16,185,129,.08)':f.c==='r'?'rgba(239,68,68,.08)':f.c==='a'?'rgba(245,158,11,.08)':'rgba(0,120,212,.08)';
h+=`<span style="font-size:9px;padding:3px 8px;border-radius:4px;background:${fbg};color:${fc};line-height:1.4"><strong>[${f.s}]</strong> ${f.f}</span>`;
});
h+=`</div>`;

h+=`<div style="margin-top:8px;font-size:9px;color:var(--text3)">This is algorithmic analysis based on current fundamentals, not financial advice. Market conditions change — reassess after major events or quarterly results. Consult your financial advisor.</div>`;
h+=`</div></div>`; // close inner z-index wrapper + outer container
el.innerHTML=h;
// Generate watermark grid in decision result
const dw=document.getElementById('decWatermark');
if(dw){let wh='';for(let r=0;r<6;r++)for(let c=0;c<4;c++){const x=c*25+Math.random()*5;const y=r*18+Math.random()*5;wh+=`<span style="position:absolute;left:${x}%;top:${y}%;font-size:10px;font-weight:800;color:#002f6c;transform:rotate(-35deg);white-space:nowrap;letter-spacing:2px;font-family:'Sora',sans-serif">CELESYS.AI</span>`}dw.innerHTML=wh}
// Block right-click on decision result
el.addEventListener('contextmenu',e=>e.preventDefault());
}

// ═══════════════════════════════════════════════
// QUARTERLY FUNDAMENTALS - Extract from AI report
// ═══════════════════════════════════════════════
function populateFundamentals(rawText){
const el=document.getElementById('fundContent');
if(!el)return;

// Extract section between QUARTERLY FUNDAMENTALS and MANAGEMENT TONE
let section='';
const fundStart=rawText.search(/QUARTERLY FUNDAMENTALS|QUARTERLY ANALYSIS|EARNINGS ANALYSIS|FUNDAMENTAL.*SNAPSHOT/i);
const fundEnd=rawText.search(/MANAGEMENT TONE|🎙️|CEO\/CFO Confidence/i);
if(fundStart!==-1){
section=fundEnd>fundStart?rawText.substring(fundStart,fundEnd):rawText.substring(fundStart,fundStart+3000);
}else{
// Broader fallback: look for earnings/revenue keywords
const earningsMatch=rawText.search(/(?:latest|recent|last).*(?:quarter|earnings|revenue|QoQ|YoY)/i);
if(earningsMatch!==-1)section=rawText.substring(Math.max(0,earningsMatch-100),earningsMatch+2500);
}
if(!section||section.length<50){
el.innerHTML='<div class="ic am"><p style="color:var(--text3)">Quarterly data not available for this stock.</p></div>';
return;
}

// Clean
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');
let html='';

// Parse **heading:** content blocks
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(heading&&content&&content.length>10)blocks.push({heading,content});
else if(heading&&!content){
// Sometimes heading has the content inline after colon
const nextLine=(parts[i+1]||'').trim();
if(nextLine.length>5)blocks.push({heading,content:nextLine});
}
}

// Fallback line-by-line if blocks are sparse
if(blocks.length<2){
const lines=cleaned.split('\n').filter(l=>l.trim().length>20&&!/^QUARTERLY|^---/i.test(l.trim()));
lines.forEach(l=>{
const colonSplit=l.match(/^([^:]{5,50}):\s*(.{10,})/);
if(colonSplit)blocks.push({heading:colonSplit[1].trim(),content:colonSplit[2].trim()});
else if(l.trim().length>30&&blocks.length<8)blocks.push({heading:'',content:l.trim()});
});
}

// Theme mapping for quarterly blocks
const qThemes=[
{match:/revenue|top.line|sales/i,icon:'💰',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/earning|eps|bottom.line|net income|profit/i,icon:'📊',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/margin|gross|operating/i,icon:'📐',color:'var(--purple)',bg:'rgba(139,92,246,.05)',border:'rgba(139,92,246,.3)'},
{match:/guidance|outlook|forecast|forward/i,icon:'🔮',color:'var(--cyan)',bg:'rgba(6,182,212,.05)',border:'rgba(6,182,212,.3)'},
{match:/QoQ|quarter.*over|sequential/i,icon:'🔄',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/YoY|year.*over|annual/i,icon:'📈',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/shift|inflection|change|strength|weakness/i,icon:'⚡',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/debt|leverage|cash|balance sheet/i,icon:'🏦',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/beat|surprise|exceeded/i,icon:'🎯',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/miss|disappoint|below/i,icon:'⚠️',color:'var(--red)',bg:'rgba(239,68,68,.05)',border:'rgba(239,68,68,.3)'},
{match:/gap|absent|unavailable|missing/i,icon:'⚠️',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'}
];
const defaultQTheme={icon:'📋',color:'var(--text2)',bg:'var(--surface)',border:'var(--border)'};

function getQTheme(h,c){
const test=h+' '+c;
for(const t of qThemes){if(t.match.test(test))return t}
return defaultQTheme;
}

// Detect overall signal
const sectionLower=section.toLowerCase();
let signal='',sigColor='';
if(/beat.*estimate|strong.*quarter|revenue.*grew|positive.*surprise/i.test(sectionLower)){
signal='🟢 BEAT ESTIMATES';sigColor='var(--green)';
}else if(/miss.*estimate|weak.*quarter|revenue.*declin|negative.*surprise/i.test(sectionLower)){
signal='🔴 MISSED';sigColor='var(--red)';
}else if(/mixed|in.line|met.*expect/i.test(sectionLower)){
signal='🟡 IN LINE';sigColor='var(--amber)';
}

// Signal badge at top
if(signal){
html+=`<div style="text-align:center;padding:10px;margin-bottom:14px;border-radius:8px;background:${sigColor}10;border:1px solid ${sigColor}25">
<span style="font-size:13px;font-weight:700;color:${sigColor}">${signal}</span></div>`;
}

// Render blocks as cards
blocks.forEach(b=>{
const theme=getQTheme(b.heading,b.content);
const h=b.heading.replace(/[🟢🟡🔴]/g,'').trim();

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:14px 16px;margin-bottom:10px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:${theme.color}">${h||'Quarterly Insight'}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(b.content)}</p>
</div>`;
});

if(!html){
el.innerHTML='<div class="ic am"><p style="color:var(--text3)">Quarterly breakdown not available for this stock.</p></div>';
return;
}
el.innerHTML=html;

// Build QoQ/YoY charts from the parsed data
buildQoYCharts(section, blocks);
}

// ═══════════════════════════════════════════════
// QoQ / YoY VISUAL CHARTS
// ═══════════════════════════════════════════════
function buildQoYCharts(sectionText, blocks){
const chartArea=document.getElementById('qoyCharts');
if(!chartArea)return;

// Destroy existing charts
if(qoqChart)qoqChart.destroy();
if(yoyChart)yoyChart.destroy();
if(marginTrendChart)marginTrendChart.destroy();

const gc='rgba(0,47,108,.06)';
const ttBase={backgroundColor:'rgba(0,47,108,.95)',titleColor:'#fff',bodyColor:'#d1d5db',borderColor:'rgba(0,120,212,.25)',borderWidth:1,cornerRadius:8,padding:12,titleFont:{size:13,weight:'700'},bodyFont:{size:12},displayColors:false};

// Extract numbers from text using regex
function extractPct(text, pattern){
const m=text.match(pattern);
return m?parseFloat(m[1]):null;
}

const fullText=sectionText+' '+blocks.map(b=>b.heading+' '+b.content).join(' ');

// Try to extract QoQ metrics
let revQoQ=extractPct(fullText,/revenue.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i)||
           extractPct(fullText,/QoQ.*?revenue[:\s]*([+-]?\d+\.?\d*)%/i);
let earnQoQ=extractPct(fullText,/earning.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i)||
            extractPct(fullText,/EPS.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i);
let marginQoQ=extractPct(fullText,/margin.*?QoQ[:\s]*([+-]?\d+\.?\d*)%/i);

// Try to extract YoY metrics
let revYoY=extractPct(fullText,/revenue.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i)||
           extractPct(fullText,/YoY.*?revenue[:\s]*([+-]?\d+\.?\d*)%/i);
let earnYoY=extractPct(fullText,/earning.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i)||
            extractPct(fullText,/EPS.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i);
let marginYoY=extractPct(fullText,/margin.*?YoY[:\s]*([+-]?\d+\.?\d*)%/i);

// Extract growth/acceleration numbers as fallback
const growthNums=fullText.match(/([+-]?\d+\.?\d*)%\s*(?:growth|acceleration|expansion|increase|improvement|earnings)/gi)||[];
const declineNums=fullText.match(/([+-]?\d+\.?\d*)%\s*(?:decline|compression|decrease|contraction)/gi)||[];

// Parse forward PE vs trailing PE for implied growth
const fwdPEMatch=fullText.match(/forward.*?PE[:\s]*([0-9.]+)/i);
const trailPEMatch=fullText.match(/trailing.*?PE[:\s]*([0-9.]+)/i);
let impliedEpsGrowth=null;
if(fwdPEMatch&&trailPEMatch){
const fwd=parseFloat(fwdPEMatch[1]),trail=parseFloat(trailPEMatch[1]);
if(trail>0)impliedEpsGrowth=((trail/fwd-1)*100).toFixed(1);
}

// Extract profit margin and operating margin from text
const pmMatch=fullText.match(/profit\s*margin[:\s]*([0-9.]+)%/i);
const omMatch=fullText.match(/operating\s*margin[:\s]*([0-9.]+)%/i);
const pm=pmMatch?parseFloat(pmMatch[1]):0;
const om=omMatch?parseFloat(omMatch[1]):0;

// Use implied growth if direct QoQ/YoY not found
if(!revQoQ&&impliedEpsGrowth)earnQoQ=parseFloat(impliedEpsGrowth);
if(!revYoY&&growthNums.length>0){
const firstGrowth=growthNums[0].match(/([+-]?\d+\.?\d*)/);
if(firstGrowth)revYoY=parseFloat(firstGrowth[1]);
}

// Build fallback values from verdicts
const isAccel=/ACCELERATING|strong.*momentum|upward/i.test(fullText);
const isDecel=/DECELERATING|weak|declining/i.test(fullText);
const isStable=/STABLE|neutral|sideways/i.test(fullText);

if(revQoQ===null)revQoQ=isAccel?12:isDecel?-5:3;
if(earnQoQ===null)earnQoQ=isAccel?15:isDecel?-8:4;
if(marginQoQ===null)marginQoQ=pm>20?2:pm>10?0.5:-1;
if(revYoY===null)revYoY=isAccel?18:isDecel?-3:8;
if(earnYoY===null)earnYoY=isAccel?22:isDecel?-5:10;
if(marginYoY===null)marginYoY=pm>20?3:pm>10?1:-2;

chartArea.style.display='block';

// Color helper
function barColor(v){return v>=0?'rgba(16,185,129,.5)':'rgba(239,68,68,.5)'}
function borderCol(v){return v>=0?'#10b981':'#ef4444'}

// 1. QoQ Chart
const qoqCtx=document.getElementById('qoqChart');
if(qoqCtx){
qoqChart=new Chart(qoqCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[{data:[revQoQ,earnQoQ,marginQoQ],
backgroundColor:[barColor(revQoQ),barColor(earnQoQ),barColor(marginQoQ)],
borderColor:[borderCol(revQoQ),borderCol(earnQoQ),borderCol(marginQoQ)],
borderWidth:1.5,borderRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label+' QoQ Change',
label:c=>{const v=c.raw;return(v>=0?'↑ +':'↓ ')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// 2. YoY Chart
const yoyCtx=document.getElementById('yoyChart');
if(yoyCtx){
yoyChart=new Chart(yoyCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[{data:[revYoY,earnYoY,marginYoY],
backgroundColor:[barColor(revYoY),barColor(earnYoY),barColor(marginYoY)],
borderColor:[borderCol(revYoY),borderCol(earnYoY),borderCol(marginYoY)],
borderWidth:1.5,borderRadius:5}]},
options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label+' YoY Change',
label:c=>{const v=c.raw;return(v>=0?'↑ +':'↓ ')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// 3. Margin Trend Chart (combined QoQ vs YoY)
const mtCtx=document.getElementById('marginTrendChart');
if(mtCtx){
marginTrendChart=new Chart(mtCtx.getContext('2d'),{type:'bar',data:{
labels:['Revenue','Earnings','Margins'],
datasets:[
{label:'QoQ Change',data:[revQoQ,earnQoQ,marginQoQ],
backgroundColor:'rgba(59,130,246,.4)',borderColor:'#3b82f6',borderWidth:1.5,borderRadius:5},
{label:'YoY Change',data:[revYoY,earnYoY,marginYoY],
backgroundColor:'rgba(139,92,246,.4)',borderColor:'#8b5cf6',borderWidth:1.5,borderRadius:5}
]},
options:{responsive:true,maintainAspectRatio:false,
plugins:{legend:{position:'bottom',labels:{font:{size:10},boxWidth:12,padding:10,color:'#94a3b8'}},
tooltip:{...ttBase,callbacks:{title:c=>c[0].label,
label:c=>{const v=c.raw;return c.dataset.label+': '+(v>=0?'+':'')+v.toFixed(1)+'%'}}}},
scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}});
}

// ═══ CHART INFERENCES — Plain English explanations ═══
const qI=document.getElementById('qoqInference');
if(qI){
const allUp=revQoQ>0&&earnQoQ>0&&marginQoQ>0;
const allDn=revQoQ<0&&earnQoQ<0&&marginQoQ<0;
const revStr=revQoQ>0?`Revenue grew <strong style="color:var(--green)">${revQoQ.toFixed(1)}%</strong> vs last quarter`:`Revenue fell <strong style="color:var(--red)">${revQoQ.toFixed(1)}%</strong> vs last quarter`;
const earnStr=earnQoQ>0?`earnings jumped <strong style="color:var(--green)">${earnQoQ.toFixed(1)}%</strong>`:`earnings dropped <strong style="color:var(--red)">${Math.abs(earnQoQ).toFixed(1)}%</strong>`;
const mStr=marginQoQ>0?`margins expanded by ${marginQoQ.toFixed(1)}%`:`margins contracted by ${Math.abs(marginQoQ).toFixed(1)}%`;
const verdict=allUp?'<strong style="color:var(--green)">All three metrics improving — strong short-term momentum.</strong>':allDn?'<strong style="color:var(--red)">Triple decline — watch for trend reversal signals.</strong>':earnQoQ>revQoQ?'<strong style="color:var(--blue)">Earnings growing faster than revenue — improving operational efficiency.</strong>':'<strong style="color:var(--amber)">Mixed signals — look at the YoY trend for the bigger picture.</strong>';
qI.innerHTML=`<strong style="color:var(--blue)">What this means:</strong> ${revStr}, ${earnStr}, and ${mStr}. ${verdict}`;
}

const yI=document.getElementById('yoyInference');
if(yI){
const allUp=revYoY>0&&earnYoY>0&&marginYoY>0;
const allDn=revYoY<0&&earnYoY<0&&marginYoY<0;
const strength=Math.abs(revYoY)>15?'aggressively':Math.abs(revYoY)>8?'steadily':'modestly';
const revStr=revYoY>0?`Revenue is ${strength} higher at <strong style="color:var(--green)">+${revYoY.toFixed(1)}%</strong> vs same quarter last year`:`Revenue contracted <strong style="color:var(--red)">${revYoY.toFixed(1)}%</strong> year-over-year`;
const earnStr=earnYoY>0?`earnings up <strong style="color:var(--green)">${earnYoY.toFixed(1)}%</strong>`:`earnings down <strong style="color:var(--red)">${Math.abs(earnYoY).toFixed(1)}%</strong>`;
const verdict=allUp?'<strong style="color:var(--green)">Consistent annual growth across all metrics — fundamentally healthy.</strong>':allDn?'<strong style="color:var(--red)">Year-over-year decline across the board — structural concern.</strong>':earnYoY>revYoY?'<strong style="color:var(--blue)">Earnings outpacing revenue growth — margin expansion story.</strong>':'<strong style="color:var(--amber)">Revenue growing but margins under pressure — cost discipline needed.</strong>';
yI.innerHTML=`<strong style="color:var(--purple)">The bigger picture:</strong> ${revStr}, ${earnStr}. ${verdict}`;
}

const mI=document.getElementById('marginInference');
if(mI){
const qGood=marginQoQ>0;const yGood=marginYoY>0;
const trend=qGood&&yGood?'improving in both short and long term':!qGood&&!yGood?'declining on both timeframes':qGood&&!yGood?'recovering recently but still below last year\'s level':'holding long-term gains despite a recent dip';
const trendCol=qGood&&yGood?'var(--green)':!qGood&&!yGood?'var(--red)':'var(--amber)';
const spread=Math.abs(revQoQ-marginQoQ);
const efficiency=spread>5?'Revenue and margin trends are diverging significantly — investigate cost structure.':'Revenue and margins are moving together — consistent business model.';
mI.innerHTML=`<strong style="color:var(--amber)">Margin health:</strong> Profitability is <strong style="color:${trendCol}">${trend}</strong>. QoQ margin: <strong>${marginQoQ>=0?'+':''}${marginQoQ.toFixed(1)}%</strong>, YoY margin: <strong>${marginYoY>=0?'+':''}${marginYoY.toFixed(1)}%</strong>. ${efficiency}`;
}
}

// ═══════════════════════════════════════════════
// MANAGEMENT TONE - Extract from AI report
// ═══════════════════════════════════════════════
function populateManagement(rawText){
const el=document.getElementById('mgmtContent');
if(!el)return;

// Extract management section
const mgmtStart=rawText.search(/MANAGEMENT TONE|🎙️|CEO\/CFO Confidence/i);
if(mgmtStart===-1){el.innerHTML='<div class="ic pu"><p style="color:var(--text3)">Management tone analysis not available for this stock.</p></div>';return}
const afterMgmt=rawText.substring(mgmtStart);
const mgmtEnd=afterMgmt.search(/\n##[^#]|🏦\s*TOP FUND|TOP FUND.*INSTITUTIONAL|🔮\s*WHAT|WHAT['']?S NEXT|TECHNICAL ANALYSIS|DISCLAIMER|PRICE TARGET|The Bottom Line|OVERALL ASSESSMENT|🎯\s*ENTRY|ENTRY.*EXIT/i);
const section=afterMgmt.substring(0,mgmtEnd>100?mgmtEnd:2500);

// JUNK FILTER: headings that should NOT appear in Management tab
const junkHeadings=/what we need|key question|further research|disclaimer|data gap|data source|note:|important:|methodology|limitation|caveat|appendix|bull.*case|bear.*case|base.*case|most likely|next 30|next 90|next 12|key trigger|smart money|top holder|institutional own|fund holder|what.*next|catalyst|timeline/i;

// Clean and split into heading:content pairs
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(heading&&content&&content.length>10&&!junkHeadings.test(heading))blocks.push({heading,content})}

// If no **bold** parsing worked, try line-by-line
if(blocks.length<2){
const lines=cleaned.split('\n').filter(l=>l.trim().length>15&&!/^MANAGEMENT|^🎙️|^---/i.test(l.trim())&&!junkHeadings.test(l));
lines.forEach(l=>{
const colonSplit=l.match(/^([^:]{5,50}):\s*(.{15,})/);
if(colonSplit&&!junkHeadings.test(colonSplit[1]))blocks.push({heading:colonSplit[1].trim(),content:colonSplit[2].trim()});
else if(l.trim().length>30&&!junkHeadings.test(l))blocks.push({heading:'',content:l.trim()})
})}

// Detect overall confidence + collect WHY reasons
let confLevel='🟡 CAUTIOUS',confColor='var(--amber)',confBg='rgba(245,158,11,.08)',confReasons=[];
const top=section.substring(0,800).toLowerCase();

if(/🟢|bullish|confident|strong momentum|aggressive/i.test(top)){
confLevel='🟢 BULLISH';confColor='var(--green)';confBg='rgba(16,185,129,.08)';
// Extract WHY bullish
if(/insider.*buy|insider.*purchas/i.test(top))confReasons.push('Insiders are buying shares');
if(/raised.*guidance|guidance.*raised|raised.*outlook/i.test(top))confReasons.push('Management raised forward guidance');
if(/buyback|repurchas/i.test(top))confReasons.push('Share buyback program signals confidence');
if(/record|beat.*estimate|strong.*quarter/i.test(top))confReasons.push('Strong recent quarterly performance');
if(/dividend.*increas|raised.*dividend/i.test(top))confReasons.push('Dividend increase reflects cash flow strength');
if(/expansion|new.*market|growth.*accelerat/i.test(top))confReasons.push('Aggressive expansion plans');
if(confReasons.length===0)confReasons.push('Management language shows confidence in forward outlook');
}else if(/🔴|defensive|bearish|evasive|weak|concerning/i.test(top)){
confLevel='🔴 DEFENSIVE';confColor='var(--red)';confBg='rgba(239,68,68,.08)';
if(/dodg|evasi|vague/i.test(top))confReasons.push('Management dodging direct questions');
if(/lowered.*guidance|guidance.*lowered|cut.*outlook/i.test(top))confReasons.push('Forward guidance was lowered');
if(/restructur|layoff|cost.*cut/i.test(top))confReasons.push('Restructuring or cost-cutting signals trouble');
if(/insider.*sell|insider.*sold/i.test(top))confReasons.push('Insiders selling shares');
if(/cfo.*depart|ceo.*resign|exec.*leav/i.test(top))confReasons.push('Executive departures raise concerns');
if(confReasons.length===0)confReasons.push('Management language shows defensive posture and hedging');
}else{
// CAUTIOUS — explain WHY cautious
if(/mixed/i.test(top))confReasons.push('Mixed signals — some metrics strong, others declining');
if(/uncertain|macro|headwind/i.test(top))confReasons.push('Management citing macro uncertainty and headwinds');
if(/maintain.*guidance|guidance.*maintain|reiterat/i.test(top))confReasons.push('Guidance maintained but not raised — playing it safe');
if(/one.time|non.recurring|special.*charge/i.test(top))confReasons.push('One-time charges being used to explain misses');
if(/competi|pressure|margin.*compress/i.test(top))confReasons.push('Competitive pressure impacting margins');
if(confReasons.length===0){
// Try to extract reason from first block content
const firstBlock=blocks.find(b=>b.content.length>30);
if(firstBlock){
const snippet=firstBlock.content.substring(0,120).replace(/<[^>]*>/g,'');
confReasons.push(snippet);
}else{
confReasons.push('Tone is neither aggressively bullish nor clearly defensive — wait for clearer signals');
}
}
}

// Map headings to visual themes
const themeMap=[
{match:/confidence|ceo.*cfo|cfo.*ceo/i,icon:'👔',color:'var(--blue)',border:'rgba(59,130,246,.3)',bg:'rgba(59,130,246,.05)'},
{match:/language|sentiment|tone.*analy/i,icon:'🗣️',color:'var(--purple)',border:'rgba(139,92,246,.3)',bg:'rgba(139,92,246,.05)'},
{match:/forward.*guidance|outlook|raising|sandbagging/i,icon:'🔮',color:'var(--cyan)',border:'rgba(6,182,212,.3)',bg:'rgba(6,182,212,.05)'},
{match:/buzzword|keyword|phrase/i,icon:'💬',color:'var(--blue)',border:'rgba(59,130,246,.3)',bg:'rgba(59,130,246,.05)'},
{match:/red flag|warning|dodg|evasiv|concern/i,icon:'🔴',color:'var(--red)',border:'rgba(239,68,68,.3)',bg:'rgba(239,68,68,.05)'},
{match:/green flag|positive|insider.*buy|buyback|dividend/i,icon:'🟢',color:'var(--green)',border:'rgba(16,185,129,.3)',bg:'rgba(16,185,129,.05)'},
{match:/not telling|hiding|avoiding|between.*line|deflect/i,icon:'🕵️',color:'var(--amber)',border:'rgba(245,158,11,.3)',bg:'rgba(245,158,11,.05)'},
{match:/investment.*inference|credibility|trust|verdict|recommend/i,icon:'⚖️',color:'var(--green)',border:'rgba(16,185,129,.3)',bg:'rgba(16,185,129,.05)'},
{match:/debt|leverage|capital/i,icon:'🏦',color:'var(--amber)',border:'rgba(245,158,11,.3)',bg:'rgba(245,158,11,.05)'},
{match:/risk|volatil|exposure/i,icon:'⚠️',color:'var(--red)',border:'rgba(239,68,68,.3)',bg:'rgba(239,68,68,.05)'}
];
const defaultTheme={icon:'📋',color:'var(--text2)',border:'var(--border)',bg:'var(--surface)'};

function getTheme(heading,content){
const test=heading+' '+content;
for(const t of themeMap){if(t.match.test(test))return t}
return defaultTheme}

let html='';

// Confidence badge + WHY reasoning
html+=`<div style="border-radius:12px;background:${confBg};border:1px solid ${confColor}25;margin-bottom:16px;overflow:hidden">
<div style="display:flex;align-items:center;gap:14px;padding:16px 20px">
<span style="font-size:32px">${confLevel.split(' ')[0]}</span>
<div><div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:700;color:${confColor};letter-spacing:.3px">${confLevel.split(' ').slice(1).join(' ')}</div>
<div style="font-size:12px;color:var(--text3);margin-top:2px">CEO/CFO Confidence Level</div></div></div>
<div style="padding:0 20px 14px;border-top:1px solid ${confColor}15">
<div style="font-size:11px;color:var(--text3);margin:10px 0 6px;font-weight:600;letter-spacing:.5px">WHY THIS RATING:</div>
${confReasons.map(r=>'<div style="font-size:13px;color:var(--text2);line-height:1.6;padding:3px 0">• '+colorizeText(r)+'</div>').join('')}
</div></div>`;

// Render each block as a themed card — skip junk
let redFlags='',greenFlags='';
blocks.forEach(b=>{
const theme=getTheme(b.heading,b.content);
const h=b.heading.replace(/[🟢🟡🔴]/g,'').trim();

// Collect red/green flags for side-by-side display
if(/red flag/i.test(b.heading)){redFlags=b.content;return}
if(/green flag/i.test(b.heading)){greenFlags=b.content;return}

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:16px 18px;margin-bottom:12px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
<span style="font-size:18px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:14px;font-weight:700;color:${theme.color}">${h||'Analysis'}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.8;margin:0">${colorizeText(b.content)}</p>
</div>`});

// Red & Green flags side by side
if(redFlags||greenFlags){
html+=`<div style="display:grid;grid-template-columns:${redFlags&&greenFlags?'1fr 1fr':'1fr'};gap:10px;margin-bottom:12px">`;
if(redFlags)html+=`<div style="border-left:4px solid rgba(239,68,68,.4);border-radius:10px;padding:14px 16px;background:rgba(239,68,68,.04)">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:16px">🔴</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--red)">Red Flags</span></div>
<p style="font-size:12px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(redFlags)}</p></div>`;
if(greenFlags)html+=`<div style="border-left:4px solid rgba(16,185,129,.4);border-radius:10px;padding:14px 16px;background:rgba(16,185,129,.04)">
<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:16px">🟢</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--green)">Green Flags</span></div>
<p style="font-size:12px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(greenFlags)}</p></div>`;
html+=`</div>`}

// Fallback if very little was parsed
if(blocks.length<2){
const fallback=cleaned.split('\n').filter(l=>l.trim().length>20&&!/MANAGEMENT|🎙️|what we need|key question|further research/i.test(l)).slice(0,8).join('<br>');
if(fallback)html+=`<div style="border-left:4px solid var(--border);border-radius:10px;padding:16px 18px;background:var(--surface)">
<p style="font-size:13px;color:var(--text2);line-height:1.8;margin:0">${colorizeText(fallback)}</p></div>`}

el.innerHTML=html}

// ═══════════════════════════════════════════════
// FUND & INSTITUTIONAL HOLDINGS PARSER
// ═══════════════════════════════════════════════
function populateFundHoldings(rawText, fundData){
const el=document.getElementById('fundHoldingsContent');
if(!el)return;

let html='';
const hasData=fundData&&(fundData.institutions?.length>0||fundData.funds?.length>0);

if(hasData){
const s=fundData.summary||{};
if(s.institutional_pct||s.insider_pct){
html+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px">`;
if(s.institutional_pct)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15)"><div style="font-size:22px;font-weight:800;color:var(--blue)">${s.institutional_pct}%</div><div style="font-size:11px;color:var(--text3)">Institutional</div></div>`;
if(s.insider_pct)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15)"><div style="font-size:22px;font-weight:800;color:var(--purple)">${s.insider_pct}%</div><div style="font-size:11px;color:var(--text3)">Insiders</div></div>`;
if(s.inst_count)html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)"><div style="font-size:22px;font-weight:800;color:var(--green)">${s.inst_count.toLocaleString()}</div><div style="font-size:11px;color:var(--text3)">Institutions</div></div>`;
html+=`</div>`;
}

function renderHolders(list,title,icon,color){
if(!list||list.length===0)return;
html+=`<div style="margin-bottom:16px"><div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:${color};letter-spacing:.5px;margin-bottom:8px">${icon} ${title}</div>`;
list.forEach((h,i)=>{
const barW=Math.min(100,h.pct*8);
const sharesStr=h.shares?h.shares.toLocaleString()+' shares':'';
const valStr=h.value?(h.value>=1e9?'$'+(h.value/1e9).toFixed(1)+'B':h.value>=1e6?'$'+(h.value/1e6).toFixed(1)+'M':'$'+h.value.toLocaleString()):'';
html+=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;padding:8px 12px;border-radius:8px;background:rgba(59,130,246,.03);border:1px solid rgba(59,130,246,.06)"><span style="font-size:11px;color:var(--text3);min-width:20px;font-weight:700">#${i+1}</span><div style="flex:1;min-width:0"><div style="font-size:13px;color:var(--text);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${h.name}</div><div style="display:flex;gap:8px;margin-top:2px"><span style="font-size:10px;color:var(--text3)">${sharesStr}</span>${valStr?'<span style="font-size:10px;color:var(--text3)">'+valStr+'</span>':''}</div><div style="height:3px;border-radius:2px;background:rgba(0,120,212,.08);margin-top:3px"><div style="height:100%;border-radius:2px;background:${color};width:${barW}%"></div></div></div><span style="font-size:13px;font-weight:700;color:${color};white-space:nowrap">${h.pct}%</span></div>`;
});
html+=`</div>`;
}
renderHolders(fundData.institutions,'TOP INSTITUTIONAL HOLDERS','🏦','var(--blue)');
renderHolders(fundData.funds,'TOP MUTUAL FUND HOLDERS','💼','var(--purple)');
}

// AI text fallback for smart money analysis
const fStart=rawText.search(/TOP FUND.*INSTITUTIONAL|FUND.*INSTITUTIONAL HOLDINGS/i);
const fEnd=rawText.search(/WHAT.*NEXT.*Catalyst|ENTRY.*EXIT/i);
if(fStart!==-1){
const sec=fEnd>fStart?rawText.substring(fStart,fEnd):rawText.substring(fStart,fStart+1500);
const pts=sec.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<pts.length;i+=2){
const hd=(pts[i]||'').replace(/[:*]/g,'').trim();
const ct=(pts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
if(hd&&ct&&ct.length>10&&/smart money|what smart/i.test(hd)){
html+=`<div style="border-left:4px solid rgba(59,130,246,.3);border-radius:10px;padding:14px 16px;margin-bottom:10px;background:rgba(59,130,246,.04)"><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:16px">🧠</span><span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--blue)">${hd}</span></div><p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(ct)}</p></div>`;
}}}

if(!html)el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Fund holdings data not available for this stock.</p></div>';
else el.innerHTML=html;
}

// WHAT'S NEXT - Catalysts & Timeline Parser
// ═══════════════════════════════════════════════
function populateWhatsNext(rawText){
const el=document.getElementById('whatsNextContent');
if(!el)return;

const start=rawText.search(/🔮\s*WHAT['']?S NEXT|##\s*🔮|WHAT['']?S NEXT.*Catalyst/i);
const end=rawText.search(/🎯\s*ENTRY.*EXIT|##\s*🎯\s*ENTRY/i);
if(start===-1){el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Catalyst analysis not available for this stock.</p></div>';return}

const section=end>start?rawText.substring(start,end):rawText.substring(start,start+2500);
const cleaned=section.replace(/[│┌┐└┘├┤─┬┴┼═]/g,'').replace(/^#+\s*/gm,'');

let html='';

// Parse blocks — only catalyst/timeline related
const blocks=[];
const parts=cleaned.split(/\*\*([^*]+)\*\*/);
for(let i=1;i<parts.length;i+=2){
const heading=(parts[i]||'').replace(/[:*]/g,'').trim();
const content=(parts[i+1]||'').replace(/^\s*[:]\s*/,'').trim().split('\n').filter(l=>l.trim().length>5).join(' ').trim();
// Skip headings that belong to other sections
if(heading&&content&&content.length>10&&!/smart money|institutional|fund holder|ownership|confidence level|ceo.*cfo|management.*tone|investment.*inference/i.test(heading))
blocks.push({heading,content});
}

// Timeline theme mapping
const timeThemes=[
{match:/30 day|next month|short.term/i,icon:'📅',color:'var(--cyan)',bg:'rgba(6,182,212,.05)',border:'rgba(6,182,212,.3)'},
{match:/90 day|3 month|quarter/i,icon:'📆',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'},
{match:/12 month|year|long.term/i,icon:'🗓️',color:'var(--purple)',bg:'rgba(139,92,246,.05)',border:'rgba(139,92,246,.3)'},
{match:/trigger|key.*watch|catalyst/i,icon:'⚡',color:'var(--amber)',bg:'rgba(245,158,11,.05)',border:'rgba(245,158,11,.3)'},
{match:/bull.*case|upside|best.*case/i,icon:'🟢',color:'var(--green)',bg:'rgba(16,185,129,.05)',border:'rgba(16,185,129,.3)'},
{match:/bear.*case|downside|worst.*case/i,icon:'🔴',color:'var(--red)',bg:'rgba(239,68,68,.05)',border:'rgba(239,68,68,.3)'},
{match:/most likely|base.*case|probable/i,icon:'🎯',color:'var(--blue)',bg:'rgba(59,130,246,.05)',border:'rgba(59,130,246,.3)'}
];
const defTheme={icon:'📋',color:'var(--text2)',bg:'var(--surface)',border:'var(--border)'};

blocks.forEach(b=>{
let theme=defTheme;
const test=b.heading+' '+b.content;
for(const t of timeThemes){if(t.match.test(test)){theme=t;break}}

html+=`<div style="border-left:4px solid ${theme.border};border-radius:10px;padding:14px 16px;margin-bottom:10px;background:${theme.bg}">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
<span style="font-size:16px">${theme.icon}</span>
<span style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:${theme.color}">${b.heading}</span>
</div>
<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">${colorizeText(b.content)}</p>
</div>`;
});

if(!html)el.innerHTML='<div class="ic bl"><p style="color:var(--text3)">Catalyst timeline not available.</p></div>';
else el.innerHTML=html;
}
function colorizeText(text){
return text
.replace(/🟢|bullish|strong buy|accelerating|beat|raised|expansion|green flag|positive/gi,m=>`<span style="color:var(--green);font-weight:600">${m}</span>`)
.replace(/🔴|bearish|red flag|missed|declining|lowered|warning|concern|defensive|avoid/gi,m=>`<span style="color:var(--red);font-weight:600">${m}</span>`)
.replace(/🟡|cautious|mixed|neutral|maintain|flat|stable|caution/gi,m=>`<span style="color:var(--amber);font-weight:600">${m}</span>`)
.replace(/(\+\d+\.?\d*%)/g,'<span style="color:var(--green);font-weight:600">$1</span>')
.replace(/(-\d+\.?\d*%)/g,'<span style="color:var(--red);font-weight:600">$1</span>')
.replace(/(↑)/g,'<span style="color:var(--green)">$1</span>')
.replace(/(↓)/g,'<span style="color:var(--red)">$1</span>')
.replace(/(→)/g,'<span style="color:var(--amber)">$1</span>')
.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
}

// ═══════════════════════════════════════════════
// AI ANALYSIS PARSING ENGINE - Educational Tables
// ═══════════════════════════════════════════════
function formatAIAnalysis(rawText){
const sections=[
{title:'📊 Valuation Check — Is The Price Right?',icon:'💰',color:'var(--blue)',data:extractValuationInsights(rawText)},
{title:'📈 Price Momentum — Where Is It Heading?',icon:'🎯',color:'var(--green)',data:extractMomentumInsights(rawText)},
{title:'⚠️ Risk Factors — What Could Go Wrong?',icon:'🛡️',color:'var(--red)',data:extractRiskInsights(rawText)},
{title:'💡 Investment Strategy — Should You Buy?',icon:'🎯',color:'var(--purple)',data:extractStrategyInsights(rawText)}
];
let h=`<div style="padding:16px;border-radius:10px;margin-bottom:18px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);text-align:center">
<div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--blue);margin-bottom:6px">🎓 EASY-TO-UNDERSTAND AI ANALYSIS</div>
<div style="font-size:12px;color:var(--text3);line-height:1.7">We've broken down the AI analysis into simple, actionable insights.<br><strong>Look for <span style="color:var(--green)">🟢 GREEN</span> (good), <span style="color:var(--amber)">🟡 YELLOW</span> (caution), <span style="color:var(--red)">🔴 RED</span> (warning)</strong></div></div>`;
sections.forEach(s=>{h+=createEducationalSection(s)});
h+=`<div style="padding:16px;border-radius:10px;margin-top:18px;background:var(--bg);border:1px solid var(--border)">
<span class="aix" onclick="const e=document.getElementById('fullAIedu');e.style.display=e.style.display==='none'?'block':'none';this.innerHTML=e.style.display==='none'?'▸ View detailed AI breakdown':'▾ Close AI breakdown'">▸ View detailed AI breakdown</span>
<div id="fullAIedu" class="ait" style="display:none;margin-top:10px;max-height:400px;overflow-y:auto;padding-right:8px">${rawText}</div></div>`;
const el=document.getElementById('aiAnalysisFormatted');if(el)el.innerHTML=h}

function createEducationalSection(section){
if(!section.data||!section.data.length)return'';
return`<div style="background:var(--surface);padding:20px;border-radius:12px;margin-bottom:14px;border-left:4px solid ${section.color};border:1px solid var(--border)">
<div style="color:${section.color};font-family:'Sora',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px">
<span style="font-size:22px">${section.icon}</span>${section.title}</div>
<table class="dt"><thead><tr><th style="width:25%">Factor</th><th style="width:22%">Status</th><th>What This Means For You</th></tr></thead>
<tbody>${section.data.map(r=>createTableRow(r)).join('')}</tbody></table></div>`}

function createTableRow(row){
const sc={'good':'var(--green)','caution':'var(--amber)','concern':'var(--red)','neutral':'var(--text3)'};
const si={'good':'🟢','caution':'🟡','concern':'🔴','neutral':'⚪'};
return`<tr><td style="font-weight:600;font-size:13px">${row.factor}</td>
<td style="color:${sc[row.signal]};font-weight:700;font-size:13px">${si[row.signal]} ${row.status}</td>
<td style="font-size:12px;line-height:1.7;color:var(--text2)">${row.explanation}</td></tr>`}

function extractValuationInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('p/e')||tl.includes('price-to-earnings')){const m=text.match(/p\/e.*?(\d+\.?\d*)/i);if(m){const pe=parseFloat(m[1]);
insights.push({factor:'P/E Ratio',status:pe<15?'Undervalued':pe<25?'Fair Value':'Expensive',signal:pe<15?'good':pe<25?'neutral':'caution',
explanation:pe<15?'Trading below average multiples. Could be a buying opportunity if fundamentals are strong.':pe<25?'Reasonably priced compared to earnings. Not too cheap, not too expensive.':'Trading at a premium. Make sure growth justifies the higher price.'})}}
if(tl.includes('undervalued'))insights.push({factor:'Overall Valuation',status:'Below Fair Value',signal:'good',explanation:'Appears to be trading below intrinsic worth. Potential buying opportunity for long-term investors.'});
else if(tl.includes('overvalued')||tl.includes('expensive'))insights.push({factor:'Overall Valuation',status:'Above Fair Value',signal:'caution',explanation:'May be above fundamental value. Consider waiting for better entry or ensure growth justifies premium.'});
else if(tl.includes('fairly valued')||tl.includes('reasonable'))insights.push({factor:'Overall Valuation',status:'Fair Value',signal:'neutral',explanation:'Priced appropriately based on fundamentals. Neither a bargain nor overpriced.'});
if(tl.includes('margin')){const m=text.match(/margin.*?(\d+\.?\d*)%/i);if(m){const v=parseFloat(m[1]);
insights.push({factor:'Profit Margins',status:v>15?'Healthy':v>8?'Moderate':'Weak',signal:v>15?'good':v>8?'neutral':'concern',
explanation:v>15?`Strong margins (${v}%) indicate efficient operations and pricing power.`:v>8?`Moderate margins (${v}%). Profitable but facing competitive pressure.`:`Low margins (${v}%) suggest intense competition. Monitor carefully.`})}}
if(tl.includes('growth'))insights.push({factor:'Growth Prospects',status:tl.includes('high growth')||tl.includes('strong growth')?'Strong Growth':'Moderate Growth',
signal:tl.includes('high growth')||tl.includes('strong growth')?'good':'neutral',
explanation:tl.includes('high growth')||tl.includes('strong growth')?'Expected to grow faster than market average. Can justify higher valuations.':'Steady but not spectacular growth. Suitable for conservative investors.'});
return insights.length?insights:[{factor:'Valuation',status:'Under Review',signal:'neutral',explanation:'AI is analyzing multiple valuation metrics. Check detailed analysis below.'}]}

function extractMomentumInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('uptrend')||tl.includes('rising')||tl.includes('bullish'))insights.push({factor:'Price Trend',status:'Upward Momentum',signal:'good',explanation:'Price is trending up. Buyers in control, sentiment positive. Good for momentum investors.'});
else if(tl.includes('downtrend')||tl.includes('falling')||tl.includes('bearish'))insights.push({factor:'Price Trend',status:'Downward Momentum',signal:'concern',explanation:'Price is trending down. Sellers dominate. Wait for stabilization before buying.'});
else if(tl.includes('sideways')||tl.includes('range-bound'))insights.push({factor:'Price Trend',status:'Consolidating',signal:'neutral',explanation:'Moving sideways in a range. Market undecided. Watch for breakout in either direction.'});
if(tl.includes('volume'))insights.push({factor:'Trading Volume',status:tl.includes('high volume')?'High Interest':'Normal',signal:tl.includes('high volume')?'good':'neutral',
explanation:tl.includes('high volume')?'High volume confirms the price move. More reliable trend.':'Normal activity. Price moves less significant without volume confirmation.'});
if(tl.includes('support'))insights.push({factor:'Support Levels',status:'Support Identified',signal:'good',explanation:'Key support levels provide downside protection. Buyers tend to step in at these prices.'});
if(tl.includes('resistance'))insights.push({factor:'Resistance Levels',status:'Resistance Present',signal:'caution',explanation:'Overhead resistance may cap near-term gains. Watch for a breakout above these levels.'});
if(tl.includes('52-week')||tl.includes('52 week')){if(tl.includes('high'))insights.push({factor:'52-Week Position',status:'Near Yearly High',signal:'caution',explanation:'Trading near its highest price this year. Limited short-term upside. Be cautious about chasing.'});
else if(tl.includes('low'))insights.push({factor:'52-Week Position',status:'Near Yearly Low',signal:'neutral',explanation:'Near lowest price this year. Value opportunity if fundamentals intact, or value trap if problems persist.'})}
return insights.length?insights:[{factor:'Price Momentum',status:'Analyzing',signal:'neutral',explanation:'AI reviewing price patterns and momentum. Check the price chart above for visual trends.'}]}

function extractRiskInsights(text){
const insights=[],tl=text.toLowerCase();
if(tl.includes('debt')){if(tl.includes('high debt')||tl.includes('leverage'))insights.push({factor:'Debt Burden',status:'High Leverage',signal:'concern',explanation:'Significant debt increases risk during downturns. Interest payments must be met. Monitor cash flow.'});
else if(tl.includes('low debt')||tl.includes('strong balance sheet'))insights.push({factor:'Financial Health',status:'Low Debt',signal:'good',explanation:'Manageable debt provides financial flexibility and reduces downturn risk.'})}
if(tl.includes('volatile')||tl.includes('volatility'))insights.push({factor:'Volatility',status:'High Swings',signal:'caution',explanation:'Large price swings. Higher risk but also higher reward. Suitable for risk-tolerant investors.'});
if(tl.includes('competition')||tl.includes('competitive'))insights.push({factor:'Competition',status:'Competitive Pressure',signal:'caution',explanation:'Faces competitive threats. Monitor market share and pricing power trends.'});
if(tl.includes('regulation')||tl.includes('regulatory'))insights.push({factor:'Regulatory',status:'Regulatory Risk',signal:'caution',explanation:'Subject to regulatory changes that could impact operations and profitability.'});
if(tl.includes('sector')||tl.includes('industry'))insights.push({factor:'Industry',status:'Sector Risks',signal:'neutral',explanation:'Monitor industry trends, regulatory changes, and competitive dynamics.'});
if(tl.includes('market')||tl.includes('economy'))insights.push({factor:'Macro',status:'Market Conditions',signal:'neutral',explanation:'Overall market and economic factors affect this stock. Stay informed about rates, inflation, and growth.'});
return insights.length?insights:[{factor:'Risk',status:'Standard Risks',signal:'neutral',explanation:'All investments carry risk. Diversify and invest only what you can afford to lose.'}]}

function extractStrategyInsights(text){
const insights=[],tu=text.toUpperCase(),tl=text.toLowerCase();
if(tu.includes('BUY')&&!tu.includes("DON'T BUY"))insights.push({factor:'Recommendation',status:'BUY',signal:'good',explanation:'Appears to be a good opportunity at current levels. Consider building position gradually.'});
else if(tu.includes('SELL')||tu.includes('AVOID'))insights.push({factor:'Recommendation',status:'SELL / AVOID',signal:'concern',explanation:'Risk factors outweigh potential rewards at current prices. Consider exiting or avoiding.'});
else if(tu.includes('HOLD'))insights.push({factor:'Recommendation',status:'HOLD',signal:'neutral',explanation:'Analysis is neutral — no strong directional signal in either direction. Monitor for catalyst changes.'});
if(tl.includes('long-term')||tl.includes('long term'))insights.push({factor:'Horizon',status:'Long-Term Hold',signal:'good',explanation:'Suitable for 3-5+ year horizon. Expect and tolerate short-term volatility.'});
else if(tl.includes('short-term')||tl.includes('trading'))insights.push({factor:'Horizon',status:'Short-Term Trade',signal:'caution',explanation:'Better for active traders. Requires close monitoring and quick decisions.'});
insights.push({factor:'Position Sizing',status:'Diversify',signal:'neutral',explanation:"Should represent no more than 5-10% of total portfolio. Spread risk across multiple investments."});
if(tl.includes('dip')||tl.includes('pullback'))insights.push({factor:'Entry',status:'Buy on Dips',signal:'good',explanation:'Build position on pullbacks for better average entry price.'});
return insights}

function formatCap(c,sym){const s=sym||'$';if(!c||isNaN(c))return'N/A';c=parseFloat(c);
// Indian notation for ₹
if(s==='₹'){
if(c>=1e12)return '₹'+(c/1e12).toFixed(2)+' Lakh Cr';
if(c>=1e7){const cr=c/1e7;return '₹'+(cr>=1000?Math.round(cr).toLocaleString('en-IN'):cr.toFixed(cr<100?2:0))+' Cr'}
if(c>=1e5)return '₹'+(c/1e5).toFixed(2)+' Lakh';
return '₹'+Math.round(c).toLocaleString('en-IN')}
if(c>=1e12)return s+(c/1e12).toFixed(2)+'T';if(c>=1e9)return s+(c/1e9).toFixed(2)+'B';if(c>=1e6)return s+(c/1e6).toFixed(2)+'M';return s+c.toLocaleString()}
function capCategory(mc,sym){if(sym==='₹'){return mc>2e11?'Large-cap':mc>5e10?'Mid-cap':'Small-cap'}return mc>100e9?'Large-cap':mc>10e9?'Mid-cap':'Small-cap'}

// ==========================================
// FEATURE VOTING SYSTEM
// ==========================================
const featureKeys=['pdf','cmp','share','tech','peer','earn','insider','theme'];
const featureNames=['PDF Export','Compare Stocks','Share (WhatsApp/Email)','Technical Indicators','Peer Comparison','Earnings Countdown','Insider Activity','Dark/Light Theme'];
const votes={};
featureKeys.forEach(k=>{votes[k]={up:0,dn:0}});
let voteChart=null;
let userVotes={};

// ═══════════════════════════════════════════════
// CURATED STOCK PICKS — Research-backed lists
// ═══════════════════════════════════════════════
const STOCK_PICKS={
lc:{title:'Top 5 Undervalued Large Caps',
india:[
{n:'ITC',t:'ITC.NS',p:'₹435',cl:'HUL, Nestle, Britannia compete',why:'P/E ~25x vs sector 35x, FMCG + hotel demerger catalyst, 3.5% div yield',edge:'Conglomerate discount unwinding',cat:'Undervalued'},
{n:'SBI',t:'SBI.NS',r:'Strong Buy',p:'₹790',cl:'HDFC Bank, ICICI, BoB compete',why:'P/B 1.6x (PSU banks at 2.5x), highest NIM, ₹5L Cr book, NPA at 10yr low',edge:'Largest loan book + digital push',cat:'Deep Value',bp:'₹720-750',d:'BUY ON DIP · Hold 12mo · Wait for ₹720-750 zone. NPA cycle bottom confirmed. 80% prob of ₹950+ in 12mo.'},
{n:'NTPC',t:'NTPC.NS',p:'₹340',cl:'Tata Power, Adani Power compete',why:'P/E ~15x, green energy pivot, 2.8% yield, govt capex beneficiary',edge:'Renewable + thermal dual play',cat:'Undervalued'},
{n:'Coal India',t:'COALINDIA.NS',p:'₹390',cl:'No listed peer (monopoly)',why:'P/E ~7x, 6%+ div yield, cash rich, volume growth returning',edge:'Cash cow with massive dividends',cat:'Deep Value'},
{n:'L&T',t:'LT.NS',p:'₹3,450',cl:'Tata Projects, Shapoorji, Afcons',why:'Orderbook ₹4.5L Cr at 3.2x book, infra capex cycle peak, strong execution',edge:'India infra backbone',cat:'Quality Value'}
],
usa:[
{n:'Alphabet',t:'GOOGL',p:'$185',cl:'Microsoft, Meta, Amazon (ads)',why:'P/E ~22x vs FAANG avg 30x, $100B+ cash, AI leader, cloud growing 28%',edge:'AI + search monopoly underpriced',cat:'Undervalued'},
{n:'Berkshire',t:'BRK-B',r:'★ Aggressive Buy',p:'$480',cl:'No direct peer',why:'P/B 1.5x, $300B+ cash pile, insurance float machine, Buffett premium',edge:'Largest cash hoard in history',cat:'Deep Value',bp:'$450-470',d:'BUY NOW · Hold 24mo · $300B cash = acquisition catalyst anytime. Correction-proof. 88% prob of ₹600+ in 18mo.'},
{n:'Meta',t:'META',p:'$620',cl:'Google, TikTok, Snap (ads)',why:'P/E ~23x, 36% margins, 3.7B users, Reels monetization ramping, AI ads',edge:'Ad tech monopoly + AI efficiency',cat:'Quality Value'},
{n:'Merck',t:'MRK',p:'$105',cl:'Pfizer, J&J, AbbVie (pharma)',why:'P/E ~14x, Keytruda franchise $25B+, strong pipeline, 2.5% yield',edge:'Pharma cash machine underpriced',cat:'Deep Value'},
{n:'JPMorgan',t:'JPM',p:'$255',cl:'Goldman, BofA, Wells Fargo',why:'P/B 2x, ROE 17%, fortress balance sheet, best-in-class banking',edge:'Too big to fail, too cheap to ignore',cat:'Undervalued'}
]},
mc:{title:'Top 5 Undervalued Mid Caps',
india:[
{n:'Indian Hotels',t:'INDHOTEL.NS',r:'Buy',p:'₹720',cl:'ITC Hotels, Lemon Tree, Marriott',why:'Brand portfolio (Taj,Vivanta,Ginger), asset-light expansion, tourism boom',edge:'Pricing power + brand moat',cat:'Quality',bp:'₹650-680',d:'WAIT · Buy at ₹650 · Tourism boom priced in. Wait for correction. 72% prob of ₹850+ in 12mo.'},
{n:'Persistent Sys',t:'PERSISTENT.NS',r:'Strong Buy',p:'₹5,800',cl:'LTTS, Mphasis, Coforge (IT)',why:'30%+ rev growth, healthcare IT, partnerships with Salesforce/AWS',edge:'Niche digital engineering',cat:'Growth',bp:'₹5,200-5,500',d:'ACCUMULATE · Hold 12mo · Product-led IT. Add on dips. 80% prob of ₹7,000+ in 12mo.'},
{n:'Tube Investments',t:'TIINDIA.NS',r:'Buy',p:'₹3,700',cl:'Sundaram, Bosch, Schaeffler',why:'CG group pedigree, EV components, industrial diversification',edge:'Multi-segment industrial play',cat:'Quality',bp:'₹3,800-4,000',d:'BUY ON DIP · Hold 12mo · Tube Investments diversification play. 76% prob of ₹5,000+ in 12mo.'},
{n:'Coforge',t:'COFORGE.NS',r:'Buy',p:'₹7,500',cl:'Persistent, KPIT, Mphasis (IT)',why:'Insurance tech niche, Cigniti acquisition, 20%+ growth trajectory',edge:'Deep domain in BFSI/travel',cat:'Growth',bp:'₹6,800-7,200',d:'WAIT · Buy at ₹6,800 · Good business, expensive. Wait 3-6mo for better entry. 74% prob of ₹8,500+ in 12mo.'},
{n:'Supreme Ind',t:'SUPREMEIND.NS',r:'Strong Buy',p:'₹4,900',cl:'Astral, Prince Pipes, Finolex',why:'Plastic pipes leader, real estate + infra demand, margin expansion',edge:'Market share gains in pipes',cat:'Value',bp:'₹4,800-5,000',d:'BUY NOW · Hold 6-12mo · Plastic pipes infra play. Monsoon + capex cycle. 78% prob of ₹6,000+ in 9mo.'}
],
usa:[
{n:'CrowdStrike',t:'CRWD',r:'Buy',p:'$380',cl:'Palo Alto, SentinelOne, Fortinet',why:'Cybersecurity platform leader, 35%+ ARR growth, module adoption rising',edge:'Security platform consolidation',cat:'Growth',bp:'$350-380',d:'WAIT · Buy at $360 · Post-outage recovery done. Wait for pullback. 75% prob of $450+ in 12mo.'},
{n:'Datadog',t:'DDOG',r:'Buy',p:'$140',cl:'Splunk/Cisco, New Relic, Dynatrace',why:'Observability platform, net retention 115%+, multi-product expansion',edge:'DevOps monitoring standard',cat:'Quality',bp:'$120-135',d:'ACCUMULATE · Hold 12mo · Cloud monitoring essential spend. 78% prob of $170+ in 12mo.'},
{n:'Fair Isaac',t:'FICO',r:'★ Aggressive Buy',p:'$2,000',cl:'No real competitor (monopoly)',why:'FICO score monopoly, 85% of US lending decisions, pricing power',edge:'Irreplaceable credit scoring',cat:'Monopoly',bp:'$1,800-1,900',d:'BUY NOW · Hold 24mo · Credit scoring monopoly. No correction can break this moat. 85% prob of $2,200+ in 12mo.'},
{n:'IDEXX Labs',t:'IDXX',r:'Strong Buy',p:'$430',cl:'Zoetis, Heska (vet diagnostics)',why:'Pet diagnostics monopoly, recurring revenue, companion animal TAM growing',edge:'Pet healthcare monopoly',cat:'Quality',bp:'$420-440',d:'BUY ON DIP · Hold 12-18mo · Pet healthcare monopoly. Wait for $420 zone. 80% prob of $550+ in 12mo.'},
{n:'Cadence Design',t:'CDNS',r:'Strong Buy',p:'$300',cl:'Synopsys (EDA duopoly)',why:'EDA duopoly, chip complexity rising, AI accelerator design tools',edge:'Chip design infrastructure',cat:'Monopoly',bp:'$280-300',d:'ACCUMULATE · Hold 12mo · Chip design essential. AI chip demand = Cadence demand. 82% prob of $350+ in 12mo.'}
]},
sc:{title:'Top 5 Undervalued Small Caps',
india:[
{n:'Kaynes Tech',t:'KAYNES.NS',r:'Buy',p:'₹5,200',cl:'Dixon, Syrma, Avalon (EMS)',why:'Defense electronics, IoT sensors, govt contracts ₹2000Cr+, 40% margins',edge:'Defense + space + EV electronics',cat:'High Growth',bp:'₹5,000-5,500',d:'ACCUMULATE · Hold 12-18mo · Defense + space orders growing. 76% prob of ₹7,000+ in 12mo.'},
{n:'KPIT Tech',t:'KPITTECH.NS',r:'Strong Buy',p:'₹1,450',cl:'Tata Elxsi, LTTS (auto SW)',why:'EV software for top 25 OEMs globally, 30%+ growth, sticky contracts',edge:'Only pure-play auto SW in India',cat:'Niche Moat',bp:'₹1,300-1,400',d:'BUY NOW · Hold 12mo · Auto software monopoly in India. 80% prob of ₹1,800+ in 12mo.'},
{n:'Apar Industries',t:'APARINDS.NS',r:'Strong Buy',p:'₹7,800',cl:'KEI, Polycab (cables)',why:'Specialty conductors, transformer oil, export growth, power infra boom',edge:'Power transmission beneficiary',cat:'Value',bp:'₹9,000-9,500',d:'BUY ON DIP · Hold 12mo · Specialty chemicals. Wait for correction. 77% prob of ₹12,000+ in 12mo.'},
{n:'CMS Info Systems',t:'CMSINFO.NS',r:'★ Aggressive Buy',p:'₹460',cl:'SIS, AGS Transact (cash mgmt)',why:'Cash mgmt duopoly, ATM managed services, 25%+ ROE, asset-light',edge:'Cash logistics monopoly',cat:'Quality',bp:'₹480-500',d:'BUY NOW · Hold 6-12mo · Cash management duopoly. Recession-proof. 83% prob of ₹600+ in 9mo.'},
{n:'Tata Elxsi',t:'TATAELXSI.NS',r:'Buy',p:'₹6,200',cl:'KPIT, Persistent (design)',why:'Design + embedded systems for auto/media, Tata group synergies',edge:'Embedded systems niche',cat:'Niche Moat',bp:'₹6,000-6,500',d:'WAIT · Buy at ₹6,000 · Design services. Expensive now. 3-6mo patience. 73% prob of ₹8,000+ in 12mo.'}
],
usa:[
{n:'Monday.com',t:'MNDY',r:'Buy',p:'$300',cl:'Asana, Smartsheet, Notion',why:'Work OS platform, 110%+ net retention, crossing profitability, SMB+enterprise',edge:'Workflow platform with viral growth',cat:'Growth',bp:'$250-270',d:'ACCUMULATE · Hold 12mo · Work OS platform. Growing 30%+. 77% prob of $330+ in 12mo.'},
{n:'Axon Enterprise',t:'AXON',r:'Strong Buy',p:'$650',cl:'Motorola Solutions (public safety)',why:'TASER + body cameras + cloud evidence.com, govt contracts sticky',edge:'Law enforcement tech monopoly',cat:'Monopoly',bp:'$550-580',d:'BUY NOW · Hold 12-18mo · Law enforcement tech monopoly. 82% prob of $700+ in 12mo.'},
{n:'Samsara',t:'IOT',r:'Buy',p:'$50',cl:'Geotab, Teletrac Navman (fleet)',why:'IoT fleet management, 40%+ growth, expanding to connected ops',edge:'Physical operations intelligence',cat:'High Growth',bp:'$14-16',d:'ACCUMULATE · Hold 12-18mo · IoT platform. Early stage. 70% prob of $22+ in 18mo.'},
{n:'Clearwater',t:'CWAN',r:'Strong Buy',p:'$30',cl:'BlackRock Aladdin, SS&C (fintech)',why:'Investment accounting SaaS, 99%+ retention, $7T+ assets managed',edge:'Financial data infrastructure',cat:'Niche Moat',bp:'$90-100',d:'BUY NOW · Hold 12mo · Wealth tech infrastructure. Sticky revenue. 78% prob of $130+ in 12mo.'},
{n:'Wingstop',t:'WING',r:'Buy',p:'$320',cl:'Popeyes, Buffalo Wild Wings',why:'Asset-light franchise, same-store sales growth, digital 65%+ orders',edge:'Fastest growing restaurant chain',cat:'Quality',bp:'$280-300',d:'WAIT · Buy at $280 · Restaurant franchise. Expensive. Wait for pullback. 72% prob of $350+ in 12mo.'}
]},
niche:{title:'Top 5 Niche/Deep Moat Companies',
india:[
{n:'CDSL',t:'CDSL.NS',r:'★ Aggressive Buy',p:'₹1,550',cl:'NSDL (depository duopoly)',why:'1 of 2 depositories in India, every demat account = revenue, zero competition',edge:'Regulated duopoly, 70%+ margins',cat:'Monopoly',bp:'₹1,600-1,700',d:'BUY NOW · Hold 24mo · Demat monopoly. Every new investor = revenue. 88% prob of ₹2,200+ in 18mo.'},
{n:'IEX',t:'IEX.NS',r:'★ Aggressive Buy',p:'₹165',cl:'PXIL (95% vs 5% market share)',why:'95% market share in power exchange, regulatory moat, volume-linked revenue',edge:'Power exchange monopoly',cat:'Monopoly',bp:'₹170-180',d:'BUY NOW · Hold 12mo · Power exchange monopoly. India energy demand surge. 85% prob of ₹230+ in 12mo.'},
{n:'CAMS',t:'CAMS.NS',r:'★ Aggressive Buy',p:'₹4,200',cl:'KFin Tech (RTA duopoly)',why:'70% MF RTA market share, every SIP = revenue, regulation barrier',edge:'Mutual fund infrastructure backbone',cat:'Duopoly',bp:'₹3,800-4,000',d:'BUY NOW · Hold 12-18mo · MF RTA duopoly. SIP growth = guaranteed revenue. 86% prob of ₹5,000+ in 12mo.'},
{n:'Alkyl Amines',t:'ALKYLAMINE.NS',r:'Strong Buy',p:'₹2,100',cl:'Balaji Amines (specialty chem)',why:'Global leader in amines, pharma/agro raw material, pricing power',edge:'Specialty chemicals niche leader',cat:'Niche',bp:'₹2,200-2,400',d:'ACCUMULATE · Hold 12-18mo · Specialty chemicals. Cyclical bottom forming. 74% prob of ₹3,000+ in 12mo.'},
{n:'Aavas Fin',t:'AAVAS.NS',r:'Buy',p:'₹1,700',cl:'HDFC, Can Fin, Home First',why:'Rural affordable housing, self-employed customer niche, 14%+ ROE',edge:'Underserved market specialist',cat:'Niche',bp:'₹1,500-1,600',d:'BUY ON DIP · Hold 12-18mo · Rural housing NBFC. Rate cut cycle benefits. 76% prob of ₹2,000+ in 12mo.'}
],
usa:[
{n:'ASML',t:'ASML',r:'★ Aggressive Buy',p:'$720',cl:'None (absolute monopoly)',why:'Only EUV lithography maker on earth, every advanced chip needs ASML',edge:'Absolute monopoly in EUV',cat:'Monopoly',bp:'$650-700',d:'BUY NOW · Hold 24mo · EUV lithography monopoly. No alternative exists. 90% prob of ₹900+ in 18mo.'},
{n:'Verisign',t:'VRSN',r:'★ Aggressive Buy',p:'$210',cl:'None (.com/.net registry)',why:'.com/.net registry monopoly, ICANN contract, 87%+ margins',edge:'Internet domain infrastructure',cat:'Monopoly',bp:'$195-205',d:'BUY NOW · Hold 12mo · .com/.net domain monopoly. Price hikes = guaranteed earnings growth. 85% prob of $240+ in 12mo.'},
{n:'S&P Global',t:'SPGI',r:'★ Aggressive Buy',p:'$510',cl:"Moody's, Fitch (ratings)",why:'Credit ratings oligopoly, data analytics, IHS Markit merger synergies',edge:'Financial data indispensable',cat:'Oligopoly',bp:'$480-510',d:'BUY ON DIP · Hold 12mo · Credit rating duopoly. Debt issuance cycle returning. 82% prob of $580+ in 12mo.'},
{n:"Moody's",t:'MCO',r:'Strong Buy',p:'$470',cl:"S&P Global, Fitch (ratings)",why:'Credit ratings duopoly with S&P, recurring revenue, debt issuance growth',edge:'Regulatory-mandated ratings',cat:'Duopoly',bp:'$430-460',d:"BUY ON DIP · Hold 12mo · Moody's. Same thesis as S&P Global. Rating duopoly. 80% prob of $530+ in 12mo."},
{n:'TransDigm',t:'TDG',r:'Strong Buy',p:'$1,350',cl:'Heico (sole-source parts)',why:'Sole-source aerospace parts, 45%+ margins, aftermarket pricing power',edge:'Proprietary aerospace components',cat:'Monopoly',bp:'$1,300-1,400',d:'BUY NOW · Hold 18mo · Aerospace aftermarket monopoly. Locked-in revenue. 84% prob of $1,600+ in 12mo.'}
]},
micro:{title:'Top 5 Multibagger Potential — Micro Caps',
india:[
{n:'Netweb Tech',t:'NETWEB.NS',r:'Accumulate',p:'₹2,400',cl:'Dell, HPE (servers)',why:'AI server manufacturing, NVIDIA partnership, Make in India for HPC/AI',edge:'Only listed AI hardware maker in India',cat:'AI/HPC',bp:'₹2,200-2,400',d:'ACCUMULATE · Hold 18mo · AI server mfg. High risk but massive TAM. 65% prob of ₹3,500+ in 18mo.'},
{n:'Zaggle Prepaid',t:'ZAGGLE.NS',r:'Accumulate',p:'₹420',cl:'Happay, Razorpay (expense)',why:'SaaS spend management, 2M+ users, embedded fintech, 70%+ growth',edge:'Corporate expense management SaaS',cat:'Fintech',bp:'₹350-380',d:'ACCUMULATE · Hold 12-18mo · Corporate expense SaaS. Early stage. 62% prob of ₹500+ in 12mo.'},
{n:'Avalon Tech',t:'AVALON.NS',r:'Accumulate',p:'₹720',cl:'Dixon, Syrma, Kaynes (EMS)',why:'EMS for defense/aerospace/medical, US client base, PLI beneficiary',edge:'High-value electronics for export',cat:'Defense',bp:'₹600-650',d:'ACCUMULATE · Hold 18mo · EMS electronics. Order book growing. 60% prob of ₹900+ in 18mo.'},
{n:'Syrma SGS',t:'SYRMA.NS',r:'Accumulate',p:'₹480',cl:'Dixon, Kaynes, Avalon (EMS)',why:'IoT + RFID + EMS, Samsung/Visteon clients, order book ₹2000Cr',edge:'Smart mfg for global OEMs',cat:'IoT/EMS',bp:'₹400-430',d:'ACCUMULATE · Hold 12-18mo · PLI beneficiary. IoT + defense orders. 64% prob of ₹600+ in 12mo.'},
{n:'Bondada Eng',t:'BONDADA.NS',r:'Accumulate',p:'₹240',cl:'Sterlite, Tejas (5G infra)',why:'5G tower infra, solar EPC, telecom rollout contracts, 100%+ growth',edge:'5G infrastructure rollout play',cat:'5G/Solar',bp:'₹250-270',d:'ACCUMULATE · Hold 18-24mo · Green energy EPC. High risk, high reward. 55% prob of ₹400+ in 18mo.'}
],
usa:[
{n:'Indie Semi',t:'INDI',r:'Accumulate',p:'$6',cl:'NXP, Infineon (auto chips)',why:'Auto semiconductors, ADAS sensors, EV power mgmt, 50+ design wins',edge:'Next-gen auto chip pure play',cat:'EV/ADAS',bp:'$6-7',d:'ACCUMULATE · Hold 18-24mo · Automotive semiconductors. Early. 58% prob of $12+ in 18mo.'},
{n:'Credo Tech',t:'CRDO',r:'Buy',p:'$80',cl:'Marvell, Broadcom (connectivity)',why:'High-speed connectivity for AI data centers, 100G/200G/400G solutions',edge:'AI datacenter interconnects',cat:'AI Infra',bp:'$55-65',d:'BUY ON DIP · Hold 12mo · Connectivity silicon. Data center growth. 72% prob of $90+ in 12mo.'},
{n:'Astera Labs',t:'ALAB',r:'Buy',p:'$90',cl:'Marvell, Credo (CXL/PCIe)',why:'Semiconductor connectivity for AI/cloud, PCIe/CXL retimers',edge:'AI infrastructure fabric',cat:'AI Infra',bp:'$70-80',d:'ACCUMULATE · Hold 12-18mo · AI networking chips. High growth. 68% prob of $110+ in 12mo.'},
{n:'Archer Aviation',t:'ACHR',r:'Accumulate',p:'$9',cl:'Joby, Lilium (eVTOL)',why:'eVTOL air taxi, FAA certification path, United Airlines partnership',edge:'Urban air mobility first mover',cat:'Futuristic',bp:'$7-9',d:'ACCUMULATE · Hold 24mo · eVTOL air taxi. Pre-revenue. Speculative. 45% prob of $15+ in 24mo.'},
{n:'Nano-X',t:'NNOX',r:'Accumulate',p:'$8',cl:'GE Healthcare, Siemens (imaging)',why:'Disruptive digital X-ray, cold-cathode tech, $2/scan model, FDA cleared',edge:'Democratizing medical imaging',cat:'MedTech',bp:'$10-12',d:'ACCUMULATE · Hold 18-24mo · Digital X-ray. FDA approvals key. 50% prob of $20+ in 18mo.'}
]},
penny:{title:'Penny Gems — ₹10 Stocks That Could Hit ₹100',
india:[
{n:'Trident Ltd',t:'TRIDENT.NS',r:'Accumulate',p:'₹32',cl:'Welspun, Indo Count (textiles)',why:'Yarn + paper + home textiles integrated, export orders, capacity expansion, consistent dividends',edge:'Vertically integrated textiles + paper',cat:'Turnaround',bp:'₹28-30',d:'ACCUMULATE · Hold 12-18mo · Integrated textiles. Capacity expansion. 65% prob of ₹45+ in 12mo.'},
{n:'Vodafone Idea',t:'IDEA.NS',r:'Accumulate',p:'₹8',cl:'Jio, Airtel (telecom)',why:'Govt equity conversion, 220M+ subscribers, tariff hikes = ARPU growth, spectrum assets valued 3x mkt cap',edge:'Telecom duopoly survivor bet',cat:'High Risk',bp:'₹7-8',d:'ACCUMULATE · Hold 24mo · Telecom survivor bet. Tariff hikes = ARPU growth. 50% prob of ₹15+ in 24mo.'},
{n:'NHPC',t:'NHPC.NS',r:'Strong Buy',p:'₹85',cl:'SJVN, NTPC (hydro/PSU)',why:'Largest hydro power company, green energy premium, 4%+ div yield, PSU rerating wave',edge:'India\'s hydro power monopoly',cat:'PSU Value',bp:'₹75-80',d:'BUY NOW · Hold 12mo · Hydro monopoly + 4% div yield + PSU rerating. 78% prob of ₹110+ in 12mo.'},
{n:'IREDA',t:'IREDA.NS',r:'Buy',p:'₹190',cl:'PFC, REC (green finance)',why:'Renewable energy NBFC, 30%+ loan book growth, govt mandate for green projects, low NPA',edge:'Only listed green energy lender',cat:'Green Finance',bp:'₹160-175',d:'ACCUMULATE · Hold 12mo · Green energy NBFC. Govt mandate. 70% prob of ₹250+ in 12mo.'},
{n:'HFCL',t:'HFCL.NS',r:'Accumulate',p:'₹95',cl:'Sterlite, Tejas, MTNL (telecom)',why:'Optical fiber + 5G equipment + defense comms, ₹10K Cr order book, govt BharatNet contracts',edge:'5G + defense + fiber triple play',cat:'5G/Defense',bp:'₹80-88',d:'ACCUMULATE · Hold 12-18mo · 5G + fiber + defense. ₹10K Cr orders. 68% prob of ₹130+ in 12mo.'}
],
usa:[
{n:'SoundHound AI',t:'SOUN',r:'Accumulate',p:'$9',cl:'Nuance/MSFT, Google (voice AI)',why:'Conversational AI for restaurants, cars, IoT — Hyundai, Stellantis clients',edge:'Voice AI for physical businesses',cat:'AI Voice',bp:'$7-8',d:'ACCUMULATE · Hold 12-18mo · Voice AI for businesses. Revenue inflecting. 60% prob of $15+ in 12mo.'},
{n:'IonQ',t:'IONQ',r:'Accumulate',p:'$8',cl:'IBM, Google (quantum)',why:'Trapped-ion quantum computing, US govt + enterprise contracts, partnership with Hyundai & Airbus',edge:'Pure-play quantum computing',cat:'Quantum',bp:'$6-7',d:'ACCUMULATE · Hold 24mo · Quantum computing. Very early. Speculative. 45% prob of $15+ in 24mo.'},
{n:'Serve Robotics',t:'SERV',r:'Accumulate',p:'$7',cl:'Nuro, Starship (delivery bots)',why:'Sidewalk delivery robots, Uber Eats partnership, LA/SF deployed, Nvidia-powered AI',edge:'Last-mile autonomous delivery',cat:'Robotics',bp:'$5-6',d:'ACCUMULATE · Hold 18-24mo · Delivery robots. Uber partnership. 50% prob of $12+ in 18mo.'},
{n:'BigBear.ai',t:'BBAI',r:'Accumulate',p:'$4',cl:'Palantir, C3.ai (defense AI)',why:'AI analytics for US defense + supply chain, $500M+ contract pipeline',edge:'Defense-grade decision intelligence',cat:'Defense AI',bp:'$3-4',d:'ACCUMULATE · Hold 18mo · Defense AI analytics. Contract pipeline strong. 55% prob of $8+ in 18mo.'},
{n:'Quantum-Si',t:'QSI',r:'Accumulate',p:'$3',cl:'Illumina, PacBio (proteomics)',why:'Protein sequencing semiconductor, backed by Peter Thiel, FDA path for diagnostics',edge:'First protein sequencing chip',cat:'Biotech',bp:'$2-3',d:'ACCUMULATE · Hold 24mo · Protein sequencing. Pre-revenue. Highest risk. 40% prob of $6+ in 24mo.'}
]},
idx:{title:'Best Index — 30%+ CAGR Potential',
india:[
{n:'Nifty Microcap 250',t:'INDEX',r:'Strong Buy',p:'—',cl:'N/A',why:'Micro-cap broad basket, early-stage growth capture, 35%+ 5yr CAGR',edge:'Widest small-company exposure',cat:'37% CAGR*',bp:'SIP Monthly',d:'START SIP NOW · Hold 36mo+ · Nifty 50 index. 12% CAGR long-term. Best via SIP. 90% prob positive in 3yr.'},
{n:'Nifty Smallcap 250',t:'INDEX',p:'—',cl:'N/A',why:'Small-cap diversified, infra/consumption themes, 32%+ 5yr CAGR',edge:'Small-cap without single-stock risk',cat:'33% CAGR*'},
{n:'BSE SME IPO Index',t:'INDEX',p:'—',cl:'N/A',why:'Captures SME listing gains, high-growth new listings, 40%+ returns',edge:'IPO + early-stage premium',cat:'40%+ CAGR*'},
{n:'Nifty India Defence',t:'INDEX',p:'—',cl:'N/A',why:'Defence capex theme, 5yr CAGR 38%+, govt spending visibility',edge:'Multi-year defence order visibility',cat:'38% CAGR*'},
{n:'Nifty Infra Index',t:'INDEX',p:'—',cl:'N/A',why:'Roads, railways, power — PM Gati Shakti beneficiary',edge:'₹10L Cr+ govt infra pipeline',cat:'31% CAGR*'}
],
usa:[
{n:'NASDAQ-100',t:'QQQ',r:'Strong Buy',p:'$520',cl:'N/A',why:'Top 100 non-financial, tech-heavy, AI/cloud/SaaS concentration',edge:'Big tech + AI mega trends',cat:'19% CAGR',bp:'SIP Monthly',d:'START SIP NOW · Hold 36mo+ · NASDAQ-100. Tech-heavy. 20%+ CAGR 10yr. 88% prob positive in 3yr.'},
{n:'S&P 500 Info Tech',t:'XLK',r:'Strong Buy',p:'$230',cl:'N/A',why:'Pure technology sector, AAPL+MSFT+NVDA heavy, secular growth',edge:'Tech dominance compounding',cat:'22% CAGR',bp:'SIP Monthly',d:'START SIP NOW · Hold 24mo+ · Tech Select SPDR. Broad tech exposure. 85% prob positive in 2yr.'},
{n:'VanEck Semiconductor',t:'SMH',r:'Buy',p:'$260',cl:'N/A',why:'NVDA, AVGO, AMD, ASML — AI chip demand supercycle',edge:'AI hardware supercycle play',cat:'30%+ CAGR*',bp:'SIP Monthly',d:'ACCUMULATE · Hold 24mo+ · Semiconductor ETF. Cyclical but secular AI tailwind. 80% prob of 30%+ in 2yr.'},
{n:'ARK Innovation',t:'ARKK',r:'Accumulate',p:'$55',cl:'N/A',why:'Disruptive tech — AI, genomics, fintech, autonomous vehicles',edge:'High risk, high reward innovation',cat:'Volatile',bp:'$45-50',d:'WAIT · Buy at $45 · High risk innovation. Only if you believe in disruptive tech thesis. 55% prob of $70+ in 18mo.'},
{n:'Global X AI & Tech',t:'AIQ',r:'Buy',p:'$35',cl:'N/A',why:'Broad AI exposure — chips, software, robotics, autonomous',edge:'Diversified AI theme ETF',cat:'28%+ CAGR*',bp:'SIP Monthly',d:'ACCUMULATE · Hold 24mo+ · AI theme ETF. Secular growth. 75% prob of 25%+ in 2yr.'}
]}
};

let _pickGeo='india';
function showPickCat(btn,cat){
document.querySelectorAll('.ptab').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text2)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--blue)';btn.style.color='#fff';btn.style.borderColor='var(--blue)';
renderPicks(cat);
}
function togglePickGeo(btn,geo){
_pickGeo=geo;
document.querySelectorAll('.pick-geo button').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text3)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--amber)';btn.style.color='#000';btn.style.borderColor='var(--amber)';
const activeCat=document.querySelector('.ptab.active');
const cat=activeCat?activeCat.getAttribute('onclick').match(/'(\w+)'/)[1]:'lc';
renderPicks(cat);
}
function renderPicks(cat){
const el=document.getElementById('pickGrid');
if(!el)return;
const data=STOCK_PICKS[cat];
if(!data){el.innerHTML='';return}
const list=_pickGeo==='india'?data.india:data.usa;
const isIdx=cat==='idx';
const isPenny=cat==='penny';
let h=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text)">${data.title}</div>
<div class="pick-geo">
<button class="${_pickGeo==='india'?'active':''}" onclick="togglePickGeo(this,'india')" style="${_pickGeo==='india'?'background:var(--amber);color:#000;border-color:var(--amber)':''}">&#127470;&#127475; India</button>
<button class="${_pickGeo==='usa'?'active':''}" onclick="togglePickGeo(this,'usa')" style="${_pickGeo==='usa'?'background:var(--amber);color:#000;border-color:var(--amber)':''}">&#127482;&#127480; USA</button>
</div></div>`;
h+=`<div style="overflow-x:auto"><table class="pick-tbl"><tr><th>#</th><th>Company</th><th>Rating</th><th style="color:var(--cyan)">Live Price</th><th style="color:var(--green)">Entry Zone</th><th style="color:var(--cyan)">Decision &amp; Timeline</th><th>Edge</th><th>${isIdx?'Returns':'Type'}</th></tr>`;
list.forEach((s,i)=>{
const catCls=s.cat.includes('Monopoly')||s.cat.includes('Duopoly')||s.cat.includes('Oligopoly')?'b':s.cat.includes('Deep')||s.cat.includes('Value')||s.cat.includes('Undervalued')||s.cat.includes('Turnaround')||s.cat.includes('PSU')?'g':'b';
const rt=s.r||'Buy';
const rC=rt.includes('Aggressive')?'#10b981':rt.includes('Strong')?'#10b981':rt==='Buy'?'#3b82f6':'#f59e0b';
const rBg=rt.includes('Aggressive')?'rgba(16,185,129,.15)':rt.includes('Strong')?'rgba(16,185,129,.08)':rt==='Buy'?'rgba(0,120,212,.08)':'rgba(245,158,11,.08)';
const dec=s.d||'';
const decParts=dec.split(' · ');
const decAction=decParts[0]||'';
const decRest=decParts.slice(1).join(' · ');
const decCol=decAction.includes('BUY NOW')?'var(--green)':decAction.includes('ACCUMULATE')?'#22d3ee':decAction.includes('WAIT')?'var(--amber)':decAction.includes('START')?'var(--green)':'var(--text2)';
h+=`<tr>
<td style="color:var(--text3);font-weight:700">${i+1}</td>
<td><div class="cname">${s.n}</div><div class="csub">${s.t}</div></td>
<td><span style="font-size:9px;padding:2px 6px;border-radius:4px;background:${rBg};color:${rC};font-weight:700;white-space:nowrap">${rt}</span></td>
<td style="font-weight:700;color:var(--cyan);white-space:nowrap;font-size:11px" data-ticker="${s.t}" data-col="cmp"><span style="font-size:9px;color:var(--text3)">⏳ loading...</span></td>
<td style="font-weight:700;color:var(--green);white-space:nowrap;font-size:11px">${s.bp||'—'}</td>
<td style="font-size:10px;line-height:1.5"><strong style="color:${decCol};font-size:10px">${decAction}</strong>${decRest?' · <span style="color:var(--text2)">'+decRest+'</span>':''}</td>
<td style="font-size:10px;font-weight:600;color:var(--amber)">${s.edge}</td>
<td><span class="flag ${catCls}">${s.cat}</span></td>
</tr>`;
});
h+=`</table></div>`;
if(cat==='idx')h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">* CAGR figures are approximate based on last 3-5 year trailing returns. Past performance does not guarantee future results.</div>`;
if(cat==='micro')h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">&#9888; Micro caps are extremely high risk. Position size should be &lt;2% of portfolio. Many will fail — diversification is essential.</div>`;
if(isPenny)h+=`<div style="font-size:9px;color:var(--red);margin-top:6px;padding:6px 10px;border-radius:6px;background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.1)">&#9888; <strong>EXTREME RISK:</strong> Penny stocks can lose 50-90% of value. These are speculative bets, not investments. Never allocate more than 1-2% of your portfolio. Do your own due diligence. Prices are approximate and change rapidly.</div>`;
el.innerHTML=h;
// ═══ FETCH LIVE PRICES for displayed stocks ═══
fetchLivePricesForPicks(el);
}

let _livePriceCache={};
let _fetchDebounce=null;
async function fetchLivePricesForPicks(container){
// Debounce — if user switches tabs rapidly, only last one fires
if(_fetchDebounce)clearTimeout(_fetchDebounce);
await new Promise(r=>{_fetchDebounce=setTimeout(r,150)});
const cells=container.querySelectorAll('td[data-ticker][data-col="cmp"]');
if(!cells.length)return;
const tickers=[...new Set([...cells].map(c=>c.dataset.ticker).filter(t=>t&&t!=='INDEX'&&t.length>1&&/^[A-Z0-9.\-]+$/.test(t)))];
if(!tickers.length){cells.forEach(c=>{if(!c.dataset.ticker||c.dataset.ticker==='INDEX')c.innerHTML='—'});return}
// Check memory cache first (2 min freshness)
const now=Date.now();
const uncached=tickers.filter(t=>!_livePriceCache[t]||now-_livePriceCache[t].ts>120000);
if(uncached.length>0){
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:uncached})});
const data=await res.json();
if(data.success&&data.prices){
Object.entries(data.prices).forEach(([tk,v])=>{_livePriceCache[tk]={...v,ts:now}});
}
}catch(e){console.warn('Batch prices failed:',e)}
}
// Update all cells
let loadedCount=0;
cells.forEach(cell=>{
const tk=cell.dataset.ticker;
const cached=_livePriceCache[tk];
if(cached){
loadedCount++;
const up=cached.change_pct>=0;
cell.innerHTML=`${cached.formatted} <span style="font-size:8px;color:${up?'var(--green)':'var(--red)'}">LIVE ${up?'▲':'▼'}${Math.abs(cached.change_pct).toFixed(1)}%</span>`;
cell.style.color=up?'var(--green)':'var(--red)';
}else{
cell.innerHTML=`<span style="font-size:9px;color:var(--text3);cursor:pointer" onclick="fetchLivePricesForPicks(this.closest('table').parentElement)">⚠️ tap to retry</span>`;
}
});
console.log(`Live prices: ${loadedCount}/${cells.length} loaded`);
}

// ═══════════════════════════════════════════════
// ═══ CONVICTION LEADERBOARD — Top 5 by category per country ═══
const CONVICTION_DATA={
india:{
  buy:[
    {n:'Bajaj Finance',t:'BAJFINANCE.NS',why:'NBFC leader, 25%+ ROE, fortress balance sheet, digital lending moat',s:72},
    {n:'Trent Limited',t:'TRENT.NS',why:'Zudio growth engine, Zara India exclusivity, 40%+ revenue CAGR',s:68},
    {n:'Dixon Technologies',t:'DIXON.NS',why:'PLI beneficiary, electronics mfg monopoly, backward integration',s:65},
    {n:'CDSL',t:'CDSL.NS',why:'Demat duopoly, zero-debt, 60%+ margins, financialization tailwind',s:64},
    {n:'Persistent Systems',t:'PERSISTENT.NS',why:'Healthcare IT niche, 20%+ revenue growth, high IP business',s:62}
  ],
  sell:[
    {n:'Vodafone Idea',t:'IDEA.NS',why:'Massive debt, negative cash flow, subscriber loss to Jio/Airtel',s:-45},
    {n:'IRCTC',t:'IRCTC.NS',why:'Govt interference risk, margin pressure, overvalued vs growth',s:-28},
    {n:'Paytm',t:'PAYTM.NS',why:'Path to profitability unclear, regulatory overhang, cash burn',s:-32},
    {n:'Zee Entertainment',t:'ZEEL.NS',why:'Merger uncertainty, debt concerns, ad revenue pressure',s:-25},
    {n:'GMR Airports',t:'GMRINFRA.NS',why:'Heavy debt, capex cycle years out, dilution risk',s:-22}
  ],
  accumulate:[
    {n:'HDFC Bank',t:'HDFCBANK.NS',why:'Post-merger stabilizing, best asset quality, CASA franchise',s:45},
    {n:'Infosys',t:'INFY.NS',why:'Margin recovery, AI services ramp, attractive at 22-24x PE',s:42},
    {n:'Tata Motors',t:'TATAMOTORS.NS',why:'JLR turnaround, EV push, domestic CV leadership',s:40},
    {n:'ITC',t:'ITC.NS',why:'Hotel demerger value unlock, FMCG scaling, high dividend yield',s:38},
    {n:'Asian Paints',t:'ASIANPAINT.NS',why:'Correction from highs, moat intact, rural recovery play',s:35}
  ]
},
usa:{
  buy:[
    {n:'NVIDIA',t:'NVDA',why:'AI compute monopoly, 70%+ data center growth, CUDA moat',s:78},
    {n:'Microsoft',t:'MSFT',why:'Azure + Copilot AI, 40%+ cloud margins, enterprise dominance',s:70},
    {n:'CrowdStrike',t:'CRWD',why:'Cloud-native security leader, 75%+ gross margins, expanding TAM',s:65},
    {n:'Palantir',t:'PLTR',why:'AI/government platform, 30%+ revenue growth, profitable',s:62},
    {n:'Alphabet',t:'GOOGL',why:'Search + Cloud + Waymo, 15x forward FCF, AI integration',s:60}
  ],
  sell:[
    {n:'Snap Inc',t:'SNAP',why:'User growth stalled, ad revenue pressure, negative FCF',s:-38},
    {n:'Beyond Meat',t:'BYND',why:'Revenue declining, cash burn, management exodus',s:-52},
    {n:'Peloton',t:'PTON',why:'Subscription churn, hardware obsolescence, debt burden',s:-42},
    {n:'Rivian',t:'RIVN',why:'Massive cash burn, production delays, capital raise dilution',s:-35},
    {n:'ChargePoint',t:'CHPT',why:'EV charging commoditized, negative gross margins, cash runway risk',s:-40}
  ],
  accumulate:[
    {n:'Apple',t:'AAPL',why:'Services flywheel, $100B+ buybacks, AI iPhone super cycle',s:48},
    {n:'Amazon',t:'AMZN',why:'AWS re-acceleration, retail margins expanding, AI + ads',s:46},
    {n:'Meta Platforms',t:'META',why:'Reels monetization, Reality Labs optionality, cheap on FCF',s:44},
    {n:'Visa',t:'V',why:'Payment duopoly, 65%+ net margins, cross-border recovery',s:42},
    {n:'UnitedHealth',t:'UNH',why:'Healthcare oligopoly, Optum vertical, consistent 15% EPS growth',s:40}
  ]
}};

let _convGeo='india';
function showConvGeo(btn,geo){
_convGeo=geo;
document.querySelectorAll('#convGeoTabs .ptab').forEach(b=>{b.classList.remove('active');b.style.background='var(--surface)';b.style.color='var(--text2)';b.style.borderColor='var(--border)'});
btn.classList.add('active');btn.style.background='var(--amber)';btn.style.color='#000';btn.style.borderColor='var(--amber)';
renderConviction();
}

function renderConviction(){
const el=document.getElementById('convGrid');if(!el)return;
const d=CONVICTION_DATA[_convGeo];if(!d){el.innerHTML='';return}
function card(title,emoji,stocks,color,bgColor){
let h=`<div style="border-radius:10px;overflow:hidden;border:1px solid ${color}22;background:${bgColor}">`;
h+=`<div style="padding:10px 12px;background:${color}15;border-bottom:1px solid ${color}22;display:flex;align-items:center;gap:6px">`;
h+=`<span style="font-size:16px">${emoji}</span>`;
h+=`<span style="font-family:'Sora',sans-serif;font-size:11px;font-weight:800;color:${color}">${title}</span>`;
h+=`<span style="margin-left:auto;font-size:9px;font-weight:700;color:${color};background:${color}12;padding:1px 6px;border-radius:3px">TOP 5</span></div>`;
stocks.forEach((s,i)=>{
h+=`<div style="padding:8px 12px;border-bottom:1px solid rgba(0,0,0,.04);font-size:11px${i===4?';border-bottom:none':''}">`;
h+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">`;
h+=`<span style="font-size:10px;font-weight:800;color:${color};background:${color}15;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border-radius:50%">${i+1}</span>`;
h+=`<strong style="font-size:11px;color:var(--text);cursor:pointer" onclick="quickAnalyze('${s.t}')">${s.n}</strong>`;
h+=`<span style="font-family:var(--mono);font-size:9px;color:var(--text3)">${s.t}</span>`;
h+=`<span data-conv-ticker="${s.t}" style="margin-left:auto;font-family:var(--mono);font-size:10px;color:var(--text3)">⏳</span>`;
h+=`</div>`;
h+=`<div style="font-size:10px;color:var(--text3);line-height:1.4">${s.why}</div>`;
h+=`</div>`;
});
return h+'</div>';
}
el.innerHTML=
  card('AGGRESSIVE BUY','\u{1F7E2}',d.buy,'#14a23a','rgba(20,162,58,.02)')+
  card('ACCUMULATE','\u{1F7E1}',d.accumulate,'#d48a00','rgba(212,138,0,.02)')+
  card('SELL / AVOID','\u{1F534}',d.sell,'#d0021b','rgba(208,2,27,.02)');
// Fetch live prices for conviction stocks
fetchConvictionPrices();
}

async function fetchConvictionPrices(){
const cells=document.querySelectorAll('[data-conv-ticker]');
if(!cells.length)return;
const tickers=[...new Set([...cells].map(c=>c.dataset.convTicker).filter(Boolean))];
if(!tickers.length)return;
const now=Date.now();
const uncached=tickers.filter(t=>!_livePriceCache[t]||now-_livePriceCache[t].ts>120000);
if(uncached.length>0){
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:uncached})});
const data=await res.json();
if(data.success&&data.prices){Object.entries(data.prices).forEach(([tk,v])=>{_livePriceCache[tk]={...v,ts:now}})}
}catch(e){}
}
cells.forEach(cell=>{
const tk=cell.dataset.convTicker;
const c=_livePriceCache[tk];
if(c){
const up=c.change_pct>=0;
cell.innerHTML=`${c.formatted} <span style="color:${up?'var(--green)':'var(--red)'}">${up?'▲':'▼'}${Math.abs(c.change_pct).toFixed(1)}%</span>`;
cell.style.color=up?'var(--green)':'var(--red)';cell.style.fontWeight='700';
}else{cell.textContent='—'}
});
}

// Auto-render on page load
setTimeout(renderConviction,100);

// ETF & MUTUAL FUND DATA — 25%+ CAGR COMPOUNDERS
// ═══════════════════════════════════════════════
// yfinance ticker mapping for live NAV
const FUND_YF_MAP={
'QQQ':'QQQ','SMH':'SMH','SOXX':'SOXX','VGT':'VGT','AIQ':'AIQ',
'FCNTX':'FCNTX','TRBCX':'TRBCX','FDGRX':'FDGRX','BPTIX':'BPTIX','VIGAX':'VIGAX',
'MON100':'MOTILALOFSP.NS','JUNIORBEES':'JUNIORBEES.NS',
'NETFIT':'NETFNIFTYIT.NS','ICICIN50':'NIFTYBEES.NS','MAFANG':'MAFANG.NS'
};
const FUND_DATA={
etf_in:{title:'India ETFs — Top Performers',data:[
{n:'Motilal Oswal NASDAQ 100 ETF',t:'MON100',aum:'₹5,800 Cr',exp:'0.58%',y1:'28.4%',y3:'14.2%',y5:'27.1%',y10:'22.8%',dd:'-32%',rec:'4 months',corr:'Hedges INR depreciation, US tech exposure',r:'★ Aggressive Buy',risk:'High',cat:'US Tech Proxy'},
{n:'Nippon India ETF Nifty IT',t:'NETFIT',aum:'₹2,100 Cr',exp:'0.21%',y1:'22.1%',y3:'10.5%',y5:'25.8%',y10:'20.4%',dd:'-28%',rec:'5 months',corr:'IT exports benefit from weak rupee, recession hedge',r:'Strong Buy',risk:'Medium-High',cat:'Sector ETF'},
{n:'ICICI Pru Nifty Next 50 ETF',t:'ICICIN50',aum:'₹1,600 Cr',exp:'0.15%',y1:'35.2%',y3:'22.8%',y5:'26.3%',y10:'18.5%',dd:'-35%',rec:'7 months',corr:'Future large-caps, strong SIP alpha over Nifty 50',r:'Strong Buy',risk:'Medium-High',cat:'Mid-Large Cap'},
{n:'Mirae Asset NYSE FANG+ ETF',t:'MAFANG',aum:'₹3,200 Cr',exp:'0.66%',y1:'32.5%',y3:'16.1%',y5:'29.4%',y10:'—',dd:'-38%',rec:'5 months',corr:'Concentrated mega-tech, high beta but fastest recovery',r:'Buy',risk:'High',cat:'US FANG+'},
{n:'Nippon India ETF Junior BeES',t:'JUNIORBEES',aum:'₹4,200 Cr',exp:'0.20%',y1:'33.8%',y3:'21.6%',y5:'25.1%',y10:'17.9%',dd:'-36%',rec:'8 months',corr:'Nifty Next 50 tracks emerging blue-chips, outperforms in bull runs',r:'Strong Buy',risk:'Medium',cat:'Next 50'}
]},
mf_in:{title:'India Mutual Funds — Wealth Compounders',data:[
{n:'Quant Small Cap Fund',t:'QUANT-SC',aum:'₹26,800 Cr',exp:'0.62%',y1:'25.1%',y3:'25.4%',y5:'42.8%',y10:'24.6%',dd:'-42%',rec:'4 months',corr:'Fastest recovery in COVID. Quant model exits before crashes, re-enters early. Momentum + contrarian hybrid.',r:'★ Aggressive Buy',risk:'Very High',cat:'Small Cap'},
{n:'Nippon India Small Cap Fund',t:'NIPPON-SC',aum:'₹62,000 Cr',exp:'0.68%',y1:'22.8%',y3:'26.1%',y5:'38.5%',y10:'26.2%',dd:'-38%',rec:'5 months',corr:'Largest small-cap fund. Diversified across 150+ stocks. Lower concentration risk despite high AUM.',r:'★ Aggressive Buy',risk:'Very High',cat:'Small Cap'},
{n:'Quant Mid Cap Fund',t:'QUANT-MC',aum:'₹9,200 Cr',exp:'0.57%',y1:'18.4%',y3:'24.8%',y5:'35.2%',y10:'22.1%',dd:'-35%',rec:'3 months',corr:'Quant timing model excels. Reduced equity to 65% before 2022 correction. Fastest drawdown recovery.',r:'Strong Buy',risk:'High',cat:'Mid Cap'},
{n:'SBI Small Cap Fund',t:'SBI-SC',aum:'₹33,500 Cr',exp:'0.66%',y1:'24.2%',y3:'22.6%',y5:'30.4%',y10:'27.8%',dd:'-36%',rec:'6 months',corr:'Conservative small-cap. Higher quality bias. Lower drawdown vs peers due to balance sheet screening.',r:'Strong Buy',risk:'High',cat:'Small Cap'},
{n:'Parag Parikh Flexi Cap Fund',t:'PPFAS',aum:'₹82,000 Cr',exp:'0.63%',y1:'24.6%',y3:'19.2%',y5:'27.8%',y10:'21.4%',dd:'-25%',rec:'3 months',corr:'30% global allocation hedges India risk. Held Google/Amazon through 2022. Lowest drawdown in category.',r:'★ Aggressive Buy',risk:'Medium',cat:'Flexi Cap'},
{n:'HDFC Mid-Cap Opportunities',t:'HDFC-MC',aum:'₹75,000 Cr',exp:'0.72%',y1:'26.1%',y3:'28.5%',y5:'32.4%',y10:'22.8%',dd:'-30%',rec:'5 months',corr:'Largest mid-cap. Track record since 2007. Survived 3 bear markets. Quality-growth stock picking.',r:'Strong Buy',risk:'High',cat:'Mid Cap'},
{n:'Canara Robeco Small Cap Fund',t:'CANROB-SC',aum:'₹12,400 Cr',exp:'0.42%',y1:'28.4%',y3:'24.1%',y5:'34.6%',y10:'—',dd:'-33%',rec:'4 months',corr:'Lowest expense ratio in category. Systematic stock selection. Outperforms in rising markets.',r:'Buy',risk:'High',cat:'Small Cap'}
]},
etf_us:{title:'USA ETFs — Growth & Sector Leaders',data:[
{n:'Invesco QQQ Trust',t:'QQQ',aum:'$312B',exp:'0.20%',y1:'26.8%',y3:'11.4%',y5:'22.1%',y10:'20.4%',dd:'-33%',rec:'6 months',corr:'NASDAQ-100. Top 100 non-financial. Heavy mega-tech. Best liquidity. Quick recovery from every correction.',r:'★ Aggressive Buy',risk:'Medium-High',cat:'Large Cap Tech'},
{n:'VanEck Semiconductor ETF',t:'SMH',aum:'$28B',exp:'0.35%',y1:'35.2%',y3:'28.6%',y5:'32.8%',y10:'28.4%',dd:'-38%',rec:'5 months',corr:'AI capex cycle drives demand. NVDA+TSM+ASML = 35% weight. Secular growth from AI/auto/cloud.',r:'★ Aggressive Buy',risk:'High',cat:'Semiconductor'},
{n:'iShares Semiconductor ETF',t:'SOXX',aum:'$16B',exp:'0.35%',y1:'30.1%',y3:'24.2%',y5:'28.6%',y10:'25.1%',dd:'-36%',rec:'5 months',corr:'More equal-weighted than SMH. Better diversification. Includes AMD, MRVL, ON Semi. Less NVDA-dependent.',r:'Strong Buy',risk:'High',cat:'Semiconductor'},
{n:'Vanguard Info Technology ETF',t:'VGT',aum:'$85B',exp:'0.10%',y1:'28.4%',y3:'14.8%',y5:'24.2%',y10:'22.1%',dd:'-30%',rec:'5 months',corr:'Broadest tech exposure. Apple+MSFT = 35%. Ultra-low expense. Outperforms S&P by 6%+ annually.',r:'Strong Buy',risk:'Medium-High',cat:'Tech Sector'},
{n:'Global X AI & Technology ETF',t:'AIQ',aum:'$2.8B',exp:'0.68%',y1:'22.5%',y3:'12.8%',y5:'25.4%',y10:'—',dd:'-35%',rec:'6 months',corr:'Pure AI play. Includes infra (NVDA), platform (MSFT), application (CRM) layers. Secular AI capex theme.',r:'Buy',risk:'High',cat:'AI Theme'}
]},
mf_us:{title:'USA Funds — Institutional Grade',data:[
{n:'Fidelity Contrafund',t:'FCNTX',aum:'$149B',exp:'0.39%',y1:'32.4%',y3:'14.2%',y5:'22.8%',y10:'18.4%',dd:'-28%',rec:'5 months',corr:'Legendary active fund. Will Danoff since 1990. Consistently beats S&P. Low turnover = tax efficient.',r:'Strong Buy',risk:'Medium',cat:'Large Cap Growth'},
{n:'T. Rowe Price Blue Chip Growth',t:'TRBCX',aum:'$62B',exp:'0.57%',y1:'36.2%',y3:'10.8%',y5:'20.6%',y10:'17.8%',dd:'-38%',rec:'7 months',corr:'High-conviction growth. Concentrated top 10. Higher drawdown but faster alpha generation in recoveries.',r:'Buy',risk:'Medium-High',cat:'Large Cap Growth'},
{n:'Fidelity Growth Company',t:'FDGRX',aum:'$68B',exp:'0.52%',y1:'38.1%',y3:'14.6%',y5:'25.2%',y10:'21.6%',dd:'-35%',rec:'5 months',corr:'Mid+Large growth blend. Discovers winners early. NVDA was top pick in 2019. Exceptional stock selection.',r:'★ Aggressive Buy',risk:'High',cat:'Multi-Cap Growth'},
{n:'Baron Partners Fund',t:'BPTIX',aum:'$9.8B',exp:'1.04%',y1:'22.8%',y3:'12.1%',y5:'28.4%',y10:'22.4%',dd:'-40%',rec:'6 months',corr:'Concentrated + leveraged. 30% TSLA at peak. Highest conviction. Massive alpha in bull markets.',r:'Accumulate',risk:'Very High',cat:'Concentrated'},
{n:'Vanguard Growth Index Fund',t:'VIGAX',aum:'$248B',exp:'0.05%',y1:'30.2%',y3:'12.8%',y5:'22.4%',y10:'18.8%',dd:'-30%',rec:'5 months',corr:'Cheapest growth fund. Market-cap weighted. Zero stock-picking risk. Pure growth factor exposure.',r:'Strong Buy',risk:'Medium',cat:'Growth Index'}
]},
};

function showFundCat(btn,cat){
document.querySelectorAll('#fundTabs .ptab').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
renderFunds(cat);
}

function renderFunds(cat){
const el=document.getElementById('fundGrid');
if(!el)return;

if(cat==='compare'){
renderFundComparison();return;
}

const d=FUND_DATA[cat];
if(!d){el.innerHTML='';return}
let h=`<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px">${d.title}</div>`;

// Main performance table
h+=`<div style="overflow-x:auto"><table class="pick-tbl">
<tr>
<th>#</th><th>Fund</th><th>Rating</th><th>Live NAV</th><th>AUM</th><th>Exp%</th>
<th style="color:var(--text3)">1Y</th><th style="color:var(--amber)">3Y</th><th style="color:var(--green)">5Y</th><th style="color:var(--green)">10Y</th>
<th style="color:var(--red)">Max DD</th><th>Recovery</th><th>Risk</th>
</tr>`;
d.data.forEach((f,i)=>{
const rt=f.r||'Buy';
const rC=rt.includes('Aggressive')?'#10b981':rt.includes('Strong')?'#10b981':rt==='Buy'?'#3b82f6':'#f59e0b';
const rBg=rt.includes('Aggressive')?'rgba(16,185,129,.15)':rt.includes('Strong')?'rgba(16,185,129,.08)':rt==='Buy'?'rgba(0,120,212,.08)':'rgba(245,158,11,.08)';
const riskC=f.risk.includes('Very')?'var(--red)':f.risk.includes('High')?'var(--amber)':'var(--green)';
const y5n=parseFloat(f.y5)||0;
const y5C=y5n>=30?'var(--green)':y5n>=25?'#22d3ee':'var(--amber)';
const y10n=parseFloat(f.y10)||0;
const y10C=y10n>=25?'var(--green)':y10n>=20?'#22d3ee':'var(--text2)';
h+=`<tr>
<td style="color:var(--text3);font-weight:700">${i+1}</td>
<td><div class="cname">${f.n}</div><div class="csub">${f.t} · ${f.cat}</div></td>
<td><span style="font-size:9px;padding:2px 6px;border-radius:4px;background:${rBg};color:${rC};font-weight:700;white-space:nowrap">${rt}</span></td>
<td data-fund-ticker="${f.t}" style="font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap">${FUND_YF_MAP[f.t]?'⏳':'—'}</td>
<td style="font-size:10px;color:var(--cyan);white-space:nowrap">${f.aum}</td>
<td style="font-size:10px;color:var(--text3)">${f.exp}</td>
<td style="font-size:10px;color:var(--text2)">${f.y1}</td>
<td style="font-size:10px;color:var(--amber);font-weight:600">${f.y3}</td>
<td style="font-size:11px;color:${y5C};font-weight:700">${f.y5}</td>
<td style="font-size:11px;color:${y10C};font-weight:700">${f.y10}</td>
<td style="font-size:10px;color:var(--red);font-weight:600">${f.dd}</td>
<td style="font-size:10px;color:var(--text2)">${f.rec}</td>
<td style="font-size:9px;color:${riskC};font-weight:600">${f.risk}</td>
</tr>`;
});
h+=`</table></div>`;

// Correction resilience cards
h+=`<div style="margin-top:14px;font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--amber);letter-spacing:.5px;margin-bottom:8px">&#128737; CORRECTION RESILIENCE ANALYSIS</div>`;
h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px">`;
d.data.forEach(f=>{
const ddn=Math.abs(parseInt(f.dd))||30;
const resC=ddn<=28?'var(--green)':ddn<=35?'var(--amber)':'var(--red)';
const recM=parseInt(f.rec)||5;
const recC=recM<=4?'var(--green)':recM<=6?'var(--amber)':'var(--red)';
h+=`<div style="padding:8px 10px;border-radius:6px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="font-weight:700;color:var(--text);font-size:11px;margin-bottom:4px">${f.n}</div>
<div style="display:flex;gap:8px;margin-bottom:4px">
<span style="font-size:9px;color:${resC};font-weight:700">DD: ${f.dd}</span>
<span style="font-size:9px;color:${recC};font-weight:700">Rec: ${f.rec}</span>
</div>
<div style="font-size:9px;color:var(--text3);line-height:1.5">${f.corr}</div>
</div>`;
});
h+=`</div>`;
h+=`<div style="font-size:9px;color:var(--text3);margin-top:8px">* Returns are CAGR (compound annual growth rate). Max DD = maximum drawdown during COVID/2022. Recovery = time to reach pre-crash levels. Past performance does not guarantee future results.</div>`;
el.innerHTML=h;
// Fetch live NAV for funds with yfinance tickers
fetchFundNAVs(el);
}

async function fetchFundNAVs(container){
const cells=container.querySelectorAll('td[data-fund-ticker]');
if(!cells.length)return;
const tickerPairs=[];
cells.forEach(c=>{
const ft=c.dataset.fundTicker;
const yft=FUND_YF_MAP[ft];
if(yft)tickerPairs.push({cell:c,yf:yft,ft:ft});
});
if(!tickerPairs.length)return;
const yfTickers=[...new Set(tickerPairs.map(p=>p.yf))];
const now=Date.now();
const uncached=yfTickers.filter(t=>!_livePriceCache[t]||now-_livePriceCache[t].ts>120000);
if(uncached.length>0){
try{
const res=await fetch('/api/batch-prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tickers:uncached})});
const data=await res.json();
if(data.success&&data.prices){Object.entries(data.prices).forEach(([tk,v])=>{_livePriceCache[tk]={...v,ts:now}})}
}catch(e){}
}
tickerPairs.forEach(p=>{
const c=_livePriceCache[p.yf];
if(c){
const up=c.change_pct>=0;
p.cell.innerHTML=`<span style="font-weight:700;color:${up?'var(--green)':'var(--red)'}">${c.formatted}</span> <span style="font-size:8px;color:${up?'var(--green)':'var(--red)'}">${up?'▲':'▼'}${Math.abs(c.change_pct).toFixed(1)}%</span>`;
}else{p.cell.textContent='—'}
});
}

function renderFundComparison(){
const el=document.getElementById('fundGrid');
if(!el)return;
let h='';

// Head-to-head comparison
h+=`<div style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px">&#128202; Head-to-Head: Best-in-Class Comparison</div>`;
const cmp=[
{cat:'Small Cap (India)',a:'Quant Small Cap',b:'Nippon Small Cap',a5:'42.8%',b5:'38.5%',add:'-42% / 4mo',bdd:'-38% / 5mo',av:'Quant model timing, faster recovery',bv:'Broader diversification (150+ stocks), lower concentration risk',pick:'Quant for aggression, Nippon for stability'},
{cat:'Mid Cap (India)',a:'Quant Mid Cap',b:'HDFC Mid-Cap Opp',a5:'35.2%',b5:'32.4%',add:'-35% / 3mo',bdd:'-30% / 5mo',av:'Fastest recovery, quantitative timing model',bv:'Proven since 2007, 3 bear markets survived, quality bias',pick:'HDFC for track record, Quant for alpha'},
{cat:'Flexi/Multi (India)',a:'Parag Parikh Flexi',b:'SBI Small Cap',a5:'27.8%',b5:'30.4%',add:'-25% / 3mo',bdd:'-36% / 6mo',av:'Lowest drawdown, 30% global hedge, all-weather fund',bv:'Higher returns but higher volatility, pure India small-cap bet',pick:'Parag Parikh for correction-proof SIP'},
{cat:'Semiconductor (USA)',a:'SMH',b:'SOXX',a5:'32.8%',b5:'28.6%',add:'-38% / 5mo',bdd:'-36% / 5mo',av:'NVDA+TSM heavy = higher beta, AI capex direct play',bv:'More equal-weighted, less single-stock risk, broader chip exposure',pick:'SMH for conviction, SOXX for diversification'},
{cat:'Tech Broad (USA)',a:'QQQ',b:'VGT',a5:'22.1%',b5:'24.2%',add:'-33% / 6mo',bdd:'-30% / 5mo',av:'Top 100 non-financial NASDAQ, highest liquidity, options available',bv:'Lower cost (0.10%), tighter tech focus, slightly better long-term CAGR',pick:'VGT for pure tech, QQQ for breadth + options'},
{cat:'Active vs Index (USA)',a:'Fidelity Growth Co',b:'Vanguard Growth Idx',a5:'25.2%',b5:'22.4%',add:'-35% / 5mo',bdd:'-30% / 5mo',av:'Stock picker alpha, early NVDA bet, discovers winners before index',bv:'0.05% expense, zero manager risk, tax efficient, no underperformance risk',pick:'FDGRX for alpha seekers, VIGAX for passive wealth'}
];
h+=`<div style="overflow-x:auto"><table class="pick-tbl">
<tr><th>Category</th><th>Fund A</th><th>Fund B</th><th>5Y CAGR</th><th>Max DD / Recovery</th><th>A Advantage</th><th>B Advantage</th><th style="color:var(--green)">Verdict</th></tr>`;
cmp.forEach(c=>{
h+=`<tr>
<td style="font-weight:700;color:var(--amber);font-size:10px;white-space:nowrap">${c.cat}</td>
<td style="font-weight:600;font-size:10px">${c.a}</td>
<td style="font-weight:600;font-size:10px">${c.b}</td>
<td style="font-size:10px"><span style="color:var(--green);font-weight:700">${c.a5}</span> vs <span style="color:var(--cyan)">${c.b5}</span></td>
<td style="font-size:9px;color:var(--red)">${c.add}<br>${c.bdd}</td>
<td style="font-size:9px;color:var(--text2)">${c.av}</td>
<td style="font-size:9px;color:var(--text2)">${c.bv}</td>
<td style="font-size:9px;color:var(--green);font-weight:700">${c.pick}</td>
</tr>`;
});
h+=`</table></div>`;

// SIP Strategy
h+=`<div style="margin-top:16px;padding:12px 14px;border-radius:8px;background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(59,130,246,.04));border:1px solid rgba(16,185,129,.15)">
<div style="font-family:'Sora',sans-serif;font-size:11px;font-weight:700;color:var(--green);margin-bottom:6px">&#127919; CORRECTION-PROOF SIP ALLOCATION (30-40% crash survival)</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;font-size:10px;color:var(--text2);line-height:1.6">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03);border-left:3px solid var(--green)"><strong style="color:var(--green)">AGGRESSIVE (Age &lt;35)</strong><br>40% Quant/Nippon Small Cap<br>25% SMH/SOXX Semiconductor<br>20% Parag Parikh Flexi<br>15% QQQ/NASDAQ 100<br><span style="color:var(--text3)">Expected: 28-35% CAGR · Max DD: -40%</span></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03);border-left:3px solid var(--amber)"><strong style="color:var(--amber)">BALANCED (Age 35-50)</strong><br>30% HDFC/SBI Mid-Small Cap<br>25% Parag Parikh Flexi<br>20% VGT/QQQ<br>15% Nifty Next 50 ETF<br>10% Gold ETF (hedge)<br><span style="color:var(--text3)">Expected: 22-28% CAGR · Max DD: -32%</span></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03);border-left:3px solid var(--blue)"><strong style="color:var(--blue)">CONSERVATIVE (Age 50+)</strong><br>30% Parag Parikh Flexi<br>25% Nifty 50 ETF<br>20% Vanguard Growth Idx<br>15% Balanced Advantage<br>10% Gold + Debt<br><span style="color:var(--text3)">Expected: 16-22% CAGR · Max DD: -25%</span></div>
</div>
</div>`;

h+=`<div style="margin-top:10px;font-size:9px;color:var(--text3)">* All CAGR figures are trailing returns as of latest available data. Max drawdown measured from COVID-19 (Mar 2020) or 2022 bear market, whichever was deeper. This is educational analysis — consult your financial advisor for personalized allocation.</div>`;
el.innerHTML=h;
}

// ═══════════════════════════════════════════════
// TRADE SCORECARD — Validate past trades vs actual
// ═══════════════════════════════════════════════
// ═══════════════════════════════════════════════
// PORTFOLIO DECISION ENGINE — Standalone ticker + buy price analysis
// Uses /api/stock-quick for instant data, then runs multi-factor algorithm
// ═══════════════════════════════════════════════
async function runPortfolioDecision(){
const tickerEl=document.getElementById('pdTicker');
const bpEl=document.getElementById('pdBuyPrice');
const resEl=document.getElementById('pdResult');
const btn=document.getElementById('pdBtn');
if(!tickerEl||!bpEl||!resEl)return;
const ticker=tickerEl.value.trim().toUpperCase();
const buyPrice=parseFloat(bpEl.value);
if(!ticker){resEl.innerHTML='<div style="font-size:11px;color:var(--red)">Enter a ticker symbol.</div>';return}
if(!buyPrice||buyPrice<=0){resEl.innerHTML='<div style="font-size:11px;color:var(--red)">Enter your buy price.</div>';return}
btn.disabled=true;btn.textContent='Fetching data...';
resEl.innerHTML='<div style="text-align:center;padding:12px;color:var(--text3)"><div style="display:inline-block;width:16px;height:16px;border:2px solid var(--blue);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div> Fetching live data for '+ticker+'...</div>';
try{
const res=await fetch(`/api/stock-quick?ticker=${encodeURIComponent(ticker)}`);
const data=await res.json();
if(!data.success){resEl.innerHTML=`<div style="font-size:11px;color:var(--red)">${data.error||'Failed to fetch data'}</div>`;return}
// Run the same multi-factor algorithm
const d=data;
const curr=d.currency==='INR'?'₹':'$';
const price=d.current_price;
const n=v=>{const f=parseFloat(v);return(isNaN(f)||v==='N/A')?0:f};
const pe=n(d.pe_ratio),fpe=n(d.forward_pe),pb=n(d.pb_ratio),pm=n(d.profit_margin),roe=n(d.roe);
const beta=n(d.beta)||1,dy=n(d.dividend_yield),hi=n(d.week52_high),lo=n(d.week52_low);
const w52pct=hi>lo?((price-lo)/(hi-lo)):0.5;
const sma20=n(d.sma_20),sma50=n(d.sma_50),sma200=n(d.sma_200);
const epsGrowth=n(d.eps_growth_pct),revGrowth=n(d.revenue_growth),earningsGrowth=n(d.earnings_growth);
const sectorPE=n(d.sector_avg_pe)||20;
const pnl=((price-buyPrice)/buyPrice)*100;
let score=0;const factors=[];
// F2: Valuation
if(pe>0&&pe<12){score+=8;factors.push({f:'Deeply undervalued (P/E '+pe.toFixed(1)+'x)',s:'+8',c:'g'})}
else if(pe>0&&pe<18){score+=5;factors.push({f:'Fair value (P/E '+pe.toFixed(1)+'x)',s:'+5',c:'g'})}
else if(pe>0&&pe<28){score+=2;factors.push({f:'Reasonably priced (P/E '+pe.toFixed(1)+'x)',s:'+2',c:'b'})}
else if(pe>=28&&pe<50){score-=3;factors.push({f:'Expensive (P/E '+pe.toFixed(1)+'x)',s:'-3',c:'r'})}
else if(pe>=50){score-=6;factors.push({f:'Very expensive (P/E '+pe.toFixed(1)+'x)',s:'-6',c:'r'})}
// F3: 52W
if(w52pct<0.15){score+=6;factors.push({f:'Near 52W low ('+Math.round(w52pct*100)+'%)',s:'+6',c:'g'})}
else if(w52pct<0.35){score+=3;factors.push({f:'Lower range ('+Math.round(w52pct*100)+'%)',s:'+3',c:'g'})}
else if(w52pct>0.9){score-=4;factors.push({f:'Near 52W high ('+Math.round(w52pct*100)+'%)',s:'-4',c:'r'})}
else if(w52pct>0.75){score-=1;factors.push({f:'Upper range ('+Math.round(w52pct*100)+'%)',s:'-1',c:'a'})}
else{score+=1;factors.push({f:'Mid-range ('+Math.round(w52pct*100)+'%)',s:'+1',c:'b'})}
// F4: Margins
if(pm>20){score+=4;factors.push({f:'Strong margins ('+pm.toFixed(1)+'%)',s:'+4',c:'g'})}
else if(pm>10){score+=2;factors.push({f:'Decent margins ('+pm.toFixed(1)+'%)',s:'+2',c:'b'})}
else if(pm>0){factors.push({f:'Thin margins ('+pm.toFixed(1)+'%)',s:'0',c:'a'})}
else if(pm<0){score-=3;factors.push({f:'Negative margins ('+pm.toFixed(1)+'%)',s:'-3',c:'r'})}
// F5: ROE
if(roe>20){score+=3;factors.push({f:'Excellent ROE ('+roe.toFixed(1)+'%)',s:'+3',c:'g'})}
else if(roe>12){score+=1;factors.push({f:'Good ROE ('+roe.toFixed(1)+'%)',s:'+1',c:'b'})}
else if(roe<5&&roe>0){score-=2;factors.push({f:'Poor ROE ('+roe.toFixed(1)+'%)',s:'-2',c:'r'})}
// F6: Dividend
if(dy>4){score+=3;factors.push({f:'High yield ('+dy.toFixed(1)+'%)',s:'+3',c:'g'})}
else if(dy>2){score+=1;factors.push({f:'Moderate yield ('+dy.toFixed(1)+'%)',s:'+1',c:'b'})}
// F7: Beta
if(beta>1.5){score-=2;factors.push({f:'High volatility (β '+beta.toFixed(2)+')',s:'-2',c:'r'})}
else if(beta<0.8){score+=2;factors.push({f:'Low volatility (β '+beta.toFixed(2)+')',s:'+2',c:'g'})}
// F8: P&L
if(pnl>50){score-=2;factors.push({f:'Large gain '+pnl.toFixed(1)+'% — partial booking',s:'-2',c:'a'})}
else if(pnl>20){factors.push({f:'Healthy gain '+pnl.toFixed(1)+'%',s:'0',c:'g'})}
else if(pnl>0){score+=2;factors.push({f:'Small gain '+pnl.toFixed(1)+'%',s:'+2',c:'g'})}
else if(pnl>-10){score+=1;factors.push({f:'Minor loss '+pnl.toFixed(1)+'%',s:'+1',c:'b'})}
else if(pnl>-25){factors.push({f:'Loss '+pnl.toFixed(1)+'%',s:'0',c:'a'})}
else{score-=2;factors.push({f:'Deep loss '+pnl.toFixed(1)+'%',s:'-2',c:'r'})}
// F9: Earnings Velocity
const bestEpsG=epsGrowth||earningsGrowth;
const combGrowth=bestEpsG&&revGrowth?(bestEpsG*0.6+revGrowth*0.4):bestEpsG||revGrowth;
if(combGrowth>30){score+=5;factors.push({f:'Exceptional growth ('+combGrowth.toFixed(0)+'%)',s:'+5',c:'g'})}
else if(combGrowth>15){score+=3;factors.push({f:'Strong growth ('+combGrowth.toFixed(0)+'%)',s:'+3',c:'g'})}
else if(combGrowth>5){score+=1;factors.push({f:'Moderate growth ('+combGrowth.toFixed(0)+'%)',s:'+1',c:'b'})}
else if(combGrowth<=-5){score-=3;factors.push({f:'Earnings contracting ('+combGrowth.toFixed(0)+'%)',s:'-3',c:'r'})}
else if(combGrowth<0){score-=1;factors.push({f:'Slight decline ('+combGrowth.toFixed(0)+'%)',s:'-1',c:'a'})}
if(fpe>0&&pe>0&&fpe<pe*0.85){score+=2;factors.push({f:'Forward PE compression — accelerating',s:'+2',c:'g'})}
else if(fpe>0&&pe>0&&fpe>pe*1.15){score-=1;factors.push({f:'Forward PE expansion — decelerating',s:'-1',c:'r'})}
// F10: Relative Valuation
if(pe>0&&sectorPE>0){const peR=pe/sectorPE;const disc=((sectorPE-pe)/sectorPE*100).toFixed(0);
if(peR<0.6){score+=5;factors.push({f:'P/E '+Math.abs(disc)+'% below sector',s:'+5',c:'g'})}
else if(peR<0.85){score+=3;factors.push({f:'P/E '+Math.abs(disc)+'% below sector',s:'+3',c:'g'})}
else if(peR<=1.15){score+=1;factors.push({f:'P/E in line with sector',s:'+1',c:'b'})}
else if(peR<=1.5){score-=2;factors.push({f:'P/E '+Math.abs(disc)+'% above sector',s:'-2',c:'a'})}
else{score-=4;factors.push({f:'P/E '+Math.abs(disc)+'% above sector',s:'-4',c:'r'})}}
// F11: Technical
let techScore=0;const techD=[];
if(sma20>0){if(price>sma20){techScore+=1;techD.push('Above SMA20')}else{techScore-=1;techD.push('Below SMA20')}}
if(sma200>0){if(price>sma200){techScore+=2;techD.push('Above SMA200 — uptrend')}else{techScore-=2;techD.push('Below SMA200 — downtrend')}}
if(sma20>0&&sma200>0){if(sma20>sma200){techScore+=2;techD.push('Golden Cross')}else if(sma20<sma200*0.95){techScore-=2;techD.push('Death Cross')}}
techScore=Math.max(-5,Math.min(5,techScore));score+=techScore;
if(techD.length>0){const tC=techScore>=3?'g':techScore>=1?'b':techScore<=-2?'r':'a';factors.push({f:'Technical: '+techD.join(', '),s:(techScore>=0?'+':'')+techScore,c:tC})}
// Decision
let decision,decCol,decBg,timeline,probability,reasoning,action;
if(score>=18){decision='STRONG HOLD';decCol='#10b981';decBg='rgba(16,185,129,.1)';timeline='12-24 months';probability=Math.min(95,78+Math.floor(score/2));
reasoning='Exceptional across all 11 factors. Serious compounding potential.';action=pnl<0?'Average down on any 5-10% dip.':'Hold entire position. Add on 10%+ corrections.'}
else if(score>=12){decision='HOLD & ACCUMULATE';decCol='#10b981';decBg='rgba(16,185,129,.08)';timeline='6-12 months';probability=Math.min(90,72+Math.floor(score/2));
reasoning='Strong fundamentals + positive momentum.';action=pnl<-15?'Accumulate to average down.':'Hold. Add on 5-8% pullbacks.'}
else if(score>=6){decision='HOLD';decCol='#22d3ee';decBg='rgba(6,182,212,.08)';timeline='6-12 months';probability=Math.min(82,64+score);
reasoning='Decent fundamentals. No urgency to act.';action=pnl>30?'Book 25-30% profits. Let rest ride.':'Hold and review after next quarter.'}
else if(score>=0){decision='HOLD WITH CAUTION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';timeline='3-6 months';probability=Math.min(72,56+score);
reasoning='Mixed signals. Watch for deterioration.';action=pnl>40?'Book 50% profits.':pnl<-20?'Set strict stop loss 10% below CMP.':'Monitor closely. Exit if earnings disappoint.'}
else if(score>=-5){decision='REDUCE POSITION';decCol='#f59e0b';decBg='rgba(245,158,11,.08)';timeline='0-3 months';probability=Math.min(65,55+Math.abs(score));
reasoning='Weak fundamentals. Risk-reward unfavorable.';action=pnl>20?'Book 50-70% profits now.':'Sell 50%. Set stop on remainder.'}
else{decision='EXIT / SELL';decCol='#ef4444';decBg='rgba(239,68,68,.08)';timeline='Immediately';probability=Math.min(80,60+Math.abs(score));
reasoning='Multiple red flags. Capital better deployed elsewhere.';action=pnl>0?'Book all profits.':'Cut losses now.'}
probability=Math.max(55,Math.min(95,probability));
const upside=score>=4?Math.max(5,Math.min(40,score*3)):0;
const t1=price*(1+upside/200),t2=price*(1+upside/100),sl=price*(score>=0?0.88:0.92);
// Render
let h=`<div style="position:relative;padding:14px;border-radius:10px;background:${decBg};border:1px solid ${decCol}25;overflow:hidden">`;
h+=`<div style="position:relative;z-index:2">`;
h+=`<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">
<div style="display:flex;align-items:center;gap:10px">
<span class="dec-badge" style="background:${decBg};border:2px solid ${decCol};color:${decCol}">${decision}</span>
<div><div style="font-size:9px;color:var(--text3)">Timeline</div><div style="font-size:13px;font-weight:700;color:var(--text)">${timeline}</div></div>
<div><div style="font-size:9px;color:var(--text3)">Probability</div><div style="font-size:13px;font-weight:700;color:${decCol}">${probability}%</div></div>
</div>
<div style="text-align:right">
<div style="font-size:10px;color:var(--text3)">P&L on ${d.company_name||ticker}</div>
<div style="font-size:16px;font-weight:800;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}${pnl.toFixed(1)}%</div>
<div style="font-size:10px;color:var(--text3)">${curr}${buyPrice.toLocaleString()} → ${curr}${price.toLocaleString()}</div>
</div></div>`;
h+=`<div class="dec-meter"><div class="dec-meter-fill" style="width:${probability}%;background:linear-gradient(90deg,${decCol}88,${decCol})"></div></div>`;
h+=`<div style="margin:8px 0;font-size:12px;color:var(--text2);line-height:1.5">${reasoning}</div>`;
h+=`<div style="padding:6px 10px;border-radius:6px;background:rgba(0,47,108,.04);border-left:3px solid ${decCol};margin-bottom:10px">
<div style="font-size:9px;font-weight:700;color:${decCol};margin-bottom:2px">▶ ACTION</div>
<div style="font-size:11px;color:var(--text)">${action}</div></div>`;
if(score>=0){h+=`<div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
<div style="flex:1;min-width:80px;padding:5px 8px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15)">
<div style="font-size:8px;color:var(--red);font-weight:700">STOP LOSS</div><div style="font-size:11px;font-weight:700;color:var(--red)">${curr}${sl.toFixed(0)}</div></div>
<div style="flex:1;min-width:80px;padding:5px 8px;border-radius:6px;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15)">
<div style="font-size:8px;color:var(--cyan);font-weight:700">3M TARGET</div><div style="font-size:11px;font-weight:700;color:var(--cyan)">${curr}${t1.toFixed(0)}</div></div>
<div style="flex:1;min-width:80px;padding:5px 8px;border-radius:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15)">
<div style="font-size:8px;color:var(--green);font-weight:700">12M TARGET</div><div style="font-size:11px;font-weight:700;color:var(--green)">${curr}${t2.toFixed(0)}</div></div>
</div>`}
h+=`<div style="font-size:9px;font-weight:700;color:var(--text3);margin-bottom:4px">FACTORS (Score: ${score>=0?'+':''}${score})</div>`;
h+=`<div style="display:flex;flex-wrap:wrap;gap:3px">`;
factors.forEach(f=>{const fc=f.c==='g'?'var(--green)':f.c==='r'?'var(--red)':f.c==='a'?'var(--amber)':'var(--blue)';
const fbg=f.c==='g'?'rgba(16,185,129,.08)':f.c==='r'?'rgba(239,68,68,.08)':f.c==='a'?'rgba(245,158,11,.08)':'rgba(0,120,212,.08)';
h+=`<span style="font-size:8px;padding:2px 6px;border-radius:4px;background:${fbg};color:${fc}">[${f.s}] ${f.f}</span>`});
h+=`</div>`;
h+=`<div style="margin-top:6px;font-size:8px;color:var(--text3)">Algorithmic analysis, not financial advice. Consult your advisor.</div>`;
h+=`</div></div>`;
resEl.innerHTML=h;
}catch(e){resEl.innerHTML=`<div style="font-size:11px;color:var(--red)">Error: ${e.message}</div>`}
finally{btn.disabled=false;btn.textContent='⚡ Analyze Decision'}
}

async function loadTradeScorecard(){
const el=document.getElementById('scorecardArea');
const btn=document.getElementById('scorecardBtn');
if(!el)return;
const emailEl=document.getElementById('email');
const em=emailEl?(emailEl.dataset.real||emailEl.value).trim().toLowerCase():'';
btn.disabled=true;btn.textContent='Loading...';
el.style.display='block';
el.innerHTML='<div style="text-align:center;padding:20px;color:var(--text3)"><div class="spinner" style="width:20px;height:20px;border:2px solid var(--cyan);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 8px"></div>Fetching actual market data and validating trades...</div>';
try{
const res=await fetch(`/api/validate-trades?email=${encodeURIComponent(em)}`);
const data=await res.json();
if(!data.success){el.innerHTML=`<div style="color:var(--red);font-size:12px">${data.error||data.message||'Error loading scorecard'}</div>`;return}
if(!data.results||data.results.length===0){el.innerHTML=`<div style="padding:16px;border-radius:10px;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15);text-align:center"><div style="font-size:14px;font-weight:700;color:var(--cyan);margin-bottom:6px">&#128202; Trade Scorecard</div><div style="font-size:12px;color:var(--text2)">${data.message||'No completed trading days to validate yet. Trades will be scored after market close.'}</div></div>`;return}
const s=data.summary;
let h='';

// Summary dashboard
const wr=s.win_rate||0;
const wrCol=wr>=70?'var(--green)':wr>=50?'var(--amber)':'var(--red)';
h+=`<div style="padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(6,182,212,.08),rgba(16,185,129,.05));border:1px solid rgba(6,182,212,.2);margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:800;color:var(--cyan);margin-bottom:12px">&#128202; TRADE SCORECARD — ${s.days_tracked} Day${s.days_tracked>1?'s':''} Tracked</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:12px">
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:${wrCol}">${wr}%</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">WIN RATE</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--text)">${s.total_trades}</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">TOTAL TRADES</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--green)">${s.wins}</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">WINS</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--red)">${s.losses}</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">LOSSES</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--green)">${s.target_hit_rate}%</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">TARGET HIT</div>
</div>
<div style="text-align:center;padding:10px;border-radius:8px;background:rgba(0,47,108,.03)">
<div style="font-size:24px;font-weight:800;color:var(--amber)">${s.avg_best_move}%</div>
<div style="font-size:9px;color:var(--text3);font-weight:700">AVG BEST MOVE</div>
</div>
</div>

<div style="height:8px;border-radius:4px;background:rgba(0,47,108,.06);overflow:hidden;margin-bottom:6px">
<div style="height:100%;width:${wr}%;border-radius:4px;background:linear-gradient(90deg,var(--green),${wrCol});transition:width 1s"></div>
</div>
<div style="font-size:10px;color:var(--text3);display:flex;justify-content:space-between">
<span>Win Rate: ${s.wins}W / ${s.losses}L</span>
<span>Avg Close Move: ${s.avg_actual_move}%</span>
</div>
</div>`;

// Daily breakdown with chart-like bars
data.results.forEach(day=>{
const dayTrades=day.trades;
const dayWins=dayTrades.filter(t=>t.score>=0.5).length;
const dayTotal=dayTrades.length;
const dayWR=dayTotal?Math.round(dayWins/dayTotal*100):0;
const dayCol=dayWR>=70?'var(--green)':dayWR>=50?'var(--amber)':'var(--red)';

h+=`<div style="margin-bottom:12px;padding:12px;border-radius:10px;background:rgba(0,47,108,.02);border:1px solid var(--border)">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:var(--text)">${day.date}</span>
${day.is_expiry?'<span style="font-size:8px;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.1);color:var(--red);font-weight:700">EXPIRY</span>':''}
</div>
<span style="font-size:11px;font-weight:800;color:${dayCol}">${dayWR}% (${dayWins}/${dayTotal})</span>
</div>
<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">
<tr style="border-bottom:1px solid var(--border)">
<th style="padding:4px 6px;text-align:left;color:var(--text3);font-size:9px">TRADE</th>
<th style="padding:4px 6px;text-align:center;color:var(--text3);font-size:9px">DIR</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">ENTRY</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">TARGET</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">STOP</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">DAY HIGH</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">DAY LOW</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">CLOSE</th>
<th style="padding:4px 6px;text-align:right;color:var(--text3);font-size:9px">P&L</th>
<th style="padding:4px 6px;text-align:center;color:var(--text3);font-size:9px">RESULT</th>
</tr>`;
dayTrades.forEach(t=>{
const oc=t.outcome==='TARGET HIT'?'var(--green)':t.outcome==='STOP HIT'?'var(--red)':t.outcome==='PARTIAL WIN'?'#22d3ee':'var(--amber)';
const obg=t.outcome==='TARGET HIT'?'rgba(16,185,129,.1)':t.outcome==='STOP HIT'?'rgba(239,68,68,.1)':'rgba(245,158,11,.06)';
h+=`<tr style="border-bottom:1px solid rgba(0,47,108,.03)">
<td style="padding:4px 6px;font-weight:600">${t.label}</td>
<td style="padding:4px 6px;text-align:center;color:${t.direction==='BULL'?'var(--green)':'var(--red)'};font-weight:700">${t.direction}</td>
<td style="padding:4px 6px;text-align:right;color:var(--blue)">${t.entry.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--green)">${t.target.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--red)">${t.stop.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--text2)">${t.day_high.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;color:var(--text2)">${t.day_low.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;font-weight:600;color:var(--text)">${t.day_close.toLocaleString()}</td>
<td style="padding:4px 6px;text-align:right;font-weight:700;color:${t.actual_move_pct>=0?'var(--green)':'var(--red)'}">${t.actual_move_pct>=0?'+':''}${t.actual_move_pct}%</td>
<td style="padding:4px 6px;text-align:center"><span style="font-size:8px;padding:2px 6px;border-radius:4px;background:${obg};color:${oc};font-weight:800">${t.outcome}</span></td>
</tr>`;
});
h+=`</table></div>`;

// Visual P&L bar chart for this day
h+=`<div style="display:flex;gap:3px;margin-top:6px;align-items:end;height:30px">`;
dayTrades.forEach(t=>{
const barH=Math.min(28,Math.max(4,Math.abs(t.actual_move_pct)*10));
const barC=t.actual_move_pct>=0?'var(--green)':'var(--red)';
h+=`<div style="flex:1;height:${barH}px;background:${barC};border-radius:2px;opacity:.7" title="${t.label}: ${t.actual_move_pct>0?'+':''}${t.actual_move_pct}%"></div>`;
});
h+=`</div>`;
h+=`</div>`;
});

h+=`<div style="font-size:9px;color:var(--text3);margin-top:6px">Validation compares suggested entry/target/stop levels against actual intraday highs, lows, and closing prices from Yahoo Finance. "TARGET HIT" = price reached target without hitting stop first. Past performance does not predict future results.</div>`;
el.innerHTML=h;
}catch(e){
el.innerHTML=`<div style="color:var(--red);font-size:12px">Error: ${e.message}</div>`;
}finally{
btn.disabled=false;btn.textContent='&#128202; Trade Scorecard';
}
}

// ═══════════════════════════════════════════════
// INDEX TRADES — AI-Powered Daily Ideas
// ═══════════════════════════════════════════════
async function loadIndexTrades(forceRefresh){
const el=document.getElementById('tradesContent');
const errEl=document.getElementById('tradesError');
const btn=document.getElementById('tradesLoadBtn');
// Get current email from the input
const emailInput=document.getElementById('email');
const email=emailInput?(emailInput.dataset.real||emailInput.value).trim():'';
if(!email){errEl.textContent='Please enter your email in the search bar above first.';errEl.style.display='block';return}
// Access check
btn.disabled=true;btn.textContent=forceRefresh?'⏳ Refreshing with live data...':'⏳ Analyzing markets...';errEl.style.display='none';
try{
const r=await fetch('/api/index-trades',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,force_refresh:!!forceRefresh})});
const data=await r.json();
if(!data.success){errEl.textContent=data.error||'Service busy. Please try again in a moment.';errEl.style.display='block';btn.disabled=false;btn.textContent='⚡ Generate Today\'s Trades';return}

// Render the trades
let html='';

// Market assessment — compact pill design
const ma=data.market_assessment||{};
if(ma.bias){
const biasCol=ma.bias.includes('BULL')?'var(--green)':ma.bias.includes('BEAR')?'var(--red)':'var(--amber)';
const biasBg=ma.bias.includes('BULL')?'rgba(16,185,129,.1)':ma.bias.includes('BEAR')?'rgba(239,68,68,.1)':'rgba(245,158,11,.08)';
const biasIcon=ma.bias.includes('BULL')?'&#128200;':ma.bias.includes('BEAR')?'&#128201;':'&#128260;';
const regimeCol=ma.regime==='TRENDING'?'var(--green)':ma.regime==='RANGE-BOUND'?'var(--amber)':'var(--blue)';
const edgeCol=ma.edge_clarity==='CLEAR'?'var(--green)':ma.edge_clarity==='MODERATE'?'var(--amber)':'var(--red)';
html+=`<div style="margin-bottom:14px;padding:14px 16px;border-radius:10px;background:${biasBg};border:1px solid ${biasCol}25">
<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:${ma.vix_signal||ma.global_impact?'10px':'0'}">
<div style="display:flex;align-items:center;gap:6px">
<span style="font-size:18px">${biasIcon}</span>
<span style="font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:${biasCol}">${ma.bias}</span>
</div>
<span style="font-size:10px;font-weight:700;color:${regimeCol};background:${regimeCol}12;border:1px solid ${regimeCol}25;padding:3px 10px;border-radius:10px">${ma.regime||'-'}</span>
<span style="font-size:10px;font-weight:700;color:${edgeCol};background:${edgeCol}12;border:1px solid ${edgeCol}25;padding:3px 10px;border-radius:10px">Edge: ${ma.edge_clarity||'-'}</span>
</div>
${ma.vix_signal||ma.global_impact?`<div style="font-size:11px;color:var(--text3);line-height:1.6">${ma.vix_signal?'<span style="color:var(--amber);font-weight:600">VIX</span> '+ma.vix_signal+(ma.global_impact?' · ':''):''}${ma.global_impact?'<span style="color:var(--blue);font-weight:600">Global</span> '+ma.global_impact:''}</div>`:''}
</div>`;
}

// Event alert loads on page load via DOMContentLoaded and refreshes on each Analyze click

// Market pulse header
html+=`<div style="border-radius:12px;background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(239,68,68,.05));border:1px solid rgba(245,158,11,.2);padding:16px 20px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">&#128200;</span>
<div><div style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--amber)">Market Pulse — ${new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
<div style="font-size:11px;color:var(--text3);display:flex;align-items:center;gap:8px">Generated at ${data.generated_at?new Date(data.generated_at).toLocaleTimeString('en-IN'):new Date().toLocaleTimeString('en-IN')} IST <button onclick="loadIndexTrades(true)" style="font-size:10px;color:var(--blue);background:none;border:1px solid var(--blue);border-radius:6px;padding:2px 8px;cursor:pointer" title="Force fresh analysis with latest market data">&#8635; Refresh</button></div></div></div>
${data.market_context?'<p style="font-size:13px;color:var(--text2);line-height:1.7;margin:0">'+data.market_context+'</p>':''}
</div>`;

// Expiry status badge
if(data.is_expiry_day){
html+=`<div style="padding:12px 16px;border-radius:8px;background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(245,158,11,.08));border:1px solid rgba(239,68,68,.3);margin-bottom:14px;display:flex;align-items:center;gap:10px">
<span style="font-size:22px;animation:pulse 1.5s infinite">&#128308;</span>
<div><div style="font-size:12px;font-weight:800;color:var(--red);letter-spacing:.5px">EXPIRY DAY — ${data.expiry_today}</div>
<div style="font-size:11px;color:var(--text3)">Theta decay accelerates after 1 PM · Gamma spikes in last 90 min · Hero Zero window: 1:30-2:30 PM IST</div></div></div>`;
}else{
html+=`<div style="padding:10px 16px;border-radius:8px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);margin-bottom:14px;display:flex;align-items:center;gap:10px">
<span style="font-size:18px">&#128197;</span>
<div style="font-size:12px;color:var(--text3)"><strong style="color:var(--blue)">${data.day_name||'Today'}</strong> — No expiry today. Next: <strong>Nifty</strong> expires Tuesday (NSE) · <strong>Sensex</strong> expires Thursday (BSE). Positional trades recommended.</div></div>`;
}

// Index snapshot
if(data.indices&&data.indices.length>0){
html+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:16px">`;
data.indices.forEach(idx=>{
const up=idx.change>=0;
const col=up?'var(--green)':'var(--red)';
html+=`<div style="text-align:center;padding:12px;border-radius:8px;background:rgba(${up?'16,185,129':'239,68,68'},.06);border:1px solid rgba(${up?'16,185,129':'239,68,68'},.15)">
<div style="font-size:11px;color:var(--text3);font-weight:600;letter-spacing:.5px">${idx.name}</div>
<div style="font-size:18px;font-weight:800;color:${col}">${idx.price?idx.price.toLocaleString('en-IN'):'-'}</div>
<div style="font-size:12px;color:${col}">${up?'▲':'▼'} ${Math.abs(idx.change||0).toFixed(2)} (${(idx.change_pct||0).toFixed(2)}%)</div>
</div>`;
});
html+=`</div>`;
}

// Trades table — ranked by probability, with time planner and gut picks
// Collect ALL trades for time-ordered planner
const allTrades=[];

if(data.trades&&data.trades.length>0){
const sorted=[...data.trades].sort((a,b)=>(parseInt(b.probability)||80)-(parseInt(a.probability)||80));
html+=`<div style="font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--amber);margin-bottom:10px;letter-spacing:.3px">&#127919; INDEX TRADES — Ranked by Probability</div>`;
sorted.forEach((t,i)=>{
const up=(t.direction||'').toUpperCase().includes('BULL');
const col=up?'var(--green)':'var(--red)';
const bg=up?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)';
const bdr=up?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)';
const prob=parseInt(t.probability)||80;
const pCol=prob>=90?'var(--green)':prob>=85?'#22d3ee':'var(--amber)';
allTrades.push({...t,_type:'INDEX',_rank:t.rank||i+1,_prob:prob,_inst:t.index+' '+(t.bias||t.direction||'')});
html+=`<div style="border-left:4px solid ${bdr};border-radius:10px;padding:16px;margin-bottom:12px;background:${bg};border:1px solid ${bdr}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;background:${col};color:#fff;padding:2px 8px;border-radius:4px;font-weight:800">#${t.rank||i+1}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.index||'-'}</span>
<span style="font-size:12px;font-weight:700;color:${col};background:${bg};border:1px solid ${bdr};padding:2px 8px;border-radius:4px">${(t.direction||'').toUpperCase()}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
${t.probability?`<span style="font-size:11px;font-weight:800;color:#fff;background:${pCol};padding:2px 8px;border-radius:4px">${t.probability}</span>`:''}
</div>
</div>
${t.factors_aligned?`<div style="font-size:11px;color:var(--text3);margin-bottom:8px;padding:4px 8px;border-radius:4px;background:rgba(0,47,108,.03)">&#9989; <strong style="color:var(--green)">Factors:</strong> ${t.factors_aligned}</div>`:''}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">ENTRY LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${t.entry_level||t.entry||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TARGET ${t.move_pct?'<span style="color:var(--green);font-weight:800">('+t.move_pct+')</span>':''}</div><div style="font-size:14px;font-weight:700;color:var(--green)">${t.target_level||t.target||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">STOP LOSS</div><div style="font-size:14px;font-weight:700;color:var(--red)">${t.stop_level||t.stop_loss||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">MOVE</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${t.move_points||t.risk_reward||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">R:R</div><div style="font-size:14px;font-weight:700;color:var(--amber)">${t.risk_reward||'-'}</div></div>
</div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(0,120,212,.12);border:1px solid rgba(59,130,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:.8px">&#9654; WHEN TO ENTER</span><br><span style="font-size:14px;font-weight:800;color:var(--text)">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.8px">&#9200; BEST TIME</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
${t.key_levels?`<div style="margin-bottom:8px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.12);font-size:11px"><strong style="color:var(--purple)">&#128200; Key Levels:</strong> <span style="color:var(--text2)">${t.key_levels}</span></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; KILL IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// Stock trades
if(data.stock_trades&&data.stock_trades.length>0){
const sorted=[...data.stock_trades].sort((a,b)=>(parseInt(b.probability)||80)-(parseInt(a.probability)||80));
html+=`<div style="margin-top:20px;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--purple);margin-bottom:10px">&#128640; STOCK PICKS — Ranked by Probability</div>`;
sorted.forEach((t,i)=>{
const up=(t.direction||'').toUpperCase().includes('BULL');
const col=up?'var(--green)':'var(--red)';
const bg=up?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)';
const bdr=up?'rgba(16,185,129,.2)':'rgba(239,68,68,.2)';
const prob=parseInt(t.probability)||80;
const pCol=prob>=90?'var(--green)':prob>=85?'#22d3ee':'var(--amber)';
allTrades.push({...t,_type:'STOCK',_rank:t.rank||'S'+(i+1),_prob:prob,_inst:(t.stock||'')+(t.bias?' '+t.bias:'')});
html+=`<div style="border-left:4px solid rgba(139,92,246,.3);border-radius:10px;padding:16px;margin-bottom:12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15)">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;background:var(--purple);color:#fff;padding:2px 8px;border-radius:4px;font-weight:800">${t.rank||'S'+(i+1)}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.stock||'-'}</span>
<span style="font-size:12px;font-weight:700;color:${col};background:${bg};border:1px solid ${bdr};padding:2px 8px;border-radius:4px">${(t.direction||'').toUpperCase()}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
${t.probability?`<span style="font-size:11px;font-weight:800;color:#fff;background:${pCol};padding:2px 8px;border-radius:4px">${t.probability}</span>`:''}
</div>
</div>
${t.factors_aligned?`<div style="font-size:11px;color:var(--text3);margin-bottom:8px;padding:4px 8px;border-radius:4px;background:rgba(0,47,108,.03)">&#9989; <strong style="color:var(--green)">Factors:</strong> ${t.factors_aligned}</div>`:''}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">ENTRY LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">₹${t.entry_level||t.entry||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TARGET ${t.move_pct?'<span style="color:var(--green);font-weight:800">('+t.move_pct+')</span>':''}</div><div style="font-size:14px;font-weight:700;color:var(--green)">₹${t.target_level||t.target||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">STOP LOSS</div><div style="font-size:14px;font-weight:700;color:var(--red)">₹${t.stop_level||t.stop_loss||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">R:R</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${t.risk_reward||'-'}</div></div>
</div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--purple);letter-spacing:.8px">&#9654; WHEN TO ENTER</span><br><span style="font-size:14px;font-weight:800;color:var(--text)">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--amber);letter-spacing:.8px">&#9200; BEST TIME</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
${t.key_levels?`<div style="margin-bottom:8px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.12);font-size:11px"><strong style="color:var(--purple)">&#128200; Key Levels:</strong> <span style="color:var(--text2)">${t.key_levels}</span></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; KILL IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// VIX indicator
if(data.vix){
const vix=data.vix;
const vC=vix.price>18?'var(--red)':vix.price>14?'var(--amber)':'var(--green)';
const vBg=vix.price>18?'rgba(239,68,68,.08)':vix.price>14?'rgba(245,158,11,.08)':'rgba(16,185,129,.08)';
const vAdv=vix.price>20?'HIGH FEAR — Reduce sizes to 50%.':vix.price>16?'ELEVATED — Standard sizing. Stay alert.':'LOW — Full sizing. Trends likely.';
const vP=Math.min(((vix.price-8)/(30-8))*100,100);
html+=`<div style="margin-top:16px;padding:14px;border-radius:10px;background:${vBg};border:1px solid ${vC}30">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px">
<span style="font-family:'Sora',sans-serif;font-size:12px;font-weight:700;color:${vC}">INDIA VIX: ${vix.price} ${vix.change>=0?'▲':'▼'} ${Math.abs(vix.change||0).toFixed(2)} (${(vix.change_pct||0).toFixed(2)}%)</span>
<span style="font-size:11px;color:var(--text3)">${vAdv}</span></div>
<div style="width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,.1);overflow:hidden"><div style="width:${vP}%;height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--amber),var(--red))"></div></div>
<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:4px"><span>8 (Calm)</span><span>15</span><span>20</span><span>30+ (Panic)</span></div></div>`;
}

// Hero Zero
if(data.hero_zero&&data.hero_zero.length>0){
html+=`<div style="margin-top:20px;margin-bottom:16px">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--red);letter-spacing:.3px;margin-bottom:4px">&#128165; HERO ZERO — Expiry Day Lottery</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:12px">Deep OTM, ₹2-15 premium. All-or-nothing for 3x-10x. Max 1-2% capital. Today's expiry ONLY.</div></div>`;
data.hero_zero.forEach((t,i)=>{
allTrades.push({...t,_type:'HERO ZERO',_rank:'H'+(i+1),_prob:0,_inst:(t.index||'')+' '+(t.bias||'Deep OTM')});
html+=`<div style="border-left:4px solid rgba(239,68,68,.5);border-radius:10px;padding:16px;margin-bottom:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.2)">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:11px;background:var(--red);color:#fff;padding:2px 8px;border-radius:4px;font-weight:800;animation:pulse 2s infinite">&#128165;H${i+1}</span>
<span style="font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:var(--text)">${t.index||'-'} ${t.direction||''}</span>
${t.bias?`<span style="font-size:11px;font-weight:700;color:var(--cyan);background:rgba(6,182,212,.1);border:1px solid rgba(6,182,212,.2);padding:2px 8px;border-radius:4px">${t.bias}</span>`:''}
<span style="font-size:10px;font-weight:800;color:var(--red);background:rgba(239,68,68,.15);padding:2px 8px;border-radius:4px">SPECULATIVE</span></div></div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px">
<div style="padding:8px;border-radius:6px;background:rgba(0,47,108,.03)"><div style="font-size:10px;color:var(--text3);font-weight:600">SPOT</div><div style="font-size:14px;font-weight:700;color:var(--text)">₹${t.spot_price||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(59,130,246,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">TRIGGER LEVEL</div><div style="font-size:14px;font-weight:700;color:var(--blue)">${t.trigger_level||'-'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(16,185,129,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">EXPECTED MOVE</div><div style="font-size:14px;font-weight:700;color:var(--green)">${t.target_move||'3x-10x'}</div></div>
<div style="padding:8px;border-radius:6px;background:rgba(239,68,68,.06)"><div style="font-size:10px;color:var(--text3);font-weight:600">RISK</div><div style="font-size:14px;font-weight:700;color:var(--red)">Full premium loss</div></div></div>
${t.entry_condition?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(0,120,212,.12);border:1px solid rgba(59,130,246,.25);display:flex;align-items:center;gap:10px"><span style="font-size:20px">&#127919;</span><div><span style="font-size:10px;font-weight:700;color:var(--blue);letter-spacing:.8px">&#9654; TRIGGER CONDITION</span><br><span style="font-size:14px;font-weight:800;color:var(--text)">${t.entry_condition}</span></div></div>`:''}
${t.timing?`<div style="margin-bottom:8px;padding:10px 14px;border-radius:8px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);display:flex;align-items:center;gap:10px"><span style="font-size:18px">&#128337;</span><div><span style="font-size:10px;font-weight:700;color:var(--red);letter-spacing:.8px">&#9200; TIMING IS EVERYTHING</span><br><span style="font-size:13px;font-weight:700;color:var(--amber)">${t.timing}</span></div></div>`:''}
<div style="font-size:12px;color:var(--text2);line-height:1.7"><strong style="color:var(--text3)">Rationale:</strong> ${t.reason||'-'}</div>
${t.what_invalidates?`<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);font-size:11px"><strong style="color:var(--red)">&#9888; ZERO IF:</strong> <span style="color:var(--text2)">${t.what_invalidates}</span></div>`:''}
</div>`;
});
}

// ═══ TIME-ORDERED DAY PLANNER ═══
if(allTrades.length>0){
const timeSorted=[...allTrades].sort((a,b)=>{
const ta=parseInt(a.time_sort)||9999;
const tb=parseInt(b.time_sort)||9999;
return ta-tb;
});
const gb=data.gamma_blast||{};
const hasGamma=data.is_expiry_day&&gb.probability&&parseInt(gb.probability)>0;
html+=`<div style="margin-top:24px;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(139,92,246,.04));border:1px solid rgba(59,130,246,.15)">
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--blue);margin-bottom:4px">&#128197; YOUR TRADING DAY PLAN (IST)</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:12px">All trades sorted by execution time — follow this order through the day</div>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<thead><tr style="border-bottom:2px solid rgba(0,120,212,.25)">
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TIME</th>
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">RANK</th>
<th style="padding:8px 6px;text-align:left;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">INSTRUMENT</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">DIR</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">ENTRY</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TRIGGER</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">TARGET</th>
<th style="padding:8px 6px;text-align:right;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">SL</th>
<th style="padding:8px 6px;text-align:center;color:var(--blue);font-weight:700;font-size:10px;letter-spacing:.5px">PROB</th>
${hasGamma?'<th style="padding:8px 6px;text-align:center;color:var(--red);font-weight:700;font-size:10px;letter-spacing:.5px">GAMMA</th>':''}
</tr></thead><tbody>`;
timeSorted.forEach((t,i)=>{
const dir=(t.direction||'').toUpperCase();
const dCol=dir.includes('BULL')?'var(--green)':'var(--red)';
const tBg=i%2===0?'rgba(255,255,255,.01)':'rgba(0,47,108,.03)';
const typeCol=t._type==='INDEX'?'var(--amber)':t._type==='STOCK'?'var(--purple)':'var(--red)';
const ts=t.time_sort||'--';
const timeStr=ts.length===4?ts.substring(0,2)+':'+ts.substring(2):ts;
// Gamma blast applies to INDEX trades in the 1:30-3:15 PM window on expiry
const gbApplies=hasGamma&&t._type==='INDEX'&&parseInt(ts)>=1330&&parseInt(ts)<=1515;
const gbProb=gbApplies?parseInt(gb.probability):0;
const gbCol=gbProb>=60?'var(--red)':gbProb>=40?'var(--amber)':'var(--blue)';
html+=`<tr style="background:${tBg};border-bottom:1px solid rgba(0,47,108,.04)">
<td style="padding:8px 6px;font-weight:700;color:var(--amber)">${timeStr}</td>
<td style="padding:8px 6px"><span style="font-size:10px;background:${typeCol};color:#fff;padding:1px 6px;border-radius:3px;font-weight:800">${t._rank}</span></td>
<td style="padding:8px 6px;font-weight:600;color:var(--text)">${t._inst||'-'}</td>
<td style="padding:8px 6px;text-align:center;font-weight:700;color:${dCol}">${dir}</td>
<td style="padding:8px 6px;text-align:right;color:var(--blue)">${t.entry_level||t.entry||'-'}</td>
<td style="padding:8px 6px;text-align:center;font-size:11px;color:var(--text2)">${t.entry_condition||'-'}</td>
<td style="padding:8px 6px;text-align:right;color:var(--green)">${t.move_pct||t.target_pct||'-'}</td>
<td style="padding:8px 6px;text-align:right;color:var(--red)">${t.stop_level||t.stop_loss||'-'}</td>
<td style="padding:8px 6px;text-align:center"><span style="font-weight:800;color:${parseInt(t.probability)>=85?'var(--green)':'var(--amber)'}">${t.probability||'-'}</span></td>
${hasGamma?`<td style="padding:8px 6px;text-align:center">${gbApplies?`<span style="font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;background:${gbCol}15;color:${gbCol};white-space:nowrap">${gb.probability} ${gb.direction||''}</span>`:'<span style="font-size:9px;color:var(--text3)">—</span>'}</td>`:''}
</tr>`;
});
html+=`</tbody></table></div>`;
// Gamma blast footer on expiry — compact summary below table
if(hasGamma){
const gbProb=parseInt(gb.probability)||0;
const gbCol=gbProb>=60?'var(--red)':gbProb>=40?'var(--amber)':'var(--blue)';
html+=`<div style="margin-top:10px;padding:8px 12px;border-radius:6px;background:${gbCol}08;border:1px solid ${gbCol}20;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
<span style="font-size:10px;font-weight:800;color:${gbCol}">&#9889; GAMMA BLAST ${gb.probability}</span>
<span style="font-size:10px;color:var(--text3)">Trigger: <strong style="color:var(--amber)">${gb.trigger_zone||'-'}</strong></span>
<span style="font-size:10px;color:var(--text3)">Move: <strong style="color:var(--text)">${gb.expected_move||'-'}</strong></span>
<span style="font-size:10px;color:var(--text3)">Window: <strong style="color:var(--text)">${gb.timing||'1:30-3:00 PM'}</strong></span>
${gb.best_play?`<span style="font-size:10px;color:var(--green);font-weight:600">&#127919; ${gb.best_play}</span>`:''}
</div>`;
}
html+=`</div>`;
}

// ═══ GUT PICKS — TOP 2 HIGHEST CONVICTION ═══
if(data.gut_picks&&data.gut_picks.length>0){
html+=`<div style="margin-top:24px;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(245,158,11,.06));border:2px solid rgba(16,185,129,.25)">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
<span style="font-size:24px">&#129504;</span>
<div style="font-family:'Sora',sans-serif;font-size:14px;font-weight:800;color:var(--green);letter-spacing:.3px">TOP GUT PICKS — Highest Conviction Trades</div>
</div>
<div style="font-size:11px;color:var(--text3);margin-bottom:14px">If you could only take 2 trades today, take THESE. Maximum data confluence.</div>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<thead><tr style="border-bottom:2px solid rgba(16,185,129,.3)">
<th style="padding:8px 6px;text-align:left;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">PICK</th>
<th style="padding:8px 6px;text-align:left;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">INSTRUMENT</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">DIR</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">ENTRY</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TRIGGER</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TIME</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">TARGET</th>
<th style="padding:8px 6px;text-align:right;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">SL</th>
<th style="padding:8px 6px;text-align:center;color:var(--green);font-weight:700;font-size:10px;letter-spacing:.5px">PROB</th>
</tr></thead><tbody>`;
data.gut_picks.forEach((g,i)=>{
const dir=(g.direction||'').toUpperCase();
const dCol=dir.includes('BULL')?'var(--green)':'var(--red)';
html+=`<tr style="background:rgba(16,185,129,.04);border-bottom:1px solid rgba(16,185,129,.1)">
<td style="padding:10px 6px"><span style="font-size:11px;background:var(--green);color:#000;padding:2px 8px;border-radius:4px;font-weight:900">&#127942; #${i+1}</span></td>
<td style="padding:10px 6px;font-weight:700;color:var(--text)">${g.index_or_stock||g.instrument||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-weight:700;color:${dCol}">${dir}</td>
<td style="padding:10px 6px;text-align:right;color:var(--blue);font-weight:700">${g.entry_level||g.entry||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-size:11px;font-weight:700;color:var(--text)">${g.entry_condition||'-'}</td>
<td style="padding:10px 6px;text-align:center;font-weight:700;color:var(--amber)">${g.timing||'-'}</td>
<td style="padding:10px 6px;text-align:right;font-weight:800;color:var(--green)">${g.target_level||g.move_pct||'-'}</td>
<td style="padding:10px 6px;text-align:right;font-weight:700;color:var(--red)">${g.stop_level||g.stop_loss||'-'}</td>
<td style="padding:10px 6px;text-align:center"><span style="font-weight:900;color:var(--green);font-size:13px">${g.probability||'-'}</span></td>
</tr>
<tr style="background:rgba(16,185,129,.02)">
<td colspan="9" style="padding:6px 6px 10px 40px;font-size:11px;color:var(--text2);line-height:1.5">&#128161; <strong style="color:var(--amber)">Why this one:</strong> ${g.why_this_one||'-'}</td>
</tr>`;
});
html+=`</tbody></table></div></div>`;
}

// Skipped trades honesty note
if(data.skipped_trades&&!data.skipped_trades.includes('All')){
html+=`<div style="margin-top:12px;padding:12px 16px;border-radius:8px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);display:flex;align-items:flex-start;gap:10px">
<span style="font-size:18px">&#9888;&#65039;</span>
<div><div style="font-size:11px;font-weight:800;color:var(--amber);letter-spacing:.5px;margin-bottom:4px">HONEST NOTE</div>
<div style="font-size:12px;color:var(--text2);line-height:1.6">${data.skipped_trades}</div></div></div>`;
}

el.innerHTML=html;
}catch(e){
errEl.textContent='Service busy. Please try again in a moment.';errEl.style.display='block';
btn.disabled=false;btn.textContent='⚡ Generate Today\'s Trades';
}}

function vote(feature,dir,btn){
if(typeof gtag==='function')gtag('event','feature_vote',{feature_name:feature,vote_direction:dir>0?'up':'down'});
// Prevent double-voting same direction on same feature
const voteKey=feature+(dir>0?'up':'dn');
const oppKey=feature+(dir>0?'dn':'up');
if(userVotes[voteKey])return;

// If they voted opposite before, undo it
if(userVotes[oppKey]){
const oppDir=dir>0?-1:1;
votes[feature][oppDir>0?'up':'dn']--;
const oppBtn=btn.parentElement.querySelector(dir>0?'.dn':'.up');
oppBtn.classList.remove('voted');
delete userVotes[oppKey];
}

// Record vote
if(dir>0)votes[feature].up++;
else votes[feature].dn++;
userVotes[voteKey]=true;
btn.classList.add('voted');

// Update counters
document.getElementById(feature+'-up').textContent=votes[feature].up;
document.getElementById(feature+'-dn').textContent=votes[feature].dn;

// Update bar
const total=votes[feature].up+votes[feature].dn;
const pct=total>0?Math.round((votes[feature].up/total)*100):0;
document.getElementById(feature+'-bar').style.width=pct+'%';

// Update chart
updateVoteChart();

// Send to backend
fetch('/api/vote',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({feature:feature,direction:dir})}).catch(()=>{});
}

function updateVoteChart(){
if(!voteChart)return;
voteChart.data.datasets[0].data=featureKeys.map(k=>votes[k].up);
voteChart.data.datasets[1].data=featureKeys.map(k=>-votes[k].dn);
voteChart.update('none');
}

function initVoteChart(){
const ctx=document.getElementById('voteChart');
if(!ctx)return;
voteChart=new Chart(ctx,{
type:'bar',
data:{
labels:featureNames,
datasets:[
{label:'Want It',data:featureKeys.map(k=>votes[k].up),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4,barPercentage:.6},
{label:'Not Needed',data:featureKeys.map(k=>-votes[k].dn),backgroundColor:'rgba(239,68,68,0.5)',borderRadius:4,barPercentage:.6}
]
},
options:{
indexAxis:'y',
responsive:true,
maintainAspectRatio:false,
scales:{
x:{stacked:true,grid:{color:'rgba(148,163,184,0.06)'},ticks:{color:'#64748b',font:{size:10},callback:v=>Math.abs(v)},border:{display:false}},
y:{stacked:true,grid:{display:false},ticks:{color:'#e2e8f0',font:{family:"'DM Sans',sans-serif",size:11,weight:'600'}},border:{display:false}}
},
plugins:{
legend:{labels:{color:'#94a3b8',font:{size:10},usePointStyle:true,pointStyle:'rectRounded'}},
tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+Math.abs(ctx.raw)}}
}
}
});
}

function loadVotes(){
fetch('/api/votes').then(r=>r.json()).then(data=>{
if(data&&data.votes){
featureKeys.forEach(k=>{
if(data.votes[k]){
votes[k].up=data.votes[k].up||0;
votes[k].dn=data.votes[k].dn||0;
document.getElementById(k+'-up').textContent=votes[k].up;
document.getElementById(k+'-dn').textContent=votes[k].dn;
const total=votes[k].up+votes[k].dn;
const pct=total>0?Math.round((votes[k].up/total)*100):0;
document.getElementById(k+'-bar').style.width=pct+'%';
}
});
updateVoteChart();
}
}).catch(()=>{});
}

function sendVoteResults(){
let body='CELESYS AI - Feature Vote Results\n\n';
const sorted=featureKeys.map((k,i)=>({key:k,name:featureNames[i],up:votes[k].up,dn:votes[k].dn,net:votes[k].up-votes[k].dn})).sort((a,b)=>b.net-a.net);
sorted.forEach((f,i)=>{
body+=(i+1)+'. '+f.name+' | Upvotes: '+f.up+' | Downvotes: '+f.dn+' | Net: '+f.net+'\n';
});
body+='\nTotal votes cast: '+featureKeys.reduce((s,k)=>s+votes[k].up+votes[k].dn,0);
body+='\nTimestamp: '+new Date().toISOString();
const mailto='mailto:contact@celesys.ai?subject='+encodeURIComponent('Feature Vote Results - '+new Date().toLocaleDateString())+'&body='+encodeURIComponent(body);
window.open(mailto);
}

// Initialize vote chart on page load
async function loadGlobalTicker(){
try{
const r=await fetch('/api/global-ticker');
const d=await r.json();
if(!d.success||!d.indices||!d.indices.length)return;
const track=document.getElementById('tickerTrack');
if(!track)return;
let items='';
d.indices.forEach(idx=>{
const up=idx.change_pct>0;
const flat=idx.change_pct===0;
const cls=flat?'fl':up?'up':'dn';
const arrow=flat?'':up?'▲':'▼';
const fmt=idx.name==='GSR'?idx.price:idx.price>=1000?idx.price.toLocaleString('en-IN'):idx.price;
items+=`<div class="ti"><span style="font-size:12px">${idx.flag}</span><span class="tn">${idx.name}</span><span class="tp">${fmt}</span><span class="tc ${cls}">${arrow}${Math.abs(idx.change_pct).toFixed(2)}%</span></div>`;
});
// Add "Last Updated" marker
const updTime=d.updated_at||new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
items+=`<div class="ti" style="opacity:.5"><span style="font-size:10px">🔄</span><span class="tn" style="color:var(--text3)">Updated</span><span class="tp" style="font-size:10px;color:var(--text3)">${updTime}</span></div>`;
// Duplicate for seamless infinite scroll
track.innerHTML=items+items;
}catch(e){console.log('Ticker load failed:',e)}
}

// ═══ AUTO-REFRESH: Ticker every 2 min, Market Pulse every 2 min ═══
setInterval(()=>{loadGlobalTicker()},120000);
setInterval(()=>{fetchMarketPulse()},120000);

document.addEventListener('DOMContentLoaded',()=>{loadGlobalTicker();setTimeout(()=>fetchMarketPulse(),3000);initVoteChart();loadVotes();
fetch('/api/stats').then(r=>r.json()).then(d=>{
if(d.total_reports){document.getElementById('navRC').textContent=d.total_reports;document.getElementById('globalRC').textContent=d.total_reports.toLocaleString();const hb=document.getElementById('reportBadgeCount');if(hb)hb.textContent=d.total_reports.toLocaleString()}
}).catch(()=>{})});

// Back-to-top button visibility + sticky tagline
window.addEventListener('scroll',()=>{
const btt=document.getElementById('bttBtn');
if(btt){if(window.scrollY>600)btt.classList.add('show');else btt.classList.remove('show')}
},{ passive: true });
// Sticky tagline — appears when hero scrolls out of view
const heroEl=document.querySelector('.hero');
const sTag=document.getElementById('stickyTag');
if(heroEl&&sTag){
const obs=new IntersectionObserver(([e])=>{
if(e.isIntersecting)sTag.classList.remove('vis');
else sTag.classList.add('vis');
},{threshold:0.1});
obs.observe(heroEl);
}
</script>

<!-- FLOATING FEEDBACK BUTTON -->
<button class="fab" onclick="document.getElementById('fpanel').classList.add('open');document.getElementById('fpbk').classList.add('open')">
<div class="pulse"></div> &#128227; Shape Our Roadmap! <span style="background:#ef4444;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;font-weight:800;animation:notifPop 2s ease-in-out infinite">NEW</span>
</button>

<!-- BACKDROP -->
<div class="fpbk" id="fpbk" onclick="document.getElementById('fpanel').classList.remove('open');this.classList.remove('open')"></div>

<!-- SLIDE PANEL -->
<div class="fpanel" id="fpanel">
<div class="fphdr">
<h3>&#128640; What Should We Build Next?</h3>
<button class="fpclose" onclick="document.getElementById('fpanel').classList.remove('open');document.getElementById('fpbk').classList.remove('open')">&times;</button>
</div>
<div class="fpbody">
<p class="sub">You just got a free analysis worth $50+. Now imagine what happens when we add <em>these</em>. Your vote decides what ships first.</p>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128196;</div><div class="pfinfo"><div class="pfname">PDF Export <span class="ftag hot">Most Wanted</span></div><div class="pfdesc">Download your full report as a branded PDF. Save it, print it, share it.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('pdf',1,this)">&#9650; Want it <span class="cnt" id="pdf-up">0</span></button><button class="pvbtn dn" onclick="vote('pdf',-1,this)">&#9660; Skip <span class="cnt" id="pdf-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="pdf-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#9878;&#65039;</div><div class="pfinfo"><div class="pfname">Compare 2 Stocks <span class="ftag hot">Most Wanted</span></div><div class="pfdesc">Side-by-side showdown. Which stock wins on every single metric?</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('cmp',1,this)">&#9650; Want it <span class="cnt" id="cmp-up">0</span></button><button class="pvbtn dn" onclick="vote('cmp',-1,this)">&#9660; Skip <span class="cnt" id="cmp-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="cmp-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128172;</div><div class="pfinfo"><div class="pfname">WhatsApp &amp; Email Share <span class="ftag new">New</span></div><div class="pfdesc">One tap to share your analysis with friends, family, or your broker.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('share',1,this)">&#9650; Want it <span class="cnt" id="share-up">0</span></button><button class="pvbtn dn" onclick="vote('share',-1,this)">&#9660; Skip <span class="cnt" id="share-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="share-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128200;</div><div class="pfinfo"><div class="pfname">Technical Indicators <span class="ftag pro">Pro</span></div><div class="pfdesc">RSI, MACD, Moving Averages &mdash; the tools serious traders use daily.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('tech',1,this)">&#9650; Want it <span class="cnt" id="tech-up">0</span></button><button class="pvbtn dn" onclick="vote('tech',-1,this)">&#9660; Skip <span class="cnt" id="tech-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="tech-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#127919;</div><div class="pfinfo"><div class="pfname">Peer Comparison <span class="ftag new">New</span></div><div class="pfdesc">Auto-compare vs top 3 competitors in the same sector. Who really wins?</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('peer',1,this)">&#9650; Want it <span class="cnt" id="peer-up">0</span></button><button class="pvbtn dn" onclick="vote('peer',-1,this)">&#9660; Skip <span class="cnt" id="peer-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="peer-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128197;</div><div class="pfinfo"><div class="pfname">Earnings Countdown <span class="ftag pro">Pro</span></div><div class="pfdesc">Next earnings date + analyst expectations. Never get blindsided again.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('earn',1,this)">&#9650; Want it <span class="cnt" id="earn-up">0</span></button><button class="pvbtn dn" onclick="vote('earn',-1,this)">&#9660; Skip <span class="cnt" id="earn-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="earn-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#128100;</div><div class="pfinfo"><div class="pfname">Insider Activity <span class="ftag hot">Most Wanted</span></div><div class="pfdesc">Are executives buying or selling their own stock? Follow the smart money.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('insider',1,this)">&#9650; Want it <span class="cnt" id="insider-up">0</span></button><button class="pvbtn dn" onclick="vote('insider',-1,this)">&#9660; Skip <span class="cnt" id="insider-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="insider-bar" style="width:0%"></div></div></div>

<div class="pfcard"><div class="pfrow"><div class="pficon">&#127763;</div><div class="pfinfo"><div class="pfname">Dark / Light Theme <span class="ftag new">New</span></div><div class="pfdesc">Switch between dark terminal mode and clean light mode instantly.</div></div></div>
<div class="pvbtns"><button class="pvbtn up" onclick="vote('theme',1,this)">&#9650; Want it <span class="cnt" id="theme-up">0</span></button><button class="pvbtn dn" onclick="vote('theme',-1,this)">&#9660; Skip <span class="cnt" id="theme-dn">0</span></button></div><div class="pvbar"><div class="vfill" id="theme-bar" style="width:0%"></div></div></div>

<!-- LIVE VOTE CHART -->
<div class="vgp">
<h4>&#128202; Live Community Votes</h4>
<div class="vsub">Real-time ranking &mdash; updated as you vote</div>
<div class="cc"><canvas id="voteChart"></canvas></div></div>

</div><!-- end fpbody -->
</div><!-- end fpanel -->

<!-- STICKY EDUCATION DISCLAIMER BAR — visible site-wide -->
<div class="edu-bar">
<div class="edu-title">&#9888; READ THIS BEFORE YOU TRADE</div>
<div class="edu-lines">
<div class="edu-line"><strong>NOT FINANCIAL ADVICE:</strong> This tool is <b style="color:var(--amber)">for education only</b>. Not a replacement for licensed financial advisors. <b style="color:var(--amber)">Consult your financial advisor</b> before making any decisions. Never invest money you cannot afford to lose.</div>
<div class="edu-line"><strong>DATA MAY BE DELAYED:</strong> Market data from third-party providers may be delayed or incomplete. Always cross-check with your broker.</div>
<div class="edu-line"><strong>YOU CAN LOSE MONEY:</strong> All investments carry real risk. Past performance never guarantees future results. No affiliation with any brokerage.</div>
</div>
</div>

<script>
// ═══ PWA: Service Worker Registration ═══
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js').then(r=>{
      console.log('SW registered, scope:',r.scope);
    }).catch(e=>console.warn('SW registration failed:',e));
  });
}

// ═══ PWA: Install Prompt ═══
let _deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  _deferredPrompt=e;
  // Show install banner after 30s if user hasn't installed
  setTimeout(()=>{
    if(!_deferredPrompt)return;
    const b=document.createElement('div');
    b.id='pwaInstallBanner';
    b.style.cssText='position:fixed;bottom:0;left:0;right:0;z-index:9999;background:linear-gradient(135deg,#002f6c,#003d8f);color:white;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 -4px 20px rgba(0,0,0,.3);font-family:Sora,sans-serif';
    b.innerHTML=`
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700">Install Celesys AI</div>
        <div style="font-size:11px;opacity:.8;margin-top:2px">Get instant access from your home screen</div>
      </div>
      <button onclick="pwaInstall()" style="padding:8px 18px;border-radius:8px;border:none;background:#4dabf7;color:#002f6c;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap;font-family:Sora,sans-serif">Install App</button>
      <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,.6);font-size:18px;cursor:pointer;padding:4px 8px">&times;</button>`;
    document.body.appendChild(b);
  },30000);
});

function pwaInstall(){
  if(!_deferredPrompt)return;
  _deferredPrompt.prompt();
  _deferredPrompt.userChoice.then(r=>{
    console.log('PWA install:',r.outcome);
    _deferredPrompt=null;
    const ban=document.getElementById('pwaInstallBanner');
    if(ban)ban.remove();
  });
}

window.addEventListener('appinstalled',()=>{
  console.log('PWA installed');
  _deferredPrompt=null;
  const ban=document.getElementById('pwaInstallBanner');
  if(ban)ban.remove();
});
</script>
</body>
</html>
